--
-- PostgreSQL database dump
--

-- Dumped from database version 11.2
-- Dumped by pg_dump version 11.3

-- Started on 2025-05-13 15:31:07

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- TOC entry 191 (class 2615 OID 24602)
-- Name: qlik; Type: SCHEMA; Schema: -; Owner: sp_postgres
--

CREATE SCHEMA qlik;


ALTER SCHEMA qlik OWNER TO sp_postgres;

--
-- TOC entry 1 (class 3079 OID 24603)
-- Name: adminpack; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS adminpack WITH SCHEMA pg_catalog;


--
-- TOC entry 7792 (class 0 OID 0)
-- Dependencies: 1
-- Name: EXTENSION adminpack; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION adminpack IS 'administrative functions for PostgreSQL';


--
-- TOC entry 4 (class 3079 OID 24612)
-- Name: citext; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS citext WITH SCHEMA public;


--
-- TOC entry 7793 (class 0 OID 0)
-- Dependencies: 4
-- Name: EXTENSION citext; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION citext IS 'data type for case-insensitive character strings';


--
-- TOC entry 6 (class 3079 OID 746890)
-- Name: file_fdw; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS file_fdw WITH SCHEMA pg_toast_temp_10;


--
-- TOC entry 7794 (class 0 OID 0)
-- Dependencies: 6
-- Name: EXTENSION file_fdw; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION file_fdw IS 'foreign-data wrapper for flat file access';


--
-- TOC entry 3 (class 3079 OID 1022258)
-- Name: pgcrypto; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS pgcrypto WITH SCHEMA public;


--
-- TOC entry 7795 (class 0 OID 0)
-- Dependencies: 3
-- Name: EXTENSION pgcrypto; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION pgcrypto IS 'cryptographic functions';


--
-- TOC entry 5 (class 3079 OID 16386)
-- Name: pgpool_recovery; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS pgpool_recovery WITH SCHEMA public;


--
-- TOC entry 7796 (class 0 OID 0)
-- Dependencies: 5
-- Name: EXTENSION pgpool_recovery; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION pgpool_recovery IS 'recovery functions for pgpool-II for V4.1 or later';


--
-- TOC entry 1095 (class 1255 OID 24752)
-- Name: extract_orphan(); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.extract_orphan() RETURNS void
    LANGUAGE plpgsql
    AS $$
declare c_cur cursor for select distinct cdc from ztes_orphans;

begin 
	delete from ztes_orphans_output;
	
	for row in c_cur loop
	insert into ztes_orphans_output
		 SELECT a.requestid,
			a.operatorid,
			a.terminalid,
			substr(a.terminalid::TEXT, 1, length(a.terminalid::TEXT) - 3)::INT locationid,
			a.transtime,
			CASE a.product WHEN 9 THEN '4D' WHEN 23 THEN 'TOTO' ELSE 'SWEEP' END product,
			a.details,
			a.STATUS,
			CASE b.tratyp WHEN 1 THEN 'Wager' WHEN 2 THEN 'Cancel' END TransType,
			a.transamt::numeric(9,2) / b.numdraws wageramt,
			(b.saleamount0 + b.saleamount1) / 100 salesamt,
			c.draws_draw drawnum,
			to_char(DATE '19860511' + interval '1 day' * d.drawcdc, 'dd Mon yyyy') drawdate,
			initcap(to_char(DATE '19860511' + interval '1 day' * d.drawcdc, 'day')) drawday
		FROM ztes_orphans a,
			ztes_mjf_journals b,
			ztes_mjf_draws c,
			ztes_pdf_drawparam d
		WHERE a.cdc = b.cdc
			AND a.product = b.prod
			AND a.terminalid = b.tratrmidn
			AND a.requestid = b.esaextchaninfo_foreignserial
			AND b.cdc = c.cdc
			AND b.journaladdress = c.journaladdress
			AND d.productnum = b.prod
			AND d.drawnumber = c.draws_draw
			AND a.cdc = row.cdc
			AND b.tratyp IN (1, 2)
			AND d.winset_id = 0
			AND d.przdiv_id = 1
		union all 

		SELECT a.requestid,
			a.operatorid,
			a.terminalid,
			substr(a.terminalid::TEXT, 1, length(a.terminalid::TEXT) - 3)::INT locationid,
			a.transtime,
			CASE a.product WHEN 9 THEN '4D' WHEN 23 THEN 'TOTO' ELSE 'SWEEP' END product,
			a.details,
			a.STATUS,
			'WinPaid' TransType,
			c.amount / 100 wageramt,
			c.amount / 100 salesamt,
			c.draw drawnum,
			to_char(DATE '19860511' + interval '1 day' * d.drawcdc, 'dd Mon yyyy') drawdate,
			initcap(to_char(DATE '19860511' + interval '1 day' * d.drawcdc, 'day')) drawday
		FROM ztes_orphans a,
			ztes_mjf_journals b,
			ztes_mjf_windtl c,
			ztes_pdf_drawparam d
		WHERE a.cdc = b.cdc
			AND a.product = b.prod
			AND a.terminalid = b.tratrmidn
			AND a.requestid = b.esaextchaninfo_foreignserial
			AND b.cdc = c.cdc
			AND b.journaladdress = c.journaladdress
			AND d.productnum = b.prod
			AND d.drawnumber = c.draw
			AND a.cdc = row.cdc
			AND b.tratyp = 3
			AND d.winset_id = 0
			AND d.przdiv_id = 1
		;

	end loop;
 end;

 $$;


ALTER FUNCTION public.extract_orphan() OWNER TO sp_postgres;

--
-- TOC entry 1096 (class 1255 OID 24753)
-- Name: extract_orphan_board(); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.extract_orphan_board() RETURNS void
    LANGUAGE plpgsql
    AS $$
declare c_cur cursor for 
	select distinct a.date cdcdate, b.business_id cdc from ztes_orphans_requestid a inner join ztall_businessday b
		on a.date=b.business_date and b.system = 'ES';

begin 
	delete from ztes_orphans_output_board;
	
	for row in c_cur loop
	insert into ztes_orphans_output_board
		 SELECT e.requestid,
				d.tratlr as operatorid, --a.operatorid,
				d.tratrmidn as terminalid, --a.terminalid,
				d.traagt as locationid, --substr(a.terminalid::TEXT, 1, length(a.terminalid::TEXT) - 3)::INT locationid,
				date_trunc('second', date'19700101' + interval '1 second' * d.tratim) as transtime, --a.transtime,
				CASE d.prod WHEN 9 THEN '4D' WHEN 23 THEN 'TOTO' ELSE 'SWEEP' END product,
				--a.details,
				--a.STATUS,
				CASE d.tratyp WHEN 1 THEN 'Wager' WHEN 2 THEN 'Cancel' END TransType,
				b.board_id, 
				b.board_desc, 
				c.draws_draw, 
				a.transamt0,
				a.transamt1,
				a.bettyp,
				d.fracwagerinfo_numfrac,
				d.partialwagerinfo_syndid
			FROM ztes_mjf_brdinf a
			     JOIN ztes_mjf_brdnums b ON a.cdc = b.cdc AND a.journaladdress = b.journaladdress AND a.board_id = b.board_id
			     LEFT JOIN ztes_mjf_draws c ON a.cdc = c.cdc AND a.journaladdress = c.journaladdress
			     LEFT JOIN ztes_mjf_journals d ON a.cdc = d.cdc AND a.journaladdress = d.journaladdress
			     LEFT JOIN ztes_orphans_requestid e on e.requestid = d.esaextchaninfo_foreignserial
			where d.tratyp IN (1, 2)
			AND d.cdc = row.cdc
			and e.date = row.cdcdate
			;

	end loop;
 end;

 $$;


ALTER FUNCTION public.extract_orphan_board() OWNER TO sp_postgres;

--
-- TOC entry 1277 (class 1255 OID 1385767)
-- Name: insert_bg(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.insert_bg(vfrdt date, vtodt date) RETURNS void
    LANGUAGE plpgsql
    AS $$

declare
	status_pnqr text[];
	status_pnric text[];

BEGIN  
	-- Get Success/Complete Paynow status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost 
	where host = 2
	and previousperioddatetime is not null;

	-- MM2
	delete from ztbg_daily where DATAORIGIN = 'MM2' and CALDAY between vFrDt and vToDt;
	
	insert into ztbg_daily
	select 'MM2' DATAORIGIN, CALDAY, RETAILER_ID,
		sum(FUNDING) as FUNDING, 
		sum(DAILY_SALES) as DAILY_SALES, 
		sum(TOTAL) as TOTAL,
		0 as EZLINK, 
		0 as CASHNET_INV, 
		0 as CASHNET_ON_INV, 
		0 as CASHNET_OFF_INV,
		0 as CASHNET_DAILY, 0 as CASHNET_ON_DAILY, 0 as CASHNET_OFF_DAILY,
		now()::timestamp without time zone,
		0 paynow_amount,
		0 paynow_qr_amount,
		0 REFUND_INV
	from (
		select invoicedate - 1 as CALDAY,
			salespointnumber as RETAILER_ID,
			fundingbalance as FUNDING, 
			0 as DAILY_SALES,
			netdue as TOTAL
		from ztmm2_invoiceperterminal 
		where invoicedate between vFrDt and vToDt
		union all
		select inv_dev.transactiondate - 1 as CALDAY,
			cast(inv_dev.salespointnumber as int) as RETAILER_ID,
			0 as FUNDING, 
			inv_dev.netdue as DAILY_SALES,
			0 as TOTAL
		from ztmm2_retailsummary inv_dev
		where transactiondate between vFrDt and vToDt
	) MM2
	group by CALDAY, RETAILER_ID
	;


	-- ES + RTMS
	delete from ztbg_daily where DATAORIGIN = 'ES' and CALDAY between vFrDt and vToDt;

	insert into ztbg_daily
	select 'ES' DATAORIGIN, 
		enddate CALDAY, 
		retailer RETAILER_ID, 
		sum(FUNDING)/100 as FUNDING, 
		(sum(dailysales) -sum(daily_paynow_qr_amount) + sum(daily_paynow_amount)- sum(daily_refund_amount))/100 as  DAILY_SALES, 
		sum(sales_amount)/100 as TOTAL, -- netdue - offline order
		sum(EZLINK) as EZLINK, 
		sum(online_amount+offline_amount)/100 as CASHNET_INV, 
		sum(online_amount)/100 as CASHNET_ON_INV, 
		sum(offline_amount)/100 as CASHNET_OFF_INV,
		sum(online_daily+offline_daily)/100 as CASHNET_DAILY, 
		sum(online_daily)/100 as CASHNET_ON_DAILY, 
		sum(offline_daily)/100 as CASHNET_OFF_DAILY,
		now()::timestamp without time zone,
		sum(coalesce(paynow_amount,0))/100 as paynow_amount,
		sum(coalesce(paynow_qr_amount,0))/100 as paynow_qr_amount,
		sum(coalesce(refund_amount,0))/100 as REFUND_INV
	from
	(
			-- invoice
			select b.enddate, 
				agentinvoice_agtidn retailer,
				case when sales_type in (571) then sales_amount else 0 end FUNDING,
				case when sales_type in (727, 2, 3, 110, 108, 47, 112, 109, 111, 113) then sales_amount 
					when sales_type in (1, 118) then sales_amount*-1 else 0 
					end sales_amount,
				case when sales_type in (108) then sales_amount else 0 end EZLINK,
				case when sales_type in (108, 110, 47, 112) then sales_amount else 0 end online_amount,
				case when sales_type in (109, 111, 113) then sales_amount else 0 end offline_amount,
				case when sales_type in (61) then sales_amount else 0 end refund_amount,
				0 dailysales,
				0 online_daily, 
				0 offline_daily,
				0 paynow_amount,
				0 paynow_qr_amount,
				0 daily_paynow_amount,
				0 daily_paynow_qr_amount,
				0 daily_refund_amount
				
			from ztes_inv_agt a 
				inner join ztes_inv_invdef b on a.agentinvoice_invid = b.invoiceperiod
			where (sales_type in (571,727,1,2,3,118,110,108,47,112,109,111,113) and agentinvoice_productid in (117,31,1)
				or (sales_type in (61) and agentinvoice_productid in (117,31,1,9,23,11)))--add sales_type= 61, product 9,23,11 lottery)
				and b.enddate between vFrDt and vToDt
	
			union all
			-- daily
			select business_date enddate, 
				deviceinvoice_agtidn retailer, 
				0 FUNDING, 
				0 sales_amount, 
				0 EZLINK, 
				0 online_amount, 
				0 offline_amount,
				0 refund_amount,--refund
				case when sales_type = 1 then sales_amount else sales_amount*-1 end dailysales,
				case when sales_type in (108, 110, 112) then sales_amount else 0 end online_daily,
				case when sales_type in (109, 111, 113) then sales_amount else 0 end offline_daily,
				0 paynow_amount,
				0 paynow_qr_amount,
				0 daily_paynow_amount,
				0 daily_paynow_qr_amount,
				case when sales_type in (61) then sales_amount else 0 end daily_refund_amount--refund
				
			from ztes_inv_dev a 
				inner join ztall_businessday on system='ES' and deviceinvoice_salescdc = business_id
			where sales_type in (1, 2, 3, 61, 7, 108, 110, 112, 109, 111, 113)
				and deviceinvoice_productid not in (31)
				and business_date between vFrDt and vToDt

			--RTMS
			union all
			select salesdate enddate, 
				retailer, 
				0 FUNDING, 
				0 sales_amount,
				0 EZLINK, 
				0 online_amount, 
				0 offline_amount,
				0 refund_amount,
				case when salestype = 1 then transamount else transamount*-1 end dailysales,
				0 online_daily,
				0 offline_daily,
				0 paynow_amount,
				0 paynow_qr_amount,
				0 daily_paynow_amount,
				0 daily_paynow_qr_amount,
				0 daily_refund_amount--refund
				
			from ztrtms_inv_dev a 
			where salestype in (1, 2, 3, 61, 7)
				and product in (20, 7) --add Horse Racing / BMCS
				and salesdate between vFrDt and vToDt

			Union all
			
			-- PaynowQR & Paynow
			-- PaynowQR & Paynow - invoice
			select cast(b.enddate as DATE) enddate, 
				cast(substring(zl.locdisplayid from '[1-9][0-9]*') as int) retailer,
				0 FUNDING, 
				0 sales_amount,
				0 EZLINK, 
				0 online_amount, 
				0 offline_amount,
				0 refund_amount,
				0 dailysales,
				0 online_daily,
				0 offline_daily,
				case when paymenttypeid='PNRIC' then coalesce(netamount,0) else 0 end as paynow_amount,
				case when paymenttypeid='PNQR' then coalesce(netamount,0) else 0 end as paynow_qr_amount,
				0 daily_paynow_amount,
				0 daily_paynow_qr_amount,
				0 daily_refund_amount
				
			from ztubt_paynowtransaction zp
			LEFT JOIN ubt_temp_busdatehost2 zgp
				on (zp.updateddatetime between zgp.previousperioddatetime and zgp.perioddatetime)
			inner join ztes_inv_invdef b on zgp.actualdate between b.startdate and b.enddate
        	inner join ztubt_cart zc ON zp.cartid = zc.cartid  
			inner join ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
			inner join ztubt_location zl ON zt.LocID = zl.LocID 
			where 1=1
    		and ((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
			or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
			)
			and cast(b.enddate as DATE) between vFrDt and vToDt
			
			Union all
			
			-- PaynowQR & Paynow - daily
			select cast(zgp.actualdate as DATE) enddate, 
				cast(substring(zl.locdisplayid from '[1-9][0-9]*') as int) retailer,
				0 FUNDING, 
				0 sales_amount,
				0 EZLINK, 
				0 online_amount, 
				0 offline_amount,
				0 refund_amount,
				0 dailysales,
				0 online_daily,
				0 offline_daily,
				0 paynow_amount,
				0 paynow_qr_amount,
				case when paymenttypeid='PNRIC' then coalesce(netamount,0) else 0 end as daily_paynow_amount,
				case when paymenttypeid='PNQR' then coalesce(netamount,0) else 0 end as daily_paynow_qr_amount,
				0 daily_refund_amount
				
			from ztubt_paynowtransaction zp
			LEFT JOIN ubt_temp_busdatehost2 zgp
				on (zp.updateddatetime between zgp.previousperioddatetime and zgp.perioddatetime)
        	inner join ztubt_cart zc ON zp.cartid = zc.cartid  
			inner join ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
			inner join ztubt_location zl ON zt.LocID = zl.LocID 
			where 1=1 
			and ((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
				or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
			)
			and zgp.actualdate between vFrDt and vToDt
	) as inv
	group by enddate, retailer;

    -- Clean up temporary tables
    DROP TABLE IF EXISTS  ubt_temp_busdatehost2;

 end;

 $$;


ALTER FUNCTION public.insert_bg(vfrdt date, vtodt date) OWNER TO sp_postgres;

--
-- TOC entry 1292 (class 1255 OID 24754)
-- Name: insert_bg_bk20240314(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.insert_bg_bk20240314(vfrdt date, vtodt date) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN  
	-- MM2
	delete from ztbg_daily where DATAORIGIN = 'MM2' and CALDAY between vFrDt and vToDt;
	
	insert into ztbg_daily
	select 'MM2' DATAORIGIN, CALDAY, RETAILER_ID,
		sum(FUNDING) as FUNDING, 
		sum(DAILY_SALES) as DAILY_SALES, 
		sum(TOTAL) as TOTAL,
		0 as EZLINK, 
		0 as CASHNET_INV, 
		0 as CASHNET_ON_INV, 
		0 as CASHNET_OFF_INV,
		0 as CASHNET_DAILY, 0 as CASHNET_ON_DAILY, 0 as CASHNET_OFF_DAILY,
		now()::timestamp without time zone
	from (
		select invoicedate - 1 as CALDAY,
			salespointnumber as RETAILER_ID,
			fundingbalance as FUNDING, 
			0 as DAILY_SALES,
			netdue as TOTAL
		from ztmm2_invoiceperterminal 
		where invoicedate between vFrDt and vToDt
		union all
		select inv_dev.transactiondate - 1 as CALDAY,
			cast(inv_dev.salespointnumber as int) as RETAILER_ID,
			0 as FUNDING, 
			inv_dev.netdue as DAILY_SALES,
			0 as TOTAL
		from ztmm2_retailsummary inv_dev
		where transactiondate between vFrDt and vToDt
	) MM2
	group by CALDAY, RETAILER_ID
	;


	-- ES + RTMS
	delete from ztbg_daily where DATAORIGIN = 'ES' and CALDAY between vFrDt and vToDt;

	insert into ztbg_daily
	select 'ES' DATAORIGIN, enddate CALDAY, 
		retailer RETAILER_ID, 
		sum(FUNDING)/100 as FUNDING, 
		sum(dailysales)/100 as  DAILY_SALES, 
		sum(sales_amount)/100 as TOTAL, -- netdue - offline order
		sum(EZLINK) as EZLINK, 
		sum(online_amount+offline_amount)/100 as CASHNET_INV, 
		sum(online_amount)/100 as CASHNET_ON_INV, 
		sum(offline_amount)/100 as CASHNET_OFF_INV,
		sum(online_daily+offline_daily)/100 as CASHNET_DAILY, 
		sum(online_daily)/100 as CASHNET_ON_DAILY, 
		sum(offline_daily)/100 as CASHNET_OFF_DAILY,
		now()::timestamp without time zone
	from
	(
			-- invoice
			select b.enddate, agentinvoice_agtidn retailer,
				case when sales_type in (571) then sales_amount else 0 end FUNDING,
				case when sales_type in (727, 2, 3, 110, 108, 47, 112, 109, 111, 113) then sales_amount when sales_type in (1, 118) then sales_amount*-1 else 0 end sales_amount,
				case when sales_type in (108) then sales_amount else 0 end EZLINK,
				case when sales_type in (108, 110, 47, 112) then sales_amount else 0 end online_amount,
				case when sales_type in (109, 111, 113) then sales_amount else 0 end offline_amount,
				0 dailysales, 0 online_daily, 0 offline_daily
			from ztes_inv_agt a 
				inner join ztes_inv_invdef b on a.agentinvoice_invid = b.invoiceperiod
			where sales_type in (571,727,1,2,3,118,110,108,47,112,109,111,113) and agentinvoice_productid in (117,31,1) 
				and b.enddate between vFrDt and vToDt
	
			union all
			-- daily
			select business_date enddate, deviceinvoice_agtidn retailer, 
				0 FUNDING, 0 sales_amount, 0 EZLINK, 0 online_amount, 0 offline_amount,
				case when sales_type = 1 then sales_amount else sales_amount*-1 end dailysales,
				case when sales_type in (108, 110, 112) then sales_amount else 0 end online_daily,
				case when sales_type in (109, 111, 113) then sales_amount else 0 end offline_daily
			from ztes_inv_dev a 
				inner join ztall_businessday on system='ES' and deviceinvoice_salescdc = business_id
			where sales_type in (1, 2, 3, 61, 7, 108, 110, 112, 109, 111, 113)
				and deviceinvoice_productid not in (31)
				and business_date between vFrDt and vToDt

			--RTMS
			union all
			select salesdate enddate, retailer, 
				0 FUNDING, 0 sales_amount, 0 EZLINK, 0 online_amount, 0 offline_amount,
				case when salestype = 1 then transamount else transamount*-1 end dailysales,
				0 online_daily, 0 offline_daily
			from ztrtms_inv_dev a 
			where salestype in (1, 2, 3, 61, 7)
				and product in (20)
				and salesdate between vFrDt and vToDt
	) as inv
	group by enddate, retailer;
	
 end;

 $$;


ALTER FUNCTION public.insert_bg_bk20240314(vfrdt date, vtodt date) OWNER TO sp_postgres;

--
-- TOC entry 1285 (class 1255 OID 1004487)
-- Name: insert_bg_bk20240604_epayment(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.insert_bg_bk20240604_epayment(vfrdt date, vtodt date) RETURNS void
    LANGUAGE plpgsql
    AS $$

declare
	status_pnqr text[];
	status_pnric text[];

BEGIN  
	-- Get Success/Complete Paynow status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost 
	where host = 2
	and previousperioddatetime is not null;

	-- MM2
	delete from ztbg_daily where DATAORIGIN = 'MM2' and CALDAY between vFrDt and vToDt;
	
	insert into ztbg_daily
	select 'MM2' DATAORIGIN, CALDAY, RETAILER_ID,
		sum(FUNDING) as FUNDING, 
		sum(DAILY_SALES) as DAILY_SALES, 
		sum(TOTAL) as TOTAL,
		0 as EZLINK, 
		0 as CASHNET_INV, 
		0 as CASHNET_ON_INV, 
		0 as CASHNET_OFF_INV,
		0 as CASHNET_DAILY, 0 as CASHNET_ON_DAILY, 0 as CASHNET_OFF_DAILY,
		now()::timestamp without time zone,
		0 paynow_amount,
		0 paynow_qr_amount
	from (
		select invoicedate - 1 as CALDAY,
			salespointnumber as RETAILER_ID,
			fundingbalance as FUNDING, 
			0 as DAILY_SALES,
			netdue as TOTAL
		from ztmm2_invoiceperterminal 
		where invoicedate between vFrDt and vToDt
		union all
		select inv_dev.transactiondate - 1 as CALDAY,
			cast(inv_dev.salespointnumber as int) as RETAILER_ID,
			0 as FUNDING, 
			inv_dev.netdue as DAILY_SALES,
			0 as TOTAL
		from ztmm2_retailsummary inv_dev
		where transactiondate between vFrDt and vToDt
	) MM2
	group by CALDAY, RETAILER_ID
	;


	-- ES + RTMS
	delete from ztbg_daily where DATAORIGIN = 'ES' and CALDAY between vFrDt and vToDt;

	insert into ztbg_daily
	select 'ES' DATAORIGIN, 
		enddate CALDAY, 
		retailer RETAILER_ID, 
		sum(FUNDING)/100 as FUNDING, 
		(sum(dailysales) -sum(daily_paynow_qr_amount) + sum(daily_paynow_amount))/100 as  DAILY_SALES, 
		sum(sales_amount)/100 as TOTAL, -- netdue - offline order
		sum(EZLINK) as EZLINK, 
		sum(online_amount+offline_amount)/100 as CASHNET_INV, 
		sum(online_amount)/100 as CASHNET_ON_INV, 
		sum(offline_amount)/100 as CASHNET_OFF_INV,
		sum(online_daily+offline_daily)/100 as CASHNET_DAILY, 
		sum(online_daily)/100 as CASHNET_ON_DAILY, 
		sum(offline_daily)/100 as CASHNET_OFF_DAILY,
		now()::timestamp without time zone,
		sum(coalesce(paynow_amount,0))/100 as paynow_amount,
		sum(coalesce(paynow_qr_amount,0))/100 as paynow_qr_amount
	from
	(
			-- invoice
			select b.enddate, 
				agentinvoice_agtidn retailer,
				case when sales_type in (571) then sales_amount else 0 end FUNDING,
				case when sales_type in (727, 2, 3, 110, 108, 47, 112, 109, 111, 113) then sales_amount 
					when sales_type in (1, 118) then sales_amount*-1 else 0 
					end sales_amount,
				case when sales_type in (108) then sales_amount else 0 end EZLINK,
				case when sales_type in (108, 110, 47, 112) then sales_amount else 0 end online_amount,
				case when sales_type in (109, 111, 113) then sales_amount else 0 end offline_amount,
				0 dailysales, 
				0 online_daily, 
				0 offline_daily,
				0 paynow_amount,
				0 paynow_qr_amount,
				0 daily_paynow_amount,
				0 daily_paynow_qr_amount
				
			from ztes_inv_agt a 
				inner join ztes_inv_invdef b on a.agentinvoice_invid = b.invoiceperiod
			where sales_type in (571,727,1,2,3,118,110,108,47,112,109,111,113) and agentinvoice_productid in (117,31,1) 
				and b.enddate between vFrDt and vToDt
	
			union all
			-- daily
			select business_date enddate, 
				deviceinvoice_agtidn retailer, 
				0 FUNDING, 
				0 sales_amount, 
				0 EZLINK, 
				0 online_amount, 
				0 offline_amount,
				case when sales_type = 1 then sales_amount else sales_amount*-1 end dailysales,
				case when sales_type in (108, 110, 112) then sales_amount else 0 end online_daily,
				case when sales_type in (109, 111, 113) then sales_amount else 0 end offline_daily,
				0 paynow_amount,
				0 paynow_qr_amount,
				0 daily_paynow_amount,
				0 daily_paynow_qr_amount
			from ztes_inv_dev a 
				inner join ztall_businessday on system='ES' and deviceinvoice_salescdc = business_id
			where sales_type in (1, 2, 3, 61, 7, 108, 110, 112, 109, 111, 113)
				and deviceinvoice_productid not in (31)
				and business_date between vFrDt and vToDt

			--RTMS
			union all
			select salesdate enddate, 
				retailer, 
				0 FUNDING, 
				0 sales_amount,
				 0 EZLINK, 
				0 online_amount, 
				0 offline_amount,
				case when salestype = 1 then transamount else transamount*-1 end dailysales,
				0 online_daily,
				0 offline_daily,
				0 paynow_amount,
				0 paynow_qr_amount,
				0 daily_paynow_amount,
				0 daily_paynow_qr_amount
			from ztrtms_inv_dev a 
			where salestype in (1, 2, 3, 61, 7)
				and product in (20)
				and salesdate between vFrDt and vToDt

			Union all
			
			-- PaynowQR & Paynow
			-- PaynowQR & Paynow - invoice
			select cast(b.enddate as DATE) enddate, 
				cast(substring(zl.locdisplayid from '[1-9][0-9]*') as int) retailer,
				0 FUNDING, 
				0 sales_amount,
				0 EZLINK, 
				0 online_amount, 
				0 offline_amount,
				0 dailysales,
				0 online_daily,
				0 offline_daily,
				case when paymenttypeid='PNRIC' then coalesce(netamount,0) else 0 end as paynow_amount,
				case when paymenttypeid='PNQR' then coalesce(netamount,0) else 0 end as paynow_qr_amount,
				0 daily_paynow_amount,
				0 daily_paynow_qr_amount
			from ztubt_paynowtransaction zp
			LEFT JOIN ubt_temp_busdatehost2 zgp
				on (zp.updateddatetime between zgp.previousperioddatetime and zgp.perioddatetime)
			inner join ztes_inv_invdef b on zgp.actualdate between b.startdate and b.enddate
        	inner join ztubt_cart zc ON zp.cartid = zc.cartid  
			inner join ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
			inner join ztubt_location zl ON zt.LocID = zl.LocID 
			where 1=1
    		and ((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
			or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
			)
			and cast(b.enddate as DATE) between vFrDt and vToDt
			
			Union all
			
			-- PaynowQR & Paynow - daily
			select cast(zgp.actualdate as DATE) enddate, 
				cast(substring(zl.locdisplayid from '[1-9][0-9]*') as int) retailer,
				0 FUNDING, 
				0 sales_amount,
				0 EZLINK, 
				0 online_amount, 
				0 offline_amount,
				0 dailysales,
				0 online_daily,
				0 offline_daily,
				0 paynow_amount,
				0 paynow_qr_amount,
				case when paymenttypeid='PNRIC' then coalesce(netamount,0) else 0 end as daily_paynow_amount,
				case when paymenttypeid='PNQR' then coalesce(netamount,0) else 0 end as daily_paynow_qr_amount
			from ztubt_paynowtransaction zp
			LEFT JOIN ubt_temp_busdatehost2 zgp
				on (zp.updateddatetime between zgp.previousperioddatetime and zgp.perioddatetime)
        	inner join ztubt_cart zc ON zp.cartid = zc.cartid  
			inner join ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
			inner join ztubt_location zl ON zt.LocID = zl.LocID 
			where 1=1 
			and ((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
				or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
			)
			and zgp.actualdate between vFrDt and vToDt
	) as inv
	group by enddate, retailer;

    -- Clean up temporary tables
    DROP TABLE IF EXISTS  ubt_temp_busdatehost2;

 end;

 $$;


ALTER FUNCTION public.insert_bg_bk20240604_epayment(vfrdt date, vtodt date) OWNER TO sp_postgres;

--
-- TOC entry 1098 (class 1255 OID 24755)
-- Name: just_check(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.just_check(transactiondate date) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare 
	FromDate timestamp ;
	ToDate timestamp;
	ConvertToSGT int4;
	ConvertToUTC int4;
	FromDateUTC timestamp ;
	ToDateUTC timestamp ;
	
	BEGIN	
		Select(TransactionDate - interval'1 Day')into FromDate;
		select (((date_part('day',current_timestamp at time zone 'utc')- date_part('day', current_timestamp)) *24) + (date_part('hour',current_timestamp at time zone 'utc'  )- date_part('hour',current_timestamp )))
		into ConvertToUTC;
	    select (((date_part('day',current_timestamp)- date_part('day', current_timestamp at time zone 'utc' )) *24) + (date_part('hour',current_timestamp  )- date_part('hour',current_timestamp at time zone 'utc' )))
	    into ConvertToSGT;
		SELECT 
		   PreviousPeriodDateTime,
		   PeriodDateTime
		   into FromDate, ToDate
	    FROM ztubt_getbusinessdate_perhost zgp 
	    WHERE ActualDate = FromDate
	    ORDER BY PreviousPeriodDateTime DESC, PeriodDateTime desc
	    limit 1 ;
	    select(FromDate + ( ConvertToUTC * interval'1 Hour' ) )into FromDateUTC;
	    select( ToDate + ( ConvertToUTC * interval'1 Hour' ))into ToDateUTC;

	    
	    create temp table if not exists ubt_temp_t
	     (
		    TerDisplayID VARCHAR(200),
		    SessionStartDateTime timestamp,
		    SessionEndDateTime timestamp,
		    SessionStartDateTimeUTC timestamp,
		    SessionEndDateTimeUTC timestamp,
		    SweepIndicator int4
	    );
	    
	    create temp table if not exists ubt_temp_count
	     (
		   TerDisplayID VARCHAR(200),
		   FirstDate timestamp,
		   FirstCount int4,
		   LastCount int4,
		   TranHeaderLineItemId VARCHAR(500)
	     );
	    select SESS.TerDisplayID, MIN(SessionStartDateTime) AS SessionStartDateTime, MAX(SessionEndDateTime) AS SessionEndDateTime,
	    MIN(SessionStartDateTime + (convertToUTC * interval'1 Hour')) AS SessionStartDateTime, MAX( SessionEndDateTime + (convertToUTC * interval'1 Hour')) AS SessionEndDateTime,--convert to UTC--(3)
	    LOC.SweepIndicator
	    FROM ztubt_session SESS
	    inner join ztubt_terminal ter on SESS.TerDisplayID=ter.TerDisplayID
	    inner join ztubt_location LOC on TER.LocID=LOC.LocID
	    WHERE SessionStartDateTime >= FromDate
	    AND SessionStartDateTime <= ToDate
	    GROUP BY SESS.TerDisplayID, LOC.SweepIndicator ;
end;
$$;


ALTER FUNCTION public.just_check(transactiondate date) OWNER TO consultant01;

--
-- TOC entry 1275 (class 1255 OID 1374598)
-- Name: sp_nyx_test(); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_nyx_test() RETURNS void
    LANGUAGE plpgsql
    AS $$
	BEGIN
insert into public.nyx_auto_job_log (channel_id)
select channel_id from nyx_auto_job_entry_log;
	END;
$$;


ALTER FUNCTION public.sp_nyx_test() OWNER TO sp_postgres;

--
-- TOC entry 1099 (class 1255 OID 24756)
-- Name: sp_test(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_test(businessdate date) RETURNS TABLE(inputfromdate timestamp without time zone, inputtodate timestamp without time zone, fromdatetimeigt timestamp without time zone, todatetimeigt timestamp without time zone, utcfromdatetimeigt timestamp without time zone, utctodatetimeigt timestamp without time zone, utcfromdatetimeob timestamp without time zone, utctodatetimeob timestamp without time zone)
    LANGUAGE plpgsql
    AS $$

#variable_conflict use_column
	
	declare 
	vbusinessdate date;
	vinputdate date;
	vstartperiod date;
	vendperiod date;
	vfromdateIGT timestamp;
	vtodateIGT timestamp;
	vfromdatetimeIGT_UTC timestamp;
	vtodatetimeIGT_UTC timestamp;
	vfromdatetimeOB_UTC timestamp;
	vtodatetimeOB_UTC timestamp;
	--vinvoiceperiodid varchar(100);
	vactualdate date;
	
	BEGIN	
 select businessdate into  vbusinessdate ;
	select  (vbusinessdate :: date) +  interval '1 DAY' into  vinputdate ;

	select (vbusinessdate :: date) + interval '1 DAY' into  vactualdate ;
	
	
select case when to_char(vinputdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date )- interval '3 day'
else date_trunc('week',vinputdate ::date ) end ,

case when to_char(vinputdate  ::date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date)- interval '1 day'
else date_trunc('week',vinputdate ::date )+ interval '3 day' end 

into  vstartperiod,vendperiod;

select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob

into 

vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC 
from public.sp_ubt_getcommonubtdates(vstartperiod,vendperiod);

return query
select inputfromdate,inputtodate,fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob from public.sp_ubt_getcommonubtdates (vstartperiod,vendperiod);

--select vstartperiod,vendperiod;
end;
 $$;


ALTER FUNCTION public.sp_test(businessdate date) OWNER TO consultant01;

--
-- TOC entry 1103 (class 1255 OID 24757)
-- Name: sp_test(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_test(startdatetime timestamp without time zone, enddatetime timestamp without time zone) RETURNS TABLE(inputfromdate timestamp without time zone, inputtodate timestamp without time zone, fromdatetimeigt timestamp without time zone, todatetimeigt timestamp without time zone, utcfromdatetimeigt timestamp without time zone, utctodatetimeigt timestamp without time zone, utcfromdatetimeob timestamp without time zone, utctodatetimeob timestamp without time zone)
    LANGUAGE plpgsql
    AS $$

#variable_conflict use_column
	
	declare 
	businessdate date;
	vinputdate date;
	vstartperiod date;
	vendperiod date;
	vfromdateIGT timestamp;
	vtodateIGT timestamp;
	vfromdatetimeIGT_UTC timestamp;
	vtodatetimeIGT_UTC timestamp;
	vfromdatetimeOB_UTC timestamp;
	vtodatetimeOB_UTC timestamp;
	--vinvoiceperiodid varchar(100);
	vactualdate date;
	
	BEGIN	
	--select '2021-11-10' into  businessdate ;
	select  (businessdate :: date) +  interval '1 DAY' into  vinputdate ;

	select (businessdate :: date) + interval '1 DAY' into  vactualdate ;
	
	
select case when to_char(vinputdate ,'Day' ) in ('Monday','Tuesday','Wednesday','Thursday')
then date_trunc('week',vinputdate )- interval '3 day'
else date_trunc('week',vinputdate ) end ,

case when to_char(vinputdate ,'Day' ) in ('Monday','Tuesday','Wednesday','Thursday')
then date_trunc('week',vinputdate :: timestamp)- interval '1 day'
else date_trunc('week',vinputdate :: timestamp)+ interval '3 day' end 

into  vstartperiod,vendperiod;

select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob

into 

vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC 
from public.sp_ubt_getcommonubtdates(vstartperiod,vendperiod);

return query
select inputfromdate,inputtodate,fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob from public.sp_ubt_getcommonubtdates (vstartperiod,vendperiod);
end;
 $$;


ALTER FUNCTION public.sp_test(startdatetime timestamp without time zone, enddatetime timestamp without time zone) OWNER TO consultant01;

--
-- TOC entry 1092 (class 1255 OID 2073653)
-- Name: sp_ubt_cf_sum_summary_report(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_cf_sum_summary_report(drawcloseddate date, prodid integer) RETURNS TABLE(hostdrawdatesid integer, subprod text, flag character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
v_drawcloseddate date;
v_prodid int4;

begin
select drawcloseddate into v_drawcloseddate;
select prodid into v_prodid;

CREATE  temp TABLE ubt_temp_report_Summary 
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId int4,
		SubProd text,
		FLAG VARCHAR(15),
		Amount numeric(32, 12)
	);
		
		CREATE TEMP  TABLE ubt_temp_CFSUMReport
	(
		
		HostDrawDatesId Int4,
		ActualDate DATE,
		SubProd text,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesFactorAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12),
		SalesCommAmount numeric(32, 12),
		iscancelled Int4
		
	);
		
insert into ubt_temp_CFSUMReport
select * from public.sp_ubt_getcfsumreport(v_drawcloseddate,v_prodid);




--Collection
	INSERT INTO ubt_temp_report_Summary
	SELECT HostDrawDatesId, SubProd, '1Collections', SUM(Wager+SecondWager)
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId, SubProd
	union all
	--Sales

	SELECT HostDrawDatesId, SubProd, '4Sales', trunc(SUM(SalesFactorAmount),2) + trunc(SUM(SecondSalesFactorAmount),2) --sum each the big and small then truncate two 2 dp each then sum the big and small sales amount
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId, SubProd
	union all	
	--Sales Commission
	
	SELECT HostDrawDatesId, SubProd, '5Commission', trunc(SUM(SalesCommAmount),2) --sum the sales comm then truncate to 2 dp
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId, SubProd;


	IF (v_ProdID = 2) --4D
	THEN
	--Big
		INSERT INTO ubt_temp_report_Summary
		SELECT HostDrawDatesId, SubProd, '2Big', SUM(Wager)
		FROM  ubt_temp_CFSUMReport  CF
		GROUP BY HostDrawDatesId, SubProd
		union all
	--Small
		SELECT HostDrawDatesId, SubProd, '3Small', SUM(SecondWager)
		FROM ubt_temp_CFSUMReport CF
		GROUP BY HostDrawDatesId, SubProd;
	end IF;

	return query
	select HostDrawDatesid,SubProd,flag,amount from ubt_temp_report_Summary;

drop table if exists ubt_temp_CFSUMReport;
drop table if exists ubt_temp_report_Summary;


	END;
$$;


ALTER FUNCTION public.sp_ubt_cf_sum_summary_report(drawcloseddate date, prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1293 (class 1255 OID 1443095)
-- Name: sp_ubt_cf_sum_summary_report_bk20240604(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_cf_sum_summary_report_bk20240604(drawcloseddate date, prodid integer) RETURNS TABLE(hostdrawdatesid integer, flag character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
v_drawcloseddate date;
v_prodid int4;

begin
select drawcloseddate into v_drawcloseddate;
select prodid into v_prodid;

CREATE  temp TABLE ubt_temp_report_Summary 
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId int4,
		FLAG VARCHAR(15),
		Amount numeric(32, 12)
	);
		
		CREATE TEMP  TABLE ubt_temp_CFSUMReport
	(
		
		HostDrawDatesId Int4,
		ActualDate DATE,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesFactorAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12),
		SalesCommAmount numeric(32, 12)
		
	);
		
insert into ubt_temp_CFSUMReport
select * from public.sp_ubt_getcfsumreport(v_drawcloseddate,v_prodid);




--Collection
	INSERT INTO ubt_temp_report_Summary
	SELECT HostDrawDatesId, '1Collections', SUM(Wager+SecondWager)
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId
	union all
	--Sales

	SELECT HostDrawDatesId, '4Sales', trunc(SUM(SalesFactorAmount),2) + trunc(SUM(SecondSalesFactorAmount),2) --sum each the big and small then truncate two 2 dp each then sum the big and small sales amount
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId
	union all	
	--Sales Commission
	
	SELECT HostDrawDatesId, '5Commission', trunc(SUM(SalesCommAmount),2) --sum the sales comm then truncate to 2 dp
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId;


	IF (v_ProdID = 2) --4D
	THEN
	--Big
		INSERT INTO ubt_temp_report_Summary
		SELECT HostDrawDatesId, '2Big', SUM(Wager)
		FROM  ubt_temp_CFSUMReport  CF
		GROUP BY HostDrawDatesId
		union all
	--Small
		SELECT HostDrawDatesId, '3Small', SUM(SecondWager)
		FROM ubt_temp_CFSUMReport CF
		GROUP BY HostDrawDatesId;
	end IF;

	return query
	select HostDrawDatesid,flag,amount from ubt_temp_report_Summary;

drop table if exists ubt_temp_CFSUMReport;
drop table if exists ubt_temp_report_Summary;


	END;
$$;


ALTER FUNCTION public.sp_ubt_cf_sum_summary_report_bk20240604(drawcloseddate date, prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1091 (class 1255 OID 2073652)
-- Name: sp_ubt_cf_sum_summary_report_bk20241010(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_cf_sum_summary_report_bk20241010(drawcloseddate date, prodid integer) RETURNS TABLE(hostdrawdatesid integer, flag character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
v_drawcloseddate date;
v_prodid int4;

begin
select drawcloseddate into v_drawcloseddate;
select prodid into v_prodid;

CREATE  temp TABLE ubt_temp_report_Summary 
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId int4,
		FLAG VARCHAR(15),
		Amount numeric(32, 12)
	);
		
		CREATE TEMP  TABLE ubt_temp_CFSUMReport
	(
		
		HostDrawDatesId Int4,
		ActualDate DATE,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesFactorAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12),
		SalesCommAmount numeric(32, 12),
		iscancelled Int4
		
	);
		
insert into ubt_temp_CFSUMReport
select * from public.sp_ubt_getcfsumreport(v_drawcloseddate,v_prodid);




--Collection
	INSERT INTO ubt_temp_report_Summary
	SELECT HostDrawDatesId, '1Collections', SUM(Wager+SecondWager)
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId
	union all
	--Sales

	SELECT HostDrawDatesId, '4Sales', trunc(SUM(SalesFactorAmount),2) + trunc(SUM(SecondSalesFactorAmount),2) --sum each the big and small then truncate two 2 dp each then sum the big and small sales amount
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId
	union all	
	--Sales Commission
	
	SELECT HostDrawDatesId, '5Commission', trunc(SUM(SalesCommAmount),2) --sum the sales comm then truncate to 2 dp
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId;


	IF (v_ProdID = 2) --4D
	THEN
	--Big
		INSERT INTO ubt_temp_report_Summary
		SELECT HostDrawDatesId, '2Big', SUM(Wager)
		FROM  ubt_temp_CFSUMReport  CF
		GROUP BY HostDrawDatesId
		union all
	--Small
		SELECT HostDrawDatesId, '3Small', SUM(SecondWager)
		FROM ubt_temp_CFSUMReport CF
		GROUP BY HostDrawDatesId;
	end IF;

	return query
	select HostDrawDatesid,flag,amount from ubt_temp_report_Summary;

drop table if exists ubt_temp_CFSUMReport;
drop table if exists ubt_temp_report_Summary;


	END;
$$;


ALTER FUNCTION public.sp_ubt_cf_sum_summary_report_bk20241010(drawcloseddate date, prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1118 (class 1255 OID 2078008)
-- Name: sp_ubt_cf_sum_summary_report_testorg(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_cf_sum_summary_report_testorg(drawcloseddate date, prodid integer) RETURNS TABLE(hostdrawdatesid integer, flag character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
v_drawcloseddate date;
v_prodid int4;

begin
select drawcloseddate into v_drawcloseddate;
select prodid into v_prodid;

CREATE  temp TABLE ubt_temp_report_Summary 
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId int4,
		FLAG VARCHAR(15),
		Amount numeric(32, 12)
	);
		
		CREATE TEMP  TABLE ubt_temp_CFSUMReport
	(
		
		HostDrawDatesId Int4,
		ActualDate DATE,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesFactorAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12),
		SalesCommAmount numeric(32, 12),
		iscancelled Int4
		
	);
		
insert into ubt_temp_CFSUMReport
select * from public.sp_ubt_getcfsumreport_bk20241010(v_drawcloseddate,v_prodid);




--Collection
	INSERT INTO ubt_temp_report_Summary
	SELECT HostDrawDatesId, '1Collections', SUM(Wager+SecondWager)
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId
	union all
	--Sales

	SELECT HostDrawDatesId, '4Sales', trunc(SUM(SalesFactorAmount),2) + trunc(SUM(SecondSalesFactorAmount),2) --sum each the big and small then truncate two 2 dp each then sum the big and small sales amount
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId
	union all	
	--Sales Commission
	
	SELECT HostDrawDatesId, '5Commission', trunc(SUM(SalesCommAmount),2) --sum the sales comm then truncate to 2 dp
	FROM ubt_temp_CFSUMReport CF
	GROUP BY HostDrawDatesId;


	IF (v_ProdID = 2) --4D
	THEN
	--Big
		INSERT INTO ubt_temp_report_Summary
		SELECT HostDrawDatesId, '2Big', SUM(Wager)
		FROM  ubt_temp_CFSUMReport  CF
		GROUP BY HostDrawDatesId
		union all
	--Small
		SELECT HostDrawDatesId, '3Small', SUM(SecondWager)
		FROM ubt_temp_CFSUMReport CF
		GROUP BY HostDrawDatesId;
	end IF;

	return query
	select HostDrawDatesid,flag,amount from ubt_temp_report_Summary;

drop table if exists ubt_temp_CFSUMReport;
drop table if exists ubt_temp_report_Summary;


	END;
$$;


ALTER FUNCTION public.sp_ubt_cf_sum_summary_report_testorg(drawcloseddate date, prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1160 (class 1255 OID 2212486)
-- Name: sp_ubt_check_draw_close_date(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_check_draw_close_date(v_drawcloseddate date, v_prodid integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$ 

Declare v_HostDrawDatesId Integer := (SELECT HostDrawDatesId FROM public.ztubt_drawdates_master  
	WHERE DrawEndDate = v_DrawClosedDate AND ProdID = v_ProdID);

begin

IF v_HostDrawDatesId IS NULL 
THEN 
		v_HostDrawDatesId := (SELECT HostDrawDatesId
		FROM public.ZTubt_Cart C
		INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON C.CartID = PBTH.CartID
		INNER JOIN public.ztUBT_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID
		LEFT JOIN public.ztubt_getbusinessdate_perhost BD ON C.CartCreatedDate >=  BD.PreviousPeriodDateTime + interval '-8 hour' AND C.CartCreatedDate < BD.PeriodDateTime + interval '-8 hour'
		WHERE DD.DrawDate = v_DrawClosedDate AND PBTH.ProdID = v_ProdID
		AND DD.HostDrawDatesId NOT IN (
			SELECT DISTINCT HostDrawDatesId
			FROM public.ztUBT_DrawDates
			WHERE DrawDate > v_drawcloseddate
		)
		GROUP BY HostDrawDatesId);
	END IF;

IF v_HostDrawDatesId is not NULL
then
		return  1;
	ELSE
		 return  0;
	end if;
end;

$$;


ALTER FUNCTION public.sp_ubt_check_draw_close_date(v_drawcloseddate date, v_prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1151 (class 1255 OID 24759)
-- Name: sp_ubt_check_draw_close_date_bk20241010(date, integer); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_check_draw_close_date_bk20241010(v_drawcloseddate date, v_prodid integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$ 

Declare v_HostDrawDatesId Integer := (SELECT HostDrawDatesId FROM public.ztubt_drawdates_master  
	WHERE DrawEndDate = v_DrawClosedDate AND ProdID = v_ProdID);

begin

IF v_HostDrawDatesId IS NULL 
THEN 
		v_HostDrawDatesId := (SELECT HostDrawDatesId
		FROM public.ZTubt_Cart C
		INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON C.CartID = PBTH.CartID
		INNER JOIN public.ztUBT_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID
		LEFT JOIN public.ztubt_getbusinessdate_perhost BD ON C.CartCreatedDate >=  BD.PreviousPeriodDateTime + interval '-8 hour' AND C.CartCreatedDate < BD.PeriodDateTime + interval '-8 hour'
		WHERE DD.DrawDate = v_DrawClosedDate AND PBTH.ProdID = v_ProdID
		GROUP BY HostDrawDatesId);
	END IF;

IF v_HostDrawDatesId is not NULL
then
		return  1;
	ELSE
		 return  0;
	end if;
end;

$$;


ALTER FUNCTION public.sp_ubt_check_draw_close_date_bk20241010(v_drawcloseddate date, v_prodid integer) OWNER TO consultant01;

--
-- TOC entry 1280 (class 1255 OID 1702090)
-- Name: sp_ubt_common_test(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_common_test(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$

declare
-- vHQLocation varchar:='008888';
vNowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vGSTRate numeric; --percentage

begin
	-- GST Config
	SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
    FROM ztubt_gstconfig zg
    WHERE inbusinessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
    ORDER BY zg.effectivefrom
    LIMIT 1;
	
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_paynow_FirstDate
	(
		Amt numeric(32,3),
		Fee numeric(32,3),
		ProductName VARCHAR(100),
		TerDisplayID VARCHAR(200)
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);

	insert into ubt_tmp_paynow_FirstDate
	select
		SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'PaynowQR' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') and amount <> 0
		group by terdisplayid
	union select
		SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'Paynow' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('Paynow [+trans fee]', 'Paynow') and amount <> 0
		group by terdisplayid;

	-- Add Paynow to ubt_tmp_V2_TAD_FirstDate
	insert into ubt_tmp_V2_TAD_FirstDate 
	select
		terdisplayid, ProductName, (a.Amt - a.Fee) as Amount,
		0 as ct, 'CAS' as FLAG, 'CL' as TransType,
		InBusinessDate as FromDate, InBusinessDate as InToDate
		from ubt_tmp_paynow_FirstDate a;
	DROP TABLE IF EXISTS ubt_tmp_paynow_FirstDate;

	insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);


    IF vNowDayName IN (0, 4) THEN
        SELECT CASE 
                WHEN vNowDayName = 0 THEN inbusinessdate + INTERVAL '-2 DAY'
                WHEN vNowDayName = 4 THEN inbusinessdate + INTERVAL '-3 DAY'
            END INTO vPeriodStartDate;

            create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
                        (
                            TerDisplayID varchar(100),
                            ProductName varchar(100),
                            Amount decimal(32, 3),
                            FLAG char(5),
                            Type char(5)
                        );

            create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
                LocID INT,
                LocDisplayID VARCHAR(100),
                LocName VARCHAR(100),
                LocType int,
                IsIBG bool,
                IsGST bool,
                ProductName varchar(100),
                Amount numeric(32, 3),
                FLAG varchar(20),
                Type varchar(25)
            );

            create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
            (
                TerDisplayID VARCHAR(200),
                ProductName VARCHAR(100),
                Amount numeric(32, 11), 
                Ct INT,
                FLAG CHAR(3),
                TransType CHAR(2),
                FromDate Date,
                ToDate Date
                --INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
            );

            insert into ubt_tmp_V2_TAD_SecondDate
            select
                terdisplayid,
                prodname,
                amount,
                ticketcount ,
                FLAG,
                TransType,
                vPeriodStartDate as FromDate,
                vPeriodEndDate as InToDate
                from public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);

                create temporary table if not exists ubt_tmp_paynow_SecondDate
                (
                    Amt numeric(32,3),
                    Fee numeric(32,3),
                    ProductName VARCHAR(100),
                    TerDisplayID VARCHAR(200)
                );
                insert into ubt_tmp_paynow_SecondDate
                select
                    SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
                    SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
                    'PaynowQR' as ProductName, terdisplayid
                    from ubt_tmp_V2_TAD_SecondDate
                    where flag='CAS' and amount <> 0 and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') 
                    group by terdisplayid
                union select
                    SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
                    SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
                        'Paynow' as ProductName, terdisplayid
                    from ubt_tmp_V2_TAD_SecondDate
                    where flag='CAS' and amount <> 0 and ProductName in ('Paynow [+trans fee]', 'Paynow') 
                    group by terdisplayid;

                -- Add Paynow to ubt_tmp_V2_TAD_SecondDate
                insert into ubt_tmp_V2_TAD_SecondDate 
                select
                    terdisplayid, ProductName, (a.Amt - a.Fee) as amount,
                    0 as ticketcount, 'CAS' as FLAG, 'CL' as TransType,
                    vPeriodStartDate as FromDate, vPeriodEndDate as InToDate
                    from ubt_tmp_paynow_SecondDate a;
                DROP TABLE IF EXISTS ubt_tmp_paynow_SecondDate;

                CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_SecondDate (FLAG, ProductName);

    END IF;
 
	return query
		select * from public.sp_ubt_getrtshopcloud_hr_test_performance(inbusinessdate) 
			union all
		select * from public.sp_ubt_getrtshopcloud_sports_test_performance(inbusinessdate);

end;

$$;


ALTER FUNCTION public.sp_ubt_common_test(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1105 (class 1255 OID 24760)
-- Name: sp_ubt_debug_test(character varying, character varying, character varying); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_debug_test(vfunc character varying, vdebug character varying, vremarks character varying) RETURNS void
    LANGUAGE plpgsql
    AS $$ 
begin
	
	insert into ztubt_debug 
	values (vFunc, vDebug,current_timestamp, vRemarks);
--	commit;

end;

$$;


ALTER FUNCTION public.sp_ubt_debug_test(vfunc character varying, vdebug character varying, vremarks character varying) OWNER TO consultant01;

--
-- TOC entry 1106 (class 1255 OID 24761)
-- Name: sp_ubt_facthousekeeping(integer); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_facthousekeeping(in_months integer) RETURNS void
    LANGUAGE plpgsql
    AS $$ 

declare


begin 

delete from ztubt_placedbettransactionheader zp 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_placedbettransactionheaderlifecyclestate 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_sports_placedbettransactionlineitem 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_sports_placedbettransactionlineitemnumber 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_sweep_placedbettransactionlineitem 
	where 1=1 
    and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_sweep_placedbettransactionlineitemnumber 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(viewcreateddate ,'YYYYMM')::int > in_months;
delete from ztubt_toto_placedbettransactionlineitem 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(viewcreateddate,'YYYYMM')::int > in_months;
delete from ztubt_toto_placedbettransactionlineitemnumber 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(viewcreateddate,'YYYYMM')::int > in_months;
delete from ztubt_validatedbetticket 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createdvalidationdate,'YYYYMM')::int > in_months;
delete from ztubt_validatedbetticketlifecyclestate 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(viewcreateddate,'YYYYMM')::int > in_months;
delete from  ztubt_4d_placedbettransactionlineitem 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(viewcreateddate ,'YYYYMM')::int > in_months;
delete from ztubt_4d_placedbettransactionlineitemnumber 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(viewcreateddate,'YYYYMM')::int > in_months;
delete from ztubt_cancelledbetticket 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createdcancellationdate,'YYYYMM')::int > in_months;
delete from ztubt_cancelledbetticketlifecyclestate 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(viewcreateddate ,'YYYYMM')::int > in_months;
delete from ztubt_drawdates 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(viewcreateddate ,'YYYYMM')::int > in_months;
delete from ztubt_horse_placedbettransactionlineitem 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_admissionvouchertransaction 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_cart 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_charitytickettransaction 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_offlineproductheader 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(transactiontime,'YYYYMM')::int > in_months;
delete from ztubt_paymentdetail 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_spatransaction 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_topupcardtransaction
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;
delete from ztubt_totohongbaotransaction 
	where 1=1
	and to_char(current_date,'YYYYMM')::int - to_char(createddate,'YYYYMM')::int > in_months;


	
--	commit;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_facthousekeeping(in_months integer) OWNER TO consultant01;

--
-- TOC entry 1110 (class 1255 OID 24762)
-- Name: sp_ubt_get_adjust_invoice(); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_get_adjust_invoice() RETURNS TABLE(lastadjustmentdate text, adjrec_updateserial integer, adjrec_invid integer, locdisplayid character varying, adjrec_trantype integer, adjrec_lineitemcode integer, updateddatetime text, adjrec_agentstatus integer, codename character varying, adjustmentamount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	BEGIN

		return query
	select 
	to_char(bd.actualdate:: timestamp,'YYYYMMDD') as lastadjustmentdate,
	sapip.invoiceperiodid as adjrec_updateserial,	--accenture will align with es before go live
	sapip.invoiceperiodid as adjrec_invid,			--accenture will align with es before go live
	loc.locdisplayid,
	case
		when left(lv.fld2value, 1) in ('c','C') then 1
		when left(lv.fld2value, 1) in ('d','D') then 2
	end as adjrec_trantype,
	1 as adjrec_lineitemcode,
	to_char(adj.updateddatetime :: timestamp,'YYYYMMDDHH24MISS') as updateddatetime,
	case
		when adj.updateddatetime < lsc.createddatetime and lsc.rownum = 1 then --(2)
			case lsc.status --take the reverse of first location status
				when 1 then 2 -- active
				when 0 then 1 -- inactive
			end
		else
			(case
				when lsc.status = 1 then 1 -- inactive
				when lsc.status = 0 then 2 -- active
				when lsc.status is null then 
				(case loc.isdeleted 
					when true then 1 -- inactive
					when false then 2 -- active
				end)
			end)
	end as adjrec_agentstatus,
	lv.fld2value as codename,
	cast(adj.adjustmentamount as numeric(10, 0)) as adjustmentamount
--	select adj.*
	from  public.ztubt_adjustinvoice  adj
	left join 
	(
		select max(previousperioddatetime) as previousperioddatetime, max(perioddatetime) as perioddatetime, actualdate
		 from public.ztubt_getbusinessdate_perhost bd
		group by actualdate
		
	)bd on (adj.updateddatetime <= bd.perioddatetime and adj.updateddatetime > previousperioddatetime) 
			or (adj.updateddatetime <= bd.perioddatetime and bd.previousperioddatetime is null)
	left join
	(
		select lsp.rownum, lsp.locid, lsp.status, lsp.createddatetime, lsp.nextcreateddatetime
		from public.sp_ubt_get_location_status_period() lsp
		
	)lsc on adj.locid = lsc.locid 
	left join public.ztubt_location  loc on adj.locid = loc.locid
	left join public.ztubt_lookupvalueconfig  lv on adj.adjustmentcode = (lv.fld1value:: int) and upper(configname) = upper('rtms_adjustmentcode')
	left join public.ztubt_invoiceperiod sapip on bd.actualdate between sapip.startdate and sapip.enddate
	where ((adj.updateddatetime between lsc.createddatetime and coalesce (lsc.nextcreateddatetime:: timestamp, '2099-01-01':: timestamp)) 
			or (adj.updateddatetime < lsc.createddatetime and lsc.rownum = 1) or lsc.locid is null) --(1)--(2)
	and adj.approvalstatus = 1 --approved --(3)
;

END;
$$;


ALTER FUNCTION public.sp_ubt_get_adjust_invoice() OWNER TO consultant01;

--
-- TOC entry 1111 (class 1255 OID 24763)
-- Name: sp_ubt_get_adjust_invoice_bkp(); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_get_adjust_invoice_bkp() RETURNS TABLE(lastadjustmentdate text, adjrec_updateserial integer, adjrec_invid integer, locdisplayid character varying, adjrec_trantype integer, adjrec_lineitemcode integer, updateddatetime text, adjrec_agentstatus integer, codename character varying, adjustmentamount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	BEGIN

		return query
	select 
	to_char(bd.actualdate:: timestamp,'YYYYMMDD') as lastadjustmentdate,
	sapip.invoiceperiodid as adjrec_updateserial,	--accenture will align with es before go live
	sapip.invoiceperiodid as adjrec_invid,			--accenture will align with es before go live
	loc.locdisplayid,
	case
		when left(lv.fld2value, 1) in ('c','C') then 1
		when left(lv.fld2value, 1) in ('d','D') then 2
	end as adjrec_trantype,
	1 as adjrec_lineitemcode,
	to_char(adj.updateddatetime :: timestamp,'YYYYMMDDHH24MISS') as updateddatetime,
	case
		when adj.updateddatetime < lsc.createddatetime and lsc.rownum = 1 then --(2)
			case lsc.status --take the reverse of first location status
				when 1 then 2 -- active
				when 0 then 1 -- inactive
			end
		else
			(case
				when lsc.status = 1 then 1 -- inactive
				when lsc.status = 0 then 2 -- active
				when lsc.status is null then 
				(case loc.isdeleted 
					when true then 1 -- inactive
					when false then 2 -- active
				end)
			end)
	end as adjrec_agentstatus,
	lv.fld2value as codename,
	cast(adj.adjustmentamount as numeric(10, 0)) as adjustmentamount
--	select adj.*
	from  public.ztubt_adjustinvoice  adj
	left join 
	(
		select max(previousperioddatetime) as previousperioddatetime, max(perioddatetime) as perioddatetime, actualdate
		 from public.ztubt_getbusinessdate_perhost bd
		group by actualdate
		
	)bd on (adj.updateddatetime <= bd.perioddatetime and adj.updateddatetime > previousperioddatetime) 
			--or (adj.updateddatetime <= bd.perioddatetime and bd.previousperioddatetime is null)
	left join
	(
		select lsp.rownum, lsp.locid, lsp.status, lsp.createddatetime, lsp.nextcreateddatetime
		from public.sp_ubt_get_location_status_period() lsp
		
	)lsc on adj.locid = lsc.locid 
	left join public.ztubt_location  loc on adj.locid = loc.locid
	left join public.ztubt_lookupvalueconfig  lv on adj.adjustmentcode = (lv.fld1value:: int) and upper(configname) = upper('rtms_adjustmentcode')
	left join public.ztubt_invoiceperiod sapip on bd.actualdate between sapip.startdate and sapip.enddate
	where ((adj.updateddatetime between lsc.createddatetime and coalesce (lsc.nextcreateddatetime:: timestamp, '2099-01-01':: timestamp)) 
			or (adj.updateddatetime < lsc.createddatetime and lsc.rownum = 1) or lsc.locid is null) --(1)--(2)
	and adj.approvalstatus = 1 --approved --(3)
;

END;
$$;


ALTER FUNCTION public.sp_ubt_get_adjust_invoice_bkp() OWNER TO consultant01;

--
-- TOC entry 1191 (class 1255 OID 24764)
-- Name: sp_ubt_get_businessdate_per_host(); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_get_businessdate_per_host() RETURNS void
    LANGUAGE plpgsql
    AS $$ 

Declare v_Date_Today date := (select max( ActualDate) + interval '1 day' from public.ztubt_adhoctimehistory );

begin

-- Creating table if does not exist
CREATE TABLE if not exists public.ztubt_getbusinessdate_perhost 
 (
	Host integer not NULL,
	PreviousPeriodDateTime timestamp,
	PeriodDateTime timestamp,
	ActualDate DATE not null,
	PreviousPeriodDateTimeUTC timestamp,
	PeriodDateTimeUTC timestamp
);

GRANT SELECT ON TABLE public.ztubt_getbusinessdate_perhost TO qlikuser;

GRANT ALL ON TABLE public.ztubt_getbusinessdate_perhost TO sp_postgres;

-- Loading old data whiche have been not loaded

INSERT INTO public.ztubt_getbusinessdate_perhost 
	SELECT AH1.Host, AH2.PeriodDateTime, AH1.PeriodDateTime, AH1.ActualDate
	, AH2.PeriodDateTime - interval '8 hour', AH1.PeriodDateTime- interval '8 hour'
	FROM 
	(
		SELECT PeriodDateTime, Host, ActualDate
		FROM public.ztubt_AdHocTimeHistory AH1
		where not exists( select 1 from public.ztubt_getbusinessdate_perhost tgt where AH1.host= tgt.host and ah1.actualdate = tgt.ActualDate )
	)AH1
	LEFT JOIN
	(
		SELECT PeriodDateTime, Host, ActualDate
		FROM public.ztubt_AdHocTimeHistory AH2
	)AH2 ON AH1.ActualDate = AH2.ActualDate +  interval '1 day' AND AH1.Host = AH2.Host 
--	where AH2.PeriodDateTime is not null
	;

-- Delete data from staging active SPA for the current data before loading
delete from public.ztubt_getbusinessdate_perhost where actualdate = v_Date_Today;
		
-- Load data to ztubt_getbusinessdate_perhost table
insert into  public.ztubt_getbusinessdate_perhost
	select a.Host, a.PeriodDateTime, b.PeriodDateTime,  v_Date_Today 
	, a.PeriodDateTime- interval '8 hour' , b.PeriodDateTime - interval '8 hour' from
	public.ztubt_AdHocTimeHistory a inner join
	(
	SELECT Host,
			cast( CASE
			--CHOOSE AdHocTime OVER DefaultTime IF AdHocTime is available
				WHEN AdHocTime IS NOT NULL THEN 
					CASE
						WHEN CAST(LEFT(AdHocTime,2) AS INT) >= 24 THEN 
							CONCAT(CAST( cast(v_Date_Today +  interval '1 day' as date) AS VARCHAR),' ', --DATE
							CAST(CAST(LEFT(AdHocTime,2) AS INT) - 24 AS VARCHAR),':', --HOUR
							SUBSTRING(AdHocTime, POSITION(':' in AdHocTime) + 1, 2),':', --MINUTE
							SUBSTRING(AdHocTime, length(DefaultTime) - position(':' in reverse(DefaultTime)) + 2, 2)) --SECOND
						ELSE CONCAT(CAST(CAST(v_Date_Today AS DATE) AS VARCHAR),' ', --DATE
							CAST(LEFT(AdHocTime,2) AS VARCHAR),':', --HOUR
							SUBSTRING(AdHocTime, POSITION(':' in AdHocTime) + 1, 2),':', --MINUTE
							SUBSTRING(AdHocTime, length(DefaultTime) - position(':' in reverse(DefaultTime)) + 2, 2)) --SECOND
					END
				WHEN AdHocTime IS NULL THEN 
					CASE
						WHEN CAST(LEFT(DefaultTime,2) AS INT) >= 24 THEN 
							CONCAT(CAST(cast (v_Date_Today +  interval '1 day' as date) AS VARCHAR),' ', --DATE
							CAST(CAST(LEFT(DefaultTime,2) AS INT) - 24 AS VARCHAR),':', --HOUR
							SUBSTRING(DefaultTime, POSITION(':' in DefaultTime) + 1, 2),':', --MINUTE
							SUBSTRING(DefaultTime, length(DefaultTime) - position(':' in reverse(DefaultTime)) + 2, 2)) --SECOND
						ELSE CONCAT(CAST(CAST(v_Date_Today AS DATE) AS VARCHAR),' ', --DATE
							CAST(LEFT(DefaultTime,2) AS VARCHAR),':', --HOUR
							SUBSTRING(DefaultTime, POSITION(':' in DefaultTime) + 1, 2),':',--MINUTE
							SUBSTRING(DefaultTime, length(DefaultTime) - position(':' in reverse(DefaultTime)) + 2, 2))--SECOND
					END
			end as timestamp) AS PeriodDateTime
			FROM public.ztUBT_AdHocTimeConfig AH
		)b
		on a.Host = b.Host
		and a.ActualDate = v_Date_Today + interval '-1 day';

		
end;

$$;


ALTER FUNCTION public.sp_ubt_get_businessdate_per_host() OWNER TO consultant01;

--
-- TOC entry 1126 (class 1255 OID 2153160)
-- Name: sp_ubt_get_businessdate_per_host_test(); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_get_businessdate_per_host_test() RETURNS void
    LANGUAGE plpgsql
    AS $$ 

Declare v_Date_Today date := (select max( ActualDate) + interval '1 day' from public.ztubt_adhoctimehistory );

begin

-- Creating table if does not exist
CREATE TABLE if not exists public.ztubt_getbusinessdate_perhost_test 
 (
	Host integer not NULL,
	PreviousPeriodDateTime timestamp,
	PeriodDateTime timestamp,
	ActualDate DATE not null,
	PreviousPeriodDateTimeUTC timestamp,
	PeriodDateTimeUTC timestamp
);

GRANT SELECT ON TABLE public.ztubt_getbusinessdate_perhost_test TO qlikuser;

GRANT ALL ON TABLE public.ztubt_getbusinessdate_perhost_test TO sp_postgres;

-- Loading old data whiche have been not loaded

INSERT INTO public.ztubt_getbusinessdate_perhost_test 
	SELECT AH1.Host, AH2.PeriodDateTime, AH1.PeriodDateTime, AH1.ActualDate
	, AH2.PeriodDateTime - interval '8 hour', AH1.PeriodDateTime- interval '8 hour'
	FROM 
	(
		SELECT PeriodDateTime, Host, ActualDate
		FROM public.ztubt_AdHocTimeHistory AH1
		where not exists( select 1 from public.ztubt_getbusinessdate_perhost_test tgt where AH1.host= tgt.host and ah1.actualdate = tgt.ActualDate )
	)AH1
	LEFT JOIN
	(
		SELECT PeriodDateTime, Host, ActualDate
		FROM public.ztubt_AdHocTimeHistory AH2
	)AH2 ON AH1.ActualDate = AH2.ActualDate +  interval '1 day' AND AH1.Host = AH2.Host 
--	where AH2.PeriodDateTime is not null
	;

-- Delete data from staging active SPA for the current data before loading
delete from public.ztubt_getbusinessdate_perhost_test where actualdate = v_Date_Today;
		
-- Load data to ztubt_getbusinessdate_perhost_test table
insert into  public.ztubt_getbusinessdate_perhost_test
	select a.Host, a.PeriodDateTime, b.PeriodDateTime,  v_Date_Today 
	, a.PeriodDateTime- interval '8 hour' , b.PeriodDateTime - interval '8 hour' from
	public.ztubt_AdHocTimeHistory a inner join
	(
	SELECT Host,
			cast( CASE
			--CHOOSE AdHocTime OVER DefaultTime IF AdHocTime is available
				WHEN AdHocTime IS NOT NULL THEN 
					CASE
						WHEN CAST(LEFT(AdHocTime,2) AS INT) >= 24 THEN 
							CONCAT(CAST( cast(v_Date_Today +  interval '1 day' as date) AS VARCHAR),' ', --DATE
							CAST(CAST(LEFT(AdHocTime,2) AS INT) - 24 AS VARCHAR),':', --HOUR
							SUBSTRING(AdHocTime, POSITION(':' in AdHocTime) + 1, 2),':', --MINUTE
							SUBSTRING(AdHocTime, length(DefaultTime) - position(':' in reverse(DefaultTime)) + 2, 2)) --SECOND
						ELSE CONCAT(CAST(CAST(v_Date_Today AS DATE) AS VARCHAR),' ', --DATE
							CAST(LEFT(AdHocTime,2) AS VARCHAR),':', --HOUR
							SUBSTRING(AdHocTime, POSITION(':' in AdHocTime) + 1, 2),':', --MINUTE
							SUBSTRING(AdHocTime, length(DefaultTime) - position(':' in reverse(DefaultTime)) + 2, 2)) --SECOND
					END
				WHEN AdHocTime IS NULL THEN 
					CASE
						WHEN CAST(LEFT(DefaultTime,2) AS INT) >= 24 THEN 
							CONCAT(CAST(cast (v_Date_Today +  interval '1 day' as date) AS VARCHAR),' ', --DATE
							CAST(CAST(LEFT(DefaultTime,2) AS INT) - 24 AS VARCHAR),':', --HOUR
							SUBSTRING(DefaultTime, POSITION(':' in DefaultTime) + 1, 2),':', --MINUTE
							SUBSTRING(DefaultTime, length(DefaultTime) - position(':' in reverse(DefaultTime)) + 2, 2)) --SECOND
						ELSE CONCAT(CAST(CAST(v_Date_Today AS DATE) AS VARCHAR),' ', --DATE
							CAST(LEFT(DefaultTime,2) AS VARCHAR),':', --HOUR
							SUBSTRING(DefaultTime, POSITION(':' in DefaultTime) + 1, 2),':',--MINUTE
							SUBSTRING(DefaultTime, length(DefaultTime) - position(':' in reverse(DefaultTime)) + 2, 2))--SECOND
					END
			end as timestamp) AS PeriodDateTime
			FROM public.ztUBT_AdHocTimeConfig AH
		)b
		on a.Host = b.Host
		and a.ActualDate = v_Date_Today + interval '-1 day';

		
end;

$$;


ALTER FUNCTION public.sp_ubt_get_businessdate_per_host_test() OWNER TO sp_postgres;

--
-- TOC entry 1119 (class 1255 OID 24765)
-- Name: sp_ubt_get_location_status_period(); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_get_location_status_period() RETURNS TABLE(rownum integer, locid integer, status integer, createddatetime timestamp without time zone, nextcreateddatetime timestamp without time zone)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	BEGIN

	create temp table ubt_temp_data_table
	(RowNum INT4,
	LocID INT4,
	Status INT4,
	CreatedDateTime timestamp,
	NextCreatedDateTime timestamp
	);

insert into ubt_temp_data_table
select lsc1.rownum, lsc1.locid, lsc1.status, lsc1.createddatetime, lsc2.createddatetime as nextcreateddatetime
	from
	(
		select row_number() over (partition by lsc.locid order by lsc.locstatusid) as rownum, lsc.locid, lsc.status, lsc.createddatetime
		from public.ztubt_locationstatuschange  lsc
	)lsc1
	left join
	(
		select row_number() over (partition by lsc.locid order by lsc.locstatusid) as rownum, lsc.locid, lsc.status, lsc.createddatetime
		from public.ztubt_locationstatuschange  lsc
	)lsc2  on lsc1.rownum = (lsc2.rownum-1) and lsc1.locid = lsc2.locid
;
		return query
		
		select 
		RowNum ,
		LocID ,
		Status ,
		CreatedDateTime ,
		NextCreatedDateTime
		from ubt_temp_data_table;
			
	drop table if exists ubt_temp_data_table;
	END;
$$;


ALTER FUNCTION public.sp_ubt_get_location_status_period() OWNER TO consultant01;

--
-- TOC entry 1193 (class 1255 OID 24766)
-- Name: sp_ubt_getamounttransaction(date, date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getamounttransaction(in_fromdatetime date, in_todatetime date) 
RETURNS TABLE(ticketserialnumber character varying, wager numeric, secondwager numeric, sales numeric, secondsales numeric, salescomm numeric, secondsalescomm numeric, gst numeric, secondgst numeric, returnamount numeric, winningamount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin

	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	

	create temporary table if not exists temp_ubt_ResultWager
					(TktSerialNumber varchar(200)
					,Wager numeric(22,2)
					,SecondWager numeric(22,2)
					);

	insert into temp_ubt_ResultWager
		-- HR
		select 
			pbth.ticketserialnumber 
		  , sum(case when pbtl.bettypeid = 'W-P' then coalesce(pbtl.betpriceamount,0)/2
				else coalesce(pbtl.betpriceamount,0) end) as Wager
		  , 0 as SecondWager
		from 
		ztubt_placedbettransactionheader pbth
		inner join ztubt_horse_placedbettransactionlineitem pbtl
		 on (pbth.tranheaderid=pbtl.tranheaderid)
		inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
			on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
		where 1=1
		and pbth.prodid = 1
		and pbth.createddate >= vUTCFromDateTimeBMCS  --bmcsutc
		and pbth.createddate < vUTCToDateTimeBMCS 
		group by pbth.ticketserialnumber
		
		union all
		
		-- 4D
		select 
			pbth.ticketserialnumber 
		  , sum(coalesce(pbtl.bigbetacceptedwager,0)) as Wager
		  , sum(coalesce(pbtl.smallbetacceptedwager,0)) as SecondWager
		from 
		ztubt_placedbettransactionheader pbth
		inner join ztubt_4d_placedbettransactionlineitemnumber pbtl
			on (pbth.tranheaderid=pbtl.tranheaderid)
		inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
			on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
		inner join ztubt_drawdates dd 
			on (pbth.tranheaderid=dd.tranheaderid)
		where 1=1
		and pbth.prodid = 2
		and pbth.isexchangeticket = false
		and pbth.createddate >= vUTCFromDateTimeIGT  --igtsutc
		and pbth.createddate < vUTCToDateTimeIGT 
		group by pbth.ticketserialnumber
		
		union all
		
		-- TOTO
		select 
			pbth.ticketserialnumber 
		  , sum(coalesce(pbtl.betpriceamount ,0)) as Wager
		  , 0 as SecondWager
		from 
		ztubt_placedbettransactionheader pbth
		inner join ztubt_toto_placedbettransactionlineitem pbtl
			on (pbth.tranheaderid=pbtl.tranheaderid)
		inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
			on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
		where 1=1
		and pbth.prodid = 3
		and pbth.isexchangeticket = false
		and pbth.createddate >= vUTCFromDateTimeIGT  --igtutc
		and pbth.createddate < vUTCToDateTimeIGT 
		and coalesce(pbtl.groupunitsequence,1) =1
		group by pbth.ticketserialnumber

		union all
		
		-- SWEEP PB06
		select 
			pbth.ticketserialnumber 
		  , sum(coalesce(pbtln.betpriceamount ,0)) as Wager
		  , 0 as SecondWager
		from 
		ztubt_placedbettransactionheader pbth
		inner join ztubt_sweep_placedbettransactionlineitem pbtl
			on (pbth.tranheaderid=pbtl.tranheaderid)
		inner join ztubt_sweep_placedbettransactionlineitemnumber pbtln
			on (pbtl.tranlineitemid =pbtln.tranlineitemid and pbtln.issoldout=false)
		inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
			on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
		where 1=1
		and pbth.prodid = 4
		and pbth.createddate >= vUTCFromDateTimeIGT  --igtutc
		and pbth.createddate < vUTCToDateTimeIGT 
		and not exists (select 1 from ztubt_placedbettransactionheaderlifecyclestate zplc
							inner join ztubt_terminal zt on (zt.terdisplayid=pbth.terdisplayid)
							inner join ztubt_location zl on (zt.locid=zl.locid)
						where 1=1
						and zplc.tranheaderid =pbth.tranheaderid 
						and zplc.betstatetypeid = 'PB06'
						and zl.sweepindicator is not null 
						and pbtl.isprinted is null
						and zplc.captureddate >= vUTCFromDateTimeIGT  --igtutc
						and zplc.captureddate < vUTCToDateTimeIGT)
--		and pbth.tranheaderid not in (select distinct pbth.tranheaderid from ztubt_placedbettransactionheaderlifecyclestate zplc
--					inner join ztubt_placedbettransactionheader pbth on (zplc.tranheaderid =pbth.tranheaderid)
--					inner join ztubt_terminal zt on (zt.terdisplayid=pbth.terdisplayid)
--					inner join ztubt_location zl on (zt.locid=zl.locid)
--					inner join ztubt_sweep_placedbettransactionlineitem pbtl on (pbth.tranheaderid=pbtl.tranheaderid)
--				where 1=1
--				and zplc.betstatetypeid = 'PB06'
--				and zl.sweepindicator is not null 
--				and isprinted is null
--				and zplc.captureddate >= vUTCFromDateTimeIGT  --igtutc
--				and zplc.captureddate < vUTCToDateTimeIGT)
		group by pbth.ticketserialnumber
		
		union all
		
		-- SWEEP PB03
		select 
			pbth.ticketserialnumber 
		  , sum(coalesce(pbtln.betpriceamount ,0)) as Wager
		  , 0 as SecondWager
		from 
		ztubt_placedbettransactionheader pbth
		inner join ztubt_sweep_placedbettransactionlineitem pbtl
			on (pbth.tranheaderid=pbtl.tranheaderid)
		inner join ztubt_sweep_placedbettransactionlineitemnumber pbtln
			on (pbtl.tranlineitemid =pbtln.tranlineitemid and pbtln.issoldout=false)
		inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
			on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB03')
		inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		inner join ztubt_location zl on (zt.locid=zl.locid)
		where 1=1
		and pbth.prodid = 4
		and pbth.createddate >= vUTCFromDateTimeIGT  --igtutc
		and pbth.createddate < vUTCToDateTimeIGT 
		and zl.sweepindicator is not null 
		and pbtl.isprinted is null
		group by pbth.ticketserialnumber
		
		union all
		
		-- SPORTS
		select 
			ticketserialnumber 
		  , sum(coalesce(betamount ,0)) as Wager
		  , 0 as SecondWager
		from (select distinct pbth.ticketserialnumber,pbtl.betamount from
		ztubt_placedbettransactionheader pbth
		inner join ztubt_sports_placedbettransactionlineitem pbtl
			on (pbth.tranheaderid=pbtl.tranheaderid)
		inner join ztubt_sports_placedbettransactionlineitemnumber pbtln
			on (pbtl.tranlineitemid =pbtln.tranlineitemid)
		inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
			on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
		where 1=1
		and pbth.prodid in (5,6)
		and pbth.isbetrejectedbytrader = false
		and pbth.createddate >= vUTCFromDateTimeOB  --obutc
		and pbth.createddate < vUTCToDateTimeOB )sq
		group by ticketserialnumber
		;
	
	create temporary table if not exists temp_ubt_ResultSales
					(TktSerialNumber varchar(200)
					,SalesCommAmount numeric(22,12)
					,SalesFactorAmount numeric(22,12)
					,SecondSalesCommAmount numeric(22,12)
					,SecondSalesFactorAmount numeric(22,12));	

	insert into temp_ubt_ResultSales
		-- HR
		select ticketserialnumber
		, sum(SalesCommAmount) SalesCommAmount
		, sum(SalesFactorAmount) SalesFactorAmount
		, 0 SecondSalesCommAmount
		, 0 SecondSalesFactorAmount
		from (
			select 
				pbth.ticketserialnumber 
			  , cast(pbth.createddate + interval '8 Hours' as date) as CreatedDate
			  , pbtl.tranheaderid 
			  , sum(case when pbtl.bettypeid = 'W-P' then coalesce(pbtl.salescommamount,0)/2
					else coalesce(pbtl.salescommamount,0) end) as SalesCommAmount
			  , sum(case when pbtl.bettypeid = 'W-P' then coalesce(pbtl.salesfactoramount,0)/2
					else coalesce(pbtl.salesfactoramount,0) end) as SalesFactorAmount
			from 
			ztubt_placedbettransactionheader pbth
			inner join ztubt_horse_placedbettransactionlineitem pbtl
			 on (pbth.tranheaderid=pbtl.tranheaderid)
			inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
				on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
			where 1=1
			and pbth.prodid = 1
			and pbth.createddate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbth.createddate < vUTCToDateTimeBMCS 
			group by pbth.ticketserialnumber, pbtl.tranheaderid
			, cast(pbth.createddate + interval '8 Hours' as date) 
		)sq
		group by ticketserialnumber
		
		union all
		
		-- 4D
		select ticketserialnumber
		, coalesce(sum(SalesCommAmount),0) SalesCommAmount
		, coalesce(sum(SalesFactorAmount),0) SalesFactorAmount
		, coalesce(sum(SecondSalesCommAmount),0) SecondSalesCommAmount
		, coalesce(sum(SecondSalesFactorAmount),0) SecondSalesFactorAmount
--		, round(sum(SalesCommAmount),2) SalesCommAmount
--		, round(sum(SalesFactorAmount),2) SalesFactorAmount
--		, round(sum(SecondSalesCommAmount),2) SecondSalesCommAmount
--		, round(sum(SecondSalesFactorAmount),2) SecondSalesFactorAmount
		from (
			select 
				pbth.ticketserialnumber 
			  , cast(pbth.createddate + interval '8 Hours' as date) as CreatedDate
			  , sum(coalesce(pbtl.salescommamountbig ,0)) as SalesCommAmount
			  , sum(coalesce(pbtl.salesfactoramountbig ,0)) as SalesFactorAmount
			  , sum(coalesce(pbtl.salescommamountsmall,0)) as SecondSalesCommAmount
			  , sum(coalesce(pbtl.salesfactoramountsmall ,0)) as SecondSalesFactorAmount
			from 
			ztubt_placedbettransactionheader pbth
			inner join ztubt_4d_placedbettransactionlineitemnumber pbtl
				on (pbth.tranheaderid=pbtl.tranheaderid)
			inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
				on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
			inner join ztubt_drawdates dd 
				on (pbth.tranheaderid=dd.tranheaderid)
			where 1=1
			and pbth.prodid = 2
			and pbth.isexchangeticket = false
			and pbth.createddate >= vUTCFromDateTimeIGT  --igtsutc
			and pbth.createddate < vUTCToDateTimeIGT 
			group by pbth.ticketserialnumber, cast(pbth.createddate + interval '8 Hours' as date)
		)sq
		group by ticketserialnumber
			
		union all
		
		-- TOTO
		select ticketserialnumber
		, coalesce(sum(SalesCommAmount),0) SalesCommAmount
		, coalesce(sum(SalesFactorAmount),0) SalesFactorAmount
		, 0 SecondSalesCommAmount
		, 0 SecondSalesFactorAmount
		from (
			select 
				pbth.ticketserialnumber 
			  , cast(pbth.createddate + interval '8 Hours' as date) as CreatedDate
			  , sum(coalesce(pbtl.salescommamount ,0)) as SalesCommAmount
			  , sum(coalesce(pbtl.salesfactoramount ,0)) as SalesFactorAmount
			from 
			ztubt_placedbettransactionheader pbth
			inner join ztubt_toto_placedbettransactionlineitem pbtl
				on (pbth.tranheaderid=pbtl.tranheaderid)
			inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
				on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
			where 1=1
			and pbth.prodid = 3
			and pbth.isexchangeticket = false
			and pbth.createddate >= vUTCFromDateTimeIGT  --igtutc
			and pbth.createddate < vUTCToDateTimeIGT 
			and coalesce(pbtl.groupunitsequence,1) =1
			group by pbth.ticketserialnumber, cast(pbth.createddate + interval '8 Hours' as date)
		)sq
		group by ticketserialnumber 
		
		union all
		
		-- SWEEP 
		select ticketserialnumber
		, coalesce(sum(SalesCommAmount),0) SalesCommAmount
		, coalesce(sum(SalesFactorAmount),0) SalesFactorAmount
		, 0 SecondSalesCommAmount
		, 0 SecondSalesFactorAmount
		from (
			select 
				pbth.ticketserialnumber 
			  , cast(pbth.createddate + interval '8 Hours' as date) as CreatedDate
			  , sum(coalesce(pbtln.salescommamount ,0)) as SalesCommAmount
			  , sum(coalesce(pbtln.salesfactoramount ,0)) as SalesFactorAmount
			from 
			ztubt_placedbettransactionheader pbth
			inner join ztubt_sweep_placedbettransactionlineitem pbtl
				on (pbth.tranheaderid=pbtl.tranheaderid)
			inner join ztubt_sweep_placedbettransactionlineitemnumber pbtln
				on (pbtl.tranlineitemid =pbtln.tranlineitemid and pbtln.issoldout=false)
			inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
				on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
			where 1=1
			and pbth.prodid = 4
			and pbth.createddate >= vUTCFromDateTimeIGT  --igtutc
			and pbth.createddate < vUTCToDateTimeIGT 
			group by pbth.ticketserialnumber, cast(pbth.createddate + interval '8 Hours' as date)
		)sq
		group by ticketserialnumber	
		
		union all
		
		-- SPORTS
		select ticketserialnumber
		, sum(coalesce(SalesCommAmount,0)) SalesCommAmount
		, sum(coalesce(SalesFactorAmount,0)) SalesFactorAmount
		, 0 SecondSalesCommAmount
		, 0 SecondSalesFactorAmount
		from (
			select distinct
				pbth.ticketserialnumber, pbth.prodid,pbth.tranheaderid
			  , pblc.placedbetlifecycleid , pbtl.sourcesystemtransactionid 
			  , pblc.betstatetypeid , pbtl.issinglebet 
			  , cast(pbth.createddate + interval '8 Hours' as date) as CreatedDate
			  , (coalesce(pbtl.salescommamount ,0)) as SalesCommAmount
			  , (coalesce(pbtl.salesfactoramount ,0)) as SalesFactorAmount
			from 
			ztubt_placedbettransactionheader pbth
			inner join ztubt_sports_placedbettransactionlineitem pbtl
				on (pbth.tranheaderid=pbtl.tranheaderid)
			inner join ztubt_sports_placedbettransactionlineitemnumber pbtln
				on (pbtl.tranlineitemid =pbtln.tranlineitemid)
			inner join ztubt_placedbettransactionheaderlifecyclestate pblc 
				on (pbth.tranheaderid=pblc.tranheaderid and pblc.betstatetypeid='PB06')
			where 1=1
			and pbth.prodid in (5,6)
			and pbth.isbetrejectedbytrader = false
			and pbth.createddate >= vUTCFromDateTimeOB  --obutc
			and pbth.createddate < vUTCToDateTimeOB 
		--	group by pbth.ticketserialnumber, cast(pbth.createddate + interval '8 Hours' as date)
		--	, pbth.prodid,pbth.tranheaderid
		)sq
		group by ticketserialnumber
		;
	
	return query
		select 
			w.TktSerialNumber 
		  , sum(w.wager)
		  , sum(w.secondWager)
		  , sum(s.SalesFactorAmount)
		  , sum(s.secondSalesFactorAmount)
		  , sum(s.SalesCommAmount)
		  , sum(s.secondSalesCommAmount)
		  , sum(w.wager)-sum(s.SalesFactorAmount)
		  , sum(w.secondWager)-sum(s.secondSalesFactorAmount)
		  , sum(coalesce(zv.winningamount,0))+sum(w.wager)+sum(w.secondWager)
		  , sum(coalesce(zv.winningamount,0))
		from 
		temp_ubt_ResultWager w
		left outer join temp_ubt_ResultSales s on (w.TktSerialNumber=s.TktSerialNumber)
		left outer join ztubt_validatedbetticket zv on (w.TktSerialNumber=zv.ticketserialnumber and zv.winningamount is not null)
		left outer join ztubt_validatedbetticketlifecyclestate zvlc on (zv.tranheaderid=zvlc.tranheaderid
																and zvlc.betstatetypeid='VB06')
		where 1=1
		group by w.TktSerialNumber
		;
	
drop table temp_ubt_ResultWager;
drop table temp_ubt_ResultSales;

end;
$$;


ALTER FUNCTION public.sp_ubt_getamounttransaction(in_fromdatetime date, in_todatetime date) OWNER TO consultant01;

--
-- TOC entry 1140 (class 1255 OID 2191608)
-- Name: sp_ubt_getcfsumreport(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getcfsumreport(v_drawcloseddate date, v_prodid integer) RETURNS TABLE(hostdrawdatesid integer, actualdate date, subprod text, wager numeric, secondwager numeric, salesfactoramount numeric, secondsalesfactoramount numeric, salescommamount numeric, iscencelled integer)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

DECLARE 
	v_TotalDraw INTEGER := (SELECT Fld2Value
		FROM public.ztUBT_LookupValueConfig LV
		WHERE ConfigName = 'RTMS_DrawCount' AND Fld3Value = cast (v_ProdID as varchar));
	v_DrawStartDate DATE;
	v_DrawEndDate DATE;
	v_HostDrawDatesId INTEGER;
	v_MinSalesDatetime TIMESTAMP;
	v_MaxSalesDatetime TIMESTAMP;
	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));
begin

	
-- Creating ubt_temp_DrawDates table

-- 26-04-2022: Hira - start: modified query for perf tuning
-- create temp table ubt_temp_dd_tran as
-- select distinct tranheaderid from ztubt_DrawDates dd
-- where cast(dd.DrawDate as date)  >= v_DrawClosedDate;

-- Hitachi: Fix case postpone lacking data of previous date with same draw
create temp table ubt_temp_dd_tran as
select distinct tranheaderid from ztubt_DrawDates dd
where dd.HostDrawDatesId in (
	select distinct HostDrawDatesId from ztubt_drawdates where DrawDate  >= v_DrawClosedDate
);

CREATE TEMP  TABLE ubt_temp_DrawDates as
SELECT distinct dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM ubt_temp_dd_tran dd
inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid; 

	
--CREATE TEMP  TABLE ubt_temp_DrawDates as
--SELECT DISTINCT dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM public.ztubt_DrawDates dd
--inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid 
--WHERE cast(dd.DrawDate as date)  >= v_DrawClosedDate;

-- 26-04-2022: Hira - End: modified query for perf tuning

-- setting variable for host_ID , draw_start_date and draw_end_date
 SELECT HostDrawDatesId, cast( DrawStartDate as date), cast(DrawEndDate as date) 
 into
 v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate  
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) = v_DrawClosedDate AND ProdID = v_ProdID;

  IF v_HostDrawDatesId IS NULL
	THEN
        SELECT HostDrawDatesId
			INTO v_HostDrawDatesId
			FROM public.ztubt_PlacedBetTransactionHeader PBTH 
			INNER JOIN ubt_temp_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID
			WHERE DD.DrawDate = v_DrawClosedDate and PBTH.ProdID = v_ProdID 
            AND DD.HostDrawDatesId NOT IN (
                SELECT DISTINCT HostDrawDatesId
                FROM ubt_temp_DrawDates
                WHERE DrawDate > v_DrawClosedDate
            );
  		IF v_HostDrawDatesId IS NOT NULL
		THEN
			SELECT MIN(BD.ActualDate),  MAX(BD.ActualDate)  
				INTO v_DrawStartDate, v_DrawEndDate
				FROM public.ztubt_PlacedBetTransactionHeader PBTH 
				INNER JOIN ubt_temp_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID
				LEFT JOIN public.ztubt_getbusinessdate_perhost BD 
				ON PBTH.CreatedDate >= (BD.PreviousPeriodDateTime + interval '-8 hour') AND PBTH.CreatedDate < (BD.PeriodDateTime + interval '-8 hour')
				and BD.HOST = 1
				WHERE HostDrawDatesId = v_HostDrawDatesId AND PBTH.ProdID = v_ProdID 
				GROUP BY HostDrawDatesId;
		END	IF;
	END	IF;
	

-- Getting business date for lottery	
CREATE TEMP  TABLE ubt_temp_BusinessDate as
SELECT PreviousPeriodDateTime, PeriodDateTime, ActualDate 
FROM public.ztubt_getbusinessdate_perhost BD
WHERE HOST = 1
and (ActualDate ::date) BETWEEN v_DrawStartDate AND v_DrawEndDate;


-- setting minimum sales date and maximu sales date	
SELECT MIN(PreviousPeriodDateTime), MAX(PeriodDateTime)
	INTO v_MinSalesDatetime, v_MaxSalesDatetime
	FROM ubt_temp_BusinessDate;	


-- List of HostDrawDateIDs	

CREATE TEMP  TABLE ubt_temp_ListOfHostDrawDatesID as	
SELECT  HostDrawDatesId
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) >= v_DrawClosedDate AND ProdID = v_ProdID 
	ORDER BY HostDrawDatesId	limit v_TotalDraw;


IF ((SELECT COUNT(*) FROM ubt_temp_ListOfHostDrawDatesID) != v_TotalDraw)
THEN
		DELETE FROM ubt_temp_ListOfHostDrawDatesID;

		INSERT INTO ubt_temp_ListOfHostDrawDatesID
		SELECT  HostDrawDatesId
		FROM
		(
			SELECT DISTINCT HostDrawDatesId, DD.DrawDate
			FROM ubt_temp_DrawDates DD 
			INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON DD.TranHeaderID = PBTH.TranHeaderID
			where ( DD.DrawDate :: date) >= v_DrawClosedDate AND HostDrawDatesId >= v_HostDrawDatesId 
			AND PBTH.ProdID = v_ProdID
		)FIN
		ORDER BY FIN.DrawDate limit v_TotalDraw;
	END	if;



	CREATE TEMP  TABLE ubt_temp_GetCFSUMReport
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId Int4,
		ActualDate DATE,
		SubProd text,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesCommAmount numeric(32, 12),
		SalesFactorAmount numeric(32, 12),
		SecondSalesCommAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12)
		
	);

	
--- Dummy Entries	
	IF v_HostDrawDatesId IS NOT NULL
	THEN
		--Make template of the report based on the configuration draw count
		IF v_ProdID = 3 -- toto
		THEN
			INSERT INTO ubt_temp_GetCFSUMReport
			SELECT HDD.HostDrawDatesID, DateData, totosubprod.SubProd, 0, 0, 0, 0, 0
			FROM (
			SELECT (date_trunc('day', dd):: date)  DateData
			FROM generate_series
			( v_DrawStartDate
			, v_DrawEndDate
			, '1 day'::interval) dd
			) as DateRange
			
			CROSS JOIN
			ubt_temp_ListOfHostDrawDatesID HDD
			
			CROSS JOIN (VALUES ('t649'), ('totomatch')) AS totosubprod(SubProd);
		ELSEIF v_ProdID <> 3 -- other products
		THEN
			INSERT INTO ubt_temp_GetCFSUMReport
			SELECT HDD.HostDrawDatesID, DateData, '', 0, 0, 0, 0, 0
			FROM (
			SELECT (date_trunc('day', dd):: date)  DateData
			FROM generate_series
			( v_DrawStartDate
			, v_DrawEndDate
			, '1 day'::interval) dd
			) as DateRange
			
			CROSS JOIN
			ubt_temp_ListOfHostDrawDatesID HDD;
		end if; 
		
		if v_ProdID = 2 --4D
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, '', SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTLN.BigBetAcceptedWager,0)) AS Wager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SmallBetAcceptedWager,0)) AS SecondWager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesCommAmountBig,0)) AS SalesCommAmount, --calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesFactorAmountBig,0)) AS SalesFactorAmount, 
					SUM(coalesce(PBTLN.SalesCommAmountSmall,0)) AS SecondSalesCommAmount, 
					SUM(coalesce(PBTLN.SalesFactorAmountSmall,0))AS SecondSalesFactorAmount
					FROM public.ztUBT_4D_PlacedBetTransactionLineItemNumber PBTLN
					INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
					INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 2
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;

		ELSIF v_ProdID = 3 --TOTO
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SubProd, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					CASE WHEN PBTL.bettypeid = ANY(v_totomatchBettypes) THEN 'totomatch' ELSE 't649' END as SubProd,
					SUM(coalesce(PBTL.BetPriceAmount,0)) / DDT.Ct AS Wager, --(2) calculate only placed ticket (not cancelled after)
					0 AS SecondWager,
					SUM(coalesce(PBTL.SalesCommAmount,0)) / DDT.Ct AS SalesCommAmount, --(1)--calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTL.SalesFactorAmount,0)) / DDT.Ct AS SalesFactorAmount, --(1)
					0 AS SecondSalesCommAmount, 
					0 AS SecondSalesFactorAmount
					FROM public.ztubt_toto_PlacedBetTransactionLineItem PBTL
					INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON PBTL.TranHeaderID = PBTH.TranHeaderID 
					INNER JOIN public.ztubt_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTL.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN (
					SELECT TranHeaderID, COUNT(TranHeaderID) AS Ct FROM ubt_temp_DrawDates DD --(1)
						GROUP BY TranHeaderID
					) DDT ON DDT.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTL.CreatedDate >= BD.PreviousPeriodDateTime  + interval '-8 hour' AND PBTL.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE (PBTL.GroupUnitSequence is null or PBTL.GroupUnitSequence = 1) 
					AND PBTL.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTL.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 3
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate, DDT.Ct,
						CASE WHEN PBTL.bettypeid = ANY(v_totomatchBettypes) THEN 'totomatch' ELSE 't649' END
				)FIN
				GROUP BY HostDrawDatesId, ActualDate, SubProd;

		ELSIf v_ProdID = 4 --SWEEP
		THEN
				--Insert wager only
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 0, 0, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER join ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE 
				PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				and PBTH.IsCancelled = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

				--For Sweep PB03 IsPrint NULL (only for Sweep Consignee and Sweep Retailer locations)
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount,  
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount,
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB03'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >=BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				AND PBTLN.CreatedDate >=(v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				--AND PBTH.IsCancelled  = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false
				GROUP BY DD.HostDrawDatesId, BD.ActualDate
			-- [2022-03-31] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation				
				--For Sweep Cancellation (only for Sweep Consignee and Sweep Retailer locations)	
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				(0-SUM(coalesce(PBTLN.BetPriceAmount,0))) AS Wager,
				0 AS SecondWager, 
				(0-SUM(coalesce(PBTLN.SalesCommAmount,0))) AS SalesCommAmount,  
				(0-SUM(coalesce(PBTLN.SalesFactorAmount,0))) AS SalesFactorAmount, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem  PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztubt_cancelledbetticket CBT  ON PBTLN.TranHeaderID = CBT.TranHeaderID 
				INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				--LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND CBT.CancelledDate < BD.PeriodDateTime + interval '-8 hour'
				LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime  AND CBT.CancelledDate < BD.PeriodDateTime 
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				--AND CBT.CancelledDate >= (v_MinSalesDatetime + interval '-8 hour') AND CBT.CancelledDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND CBT.CancelledDate >= v_MinSalesDatetime  AND CBT.CancelledDate < v_MaxSalesDatetime 
				AND CBT.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

			-- [2022-03-31] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation			
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '', 0, 0, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount, --(2) 
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount, --(2) 
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID 
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				AND cast(PBTH.IsCancelled as integer) = 0
				AND PBTH.ProdID = 4
				AND cast(PBTLN.IsSoldOut as integer) = 0 --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate;
		end if; 
	end if;
	
return query
	SELECT 
	HostDrawDatesId, ActualDate, SubProd,
	SUM(COALESCE(Wager,0))/100 AS Wager, --Convert big bet price amount from cents to dollar
	SUM(COALESCE(SecondWager,0))/100 AS SecondWager, --Convert small bet price amount from cents to dollar
	SUM(COALESCE(SalesFactorAmount,0))/100 AS SalesFactorAmount, --Convert from cents to dollar
	SUM(COALESCE(SecondSalesFactorAmount,0))/100 AS SecondSalesFactorAmount, --Convert from cents to dollar
	SUM(COALESCE(SalesCommAmount,0) + COALESCE(SecondSalesCommAmount,0))/100 AS SalesCommAmount, --Convert from cents to dollar
	case when b.drawStatus_canceld = 'T' then 1
	else 0
	end AS iscancelled
	FROM ubt_temp_GetCFSUMReport a
	LEFT JOIN (
	SELECT DISTINCT zp.drawnumber, zp.drawStatus_canceld
	FROM ztes_pdf_drawparam zp left join ztubt_sap_product zap on (zp.productnum = zap.sapprodid)
	WHERE zap.prodid = v_prodid and zp.drawcdc + DATE '19860511' <= DATE(v_drawcloseddate)
	) b 
	ON (a.HostDrawDatesId = b.drawnumber) 
	where actualdate is not null
	and HostDrawDatesId  in (select hostdrawdatesid from ubt_temp_ListOfHostDrawDatesID)
	GROUP BY HostDrawDatesId, ActualDate, b.drawStatus_canceld, SubProd;
		
DROP TABLE IF EXISTS ubt_temp_DrawDates;	
DROP TABLE IF EXISTS ubt_temp_ListOfHostDrawDatesID;
DROP TABLE IF EXISTS ubt_temp_BusinessDate;
DROP TABLE IF EXISTS ubt_temp_GetCFSUMReport;
drop table if exists ubt_temp_dd_tran;

END;

$$;


ALTER FUNCTION public.sp_ubt_getcfsumreport(v_drawcloseddate date, v_prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1276 (class 1255 OID 1442910)
-- Name: sp_ubt_getcfsumreport_bk20240604(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getcfsumreport_bk20240604(v_drawcloseddate date, v_prodid integer) RETURNS TABLE(hostdrawdatesid integer, actualdate date, wager numeric, secondwager numeric, salesfactoramount numeric, secondsalesfactoramount numeric, salescommamount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

DECLARE 
	v_TotalDraw INTEGER := (SELECT Fld2Value
		FROM public.ztUBT_LookupValueConfig LV
		WHERE ConfigName = 'RTMS_DrawCount' AND Fld3Value = cast (v_ProdID as varchar));
	v_DrawStartDate DATE;
	v_DrawEndDate DATE;
	v_HostDrawDatesId INTEGER;
	v_MinSalesDatetime TIMESTAMP;
	v_MaxSalesDatetime TIMESTAMP;

begin

	
-- Creating ubt_temp_DrawDates table

-- 26-04-2022: Hira - start: modified query for perf tuning
create temp table ubt_temp_dd_tran as
select distinct tranheaderid from ztubt_DrawDates dd
where cast(dd.DrawDate as date)  >= v_DrawClosedDate;

CREATE TEMP  TABLE ubt_temp_DrawDates as
SELECT distinct dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM ubt_temp_dd_tran dd
inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid; 

	
--CREATE TEMP  TABLE ubt_temp_DrawDates as
--SELECT DISTINCT dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM public.ztubt_DrawDates dd
--inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid 
--WHERE cast(dd.DrawDate as date)  >= v_DrawClosedDate;

-- 26-04-2022: Hira - End: modified query for perf tuning

-- setting variable for host_ID , draw_start_date and draw_end_date
 SELECT HostDrawDatesId, cast( DrawStartDate as date), cast(DrawEndDate as date) 
 into
 v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate  
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) = v_DrawClosedDate AND ProdID = v_ProdID;


  IF v_HostDrawDatesId IS NULL
	THEN
		SELECT  HostDrawDatesId,  MIN(BD.ActualDate),  MAX(BD.ActualDate)  
			INTO v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate
			FROM public.ztubt_PlacedBetTransactionHeader PBTH 
			INNER JOIN ubt_temp_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID --(1)
			LEFT JOIN public.ztubt_getbusinessdate_perhost BD 
			ON PBTH.CreatedDate >= (BD.PreviousPeriodDateTime + interval '-8 hour') AND PBTH.CreatedDate < (BD.PeriodDateTime + interval '-8 hour')
			and BD.HOST = 1
			WHERE (DD.DrawDate :: date) = v_DrawClosedDate AND PBTH.ProdID = v_ProdID 
			GROUP BY HostDrawDatesId;
	END	IF;
	

-- Getting business date for lottery	
CREATE TEMP  TABLE ubt_temp_BusinessDate as
SELECT PreviousPeriodDateTime, PeriodDateTime, ActualDate 
FROM public.ztubt_getbusinessdate_perhost BD
WHERE HOST = 1
and (ActualDate ::date) BETWEEN v_DrawStartDate AND v_DrawEndDate;


-- setting minimum sales date and maximu sales date	
SELECT MIN(PreviousPeriodDateTime), MAX(PeriodDateTime)
	INTO v_MinSalesDatetime, v_MaxSalesDatetime
	FROM ubt_temp_BusinessDate;	


-- List of HostDrawDateIDs	

CREATE TEMP  TABLE ubt_temp_ListOfHostDrawDatesID as	
SELECT  HostDrawDatesId
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) >= v_DrawClosedDate AND ProdID = v_ProdID 
	ORDER BY HostDrawDatesId	limit v_TotalDraw;


IF ((SELECT COUNT(*) FROM ubt_temp_ListOfHostDrawDatesID) != v_TotalDraw)
THEN
		DELETE FROM ubt_temp_ListOfHostDrawDatesID;

		INSERT INTO ubt_temp_ListOfHostDrawDatesID
		SELECT  HostDrawDatesId
		FROM
		(
			SELECT DISTINCT HostDrawDatesId, DD.DrawDate
			FROM ubt_temp_DrawDates DD 
			INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON DD.TranHeaderID = PBTH.TranHeaderID
			where ( DD.DrawDate :: date) >= v_DrawClosedDate AND HostDrawDatesId >= v_HostDrawDatesId 
			AND PBTH.ProdID = v_ProdID
		)FIN
		ORDER BY FIN.DrawDate limit v_TotalDraw;
	END	if;



	CREATE TEMP  TABLE ubt_temp_GetCFSUMReport
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId Int4,
		ActualDate DATE,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesCommAmount numeric(32, 12),
		SalesFactorAmount numeric(32, 12),
		SecondSalesCommAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12)
		
	);

	
--- Dummy Entries	
	IF v_HostDrawDatesId IS NOT NULL
	THEN
		--Make template of the report based on the configuration draw count
		
		INSERT INTO ubt_temp_GetCFSUMReport
		SELECT HDD.HostDrawDatesID, DateData, 0, 0, 0, 0, 0
		FROM (
		SELECT (date_trunc('day', dd):: date)  DateData
		FROM generate_series
        ( v_DrawStartDate
        , v_DrawEndDate
        , '1 day'::interval) dd
		) as DateRange
		
		CROSS JOIN
		ubt_temp_ListOfHostDrawDatesID HDD;
	
		
		if v_ProdID = 2 --4D
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTLN.BigBetAcceptedWager,0)) AS Wager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SmallBetAcceptedWager,0)) AS SecondWager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesCommAmountBig,0)) AS SalesCommAmount, --calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesFactorAmountBig,0)) AS SalesFactorAmount, 
					SUM(coalesce(PBTLN.SalesCommAmountSmall,0)) AS SecondSalesCommAmount, 
					SUM(coalesce(PBTLN.SalesFactorAmountSmall,0))AS SecondSalesFactorAmount
					FROM public.ztUBT_4D_PlacedBetTransactionLineItemNumber PBTLN
					INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
					INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 2
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;

		ELSIF v_ProdID = 3 --TOTO
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTL.BetPriceAmount,0)) / DDT.Ct AS Wager, --(2) calculate only placed ticket (not cancelled after)
					0 AS SecondWager,
					SUM(coalesce(PBTL.SalesCommAmount,0)) / DDT.Ct AS SalesCommAmount, --(1)--calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTL.SalesFactorAmount,0)) / DDT.Ct AS SalesFactorAmount, --(1)
					0 AS SecondSalesCommAmount, 
					0 AS SecondSalesFactorAmount
					FROM public.ztubt_toto_PlacedBetTransactionLineItem PBTL
					INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON PBTL.TranHeaderID = PBTH.TranHeaderID 
					INNER JOIN public.ztubt_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTL.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN (
					SELECT TranHeaderID, COUNT(TranHeaderID) AS Ct FROM ubt_temp_DrawDates DD --(1)
						GROUP BY TranHeaderID
					) DDT ON DDT.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTL.CreatedDate >= BD.PreviousPeriodDateTime  + interval '-8 hour' AND PBTL.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE (PBTL.GroupUnitSequence is null or PBTL.GroupUnitSequence = 1) 
					AND PBTL.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTL.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 3
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate, DDT.Ct
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;
			
		ELSIf v_ProdID = 4 --SWEEP
		THEN
				--Insert wager only
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 0, 0, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER join ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE 
				PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				and PBTH.IsCancelled = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

				--For Sweep PB03 IsPrint NULL (only for Sweep Consignee and Sweep Retailer locations)
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount,  
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount,
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB03'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >=BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				AND PBTLN.CreatedDate >=(v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				--AND PBTH.IsCancelled  = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false
				GROUP BY DD.HostDrawDatesId, BD.ActualDate
			-- [2022-03-31] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation				
				--For Sweep Cancellation (only for Sweep Consignee and Sweep Retailer locations)	
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				(0-SUM(coalesce(PBTLN.BetPriceAmount,0))) AS Wager,
				0 AS SecondWager, 
				(0-SUM(coalesce(PBTLN.SalesCommAmount,0))) AS SalesCommAmount,  
				(0-SUM(coalesce(PBTLN.SalesFactorAmount,0))) AS SalesFactorAmount, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem  PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztubt_cancelledbetticket CBT  ON PBTLN.TranHeaderID = CBT.TranHeaderID 
				INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				--LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND CBT.CancelledDate < BD.PeriodDateTime + interval '-8 hour'
				LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime  AND CBT.CancelledDate < BD.PeriodDateTime 
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				--AND CBT.CancelledDate >= (v_MinSalesDatetime + interval '-8 hour') AND CBT.CancelledDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND CBT.CancelledDate >= v_MinSalesDatetime  AND CBT.CancelledDate < v_MaxSalesDatetime 
				AND CBT.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

			-- [2022-03-31] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation			
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 0, 0, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount, --(2) 
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount, --(2) 
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID 
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				AND cast(PBTH.IsCancelled as integer) = 0
				AND PBTH.ProdID = 4
				AND cast(PBTLN.IsSoldOut as integer) = 0 --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate;
		end if; 
	end if;
	
return query
			SELECT 
			HostDrawDatesId, ActualDate,
			SUM(COALESCE(Wager,0))/100 AS Wager, --Convert big bet price amount from cents to dollar
			SUM(COALESCE(SecondWager,0))/100 AS SecondWager, --Convert small bet price amount from cents to dollar
			SUM(COALESCE(SalesFactorAmount,0))/100 AS SalesFactorAmount, --Convert from cents to dollar
			SUM(COALESCE(SecondSalesFactorAmount,0))/100 AS SecondSalesFactorAmount, --Convert from cents to dollar
			SUM(COALESCE(SalesCommAmount,0) + COALESCE(SecondSalesCommAmount,0))/100 AS SalesCommAmount --Convert from cents to dollar
			FROM ubt_temp_GetCFSUMReport
			where actualdate is not null
			and HostDrawDatesId  in (select hostdrawdatesid from ubt_temp_ListOfHostDrawDatesID)
			GROUP BY HostDrawDatesId, ActualDate;
		
DROP TABLE IF EXISTS ubt_temp_DrawDates;	
DROP TABLE IF EXISTS ubt_temp_ListOfHostDrawDatesID;
DROP TABLE IF EXISTS ubt_temp_BusinessDate;
DROP TABLE IF EXISTS ubt_temp_GetCFSUMReport;
drop table if exists ubt_temp_dd_tran;

END;

$$;


ALTER FUNCTION public.sp_ubt_getcfsumreport_bk20240604(v_drawcloseddate date, v_prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1097 (class 1255 OID 2073654)
-- Name: sp_ubt_getcfsumreport_bk20241010(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getcfsumreport_bk20241010(v_drawcloseddate date, v_prodid integer) RETURNS TABLE(hostdrawdatesid integer, actualdate date, wager numeric, secondwager numeric, salesfactoramount numeric, secondsalesfactoramount numeric, salescommamount numeric, iscencelled integer)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

DECLARE 
	v_TotalDraw INTEGER := (SELECT Fld2Value
		FROM public.ztUBT_LookupValueConfig LV
		WHERE ConfigName = 'RTMS_DrawCount' AND Fld3Value = cast (v_ProdID as varchar));
	v_DrawStartDate DATE;
	v_DrawEndDate DATE;
	v_HostDrawDatesId INTEGER;
	v_MinSalesDatetime TIMESTAMP;
	v_MaxSalesDatetime TIMESTAMP;

begin

	
-- Creating ubt_temp_DrawDates table

-- 26-04-2022: Hira - start: modified query for perf tuning
create temp table ubt_temp_dd_tran as
select distinct tranheaderid from ztubt_DrawDates dd
where cast(dd.DrawDate as date)  >= v_DrawClosedDate;

CREATE TEMP  TABLE ubt_temp_DrawDates as
SELECT distinct dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM ubt_temp_dd_tran dd
inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid; 

	
--CREATE TEMP  TABLE ubt_temp_DrawDates as
--SELECT DISTINCT dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM public.ztubt_DrawDates dd
--inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid 
--WHERE cast(dd.DrawDate as date)  >= v_DrawClosedDate;

-- 26-04-2022: Hira - End: modified query for perf tuning

-- setting variable for host_ID , draw_start_date and draw_end_date
 SELECT HostDrawDatesId, cast( DrawStartDate as date), cast(DrawEndDate as date) 
 into
 v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate  
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) = v_DrawClosedDate AND ProdID = v_ProdID;


  IF v_HostDrawDatesId IS NULL
	THEN
		SELECT  HostDrawDatesId,  MIN(BD.ActualDate),  MAX(BD.ActualDate)  
			INTO v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate
			FROM public.ztubt_PlacedBetTransactionHeader PBTH 
			INNER JOIN ubt_temp_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID --(1)
			LEFT JOIN public.ztubt_getbusinessdate_perhost BD 
			ON PBTH.CreatedDate >= (BD.PreviousPeriodDateTime + interval '-8 hour') AND PBTH.CreatedDate < (BD.PeriodDateTime + interval '-8 hour')
			and BD.HOST = 1
			WHERE (DD.DrawDate :: date) = v_DrawClosedDate AND PBTH.ProdID = v_ProdID 
			GROUP BY HostDrawDatesId;
	END	IF;
	

-- Getting business date for lottery	
CREATE TEMP  TABLE ubt_temp_BusinessDate as
SELECT PreviousPeriodDateTime, PeriodDateTime, ActualDate 
FROM public.ztubt_getbusinessdate_perhost BD
WHERE HOST = 1
and (ActualDate ::date) BETWEEN v_DrawStartDate AND v_DrawEndDate;


-- setting minimum sales date and maximu sales date	
SELECT MIN(PreviousPeriodDateTime), MAX(PeriodDateTime)
	INTO v_MinSalesDatetime, v_MaxSalesDatetime
	FROM ubt_temp_BusinessDate;	


-- List of HostDrawDateIDs	

CREATE TEMP  TABLE ubt_temp_ListOfHostDrawDatesID as	
SELECT  HostDrawDatesId
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) >= v_DrawClosedDate AND ProdID = v_ProdID 
	ORDER BY HostDrawDatesId	limit v_TotalDraw;


IF ((SELECT COUNT(*) FROM ubt_temp_ListOfHostDrawDatesID) != v_TotalDraw)
THEN
		DELETE FROM ubt_temp_ListOfHostDrawDatesID;

		INSERT INTO ubt_temp_ListOfHostDrawDatesID
		SELECT  HostDrawDatesId
		FROM
		(
			SELECT DISTINCT HostDrawDatesId, DD.DrawDate
			FROM ubt_temp_DrawDates DD 
			INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON DD.TranHeaderID = PBTH.TranHeaderID
			where ( DD.DrawDate :: date) >= v_DrawClosedDate AND HostDrawDatesId >= v_HostDrawDatesId 
			AND PBTH.ProdID = v_ProdID
		)FIN
		ORDER BY FIN.DrawDate limit v_TotalDraw;
	END	if;



	CREATE TEMP  TABLE ubt_temp_GetCFSUMReport
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId Int4,
		ActualDate DATE,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesCommAmount numeric(32, 12),
		SalesFactorAmount numeric(32, 12),
		SecondSalesCommAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12)
		
	);

	
--- Dummy Entries	
	IF v_HostDrawDatesId IS NOT NULL
	THEN
		--Make template of the report based on the configuration draw count
		
		INSERT INTO ubt_temp_GetCFSUMReport
		SELECT HDD.HostDrawDatesID, DateData, 0, 0, 0, 0, 0
		FROM (
		SELECT (date_trunc('day', dd):: date)  DateData
		FROM generate_series
        ( v_DrawStartDate
        , v_DrawEndDate
        , '1 day'::interval) dd
		) as DateRange
		
		CROSS JOIN
		ubt_temp_ListOfHostDrawDatesID HDD;
	
		
		if v_ProdID = 2 --4D
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTLN.BigBetAcceptedWager,0)) AS Wager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SmallBetAcceptedWager,0)) AS SecondWager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesCommAmountBig,0)) AS SalesCommAmount, --calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesFactorAmountBig,0)) AS SalesFactorAmount, 
					SUM(coalesce(PBTLN.SalesCommAmountSmall,0)) AS SecondSalesCommAmount, 
					SUM(coalesce(PBTLN.SalesFactorAmountSmall,0))AS SecondSalesFactorAmount
					FROM public.ztUBT_4D_PlacedBetTransactionLineItemNumber PBTLN
					INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
					INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 2
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;

		ELSIF v_ProdID = 3 --TOTO
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTL.BetPriceAmount,0)) / DDT.Ct AS Wager, --(2) calculate only placed ticket (not cancelled after)
					0 AS SecondWager,
					SUM(coalesce(PBTL.SalesCommAmount,0)) / DDT.Ct AS SalesCommAmount, --(1)--calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTL.SalesFactorAmount,0)) / DDT.Ct AS SalesFactorAmount, --(1)
					0 AS SecondSalesCommAmount, 
					0 AS SecondSalesFactorAmount
					FROM public.ztubt_toto_PlacedBetTransactionLineItem PBTL
					INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON PBTL.TranHeaderID = PBTH.TranHeaderID 
					INNER JOIN public.ztubt_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTL.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN (
					SELECT TranHeaderID, COUNT(TranHeaderID) AS Ct FROM ubt_temp_DrawDates DD --(1)
						GROUP BY TranHeaderID
					) DDT ON DDT.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTL.CreatedDate >= BD.PreviousPeriodDateTime  + interval '-8 hour' AND PBTL.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE (PBTL.GroupUnitSequence is null or PBTL.GroupUnitSequence = 1) 
					AND PBTL.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTL.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 3
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate, DDT.Ct
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;
			
		ELSIf v_ProdID = 4 --SWEEP
		THEN
				--Insert wager only
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 0, 0, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER join ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE 
				PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				and PBTH.IsCancelled = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

				--For Sweep PB03 IsPrint NULL (only for Sweep Consignee and Sweep Retailer locations)
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount,  
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount,
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB03'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >=BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				AND PBTLN.CreatedDate >=(v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				--AND PBTH.IsCancelled  = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false
				GROUP BY DD.HostDrawDatesId, BD.ActualDate
			-- [2022-03-31] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation				
				--For Sweep Cancellation (only for Sweep Consignee and Sweep Retailer locations)	
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				(0-SUM(coalesce(PBTLN.BetPriceAmount,0))) AS Wager,
				0 AS SecondWager, 
				(0-SUM(coalesce(PBTLN.SalesCommAmount,0))) AS SalesCommAmount,  
				(0-SUM(coalesce(PBTLN.SalesFactorAmount,0))) AS SalesFactorAmount, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem  PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztubt_cancelledbetticket CBT  ON PBTLN.TranHeaderID = CBT.TranHeaderID 
				INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				--LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND CBT.CancelledDate < BD.PeriodDateTime + interval '-8 hour'
				LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime  AND CBT.CancelledDate < BD.PeriodDateTime 
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				--AND CBT.CancelledDate >= (v_MinSalesDatetime + interval '-8 hour') AND CBT.CancelledDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND CBT.CancelledDate >= v_MinSalesDatetime  AND CBT.CancelledDate < v_MaxSalesDatetime 
				AND CBT.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

			-- [2022-03-31] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation			
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 0, 0, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount, --(2) 
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount, --(2) 
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID 
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				AND cast(PBTH.IsCancelled as integer) = 0
				AND PBTH.ProdID = 4
				AND cast(PBTLN.IsSoldOut as integer) = 0 --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate;
		end if; 
	end if;
	
return query
	SELECT 
	HostDrawDatesId, ActualDate,
	SUM(COALESCE(Wager,0))/100 AS Wager, --Convert big bet price amount from cents to dollar
	SUM(COALESCE(SecondWager,0))/100 AS SecondWager, --Convert small bet price amount from cents to dollar
	SUM(COALESCE(SalesFactorAmount,0))/100 AS SalesFactorAmount, --Convert from cents to dollar
	SUM(COALESCE(SecondSalesFactorAmount,0))/100 AS SecondSalesFactorAmount, --Convert from cents to dollar
	SUM(COALESCE(SalesCommAmount,0) + COALESCE(SecondSalesCommAmount,0))/100 AS SalesCommAmount, --Convert from cents to dollar
	case when b.drawStatus_canceld = 'T' then 1
	else 0
	end AS iscancelled
	FROM ubt_temp_GetCFSUMReport a
	LEFT JOIN (
	SELECT DISTINCT zp.drawnumber, zp.drawStatus_canceld
	FROM ztes_pdf_drawparam zp left join ztubt_sap_product zap on (zp.productnum = zap.sapprodid)
	WHERE zap.prodid = v_prodid and zp.drawcdc + DATE '19860511' <= DATE(v_drawcloseddate)
	) b 
	ON (a.HostDrawDatesId = b.drawnumber) 
	where actualdate is not null
	and HostDrawDatesId  in (select hostdrawdatesid from ubt_temp_ListOfHostDrawDatesID)
	GROUP BY HostDrawDatesId, ActualDate, b.drawStatus_canceld;
		
DROP TABLE IF EXISTS ubt_temp_DrawDates;	
DROP TABLE IF EXISTS ubt_temp_ListOfHostDrawDatesID;
DROP TABLE IF EXISTS ubt_temp_BusinessDate;
DROP TABLE IF EXISTS ubt_temp_GetCFSUMReport;
drop table if exists ubt_temp_dd_tran;

END;

$$;


ALTER FUNCTION public.sp_ubt_getcfsumreport_bk20241010(v_drawcloseddate date, v_prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1104 (class 1255 OID 2073656)
-- Name: sp_ubt_getcfsumreport_bk20241203(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getcfsumreport_bk20241203(v_drawcloseddate date, v_prodid integer) RETURNS TABLE(hostdrawdatesid integer, actualdate date, subprod text, wager numeric, secondwager numeric, salesfactoramount numeric, secondsalesfactoramount numeric, salescommamount numeric, iscencelled integer)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

DECLARE 
	v_TotalDraw INTEGER := (SELECT Fld2Value
		FROM public.ztUBT_LookupValueConfig LV
		WHERE ConfigName = 'RTMS_DrawCount' AND Fld3Value = cast (v_ProdID as varchar));
	v_DrawStartDate DATE;
	v_DrawEndDate DATE;
	v_HostDrawDatesId INTEGER;
	v_MinSalesDatetime TIMESTAMP;
	v_MaxSalesDatetime TIMESTAMP;
	v_tfogBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettfogbettypes()));
begin

	
-- Creating ubt_temp_DrawDates table

-- 26-04-2022: Hira - start: modified query for perf tuning
create temp table ubt_temp_dd_tran as
select distinct tranheaderid from ztubt_DrawDates dd
where cast(dd.DrawDate as date)  >= v_DrawClosedDate;

CREATE TEMP  TABLE ubt_temp_DrawDates as
SELECT distinct dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM ubt_temp_dd_tran dd
inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid; 

	
--CREATE TEMP  TABLE ubt_temp_DrawDates as
--SELECT DISTINCT dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM public.ztubt_DrawDates dd
--inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid 
--WHERE cast(dd.DrawDate as date)  >= v_DrawClosedDate;

-- 26-04-2022: Hira - End: modified query for perf tuning

-- setting variable for host_ID , draw_start_date and draw_end_date
 SELECT HostDrawDatesId, cast( DrawStartDate as date), cast(DrawEndDate as date) 
 into
 v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate  
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) = v_DrawClosedDate AND ProdID = v_ProdID;


  IF v_HostDrawDatesId IS NULL
	THEN
		SELECT  HostDrawDatesId,  MIN(BD.ActualDate),  MAX(BD.ActualDate)  
			INTO v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate
			FROM public.ztubt_PlacedBetTransactionHeader PBTH 
			INNER JOIN ubt_temp_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID --(1)
			LEFT JOIN public.ztubt_getbusinessdate_perhost BD 
			ON PBTH.CreatedDate >= (BD.PreviousPeriodDateTime + interval '-8 hour') AND PBTH.CreatedDate < (BD.PeriodDateTime + interval '-8 hour')
			and BD.HOST = 1
			WHERE (DD.DrawDate :: date) = v_DrawClosedDate AND PBTH.ProdID = v_ProdID 
			GROUP BY HostDrawDatesId;
	END	IF;
	

-- Getting business date for lottery	
CREATE TEMP  TABLE ubt_temp_BusinessDate as
SELECT PreviousPeriodDateTime, PeriodDateTime, ActualDate 
FROM public.ztubt_getbusinessdate_perhost BD
WHERE HOST = 1
and (ActualDate ::date) BETWEEN v_DrawStartDate AND v_DrawEndDate;


-- setting minimum sales date and maximu sales date	
SELECT MIN(PreviousPeriodDateTime), MAX(PeriodDateTime)
	INTO v_MinSalesDatetime, v_MaxSalesDatetime
	FROM ubt_temp_BusinessDate;	


-- List of HostDrawDateIDs	

CREATE TEMP  TABLE ubt_temp_ListOfHostDrawDatesID as	
SELECT  HostDrawDatesId
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) >= v_DrawClosedDate AND ProdID = v_ProdID 
	ORDER BY HostDrawDatesId	limit v_TotalDraw;


IF ((SELECT COUNT(*) FROM ubt_temp_ListOfHostDrawDatesID) != v_TotalDraw)
THEN
		DELETE FROM ubt_temp_ListOfHostDrawDatesID;

		INSERT INTO ubt_temp_ListOfHostDrawDatesID
		SELECT  HostDrawDatesId
		FROM
		(
			SELECT DISTINCT HostDrawDatesId, DD.DrawDate
			FROM ubt_temp_DrawDates DD 
			INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON DD.TranHeaderID = PBTH.TranHeaderID
			where ( DD.DrawDate :: date) >= v_DrawClosedDate AND HostDrawDatesId >= v_HostDrawDatesId 
			AND PBTH.ProdID = v_ProdID
		)FIN
		ORDER BY FIN.DrawDate limit v_TotalDraw;
	END	if;



	CREATE TEMP  TABLE ubt_temp_GetCFSUMReport
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId Int4,
		ActualDate DATE,
		SubProd text,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesCommAmount numeric(32, 12),
		SalesFactorAmount numeric(32, 12),
		SecondSalesCommAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12)
		
	);

	
--- Dummy Entries	
	IF v_HostDrawDatesId IS NOT NULL
	THEN
		--Make template of the report based on the configuration draw count
		IF v_ProdID = 3 -- toto
		THEN
			INSERT INTO ubt_temp_GetCFSUMReport
			SELECT HDD.HostDrawDatesID, DateData, totosubprod.SubProd, 0, 0, 0, 0, 0
			FROM (
			SELECT (date_trunc('day', dd):: date)  DateData
			FROM generate_series
			( v_DrawStartDate
			, v_DrawEndDate
			, '1 day'::interval) dd
			) as DateRange
			
			CROSS JOIN
			ubt_temp_ListOfHostDrawDatesID HDD
			
			CROSS JOIN (VALUES ('t649'), ('tfog')) AS totosubprod(SubProd);
		ELSEIF v_ProdID <> 3 -- other products
		THEN
			INSERT INTO ubt_temp_GetCFSUMReport
			SELECT HDD.HostDrawDatesID, DateData, '', 0, 0, 0, 0, 0
			FROM (
			SELECT (date_trunc('day', dd):: date)  DateData
			FROM generate_series
			( v_DrawStartDate
			, v_DrawEndDate
			, '1 day'::interval) dd
			) as DateRange
			
			CROSS JOIN
			ubt_temp_ListOfHostDrawDatesID HDD;
		end if; 
		
		if v_ProdID = 2 --4D
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, '', SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTLN.BigBetAcceptedWager,0)) AS Wager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SmallBetAcceptedWager,0)) AS SecondWager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesCommAmountBig,0)) AS SalesCommAmount, --calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesFactorAmountBig,0)) AS SalesFactorAmount, 
					SUM(coalesce(PBTLN.SalesCommAmountSmall,0)) AS SecondSalesCommAmount, 
					SUM(coalesce(PBTLN.SalesFactorAmountSmall,0))AS SecondSalesFactorAmount
					FROM public.ztUBT_4D_PlacedBetTransactionLineItemNumber PBTLN
					INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
					INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 2
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;

		ELSIF v_ProdID = 3 --TOTO
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SubProd, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					CASE WHEN PBTL.bettypeid = ANY(v_tfogBettypes) THEN 'tfog' ELSE 't649' END as SubProd,
					SUM(coalesce(PBTL.BetPriceAmount,0)) / DDT.Ct AS Wager, --(2) calculate only placed ticket (not cancelled after)
					0 AS SecondWager,
					SUM(coalesce(PBTL.SalesCommAmount,0)) / DDT.Ct AS SalesCommAmount, --(1)--calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTL.SalesFactorAmount,0)) / DDT.Ct AS SalesFactorAmount, --(1)
					0 AS SecondSalesCommAmount, 
					0 AS SecondSalesFactorAmount
					FROM public.ztubt_toto_PlacedBetTransactionLineItem PBTL
					INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON PBTL.TranHeaderID = PBTH.TranHeaderID 
					INNER JOIN public.ztubt_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTL.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN (
					SELECT TranHeaderID, COUNT(TranHeaderID) AS Ct FROM ubt_temp_DrawDates DD --(1)
						GROUP BY TranHeaderID
					) DDT ON DDT.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTL.CreatedDate >= BD.PreviousPeriodDateTime  + interval '-8 hour' AND PBTL.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE (PBTL.GroupUnitSequence is null or PBTL.GroupUnitSequence = 1) 
					AND PBTL.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTL.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 3
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate, DDT.Ct,
						CASE WHEN PBTL.bettypeid = ANY(v_tfogBettypes) THEN 'tfog' ELSE 't649' END
				)FIN
				GROUP BY HostDrawDatesId, ActualDate, SubProd;

		ELSIf v_ProdID = 4 --SWEEP
		THEN
				--Insert wager only
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 0, 0, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER join ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE 
				PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				and PBTH.IsCancelled = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

				--For Sweep PB03 IsPrint NULL (only for Sweep Consignee and Sweep Retailer locations)
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount,  
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount,
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB03'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >=BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				AND PBTLN.CreatedDate >=(v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				--AND PBTH.IsCancelled  = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false
				GROUP BY DD.HostDrawDatesId, BD.ActualDate
			-- [2022-03-31] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation				
				--For Sweep Cancellation (only for Sweep Consignee and Sweep Retailer locations)	
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				(0-SUM(coalesce(PBTLN.BetPriceAmount,0))) AS Wager,
				0 AS SecondWager, 
				(0-SUM(coalesce(PBTLN.SalesCommAmount,0))) AS SalesCommAmount,  
				(0-SUM(coalesce(PBTLN.SalesFactorAmount,0))) AS SalesFactorAmount, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem  PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztubt_cancelledbetticket CBT  ON PBTLN.TranHeaderID = CBT.TranHeaderID 
				INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				--LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND CBT.CancelledDate < BD.PeriodDateTime + interval '-8 hour'
				LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime  AND CBT.CancelledDate < BD.PeriodDateTime 
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				--AND CBT.CancelledDate >= (v_MinSalesDatetime + interval '-8 hour') AND CBT.CancelledDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND CBT.CancelledDate >= v_MinSalesDatetime  AND CBT.CancelledDate < v_MaxSalesDatetime 
				AND CBT.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

			-- [2022-03-31] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation			
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '', 0, 0, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount, --(2) 
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount, --(2) 
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID 
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				AND cast(PBTH.IsCancelled as integer) = 0
				AND PBTH.ProdID = 4
				AND cast(PBTLN.IsSoldOut as integer) = 0 --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate;
		end if; 
	end if;
	
return query
	SELECT 
	HostDrawDatesId, ActualDate, SubProd,
	SUM(COALESCE(Wager,0))/100 AS Wager, --Convert big bet price amount from cents to dollar
	SUM(COALESCE(SecondWager,0))/100 AS SecondWager, --Convert small bet price amount from cents to dollar
	SUM(COALESCE(SalesFactorAmount,0))/100 AS SalesFactorAmount, --Convert from cents to dollar
	SUM(COALESCE(SecondSalesFactorAmount,0))/100 AS SecondSalesFactorAmount, --Convert from cents to dollar
	SUM(COALESCE(SalesCommAmount,0) + COALESCE(SecondSalesCommAmount,0))/100 AS SalesCommAmount, --Convert from cents to dollar
	case when b.drawStatus_canceld = 'T' then 1
	else 0
	end AS iscancelled
	FROM ubt_temp_GetCFSUMReport a
	LEFT JOIN (
	SELECT DISTINCT zp.drawnumber, zp.drawStatus_canceld
	FROM ztes_pdf_drawparam zp left join ztubt_sap_product zap on (zp.productnum = zap.sapprodid)
	WHERE zap.prodid = v_prodid and zp.drawcdc + DATE '19860511' <= DATE(v_drawcloseddate)
	) b 
	ON (a.HostDrawDatesId = b.drawnumber) 
	where actualdate is not null
	and HostDrawDatesId  in (select hostdrawdatesid from ubt_temp_ListOfHostDrawDatesID)
	GROUP BY HostDrawDatesId, ActualDate, b.drawStatus_canceld, SubProd;
		
DROP TABLE IF EXISTS ubt_temp_DrawDates;	
DROP TABLE IF EXISTS ubt_temp_ListOfHostDrawDatesID;
DROP TABLE IF EXISTS ubt_temp_BusinessDate;
DROP TABLE IF EXISTS ubt_temp_GetCFSUMReport;
drop table if exists ubt_temp_dd_tran;

END;

$$;


ALTER FUNCTION public.sp_ubt_getcfsumreport_bk20241203(v_drawcloseddate date, v_prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1122 (class 1255 OID 267545)
-- Name: sp_ubt_getcfsumreport_bkup_220922(date, integer); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_ubt_getcfsumreport_bkup_220922(v_drawcloseddate date, v_prodid integer) RETURNS TABLE(hostdrawdatesid integer, actualdate date, wager numeric, secondwager numeric, salesfactoramount numeric, secondsalesfactoramount numeric, salescommamount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

DECLARE 
	v_TotalDraw INTEGER := (SELECT Fld2Value
		FROM public.ztUBT_LookupValueConfig LV
		WHERE ConfigName = 'RTMS_DrawCount' AND Fld3Value = cast (v_ProdID as varchar));
	v_DrawStartDate DATE;
	v_DrawEndDate DATE;
	v_HostDrawDatesId INTEGER;
	v_MinSalesDatetime TIMESTAMP;
	v_MaxSalesDatetime TIMESTAMP;

begin
-- Creating ubt_temp_DrawDates table

-- 26-04-2022: Hira - start: modified query for perf tuning
create temp table ubt_temp_dd_tran as
select distinct tranheaderid from ztubt_DrawDates dd
where cast(dd.DrawDate as date)  >= v_DrawClosedDate;

CREATE TEMP  TABLE ubt_temp_DrawDates as
SELECT distinct dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM ubt_temp_dd_tran dd
inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid; 

	
--CREATE TEMP  TABLE ubt_temp_DrawDates as
--SELECT DISTINCT dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM public.ztubt_DrawDates dd
--inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid 
--WHERE cast(dd.DrawDate as date)  >= v_DrawClosedDate;

-- 26-04-2022: Hira - End: modified query for perf tuning

-- setting variable for host_ID , draw_start_date and draw_end_date
 SELECT HostDrawDatesId, cast( DrawStartDate as date), cast(DrawEndDate as date) 
 into
 v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate  
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) = v_DrawClosedDate AND ProdID = v_ProdID;


  IF v_HostDrawDatesId IS NULL
	THEN
		SELECT  HostDrawDatesId,  MIN(BD.ActualDate),  MAX(BD.ActualDate)  
			INTO v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate
			FROM public.ztubt_PlacedBetTransactionHeader PBTH 
			INNER JOIN ubt_temp_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID --(1)
			LEFT JOIN public.ztubt_getbusinessdate_perhost BD 
			ON PBTH.CreatedDate >= (BD.PreviousPeriodDateTime + interval '-8 hour') AND PBTH.CreatedDate < (BD.PeriodDateTime + interval '-8 hour')
			and BD.HOST = 1
			WHERE (DD.DrawDate :: date) = v_DrawClosedDate AND PBTH.ProdID = v_ProdID 
			GROUP BY HostDrawDatesId;
	END	IF;
	

-- Getting business date for lottery	


CREATE TEMP  TABLE ubt_temp_BusinessDate as
SELECT PreviousPeriodDateTime, PeriodDateTime, ActualDate 
FROM public.ztubt_getbusinessdate_perhost BD
WHERE HOST = 1
and (ActualDate ::date) BETWEEN v_DrawStartDate AND v_DrawEndDate;


-- setting minimum sales date and maximu sales date	
SELECT MIN(PreviousPeriodDateTime), MAX(PeriodDateTime)
	INTO v_MinSalesDatetime, v_MaxSalesDatetime
	FROM ubt_temp_BusinessDate;	


-- List of HostDrawDateIDs	

CREATE TEMP  TABLE ubt_temp_ListOfHostDrawDatesID as	
SELECT  HostDrawDatesId
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) >= v_DrawClosedDate AND ProdID = v_ProdID 
	ORDER BY HostDrawDatesId	limit v_TotalDraw;


IF ((SELECT COUNT(*) FROM ubt_temp_ListOfHostDrawDatesID) != v_TotalDraw)
THEN
		DELETE FROM ubt_temp_ListOfHostDrawDatesID;

		INSERT INTO ubt_temp_ListOfHostDrawDatesID
		SELECT  HostDrawDatesId
		FROM
		(
			SELECT DISTINCT HostDrawDatesId, DD.DrawDate
			FROM ubt_temp_DrawDates DD 
			INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON DD.TranHeaderID = PBTH.TranHeaderID
			where ( DD.DrawDate :: date) >= v_DrawClosedDate AND HostDrawDatesId >= v_HostDrawDatesId 
			AND PBTH.ProdID = v_ProdID
		)FIN
		ORDER BY FIN.DrawDate limit v_TotalDraw;
	END	if;



	CREATE TEMP  TABLE ubt_temp_GetCFSUMReport
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId Int4,
		ActualDate DATE,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesCommAmount numeric(32, 12),
		SalesFactorAmount numeric(32, 12),
		SecondSalesCommAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12)
		
	);

	
--- Dummy Entries	
	IF v_HostDrawDatesId IS NOT NULL
	THEN
		--Make template of the report based on the configuration draw count
		
		INSERT INTO ubt_temp_GetCFSUMReport
		SELECT HDD.HostDrawDatesID, DateData, 0, 0, 0, 0, 0
		FROM (
		SELECT (date_trunc('day', dd):: date)  DateData
		FROM generate_series
        ( v_DrawStartDate
        , v_DrawEndDate
        , '1 day'::interval) dd
		) as DateRange
		
		CROSS JOIN
		ubt_temp_ListOfHostDrawDatesID HDD;
	
	
		if v_ProdID = 2 --4D
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTLN.BigBetAcceptedWager,0)) AS Wager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SmallBetAcceptedWager,0)) AS SecondWager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesCommAmountBig,0)) AS SalesCommAmount, --calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesFactorAmountBig,0)) AS SalesFactorAmount, 
					SUM(coalesce(PBTLN.SalesCommAmountSmall,0)) AS SecondSalesCommAmount, 
					SUM(coalesce(PBTLN.SalesFactorAmountSmall,0))AS SecondSalesFactorAmount
					FROM public.ztUBT_4D_PlacedBetTransactionLineItemNumber PBTLN
					INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
					INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 2
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;

		ELSIF v_ProdID = 3 --TOTO
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTL.BetPriceAmount,0)) / DDT.Ct AS Wager, --(2) calculate only placed ticket (not cancelled after)
					0 AS SecondWager,
					SUM(coalesce(PBTL.SalesCommAmount,0)) / DDT.Ct AS SalesCommAmount, --(1)--calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTL.SalesFactorAmount,0)) / DDT.Ct AS SalesFactorAmount, --(1)
					0 AS SecondSalesCommAmount, 
					0 AS SecondSalesFactorAmount
					FROM public.ztubt_toto_PlacedBetTransactionLineItem PBTL
					INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON PBTL.TranHeaderID = PBTH.TranHeaderID 
					INNER JOIN public.ztubt_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTL.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN (
					SELECT TranHeaderID, COUNT(TranHeaderID) AS Ct FROM ubt_temp_DrawDates DD --(1)
						GROUP BY TranHeaderID
					) DDT ON DDT.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTL.CreatedDate >= BD.PreviousPeriodDateTime  + interval '-8 hour' AND PBTL.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE (PBTL.GroupUnitSequence is null or PBTL.GroupUnitSequence = 1) 
					AND PBTL.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTL.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 3
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate, DDT.Ct
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;
			
		ELSIf v_ProdID = 4 --SWEEP
		THEN
				--Insert wager only
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 0, 0, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER join ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE 
				PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				and PBTH.IsCancelled = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

				--For Sweep PB03 IsPrint NULL (only for Sweep Consignee and Sweep Retailer locations)
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount,  
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount,
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB03'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >=BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				AND PBTLN.CreatedDate >=(v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				--AND PBTH.IsCancelled  = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false
				GROUP BY DD.HostDrawDatesId, BD.ActualDate
			-- [2022-03-31] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation				
				--For Sweep Cancellation (only for Sweep Consignee and Sweep Retailer locations)	
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 
				(0-SUM(coalesce(PBTLN.BetPriceAmount,0))) AS Wager,
				0 AS SecondWager, 
				(0-SUM(coalesce(PBTLN.SalesCommAmount,0))) AS SalesCommAmount,  
				(0-SUM(coalesce(PBTLN.SalesFactorAmount,0))) AS SalesFactorAmount, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem  PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztubt_cancelledbetticket CBT  ON PBTLN.TranHeaderID = CBT.TranHeaderID 
				INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				--LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND CBT.CancelledDate < BD.PeriodDateTime + interval '-8 hour'
				LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime  AND CBT.CancelledDate < BD.PeriodDateTime
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				--AND CBT.CancelledDate >= (v_MinSalesDatetime + interval '-8 hour') AND CBT.CancelledDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND CBT.CancelledDate >= v_MinSalesDatetime  AND CBT.CancelledDate < v_MaxSalesDatetime
				AND CBT.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

			-- [2022-03-31] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation			
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, 0, 0, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount, --(2) 
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount, --(2) 
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID 
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				AND cast(PBTH.IsCancelled as integer) = 0
				AND PBTH.ProdID = 4
				AND cast(PBTLN.IsSoldOut as integer) = 0 --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate;
		end if; 
	end if;
	
return query
			SELECT 
			HostDrawDatesId, ActualDate,
			SUM(COALESCE(Wager,0))/100 AS Wager, --Convert big bet price amount from cents to dollar
			SUM(COALESCE(SecondWager,0))/100 AS SecondWager, --Convert small bet price amount from cents to dollar
			SUM(COALESCE(SalesFactorAmount,0))/100 AS SalesFactorAmount, --Convert from cents to dollar
			SUM(COALESCE(SecondSalesFactorAmount,0))/100 AS SecondSalesFactorAmount, --Convert from cents to dollar
			SUM(COALESCE(SalesCommAmount,0) + COALESCE(SecondSalesCommAmount,0))/100 AS SalesCommAmount --Convert from cents to dollar
			FROM ubt_temp_GetCFSUMReport
			where actualdate is not null
			GROUP BY HostDrawDatesId, ActualDate;
		
DROP TABLE IF EXISTS ubt_temp_DrawDates;	
DROP TABLE IF EXISTS ubt_temp_ListOfHostDrawDatesID;
DROP TABLE IF EXISTS ubt_temp_BusinessDate;
DROP TABLE IF EXISTS ubt_temp_GetCFSUMReport;
drop table if exists ubt_temp_dd_tran;

END;

$$;


ALTER FUNCTION public.sp_ubt_getcfsumreport_bkup_220922(v_drawcloseddate date, v_prodid integer) OWNER TO postgres;

--
-- TOC entry 1130 (class 1255 OID 2169470)
-- Name: sp_ubt_getcfsumreport_mt19(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getcfsumreport_mt19(v_drawcloseddate date, v_prodid integer) RETURNS TABLE(hostdrawdatesid integer, actualdate date, subprod text, wager numeric, secondwager numeric, salesfactoramount numeric, secondsalesfactoramount numeric, salescommamount numeric, iscencelled integer)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

DECLARE 
	v_TotalDraw INTEGER := (SELECT Fld2Value
		FROM public.ztUBT_LookupValueConfig LV
		WHERE ConfigName = 'RTMS_DrawCount' AND Fld3Value = cast (v_ProdID as varchar));
	v_DrawStartDate DATE;
	v_DrawEndDate DATE;
	v_HostDrawDatesId INTEGER;
	v_MinSalesDatetime TIMESTAMP;
	v_MaxSalesDatetime TIMESTAMP;
	v_tfogBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettfogbettypes()));
begin

	
-- Creating ubt_temp_DrawDates table

-- 26-04-2022: Hira - start: modified query for perf tuning
create temp table ubt_temp_dd_tran as
select distinct tranheaderid from ztubt_DrawDates dd
where cast(dd.DrawDate as date)  >= v_DrawClosedDate;

CREATE TEMP  TABLE ubt_temp_DrawDates as
SELECT distinct dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM ubt_temp_dd_tran dd
inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid; 

	
--CREATE TEMP  TABLE ubt_temp_DrawDates as
--SELECT DISTINCT dd.TranHeaderID, zd.DrawDate, zd.HostDrawDatesId FROM public.ztubt_DrawDates dd
--inner join public.ztubt_drawdates zd on dd.tranheaderid =zd.tranheaderid 
--WHERE cast(dd.DrawDate as date)  >= v_DrawClosedDate;

-- 26-04-2022: Hira - End: modified query for perf tuning

-- setting variable for host_ID , draw_start_date and draw_end_date
 SELECT HostDrawDatesId, cast( DrawStartDate as date), cast(DrawEndDate as date) 
 into
 v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate  
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) = v_DrawClosedDate AND ProdID = v_ProdID;


  IF v_HostDrawDatesId IS NULL
	THEN
		SELECT  HostDrawDatesId,  MIN(BD.ActualDate),  MAX(BD.ActualDate)  
			INTO v_HostDrawDatesId, v_DrawStartDate, v_DrawEndDate
			FROM public.ztubt_PlacedBetTransactionHeader PBTH 
			INNER JOIN ubt_temp_DrawDates DD ON PBTH.TranHeaderID = DD.TranHeaderID --(1)
			LEFT JOIN public.ztubt_getbusinessdate_perhost BD 
			ON PBTH.CreatedDate >= (BD.PreviousPeriodDateTime + interval '-8 hour') AND PBTH.CreatedDate < (BD.PeriodDateTime + interval '-8 hour')
			and BD.HOST = 1
			WHERE (DD.DrawDate :: date) = v_DrawClosedDate AND PBTH.ProdID = v_ProdID 
			GROUP BY HostDrawDatesId;
	END	IF;
	

-- Getting business date for lottery	
CREATE TEMP  TABLE ubt_temp_BusinessDate as
SELECT PreviousPeriodDateTime, PeriodDateTime, ActualDate 
FROM public.ztubt_getbusinessdate_perhost BD
WHERE HOST = 1
and (ActualDate ::date) BETWEEN v_DrawStartDate AND v_DrawEndDate;


-- setting minimum sales date and maximu sales date	
SELECT MIN(PreviousPeriodDateTime), MAX(PeriodDateTime)
	INTO v_MinSalesDatetime, v_MaxSalesDatetime
	FROM ubt_temp_BusinessDate;	


-- List of HostDrawDateIDs	

CREATE TEMP  TABLE ubt_temp_ListOfHostDrawDatesID as	
SELECT  HostDrawDatesId
	FROM public.ztubt_drawdates_master zdm 
	WHERE (DrawEndDate :: date) >= v_DrawClosedDate AND ProdID = v_ProdID 
	ORDER BY HostDrawDatesId	limit v_TotalDraw;


IF ((SELECT COUNT(*) FROM ubt_temp_ListOfHostDrawDatesID) != v_TotalDraw)
THEN
		DELETE FROM ubt_temp_ListOfHostDrawDatesID;

		INSERT INTO ubt_temp_ListOfHostDrawDatesID
		SELECT  HostDrawDatesId
		FROM
		(
			SELECT DISTINCT HostDrawDatesId, DD.DrawDate
			FROM ubt_temp_DrawDates DD 
			INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON DD.TranHeaderID = PBTH.TranHeaderID
			where ( DD.DrawDate :: date) >= v_DrawClosedDate AND HostDrawDatesId >= v_HostDrawDatesId 
			AND PBTH.ProdID = v_ProdID
		)FIN
		ORDER BY FIN.DrawDate limit v_TotalDraw;
	END	if;



	CREATE TEMP  TABLE ubt_temp_GetCFSUMReport
	(
		-- Add the column definitions for the TABLE variable here
		HostDrawDatesId Int4,
		ActualDate DATE,
		SubProd text,
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		SalesCommAmount numeric(32, 12),
		SalesFactorAmount numeric(32, 12),
		SecondSalesCommAmount numeric(32, 12),
		SecondSalesFactorAmount numeric(32, 12)
		
	);

	
--- Dummy Entries	
	IF v_HostDrawDatesId IS NOT NULL
	THEN
		--Make template of the report based on the configuration draw count
		IF v_ProdID = 3 -- toto
		THEN
			INSERT INTO ubt_temp_GetCFSUMReport
			SELECT HDD.HostDrawDatesID, DateData, totosubprod.SubProd, 0, 0, 0, 0, 0
			FROM (
			SELECT (date_trunc('day', dd):: date)  DateData
			FROM generate_series
			( v_DrawStartDate
			, v_DrawEndDate
			, '1 day'::interval) dd
			) as DateRange
			
			CROSS JOIN
			ubt_temp_ListOfHostDrawDatesID HDD
			
			CROSS JOIN (VALUES ('t649'), ('tfog')) AS totosubprod(SubProd);
		ELSEIF v_ProdID <> 3 -- other products
		THEN
			INSERT INTO ubt_temp_GetCFSUMReport
			SELECT HDD.HostDrawDatesID, DateData, '', 0, 0, 0, 0, 0
			FROM (
			SELECT (date_trunc('day', dd):: date)  DateData
			FROM generate_series
			( v_DrawStartDate
			, v_DrawEndDate
			, '1 day'::interval) dd
			) as DateRange
			
			CROSS JOIN
			ubt_temp_ListOfHostDrawDatesID HDD;
		end if; 
		
		if v_ProdID = 2 --4D
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, '', SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					SUM(coalesce(PBTLN.BigBetAcceptedWager,0)) AS Wager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SmallBetAcceptedWager,0)) AS SecondWager, --(2) calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesCommAmountBig,0)) AS SalesCommAmount, --calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTLN.SalesFactorAmountBig,0)) AS SalesFactorAmount, 
					SUM(coalesce(PBTLN.SalesCommAmountSmall,0)) AS SecondSalesCommAmount, 
					SUM(coalesce(PBTLN.SalesFactorAmountSmall,0))AS SecondSalesFactorAmount
					FROM public.ztUBT_4D_PlacedBetTransactionLineItemNumber PBTLN
					INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
					INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 2
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate
				)FIN
				GROUP BY HostDrawDatesId, ActualDate;

		ELSIF v_ProdID = 3 --TOTO
		THEN
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT HostDrawDatesId,  ActualDate, SubProd, SUM(Wager) as Wager, SUM(SecondWager) as SecondWager, 
				SUM(SalesCommAmount) as SalesCommAmount, SUM(SalesFactorAmount) as SalesFactorAmount, 
				SUM(SecondSalesCommAmount) as SecondSalesCommAmount, SUM(SecondSalesFactorAmount) as SecondSalesFactorAmount
				FROM
				(
					SELECT PBTH.TranHeaderID, 
					DD.HostDrawDatesId,
					cast(BD.ActualDate as date) as ActualDate,
					CASE WHEN PBTL.bettypeid = ANY(v_tfogBettypes) THEN 'tfog' ELSE 't649' END as SubProd,
					SUM(coalesce(PBTL.BetPriceAmount,0)) / DDT.Ct AS Wager, --(2) calculate only placed ticket (not cancelled after)
					0 AS SecondWager,
					SUM(coalesce(PBTL.SalesCommAmount,0)) / DDT.Ct AS SalesCommAmount, --(1)--calculate only placed ticket (not cancelled after)
					SUM(coalesce(PBTL.SalesFactorAmount,0)) / DDT.Ct AS SalesFactorAmount, --(1)
					0 AS SecondSalesCommAmount, 
					0 AS SecondSalesFactorAmount
					FROM public.ztubt_toto_PlacedBetTransactionLineItem PBTL
					INNER JOIN public.ztubt_PlacedBetTransactionHeader PBTH ON PBTL.TranHeaderID = PBTH.TranHeaderID 
					INNER JOIN public.ztubt_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTL.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
					INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN (
					SELECT TranHeaderID, COUNT(TranHeaderID) AS Ct FROM ubt_temp_DrawDates DD --(1)
						GROUP BY TranHeaderID
					) DDT ON DDT.TranHeaderID = PBTL.TranHeaderID --(1)
					LEFT JOIN ubt_temp_BusinessDate BD ON PBTL.CreatedDate >= BD.PreviousPeriodDateTime  + interval '-8 hour' AND PBTL.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
					WHERE (PBTL.GroupUnitSequence is null or PBTL.GroupUnitSequence = 1) 
					AND PBTL.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTL.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
					AND PBTH.IsExchangeTicket =false
					AND PBTH.IsCancelled  = false
					AND PBTH.ProdID = 3
					GROUP BY PBTH.TranHeaderID, DD.HostDrawDatesId, BD.ActualDate, DDT.Ct,
						CASE WHEN PBTL.bettypeid = ANY(v_tfogBettypes) THEN 'tfog' ELSE 't649' END
				)FIN
				GROUP BY HostDrawDatesId, ActualDate, SubProd;

		ELSIf v_ProdID = 4 --SWEEP
		THEN
				--Insert wager only
				INSERT INTO ubt_temp_GetCFSUMReport
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 0, 0, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER join ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE 
				PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				and PBTH.IsCancelled = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

				--For Sweep PB03 IsPrint NULL (only for Sweep Consignee and Sweep Retailer locations)
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				SUM(coalesce(PBTLN.BetPriceAmount,0)) AS Wager, --(2) 
				0 AS SecondWager, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount,  
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount,
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB03'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >=BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				AND PBTLN.CreatedDate >=(v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				--AND PBTH.IsCancelled  = false
				AND PBTH.ProdID = 4
				AND PBTLN.IsSoldOut  = false
				GROUP BY DD.HostDrawDatesId, BD.ActualDate
			-- [2022-03-31] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation				
				--For Sweep Cancellation (only for Sweep Consignee and Sweep Retailer locations)	
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '',
				(0-SUM(coalesce(PBTLN.BetPriceAmount,0))) AS Wager,
				0 AS SecondWager, 
				(0-SUM(coalesce(PBTLN.SalesCommAmount,0))) AS SalesCommAmount,  
				(0-SUM(coalesce(PBTLN.SalesFactorAmount,0))) AS SalesFactorAmount, 0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem  PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztubt_cancelledbetticket CBT  ON PBTLN.TranHeaderID = CBT.TranHeaderID 
				INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0 --(9)
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID --AND Loc.IsDeleted = 0 --(9)
				--LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND CBT.CancelledDate < BD.PeriodDateTime + interval '-8 hour'
				LEFT JOIN ubt_temp_BusinessDate BD ON CBT.CancelledDate >= BD.PreviousPeriodDateTime  AND CBT.CancelledDate < BD.PeriodDateTime 
				WHERE IsPrinted IS NULL 
				AND Loc.SweepIndicator IS NOT NULL --Sweep Consignee and Sweep Retailer only
				--AND CBT.CancelledDate >= (v_MinSalesDatetime + interval '-8 hour') AND CBT.CancelledDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND CBT.CancelledDate >= v_MinSalesDatetime  AND CBT.CancelledDate < v_MaxSalesDatetime 
				AND CBT.ProdID = 4
				AND PBTLN.IsSoldOut  = false --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate

			-- [2022-03-31] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation			
				union all
				SELECT DD.HostDrawDatesId, cast(BD.ActualDate as date) as ActualDate, '', 0, 0, 
				SUM(coalesce(PBTLN.SalesCommAmount,0)) AS SalesCommAmount, --(2) 
				SUM(coalesce(PBTLN.SalesFactorAmount,0)) AS SalesFactorAmount, --(2) 
				0, 0
				FROM public.ztUBT_SWEEP_PlacedBetTransactionLineItemNumber PBTLN 
				INNER JOIN public.ztUBT_SWEEP_PlacedBetTransactionLineItem PBTL ON PBTLN.TranLineItemID = PBTL.TranLineItemID 
				INNER JOIN public.ztUBT_PlacedBetTransactionHeader PBTH ON PBTLN.TranHeaderID = PBTH.TranHeaderID  
				INNER JOIN public.ztUBT_PlacedBetTransactionHeaderLifeCycleState PBLC ON PBLC.TranHeaderID = PBTLN.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
				INNER JOIN ubt_temp_DrawDates DD ON DD.TranHeaderID = PBTLN.TranHeaderID --(1)
				INNER JOIN public.ztUBT_Terminal Ter ON PBTLN.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztUBT_Location Loc ON Ter.LocID = Loc.LocID 
				LEFT JOIN ubt_temp_BusinessDate BD ON PBTLN.CreatedDate >= BD.PreviousPeriodDateTime + interval '-8 hour' AND PBTLN.CreatedDate < BD.PeriodDateTime + interval '-8 hour'
				WHERE PBTLN.CreatedDate >= (v_MinSalesDatetime + interval '-8 hour') AND PBTLN.CreatedDate < (v_MaxSalesDatetime + interval '-8 hour')
				AND (Loc.SweepIndicator IS NULL OR PBTL.IsPrinted IS NOT NULL)
				AND cast(PBTH.IsCancelled as integer) = 0
				AND PBTH.ProdID = 4
				AND cast(PBTLN.IsSoldOut as integer) = 0 --(3)
				GROUP BY DD.HostDrawDatesId, BD.ActualDate;
		end if; 
	end if;
	
return query
	SELECT 
	HostDrawDatesId, ActualDate, SubProd,
	SUM(COALESCE(Wager,0))/100 AS Wager, --Convert big bet price amount from cents to dollar
	SUM(COALESCE(SecondWager,0))/100 AS SecondWager, --Convert small bet price amount from cents to dollar
	SUM(COALESCE(SalesFactorAmount,0))/100 AS SalesFactorAmount, --Convert from cents to dollar
	SUM(COALESCE(SecondSalesFactorAmount,0))/100 AS SecondSalesFactorAmount, --Convert from cents to dollar
	SUM(COALESCE(SalesCommAmount,0) + COALESCE(SecondSalesCommAmount,0))/100 AS SalesCommAmount, --Convert from cents to dollar
	case when b.drawStatus_canceld = 'T' then 1
	else 0
	end AS iscancelled
	FROM ubt_temp_GetCFSUMReport a
	LEFT JOIN (
	SELECT DISTINCT zp.drawnumber, zp.drawStatus_canceld
	FROM ztes_pdf_drawparam zp left join ztubt_sap_product zap on (zp.productnum = zap.sapprodid)
	WHERE zap.prodid = v_prodid and zp.drawcdc + DATE '19860511' <= DATE(v_drawcloseddate)
	) b 
	ON (a.HostDrawDatesId = b.drawnumber) 
	where actualdate is not null
	and HostDrawDatesId  in (select hostdrawdatesid from ubt_temp_ListOfHostDrawDatesID)
	GROUP BY HostDrawDatesId, ActualDate, b.drawStatus_canceld, SubProd;
		
--DROP TABLE IF EXISTS ubt_temp_DrawDates;	
--DROP TABLE IF EXISTS ubt_temp_ListOfHostDrawDatesID;
--DROP TABLE IF EXISTS ubt_temp_BusinessDate;
--DROP TABLE IF EXISTS ubt_temp_GetCFSUMReport;
--drop table if exists ubt_temp_dd_tran;

END;

$$;


ALTER FUNCTION public.sp_ubt_getcfsumreport_mt19(v_drawcloseddate date, v_prodid integer) OWNER TO sp_postgres;

--
-- TOC entry 1194 (class 1255 OID 24772)
-- Name: sp_ubt_getcommonubtdates(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getcommonubtdates(vfromdate timestamp without time zone, vtodate timestamp without time zone)
 RETURNS TABLE(inputfromdate timestamp without time zone, inputtodate timestamp without time zone, fromdatetimebmcs timestamp without time zone, todatetimebmcs timestamp without time zone, utcfromdatetimebmcs timestamp without time zone, utctodatetimebmcs timestamp without time zone, fromdatetimeigt timestamp without time zone, todatetimeigt timestamp without time zone, utcfromdatetimeigt timestamp without time zone, utctodatetimeigt timestamp without time zone, fromdatetimeob timestamp without time zone, todatetimeob timestamp without time zone, utcfromdatetimeob timestamp without time zone, utctodatetimeob timestamp without time zone, fromdatetimenonhost timestamp without time zone, todatetimenonhost timestamp without time zone, utcfromdatetimenonhost timestamp without time zone, utctodatetimenonhost timestamp without time zone, fromdatefund date, todatefund date)
    LANGUAGE plpgsql
    AS $$ 

begin

return Query
	with getInputDates as
	(select 
	 vFromDate as inFromDate, vToDate as inToDate
	)
	select infromdate,intodate
	,coalesce(fromdatebmcs,bmcs_adhoc_FromDate) as fromdatebmcs
	,coalesce(todatebmcs,bmcs_adhoc_ToDate) as todatebmcs
	,coalesce(fromdatebmcs,bmcs_adhoc_FromDate)-interval '8 hour' as UTCfromdatebmcs
	,coalesce(todatebmcs,bmcs_adhoc_ToDate)-interval '8 hour' as UTCtodatebmcs
	,coalesce(fromdateigt,igt_adhoc_FromDate) as fromdateigt
	,coalesce(todateigt,igt_adhoc_ToDate) as todateigt
	,coalesce(fromdateigt,igt_adhoc_FromDate)-interval '8 hour' as UTCfromdateigt
	,coalesce(todateigt,igt_adhoc_ToDate)-interval '8 hour' as UTCtodateigt
	,coalesce(fromdateob,ob_adhoc_FromDate) as fromdateob
	,coalesce(todateob,ob_adhoc_ToDate) as todateob
	,coalesce(fromdateob,ob_adhoc_FromDate)-interval '8 hour' as UTCfromdateob
	,coalesce(todateob,ob_adhoc_ToDate)-interval '8 hour' as UTCtodateob
	,coalesce(fromdatenonhost,nh_adhoc_FromDate) as fromdatenonhost
	,coalesce(todatenonhost,nh_adhoc_ToDate) as todatenonhost
	,coalesce(fromdatenonhost,nh_adhoc_FromDate)-interval '8 hour' as UTCfromdatenonhost
	,coalesce(todatenonhost,nh_adhoc_ToDate)-interval '8 hour' as UTCtodatenonhost
	,FundFromDate,FundToDate
	from (
	select  inFromDate, inToDate
		,(select za.perioddatetime from 
		getInputDates, public.ztubt_adhoctimehistory za , public.ztubt_lookupvalueconfig zl 
		where 1=1
		and za.host = cast(zl.fld1value as int)
		and zl.configname  ='RTMS_Host'
		and zl.fld2value = 'BMCS'
		and za.actualdate = cast(inFromDate as date) -1
		) fromDateBMCS 
		,(select za.perioddatetime from 
		getInputDates, public.ztubt_adhoctimehistory za , public.ztubt_lookupvalueconfig zl 
		where 1=1
		and za.host = cast(zl.fld1value as int)
		and zl.configname  ='RTMS_Host'
		and zl.fld2value = 'BMCS'
		and za.actualdate = cast(inToDate as date) 
		) toDateBMCS
		,(select za.perioddatetime from 
		getInputDates, public.ztubt_adhoctimehistory za , public.ztubt_lookupvalueconfig zl 
		where 1=1
		and za.host = cast(zl.fld1value as int)
		and zl.configname  ='RTMS_Host'
		and zl.fld2value = 'IGT'
		and za.actualdate = cast(inFromDate as date) -1
		) fromDateIGT
		,(select za.perioddatetime from 
		getInputDates, public.ztubt_adhoctimehistory za , public.ztubt_lookupvalueconfig zl 
		where 1=1
		and za.host = cast(zl.fld1value as int)
		and zl.configname  ='RTMS_Host'
		and zl.fld2value = 'IGT'
		and za.actualdate = cast(inToDate as date) 
		) toDateIGT
		,(select za.perioddatetime from 
		getInputDates, public.ztubt_adhoctimehistory za , public.ztubt_lookupvalueconfig zl 
		where 1=1
		and za.host = cast(zl.fld1value as int)
		and zl.configname  ='RTMS_Host'
		and zl.fld2value = 'OB'
		and za.actualdate = cast(inFromDate as date) -1
		) fromDateOB
		,(select za.perioddatetime from 
		getInputDates, public.ztubt_adhoctimehistory za , public.ztubt_lookupvalueconfig zl 
		where 1=1
		and za.host = cast(zl.fld1value as int)
		and zl.configname  ='RTMS_Host'
		and zl.fld2value = 'OB'
		and za.actualdate = cast(inToDate as date) 
		) toDateOB
		,(select max(za.perioddatetime) from 
		getInputDates, public.ztubt_adhoctimehistory za 
		where 1=1
		and za.actualdate = cast(inFromDate as date) -1
		) fromDateNonHost
		,(select max(za.perioddatetime) from 
		getInputDates, public.ztubt_adhoctimehistory za  
		where 1=1
		and za.actualdate = cast(inToDate as date) 
		) toDateNonHost
		,case when extract(dow from inFromDate) = 1 then infromdate::date + 4 
			  when extract(dow from inFromDate) = 5 then infromdate::date + 3 end as FundFromDate
		,case when extract(dow from inFromDate) = 1 then infromdate::date + 6 
			  when extract(dow from inFromDate) = 5 then infromdate::date + 6 end as FundToDate
	from getInputDates
	)sub_query1
	,(select 
	max(case when host =1 then adhoc_fromdate end) igt_adhoc_FromDate, 
	max(case when host =1 then adhoc_todate end) igt_adhoc_ToDate,
	max(case when host =2 then adhoc_fromdate end) bmcs_adhoc_FromDate, 
	max(case when host =2 then adhoc_todate end) bmcs_adhoc_ToDate,
	max(case when host =3 then adhoc_fromdate end) ob_adhoc_FromDate, 
	max(case when host =3 then adhoc_todate end) ob_adhoc_ToDate,
	min(adhoc_fromdate) nh_adhoc_FromDate,
	max(adhoc_todate) nh_adhoc_ToDate
	from (
	select 
	  host
	, adhoc_time 
	, case when left(adhoc_time,2)::int >= 24 
		then 
			cast(inToDate as date)
			+ cast(lpad(cast(left(adhoc_time,2)::int - 24 as text),2,'0') || right (adhoc_time,6) as time)
		else 
			cast(inToDate as date)+ adhoc_time::time
		end as adhoc_fromdate
	, case when left(adhoc_time,2)::int >= 24 
		then 
			cast(inToDate as date)+1
			+ cast(lpad(cast(left(adhoc_time,2)::int - 24 as text),2,'0') || right (adhoc_time,6) as time)
		else 
			cast(inToDate as date)+1 + adhoc_time::time
		end as adhoc_todate
	from (
	select host , coalesce(adhoctime,defaulttime) adhoc_time
	from public.ztubt_adhoctimeconfig za ) a, getInputDates
	)sq
	)subquery2
	;	
end;

$$;


ALTER FUNCTION public.sp_ubt_getcommonubtdates(vfromdate timestamp without time zone, vtodate timestamp without time zone) OWNER TO consultant01;

--
-- TOC entry 1132 (class 1255 OID 24773)
-- Name: sp_ubt_getdailyretsummarybychainreport(date, date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getdailyretsummarybychainreport(in_fromdatetime date, in_todatetime date) RETURNS TABLE(typeid character varying, id character varying, productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare
	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));
	v_totofo_prodId_temp INTEGER := 1000; --temp value for mapping in this SP

begin

	create temporary table ubt_temp_trans_amt_detail(
				 terdisplayid varchar(50)
 				,prodname varchar(50)
 				,flag char(3)
 				,amount numeric
 				,ticketcount int4
 				,actualDate date);
	
 	insert into ubt_temp_trans_amt_detail
 		select terdisplayid,prodname,flag,amount,ticketcount,actualdate
--  07-Apr-2022: Hira - removed sp_ubt_gettransamountdetails with subset sp_ubt_gtad_DR_SummaryByChain
-- 		from public.sp_ubt_gettransamountdetails(in_fromDateTime,in_toDateTime);
 		from public.sp_ubt_gtad_DR_SummaryByChain(in_fromDateTime,in_toDateTime);
 	
 	create temporary table ubt_temp_ResultTAD(
					 terdisplayid varchar(50)
	 				,prodname varchar(50)
	 				,flag char(3)
	 				,amount numeric
	 				,ticketcount int4
	 				,actualDate date);
 	
 	-- collection - cancellation
	insert into ubt_temp_ResultTAD
		select tad.terdisplayid,trim(tad.prodname),tad.flag
		,tad.amount-coalesce(can.amount,0) amount
		,tad.ticketcount,tad.actualdate
		from ubt_temp_trans_amt_detail tad
		inner join
		(select terdisplayid,prodname,flag,amount*-1 amount from ubt_temp_trans_amt_detail where 1=1
		 	and flag = 'CAN' and prodname <> 'Offline Orders' )can
		on (tad.terdisplayid=can.terdisplayid and trim(tad.prodname)=trim(can.prodname) )
		where 1=1
		and tad.flag = 'COL' and tad.prodname <> 'Offline Orders'
		;
	
	create temporary table if not exists ubt_temp_ter_prod
	(
	 terDisplayID varchar(50)
	,prodid int4 
	,prodname  varchar(100)
	);

	insert into ubt_temp_ter_prod
	select terdisplayid, zp.prodid, zp.prodname
	from ztubt_terminal zt
	cross join (
	    SELECT zp.prodid, case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid in (1,2,3,4,5)
    	UNION ALL
    	select v_totofo_prodId_temp as prodid, 'TOTO MATCH' AS prodname
	) zp;

	create temporary table if not exists ubt_temp_gat
				(TicketSerialNumber VARCHAR(500),
				Wager NUMERIC(22,2),
				SecondWager NUMERIC(22,2), 
				Sales NUMERIC(22, 11),
				SecondSales NUMERIC(22, 11),
				SalesComm NUMERIC(22, 11),
				SecondSalesComm NUMERIC(22, 11),
				GST NUMERIC(22, 11),
				SecondGST NUMERIC(22, 11),
				ReturnAmount NUMERIC(22,2),
				WinningAmount NUMERIC(22,2));
			
	insert into ubt_temp_gat
		select * from public.sp_ubt_getAmountTransaction(in_fromDateTime, in_fromDateTime);
	
	create temporary table if not exists ubt_temp_ResultSales
	(
	 terDisplayID varchar(50)
	,prodname  varchar(100)
	,SalesAmount numeric(22,10)
	);
	
	insert into ubt_temp_ResultSales
		select tp.terdisplayid
		, trim(tp.prodname)
		, round(trunc(sum(coalesce(sales,0))/100,2),2) salesAmount
		from ubt_temp_ter_prod tp left outer join(
		select gat.ticketserialnumber, zp.terdisplayid
		, case
		    when zp.prodid in (5,6) then 5
		    when zp.prodid = 3 and EXISTS (
		        select 1 
		        from ztubt_toto_placedbettransactionlineitem pbtlin
		        where zp.TranHeaderID = pbtlin.TranHeaderID
		          and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		    ) then v_totofo_prodId_temp
		    else zp.prodid 
		end as prodid
		, sum(case when zp.iscancelled = false then gat.sales+gat.secondsales else 0 end) sales
		from ubt_temp_gat gat
		inner join ztubt_placedbettransactionheader zp 
		on (gat.ticketserialnumber = zp.ticketserialnumber)
		group by gat.ticketserialnumber, zp.terdisplayid 
		, case 
		    when zp.prodid in (5,6) then 5 
		    when zp.prodid = 3 and EXISTS (
		        select 1 
		        from ztubt_toto_placedbettransactionlineitem pbtlin
		        where zp.TranHeaderID = pbtlin.TranHeaderID
		          and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		    ) then v_totofo_prodId_temp
		    else zp.prodid 
		end
		) sq_gat
		on (sq_gat.terdisplayid=tp.terdisplayid and sq_gat.prodid=tp.prodid)
		group by tp.terdisplayid, tp.prodname;
	
	-- [2022-04-05] Hira: Start handling for Sweep Consignee and Sweep Retailer Cancellation

	create Temp TABLE ubt_temp_Sales_SCandSR 
	(
		TerDisplayID varchar(200),
		ProdID integer,
		ProductName varchar(100),
		ActualDate Date,
		TotalCount numeric,
		Amount numeric
	);
	
	Insert Into ubt_temp_Sales_SCandSR
	select terdisplayid,prodid,prodname as ProductName,actualdate::Date,totalcount,amount 
	from public.sp_ubt_getSweepSalesPerSRTerminal(in_fromDateTime,in_toDateTime)
	where 1=1;
	
	DELETE FROM ubt_temp_ResultSales SAL using ubt_temp_Sales_SCandSR RS 
	where RS.TerDisplayID = SAL.TerDisplayID AND RS.ProductName = SAL.prodname;
	
	INSERT INTO ubt_temp_ResultSales
	SELECT TerDisplayID, ProductName,  ROUND (trunc(SUM(coalesce(Amount,0)) , 2),2) as Amount 
	FROM ubt_temp_Sales_SCandSR RS
	GROUP BY TerDisplayID, ProductName;
	
	-- [2022-04-05] Hira: End handling for Sweep Consignee and Sweep Retailer Cancellation
	
	return query
		select cast(TypeID as varchar(10)) TypeID, ID
		, case 
			when ProdName='TOTO' then '1TOTO'
			when ProdName='TOTO MATCH' then '1TOTO MATCH'
			when trim(ProdName)='4D Lottery' then '24D Lottery'
			when ProdName='SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
			when ProdName='SPORTS' then '4SPORTS'
			when ProdName='HORSE RACING' then '5HORSE RACING' 
			else prodname end prodname
		, amount, cast(flag as varchar(50)) flag 
		from (
			select 
			 '0CHN' TypeID
			,zc.chname ID
			,sal.prodname
			,sum(sal.salesAmount) amount
			,'0Amount of Sales' flag
			from ubt_temp_ResultSales sal
			inner join ztubt_terminal zt on (sal.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			inner join ztubt_chain zc on (zl.chid=zc.chid)
			where 1=1
			and zl.loctypeid in (1,2)
			group by zc.chname ,sal.prodname
			
			union all
			
			select 
			 '1RET' TypeID
			,'All Retailers (Exclude SC + SR)' ID
			,sal.prodname
			,sum(sal.salesAmount) amount
			,'0Amount of Sales' flag
			from ubt_temp_ResultSales sal
			inner join ztubt_terminal zt on (sal.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			where 1=1
			and zl.loctypeid in (2,4)
			and zl.sweepindicator is null
			group by sal.prodname
			
			union all 
			
			select 
			 '0CHN' TypeID
			,zc.chname ID
			,tad.prodname
			,sum(tad.amount - sal.salesAmount) amount
			,'1Amount of GST' flag
			from ubt_temp_ResultTAD tad
			inner join ubt_temp_ResultSales sal on (tad.terdisplayid=sal.terdisplayid and trim(tad.prodname)=trim(sal.prodname))
			inner join ztubt_terminal zt on (tad.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			inner join ztubt_chain zc on (zl.chid=zc.chid)
			where 1=1
			and zl.loctypeid in (1,2)
			group by zc.chname ,tad.prodname
			
			union all 
			
			select 
			 '1RET' TypeID
			,'All Retailers (Exclude SC + SR)' ID
			,tad.prodname
			,sum(tad.amount - sal.salesAmount) amount
			,'1Amount of GST' flag
			from ubt_temp_ResultTAD tad
			inner join ubt_temp_ResultSales sal on (tad.terdisplayid=sal.terdisplayid and trim(tad.prodname)=trim(sal.prodname))
			inner join ztubt_terminal zt on (tad.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			where 1=1
			and zl.loctypeid in (2,4)
			and zl.sweepindicator is null
			group by tad.prodname
		)main
		;
		
drop table ubt_temp_trans_amt_detail; 
drop table ubt_temp_ResultTAD;
drop table ubt_temp_gat;
drop table ubt_temp_ter_prod; 	
drop table ubt_temp_ResultSales;
drop table ubt_temp_Sales_SCandSR;

end;
$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummarybychainreport(in_fromdatetime date, in_todatetime date) OWNER TO consultant01;

--
-- TOC entry 1133 (class 1255 OID 2005624)
-- Name: sp_ubt_getdailyretsummarybychainreport_bk20241010(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getdailyretsummarybychainreport_bk20241010(in_fromdatetime date, in_todatetime date) RETURNS TABLE(typeid character varying, id character varying, productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin

	create temporary table ubt_temp_trans_amt_detail(
				 terdisplayid varchar(50)
 				,prodname varchar(50)
 				,flag char(3)
 				,amount numeric
 				,ticketcount int4
 				,actualDate date);
	
 	insert into ubt_temp_trans_amt_detail
 		select terdisplayid,prodname,flag,amount,ticketcount,actualdate
--  07-Apr-2022: Hira - removed sp_ubt_gettransamountdetails with subset sp_ubt_gtad_DR_SummaryByChain
-- 		from public.sp_ubt_gettransamountdetails(in_fromDateTime,in_toDateTime);
 		from public.sp_ubt_gtad_DR_SummaryByChain(in_fromDateTime,in_toDateTime);
 	
 	create temporary table ubt_temp_ResultTAD(
					 terdisplayid varchar(50)
	 				,prodname varchar(50)
	 				,flag char(3)
	 				,amount numeric
	 				,ticketcount int4
	 				,actualDate date);
 	
 	-- collection - cancellation
	insert into ubt_temp_ResultTAD
		select tad.terdisplayid,trim(tad.prodname),tad.flag
		,tad.amount-coalesce(can.amount,0) amount
		,tad.ticketcount,tad.actualdate
		from ubt_temp_trans_amt_detail tad
		inner join
		(select terdisplayid,prodname,flag,amount*-1 amount from ubt_temp_trans_amt_detail where 1=1
		 	and flag = 'CAN' and prodname <> 'Offline Orders' )can
		on (tad.terdisplayid=can.terdisplayid and trim(tad.prodname)=trim(can.prodname) )
		where 1=1
		and tad.flag = 'COL' and tad.prodname <> 'Offline Orders'
		;
	
	create temporary table if not exists ubt_temp_ter_prod
	(
	 terDisplayID varchar(50)
	,prodid int4 
	,prodname  varchar(100)
	);

	insert into ubt_temp_ter_prod
	select terdisplayid,zp.prodid 
	,case when zp.prodid =5 then 'SPORTS' else zp.prodname end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temporary table if not exists ubt_temp_gat
				(TicketSerialNumber VARCHAR(500),
				Wager NUMERIC(22,2),
				SecondWager NUMERIC(22,2), 
				Sales NUMERIC(22, 11),
				SecondSales NUMERIC(22, 11),
				SalesComm NUMERIC(22, 11),
				SecondSalesComm NUMERIC(22, 11),
				GST NUMERIC(22, 11),
				SecondGST NUMERIC(22, 11),
				ReturnAmount NUMERIC(22,2),
				WinningAmount NUMERIC(22,2));
			
	insert into ubt_temp_gat
		select * from public.sp_ubt_getAmountTransaction(in_fromDateTime, in_fromDateTime);
	
	create temporary table if not exists ubt_temp_ResultSales
	(
	 terDisplayID varchar(50)
	,prodname  varchar(100)
	,SalesAmount numeric(22,10)
	);
	
	insert into ubt_temp_ResultSales
		select tp.terdisplayid
		, trim(tp.prodname)
		, round(trunc(sum(coalesce(sales,0))/100,2),2) salesAmount
		from ubt_temp_ter_prod tp left outer join(
		select gat.ticketserialnumber, zp.terdisplayid 
		, case when zp.prodid in (5,6) then 5 else zp.prodid end as prodid 
		, sum(case when zp.iscancelled = false then gat.sales+gat.secondsales else 0 end) sales
		from ubt_temp_gat gat
		inner join ztubt_placedbettransactionheader zp 
		on (gat.ticketserialnumber = zp.ticketserialnumber)
		group by gat.ticketserialnumber, zp.terdisplayid 
		, case when zp.prodid in (5,6) then 5 else zp.prodid end)sq_gat
		on (sq_gat.terdisplayid=tp.terdisplayid and sq_gat.prodid=tp.prodid)
		group by tp.terdisplayid, tp.prodname;
	
	-- [2022-04-05] Hira: Start handling for Sweep Consignee and Sweep Retailer Cancellation

	create Temp TABLE ubt_temp_Sales_SCandSR 
	(
		TerDisplayID varchar(200),
		ProdID integer,
		ProductName varchar(100),
		ActualDate Date,
		TotalCount numeric,
		Amount numeric
	);
	
	Insert Into ubt_temp_Sales_SCandSR
	select terdisplayid,prodid,prodname as ProductName,actualdate::Date,totalcount,amount 
	from public.sp_ubt_getSweepSalesPerSRTerminal(in_fromDateTime,in_toDateTime)
	where 1=1;
	
	DELETE FROM ubt_temp_ResultSales SAL using ubt_temp_Sales_SCandSR RS 
	where RS.TerDisplayID = SAL.TerDisplayID AND RS.ProductName = SAL.prodname;
	
	INSERT INTO ubt_temp_ResultSales
	SELECT TerDisplayID, ProductName,  ROUND (trunc(SUM(coalesce(Amount,0)) , 2),2) as Amount 
	FROM ubt_temp_Sales_SCandSR RS
	GROUP BY TerDisplayID, ProductName;
	
	-- [2022-04-05] Hira: End handling for Sweep Consignee and Sweep Retailer Cancellation
	
	return query
		select cast(TypeID as varchar(10)) TypeID, ID
		, case 
			when ProdName='TOTO' then '1TOTO'
			when trim(ProdName)='4D Lottery' then '24D Lottery'
			when ProdName='SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
			when ProdName='SPORTS' then '4SPORTS'
			when ProdName='HORSE RACING' then '5HORSE RACING' 
			else prodname end prodname
		, amount, cast(flag as varchar(50)) flag 
		from (
			select 
			 '0CHN' TypeID
			,zc.chname ID
			,sal.prodname
			,sum(sal.salesAmount) amount
			,'0Amount of Sales' flag
			from ubt_temp_ResultSales sal
			inner join ztubt_terminal zt on (sal.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			inner join ztubt_chain zc on (zl.chid=zc.chid)
			where 1=1
			and zl.loctypeid in (1,2)
			group by zc.chname ,sal.prodname
			
			union all
			
			select 
			 '1RET' TypeID
			,'All Retailers (Exclude SC + SR)' ID
			,sal.prodname
			,sum(sal.salesAmount) amount
			,'0Amount of Sales' flag
			from ubt_temp_ResultSales sal
			inner join ztubt_terminal zt on (sal.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			where 1=1
			and zl.loctypeid in (2,4)
			and zl.sweepindicator is null
			group by sal.prodname
			
			union all 
			
			select 
			 '0CHN' TypeID
			,zc.chname ID
			,tad.prodname
			,sum(tad.amount - sal.salesAmount) amount
			,'1Amount of GST' flag
			from ubt_temp_ResultTAD tad
			inner join ubt_temp_ResultSales sal on (tad.terdisplayid=sal.terdisplayid and trim(tad.prodname)=trim(sal.prodname))
			inner join ztubt_terminal zt on (tad.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			inner join ztubt_chain zc on (zl.chid=zc.chid)
			where 1=1
			and zl.loctypeid in (1,2)
			group by zc.chname ,tad.prodname
			
			union all 
			
			select 
			 '1RET' TypeID
			,'All Retailers (Exclude SC + SR)' ID
			,tad.prodname
			,sum(tad.amount - sal.salesAmount) amount
			,'1Amount of GST' flag
			from ubt_temp_ResultTAD tad
			inner join ubt_temp_ResultSales sal on (tad.terdisplayid=sal.terdisplayid and trim(tad.prodname)=trim(sal.prodname))
			inner join ztubt_terminal zt on (tad.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			where 1=1
			and zl.loctypeid in (2,4)
			and zl.sweepindicator is null
			group by tad.prodname
		)main
		;
		
drop table ubt_temp_trans_amt_detail; 
drop table ubt_temp_ResultTAD;
drop table ubt_temp_gat;
drop table ubt_temp_ter_prod; 	
drop table ubt_temp_ResultSales;
drop table ubt_temp_Sales_SCandSR;

end;
$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummarybychainreport_bk20241010(in_fromdatetime date, in_todatetime date) OWNER TO sp_postgres;

--
-- TOC entry 1127 (class 1255 OID 24776)
-- Name: sp_ubt_getdailyretsummarybychainreport_bkp_050422(date, date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getdailyretsummarybychainreport_bkp_050422(in_fromdatetime date, in_todatetime date) RETURNS TABLE(typeid character varying, id character varying, productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin

	create temporary table ubt_temp_trans_amt_detail(
				 terdisplayid varchar(50)
 				,prodname varchar(50)
 				,flag char(3)
 				,amount numeric
 				,ticketcount int4
 				,actualDate date);
	
 	insert into ubt_temp_trans_amt_detail
 		select terdisplayid,prodname,flag,amount,ticketcount,actualdate
 		from public.sp_ubt_getTransAmountDetails(in_fromDateTime,in_toDateTime);
 	
 	create temporary table ubt_temp_ResultTAD(
					 terdisplayid varchar(50)
	 				,prodname varchar(50)
	 				,flag char(3)
	 				,amount numeric
	 				,ticketcount int4
	 				,actualDate date);
 	
 	-- collection - cancellation
	insert into ubt_temp_ResultTAD
		select tad.terdisplayid,trim(tad.prodname),tad.flag
		,tad.amount-coalesce(can.amount,0) amount
		,tad.ticketcount,tad.actualdate
		from ubt_temp_trans_amt_detail tad
		inner join
		(select terdisplayid,prodname,flag,amount*-1 amount from ubt_temp_trans_amt_detail where 1=1
		 	and flag = 'CAN' and prodname <> 'Offline Orders' )can
		on (tad.terdisplayid=can.terdisplayid and trim(tad.prodname)=trim(can.prodname) )
		where 1=1
		and tad.flag = 'COL' and tad.prodname <> 'Offline Orders'
		;
	
	create temporary table if not exists ubt_temp_ter_prod
	(
	 terDisplayID varchar(50)
	,prodid int4 
	,prodname  varchar(100)
	);

	insert into ubt_temp_ter_prod
	select terdisplayid,zp.prodid 
	,case when zp.prodid =5 then 'SPORTS' else zp.prodname end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temporary table if not exists ubt_temp_gat
				(TicketSerialNumber VARCHAR(500),
				Wager NUMERIC(22,2),
				SecondWager NUMERIC(22,2), 
				Sales NUMERIC(22, 11),
				SecondSales NUMERIC(22, 11),
				SalesComm NUMERIC(22, 11),
				SecondSalesComm NUMERIC(22, 11),
				GST NUMERIC(22, 11),
				SecondGST NUMERIC(22, 11),
				ReturnAmount NUMERIC(22,2),
				WinningAmount NUMERIC(22,2));
			
	insert into ubt_temp_gat
		select * from public.sp_ubt_getAmountTransaction(in_fromDateTime, in_fromDateTime);
	
	create temporary table if not exists ubt_temp_ResultSales
	(
	 terDisplayID varchar(50)
	,prodname  varchar(100)
	,SalesAmount numeric(22,10)
	);
	
	insert into ubt_temp_ResultSales
		select tp.terdisplayid
		, trim(tp.prodname)
		, round(trunc(sum(coalesce(sales,0))/100,2),2) salesAmount
		from ubt_temp_ter_prod tp left outer join(
		select gat.ticketserialnumber, zp.terdisplayid 
		, case when zp.prodid in (5,6) then 5 else zp.prodid end as prodid 
		, sum(case when zp.iscancelled = false then gat.sales+gat.secondsales else 0 end) sales
		from ubt_temp_gat gat
		inner join ztubt_placedbettransactionheader zp 
		on (gat.ticketserialnumber = zp.ticketserialnumber)
		group by gat.ticketserialnumber, zp.terdisplayid 
		, case when zp.prodid in (5,6) then 5 else zp.prodid end)sq_gat
		on (sq_gat.terdisplayid=tp.terdisplayid and sq_gat.prodid=tp.prodid)
		group by tp.terdisplayid, tp.prodname;
	
	
	return query
		select cast(TypeID as varchar(10)) TypeID, ID
		, case 
			when ProdName='TOTO' then '1TOTO'
			when trim(ProdName)='4D Lottery' then '24D Lottery'
			when ProdName='SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
			when ProdName='SPORTS' then '4SPORTS'
			when ProdName='HORSE RACING' then '5HORSE RACING' 
			else prodname end prodname
		, amount, cast(flag as varchar(50)) flag 
		from (
			select 
			 '0CHN' TypeID
			,zc.chname ID
			,sal.prodname
			,sum(sal.salesAmount) amount
			,'0Amount of Sales' flag
			from ubt_temp_ResultSales sal
			inner join ztubt_terminal zt on (sal.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			inner join ztubt_chain zc on (zl.chid=zc.chid)
			where 1=1
			and zl.loctypeid in (1,2)
			group by zc.chname ,sal.prodname
			
			union all
			
			select 
			 '1RET' TypeID
			,'All Retailers (Exclude SC + SR)' ID
			,sal.prodname
			,sum(sal.salesAmount) amount
			,'0Amount of Sales' flag
			from ubt_temp_ResultSales sal
			inner join ztubt_terminal zt on (sal.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			where 1=1
			and zl.loctypeid in (2,4)
			and zl.sweepindicator is null
			group by sal.prodname
			
			union all 
			
			select 
			 '0CHN' TypeID
			,zc.chname ID
			,tad.prodname
			,sum(tad.amount - sal.salesAmount) amount
			,'1Amount of GST' flag
			from ubt_temp_ResultTAD tad
			inner join ubt_temp_ResultSales sal on (tad.terdisplayid=sal.terdisplayid and trim(tad.prodname)=trim(sal.prodname))
			inner join ztubt_terminal zt on (tad.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			inner join ztubt_chain zc on (zl.chid=zc.chid)
			where 1=1
			and zl.loctypeid in (1,2)
			group by zc.chname ,tad.prodname
			
			union all 
			
			select 
			 '1RET' TypeID
			,'All Retailers (Exclude SC + SR)' ID
			,tad.prodname
			,sum(tad.amount - sal.salesAmount) amount
			,'1Amount of GST' flag
			from ubt_temp_ResultTAD tad
			inner join ubt_temp_ResultSales sal on (tad.terdisplayid=sal.terdisplayid and trim(tad.prodname)=trim(sal.prodname))
			inner join ztubt_terminal zt on (tad.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			where 1=1
			and zl.loctypeid in (2,4)
			and zl.sweepindicator is null
			group by tad.prodname
		)main
		;
		
drop table ubt_temp_trans_amt_detail; 
drop table ubt_temp_ResultTAD;
drop table ubt_temp_gat;
drop table ubt_temp_ter_prod; 	
drop table ubt_temp_ResultSales;

end;
$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummarybychainreport_bkp_050422(in_fromdatetime date, in_todatetime date) OWNER TO consultant01;

--
-- TOC entry 1267 (class 1255 OID 2030150)
-- Name: sp_ubt_getdailyretsummarybychainreport_testorg(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getdailyretsummarybychainreport_testorg(in_fromdatetime date, in_todatetime date) RETURNS TABLE(typeid character varying, id character varying, productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin

	create temporary table ubt_temp_trans_amt_detail(
				 terdisplayid varchar(50)
 				,prodname varchar(50)
 				,flag char(3)
 				,amount numeric
 				,ticketcount int4
 				,actualDate date);
	
 	insert into ubt_temp_trans_amt_detail
 		select terdisplayid,prodname,flag,amount,ticketcount,actualdate
--  07-Apr-2022: Hira - removed sp_ubt_gettransamountdetails with subset sp_ubt_gtad_DR_SummaryByChain
-- 		from public.sp_ubt_gettransamountdetails(in_fromDateTime,in_toDateTime);
 		from public.sp_ubt_gtad_DR_SummaryByChain_testorg(in_fromDateTime,in_toDateTime);
 	
 	create temporary table ubt_temp_ResultTAD(
					 terdisplayid varchar(50)
	 				,prodname varchar(50)
	 				,flag char(3)
	 				,amount numeric
	 				,ticketcount int4
	 				,actualDate date);
 	
 	-- collection - cancellation
	insert into ubt_temp_ResultTAD
		select tad.terdisplayid,trim(tad.prodname),tad.flag
		,tad.amount-coalesce(can.amount,0) amount
		,tad.ticketcount,tad.actualdate
		from ubt_temp_trans_amt_detail tad
		inner join
		(select terdisplayid,prodname,flag,amount*-1 amount from ubt_temp_trans_amt_detail where 1=1
		 	and flag = 'CAN' and prodname <> 'Offline Orders' )can
		on (tad.terdisplayid=can.terdisplayid and trim(tad.prodname)=trim(can.prodname) )
		where 1=1
		and tad.flag = 'COL' and tad.prodname <> 'Offline Orders'
		;
	
	create temporary table if not exists ubt_temp_ter_prod
	(
	 terDisplayID varchar(50)
	,prodid int4 
	,prodname  varchar(100)
	);

	insert into ubt_temp_ter_prod
	select terdisplayid,zp.prodid 
	,case when zp.prodid =5 then 'SPORTS' else zp.prodname end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temporary table if not exists ubt_temp_gat
				(TicketSerialNumber VARCHAR(500),
				Wager NUMERIC(22,2),
				SecondWager NUMERIC(22,2), 
				Sales NUMERIC(22, 11),
				SecondSales NUMERIC(22, 11),
				SalesComm NUMERIC(22, 11),
				SecondSalesComm NUMERIC(22, 11),
				GST NUMERIC(22, 11),
				SecondGST NUMERIC(22, 11),
				ReturnAmount NUMERIC(22,2),
				WinningAmount NUMERIC(22,2));
			
	insert into ubt_temp_gat
		select * from public.sp_ubt_getAmountTransaction(in_fromDateTime, in_fromDateTime);
	
	create temporary table if not exists ubt_temp_ResultSales
	(
	 terDisplayID varchar(50)
	,prodname  varchar(100)
	,SalesAmount numeric(22,10)
	);
	
	insert into ubt_temp_ResultSales
		select tp.terdisplayid
		, trim(tp.prodname)
		, round(trunc(sum(coalesce(sales,0))/100,2),2) salesAmount
		from ubt_temp_ter_prod tp left outer join(
		select gat.ticketserialnumber, zp.terdisplayid 
		, case when zp.prodid in (5,6) then 5 else zp.prodid end as prodid 
		, sum(case when zp.iscancelled = false then gat.sales+gat.secondsales else 0 end) sales
		from ubt_temp_gat gat
		inner join ztubt_placedbettransactionheader zp 
		on (gat.ticketserialnumber = zp.ticketserialnumber)
		group by gat.ticketserialnumber, zp.terdisplayid 
		, case when zp.prodid in (5,6) then 5 else zp.prodid end)sq_gat
		on (sq_gat.terdisplayid=tp.terdisplayid and sq_gat.prodid=tp.prodid)
		group by tp.terdisplayid, tp.prodname;
	
	-- [2022-04-05] Hira: Start handling for Sweep Consignee and Sweep Retailer Cancellation

	create Temp TABLE ubt_temp_Sales_SCandSR 
	(
		TerDisplayID varchar(200),
		ProdID integer,
		ProductName varchar(100),
		ActualDate Date,
		TotalCount numeric,
		Amount numeric
	);
	
	Insert Into ubt_temp_Sales_SCandSR
	select terdisplayid,prodid,prodname as ProductName,actualdate::Date,totalcount,amount 
	from public.sp_ubt_getSweepSalesPerSRTerminal(in_fromDateTime,in_toDateTime)
	where 1=1;
	
	DELETE FROM ubt_temp_ResultSales SAL using ubt_temp_Sales_SCandSR RS 
	where RS.TerDisplayID = SAL.TerDisplayID AND RS.ProductName = SAL.prodname;
	
	INSERT INTO ubt_temp_ResultSales
	SELECT TerDisplayID, ProductName,  ROUND (trunc(SUM(coalesce(Amount,0)) , 2),2) as Amount 
	FROM ubt_temp_Sales_SCandSR RS
	GROUP BY TerDisplayID, ProductName;
	
	-- [2022-04-05] Hira: End handling for Sweep Consignee and Sweep Retailer Cancellation
	
	return query
		select cast(TypeID as varchar(10)) TypeID, ID
		, case 
			when ProdName='TOTO' then '1TOTO'
			when trim(ProdName)='4D Lottery' then '24D Lottery'
			when ProdName='SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
			when ProdName='SPORTS' then '4SPORTS'
			when ProdName='HORSE RACING' then '5HORSE RACING' 
			else prodname end prodname
		, amount, cast(flag as varchar(50)) flag 
		from (
			select 
			 '0CHN' TypeID
			,zc.chname ID
			,sal.prodname
			,sum(sal.salesAmount) amount
			,'0Amount of Sales' flag
			from ubt_temp_ResultSales sal
			inner join ztubt_terminal zt on (sal.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			inner join ztubt_chain zc on (zl.chid=zc.chid)
			where 1=1
			and zl.loctypeid in (1,2)
			group by zc.chname ,sal.prodname
			
			union all
			
			select 
			 '1RET' TypeID
			,'All Retailers (Exclude SC + SR)' ID
			,sal.prodname
			,sum(sal.salesAmount) amount
			,'0Amount of Sales' flag
			from ubt_temp_ResultSales sal
			inner join ztubt_terminal zt on (sal.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			where 1=1
			and zl.loctypeid in (2,4)
			and zl.sweepindicator is null
			group by sal.prodname
			
			union all 
			
			select 
			 '0CHN' TypeID
			,zc.chname ID
			,tad.prodname
			,sum(tad.amount - sal.salesAmount) amount
			,'1Amount of GST' flag
			from ubt_temp_ResultTAD tad
			inner join ubt_temp_ResultSales sal on (tad.terdisplayid=sal.terdisplayid and trim(tad.prodname)=trim(sal.prodname))
			inner join ztubt_terminal zt on (tad.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			inner join ztubt_chain zc on (zl.chid=zc.chid)
			where 1=1
			and zl.loctypeid in (1,2)
			group by zc.chname ,tad.prodname
			
			union all 
			
			select 
			 '1RET' TypeID
			,'All Retailers (Exclude SC + SR)' ID
			,tad.prodname
			,sum(tad.amount - sal.salesAmount) amount
			,'1Amount of GST' flag
			from ubt_temp_ResultTAD tad
			inner join ubt_temp_ResultSales sal on (tad.terdisplayid=sal.terdisplayid and trim(tad.prodname)=trim(sal.prodname))
			inner join ztubt_terminal zt on (tad.terdisplayid=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
			where 1=1
			and zl.loctypeid in (2,4)
			and zl.sweepindicator is null
			group by tad.prodname
		)main
		;
		
drop table ubt_temp_trans_amt_detail; 
drop table ubt_temp_ResultTAD;
drop table ubt_temp_gat;
drop table ubt_temp_ter_prod; 	
drop table ubt_temp_ResultSales;
drop table ubt_temp_Sales_SCandSR;

end;
$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummarybychainreport_testorg(in_fromdatetime date, in_todatetime date) OWNER TO sp_postgres;

--
-- TOC entry 1207 (class 1255 OID 2380388)
-- Name: sp_ubt_getdailyretsummaryreport(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getdailyretsummaryreport(infromdate date, intodate date) RETURNS TABLE(productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin
	
	create temporary table if not exists ubt_temp_dailyretsummary
			(ProdName varchar(100),
			 Amt numeric,
			 Flg varchar(50));
			
	insert into ubt_temp_dailyretsummary
		select 
		  prodname as ProductName
		, sum(amount) as Amt
		, flag as flg
		from public.sp_ubt_getTransAmountDetails(inFromDate,inToDate)
		where 1=1
		and flag <> 'GST'
		and (flag = 'COL' or flag = 'CAN' OR flag = 'RFD' OR flag = 'SAL' 
			OR flag = 'PAY' OR flag = 'RBT' OR flag = 'CAS')
		group by prodname, flag;

	
	/* Update offline orders */
	UPDATE ubt_temp_dailyretsummary a
	SET Amt = a.Amt - COALESCE(b.Amt, 0)
	FROM (
		select flg, Amt
		from ubt_temp_dailyretsummary
		where ProdName = 'Gate Admission' and Amt <> 0
	) b
	WHERE a.flg = b.flg 
	AND a.ProdName = 'Offline Orders' AND a.Amt <> 0;

	return query
	select 
		  case 
		  	when ProdName = 'TOTO' then '1TOTO'
		  	when ProdName = 'TOTO MATCH' then '1TOTO MATCH'
		  	when ProdName in (' 4D Lottery','4D Lottery') then '24D Lottery'
		  	when ProdName = 'SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
		  	when ProdName = 'SPORTS' then '4SPORTS'
		  	when ProdName = 'HORSE RACING' then '5HORSE RACING'
		  	when ProdName = 'Offline Orders' then '6Offline Orders'
	  		when ProdName = 'Gate Admission' then '7Gate Admission'
		  	when ProdName = 'NETS' then '2NETS'
		  	when ProdName = 'CASHCARD/Flashpay' then '3CASHCARD/Flashpay'
			when ProdName = 'PaynowQR [+trans fee]' then '4PaynowQR [+trans fee]'
			when ProdName = 'Paynow [+trans fee]' then '5Paynow [+trans fee]'
			when ProdName = 'PaynowQR' then '6PaynowQR'
			when ProdName = 'Paynow' then '7Paynow'
		  	else ProdName end as prodname
		, Amt
		, case 
			when flg = 'COL' then '0Amount of Wagers'
			when flg = 'CAN' then '1Amount of Cancels'
			when flg = 'RFD' then '2Amount of Actual Refund'
			when flg = 'RBT' then '3Amount of Rebates'
			when flg = 'PAY' then '4Amount of Win Paid'
			when flg = 'SAL' then '5Amount of Sales Commission'
			when flg = 'CAS' then '6Amount Due'
			else flg end as flag
		from ubt_temp_dailyretsummary
	union all
	select '1Total' prodname
		, sum(Amt) as Amt
		, '6Amount Due' as Flg
		from ubt_temp_dailyretsummary
		where flg <> 'CAS';


drop table ubt_temp_dailyretsummary;
	
end;

$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummaryreport(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1196 (class 1255 OID 24779)
-- Name: sp_ubt_getdailyretsummaryreport_bk20240314(date, date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getdailyretsummaryreport_bk20240314(infromdate date, intodate date) RETURNS TABLE(productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin
	
	create temporary table if not exists ubt_temp_dailyretsummary
			(ProdName varchar(100),
			 Amt numeric,
			 Flg varchar(50));
			
	insert into ubt_temp_dailyretsummary
		select 
		  prodname as ProductName
		, sum(amount) as Amt
		, flag as flg
		from public.sp_ubt_getTransAmountDetails(inFromDate,inToDate)
		where 1=1
		and flag <> 'GST'
		and (flag = 'COL' or flag = 'CAN' OR flag = 'RFD' OR flag = 'SAL' 
			OR flag = 'PAY' OR flag = 'RBT' OR flag = 'CAS')
		group by prodname, flag;
	
	return query
	select 
		  case 
		  	when ProdName = 'TOTO' then '1TOTO'
		  	when ProdName in (' 4D Lottery','4D Lottery') then '24D Lottery'
		  	when ProdName = 'SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
		  	when ProdName = 'SPORTS' then '4SPORTS'
		  	when ProdName = 'HORSE RACING' then '5HORSE RACING'
		  	when ProdName = 'Offline Orders' then '6Offline Orders'
		  	when ProdName = 'NETS' then '2NETS'
		  	when ProdName = 'CASHCARD/Flashpay' then '3CASHCARD/Flashpay'
		  	else ProdName end as prodname
		, Amt
		, case 
			when flg = 'COL' then '0Amount of Wagers'
			when flg = 'CAN' then '1Amount of Cancels'
			when flg = 'RFD' then '2Amount of Actual Refund'
			when flg = 'RBT' then '3Amount of Rebates'
			when flg = 'PAY' then '4Amount of Win Paid'
			when flg = 'SAL' then '5Amount of Sales Commission'
			when flg = 'CAS' then '6Amount Due'
			else flg end as flag
		from ubt_temp_dailyretsummary
	union all
	select '1Total' prodname
		, sum(Amt) as Amt
		, '6Amount Due' as Flg
		from ubt_temp_dailyretsummary
		where flg <> 'CAS';


drop table ubt_temp_dailyretsummary;
	
end;

$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummaryreport_bk20240314(infromdate date, intodate date) OWNER TO consultant01;

--
-- TOC entry 1301 (class 1255 OID 2005629)
-- Name: sp_ubt_getdailyretsummaryreport_bk20241010(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getdailyretsummaryreport_bk20241010(infromdate date, intodate date) RETURNS TABLE(productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin
	
	create temporary table if not exists ubt_temp_dailyretsummary
			(ProdName varchar(100),
			 Amt numeric,
			 Flg varchar(50));
			
	insert into ubt_temp_dailyretsummary
		select 
		  prodname as ProductName
		, sum(amount) as Amt
		, flag as flg
		from public.sp_ubt_getTransAmountDetails(inFromDate,inToDate)
		where 1=1
		and flag <> 'GST'
		and (flag = 'COL' or flag = 'CAN' OR flag = 'RFD' OR flag = 'SAL' 
			OR flag = 'PAY' OR flag = 'RBT' OR flag = 'CAS')
		group by prodname, flag;
	
	return query
	select 
		  case 
		  	when ProdName = 'TOTO' then '1TOTO'
		  	when ProdName in (' 4D Lottery','4D Lottery') then '24D Lottery'
		  	when ProdName = 'SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
		  	when ProdName = 'SPORTS' then '4SPORTS'
		  	when ProdName = 'HORSE RACING' then '5HORSE RACING'
		  	when ProdName = 'Offline Orders' then '6Offline Orders'
		  	when ProdName = 'NETS' then '2NETS'
		  	when ProdName = 'CASHCARD/Flashpay' then '3CASHCARD/Flashpay'
			when ProdName = 'PaynowQR [+trans fee]' then '4PaynowQR [+trans fee]'
			when ProdName = 'Paynow [+trans fee]' then '5Paynow [+trans fee]'
			when ProdName = 'PaynowQR' then '6PaynowQR'
			when ProdName = 'Paynow' then '7Paynow'
		  	else ProdName end as prodname
		, Amt
		, case 
			when flg = 'COL' then '0Amount of Wagers'
			when flg = 'CAN' then '1Amount of Cancels'
			when flg = 'RFD' then '2Amount of Actual Refund'
			when flg = 'RBT' then '3Amount of Rebates'
			when flg = 'PAY' then '4Amount of Win Paid'
			when flg = 'SAL' then '5Amount of Sales Commission'
			when flg = 'CAS' then '6Amount Due'
			else flg end as flag
		from ubt_temp_dailyretsummary
	union all
	select '1Total' prodname
		, sum(Amt) as Amt
		, '6Amount Due' as Flg
		from ubt_temp_dailyretsummary
		where flg <> 'CAS';


drop table ubt_temp_dailyretsummary;
	
end;

$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummaryreport_bk20241010(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1205 (class 1255 OID 2380387)
-- Name: sp_ubt_getdailyretsummaryreport_bk20250310(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getdailyretsummaryreport_bk20250310(infromdate date, intodate date) RETURNS TABLE(productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin
	
	create temporary table if not exists ubt_temp_dailyretsummary
			(ProdName varchar(100),
			 Amt numeric,
			 Flg varchar(50));
			
	insert into ubt_temp_dailyretsummary
		select 
		  prodname as ProductName
		, sum(amount) as Amt
		, flag as flg
		from public.sp_ubt_getTransAmountDetails(inFromDate,inToDate)
		where 1=1
		and flag <> 'GST'
		and (flag = 'COL' or flag = 'CAN' OR flag = 'RFD' OR flag = 'SAL' 
			OR flag = 'PAY' OR flag = 'RBT' OR flag = 'CAS')
		group by prodname, flag;
	
	return query
	select 
		  case 
		  	when ProdName = 'TOTO' then '1TOTO'
		  	when ProdName = 'TOTO MATCH' then '1TOTO MATCH'
		  	when ProdName in (' 4D Lottery','4D Lottery') then '24D Lottery'
		  	when ProdName = 'SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
		  	when ProdName = 'SPORTS' then '4SPORTS'
		  	when ProdName = 'HORSE RACING' then '5HORSE RACING'
		  	when ProdName = 'Offline Orders' then '6Offline Orders'
		  	when ProdName = 'NETS' then '2NETS'
		  	when ProdName = 'CASHCARD/Flashpay' then '3CASHCARD/Flashpay'
			when ProdName = 'PaynowQR [+trans fee]' then '4PaynowQR [+trans fee]'
			when ProdName = 'Paynow [+trans fee]' then '5Paynow [+trans fee]'
			when ProdName = 'PaynowQR' then '6PaynowQR'
			when ProdName = 'Paynow' then '7Paynow'
		  	else ProdName end as prodname
		, Amt
		, case 
			when flg = 'COL' then '0Amount of Wagers'
			when flg = 'CAN' then '1Amount of Cancels'
			when flg = 'RFD' then '2Amount of Actual Refund'
			when flg = 'RBT' then '3Amount of Rebates'
			when flg = 'PAY' then '4Amount of Win Paid'
			when flg = 'SAL' then '5Amount of Sales Commission'
			when flg = 'CAS' then '6Amount Due'
			else flg end as flag
		from ubt_temp_dailyretsummary
	union all
	select '1Total' prodname
		, sum(Amt) as Amt
		, '6Amount Due' as Flg
		from ubt_temp_dailyretsummary
		where flg <> 'CAS';


drop table ubt_temp_dailyretsummary;
	
end;

$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummaryreport_bk20250310(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1173 (class 1255 OID 931779)
-- Name: sp_ubt_getdailyretsummaryreport_bk20250326(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getdailyretsummaryreport_bk20250326(infromdate date, intodate date) RETURNS TABLE(productname character varying, amount numeric, flag character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin
	
	create temporary table if not exists ubt_temp_dailyretsummary
			(ProdName varchar(100),
			 Amt numeric,
			 Flg varchar(50));
			
	insert into ubt_temp_dailyretsummary
		select 
		  prodname as ProductName
		, sum(amount) as Amt
		, flag as flg
		from public.sp_ubt_getTransAmountDetails(inFromDate,inToDate)
		where 1=1
		and flag <> 'GST'
		and (flag = 'COL' or flag = 'CAN' OR flag = 'RFD' OR flag = 'SAL' 
			OR flag = 'PAY' OR flag = 'RBT' OR flag = 'CAS')
		group by prodname, flag;
	
	return query
	select 
		  case 
		  	when ProdName = 'TOTO' then '1TOTO'
		  	when ProdName = 'TOTO MATCH' then '1TOTO MATCH'
		  	when ProdName in (' 4D Lottery','4D Lottery') then '24D Lottery'
		  	when ProdName = 'SINGAPORE SWEEP' then '3SINGAPORE SWEEP'
		  	when ProdName = 'SPORTS' then '4SPORTS'
		  	when ProdName = 'HORSE RACING' then '5HORSE RACING'
		  	when ProdName = 'Offline Orders' then '6Offline Orders'
		  	when ProdName = 'NETS' then '2NETS'
		  	when ProdName = 'CASHCARD/Flashpay' then '3CASHCARD/Flashpay'
			when ProdName = 'PaynowQR [+trans fee]' then '4PaynowQR [+trans fee]'
			when ProdName = 'Paynow [+trans fee]' then '5Paynow [+trans fee]'
			when ProdName = 'PaynowQR' then '6PaynowQR'
			when ProdName = 'Paynow' then '7Paynow'
		  	else ProdName end as prodname
		, Amt
		, case 
			when flg = 'COL' then '0Amount of Wagers'
			when flg = 'CAN' then '1Amount of Cancels'
			when flg = 'RFD' then '2Amount of Actual Refund'
			when flg = 'RBT' then '3Amount of Rebates'
			when flg = 'PAY' then '4Amount of Win Paid'
			when flg = 'SAL' then '5Amount of Sales Commission'
			when flg = 'CAS' then '6Amount Due'
			else flg end as flag
		from ubt_temp_dailyretsummary
	union all
	select '1Total' prodname
		, sum(Amt) as Amt
		, '6Amount Due' as Flg
		from ubt_temp_dailyretsummary
		where flg <> 'CAS';


drop table ubt_temp_dailyretsummary;
	
end;

$$;


ALTER FUNCTION public.sp_ubt_getdailyretsummaryreport_bk20250326(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1109 (class 1255 OID 216781)
-- Name: sp_ubt_getentrymethodsforsports(date); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_ubt_getentrymethodsforsports(v_businessdate date) RETURNS TABLE(businessdate date, tranheaderid character varying, transactiontype integer, entrymethod integer, locationid integer, productid integer)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare
v_perioddate date;
v_periodfromdateob timestamp;
v_periodtodateob timestamp;

begin
	create temp table if not exists ubt_temp_entrymethodtable
	(
	businessdate date,
	tranheaderid varchar(50),
	transactiontype integer,
	entrymethodid integer,
	locationid integer, -- retailer id
	productid integer
	);

select v_businessdate into v_perioddate;

--OB - 3 (Sports)
	SELECT zgp.PreviousPeriodDateTime, zgp.PeriodDateTime
	into v_periodfromdateob, v_periodtodateob
	FROM ztubt_getbusinessdate_perhost zgp 
	LEFT JOIN ztubt_lookupvalueconfig zl  ON zgp.Host = zl.Fld1Value ::integer 
	WHERE ConfigName='RTMS_Host' 
	AND Fld2Value = 'OB'
	AND zgp.ActualDate = v_perioddate;

insert into ubt_temp_entrymethodtable (businessdate,tranheaderid,transactiontype,entrymethodid, locationid,productid)
SELECT 
				v_perioddate as businessdate, 
				PB.TranHeaderID as tranheaderid, 
				1 as transactiontype,
				CASE PB.EntryMethodID
					WHEN 'Manual' THEN 0
					WHEN 'BetSlip' THEN 2
					WHEN 'Edit' THEN 10
					WHEN 'eBet' THEN 16
				end as entrymethodid,
				L.LocDisplayID::integer as locationid,
				CASE PB.ProdID
					WHEN 1 THEN 7--Horse Racing
					WHEN 2 THEN 9--4D
					WHEN 4 THEN 11--Sweep
					WHEN 3 THEN 23--Toto 6/49
					WHEN 5 THEN 20--Football/Motor Racing
					WHEN 6 THEN 20--Football/Motor Racing
				end as productid
			FROM ztubt_placedbettransactionheader PB
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate PBLC ON PB.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
			INNER JOIN ztubt_cart CART ON PB.CartID = CART.CartID 
			INNER JOIN ztubt_terminal T ON PB.TerDisplayID = T.TerDisplayID
			LEFT JOIN ztubt_location L ON T.LocID = L.LocID
			WHERE
			 (CART.cartcreateddate + interval'8 hour')::timestamp BETWEEN (v_periodfromdateob::timestamp) AND (v_periodtodateob::timestamp)
			AND PB.ProdID in (5,6)
			
			union all
			
			SELECT 
				v_perioddate as businessdate,
				VB.TranHeaderID as tranheaderid, 
				3 as transactiontype,
				CASE PB.EntryMethodID
					WHEN 'Manual' THEN 0
					WHEN 'BetSlip' THEN 2
					WHEN 'Edit' THEN 10
					WHEN 'eBet' THEN 16   -- ebet?
				end as entrymethodid,
				L.LocDisplayID::integer as locationid,
				CASE PB.ProdID
					WHEN 1 THEN 7--Horse Racing
					WHEN 2 THEN 9--4D
					WHEN 4 THEN 11--Sweep
					WHEN 3 THEN 23--Toto 6/49
					WHEN 5 THEN 20--Football/Motor Racing
					WHEN 6 THEN 20--Football/Motor Racing
				end as productid
			FROM ztubt_validatedbetticket VB
			INNER JOIN ztubt_placedbettransactionheader PB ON VB.TicketSerialNumber = PB.TicketSerialNumber
			INNER JOIN ztubt_validatedbetticketlifecyclestate VBLC ON VB.TranHeaderID = VBLC.TranHeaderID AND VBLC.BetStateTypeID = 'VB06'
			INNER JOIN ztubt_cart C ON VB.CartID = C.CartID
			INNER JOIN ztubt_terminal T ON PB.TerDisplayID = T.TerDisplayID
			LEFT JOIN ztubt_location L ON T.LocID = L.LocID
			WHERE VB.ValidationTypeID IN ('VALD', 'RFND')
			AND
			(C.cartcreateddate + interval'8 hour')::timestamp BETWEEN (v_periodfromdateob::timestamp) AND (v_periodtodateob::timestamp)
			AND PB.ProdID in (5,6)
			
			union all 
			
			SELECT 
				v_perioddate as businessdate, 
				CB.TranHeaderID as tranheaderid, 
				2 as transactiontype,
				CASE PB.EntryMethodID
					WHEN 'Manual' THEN 0
					WHEN 'BetSlip' THEN 2
					WHEN 'Edit' THEN 10
					WHEN 'eBet' THEN 16
				end as entrymethodid,
				L.LocDisplayID::integer as locationid,
				CASE PB.ProdID
					WHEN 1 THEN 7--Horse Racing
					WHEN 2 THEN 9--4D
					WHEN 4 THEN 11--Sweep
					WHEN 3 THEN 23--Toto 6/49
					WHEN 5 THEN 20--Football/Motor Racing
					WHEN 6 THEN 20--Football/Motor Racing
				end as productid
			FROM ztubt_cancelledbetticket CB
			INNER JOIN ztubt_placedbettransactionheader PB ON CB.TicketSerialNumber = PB.TicketSerialNumber 
			INNER JOIN ztubt_cancelledbetticketlifecyclestate CBLC ON CBLC.TranHeaderID = PB.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			INNER JOIN ztubt_terminal T ON PB.TerDisplayID = T.TerDisplayID
			LEFT JOIN ztubt_location L ON T.LocID = L.LocID
			WHERE PB.IsBetRejectedByTrader = false AND
			 CB.CancelledDate::timestamp BETWEEN (v_periodfromdateob::timestamp) AND (v_periodtodateob::timestamp)
			AND PB.ProdID in (5,6);

		return query
		select
		businessdate,tranheaderid,transactiontype,entrymethodid, locationid,productid
		from 
		ubt_temp_entrymethodtable;
	
	drop table if exists ubt_temp_entrymethodtable;

end;
$$;


ALTER FUNCTION public.sp_ubt_getentrymethodsforsports(v_businessdate date) OWNER TO postgres;

--
-- TOC entry 1290 (class 1255 OID 1276434)
-- Name: sp_ubt_getexpectedpaynow(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getexpectedpaynow(ptransactiondate date) RETURNS TABLE(transactiondate date, transactiondatetime timestamp without time zone, valuedate date, retailer_id integer, paymenttypeid character varying, transaction_amount numeric, transaction_fee numeric, bank_amount numeric, transactionreference character varying, transactionstatus character varying)
    LANGUAGE plpgsql
    AS $$

declare
	status_pnqr text[];
	status_pnric text[];

BEGIN
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

    CREATE TEMPORARY TABLE IF NOT EXISTS ubt_tmp_expected_epayment (
    	transactiondate date,
        transactiondatetime timestamp,
        valuedate DATE,
        retailer_id INT,
        paymenttypeid VARCHAR(20),
        transaction_amount NUMERIC,
        transaction_fee NUMERIC,
        bank_amount NUMERIC,
        transactionreference varchar(30),
        transactionstatus varchar(2)
    );

    INSERT INTO ubt_tmp_expected_epayment

    SELECT
    	cast(zp.updateddatetime as date) as transactiondate,
        cast(zp.updateddatetime as timestamp) AS transactiondatetime,
        CAST(zr.valuedate AS DATE) AS valuedate,
        CAST(SUBSTRING(zl.locdisplayid FROM '[1-9][0-9]*') AS INT) AS retailer_id,
        zp.paymenttypeid,
        COALESCE(zp.netamount/100, 0)AS transaction_amount,
        COALESCE(zp.transactionfee/100, 0) AS transaction_fee,
        COALESCE(zr.bankamount/100,0) as bank_amount,
        zp.transactionreference,
        zp.transactionstatus
    FROM
        ztubt_paynowtransaction zp
        LEFT JOIN 
           (select * ,
           		  row_number() over (partition by zr.transactionreference order by zr.updateddatetime desc) as row_num
           from ztubt_reconciliationresult zr
           ) as zr 
        on zp.transactionreference = zr.transactionreference and zr.row_num =1
        LEFT JOIN ztubt_cart zc ON zp.cartid = zc.cartid  
		LEFT JOIN ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
		LEFT JOIN ztubt_location zl ON zt.LocID = zl.LocID 
    where
    	((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
			or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
		)
        AND CAST(zp.updateddatetime AS DATE) = ptransactiondate;
   
    RETURN QUERY SELECT * FROM ubt_tmp_expected_epayment;
    
    -- Clean up temporary tables
    DROP TABLE IF EXISTS ubt_tmp_expected_epayment;
END;
$$;


ALTER FUNCTION public.sp_ubt_getexpectedpaynow(ptransactiondate date) OWNER TO sp_postgres;

--
-- TOC entry 1298 (class 1255 OID 1866768)
-- Name: sp_ubt_getexpectedpaynow_bk20240820(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getexpectedpaynow_bk20240820(ptransactiondate date) RETURNS TABLE(transactiondate date, transactiondatetime timestamp without time zone, valuedate date, retailer_id integer, paymenttypeid character varying, transaction_amount numeric, transaction_fee numeric, bank_amount numeric, transactionreference character varying, transactionstatus character varying)
    LANGUAGE plpgsql
    AS $$

declare
	status_pnqr text[];
	status_pnric text[];

BEGIN
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

    CREATE TEMPORARY TABLE IF NOT EXISTS ubt_tmp_expected_epayment (
    	transactiondate date,
        transactiondatetime timestamp,
        valuedate DATE,
        retailer_id INT,
        paymenttypeid VARCHAR(20),
        transaction_amount NUMERIC,
        transaction_fee NUMERIC,
        bank_amount NUMERIC,
        transactionreference varchar(30),
        transactionstatus varchar(2)
    );

    INSERT INTO ubt_tmp_expected_epayment

    SELECT
    	cast(zp.updateddatetime as date) as transactiondate,
        cast(zp.updateddatetime as timestamp) AS transactiondatetime,
        CAST(zr.valuedate AS DATE) AS valuedate,
        CAST(SUBSTRING(zl.locdisplayid FROM '[1-9][0-9]*') AS INT) AS retailer_id,
        zp.paymenttypeid,
        COALESCE(zp.netamount/100, 0)AS transaction_amount,
        COALESCE(zp.transactionfee/100, 0) AS transaction_fee,
        COALESCE(zr.bankamount/100,0) as bank_amount,
        zp.transactionreference,
        zp.transactionstatus
    FROM
        ztubt_paynowtransaction zp
        LEFT JOIN 
           (select * ,
           		  row_number() over (partition by zr.transactionreference order by zr.transactiondate desc) as row_num
           from ztubt_reconciliationresult zr
           ) as zr 
        on zp.transactionreference = zr.transactionreference and zr.row_num =1
        LEFT JOIN ztubt_cart zc ON zp.cartid = zc.cartid  
		LEFT JOIN ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
		LEFT JOIN ztubt_location zl ON zt.LocID = zl.LocID 
    where
    	((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
			or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
		)
        AND CAST(zp.updateddatetime AS DATE) = ptransactiondate;
   
    RETURN QUERY SELECT * FROM ubt_tmp_expected_epayment;
    
    -- Clean up temporary tables
    DROP TABLE IF EXISTS ubt_tmp_expected_epayment;
END;
$$;


ALTER FUNCTION public.sp_ubt_getexpectedpaynow_bk20240820(ptransactiondate date) OWNER TO sp_postgres;

--
-- TOC entry 1297 (class 1255 OID 1841913)
-- Name: sp_ubt_getinoutpaymentdetail(timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinoutpaymentdetail(inbusinessdate timestamp without time zone) RETURNS TABLE(out_payoutid character varying, in_paymentdetailid character varying, in_paymentid character varying, transactiontype character varying, paidamount numeric, paymenttypeid character varying, cartid character varying, terdisplayid character varying, userdisplayid character varying, sessionid character varying, createddate timestamp without time zone)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;

begin
	select 
		utcfromdatetimeigt,
		utctodatetimeigt
	into
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT
	from public.sp_ubt_getcommonubtdates(inbusinessdate,inbusinessdate)
	;
	
	CREATE TEMPORARY TABLE if not exists ubt_temp_inout_paymentdetail(
		out_payoutid varchar(38) NULL,
		in_paymentdetailid varchar(38) NULL,
		in_paymentid varchar(38) NULL,
		transactiontype varchar(38) NOT NULL,
		paidamount numeric(18,2) NULL,
		paymenttypeid varchar(5) NOT NULL,
		cartid varchar(38) NULL,
		terdisplayid varchar(50) NULL,
		userdisplayid varchar(50) NULL,
		sessionid varchar(38) NULL,
		createddate timestamp NOT NULL
	);

INSERT INTO ubt_temp_inout_paymentdetail(out_payoutid,in_paymentdetailid,in_paymentid, transactiontype ,paidamount,
	paymenttypeid,cartid,terdisplayid, userdisplayid, sessionid, createddate)

	-- OUTGOING - Cheque, PayNow NRIC
	select 
		po.payoutid as out_payoutid,
		'' as in_paymentdetailid,
       '' as in_paymentid,
       'OUTGOING' as transactiontype,
       po.totalamountpaid as paidamount,
       po.paymenttypeid,
       po.cartid,
       ca.terdisplayid,
       ca.userdisplayid,
       ca.sessionid,
       po.cartcreateddate as createddate
	from ztubt_payoutdata po
	inner join ztubt_cart ca on po.cartid = ca.cartid
	where ca.cartcreateddate between vUTCFromDateTimeIGT and vUTCToDateTimeIGT

	union all

	-- OUTGOING - Cash
	select 
		cast(cashboxtranid as varchar(38)) as out_payoutid,
       '' as in_paymentdetailid,
       '' as in_paymentid,   
       'OUTGOING' as transactiontype,
       returnedamount as paidamount,
       'CH' as paymenttypeid,
       cartid,
       terdisplayid,
       userdisplayid,
       sessionid,
       createddatetime - INTERVAL '8 hours' as createddate
	from ztubt_cashbox
	where cashtransactiontypeid = 4
	and createddatetime - INTERVAL '8 hours' between vUTCFromDateTimeIGT and vUTCToDateTimeIGT 
	
	union all
	
	-- Incoming - Cash, Nets, PayNow
	
	select 
	out_payoutid,
       in_paymentdetailid,
       in_paymentid,
       transactiontype,
       paidamount,
       paymenttypeid,
       cartid,
       terdisplayid,
       userdisplayid,
       sessionid,
       a.createddate
	from 
	(select 
	   '' as out_payoutid,
       zd.paymentdetailid as in_paymentdetailid,
       zd.paymentid as in_paymentid,
       'INCOMING' as transactiontype,
       zd.paidamount,
       zd.paymenttypeid,
       zd.terdisplayid,
       zd.userdisplayid,
       zd.sessionid,
       zd.createddate
	from ztubt_paymentdetail zd
	where zd.createddate between vUTCFromDateTimeIGT and vUTCToDateTimeIGT) a
	join ztubt_paymentheader zh on a.in_paymentid =  zh.paymentid
	;

return query select * from ubt_temp_inout_paymentdetail;

drop table if exists ubt_temp_inout_paymentdetail;

end;
$$;


ALTER FUNCTION public.sp_ubt_getinoutpaymentdetail(inbusinessdate timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1296 (class 1255 OID 1858025)
-- Name: sp_ubt_getinoutpaymentdetail_bk(timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinoutpaymentdetail_bk(inbusinessdate timestamp without time zone) RETURNS TABLE(out_payoutid character varying, in_paymentdetailid character varying, in_paymentid character varying, transactiontype character varying, paidamount numeric, paymenttypeid character varying, cartid character varying, terdisplayid character varying, userdisplayid character varying, sessionid character varying, createddate timestamp without time zone)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;

begin
	select 
		utcfromdatetimeigt,
		utctodatetimeigt
	into
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT
	from public.sp_ubt_getcommonubtdates(inbusinessdate,inbusinessdate)
	;
	
	CREATE TEMPORARY TABLE if not exists ubt_temp_inout_paymentdetail(
		out_payoutid varchar(38) NULL,
		in_paymentdetailid varchar(38) NULL,
		in_paymentid varchar(38) NULL,
		transactiontype varchar(38) NOT NULL,
		paidamount numeric(18,2) NULL,
		paymenttypeid varchar(5) NOT NULL,
		cartid varchar(38) NULL,
		terdisplayid varchar(50) NULL,
		userdisplayid varchar(50) NULL,
		sessionid varchar(38) NULL,
		createddate timestamp NOT NULL
	);

INSERT INTO ubt_temp_inout_paymentdetail(out_payoutid,in_paymentdetailid,in_paymentid, transactiontype ,paidamount,
	paymenttypeid,cartid,terdisplayid, userdisplayid, sessionid, createddate)

	-- OUTGOING - Cheque, PayNow NRIC
	select 
		po.payoutid as out_payoutid,
		'' as in_paymentdetailid,
       '' as in_paymentid,
       'OUTGOING' as transactiontype,
       po.totalamountpaid as paidamount,
       po.paymenttypeid,
       po.cartid,
       ca.terdisplayid,
       ca.userdisplayid,
       ca.sessionid,
       po.cartcreateddate as createddate
	from ztubt_payoutdata po
	inner join ztubt_cart ca on po.cartid = ca.cartid
	where ca.cartcreateddate between vUTCFromDateTimeIGT and vUTCToDateTimeIGT

	union all

	-- OUTGOING - Cash
	select 
		cast(cashboxtranid as varchar(38)) as out_payoutid,
       '' as in_paymentdetailid,
       '' as in_paymentid,   
       'OUTGOING' as transactiontype,
       returnedamount as paidamount,
       'CH' as paymenttypeid,
       cartid,
       terdisplayid,
       userdisplayid,
       sessionid,
       createddatetime - INTERVAL '8 hours' as createddate
	from ztubt_cashbox
	where cashtransactiontypeid = 4
	and createddatetime - INTERVAL '8 hours' between vUTCFromDateTimeIGT and vUTCToDateTimeIGT 
	
	union all
	
	-- Incoming - Cash, Nets, PayNow
	select 
	   '' as out_payoutid,
       zd.paymentdetailid as in_paymentdetailid,
       zd.paymentid as in_paymentid,
       'INCOMING' as transactiontype,
       zd.paidamount,
       zd.paymenttypeid,
       zh.cartid,
       zd.terdisplayid,
       zd.userdisplayid,
       zd.sessionid,
       zd.createddate
	from ztubt_paymentdetail zd
	join ztubt_paymentheader zh on zd.paymentid =  zh.paymentid
	where zd.createddate between vUTCFromDateTimeIGT and vUTCToDateTimeIGT
	;

return query select * from ubt_temp_inout_paymentdetail;

drop table if exists ubt_temp_inout_paymentdetail;

end;
$$;


ALTER FUNCTION public.sp_ubt_getinoutpaymentdetail_bk(inbusinessdate timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1176 (class 1255 OID 931780)
-- Name: sp_ubt_getinvbankdbtcrdreport(timestamp without time zone, timestamp without time zone, character varying); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinvbankdbtcrdreport(infromdate timestamp without time zone, intodate timestamp without time zone, intype character varying) RETURNS TABLE(chainname character varying, locdisplayid character varying, locname character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare


begin
	
	create temporary table if not exists ubt_temp_invdbcrTerProdSumCtAmtInRange(
	 	TerDisplayID VARCHAR(100),			
	 	ProductName VARCHAR(100),
 		FLAG CHAR(3),
		Amount Numeric(32, 11), 
		TicketCount INT4,
		ActualDate Date,
		TransType CHAR(2));
	
	
	insert into ubt_temp_invdbcrTerProdSumCtAmtInRange
	select * from sp_ubt_gettransamountdetails(inFromDate,inToDate);

	create temporary table if not exists ubt_temp_invdbcrLocWithProdAmt(
        LocID int4,
		ProductName varchar(100),
		Amount numeric(32, 11), 
		FLAG char(3),
		TransType char(2));
		
	INSERT INTO ubt_temp_invdbcrLocWithProdAmt
		Select LOC.LocID, TPA.ProductName, MAX(TPA.Amount), TPA.FLAG, TPA.TransType
		From ubt_temp_invdbcrTerProdSumCtAmtInRange TPA
		INNER JOIN ztubt_terminal Ter ON TPA.TerDisplayID = TER.TerDisplayID --AND TER.IsDeleted = 0 --(4)
		INNER JOIN ztubt_location Loc ON TER.LocID = LOC.LocID --AND LOC.IsDeleted = 0 --(4)
			Where FLAG IN ('FUN','REC')
		GROUP BY LOC.LocID, TPA.ProductName, TPA.FLAG, TPA.TransType;

	create temporary table if not exists ubt_temp_invdbcrTmpChainLocAmt(
		ChainName varchar(100),
		LocID int4,
		LocName varchar(100),
		Amount numeric(32, 11));
	
	insert into ubt_temp_invdbcrTmpChainLocAmt	
			select A.chname,A.locid,A.locname,(A.Amount+coalesce (B.amount,0))	 Amount from (
	select zc.chname , zl.locid,zl.locname , sum(coalesce(tabA.amount,0))  Amount from ztubt_location zl  
		left outer join ztubt_terminal zt on (zl.locid=zt.locid)
		inner join ztubt_chain zc on (zl.chid = zc.chid)
		left join (
			select terdisplayid, sum(amount) amount from ubt_temp_invdbcrTerProdSumCtAmtInRange
			where 1=1
			and (
				(flag in ('COL') and transtype <> 'OO')
			  or(flag in ('CAN','PAY','RFD','RBT') and transtype <> 'OO')
			  or(flag in ('SAL','GST'))
			  or(flag in ('CAS') and transtype = 'TF') -- add Transfee Paynow, PaynowQR
				) 
			group by terdisplayid
			union all 
			select terdisplayid, sum(amount)*-1  from ubt_temp_invdbcrTerProdSumCtAmtInRange
			where 1=1
			and transtype = 'CL'
			group by terdisplayid
			) tabA
			on (zt.terdisplayid = tabA.terdisplayid)
	--	left outer join
	--	(select locid, sum(amount) amount from ubt_temp_invdbcrLocWithProdAmt group by locid) aa on (aa.locid = zl.locid)
	group by zc.chname , zl.locid,zl.locname
) A 
left outer join
		(select locid, sum(amount) amount from ubt_temp_invdbcrLocWithProdAmt group by locid) B on (A.locid = B.locid);
/*
insert into ubt_temp_invdbcrTmpChainLocAmt

	select zc.chname , pa.locid,zl.locname , sum(coalesce(pa.amount,0)) Amount 
		from ubt_temp_invdbcrLocWithProdAmt pa 
		left join ztubt_location zl  on pa.locid=zl.locid
		inner join ztubt_chain zc on (zl.chid = zc.chid)
	where flag in ('FUN','REC')
	group by zc.chname , pa.locid,zl.locname  */


	
	if inType = 'C-IBG' then
	return query
		select
		T.ChainName,L.LocDisplayID,T.LocName,T.Amount Amount
		from
		ubt_temp_invdbcrTmpChainLocAmt T
		inner join ztubt_Location L on
		T.LocID = L.LocID
		where
		T.Amount < 0
		and (L.IsIBG = true)
		and L.LocTypeID != 1;
	---group by T.ChainName,L.LocDisplayID,T.LocName;
	end if;


   if inType = 'C-NON' then 
   return query
       select
	   T.ChainName,
	   L.LocDisplayID,
	   T.LocName,
	   T.Amount Amount
       from
	   ubt_temp_invdbcrTmpChainLocAmt T
       inner join ztubt_Location L on
	   T.LocID = L.LocID
       where
	   T.Amount < 0
	   and (L.IsIBG = false
	   or L.IsIBG is null);
	  --group by T.ChainName,L.LocDisplayID,T.LocName;
end if;




  if inType = 'D-IBG' then 
  return query
     select
	 T.ChainName,
	 L.LocDisplayID,
	 T.LocName,
	 T.Amount Amount 
     from
	 ubt_temp_invdbcrTmpChainLocAmt T
     inner join ztubt_location L on
	 T.LocID = L.LocID
     where
	 T.Amount >= 0
	 and (L.IsIBG = true)
	 and L.LocTypeID != 1;
	--group by T.ChainName,L.LocDisplayID,T.LocName;
end if;	


if inType = 'D-NON' then 
  return query
    select
	T.ChainName,
	L.LocDisplayID,
	T.LocName,
    T.Amount Amount
    from
	ubt_temp_invdbcrTmpChainLocAmt T
    inner join ztubt_location L on
	T.LocID = L.LocID
    where
	T.Amount >= 0
	and (L.IsIBG = false
		or L.IsIBG is null);
	---group by T.ChainName,L.LocDisplayID,T.LocName;
end if;	


drop table ubt_temp_invdbcrTerProdSumCtAmtInRange;
drop table ubt_temp_invdbcrLocWithProdAmt;
drop table ubt_temp_invdbcrTmpChainLocAmt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvbankdbtcrdreport(infromdate timestamp without time zone, intodate timestamp without time zone, intype character varying) OWNER TO sp_postgres;

--
-- TOC entry 1284 (class 1255 OID 24780)
-- Name: sp_ubt_getinvbankdbtcrdreport_bk20240314(timestamp without time zone, timestamp without time zone, character varying); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getinvbankdbtcrdreport_bk20240314(infromdate timestamp without time zone, intodate timestamp without time zone, intype character varying) RETURNS TABLE(chainname character varying, locdisplayid character varying, locname character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare


begin
	
	create temporary table if not exists ubt_temp_invdbcrTerProdSumCtAmtInRange(
	 	TerDisplayID VARCHAR(100),			
	 	ProductName VARCHAR(100),
 		FLAG CHAR(3),
		Amount Numeric(32, 11), 
		TicketCount INT4,
		ActualDate Date,
		TransType CHAR(2));
	
	
	insert into ubt_temp_invdbcrTerProdSumCtAmtInRange
	select * from sp_ubt_gettransamountdetails (inFromDate,inToDate);

	create temporary table if not exists ubt_temp_invdbcrLocWithProdAmt(
        LocID int4,
		ProductName varchar(100),
		Amount numeric(32, 11), 
		FLAG char(3),
		TransType char(2));
		
	INSERT INTO ubt_temp_invdbcrLocWithProdAmt
		Select LOC.LocID, TPA.ProductName, MAX(TPA.Amount), TPA.FLAG, TPA.TransType
		From ubt_temp_invdbcrTerProdSumCtAmtInRange TPA
		INNER JOIN ztubt_terminal Ter ON TPA.TerDisplayID = TER.TerDisplayID --AND TER.IsDeleted = 0 --(4)
		INNER JOIN ztubt_location Loc ON TER.LocID = LOC.LocID --AND LOC.IsDeleted = 0 --(4)
			Where FLAG IN ('FUN','REC')
		GROUP BY LOC.LocID, TPA.ProductName, TPA.FLAG, TPA.TransType;

	create temporary table if not exists ubt_temp_invdbcrTmpChainLocAmt(
		ChainName varchar(100),
		LocID int4,
		LocName varchar(100),
		Amount numeric(32, 11));
	
	insert into ubt_temp_invdbcrTmpChainLocAmt	
			select A.chname,A.locid,A.locname,(A.Amount+coalesce (B.amount,0))	 Amount from (
	select zc.chname , zl.locid,zl.locname , sum(coalesce(tabA.amount,0))  Amount from ztubt_location zl  
		left outer join ztubt_terminal zt on (zl.locid=zt.locid)
		inner join ztubt_chain zc on (zl.chid = zc.chid)
		left join (
			select terdisplayid, sum(amount) amount from ubt_temp_invdbcrTerProdSumCtAmtInRange
			where 1=1
			and (
				(flag in ('COL') and transtype <> 'OO')
			  or(flag in ('CAN','PAY','RFD','RBT') and transtype <> 'OO')
			  or(flag in ('SAL','GST'))
				) 
			group by terdisplayid
			union all 
			select terdisplayid, sum(amount)*-1  from ubt_temp_invdbcrTerProdSumCtAmtInRange
			where 1=1
			and transtype = 'CL'
			group by terdisplayid
			) tabA
			on (zt.terdisplayid = tabA.terdisplayid)
	--	left outer join
	--	(select locid, sum(amount) amount from ubt_temp_invdbcrLocWithProdAmt group by locid) aa on (aa.locid = zl.locid)
	group by zc.chname , zl.locid,zl.locname
) A 
left outer join
		(select locid, sum(amount) amount from ubt_temp_invdbcrLocWithProdAmt group by locid) B on (A.locid = B.locid);
/*
insert into ubt_temp_invdbcrTmpChainLocAmt

	select zc.chname , pa.locid,zl.locname , sum(coalesce(pa.amount,0)) Amount 
		from ubt_temp_invdbcrLocWithProdAmt pa 
		left join ztubt_location zl  on pa.locid=zl.locid
		inner join ztubt_chain zc on (zl.chid = zc.chid)
	where flag in ('FUN','REC')
	group by zc.chname , pa.locid,zl.locname  */


	
	if inType = 'C-IBG' then
	return query
		select
		T.ChainName,L.LocDisplayID,T.LocName,T.Amount Amount
		from
		ubt_temp_invdbcrTmpChainLocAmt T
		inner join ztubt_Location L on
		T.LocID = L.LocID
		where
		T.Amount < 0
		and (L.IsIBG = true)
		and L.LocTypeID != 1;
	---group by T.ChainName,L.LocDisplayID,T.LocName;
	end if;


   if inType = 'C-NON' then 
   return query
       select
	   T.ChainName,
	   L.LocDisplayID,
	   T.LocName,
	   T.Amount Amount
       from
	   ubt_temp_invdbcrTmpChainLocAmt T
       inner join ztubt_Location L on
	   T.LocID = L.LocID
       where
	   T.Amount < 0
	   and (L.IsIBG = false
	   or L.IsIBG is null);
	  --group by T.ChainName,L.LocDisplayID,T.LocName;
end if;




  if inType = 'D-IBG' then 
  return query
     select
	 T.ChainName,
	 L.LocDisplayID,
	 T.LocName,
	 T.Amount Amount 
     from
	 ubt_temp_invdbcrTmpChainLocAmt T
     inner join ztubt_location L on
	 T.LocID = L.LocID
     where
	 T.Amount >= 0
	 and (L.IsIBG = true)
	 and L.LocTypeID != 1;
	--group by T.ChainName,L.LocDisplayID,T.LocName;
end if;	


if inType = 'D-NON' then 
  return query
    select
	T.ChainName,
	L.LocDisplayID,
	T.LocName,
    T.Amount Amount
    from
	ubt_temp_invdbcrTmpChainLocAmt T
    inner join ztubt_location L on
	T.LocID = L.LocID
    where
	T.Amount >= 0
	and (L.IsIBG = false
		or L.IsIBG is null);
	---group by T.ChainName,L.LocDisplayID,T.LocName;
end if;	


drop table ubt_temp_invdbcrTerProdSumCtAmtInRange;
drop table ubt_temp_invdbcrLocWithProdAmt;
drop table ubt_temp_invdbcrTmpChainLocAmt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvbankdbtcrdreport_bk20240314(infromdate timestamp without time zone, intodate timestamp without time zone, intype character varying) OWNER TO consultant01;

--
-- TOC entry 1305 (class 1255 OID 2042627)
-- Name: sp_ubt_getinvbankdbtcrdreport_testorg(timestamp without time zone, timestamp without time zone, character varying); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinvbankdbtcrdreport_testorg(infromdate timestamp without time zone, intodate timestamp without time zone, intype character varying) RETURNS TABLE(chainname character varying, locdisplayid character varying, locname character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare


begin
	
	create temporary table if not exists ubt_temp_invdbcrTerProdSumCtAmtInRange(
	 	TerDisplayID VARCHAR(100),			
	 	ProductName VARCHAR(100),
 		FLAG CHAR(3),
		Amount Numeric(32, 11), 
		TicketCount INT4,
		ActualDate Date,
		TransType CHAR(2));
	
	
	insert into ubt_temp_invdbcrTerProdSumCtAmtInRange
	select * from sp_ubt_gettransamountdetails_testorg(inFromDate,inToDate);

	create temporary table if not exists ubt_temp_invdbcrLocWithProdAmt(
        LocID int4,
		ProductName varchar(100),
		Amount numeric(32, 11), 
		FLAG char(3),
		TransType char(2));
		
	INSERT INTO ubt_temp_invdbcrLocWithProdAmt
		Select LOC.LocID, TPA.ProductName, MAX(TPA.Amount), TPA.FLAG, TPA.TransType
		From ubt_temp_invdbcrTerProdSumCtAmtInRange TPA
		INNER JOIN ztubt_terminal Ter ON TPA.TerDisplayID = TER.TerDisplayID --AND TER.IsDeleted = 0 --(4)
		INNER JOIN ztubt_location Loc ON TER.LocID = LOC.LocID --AND LOC.IsDeleted = 0 --(4)
			Where FLAG IN ('FUN','REC')
		GROUP BY LOC.LocID, TPA.ProductName, TPA.FLAG, TPA.TransType;

	create temporary table if not exists ubt_temp_invdbcrTmpChainLocAmt(
		ChainName varchar(100),
		LocID int4,
		LocName varchar(100),
		Amount numeric(32, 11));
	
	insert into ubt_temp_invdbcrTmpChainLocAmt	
			select A.chname,A.locid,A.locname,(A.Amount+coalesce (B.amount,0))	 Amount from (
	select zc.chname , zl.locid,zl.locname , sum(coalesce(tabA.amount,0))  Amount from ztubt_location zl  
		left outer join ztubt_terminal zt on (zl.locid=zt.locid)
		inner join ztubt_chain zc on (zl.chid = zc.chid)
		left join (
			select terdisplayid, sum(amount) amount from ubt_temp_invdbcrTerProdSumCtAmtInRange
			where 1=1
			and (
				(flag in ('COL') and transtype <> 'OO')
			  or(flag in ('CAN','PAY','RFD','RBT') and transtype <> 'OO')
			  or(flag in ('SAL','GST'))
			  or(flag in ('CAS') and transtype = 'TF') -- add Transfee Paynow, PaynowQR
				) 
			group by terdisplayid
			union all 
			select terdisplayid, sum(amount)*-1  from ubt_temp_invdbcrTerProdSumCtAmtInRange
			where 1=1
			and transtype = 'CL'
			group by terdisplayid
			) tabA
			on (zt.terdisplayid = tabA.terdisplayid)
	--	left outer join
	--	(select locid, sum(amount) amount from ubt_temp_invdbcrLocWithProdAmt group by locid) aa on (aa.locid = zl.locid)
	group by zc.chname , zl.locid,zl.locname
) A 
left outer join
		(select locid, sum(amount) amount from ubt_temp_invdbcrLocWithProdAmt group by locid) B on (A.locid = B.locid);
/*
insert into ubt_temp_invdbcrTmpChainLocAmt

	select zc.chname , pa.locid,zl.locname , sum(coalesce(pa.amount,0)) Amount 
		from ubt_temp_invdbcrLocWithProdAmt pa 
		left join ztubt_location zl  on pa.locid=zl.locid
		inner join ztubt_chain zc on (zl.chid = zc.chid)
	where flag in ('FUN','REC')
	group by zc.chname , pa.locid,zl.locname  */


	
	if inType = 'C-IBG' then
	return query
		select
		T.ChainName,L.LocDisplayID,T.LocName,T.Amount Amount
		from
		ubt_temp_invdbcrTmpChainLocAmt T
		inner join ztubt_Location L on
		T.LocID = L.LocID
		where
		T.Amount < 0
		and (L.IsIBG = true)
		and L.LocTypeID != 1;
	---group by T.ChainName,L.LocDisplayID,T.LocName;
	end if;


   if inType = 'C-NON' then 
   return query
       select
	   T.ChainName,
	   L.LocDisplayID,
	   T.LocName,
	   T.Amount Amount
       from
	   ubt_temp_invdbcrTmpChainLocAmt T
       inner join ztubt_Location L on
	   T.LocID = L.LocID
       where
	   T.Amount < 0
	   and (L.IsIBG = false
	   or L.IsIBG is null);
	  --group by T.ChainName,L.LocDisplayID,T.LocName;
end if;




  if inType = 'D-IBG' then 
  return query
     select
	 T.ChainName,
	 L.LocDisplayID,
	 T.LocName,
	 T.Amount Amount 
     from
	 ubt_temp_invdbcrTmpChainLocAmt T
     inner join ztubt_location L on
	 T.LocID = L.LocID
     where
	 T.Amount >= 0
	 and (L.IsIBG = true)
	 and L.LocTypeID != 1;
	--group by T.ChainName,L.LocDisplayID,T.LocName;
end if;	


if inType = 'D-NON' then 
  return query
    select
	T.ChainName,
	L.LocDisplayID,
	T.LocName,
    T.Amount Amount
    from
	ubt_temp_invdbcrTmpChainLocAmt T
    inner join ztubt_location L on
	T.LocID = L.LocID
    where
	T.Amount >= 0
	and (L.IsIBG = false
		or L.IsIBG is null);
	---group by T.ChainName,L.LocDisplayID,T.LocName;
end if;	


drop table ubt_temp_invdbcrTerProdSumCtAmtInRange;
drop table ubt_temp_invdbcrLocWithProdAmt;
drop table ubt_temp_invdbcrTmpChainLocAmt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvbankdbtcrdreport_testorg(infromdate timestamp without time zone, intodate timestamp without time zone, intype character varying) OWNER TO sp_postgres;

--
-- TOC entry 1135 (class 1255 OID 24781)
-- Name: sp_ubt_getinvoicedef(); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getinvoicedef() RETURNS TABLE(invoiceperiod integer, startdate date, enddate date)
    LANGUAGE plpgsql
    AS $$

#variable_conflict use_column

begin
create temp table if not exists ubt_resultdata (
 InvoicePeriod int, 
 StartDate date, 
 EndDate date
);
Insert into ubt_resultdata
select IP.InvoicePeriodID as InvoicePeriod, f.StartDate, f.EndDate 
from (
	SELECT AdHocTimeHistoryID as InvoicePeriod, 
	case when to_char(actualdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',actualdate  ::date )
else date_trunc('week',actualdate ::date )+ interval '4 days' end as  StartDate, 

	case when to_char(actualdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',actualdate  ::date )+ interval '3 days'
else date_trunc('week',actualdate ::date )+ interval '6 days' end as EndDate
	from ztubt_adhoctimehistory 
) f
LEFT JOIN ztubt_invoiceperiod IP ON f.StartDate = IP.StartDate:: date AND f.EndDate = IP.EndDate :: date
group by IP.InvoicePeriodID, f.StartDate, f.EndDate;

RETURN query
select 
InvoicePeriod,
StartDate, 
EndDate
from ubt_resultdata;

drop table ubt_resultdata;
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicedef() OWNER TO consultant01;

--
-- TOC entry 1229 (class 1255 OID 2379276)
-- Name: sp_ubt_getinvoicereport(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinvoicereport(infromdate date, intodate date) RETURNS TABLE(locterdisplayid character varying, productname character varying, amount numeric, flag character varying, transtype character varying, idtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin

	create temporary table if not exists temp_ubt_InvoiceRpt(
			LocTerID varchar(100),	
			ProdName varchar(100),
			Amt numeric,
			Flg varchar(50),
			TrxType varchar(25)
			);
		
	insert into temp_ubt_InvoiceRpt
		select  
		 terdisplayid
		,prodname
		,amount
		,flag
		,case 
			when prodname in ('Offline Orders', 'Gate Admission') then 'OO'
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end TransType
		from public.sp_ubt_getTransAmountDetails(inFromDate, inToDate)
		where 1=1;

	CREATE INDEX idx_tempinvoicerpt_locid_prodname ON temp_ubt_InvoiceRpt (LocTerID, Flg, ProdName);

	/* Update offline orders */
	UPDATE temp_ubt_InvoiceRpt a
	SET Amt = a.Amt - COALESCE(b.Amt, 0)
	FROM (
		select LocTerID, Flg, Amt
		from temp_ubt_InvoiceRpt
		where ProdName = 'Gate Admission' and Amt <> 0
	) b
	WHERE a.LocTerID = b.LocTerID AND a.Flg = b.Flg 
	AND a.ProdName = 'Offline Orders' AND a.Amt <> 0;
	
	return query
	select 
		LocTerID
	  , case
			when ProdName='TOTO' then '0TOTO'
			when ProdName='TOTO MATCH' then '0TOTO MATCH'
			when trim(ProdName)='4D Lottery' then '14D'
			when ProdName='SINGAPORE SWEEP' then '2SINGAPORE SWEEP'
			when ProdName='SPORTS' then '3SPORTS'
			when ProdName='HORSE RACING' then '4HORSE RACING'
			when ProdName='Funding and Recovery' then '5Funding and Recovery'
			when ProdName='Online Adjustment' then '6Online Adjustment'
			when ProdName='Offline Orders' then '7Offline Orders' 
			when ProdName='Gate Admission' then '8Gate Admission'
			when ProdName='NETS' then '8NETS'
			when ProdName='CASHCARD/Flashpay' then '9CASHCARD/Flashpay'
			when ProdName='PaynowQR [+trans fee]' then '9PaynowQR [+trans fee]'
			when ProdName='Paynow [+trans fee]' then '9Paynow [+trans fee]'
			when ProdName='PaynowQR' then '9PaynowQR'
			when ProdName='Paynow' then '9Paynow'
			else ProdName end ProdName
	  , Amt
	  , case
			when flg= 'COL' then '0Wagers'
			when flg= 'CAN'	then '1Cancel'
			when flg= 'RFD'	then '2Actual Refund'
			when flg= 'RBT'	then '3Rebates'
			when flg= 'PAY'	then '4Win Paid'
			when flg= 'SAL'	then '5Sales Comm'
			when flg= 'GST'	then '6GST'
			when flg= 'FUN'	then '7Funding / Crd Adj'
			when flg= 'REC'	then '8Recovery / Dbt Adj'
			when flg= 'CAS'	then '9Cashless' 
			else flg end Flg
	  , case
			when TrxType= 'CH' then '1Product'
			when TrxType= 'OO' then '2Offline Orders'
			when TrxType= 'CL' then '3Cashless Transactions'
			when TrxType= 'TF' then '4Transaction Fee'
			else TrxType end TrxType
	  , ID_Type
	from (
		select LocTerID ,ProdName
		,sum(case when flg in ('FUN','REC') then 0 else Amt end) Amt
		,Flg,TrxType, 'T'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt
		group by LocTerID ,ProdName,Flg,TrxType
		union all
		select zl.locdisplayid,ProdName,Max(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
		union all 
		select zl.locdisplayid ,ProdName,sum(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg not in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
	)sq;
	
drop table temp_ubt_InvoiceRpt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicereport(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1199 (class 1255 OID 24782)
-- Name: sp_ubt_getinvoicereport_bk20240314(date, date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getinvoicereport_bk20240314(infromdate date, intodate date) RETURNS TABLE(locterdisplayid character varying, productname character varying, amount numeric, flag character varying, transtype character varying, idtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin

	create temporary table if not exists temp_ubt_InvoiceRpt(
			LocTerID varchar(100),	
			ProdName varchar(100),
			Amt numeric,
			Flg varchar(50),
			TrxType varchar(25)
			);
		
	insert into temp_ubt_InvoiceRpt
		select  
		 terdisplayid
		,prodname
		,amount
		,flag
		,case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end TransType
		from public.sp_ubt_getTransAmountDetails(inFromDate, inToDate)
		where 1=1;
	
	return query
	select 
		LocTerID
	  , case
			when ProdName='TOTO' then '0TOTO'
			when trim(ProdName)='4D Lottery' then '14D'
			when ProdName='SINGAPORE SWEEP' then '2SINGAPORE SWEEP'
			when ProdName='SPORTS' then '3SPORTS'
			when ProdName='HORSE RACING' then '4HORSE RACING'
			when ProdName='Funding and Recovery' then '5Funding and Recovery'
			when ProdName='Online Adjustment' then '6Online Adjustment'
			when ProdName='Offline Orders' then '7Offline Orders'
			when ProdName='NETS' then '8NETS'
			when ProdName='CASHCARD/Flashpay' then '9CASHCARD/Flashpay'
			else ProdName end ProdName
	  , Amt
	  , case
			when flg= 'COL' then '0Wagers'
			when flg= 'CAN'	then '1Cancel'
			when flg= 'RFD'	then '2Actual Refund'
			when flg= 'RBT'	then '3Rebates'
			when flg= 'PAY'	then '4Win Paid'
			when flg= 'SAL'	then '5Sales Comm'
			when flg= 'GST'	then '6GST'
			when flg= 'FUN'	then '7Funding / Crd Adj'
			when flg= 'REC'	then '8Recovery / Dbt Adj'
			when flg= 'CAS'	then '9Cashless' 
			else flg end Flg
	  , case
			when TrxType= 'CH' then '1Product'
			when TrxType= 'OO' then '2Offline Orders'
			when TrxType= 'CL' then '3Cashless Transactions'
			else TrxType end TrxType
	  , ID_Type
	from (
		select LocTerID ,ProdName
		,sum(case when flg in ('FUN','REC') then 0 else Amt end) Amt
		,Flg,TrxType, 'T'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt
		group by LocTerID ,ProdName,Flg,TrxType
		union all
		select zl.locdisplayid,ProdName,Max(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
		union all 
		select zl.locdisplayid ,ProdName,sum(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg not in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
	)sq;
	
drop table temp_ubt_InvoiceRpt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicereport_bk20240314(infromdate date, intodate date) OWNER TO consultant01;

--
-- TOC entry 1302 (class 1255 OID 2005630)
-- Name: sp_ubt_getinvoicereport_bk20241010(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinvoicereport_bk20241010(infromdate date, intodate date) RETURNS TABLE(locterdisplayid character varying, productname character varying, amount numeric, flag character varying, transtype character varying, idtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin

	create temporary table if not exists temp_ubt_InvoiceRpt(
			LocTerID varchar(100),	
			ProdName varchar(100),
			Amt numeric,
			Flg varchar(50),
			TrxType varchar(25)
			);
		
	insert into temp_ubt_InvoiceRpt
		select  
		 terdisplayid
		,prodname
		,amount
		,flag
		,case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end TransType
		from public.sp_ubt_getTransAmountDetails(inFromDate, inToDate)
		where 1=1;
	
	return query
	select 
		LocTerID
	  , case
			when ProdName='TOTO' then '0TOTO'
			when trim(ProdName)='4D Lottery' then '14D'
			when ProdName='SINGAPORE SWEEP' then '2SINGAPORE SWEEP'
			when ProdName='SPORTS' then '3SPORTS'
			when ProdName='HORSE RACING' then '4HORSE RACING'
			when ProdName='Funding and Recovery' then '5Funding and Recovery'
			when ProdName='Online Adjustment' then '6Online Adjustment'
			when ProdName='Offline Orders' then '7Offline Orders'
			when ProdName='NETS' then '8NETS'
			when ProdName='CASHCARD/Flashpay' then '9CASHCARD/Flashpay'
			when ProdName='PaynowQR [+trans fee]' then '9PaynowQR [+trans fee]'
			when ProdName='Paynow [+trans fee]' then '9Paynow [+trans fee]'
			when ProdName='PaynowQR' then '9PaynowQR'
			when ProdName='Paynow' then '9Paynow'
			else ProdName end ProdName
	  , Amt
	  , case
			when flg= 'COL' then '0Wagers'
			when flg= 'CAN'	then '1Cancel'
			when flg= 'RFD'	then '2Actual Refund'
			when flg= 'RBT'	then '3Rebates'
			when flg= 'PAY'	then '4Win Paid'
			when flg= 'SAL'	then '5Sales Comm'
			when flg= 'GST'	then '6GST'
			when flg= 'FUN'	then '7Funding / Crd Adj'
			when flg= 'REC'	then '8Recovery / Dbt Adj'
			when flg= 'CAS'	then '9Cashless' 
			else flg end Flg
	  , case
			when TrxType= 'CH' then '1Product'
			when TrxType= 'OO' then '2Offline Orders'
			when TrxType= 'CL' then '3Cashless Transactions'
			when TrxType= 'TF' then '4Transaction Fee'
			else TrxType end TrxType
	  , ID_Type
	from (
		select LocTerID ,ProdName
		,sum(case when flg in ('FUN','REC') then 0 else Amt end) Amt
		,Flg,TrxType, 'T'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt
		group by LocTerID ,ProdName,Flg,TrxType
		union all
		select zl.locdisplayid,ProdName,Max(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
		union all 
		select zl.locdisplayid ,ProdName,sum(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg not in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
	)sq;
	
drop table temp_ubt_InvoiceRpt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicereport_bk20241010(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1202 (class 1255 OID 2379275)
-- Name: sp_ubt_getinvoicereport_bk20250310(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinvoicereport_bk20250310(infromdate date, intodate date) RETURNS TABLE(locterdisplayid character varying, productname character varying, amount numeric, flag character varying, transtype character varying, idtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin

	create temporary table if not exists temp_ubt_InvoiceRpt(
			LocTerID varchar(100),	
			ProdName varchar(100),
			Amt numeric,
			Flg varchar(50),
			TrxType varchar(25)
			);
		
	insert into temp_ubt_InvoiceRpt
		select  
		 terdisplayid
		,prodname
		,amount
		,flag
		,case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end TransType
		from public.sp_ubt_getTransAmountDetails(inFromDate, inToDate)
		where 1=1;
	
	return query
	select 
		LocTerID
	  , case
			when ProdName='TOTO' then '0TOTO'
			when ProdName='TOTO MATCH' then '0TOTO MATCH'
			when trim(ProdName)='4D Lottery' then '14D'
			when ProdName='SINGAPORE SWEEP' then '2SINGAPORE SWEEP'
			when ProdName='SPORTS' then '3SPORTS'
			when ProdName='HORSE RACING' then '4HORSE RACING'
			when ProdName='Funding and Recovery' then '5Funding and Recovery'
			when ProdName='Online Adjustment' then '6Online Adjustment'
			when ProdName='Offline Orders' then '7Offline Orders'
			when ProdName='NETS' then '8NETS'
			when ProdName='CASHCARD/Flashpay' then '9CASHCARD/Flashpay'
			when ProdName='PaynowQR [+trans fee]' then '9PaynowQR [+trans fee]'
			when ProdName='Paynow [+trans fee]' then '9Paynow [+trans fee]'
			when ProdName='PaynowQR' then '9PaynowQR'
			when ProdName='Paynow' then '9Paynow'
			else ProdName end ProdName
	  , Amt
	  , case
			when flg= 'COL' then '0Wagers'
			when flg= 'CAN'	then '1Cancel'
			when flg= 'RFD'	then '2Actual Refund'
			when flg= 'RBT'	then '3Rebates'
			when flg= 'PAY'	then '4Win Paid'
			when flg= 'SAL'	then '5Sales Comm'
			when flg= 'GST'	then '6GST'
			when flg= 'FUN'	then '7Funding / Crd Adj'
			when flg= 'REC'	then '8Recovery / Dbt Adj'
			when flg= 'CAS'	then '9Cashless' 
			else flg end Flg
	  , case
			when TrxType= 'CH' then '1Product'
			when TrxType= 'OO' then '2Offline Orders'
			when TrxType= 'CL' then '3Cashless Transactions'
			when TrxType= 'TF' then '4Transaction Fee'
			else TrxType end TrxType
	  , ID_Type
	from (
		select LocTerID ,ProdName
		,sum(case when flg in ('FUN','REC') then 0 else Amt end) Amt
		,Flg,TrxType, 'T'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt
		group by LocTerID ,ProdName,Flg,TrxType
		union all
		select zl.locdisplayid,ProdName,Max(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
		union all 
		select zl.locdisplayid ,ProdName,sum(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg not in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
	)sq;
	
drop table temp_ubt_InvoiceRpt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicereport_bk20250310(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1169 (class 1255 OID 931781)
-- Name: sp_ubt_getinvoicereport_bk20250326(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinvoicereport_bk20250326(infromdate date, intodate date) RETURNS TABLE(locterdisplayid character varying, productname character varying, amount numeric, flag character varying, transtype character varying, idtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

begin

	create temporary table if not exists temp_ubt_InvoiceRpt(
			LocTerID varchar(100),	
			ProdName varchar(100),
			Amt numeric,
			Flg varchar(50),
			TrxType varchar(25)
			);
		
	insert into temp_ubt_InvoiceRpt
		select  
		 terdisplayid
		,prodname
		,amount
		,flag
		,case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end TransType
		from public.sp_ubt_getTransAmountDetails(inFromDate, inToDate)
		where 1=1;
	
	return query
	select 
		LocTerID
	  , case
			when ProdName='TOTO' then '0TOTO'
			when ProdName='TOTO MATCH' then '0TOTO MATCH'
			when trim(ProdName)='4D Lottery' then '14D'
			when ProdName='SINGAPORE SWEEP' then '2SINGAPORE SWEEP'
			when ProdName='SPORTS' then '3SPORTS'
			when ProdName='HORSE RACING' then '4HORSE RACING'
			when ProdName='Funding and Recovery' then '5Funding and Recovery'
			when ProdName='Online Adjustment' then '6Online Adjustment'
			when ProdName='Offline Orders' then '7Offline Orders'
			when ProdName='NETS' then '8NETS'
			when ProdName='CASHCARD/Flashpay' then '9CASHCARD/Flashpay'
			when ProdName='PaynowQR [+trans fee]' then '9PaynowQR [+trans fee]'
			when ProdName='Paynow [+trans fee]' then '9Paynow [+trans fee]'
			when ProdName='PaynowQR' then '9PaynowQR'
			when ProdName='Paynow' then '9Paynow'
			else ProdName end ProdName
	  , Amt
	  , case
			when flg= 'COL' then '0Wagers'
			when flg= 'CAN'	then '1Cancel'
			when flg= 'RFD'	then '2Actual Refund'
			when flg= 'RBT'	then '3Rebates'
			when flg= 'PAY'	then '4Win Paid'
			when flg= 'SAL'	then '5Sales Comm'
			when flg= 'GST'	then '6GST'
			when flg= 'FUN'	then '7Funding / Crd Adj'
			when flg= 'REC'	then '8Recovery / Dbt Adj'
			when flg= 'CAS'	then '9Cashless' 
			else flg end Flg
	  , case
			when TrxType= 'CH' then '1Product'
			when TrxType= 'OO' then '2Offline Orders'
			when TrxType= 'CL' then '3Cashless Transactions'
			when TrxType= 'TF' then '4Transaction Fee'
			else TrxType end TrxType
	  , ID_Type
	from (
		select LocTerID ,ProdName
		,sum(case when flg in ('FUN','REC') then 0 else Amt end) Amt
		,Flg,TrxType, 'T'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt
		group by LocTerID ,ProdName,Flg,TrxType
		union all
		select zl.locdisplayid,ProdName,Max(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
		union all 
		select zl.locdisplayid ,ProdName,sum(Amt),Flg,TrxType, 'L'::varchar ID_Type 
		from  temp_ubt_InvoiceRpt a 
			inner join ztubt_terminal zt on (a.LocTerID=zt.terdisplayid)
			inner join ztubt_location zl on (zt.locid=zl.locid)
		where flg not in ('FUN','REC')
		group by zl.locid ,ProdName,Flg,TrxType
	)sq;
	
drop table temp_ubt_InvoiceRpt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicereport_bk20250326(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1281 (class 1255 OID 931782)
-- Name: sp_ubt_getinvoicesummaryreport(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinvoicesummaryreport(infromdate date, intodate date) RETURNS TABLE(description character varying, totalamountdue numeric, type character varying)
    LANGUAGE plpgsql
    AS $$
	declare
	
begin
	create temporary table if not exists ubt_tmp_ResultData(
	Description varchar(100),
	Value numeric(32,11),
	Type varchar(40)
	);

	create temporary table if not exists ubt_tmp_TerProdSumCtAmtInrange( 
	TerDisplayID varchar(100),
	ProductName varchar(100),
	Amount numeric(32,11),
	Ct INT,
	FLAG varchar(3),
	TransType varchar(2),
	FromDate date,
	ToDATE date );

	create temporary table if not exists ubt_tmp_IndependentRetailerData(
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(3),
	TransType varchar(5)
	);

	create temporary table if not exists ubt_tmp_ChainData(
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(5),
	TransType varchar(5),
	CHDisplayID varchar(100),
	CHName varchar(100)
	);
	create temporary table if not exists ubt_tmp_Location(
	LocID int4,--varchar(100),
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(5),
	TransType varchar(5)
	);

insert
	into
	ubt_tmp_TerProdSumCtAmtInrange
select
	terdisplayid,
	prodname,
	amount,
	ticketcount ,
	FLAG,
	TransType,
	InFromdate as FromDate,
	inToDate as InToDate
from
	public.sp_ubt_gettransamountdetails(InFromdate,
	InTodate);

	insert
	into
	ubt_tmp_Location
select
	loc.locid,
	tpa.ProductName,
	max(tpa.amount),
	tpa.FLAG,
	tpa.TransType
from
	ubt_tmp_TerProdSumCtAmtInrange tpa
inner join ztubt_terminal ter on
	tpa.terdisplayid = ter.terdisplayid
inner join ztubt_location loc on
	ter.locid = loc.locID
where
	tpa.FLAG in('FUN', 'REC')
group by
	loc.locid,
	tpa.ProductName,
	tpa.FLAG,
	tpa.TransType;

-- insert all total of amount detail for independent retailer

insert
	into
	ubt_tmp_IndependentRetailerData
select
	tpa.ProductName,
	sum(tpa.amount) as Amount,
	tpa.FLAG,
	tpa.TransType
from
	ubt_tmp_TerProdSumCtAmtInrange tpa
inner join ztubt_terminal ter on
	tpa.terdisplayid = ter.terdisplayid
inner join ztubt_location loc on
	ter.locid = loc.locid
left join ztubt_retailer ret on
	loc.retid = ret.retid
where
	loc.loctypeid = 4
	and tpa.FLAG not in('FUN', 'REC')
group by
	tpa.ProductName,
	tpa.FLAG,
	tpa.TransType;


insert into ubt_tmp_IndependentRetailerData
select lot.ProductName, sum(lot.amount)as Amount,
lot.FLAG,Lot.TransType
from ubt_tmp_Location lot 
inner join ztubt_location loc on lot.locid=loc.locid 
left join ztubt_retailer ret on loc.retid=ret.retid 
where loc.loctypeid=4 
group by lot.ProductName, lot.FLAG,lot.TransType;

insert into ubt_tmp_ResultData 
select 'Independent Retailer' as description,
 coalesce (sum(case when FLAG='COL' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='RFD' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='CAN' then coalesce(Amount,0)
 when FLAG='PAY' then coalesce(Amount,0)
 when FLAG='SAL' then coalesce(Amount,0)
 when FLAG='GST' then coalesce(Amount,0)
 when FLAG='RBT' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Online Adjustment' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Online Adjustment' then coalesce(Amount,0)
end)-
sum(case when FLAG='CAS' then coalesce(amount,0)end),0) as Amount,
'1Independent Retailers' as Type
from ubt_tmp_IndependentRetailerData;

insert into ubt_tmp_ChainData
select tpa.ProductName, SUM(Amount) as Amount,FLAG, TransType,CHN.chdisplayid,CHN.chname
from ztubt_chain chn 
inner join ztubt_location loc on chn.chid=loc.chid 
inner join ztubt_terminal ter on loc.locid=ter.locid 
inner join ubt_tmp_TerProdSumCtAmtInrange tpa on tpa.terdisplayid=ter.terdisplayid
where tpa.FLAG not in('FUN','REC')
group by tpa.ProductName, tpa.FLAG, tpa.TransType,chn.chdisplayid ,chn.chname;

insert into ubt_tmp_ChainData
select ProductName, sum(Amount)as Amount, FLAG, TransType,chn.chdisplayid,chn.chname
from ubt_tmp_Location lot 
inner join  ztubt_location loc on lot.locid=loc.locid 
inner join ztubt_chain chn on chn.chid=loc.chid 
group by ProductName,FLAG,TransType,chn.chdisplayid,chn.chname;

insert into ubt_tmp_ResultData 
select tcd.chname,
 sum(case when FLAG='COL' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='RFD' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='CAN' then coalesce(Amount,0)
 when FLAG='PAY' then coalesce(Amount,0)
 when FLAG='SAL' then coalesce(Amount,0)
 when FLAG='GST' then coalesce(Amount,0)
 when FLAG='RBT' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Online Adjustment' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Online Adjustment' then coalesce(Amount,0)
end)-
sum(case when FLAG='CAS' then coalesce(amount,0)
 end) as Amount,
'2ALL Chains (Retailers and Branches)' as Type
from ubt_tmp_ChainData tcd
inner join ztubt_chain chn on chn.chdisplayID=tcd.chdisplayid
group by tcd.chdisplayid,tcd.chname;

insert into ubt_tmp_ResultData
select ProductName, sum(Amount),'3Cashless Summary'
from ubt_tmp_TerProdSumCtAmtInrange
where FLAG='CAS' and ProductName not in ('Paynow','PaynowQR') -- not in transtype=TF : transaction fee
group by ProductName;

insert into ubt_tmp_ResultData
select ProductName, sum(Amount),'4Transaction Fee'
from ubt_tmp_TerProdSumCtAmtInrange
where FLAG='CAS' and ProductName in ('Paynow','PaynowQR') -- transaction fee
group by ProductName;

return query
select rd.description, rd.value, rd.type
from ubt_tmp_ResultData rd;

drop table if exists ubt_tmp_Location;
drop table if exists ubt_tmp_ResultData;
drop table if exists ubt_tmp_TerProdSumCtAmtInrange;
drop table if exists ubt_tmp_IndependentRetailerData;
drop table if exists ubt_tmp_ChainData;
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicesummaryreport(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1141 (class 1255 OID 24783)
-- Name: sp_ubt_getinvoicesummaryreport_bk20240314(date, date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getinvoicesummaryreport_bk20240314(infromdate date, intodate date) RETURNS TABLE(description character varying, totalamountdue numeric, type character varying)
    LANGUAGE plpgsql
    AS $$
	declare
	
begin
	create temporary table if not exists ubt_tmp_ResultData(
	Description varchar(100),
	Value numeric(32,11),
	Type varchar(40)
	);

	create temporary table if not exists ubt_tmp_TerProdSumCtAmtInrange( 
	TerDisplayID varchar(100),
	ProductName varchar(100),
	Amount numeric(32,11),
	Ct INT,
	FLAG varchar(3),
	TransType varchar(2),
	FromDate date,
	ToDATE date );

	create temporary table if not exists ubt_tmp_IndependentRetailerData(
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(3),
	TransType varchar(5)
	);

	create temporary table if not exists ubt_tmp_ChainData(
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(5),
	TransType varchar(5),
	CHDisplayID varchar(100),
	CHName varchar(100)
	);
	create temporary table if not exists ubt_tmp_Location(
	LocID int4,--varchar(100),
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(5),
	TransType varchar(5)
	);

insert
	into
	ubt_tmp_TerProdSumCtAmtInrange
select
	terdisplayid,
	prodname,
	amount,
	ticketcount ,
	FLAG,
	TransType,
	InFromdate as FromDate,
	inToDate as InToDate
from
	public.sp_ubt_gettransamountdetails (InFromdate,
	InTodate);

	insert
	into
	ubt_tmp_Location
select
	loc.locid,
	tpa.ProductName,
	max(tpa.amount),
	tpa.FLAG,
	tpa.TransType
from
	ubt_tmp_TerProdSumCtAmtInrange tpa
inner join ztubt_terminal ter on
	tpa.terdisplayid = ter.terdisplayid
inner join ztubt_location loc on
	ter.locid = loc.locID
where
	tpa.FLAG in('FUN', 'REC')
group by
	loc.locid,
	tpa.ProductName,
	tpa.FLAG,
	tpa.TransType;

-- insert all total of amount detail for independent retailer

insert
	into
	ubt_tmp_IndependentRetailerData
select
	tpa.ProductName,
	sum(tpa.amount) as Amount,
	tpa.FLAG,
	tpa.TransType
from
	ubt_tmp_TerProdSumCtAmtInrange tpa
inner join ztubt_terminal ter on
	tpa.terdisplayid = ter.terdisplayid
inner join ztubt_location loc on
	ter.locid = loc.locid
left join ztubt_retailer ret on
	loc.retid = ret.retid
where
	loc.loctypeid = 4
	and tpa.FLAG not in('FUN', 'REC')
group by
	tpa.ProductName,
	tpa.FLAG,
	tpa.TransType;


insert into ubt_tmp_IndependentRetailerData
select lot.ProductName, sum(lot.amount)as Amount,
lot.FLAG,Lot.TransType
from ubt_tmp_Location lot 
inner join ztubt_location loc on lot.locid=loc.locid 
left join ztubt_retailer ret on loc.retid=ret.retid 
where loc.loctypeid=4 
group by lot.ProductName, lot.FLAG,lot.TransType;

insert into ubt_tmp_ResultData 
select 'Independent Retailer' as description,
 coalesce (sum(case when FLAG='COL' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='RFD' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='CAN' then coalesce(Amount,0)
 when FLAG='PAY' then coalesce(Amount,0)
 when FLAG='SAL' then coalesce(Amount,0)
 when FLAG='GST' then coalesce(Amount,0)
 when FLAG='RBT' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Online Adjustment' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Online Adjustment' then coalesce(Amount,0)
end)-
sum(case when FLAG='CAS' then coalesce(amount,0)end),0) as Amount,
'1Independent Retailers' as Type
from ubt_tmp_IndependentRetailerData;

insert into ubt_tmp_ChainData
select tpa.ProductName, SUM(Amount) as Amount,FLAG, TransType,CHN.chdisplayid,CHN.chname
from ztubt_chain chn 
inner join ztubt_location loc on chn.chid=loc.chid 
inner join ztubt_terminal ter on loc.locid=ter.locid 
inner join ubt_tmp_TerProdSumCtAmtInrange tpa on tpa.terdisplayid=ter.terdisplayid
where tpa.FLAG not in('FUN','REC')
group by tpa.ProductName, tpa.FLAG, tpa.TransType,chn.chdisplayid ,chn.chname;

insert into ubt_tmp_ChainData
select ProductName, sum(Amount)as Amount, FLAG, TransType,chn.chdisplayid,chn.chname
from ubt_tmp_Location lot 
inner join  ztubt_location loc on lot.locid=loc.locid 
inner join ztubt_chain chn on chn.chid=loc.chid 
group by ProductName,FLAG,TransType,chn.chdisplayid,chn.chname;

insert into ubt_tmp_ResultData 
select tcd.chname,
 sum(case when FLAG='COL' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='RFD' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='CAN' then coalesce(Amount,0)
 when FLAG='PAY' then coalesce(Amount,0)
 when FLAG='SAL' then coalesce(Amount,0)
 when FLAG='GST' then coalesce(Amount,0)
 when FLAG='RBT' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Online Adjustment' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Online Adjustment' then coalesce(Amount,0)
end)-
sum(case when FLAG='CAS' then coalesce(amount,0)
 end) as Amount,
'2ALL Chains (Retailers and Branches)' as Type
from ubt_tmp_ChainData tcd
inner join ztubt_chain chn on chn.chdisplayID=tcd.chdisplayid
group by tcd.chdisplayid,tcd.chname;

insert into ubt_tmp_ResultData
select ProductName, sum(Amount),'3Cashless Summary'
from ubt_tmp_TerProdSumCtAmtInrange
where FLAG='CAS'
group by ProductName;

return query
select rd.description, rd.value, rd.type
from ubt_tmp_ResultData rd;

drop table if exists ubt_tmp_Location;
drop table if exists ubt_tmp_ResultData;
drop table if exists ubt_tmp_TerProdSumCtAmtInrange;
drop table if exists ubt_tmp_IndependentRetailerData;
drop table if exists ubt_tmp_ChainData;
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicesummaryreport_bk20240314(infromdate date, intodate date) OWNER TO consultant01;

--
-- TOC entry 1304 (class 1255 OID 2042277)
-- Name: sp_ubt_getinvoicesummaryreport_testorg(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getinvoicesummaryreport_testorg(infromdate date, intodate date) RETURNS TABLE(description character varying, totalamountdue numeric, type character varying)
    LANGUAGE plpgsql
    AS $$
	declare
	
begin
	create temporary table if not exists ubt_tmp_ResultData(
	Description varchar(100),
	Value numeric(32,11),
	Type varchar(40)
	);

	create temporary table if not exists ubt_tmp_TerProdSumCtAmtInrange( 
	TerDisplayID varchar(100),
	ProductName varchar(100),
	Amount numeric(32,11),
	Ct INT,
	FLAG varchar(3),
	TransType varchar(2),
	FromDate date,
	ToDATE date );

	create temporary table if not exists ubt_tmp_IndependentRetailerData(
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(3),
	TransType varchar(5)
	);

	create temporary table if not exists ubt_tmp_ChainData(
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(5),
	TransType varchar(5),
	CHDisplayID varchar(100),
	CHName varchar(100)
	);
	create temporary table if not exists ubt_tmp_Location(
	LocID int4,--varchar(100),
	ProductName varchar(100),
	Amount numeric(32,11),
	FLAG varchar(5),
	TransType varchar(5)
	);

insert
	into
	ubt_tmp_TerProdSumCtAmtInrange
select
	terdisplayid,
	prodname,
	amount,
	ticketcount ,
	FLAG,
	TransType,
	InFromdate as FromDate,
	inToDate as InToDate
from
	public.sp_ubt_gettransamountdetails_testorg(InFromdate,
	InTodate);

	insert
	into
	ubt_tmp_Location
select
	loc.locid,
	tpa.ProductName,
	max(tpa.amount),
	tpa.FLAG,
	tpa.TransType
from
	ubt_tmp_TerProdSumCtAmtInrange tpa
inner join ztubt_terminal ter on
	tpa.terdisplayid = ter.terdisplayid
inner join ztubt_location loc on
	ter.locid = loc.locID
where
	tpa.FLAG in('FUN', 'REC')
group by
	loc.locid,
	tpa.ProductName,
	tpa.FLAG,
	tpa.TransType;

-- insert all total of amount detail for independent retailer

insert
	into
	ubt_tmp_IndependentRetailerData
select
	tpa.ProductName,
	sum(tpa.amount) as Amount,
	tpa.FLAG,
	tpa.TransType
from
	ubt_tmp_TerProdSumCtAmtInrange tpa
inner join ztubt_terminal ter on
	tpa.terdisplayid = ter.terdisplayid
inner join ztubt_location loc on
	ter.locid = loc.locid
left join ztubt_retailer ret on
	loc.retid = ret.retid
where
	loc.loctypeid = 4
	and tpa.FLAG not in('FUN', 'REC')
group by
	tpa.ProductName,
	tpa.FLAG,
	tpa.TransType;


insert into ubt_tmp_IndependentRetailerData
select lot.ProductName, sum(lot.amount)as Amount,
lot.FLAG,Lot.TransType
from ubt_tmp_Location lot 
inner join ztubt_location loc on lot.locid=loc.locid 
left join ztubt_retailer ret on loc.retid=ret.retid 
where loc.loctypeid=4 
group by lot.ProductName, lot.FLAG,lot.TransType;

insert into ubt_tmp_ResultData 
select 'Independent Retailer' as description,
 coalesce (sum(case when FLAG='COL' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='RFD' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='CAN' then coalesce(Amount,0)
 when FLAG='PAY' then coalesce(Amount,0)
 when FLAG='SAL' then coalesce(Amount,0)
 when FLAG='GST' then coalesce(Amount,0)
 when FLAG='RBT' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Online Adjustment' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Online Adjustment' then coalesce(Amount,0)
end)-
sum(case when FLAG='CAS' then coalesce(amount,0)end),0) as Amount,
'1Independent Retailers' as Type
from ubt_tmp_IndependentRetailerData;

insert into ubt_tmp_ChainData
select tpa.ProductName, SUM(Amount) as Amount,FLAG, TransType,CHN.chdisplayid,CHN.chname
from ztubt_chain chn 
inner join ztubt_location loc on chn.chid=loc.chid 
inner join ztubt_terminal ter on loc.locid=ter.locid 
inner join ubt_tmp_TerProdSumCtAmtInrange tpa on tpa.terdisplayid=ter.terdisplayid
where tpa.FLAG not in('FUN','REC')
group by tpa.ProductName, tpa.FLAG, tpa.TransType,chn.chdisplayid ,chn.chname;

insert into ubt_tmp_ChainData
select ProductName, sum(Amount)as Amount, FLAG, TransType,chn.chdisplayid,chn.chname
from ubt_tmp_Location lot 
inner join  ztubt_location loc on lot.locid=loc.locid 
inner join ztubt_chain chn on chn.chid=loc.chid 
group by ProductName,FLAG,TransType,chn.chdisplayid,chn.chname;

insert into ubt_tmp_ResultData 
select tcd.chname,
 sum(case when FLAG='COL' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='RFD' and TransType <> 'OO' then coalesce(Amount,0)
 when FLAG='CAN' then coalesce(Amount,0)
 when FLAG='PAY' then coalesce(Amount,0)
 when FLAG='SAL' then coalesce(Amount,0)
 when FLAG='GST' then coalesce(Amount,0)
 when FLAG='RBT' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Funding and Recovery' then coalesce(Amount,0)
 when FLAG='FUN' and  ProductName='Online Adjustment' then coalesce(Amount,0)
 when FLAG='REC' and  ProductName='Online Adjustment' then coalesce(Amount,0)
end)-
sum(case when FLAG='CAS' then coalesce(amount,0)
 end) as Amount,
'2ALL Chains (Retailers and Branches)' as Type
from ubt_tmp_ChainData tcd
inner join ztubt_chain chn on chn.chdisplayID=tcd.chdisplayid
group by tcd.chdisplayid,tcd.chname;

insert into ubt_tmp_ResultData
select ProductName, sum(Amount),'3Cashless Summary'
from ubt_tmp_TerProdSumCtAmtInrange
where FLAG='CAS' and ProductName not in ('Paynow','PaynowQR') -- not in transtype=TF : transaction fee
group by ProductName;

insert into ubt_tmp_ResultData
select ProductName, sum(Amount),'4Transaction Fee'
from ubt_tmp_TerProdSumCtAmtInrange
where FLAG='CAS' and ProductName in ('Paynow','PaynowQR') -- transaction fee
group by ProductName;

return query
select rd.description, rd.value, rd.type
from ubt_tmp_ResultData rd;

drop table if exists ubt_tmp_Location;
drop table if exists ubt_tmp_ResultData;
drop table if exists ubt_tmp_TerProdSumCtAmtInrange;
drop table if exists ubt_tmp_IndependentRetailerData;
drop table if exists ubt_tmp_ChainData;
end;
$$;


ALTER FUNCTION public.sp_ubt_getinvoicesummaryreport_testorg(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1222 (class 1255 OID 2386929)
-- Name: sp_ubt_getlocationinvoice(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getlocationinvoice(businessdate date) RETURNS TABLE(locdisplayid character varying, agentinvoice_invid character varying, agentinvoice_finidn character varying, agentinvoice_productid integer, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	vbusinessdate date;
	vinputdate date;
	vstartperiod date;
	vendperiod date;
	vfromdateIGT timestamp;
	vtodateIGT timestamp;
	vfromdatetimeIGT_UTC timestamp;
	vtodatetimeIGT_UTC timestamp;
	vfromdatetimeOB_UTC timestamp;
	vtodatetimeOB_UTC timestamp;
	vfromdatetimeBMCS_UTC timestamp;
	vtodatetimeBMCS_UTC timestamp;
	
	vinvoiceperiodid varchar(100);
	vactualdate date;

	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));
	
	BEGIN	
	select businessdate into  vbusinessdate ;
	select  (vbusinessdate :: date) +  interval '1 DAY' into  vinputdate ;

	select (vbusinessdate :: date) + interval '1 DAY' into  vactualdate ;
	
	
select case when to_char(vinputdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date )- interval '3 day'
else date_trunc('week',vinputdate ::date ) end ,

case when to_char(vinputdate  ::date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date)- interval '1 day'
else date_trunc('week',vinputdate ::date )+ interval '3 day' end 

into  vstartperiod,vendperiod;

select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob,utcfromdatetimebmcs, utctodatetimebmcs

into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
from public.sp_ubt_getcommonubtdates(vstartperiod,vendperiod);

select cast(invoiceperiodid as varchar)
into  vinvoiceperiodid
from public.ztubt_invoiceperiod zi  where startdate=vstartperiod and enddate=vendperiod;



create temp table if not exists ubt_temp_terminal
(
terdisplayid varchar(100),
locid int4
);

create temp table if not exists ubt_temp_location
(
locid int4,
locdisplayid varchar(100),
sweepindicator int4,
loctypeid int4,
isgst bool,
accountnumber varchar(100),
branchid varchar(100),
bankid varchar(100),
locname varchar(100),
isibg bool,
retid int4,
chid int4
);

create temp table if not exists ubt_temp_product
(
ProdID int4,
ProdName varchar(100)
);




insert into ubt_temp_terminal
	select ter.terdisplayid, ter.locid
	from public.ztubt_terminal ter;
	
	insert into ubt_temp_location
	select loc.locid, loc.locdisplayid, loc.sweepindicator,loc.loctypeid,loc.isgst,loc.accountnumber,
	loc.branchid,loc.bankid,loc.locname,loc.isibg,loc.retid,loc.chid	
	from public.ztubt_location loc;
	
	insert into ubt_temp_product
	select pd.prodid, case   pd.prodid when 5 then 'SPORTS' else trim(pd.prodname) end prodname
	from public.ztubt_product pd
	where pd.prodid != 6 ;--(15) remove sports live so that all sports refer to productid = 5 only
	
	insert into ubt_temp_product (prodid, prodname) values (3, 'TOTO MATCH');

--	UPDATE public.ztubt_product SET prodname = 'SPORTS' WHERE ProdID = 5 ;--(15) rename "Sports %" to be "Sports" only
	
	create temp table if not exists ubt_temp_chain
	(
	chid int4,
	chdisplayid varchar(100),
	chname varchar(100)
	);

create temp table if not exists ubt_temp_cancelledbeticket
	(
	ticketserialnumber varchar(500),
	CancelledDate timestamp,
	CancelledAmout numeric(22,2),
	ProdID int4,
	TerDisplayID varchar(100)
	);

	insert into ubt_temp_chain

	select zc.chid, zc.chdisplayid, zc.chname	from public.ztubt_chain zc ;
	
	insert into ubt_temp_cancelledbeticket
	select cb.ticketserialnumber,cb.cancelleddate,cb.cancelledamout,cb.prodid,cb.terdisplayid
	from public.ztubt_cancelledbetticket cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
	on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateigt and vtodateigt ;
	
create index  idx_ubt_cancelledbetticket_tck_prdid_candt on ubt_temp_cancelledbeticket (ticketserialnumber,Prodid, CancelledDate)
;
	
	
	create temp table if not exists ubt_temp_getamounttrans --(12)
(
	ticketserialnumber varchar(500),
	wager numeric(22,2),
	secondwager numeric(22,2),
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2),
	winningamount numeric(22,2) 
);

	INSERT INTO ubt_temp_getamounttrans 
	select * from public.sp_ubt_getamounttransaction(vstartperiod,vendperiod);

create index  idx_ubt_getamounttrans_ticket on ubt_temp_getamounttrans (ticketserialnumber)
;



create temp table if not exists ubt_temp_resultcashlesslocation
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(22, 11),
ct int4
	);
	
	insert into ubt_temp_resultcashlesslocation
	select pd.terdisplayid, 
	case pd.PaymentTypeID  when 'NC' then 'NETS'
	when 	'NN' then 'NETS'
	 when 'NCC' then 'CASHCARD'
	 when 'NFP' then 'Flashpay' end,
	 coalesce(sum(coalesce(pd.paidamount,0)),0), count(distinct pd.paymentdetailid)
from  public.ztubt_paymentdetail  pd 
where pd.paymenttypeid IN ('NC','NN','NCC','NFP')--(7)--nets
and pd.createddate >= vfromdatetimeIGT_UTC 	and pd.createddate < vtodatetimeIGT_UTC --(30)

group by pd.terdisplayid,pd.PaymentTypeID ;

create index  idx_ubt_cashless_terdsplid on ubt_temp_resultcashlesslocation (terdisplayid)
;	
	
	create temp table if not exists ubt_temp_iTotolocation 
	(
TicketSerialNumber VARCHAR(200),
iTotoIndicator bool,
GroupUnitSequence int4,
	bettype int4
	);

	insert into ubt_temp_itotolocation
select distinct ticketserialnumber, itotoindicator, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where (groupunitsequence = 1) or --group toto
 (itotoindicator = true) --itoto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create index  idx_ubt_itotoloc_ticket on ubt_temp_iTotolocation (ticketserialnumber)
;	
	
	create temp table if not exists ubt_temp_groupTotolocation
	(
ticketserialnumber varchar(200),
grouphostid varchar(50),
groupunitsequence int4,
	bettype int4
	);

insert into ubt_temp_grouptotolocation
select distinct ticketserialnumber, grouphostid, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where groupunitsequence is not null --group toto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc );

create index  idx_ubt_grptotoloc_ticket on ubt_temp_groupTotolocation (ticketserialnumber)
;	
-----------------------------------------------------------------

create temp table ubt_temp_pbth as 
select terdisplayid,ticketserialnumber,createddate
from public.ztubt_placedbettransactionheader pbt
where  
	pbt.prodid = 3 
and (pbt.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create temp table if not exists ubt_temp_salesgroupTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);
	

insert into ubt_temp_salesgroupTotolocation (locid, chid, prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100 )--(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, --gb.actualdate, --(10)
	pbth.terdisplayid, 
	--lc.chid,
	3 as prodid, 
	fin.bettype as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1) as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, --(1)sum(coalesce(pbtl.betpriceamount,0))	 as totalamount
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
--from public.ztubt_placedbettransactionheader  pbth
	from ubt_temp_pbth  pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager,
case when can.ticketserialnumber is null then gat.sales else 0 end as sales,
itoto.bettype
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
	(
select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
	
inner join ubt_temp_cancelledbeticket  cb on gat.ticketserialnumber =  cb.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where  
	pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/	

	group by pbth.terdisplayid, (pbth.createddate :: date), fin.bettype--gb.actualdate --(10)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype;
	
create index  idx_ubt_salegrptotoloc_locid_prodid on ubt_temp_salesgroupTotolocation (locid,prodid)
;		

	create temp table if not exists ubt_temp_salesTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	)
;


	INSERT INTO ubt_temp_salesTotolocation(LocID, CHID, ProdID, BetType, WagerTotal, CancelTotal, WagerAmount, SalesAmount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100) --(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, 
	pbth.terdisplayid as terdisplayid,	
	3 as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal,
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
	--from	public.ztubt_placedbettransactionheader pbth
	from ubt_temp_pbth pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager, 
case when can.ticketserialnumber is null then gat.sales else 0 end as sales
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join --(8)
	(
select gat.ticketserialnumber, gat.wager, gat.sales
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
inner join ubt_temp_cancelledbeticket cb on gat.ticketserialnumber = cb.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/
	
	group by pbth.terdisplayid, (pbth.createddate :: date)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype
	;

create index  idx_ubt_saletotoloc_locid_prodid on ubt_temp_salesTotolocation (locid,prodid)
;		

--=================================
--FILL IN TRANS AMOUNT DETAIL DATA
--=================================

create temp table if not exists ubt_temp_transamountdetaildata 
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(32,13),
ct int4,
flag char(3),
transtype char(3),
fromdate date,
todate date
	);

	Insert Into ubt_temp_transamountdetaildata
select 
terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
from public.sp_ubt_gettransamountdetails(vstartperiod,vendperiod);

	/*UPDATE ubt_temp_transamountdetaildata
	SET amount = amount * 100;*/

create index  idx_ubt_transamt_terdisplayid on ubt_temp_transamountdetaildata (terdisplayid)
;	
create index  idx_ubt_transamt_productname on ubt_temp_transamountdetaildata (productname)
;	
create index  idx_ubt_transamt_flag on ubt_temp_transamountdetaildata (flag)
;	
create index  idx_ubt_transamt_transtype on ubt_temp_transamountdetaildata (transtype)
;	
--------------------------------------------------------------------------------------------	
	create temp table if not exists ubt_temp_datalocationinvoice
	(
locdisplayid varchar(200) ,
agentinvoice_invid varchar(100) ,
agentinvoice_finidn varchar(200) ,
agentinvoice_productid int4 ,
sales_type varchar(100) ,
totalcount int4 ,
amount numeric(32, 11),
sub_prod varchar(100)
	) 
	;
 
insert into ubt_temp_datalocationinvoice (locdisplayid, agentinvoice_invid, agentinvoice_finidn, agentinvoice_productid, sales_type, totalcount, amount, sub_prod)
	
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,  
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) 
group by lc.locdisplayid,c.chdisplayid,pr.prodid, a.productname

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
case when a.productname <> 'Gate Admission' then 31	
	 when a.productname = 'Gate Admission' then 99 end as agentinvoice_productid,
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) 	as amount,
'' as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid,case when a.productname <> 'Gate Admission' then 31	
											when a.productname = 'Gate Admission' then 99 end

----------2	AT_CANCELAMT
----------3 AT_VALIDAMT
----------4 AT_VALIDAMT

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.Flag when 'CAN' then '2'
   when 'PAY' then '3'
   when 'RBT' then '4' end as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) * -1	as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('CAN','PAY','RBT') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag, a.productname
	
union all 

-----61	Refund Amount--(5)(6)

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) * -1	as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid, a.productname

--offline orders - refund
	
union all

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
(sum(coalesce(a.amount,0)) * -1) as amount,
'' as sub_prod 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid


union all 
-----6	AT_TAXAMT 
-----7	AT_COMMAMT 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.flag when 'GST' then '6' when 'SAL'then '7' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
(sum(coalesce(a.amount,0)) * -1)as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('GST', 'SAL') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag, a.productname

union all 
------16. AT_FRACVALAMT

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'16'as sales_type,
count(distinct vb.tranheaderid)	as totalcount, --(16) --(1)count(1)as totalcount, 
sum(coalesce(vb.winningamount,0))as totalamount,--(1) sum(coalesce(vb.amount,0))as totalamount
case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
	else 'TOTO MATCH' end as sub_prod
from 
(
	select vb.tranheaderid,vb.winningamount,vb.terdisplayid,vb.createdvalidationdate 
	from public.ztubt_validatedbetticket  vb --(16)
	inner join  public.ztubt_validatedbetticketlifecyclestate  vbt
on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
	where vb.winningamount != 0 and vb.winningamount is not null --(8)
	and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	
)vb
	
inner join
(
	select distinct tranheaderid, grouphostid, groupunitsequence, bettypeid
	from  public.ztubt_toto_placedbettransactionlineitem ztp
) ph on vb.tranheaderid = ph.tranheaderid --(16)

inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid

where ph.groupunitsequence is not null --(16)
group by lc.locdisplayid,c.chdisplayid,
case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
	else 'TOTO MATCH' end
	
----52. House syndicate sales amount

union all 
--TOTO
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
s.prodid as agentinvoice_productid, 
'52'as sales_type, 
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0))	as totalamount,--(1)(coalesce(s.amount,0))	as totalamount
'TOTO' as sub_prod 
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid, s.prodid


-------25. house syndicate sales amount by sales factor [itoto sales by sales factor

union all 
--TOTO
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
3 as agentinvoice_productid,
'25' as sales_type,
sum(coalesce (s.wagertotal,0) - coalesce(s.canceltotal,0))	as totalcount,  --(8)
sum(coalesce(s.salesamount,0)) as totalamount ,
'TOTO' as sub_prod
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid

-----40. GST TAX rate
union all 
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
prd.prodid as agentinvoice_productid,
'40'as sales_type,
0 as totalcount, 
gst.gstrate,
prd.prodname as sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst = True
)lc
cross join 
(
	select prodid, prodname from ubt_temp_product where prodid in (2,3,4) --lottery / es
)prd
cross join
(
	select  gstrate from public.ztubt_gstconfig	a  
	where 
	(vactualdate between effectivefrom and enddate) or (vactualdate >=effectivefrom and enddate is null) 
	limit 1 
)gst

union all 
--------59. House syndicate cancel amount - [iTOTO cancellations
--TOTO
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid, 
'59'as sales_type, 
count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)	as totalcount, 
sum(coalesce(cb.cancelledamout,0))	as totalamount,
'TOTO' as sub_prod
from ubt_temp_cancelledbeticket cb
inner join ubt_temp_iTotolocation itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true
inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cb.prodid = 3  
	and cb.cancelleddate >= vfromdateIGT and cb.cancelleddate < vtodateIGT --(30)

group by lc.locdisplayid,c.chdisplayid

union all 
--------60. Player syndicate sales amount by sales factor 
--TOTO, totomatch
select l.locdisplayid	as locdisplayid ,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
s.prodid	as agentinvoice_productid,
'60'	as sales_type, 
sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))as totalcount, --(8)
sum(coalesce(s.salesamount,0)) as totalamount,
case when s.bettype = 1 then 'TOTO'
	else 'TOTO MATCH' end as sub_prod
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,s.prodid,
	case when s.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end

union all 

---------69. player syndicate sales amount 

--TOTO, totomatch
select	l.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,  
3 as agentinvoice_productid, 
'69'as sales_type,
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0)) as totalamount,
case when s.bettype = 1 then 'TOTO'
	else 'TOTO MATCH' end as sub_prod
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,
	case when s.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end

union all

-----------70 [	 GROUP TOTO Cancel Amount
--TOTO, totomatch
select      lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'70'as sales_type, 
count(distinct gt.grouphostid)	as totalcount,  
sum(coalesce(cbt.cancelledamout,0))	as totalamount,
case when gt.bettype = 1 then 'TOTO'
	else 'TOTO MATCH' end as sub_prod
from ubt_temp_cancelledbeticket cbt
inner join ubt_temp_grouptotolocation gt on cbt.ticketserialnumber = gt.ticketserialnumber
inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cbt.prodid = 3 
and cbt.cancelleddate >= vfromdateIGT and cbt.cancelleddate < vtodateIGT 
group by lc.locdisplayid,c.chdisplayid,
	case when gt.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end

union all
-----------------105 Sales Commision Rate
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission,
'' as sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (2,4) --lottery / es
)sal

union all
--TOTO, totomatch
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission,
sp.sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (3)
)sal
cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp

union all 

--------108 AT_ON_EZLINK--  NETS
----110	AT_ON_ATM--- Flashpay
---112	AT_ON_CASHCARD

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case a.productname when 'NETS' then '108'	
 when 'Flashpay' then '110' when 'CASHCARD' then '112' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
sum(coalesce(a.amount,0)) as amount,
'' as sub_prod
		from	ubt_temp_location as lc 
left join ubt_temp_chain c on lc.chid = c.chid
left join ubt_temp_terminal  as ter on  ter.locid=lc.locid
left join ubt_temp_resultcashlesslocation a on a.terdisplayid = ter.terdisplayid
		where a.productname in ('NETS','Flashpay','CASHCARD')
		group by lc.locdisplayid,c.chdisplayid,a.productname
		
		
union all 
---------116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor

select loc.locdisplayid, vinvoiceperiodid as agentinvoice_invid, ch.chdisplayid, fin.agentinvoice_productid,
'116'	as sales_type, sum(fin.totalcount), (sum(fin.totalamount) * 100),
fin.sub_prod as sub_prod
		from
		(
			select	a.actualdate,
	a.terdisplayid	as terdisplayid,	
	a.prodid	as agentinvoice_productid,	
	sum(coalesce(a.total,0) - coalesce(can.total,0))	as totalcount, --(8)
	round(trunc(sum(coalesce(a.amount,0)) / 100,2), 2)	as totalamount ,
	a.sub_prod
			from
			(
select cast(pb.createddate as date) actualdate, a.ticketserialnumber, 
sum(a.sales + a.secondsales) as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid,
	case pb.prodid
		when 6 then 5 else pb.prodid
		end as prodid, --(15)
		case when pb.prodid <> 3 then ''
			when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
			) then 'TOTO MATCH' 
		else 'TOTO' end as sub_prod
from ubt_temp_getamounttrans a 
inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 

where
pb.iscancelled = false and (
		(
		pb.prodid in (2,3,4) --lottery / es
		and (pb.createddate between vfromdatetimeIGT_UTC and vtodatetimeIGT_UTC )
		
		)
		or --(15)
		(
		pb.prodid in (5,6) --sports / ob
		and (pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC )
		)
		or
		(
		pb.prodid in (1) --horse racing / bmcs
		and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
		)
	)
 
group by pb.createddate , a.ticketserialnumber, pb.terdisplayid, pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
			SELECT 1 
			FROM ztubt_toto_placedbettransactionlineitem pbtlin
			WHERE pb.TranHeaderID = pbtlin.TranHeaderID
				AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
		) then 'TOTO MATCH' 
		else 'TOTO' end
			)a
			
			left join --(8)
			(
select a.ticketserialnumber,0 as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
	pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
			) then 'TOTO MATCH' 
		else 'TOTO' end as sub_prod 
from ubt_temp_getamounttrans a 
inner join ubt_temp_cancelledbeticket cb on a.ticketserialnumber = cb.ticketserialnumber
inner join (select ticketserialnumber,terdisplayid,prodid, TranHeaderID from public.ztubt_placedbettransactionheader)  pb on a.ticketserialnumber = pb.ticketserialnumber
where pb.prodid in (2,3,4) --lottery / es
group by a.ticketserialnumber, pb.terdisplayid, pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
			) then 'TOTO MATCH' 
		else 'TOTO' end
			)can on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid and a.prodid = can.prodid and a.sub_prod = can.sub_prod
		group by a.actualdate, a.terdisplayid, a.prodid , a.sub_prod
		)fin
		
		inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join ubt_temp_chain ch on loc.chid = ch.chid
		group by loc.locdisplayid, ch.chdisplayid, fin.agentinvoice_productid, fin.sub_prod;

/*	update ubt_temp_datalocationinvoice tt
		set totalcount = fin.totalcount
		from (	
			select td2.locdisplayid,td2.agentinvoice_finidn,td2.agentinvoice_productid,td2.totalcount
			from  ubt_temp_datalocationinvoice td2 where td2.sales_type = '7'
		)fin  
		where  tt.locdisplayid = fin.locdisplayid and tt.agentinvoice_finidn = fin.agentinvoice_finidn 
		and tt.sales_type ='116'
	;*/
	
-- [2022-04-05] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation

create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('211801001', 4, 'SWEEP','2021-11-18'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vstartperiod,vendperiod);

create temp table if not exists ubt_temp_sales_scandsr_loc
	(
	LocDisplayID varchar(200),
	AgentInvoice_invId varchar(100),
	AgentInvoice_finidn varchar(200),
	AgentInvoice_productId int4,
	Sales_type varchar(100),
	TotalCount int,
	Amount decimal(32, 11)
	);


Insert into ubt_temp_sales_scandsr_loc
SELECT	LOC.LocDisplayID	as LocDisplayID,
		vinvoiceperiodid			as AgentInvoice_invId,
		CH.CHDisplayID		as AgentInvoice_finidn ,
		RS.ProdID			as AgentInvoice_productId,
		'116'					aS sales_type,
		SUM(RS.TotalCount), 
		SUM(RS.Amount) * 100
FROM ubt_temp_sales_scandsr RS
INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
LEFT JOIN ubt_temp_chain CH ON LOC.CHID = CH.CHID
group by LOC.LocDisplayID,CH.CHDisplayID,CH.CHDisplayID, RS.ProdID;


DELETE FROM ubt_temp_datalocationinvoice SAL  USING ubt_temp_sales_scandsr_loc RSLoc
WHERE RSLoc.LocDisplayID = SAL.LocDisplayID AND RSLoc.AgentInvoice_productId = SAL.AgentInvoice_productId
AND SAL.Sales_type = '116';

INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, sub_prod)
	SELECT	RSLoc.LocDisplayID	as LocDisplayID,
			vinvoiceperiodid			as AgentInvoice_invId,
			RSLoc.AgentInvoice_finidn		as AgentInvoice_finidn ,
			RSLoc.AgentInvoice_productId			as AgentInvoice_productId,
			'116'					as sales_type,
			RSLoc.TotalCount, 
			RSLoc.Amount,
			'' as sub_prod
	FROM ubt_temp_sales_scandsr_loc RSLoc;

-- [2022-04-05] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--------119	AT_SALESFACTOR	
CREATE temp TABLE if not exists ubt_temp_salesfactorconfig 
	(
		prodid int4,
		salesfactor numeric(13,12)
	);

	INSERT INTO ubt_temp_salesfactorconfig 
	select A.ProdID, A.SalesFactor  
	FROM public.ztubt_salescomconfig   A 
	WHERE CommissionType=1  AND A.IsDeleted = false AND ProdID IN (2,3,4);

	
	INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, sub_prod)
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor, ''
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid <> 3
		)sfc

		union all
		--TOTO, totomatch
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor, sp.sub_prod
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid = 3
		)sfc
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp

		union all
--------571	ACT_VALID_FUND_AMT
------572	ACT_RECOVERY_AMT
		
select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case  flag  when 'FUN' then '571' when 'REC' then '572' end sales_type,
0	as totalcount,
(case when flag='FUN' then sum(coalesce(a.amount,0)) * -1
		when flag='REC' then sum(coalesce(a.amount,0)) end)		as amount,
		'' as sub_prod
		from 
		(
			select l.locid, flag, max(a.amount) as amount
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('FUN','REC') AND ProductName = 'Funding and Recovery'
			and l.loctypeid in (2,4) 
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid,c.chdisplayid,flag		

union all 

-------727	ACT_TOTAL_NETAMTDUE	Yes	Net Amt Due

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
--agentinvoice_sales
case  flag  when 'REC' then '-2' when 'FUN' then '-3' end 	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
case  flag  when 'REC' then sum(coalesce(a.amount,0)) when 'FUN' then  (sum(coalesce(a.amount,0))* -1) end as amount,
		'' as sub_prod
		from 
		(
			select l.locid,flag, max(a.amount) as amount, max(a.ct) as ct
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('REC','FUN') and productname = 'Online Adjustment'
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid, c.chdisplayid,flag

	;	
		
		insert into ubt_temp_datalocationinvoice
select	coalesce(db.locdisplayid,cr.locdisplayid)as locdisplayid,
coalesce(db.agentinvoice_invid,cr.agentinvoice_invid)	as agentinvoice_invid,
coalesce(db.agentinvoice_finidn,cr.agentinvoice_finidn)as agentinvoice_finidn ,
0		as agentinvoice_productid,
'727'		as sales_type,
0		as totalcount,
(sum(db.amount) - sum(cr.amount)) as amount,
'' as sub_prod
		from
		(
			select  a.locdisplayid as locdisplayid,
					a.agentinvoice_invid		as agentinvoice_invid, 
					a.agentinvoice_finidn		as agentinvoice_finidn,
					sum(coalesce(a.totalcount,0))			as totalcount,
					sum(coalesce(a.amount,0))as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in
			(
				'2', 		--cancel amount
				'3',		--validation amount
				'7',		--commission amount
				'6', 		-- gst tax amount
				'108', 	--?nets transaction
				'110', 	--?flashpay transaction
				'112', 	--?cashcard transaction
				'571', 	--funding
				'4', 		--rebate
				'61', 	--refund--(6)5, --refund
				'-3' 		-- crd adj
			)		
			-- and agentinvoice_productid != 31 --(15) exclude offline orders in the net amount due calculation
			and agentinvoice_productid not in (31,99)
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn
		) cr
		full outer join 
		(
			select  a.locdisplayid as locdisplayid,
				a.agentinvoice_invid		as agentinvoice_invid, 
				a.agentinvoice_finidn		as agentinvoice_finidn,
				sum(coalesce(a.totalcount,0))as totalcount,
				sum(coalesce(a.amount,0))	as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in('1','572','-2')   --1,	--collection	572, --recovery		-2 --dbt adj
		
			-- and agentinvoice_productid != 31 
			and agentinvoice_productid not in (31,99)
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn	
		) db 
		on db.locdisplayid=cr.locdisplayid and db.agentinvoice_invid=cr.agentinvoice_invid 
		and db.agentinvoice_finidn=cr.agentinvoice_finidn
		group by db.locdisplayid, db.agentinvoice_invid,db.agentinvoice_finidn, 
		cr.locdisplayid, cr.agentinvoice_invid	,cr.agentinvoice_finidn
;

--CLEAR REFUND, REBATE, ADJ, COLLECTION DATA
	DELETE FROM ubt_temp_datalocationinvoice WHERE Sales_type IN('-2', '-3')
	;

-- for both types of toto
INSERT INTO ubt_temp_datalocationinvoice
-- sum totomatch and t649
select LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, sum(TotalCount), sum(Amount), ''
from ubt_temp_datalocationinvoice td
where sub_prod in ('TOTO MATCH', 'TOTO') and Sales_type not in ('40', '119', '105')
group by LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type

union all

-- config - clone totomatch config for product Toto (t649 and totomatch)
select LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, ''
from ubt_temp_datalocationinvoice td
where sub_prod in ('TOTO MATCH') and Sales_type in ('40', '119', '105');

UPDATE ubt_temp_datalocationinvoice td--(12)FinalTempDataLocationInvoice--(1)UPDATE TempDataLocationInvoice
		SET agentinvoice_productid = CASE 
					WHEN td.agentinvoice_productid::int = 3 AND td.sub_prod = 'TOTO' THEN 71
					WHEN td.agentinvoice_productid::int = 3 AND td.sub_prod = 'TOTO MATCH' THEN 66
					ELSE p.SAPProdID
				END
		from public.ztubt_sap_product  p
		where td.agentinvoice_productid = p.prodid 
;


		return query
		SELECT Distinct
			coalesce(LocDisplayID, '') LocDisplayID
			,coalesce(AgentInvoice_invId, '') as AgentInvoice_invId
			,coalesce(AgentInvoice_finidn, '') as AgentInvoice_finidn
			,coalesce(AgentInvoice_productId, 0) as AgentInvoice_productId
			,coalesce(Sales_type, '') as Sales_type
			,TotalCount
			,Amount
		
		FROM ubt_temp_datalocationinvoice
	WHERE (TotalCount!=0 or Amount!=0) AND (coalesce(AgentInvoice_finidn,'') <> '')
			AND AgentInvoice_invId in(  vinvoiceperiodid ) --(4)
			;

drop table ubt_temp_terminal;
drop table ubt_temp_location;
drop table ubt_temp_chain;
drop table ubt_temp_product;
drop table ubt_temp_cancelledbeticket;
drop table ubt_temp_getamounttrans;
drop table ubt_temp_resultcashlesslocation;
drop table ubt_temp_iTotolocation;
drop table	ubt_temp_groupTotolocation;
drop table  ubt_temp_salesgroupTotolocation;
drop table 	ubt_temp_salesTotolocation;
drop table 	ubt_temp_transamountdetaildata;
drop table	ubt_temp_datalocationinvoice;
drop table 	ubt_temp_salesfactorconfig;
drop table ubt_temp_pbth; 
-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
drop table ubt_temp_sales_scandsr;
drop table ubt_temp_sales_scandsr_loc;
	end;
$$;


ALTER FUNCTION public.sp_ubt_getlocationinvoice(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1200 (class 1255 OID 24784)
-- Name: sp_ubt_getlocationinvoice_bk20240704(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getlocationinvoice_bk20240704(businessdate date) RETURNS TABLE(locdisplayid character varying, agentinvoice_invid character varying, agentinvoice_finidn character varying, agentinvoice_productid integer, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	vbusinessdate date;
	vinputdate date;
	vstartperiod date;
	vendperiod date;
	vfromdateIGT timestamp;
	vtodateIGT timestamp;
	vfromdatetimeIGT_UTC timestamp;
	vtodatetimeIGT_UTC timestamp;
	vfromdatetimeOB_UTC timestamp;
	vtodatetimeOB_UTC timestamp;
	vinvoiceperiodid varchar(100);
	vactualdate date;
	
	BEGIN	
	select businessdate into  vbusinessdate ;
	select  (vbusinessdate :: date) +  interval '1 DAY' into  vinputdate ;

	select (vbusinessdate :: date) + interval '1 DAY' into  vactualdate ;
	
	
select case when to_char(vinputdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date )- interval '3 day'
else date_trunc('week',vinputdate ::date ) end ,

case when to_char(vinputdate  ::date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date)- interval '1 day'
else date_trunc('week',vinputdate ::date )+ interval '3 day' end 

into  vstartperiod,vendperiod;

select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob

into 

vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC 
from public.sp_ubt_getcommonubtdates(vstartperiod,vendperiod);

select cast(invoiceperiodid as varchar)
into  vinvoiceperiodid
from public.ztubt_invoiceperiod zi  where startdate=vstartperiod and enddate=vendperiod;



create temp table if not exists ubt_temp_terminal
(
terdisplayid varchar(100),
locid int4
);

create temp table if not exists ubt_temp_location
(
locid int4,
locdisplayid varchar(100),
sweepindicator int4,
loctypeid int4,
isgst bool,
accountnumber varchar(100),
branchid varchar(100),
bankid varchar(100),
locname varchar(100),
isibg bool,
retid int4,
chid int4
);

create temp table if not exists ubt_temp_product
(
ProdID int4,
ProdName varchar(100)
);




insert into ubt_temp_terminal
	select ter.terdisplayid, ter.locid
	from public.ztubt_terminal ter;
	
	insert into ubt_temp_location
	select loc.locid, loc.locdisplayid, loc.sweepindicator,loc.loctypeid,loc.isgst,loc.accountnumber,
	loc.branchid,loc.bankid,loc.locname,loc.isibg,loc.retid,loc.chid	
	from public.ztubt_location loc;
	
	insert into ubt_temp_product
	select pd.prodid, case   pd.prodid when 5 then 'SPORTS' else trim(pd.prodname) end prodname
	from public.ztubt_product pd
	where pd.prodid != 6 ;--(15) remove sports live so that all sports refer to productid = 5 only

--	UPDATE public.ztubt_product SET prodname = 'SPORTS' WHERE ProdID = 5 ;--(15) rename "Sports %" to be "Sports" only
	
	create temp table if not exists ubt_temp_chain
	(
	chid int4,
	chdisplayid varchar(100),
	chname varchar(100)
	);

create temp table if not exists ubt_temp_cancelledbeticket
	(
	ticketserialnumber varchar(500),
	CancelledDate timestamp,
	CancelledAmout numeric(22,2),
	ProdID int4,
	TerDisplayID varchar(100)
	);

	insert into ubt_temp_chain

	select zc.chid, zc.chdisplayid, zc.chname	from public.ztubt_chain zc ;
	
	insert into ubt_temp_cancelledbeticket
	select cb.ticketserialnumber,cb.cancelleddate,cb.cancelledamout,cb.prodid,cb.terdisplayid
	from public.ztubt_cancelledbetticket cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
	on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateigt and vtodateigt ;
	
create index  idx_ubt_cancelledbetticket_tck_prdid_candt on ubt_temp_cancelledbeticket (ticketserialnumber,Prodid, CancelledDate)
;
	
	
	create temp table if not exists ubt_temp_getamounttrans --(12)
(
	ticketserialnumber varchar(500),
	wager numeric(22,2),
	secondwager numeric(22,2),
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2),
	winningamount numeric(22,2) 
);

	INSERT INTO ubt_temp_getamounttrans 
	select * from public.sp_ubt_getamounttransaction(vstartperiod,vendperiod);

create index  idx_ubt_getamounttrans_ticket on ubt_temp_getamounttrans (ticketserialnumber)
;



create temp table if not exists ubt_temp_resultcashlesslocation
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(22, 11),
ct int4
	);
	
	insert into ubt_temp_resultcashlesslocation
	select pd.terdisplayid, 
	case pd.PaymentTypeID  when 'NC' then 'NETS'
	when 	'NN' then 'NETS'
	 when 'NCC' then 'CASHCARD'
	 when 'NFP' then 'Flashpay' end,
	 coalesce(sum(coalesce(pd.paidamount,0)),0), count(distinct pd.paymentdetailid)
from  public.ztubt_paymentdetail  pd 
where pd.paymenttypeid IN ('NC','NN','NCC','NFP')--(7)--nets
and pd.createddate >= vfromdatetimeIGT_UTC 	and pd.createddate < vtodatetimeIGT_UTC --(30)

group by pd.terdisplayid,pd.PaymentTypeID ;

create index  idx_ubt_cashless_terdsplid on ubt_temp_resultcashlesslocation (terdisplayid)
;	
	
	create temp table if not exists ubt_temp_iTotolocation 
	(
TicketSerialNumber VARCHAR(200),
iTotoIndicator bool,
GroupUnitSequence int4
	);

	insert into ubt_temp_itotolocation
select distinct ticketserialnumber, itotoindicator, groupunitsequence
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where (groupunitsequence = 1) or --group toto
 (itotoindicator = true) --itoto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create index  idx_ubt_itotoloc_ticket on ubt_temp_iTotolocation (ticketserialnumber)
;	
	
	create temp table if not exists ubt_temp_groupTotolocation
	(
ticketserialnumber varchar(200),
grouphostid varchar(50),
groupunitsequence int4
	);

insert into ubt_temp_grouptotolocation
select distinct ticketserialnumber, grouphostid, groupunitsequence
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where groupunitsequence is not null --group toto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc );

create index  idx_ubt_grptotoloc_ticket on ubt_temp_groupTotolocation (ticketserialnumber)
;	
-----------------------------------------------------------------

create temp table ubt_temp_pbth as 
select terdisplayid,ticketserialnumber,createddate
from public.ztubt_placedbettransactionheader pbt
where  
	pbt.prodid = 3 
and (pbt.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create temp table if not exists ubt_temp_salesgroupTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);
	

insert into ubt_temp_salesgroupTotolocation (locid, chid, prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100 )--(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, --gb.actualdate, --(10)
	pbth.terdisplayid, 
	--lc.chid,
	3 as prodid, 
	1 as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1) as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, --(1)sum(coalesce(pbtl.betpriceamount,0))	 as totalamount
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
--from public.ztubt_placedbettransactionheader  pbth
	from ubt_temp_pbth  pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager,
case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
	(
select gat.ticketserialnumber, gat.wager, gat.sales 
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
	
inner join ubt_temp_cancelledbeticket  cb on gat.ticketserialnumber =  cb.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where  
	pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/	

	group by pbth.terdisplayid, (pbth.createddate :: date) --gb.actualdate --(10)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype;
	
create index  idx_ubt_salegrptotoloc_locid_prodid on ubt_temp_salesgroupTotolocation (locid,prodid)
;		

	create temp table if not exists ubt_temp_salesTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	)
;


	INSERT INTO ubt_temp_salesTotolocation(LocID, CHID, ProdID, BetType, WagerTotal, CancelTotal, WagerAmount, SalesAmount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100) --(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, 
	pbth.terdisplayid as terdisplayid,	
	3 as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal,
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
	--from	public.ztubt_placedbettransactionheader pbth
	from ubt_temp_pbth pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager, 
case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join --(8)
	(
select gat.ticketserialnumber, gat.wager, gat.sales 
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
inner join ubt_temp_cancelledbeticket cb on gat.ticketserialnumber = cb.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/
	
	group by pbth.terdisplayid, (pbth.createddate :: date)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype
	;

create index  idx_ubt_saletotoloc_locid_prodid on ubt_temp_salesTotolocation (locid,prodid)
;		

--=================================
--FILL IN TRANS AMOUNT DETAIL DATA
--=================================

create temp table if not exists ubt_temp_transamountdetaildata 
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(32,13),
ct int4,
flag char(3),
transtype char(3),
fromdate date,
todate date
	);

	Insert Into ubt_temp_transamountdetaildata
select 
terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
from public.sp_ubt_gettransamountdetails (vstartperiod,vendperiod);

	/*UPDATE ubt_temp_transamountdetaildata
	SET amount = amount * 100;*/

create index  idx_ubt_transamt_terdisplayid on ubt_temp_transamountdetaildata (terdisplayid)
;	
create index  idx_ubt_transamt_productname on ubt_temp_transamountdetaildata (productname)
;	
create index  idx_ubt_transamt_flag on ubt_temp_transamountdetaildata (flag)
;	
create index  idx_ubt_transamt_transtype on ubt_temp_transamountdetaildata (transtype)
;	
--------------------------------------------------------------------------------------------	
	create temp table if not exists ubt_temp_datalocationinvoice
	(
locdisplayid varchar(200) ,
agentinvoice_invid varchar(100) ,
agentinvoice_finidn varchar(200) ,
agentinvoice_productid int4 ,
sales_type varchar(100) ,
totalcount int4 ,
amount numeric(32, 11) 
	) 
	;
 
insert into ubt_temp_datalocationinvoice (locdisplayid, agentinvoice_invid, agentinvoice_finidn, agentinvoice_productid, sales_type, totalcount, amount)
	
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,  
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype != 'OO' and pr.prodid in (2,3,4,5) 
group by lc.locdisplayid,c.chdisplayid,pr.prodid

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) 	as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid

----------2	AT_CANCELAMT
----------3 AT_VALIDAMT
----------4 AT_VALIDAMT

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.Flag when 'CAN' then '2'
   when 'PAY' then '3'
   when 'RBT' then '4' end as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) * -1	as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('CAN','PAY','RBT') and pr.prodid in (2,3,4,5) --(15)add sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag
	
union all 

-----61	Refund Amount--(5)(6)

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) * -1	as amount  
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype != 'OO' and pr.prodid in (2,3,4,5) --(15)add sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid

--offline orders - refund
	
union all

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
(sum(coalesce(a.amount,0)) * -1) as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid


union all 
-----6	AT_TAXAMT 
-----7	AT_COMMAMT 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.flag when 'GST' then '6' when 'SAL'then '7' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
(sum(coalesce(a.amount,0)) * -1)as amount  
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('GST', 'SAL') and pr.prodid in (2,3,4,5) --(15)add sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by 	lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag


union all 
------16. AT_FRACVALAMT

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'16'as sales_type,
count(distinct vb.tranheaderid)	as totalcount, --(16) --(1)count(1)as totalcount, 
sum(coalesce(vb.winningamount,0))as totalamount--(1) sum(coalesce(vb.amount,0))as totalamount
from 
(
	select vb.tranheaderid,vb.winningamount,vb.terdisplayid,vb.createdvalidationdate 
	from public.ztubt_validatedbetticket  vb --(16)
	inner join  public.ztubt_validatedbetticketlifecyclestate  vbt
on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
	where vb.winningamount != 0 and vb.winningamount is not null --(8)
	and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	
)vb
	
inner join
(
	select distinct tranheaderid, grouphostid, groupunitsequence 
	from  public.ztubt_toto_placedbettransactionlineitem ztp  
) ph on vb.tranheaderid = ph.tranheaderid --(16)

inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid

where ph.groupunitsequence is not null --(16)
group by lc.locdisplayid,c.chdisplayid

----52. House syndicate sales amount

union all 

select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
s.prodid as agentinvoice_productid, 
'52'as sales_type, 
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0))	as totalamount--(1)(coalesce(s.amount,0))	as totalamount
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid, s.prodid


-------25. house syndicate sales amount by sales factor [itoto sales by sales factor

union all 
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
3 as agentinvoice_productid,
'25' as sales_type,
sum(coalesce (s.wagertotal,0) - coalesce(s.canceltotal,0))	as totalcount,  --(8)
sum(coalesce(s.salesamount,0)) as totalamount 
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid

-----40. GST TAX rate
union all 
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
prd.prodid as agentinvoice_productid,
'40'as sales_type,
0 as totalcount, 
gst.gstrate
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst = True
)lc
cross join 
(
	select prodid from ubt_temp_product where prodid in (2,3,4) --lottery / es
)prd
cross join
(
	select  gstrate from public.ztubt_gstconfig	a  
	where 
	(vactualdate between effectivefrom and enddate) or (vactualdate >=effectivefrom and enddate is null) 
	limit 1 
)gst

union all 
--------59. House syndicate cancel amount - [iTOTO cancellations

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid, 
'59'as sales_type, 
count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)	as totalcount, 
sum(coalesce(cb.cancelledamout,0))	as totalamount
from ubt_temp_cancelledbeticket cb
inner join ubt_temp_iTotolocation itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true
inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cb.prodid = 3  
	and cb.cancelleddate >= vfromdateIGT and cb.cancelleddate < vtodateIGT --(30)

group by lc.locdisplayid,c.chdisplayid	

union all 
--------60. Player syndicate sales amount by sales factor 

select l.locdisplayid	as locdisplayid ,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
s.prodid	as agentinvoice_productid,
'60'	as sales_type, 
sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))as totalcount, --(8)
sum(coalesce(s.salesamount,0)) as totalamount 
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,s.prodid 

union all 

---------69. player syndicate sales amount 

select	l.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,  
3 as agentinvoice_productid, 
'69'as sales_type,
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0)) as totalamount
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid

union all

-----------70 [	 GROUP TOTO Cancel Amount

select      lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'70'as sales_type, 
count(distinct gt.grouphostid)	as totalcount,  
sum(coalesce(cbt.cancelledamout,0))	as totalamount
from ubt_temp_cancelledbeticket cbt
inner join ubt_temp_grouptotolocation gt on cbt.ticketserialnumber = gt.ticketserialnumber
inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cbt.prodid = 3 
and cbt.cancelleddate >= vfromdateIGT and cbt.cancelleddate < vtodateIGT 

group by lc.locdisplayid,c.chdisplayid

union all
-----------------105 Sales Commision Rate

select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (2,3,4) --lottery / es
)sal

union all 

--------108 AT_ON_EZLINK--  NETS
----110	AT_ON_ATM--- Flashpay
---112	AT_ON_CASHCARD

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case a.productname when 'NETS' then '108'	
 when 'Flashpay' then '110' when 'CASHCARD' then '112' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
sum(coalesce(a.amount,0))	as amount 
		from	ubt_temp_location as lc 
left join ubt_temp_chain c on lc.chid = c.chid
left join ubt_temp_terminal  as ter on  ter.locid=lc.locid
left join ubt_temp_resultcashlesslocation a on a.terdisplayid = ter.terdisplayid
		where a.productname in ('NETS','Flashpay','CASHCARD')
		group by lc.locdisplayid,c.chdisplayid,a.productname
		
		
union all 
---------116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor

select loc.locdisplayid, vinvoiceperiodid as agentinvoice_invid, ch.chdisplayid, fin.agentinvoice_productid,
'116'	as sales_type, sum(fin.totalcount), (sum(fin.totalamount) * 100) 
		from
		(
			select	a.actualdate,
	a.terdisplayid	as terdisplayid,	
	a.prodid	as agentinvoice_productid,	
	sum(coalesce(a.total,0) - coalesce(can.total,0))	as totalcount, --(8)
	round(trunc(sum(coalesce(a.amount,0)) / 100,2), 2)	as totalamount 
	
			from
			(
select cast(pb.createddate as date) actualdate, a.ticketserialnumber, 
sum(a.sales + a.secondsales) as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid,
	case pb.prodid
		when 6 then 5 else pb.prodid
		end as prodid --(15)
from ubt_temp_getamounttrans a 
inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 

where
pb.iscancelled = false and (
		(
		pb.prodid in (2,3,4) --lottery / es
		and (pb.createddate between vfromdatetimeIGT_UTC and vtodatetimeIGT_UTC )
		
		)
		or --(15)
		(
		pb.prodid in (5,6) --sports / ob
		and (pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC )
		)
	)
 
group by pb.createddate , a.ticketserialnumber, pb.terdisplayid, pb.prodid
			)a
			
			left join --(8)
			(
select a.ticketserialnumber,0 as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
pb.prodid
from ubt_temp_getamounttrans a 
inner join ubt_temp_cancelledbeticket cb on a.ticketserialnumber = cb.ticketserialnumber
inner join (select ticketserialnumber,terdisplayid,prodid from public.ztubt_placedbettransactionheader)  pb on a.ticketserialnumber = pb.ticketserialnumber
where pb.prodid in (2,3,4) --lottery / es
group by a.ticketserialnumber, pb.terdisplayid, pb.prodid
			)can on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid and a.prodid = can.prodid
		group by a.actualdate,		a.terdisplayid, a.prodid 
		)fin
		
		inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join ubt_temp_chain ch on loc.chid = ch.chid
		group by loc.locdisplayid, ch.chdisplayid, fin.agentinvoice_productid;

		
	 
/*	update ubt_temp_datalocationinvoice tt
		set totalcount = fin.totalcount
		from (	
			select td2.locdisplayid,td2.agentinvoice_finidn,td2.agentinvoice_productid,td2.totalcount
			from  ubt_temp_datalocationinvoice td2 where td2.sales_type = '7'
		)fin  
		where  tt.locdisplayid = fin.locdisplayid and tt.agentinvoice_finidn = fin.agentinvoice_finidn 
		and tt.sales_type ='116'
	;*/
	
-- [2022-04-05] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation

create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('211801001', 4, 'SWEEP','2021-11-18'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vstartperiod,vendperiod);

create temp table if not exists ubt_temp_sales_scandsr_loc
	(
	LocDisplayID varchar(200),
	AgentInvoice_invId varchar(100),
	AgentInvoice_finidn varchar(200),
	AgentInvoice_productId int4,
	Sales_type varchar(100),
	TotalCount int,
	Amount decimal(32, 11)
	);


Insert into ubt_temp_sales_scandsr_loc
SELECT	LOC.LocDisplayID	as LocDisplayID,
		vinvoiceperiodid			as AgentInvoice_invId,
		CH.CHDisplayID		as AgentInvoice_finidn ,
		RS.ProdID			as AgentInvoice_productId,
		'116'					aS sales_type,
		SUM(RS.TotalCount), 
		SUM(RS.Amount) * 100
FROM ubt_temp_sales_scandsr RS
INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
LEFT JOIN ubt_temp_chain CH ON LOC.CHID = CH.CHID
group by LOC.LocDisplayID,CH.CHDisplayID,CH.CHDisplayID, RS.ProdID;


DELETE FROM ubt_temp_datalocationinvoice SAL  USING ubt_temp_sales_scandsr_loc RSLoc
WHERE RSLoc.LocDisplayID = SAL.LocDisplayID AND RSLoc.AgentInvoice_productId = SAL.AgentInvoice_productId
AND SAL.Sales_type = '116';

INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount)
	SELECT	RSLoc.LocDisplayID	as LocDisplayID,
			vinvoiceperiodid			as AgentInvoice_invId,
			RSLoc.AgentInvoice_finidn		as AgentInvoice_finidn ,
			RSLoc.AgentInvoice_productId			as AgentInvoice_productId,
			'116'					as sales_type,
			RSLoc.TotalCount, 
			RSLoc.Amount
	FROM ubt_temp_sales_scandsr_loc RSLoc;

-- [2022-04-05] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--------119	AT_SALESFACTOR	
CREATE temp TABLE if not exists ubt_temp_salesfactorconfig 
	(
		prodid int4,
		salesfactor numeric(13,12)
	);

	INSERT INTO ubt_temp_salesfactorconfig 
	select A.ProdID, A.SalesFactor  
	FROM public.ztubt_salescomconfig   A 
	WHERE CommissionType=1  AND A.IsDeleted = false AND ProdID IN (2,3,4);

	
	INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount)
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc
		)sfc

		union all
--------571	ACT_VALID_FUND_AMT
------572	ACT_RECOVERY_AMT
		
select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case  flag  when 'FUN' then '571' when 'REC' then '572' end sales_type,
0	as totalcount,
(case when flag='FUN' then sum(coalesce(a.amount,0)) * -1
		when flag='REC' then sum(coalesce(a.amount,0)) end)		as amount 
		from 
		(
			select l.locid, flag, max(a.amount) as amount
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('FUN','REC') AND ProductName = 'Funding and Recovery'
			and l.loctypeid in (2,4) 
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid,c.chdisplayid,flag		

union all 

-------727	ACT_TOTAL_NETAMTDUE	Yes	Net Amt Due

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
--agentinvoice_sales
case  flag  when 'REC' then '-2' when 'FUN' then '-3' end 	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
case  flag  when 'REC' then sum(coalesce(a.amount,0)) when 'FUN' then  (sum(coalesce(a.amount,0))* -1) end as amount 
		from 
		(
			select l.locid,flag, max(a.amount) as amount, max(a.ct) as ct
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('REC','FUN') and productname = 'Online Adjustment'
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid, c.chdisplayid,flag

	;	
		
		insert into ubt_temp_datalocationinvoice
select	coalesce(db.locdisplayid,cr.locdisplayid)as locdisplayid,
coalesce(db.agentinvoice_invid,cr.agentinvoice_invid)	as agentinvoice_invid,
coalesce(db.agentinvoice_finidn,cr.agentinvoice_finidn)as agentinvoice_finidn ,
0		as agentinvoice_productid,
'727'		as sales_type,
0		as totalcount,
(sum(db.amount) - sum(cr.amount))			as amount 
		from
		(
			select  a.locdisplayid as locdisplayid,
					a.agentinvoice_invid		as agentinvoice_invid, 
					a.agentinvoice_finidn		as agentinvoice_finidn,
					sum(coalesce(a.totalcount,0))			as totalcount,
					sum(coalesce(a.amount,0))as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in
			(
				'2', 		--cancel amount
				'3',		--validation amount
				'7',		--commission amount
				'6', 		-- gst tax amount
				'108', 	--?nets transaction
				'110', 	--?flashpay transaction
				'112', 	--?cashcard transaction
				'571', 	--funding
				'4', 		--rebate
				'61', 	--refund--(6)5, --refund
				'-3' 		-- crd adj
			)		
			and agentinvoice_productid != 31 --(15) exclude offline orders in the net amount due calculation
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn
		) cr
		full outer join 
		(
			select  a.locdisplayid as locdisplayid,
				a.agentinvoice_invid		as agentinvoice_invid, 
				a.agentinvoice_finidn		as agentinvoice_finidn,
				sum(coalesce(a.totalcount,0))as totalcount,
				sum(coalesce(a.amount,0))	as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in('1','572','-2')   --1,	--collection	572, --recovery		-2 --dbt adj
		
			and agentinvoice_productid != 31 
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn	
		) db 
		on db.locdisplayid=cr.locdisplayid and db.agentinvoice_invid=cr.agentinvoice_invid 
		and db.agentinvoice_finidn=cr.agentinvoice_finidn
		group by db.locdisplayid, db.agentinvoice_invid,db.agentinvoice_finidn, 
		cr.locdisplayid, cr.agentinvoice_invid	,cr.agentinvoice_finidn
;

--CLEAR REFUND, REBATE, ADJ, COLLECTION DATA
	DELETE FROM ubt_temp_datalocationinvoice WHERE Sales_type IN('-2', '-3')
	;

UPDATE ubt_temp_datalocationinvoice td--(12)FinalTempDataLocationInvoice--(1)UPDATE TempDataLocationInvoice
		set agentinvoice_productid = p.sapprodid
		from public.ztubt_sap_product  p
		where td.agentinvoice_productid = p.prodid 
;


		return query
		SELECT Distinct
			coalesce(LocDisplayID, '') LocDisplayID
			,coalesce(AgentInvoice_invId, '') as AgentInvoice_invId
			,coalesce(AgentInvoice_finidn, '') as AgentInvoice_finidn
			,coalesce(AgentInvoice_productId, 0) as AgentInvoice_productId
			,coalesce(Sales_type, '') as Sales_type
			,TotalCount
			,Amount
		
		FROM ubt_temp_datalocationinvoice
	WHERE (TotalCount!=0 or Amount!=0) AND (coalesce(AgentInvoice_finidn,'') <> '')
			AND AgentInvoice_invId in(  vinvoiceperiodid ) --(4)
			;

drop table ubt_temp_terminal;
drop table ubt_temp_location;
drop table ubt_temp_chain;
drop table ubt_temp_product;
drop table ubt_temp_cancelledbeticket;
drop table ubt_temp_getamounttrans;
drop table ubt_temp_resultcashlesslocation;
drop table ubt_temp_iTotolocation;
drop table	ubt_temp_groupTotolocation;
drop table  ubt_temp_salesgroupTotolocation;
drop table 	ubt_temp_salesTotolocation;
drop table 	ubt_temp_transamountdetaildata;
drop table	ubt_temp_datalocationinvoice;
drop table 	ubt_temp_salesfactorconfig;
drop table ubt_temp_pbth; 
-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
drop table ubt_temp_sales_scandsr;
drop table ubt_temp_sales_scandsr_loc;
	end;
$$;


ALTER FUNCTION public.sp_ubt_getlocationinvoice_bk20240704(businessdate date) OWNER TO consultant01;

--
-- TOC entry 1147 (class 1255 OID 2005648)
-- Name: sp_ubt_getlocationinvoice_bk20241010(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getlocationinvoice_bk20241010(businessdate date) RETURNS TABLE(locdisplayid character varying, agentinvoice_invid character varying, agentinvoice_finidn character varying, agentinvoice_productid integer, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	vbusinessdate date;
	vinputdate date;
	vstartperiod date;
	vendperiod date;
	vfromdateIGT timestamp;
	vtodateIGT timestamp;
	vfromdatetimeIGT_UTC timestamp;
	vtodatetimeIGT_UTC timestamp;
	vfromdatetimeOB_UTC timestamp;
	vtodatetimeOB_UTC timestamp;
	vfromdatetimeBMCS_UTC timestamp;
	vtodatetimeBMCS_UTC timestamp;
	
	vinvoiceperiodid varchar(100);
	vactualdate date;
	
	BEGIN	
	select businessdate into  vbusinessdate ;
	select  (vbusinessdate :: date) +  interval '1 DAY' into  vinputdate ;

	select (vbusinessdate :: date) + interval '1 DAY' into  vactualdate ;
	
	
select case when to_char(vinputdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date )- interval '3 day'
else date_trunc('week',vinputdate ::date ) end ,

case when to_char(vinputdate  ::date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date)- interval '1 day'
else date_trunc('week',vinputdate ::date )+ interval '3 day' end 

into  vstartperiod,vendperiod;

select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob,utcfromdatetimebmcs, utctodatetimebmcs

into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
from public.sp_ubt_getcommonubtdates(vstartperiod,vendperiod);

select cast(invoiceperiodid as varchar)
into  vinvoiceperiodid
from public.ztubt_invoiceperiod zi  where startdate=vstartperiod and enddate=vendperiod;



create temp table if not exists ubt_temp_terminal
(
terdisplayid varchar(100),
locid int4
);

create temp table if not exists ubt_temp_location
(
locid int4,
locdisplayid varchar(100),
sweepindicator int4,
loctypeid int4,
isgst bool,
accountnumber varchar(100),
branchid varchar(100),
bankid varchar(100),
locname varchar(100),
isibg bool,
retid int4,
chid int4
);

create temp table if not exists ubt_temp_product
(
ProdID int4,
ProdName varchar(100)
);




insert into ubt_temp_terminal
	select ter.terdisplayid, ter.locid
	from public.ztubt_terminal ter;
	
	insert into ubt_temp_location
	select loc.locid, loc.locdisplayid, loc.sweepindicator,loc.loctypeid,loc.isgst,loc.accountnumber,
	loc.branchid,loc.bankid,loc.locname,loc.isibg,loc.retid,loc.chid	
	from public.ztubt_location loc;
	
	insert into ubt_temp_product
	select pd.prodid, case   pd.prodid when 5 then 'SPORTS' else trim(pd.prodname) end prodname
	from public.ztubt_product pd
	where pd.prodid != 6 ;--(15) remove sports live so that all sports refer to productid = 5 only

--	UPDATE public.ztubt_product SET prodname = 'SPORTS' WHERE ProdID = 5 ;--(15) rename "Sports %" to be "Sports" only
	
	create temp table if not exists ubt_temp_chain
	(
	chid int4,
	chdisplayid varchar(100),
	chname varchar(100)
	);

create temp table if not exists ubt_temp_cancelledbeticket
	(
	ticketserialnumber varchar(500),
	CancelledDate timestamp,
	CancelledAmout numeric(22,2),
	ProdID int4,
	TerDisplayID varchar(100)
	);

	insert into ubt_temp_chain

	select zc.chid, zc.chdisplayid, zc.chname	from public.ztubt_chain zc ;
	
	insert into ubt_temp_cancelledbeticket
	select cb.ticketserialnumber,cb.cancelleddate,cb.cancelledamout,cb.prodid,cb.terdisplayid
	from public.ztubt_cancelledbetticket cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
	on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateigt and vtodateigt ;
	
create index  idx_ubt_cancelledbetticket_tck_prdid_candt on ubt_temp_cancelledbeticket (ticketserialnumber,Prodid, CancelledDate)
;
	
	
	create temp table if not exists ubt_temp_getamounttrans --(12)
(
	ticketserialnumber varchar(500),
	wager numeric(22,2),
	secondwager numeric(22,2),
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2),
	winningamount numeric(22,2) 
);

	INSERT INTO ubt_temp_getamounttrans 
	select * from public.sp_ubt_getamounttransaction(vstartperiod,vendperiod);

create index  idx_ubt_getamounttrans_ticket on ubt_temp_getamounttrans (ticketserialnumber)
;



create temp table if not exists ubt_temp_resultcashlesslocation
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(22, 11),
ct int4
	);
	
	insert into ubt_temp_resultcashlesslocation
	select pd.terdisplayid, 
	case pd.PaymentTypeID  when 'NC' then 'NETS'
	when 	'NN' then 'NETS'
	 when 'NCC' then 'CASHCARD'
	 when 'NFP' then 'Flashpay' end,
	 coalesce(sum(coalesce(pd.paidamount,0)),0), count(distinct pd.paymentdetailid)
from  public.ztubt_paymentdetail  pd 
where pd.paymenttypeid IN ('NC','NN','NCC','NFP')--(7)--nets
and pd.createddate >= vfromdatetimeIGT_UTC 	and pd.createddate < vtodatetimeIGT_UTC --(30)

group by pd.terdisplayid,pd.PaymentTypeID ;

create index  idx_ubt_cashless_terdsplid on ubt_temp_resultcashlesslocation (terdisplayid)
;	
	
	create temp table if not exists ubt_temp_iTotolocation 
	(
TicketSerialNumber VARCHAR(200),
iTotoIndicator bool,
GroupUnitSequence int4
	);

	insert into ubt_temp_itotolocation
select distinct ticketserialnumber, itotoindicator, groupunitsequence
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where (groupunitsequence = 1) or --group toto
 (itotoindicator = true) --itoto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create index  idx_ubt_itotoloc_ticket on ubt_temp_iTotolocation (ticketserialnumber)
;	
	
	create temp table if not exists ubt_temp_groupTotolocation
	(
ticketserialnumber varchar(200),
grouphostid varchar(50),
groupunitsequence int4
	);

insert into ubt_temp_grouptotolocation
select distinct ticketserialnumber, grouphostid, groupunitsequence
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where groupunitsequence is not null --group toto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc );

create index  idx_ubt_grptotoloc_ticket on ubt_temp_groupTotolocation (ticketserialnumber)
;	
-----------------------------------------------------------------

create temp table ubt_temp_pbth as 
select terdisplayid,ticketserialnumber,createddate
from public.ztubt_placedbettransactionheader pbt
where  
	pbt.prodid = 3 
and (pbt.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create temp table if not exists ubt_temp_salesgroupTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);
	

insert into ubt_temp_salesgroupTotolocation (locid, chid, prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100 )--(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, --gb.actualdate, --(10)
	pbth.terdisplayid, 
	--lc.chid,
	3 as prodid, 
	1 as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1) as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, --(1)sum(coalesce(pbtl.betpriceamount,0))	 as totalamount
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
--from public.ztubt_placedbettransactionheader  pbth
	from ubt_temp_pbth  pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager,
case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
	(
select gat.ticketserialnumber, gat.wager, gat.sales 
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
	
inner join ubt_temp_cancelledbeticket  cb on gat.ticketserialnumber =  cb.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where  
	pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/	

	group by pbth.terdisplayid, (pbth.createddate :: date) --gb.actualdate --(10)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype;
	
create index  idx_ubt_salegrptotoloc_locid_prodid on ubt_temp_salesgroupTotolocation (locid,prodid)
;		

	create temp table if not exists ubt_temp_salesTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	)
;


	INSERT INTO ubt_temp_salesTotolocation(LocID, CHID, ProdID, BetType, WagerTotal, CancelTotal, WagerAmount, SalesAmount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100) --(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, 
	pbth.terdisplayid as terdisplayid,	
	3 as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal,
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
	--from	public.ztubt_placedbettransactionheader pbth
	from ubt_temp_pbth pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager, 
case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join --(8)
	(
select gat.ticketserialnumber, gat.wager, gat.sales 
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
inner join ubt_temp_cancelledbeticket cb on gat.ticketserialnumber = cb.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/
	
	group by pbth.terdisplayid, (pbth.createddate :: date)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype
	;

create index  idx_ubt_saletotoloc_locid_prodid on ubt_temp_salesTotolocation (locid,prodid)
;		

--=================================
--FILL IN TRANS AMOUNT DETAIL DATA
--=================================

create temp table if not exists ubt_temp_transamountdetaildata 
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(32,13),
ct int4,
flag char(3),
transtype char(3),
fromdate date,
todate date
	);

	Insert Into ubt_temp_transamountdetaildata
select 
terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
from public.sp_ubt_gettransamountdetails (vstartperiod,vendperiod);

	/*UPDATE ubt_temp_transamountdetaildata
	SET amount = amount * 100;*/

create index  idx_ubt_transamt_terdisplayid on ubt_temp_transamountdetaildata (terdisplayid)
;	
create index  idx_ubt_transamt_productname on ubt_temp_transamountdetaildata (productname)
;	
create index  idx_ubt_transamt_flag on ubt_temp_transamountdetaildata (flag)
;	
create index  idx_ubt_transamt_transtype on ubt_temp_transamountdetaildata (transtype)
;	
--------------------------------------------------------------------------------------------	
	create temp table if not exists ubt_temp_datalocationinvoice
	(
locdisplayid varchar(200) ,
agentinvoice_invid varchar(100) ,
agentinvoice_finidn varchar(200) ,
agentinvoice_productid int4 ,
sales_type varchar(100) ,
totalcount int4 ,
amount numeric(32, 11) 
	) 
	;
 
insert into ubt_temp_datalocationinvoice (locdisplayid, agentinvoice_invid, agentinvoice_finidn, agentinvoice_productid, sales_type, totalcount, amount)
	
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,  
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) 
group by lc.locdisplayid,c.chdisplayid,pr.prodid

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) 	as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid

----------2	AT_CANCELAMT
----------3 AT_VALIDAMT
----------4 AT_VALIDAMT

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.Flag when 'CAN' then '2'
   when 'PAY' then '3'
   when 'RBT' then '4' end as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) * -1	as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('CAN','PAY','RBT') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag
	
union all 

-----61	Refund Amount--(5)(6)

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) * -1	as amount  
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid

--offline orders - refund
	
union all

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
(sum(coalesce(a.amount,0)) * -1) as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid


union all 
-----6	AT_TAXAMT 
-----7	AT_COMMAMT 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.flag when 'GST' then '6' when 'SAL'then '7' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
(sum(coalesce(a.amount,0)) * -1)as amount  
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('GST', 'SAL') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by 	lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag


union all 
------16. AT_FRACVALAMT

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'16'as sales_type,
count(distinct vb.tranheaderid)	as totalcount, --(16) --(1)count(1)as totalcount, 
sum(coalesce(vb.winningamount,0))as totalamount--(1) sum(coalesce(vb.amount,0))as totalamount
from 
(
	select vb.tranheaderid,vb.winningamount,vb.terdisplayid,vb.createdvalidationdate 
	from public.ztubt_validatedbetticket  vb --(16)
	inner join  public.ztubt_validatedbetticketlifecyclestate  vbt
on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
	where vb.winningamount != 0 and vb.winningamount is not null --(8)
	and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	
)vb
	
inner join
(
	select distinct tranheaderid, grouphostid, groupunitsequence 
	from  public.ztubt_toto_placedbettransactionlineitem ztp  
) ph on vb.tranheaderid = ph.tranheaderid --(16)

inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid

where ph.groupunitsequence is not null --(16)
group by lc.locdisplayid,c.chdisplayid

----52. House syndicate sales amount

union all 

select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
s.prodid as agentinvoice_productid, 
'52'as sales_type, 
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0))	as totalamount--(1)(coalesce(s.amount,0))	as totalamount
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid, s.prodid


-------25. house syndicate sales amount by sales factor [itoto sales by sales factor

union all 
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
3 as agentinvoice_productid,
'25' as sales_type,
sum(coalesce (s.wagertotal,0) - coalesce(s.canceltotal,0))	as totalcount,  --(8)
sum(coalesce(s.salesamount,0)) as totalamount 
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid

-----40. GST TAX rate
union all 
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
prd.prodid as agentinvoice_productid,
'40'as sales_type,
0 as totalcount, 
gst.gstrate
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst = True
)lc
cross join 
(
	select prodid from ubt_temp_product where prodid in (2,3,4) --lottery / es
)prd
cross join
(
	select  gstrate from public.ztubt_gstconfig	a  
	where 
	(vactualdate between effectivefrom and enddate) or (vactualdate >=effectivefrom and enddate is null) 
	limit 1 
)gst

union all 
--------59. House syndicate cancel amount - [iTOTO cancellations

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid, 
'59'as sales_type, 
count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)	as totalcount, 
sum(coalesce(cb.cancelledamout,0))	as totalamount
from ubt_temp_cancelledbeticket cb
inner join ubt_temp_iTotolocation itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true
inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cb.prodid = 3  
	and cb.cancelleddate >= vfromdateIGT and cb.cancelleddate < vtodateIGT --(30)

group by lc.locdisplayid,c.chdisplayid	

union all 
--------60. Player syndicate sales amount by sales factor 

select l.locdisplayid	as locdisplayid ,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
s.prodid	as agentinvoice_productid,
'60'	as sales_type, 
sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))as totalcount, --(8)
sum(coalesce(s.salesamount,0)) as totalamount 
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,s.prodid 

union all 

---------69. player syndicate sales amount 

select	l.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,  
3 as agentinvoice_productid, 
'69'as sales_type,
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0)) as totalamount
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid

union all

-----------70 [	 GROUP TOTO Cancel Amount

select      lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'70'as sales_type, 
count(distinct gt.grouphostid)	as totalcount,  
sum(coalesce(cbt.cancelledamout,0))	as totalamount
from ubt_temp_cancelledbeticket cbt
inner join ubt_temp_grouptotolocation gt on cbt.ticketserialnumber = gt.ticketserialnumber
inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cbt.prodid = 3 
and cbt.cancelleddate >= vfromdateIGT and cbt.cancelleddate < vtodateIGT 

group by lc.locdisplayid,c.chdisplayid

union all
-----------------105 Sales Commision Rate

select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (2,3,4) --lottery / es
)sal

union all 

--------108 AT_ON_EZLINK--  NETS
----110	AT_ON_ATM--- Flashpay
---112	AT_ON_CASHCARD

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case a.productname when 'NETS' then '108'	
 when 'Flashpay' then '110' when 'CASHCARD' then '112' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
sum(coalesce(a.amount,0))	as amount 
		from	ubt_temp_location as lc 
left join ubt_temp_chain c on lc.chid = c.chid
left join ubt_temp_terminal  as ter on  ter.locid=lc.locid
left join ubt_temp_resultcashlesslocation a on a.terdisplayid = ter.terdisplayid
		where a.productname in ('NETS','Flashpay','CASHCARD')
		group by lc.locdisplayid,c.chdisplayid,a.productname
		
		
union all 
---------116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor

select loc.locdisplayid, vinvoiceperiodid as agentinvoice_invid, ch.chdisplayid, fin.agentinvoice_productid,
'116'	as sales_type, sum(fin.totalcount), (sum(fin.totalamount) * 100) 
		from
		(
			select	a.actualdate,
	a.terdisplayid	as terdisplayid,	
	a.prodid	as agentinvoice_productid,	
	sum(coalesce(a.total,0) - coalesce(can.total,0))	as totalcount, --(8)
	round(trunc(sum(coalesce(a.amount,0)) / 100,2), 2)	as totalamount 
	
			from
			(
select cast(pb.createddate as date) actualdate, a.ticketserialnumber, 
sum(a.sales + a.secondsales) as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid,
	case pb.prodid
		when 6 then 5 else pb.prodid
		end as prodid --(15)
from ubt_temp_getamounttrans a 
inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 

where
pb.iscancelled = false and (
		(
		pb.prodid in (2,3,4) --lottery / es
		and (pb.createddate between vfromdatetimeIGT_UTC and vtodatetimeIGT_UTC )
		
		)
		or --(15)
		(
		pb.prodid in (5,6) --sports / ob
		and (pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC )
		)
		or
		(
		pb.prodid in (1) --horse racing / bmcs
		and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
		)
	)
 
group by pb.createddate , a.ticketserialnumber, pb.terdisplayid, pb.prodid
			)a
			
			left join --(8)
			(
select a.ticketserialnumber,0 as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
pb.prodid
from ubt_temp_getamounttrans a 
inner join ubt_temp_cancelledbeticket cb on a.ticketserialnumber = cb.ticketserialnumber
inner join (select ticketserialnumber,terdisplayid,prodid from public.ztubt_placedbettransactionheader)  pb on a.ticketserialnumber = pb.ticketserialnumber
where pb.prodid in (2,3,4) --lottery / es
group by a.ticketserialnumber, pb.terdisplayid, pb.prodid
			)can on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid and a.prodid = can.prodid
		group by a.actualdate,		a.terdisplayid, a.prodid 
		)fin
		
		inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join ubt_temp_chain ch on loc.chid = ch.chid
		group by loc.locdisplayid, ch.chdisplayid, fin.agentinvoice_productid;

		
	 
/*	update ubt_temp_datalocationinvoice tt
		set totalcount = fin.totalcount
		from (	
			select td2.locdisplayid,td2.agentinvoice_finidn,td2.agentinvoice_productid,td2.totalcount
			from  ubt_temp_datalocationinvoice td2 where td2.sales_type = '7'
		)fin  
		where  tt.locdisplayid = fin.locdisplayid and tt.agentinvoice_finidn = fin.agentinvoice_finidn 
		and tt.sales_type ='116'
	;*/
	
-- [2022-04-05] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation

create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('211801001', 4, 'SWEEP','2021-11-18'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vstartperiod,vendperiod);

create temp table if not exists ubt_temp_sales_scandsr_loc
	(
	LocDisplayID varchar(200),
	AgentInvoice_invId varchar(100),
	AgentInvoice_finidn varchar(200),
	AgentInvoice_productId int4,
	Sales_type varchar(100),
	TotalCount int,
	Amount decimal(32, 11)
	);


Insert into ubt_temp_sales_scandsr_loc
SELECT	LOC.LocDisplayID	as LocDisplayID,
		vinvoiceperiodid			as AgentInvoice_invId,
		CH.CHDisplayID		as AgentInvoice_finidn ,
		RS.ProdID			as AgentInvoice_productId,
		'116'					aS sales_type,
		SUM(RS.TotalCount), 
		SUM(RS.Amount) * 100
FROM ubt_temp_sales_scandsr RS
INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
LEFT JOIN ubt_temp_chain CH ON LOC.CHID = CH.CHID
group by LOC.LocDisplayID,CH.CHDisplayID,CH.CHDisplayID, RS.ProdID;


DELETE FROM ubt_temp_datalocationinvoice SAL  USING ubt_temp_sales_scandsr_loc RSLoc
WHERE RSLoc.LocDisplayID = SAL.LocDisplayID AND RSLoc.AgentInvoice_productId = SAL.AgentInvoice_productId
AND SAL.Sales_type = '116';

INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount)
	SELECT	RSLoc.LocDisplayID	as LocDisplayID,
			vinvoiceperiodid			as AgentInvoice_invId,
			RSLoc.AgentInvoice_finidn		as AgentInvoice_finidn ,
			RSLoc.AgentInvoice_productId			as AgentInvoice_productId,
			'116'					as sales_type,
			RSLoc.TotalCount, 
			RSLoc.Amount
	FROM ubt_temp_sales_scandsr_loc RSLoc;

-- [2022-04-05] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--------119	AT_SALESFACTOR	
CREATE temp TABLE if not exists ubt_temp_salesfactorconfig 
	(
		prodid int4,
		salesfactor numeric(13,12)
	);

	INSERT INTO ubt_temp_salesfactorconfig 
	select A.ProdID, A.SalesFactor  
	FROM public.ztubt_salescomconfig   A 
	WHERE CommissionType=1  AND A.IsDeleted = false AND ProdID IN (2,3,4);

	
	INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount)
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc
		)sfc

		union all
--------571	ACT_VALID_FUND_AMT
------572	ACT_RECOVERY_AMT
		
select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case  flag  when 'FUN' then '571' when 'REC' then '572' end sales_type,
0	as totalcount,
(case when flag='FUN' then sum(coalesce(a.amount,0)) * -1
		when flag='REC' then sum(coalesce(a.amount,0)) end)		as amount 
		from 
		(
			select l.locid, flag, max(a.amount) as amount
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('FUN','REC') AND ProductName = 'Funding and Recovery'
			and l.loctypeid in (2,4) 
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid,c.chdisplayid,flag		

union all 

-------727	ACT_TOTAL_NETAMTDUE	Yes	Net Amt Due

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
--agentinvoice_sales
case  flag  when 'REC' then '-2' when 'FUN' then '-3' end 	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
case  flag  when 'REC' then sum(coalesce(a.amount,0)) when 'FUN' then  (sum(coalesce(a.amount,0))* -1) end as amount 
		from 
		(
			select l.locid,flag, max(a.amount) as amount, max(a.ct) as ct
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('REC','FUN') and productname = 'Online Adjustment'
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid, c.chdisplayid,flag

	;	
		
		insert into ubt_temp_datalocationinvoice
select	coalesce(db.locdisplayid,cr.locdisplayid)as locdisplayid,
coalesce(db.agentinvoice_invid,cr.agentinvoice_invid)	as agentinvoice_invid,
coalesce(db.agentinvoice_finidn,cr.agentinvoice_finidn)as agentinvoice_finidn ,
0		as agentinvoice_productid,
'727'		as sales_type,
0		as totalcount,
(sum(db.amount) - sum(cr.amount))			as amount 
		from
		(
			select  a.locdisplayid as locdisplayid,
					a.agentinvoice_invid		as agentinvoice_invid, 
					a.agentinvoice_finidn		as agentinvoice_finidn,
					sum(coalesce(a.totalcount,0))			as totalcount,
					sum(coalesce(a.amount,0))as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in
			(
				'2', 		--cancel amount
				'3',		--validation amount
				'7',		--commission amount
				'6', 		-- gst tax amount
				'108', 	--?nets transaction
				'110', 	--?flashpay transaction
				'112', 	--?cashcard transaction
				'571', 	--funding
				'4', 		--rebate
				'61', 	--refund--(6)5, --refund
				'-3' 		-- crd adj
			)		
			and agentinvoice_productid != 31 --(15) exclude offline orders in the net amount due calculation
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn
		) cr
		full outer join 
		(
			select  a.locdisplayid as locdisplayid,
				a.agentinvoice_invid		as agentinvoice_invid, 
				a.agentinvoice_finidn		as agentinvoice_finidn,
				sum(coalesce(a.totalcount,0))as totalcount,
				sum(coalesce(a.amount,0))	as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in('1','572','-2')   --1,	--collection	572, --recovery		-2 --dbt adj
		
			and agentinvoice_productid != 31 
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn	
		) db 
		on db.locdisplayid=cr.locdisplayid and db.agentinvoice_invid=cr.agentinvoice_invid 
		and db.agentinvoice_finidn=cr.agentinvoice_finidn
		group by db.locdisplayid, db.agentinvoice_invid,db.agentinvoice_finidn, 
		cr.locdisplayid, cr.agentinvoice_invid	,cr.agentinvoice_finidn
;

--CLEAR REFUND, REBATE, ADJ, COLLECTION DATA
	DELETE FROM ubt_temp_datalocationinvoice WHERE Sales_type IN('-2', '-3')
	;

UPDATE ubt_temp_datalocationinvoice td--(12)FinalTempDataLocationInvoice--(1)UPDATE TempDataLocationInvoice
		set agentinvoice_productid = p.sapprodid
		from public.ztubt_sap_product  p
		where td.agentinvoice_productid = p.prodid 
;


		return query
		SELECT Distinct
			coalesce(LocDisplayID, '') LocDisplayID
			,coalesce(AgentInvoice_invId, '') as AgentInvoice_invId
			,coalesce(AgentInvoice_finidn, '') as AgentInvoice_finidn
			,coalesce(AgentInvoice_productId, 0) as AgentInvoice_productId
			,coalesce(Sales_type, '') as Sales_type
			,TotalCount
			,Amount
		
		FROM ubt_temp_datalocationinvoice
	WHERE (TotalCount!=0 or Amount!=0) AND (coalesce(AgentInvoice_finidn,'') <> '')
			AND AgentInvoice_invId in(  vinvoiceperiodid ) --(4)
			;

drop table ubt_temp_terminal;
drop table ubt_temp_location;
drop table ubt_temp_chain;
drop table ubt_temp_product;
drop table ubt_temp_cancelledbeticket;
drop table ubt_temp_getamounttrans;
drop table ubt_temp_resultcashlesslocation;
drop table ubt_temp_iTotolocation;
drop table	ubt_temp_groupTotolocation;
drop table  ubt_temp_salesgroupTotolocation;
drop table 	ubt_temp_salesTotolocation;
drop table 	ubt_temp_transamountdetaildata;
drop table	ubt_temp_datalocationinvoice;
drop table 	ubt_temp_salesfactorconfig;
drop table ubt_temp_pbth; 
-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
drop table ubt_temp_sales_scandsr;
drop table ubt_temp_sales_scandsr_loc;
	end;
$$;


ALTER FUNCTION public.sp_ubt_getlocationinvoice_bk20241010(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1278 (class 1255 OID 1541804)
-- Name: sp_ubt_getlocationinvoice_bk20241203(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getlocationinvoice_bk20241203(businessdate date) RETURNS TABLE(locdisplayid character varying, agentinvoice_invid character varying, agentinvoice_finidn character varying, agentinvoice_productid integer, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	vbusinessdate date;
	vinputdate date;
	vstartperiod date;
	vendperiod date;
	vfromdateIGT timestamp;
	vtodateIGT timestamp;
	vfromdatetimeIGT_UTC timestamp;
	vtodatetimeIGT_UTC timestamp;
	vfromdatetimeOB_UTC timestamp;
	vtodatetimeOB_UTC timestamp;
	vfromdatetimeBMCS_UTC timestamp;
	vtodatetimeBMCS_UTC timestamp;
	
	vinvoiceperiodid varchar(100);
	vactualdate date;

	v_tfogBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettfogbettypes()));
	
	BEGIN	
	select businessdate into  vbusinessdate ;
	select  (vbusinessdate :: date) +  interval '1 DAY' into  vinputdate ;

	select (vbusinessdate :: date) + interval '1 DAY' into  vactualdate ;
	
	
select case when to_char(vinputdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date )- interval '3 day'
else date_trunc('week',vinputdate ::date ) end ,

case when to_char(vinputdate  ::date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date)- interval '1 day'
else date_trunc('week',vinputdate ::date )+ interval '3 day' end 

into  vstartperiod,vendperiod;

select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob,utcfromdatetimebmcs, utctodatetimebmcs

into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
from public.sp_ubt_getcommonubtdates(vstartperiod,vendperiod);

select cast(invoiceperiodid as varchar)
into  vinvoiceperiodid
from public.ztubt_invoiceperiod zi  where startdate=vstartperiod and enddate=vendperiod;



create temp table if not exists ubt_temp_terminal
(
terdisplayid varchar(100),
locid int4
);

create temp table if not exists ubt_temp_location
(
locid int4,
locdisplayid varchar(100),
sweepindicator int4,
loctypeid int4,
isgst bool,
accountnumber varchar(100),
branchid varchar(100),
bankid varchar(100),
locname varchar(100),
isibg bool,
retid int4,
chid int4
);

create temp table if not exists ubt_temp_product
(
ProdID int4,
ProdName varchar(100)
);




insert into ubt_temp_terminal
	select ter.terdisplayid, ter.locid
	from public.ztubt_terminal ter;
	
	insert into ubt_temp_location
	select loc.locid, loc.locdisplayid, loc.sweepindicator,loc.loctypeid,loc.isgst,loc.accountnumber,
	loc.branchid,loc.bankid,loc.locname,loc.isibg,loc.retid,loc.chid	
	from public.ztubt_location loc;
	
	insert into ubt_temp_product
	select pd.prodid, case   pd.prodid when 5 then 'SPORTS' else trim(pd.prodname) end prodname
	from public.ztubt_product pd
	where pd.prodid != 6 ;--(15) remove sports live so that all sports refer to productid = 5 only
	
	insert into ubt_temp_product (prodid, prodname) values (3, 'TFOG');

--	UPDATE public.ztubt_product SET prodname = 'SPORTS' WHERE ProdID = 5 ;--(15) rename "Sports %" to be "Sports" only
	
	create temp table if not exists ubt_temp_chain
	(
	chid int4,
	chdisplayid varchar(100),
	chname varchar(100)
	);

create temp table if not exists ubt_temp_cancelledbeticket
	(
	ticketserialnumber varchar(500),
	CancelledDate timestamp,
	CancelledAmout numeric(22,2),
	ProdID int4,
	TerDisplayID varchar(100)
	);

	insert into ubt_temp_chain

	select zc.chid, zc.chdisplayid, zc.chname	from public.ztubt_chain zc ;
	
	insert into ubt_temp_cancelledbeticket
	select cb.ticketserialnumber,cb.cancelleddate,cb.cancelledamout,cb.prodid,cb.terdisplayid
	from public.ztubt_cancelledbetticket cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
	on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateigt and vtodateigt ;
	
create index  idx_ubt_cancelledbetticket_tck_prdid_candt on ubt_temp_cancelledbeticket (ticketserialnumber,Prodid, CancelledDate)
;
	
	
	create temp table if not exists ubt_temp_getamounttrans --(12)
(
	ticketserialnumber varchar(500),
	wager numeric(22,2),
	secondwager numeric(22,2),
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2),
	winningamount numeric(22,2) 
);

	INSERT INTO ubt_temp_getamounttrans 
	select * from public.sp_ubt_getamounttransaction(vstartperiod,vendperiod);

create index  idx_ubt_getamounttrans_ticket on ubt_temp_getamounttrans (ticketserialnumber)
;



create temp table if not exists ubt_temp_resultcashlesslocation
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(22, 11),
ct int4
	);
	
	insert into ubt_temp_resultcashlesslocation
	select pd.terdisplayid, 
	case pd.PaymentTypeID  when 'NC' then 'NETS'
	when 	'NN' then 'NETS'
	 when 'NCC' then 'CASHCARD'
	 when 'NFP' then 'Flashpay' end,
	 coalesce(sum(coalesce(pd.paidamount,0)),0), count(distinct pd.paymentdetailid)
from  public.ztubt_paymentdetail  pd 
where pd.paymenttypeid IN ('NC','NN','NCC','NFP')--(7)--nets
and pd.createddate >= vfromdatetimeIGT_UTC 	and pd.createddate < vtodatetimeIGT_UTC --(30)

group by pd.terdisplayid,pd.PaymentTypeID ;

create index  idx_ubt_cashless_terdsplid on ubt_temp_resultcashlesslocation (terdisplayid)
;	
	
	create temp table if not exists ubt_temp_iTotolocation 
	(
TicketSerialNumber VARCHAR(200),
iTotoIndicator bool,
GroupUnitSequence int4,
	bettype int4
	);

	insert into ubt_temp_itotolocation
select distinct ticketserialnumber, itotoindicator, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_tfogBettypes) THEN 1 --TOTO
        else 2 --TFOG
    end AS bettype
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where (groupunitsequence = 1) or --group toto
 (itotoindicator = true) --itoto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create index  idx_ubt_itotoloc_ticket on ubt_temp_iTotolocation (ticketserialnumber)
;	
	
	create temp table if not exists ubt_temp_groupTotolocation
	(
ticketserialnumber varchar(200),
grouphostid varchar(50),
groupunitsequence int4,
	bettype int4
	);

insert into ubt_temp_grouptotolocation
select distinct ticketserialnumber, grouphostid, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_tfogBettypes) THEN 1 --TOTO
        else 2 --TFOG
    end AS bettype
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where groupunitsequence is not null --group toto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc );

create index  idx_ubt_grptotoloc_ticket on ubt_temp_groupTotolocation (ticketserialnumber)
;	
-----------------------------------------------------------------

create temp table ubt_temp_pbth as 
select terdisplayid,ticketserialnumber,createddate
from public.ztubt_placedbettransactionheader pbt
where  
	pbt.prodid = 3 
and (pbt.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create temp table if not exists ubt_temp_salesgroupTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);
	

insert into ubt_temp_salesgroupTotolocation (locid, chid, prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100 )--(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, --gb.actualdate, --(10)
	pbth.terdisplayid, 
	--lc.chid,
	3 as prodid, 
	fin.bettype as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1) as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, --(1)sum(coalesce(pbtl.betpriceamount,0))	 as totalamount
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
--from public.ztubt_placedbettransactionheader  pbth
	from ubt_temp_pbth  pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager,
case when can.ticketserialnumber is null then gat.sales else 0 end as sales,
itoto.bettype
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
	(
select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
	
inner join ubt_temp_cancelledbeticket  cb on gat.ticketserialnumber =  cb.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where  
	pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/	

	group by pbth.terdisplayid, (pbth.createddate :: date), fin.bettype--gb.actualdate --(10)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype;
	
create index  idx_ubt_salegrptotoloc_locid_prodid on ubt_temp_salesgroupTotolocation (locid,prodid)
;		

	create temp table if not exists ubt_temp_salesTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	)
;


	INSERT INTO ubt_temp_salesTotolocation(LocID, CHID, ProdID, BetType, WagerTotal, CancelTotal, WagerAmount, SalesAmount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100) --(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, 
	pbth.terdisplayid as terdisplayid,	
	3 as prodid, 
	fin.bettype as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal,
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
	--from	public.ztubt_placedbettransactionheader pbth
	from ubt_temp_pbth pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager, 
case when can.ticketserialnumber is null then gat.sales else 0 end as sales, itoto.bettype
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join --(8)
	(
select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
inner join ubt_temp_cancelledbeticket cb on gat.ticketserialnumber = cb.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/
	
	group by pbth.terdisplayid, (pbth.createddate :: date), fin.bettype
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype
	;

create index  idx_ubt_saletotoloc_locid_prodid on ubt_temp_salesTotolocation (locid,prodid)
;		

--=================================
--FILL IN TRANS AMOUNT DETAIL DATA
--=================================

create temp table if not exists ubt_temp_transamountdetaildata 
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(32,13),
ct int4,
flag char(3),
transtype char(3),
fromdate date,
todate date
	);

	Insert Into ubt_temp_transamountdetaildata
select 
terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
from public.sp_ubt_gettransamountdetails (vstartperiod,vendperiod);

	/*UPDATE ubt_temp_transamountdetaildata
	SET amount = amount * 100;*/

create index  idx_ubt_transamt_terdisplayid on ubt_temp_transamountdetaildata (terdisplayid)
;	
create index  idx_ubt_transamt_productname on ubt_temp_transamountdetaildata (productname)
;	
create index  idx_ubt_transamt_flag on ubt_temp_transamountdetaildata (flag)
;	
create index  idx_ubt_transamt_transtype on ubt_temp_transamountdetaildata (transtype)
;	
--------------------------------------------------------------------------------------------	
	create temp table if not exists ubt_temp_datalocationinvoice
	(
locdisplayid varchar(200) ,
agentinvoice_invid varchar(100) ,
agentinvoice_finidn varchar(200) ,
agentinvoice_productid int4 ,
sales_type varchar(100) ,
totalcount int4 ,
amount numeric(32, 11),
sub_prod varchar(100)
	) 
	;
 
insert into ubt_temp_datalocationinvoice (locdisplayid, agentinvoice_invid, agentinvoice_finidn, agentinvoice_productid, sales_type, totalcount, amount, sub_prod)
	
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,  
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) 
group by lc.locdisplayid,c.chdisplayid,pr.prodid, a.productname

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) 	as amount,
'' as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid

----------2	AT_CANCELAMT
----------3 AT_VALIDAMT
----------4 AT_VALIDAMT

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.Flag when 'CAN' then '2'
   when 'PAY' then '3'
   when 'RBT' then '4' end as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) * -1	as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('CAN','PAY','RBT') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag, a.productname
	
union all 

-----61	Refund Amount--(5)(6)

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) * -1	as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid, a.productname

--offline orders - refund
	
union all

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
(sum(coalesce(a.amount,0)) * -1) as amount,
'' as sub_prod 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid


union all 
-----6	AT_TAXAMT 
-----7	AT_COMMAMT 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.flag when 'GST' then '6' when 'SAL'then '7' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
(sum(coalesce(a.amount,0)) * -1)as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('GST', 'SAL') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag, a.productname

union all 
------16. AT_FRACVALAMT

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'16'as sales_type,
count(distinct vb.tranheaderid)	as totalcount, --(16) --(1)count(1)as totalcount, 
sum(coalesce(vb.winningamount,0))as totalamount,--(1) sum(coalesce(vb.amount,0))as totalamount
case when ph.bettypeid != ALL(v_tfogBettypes) then 'TOTO'
	else 'TFOG' end as sub_prod
from 
(
	select vb.tranheaderid,vb.winningamount,vb.terdisplayid,vb.createdvalidationdate 
	from public.ztubt_validatedbetticket  vb --(16)
	inner join  public.ztubt_validatedbetticketlifecyclestate  vbt
on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
	where vb.winningamount != 0 and vb.winningamount is not null --(8)
	and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	
)vb
	
inner join
(
	select distinct tranheaderid, grouphostid, groupunitsequence, bettypeid
	from  public.ztubt_toto_placedbettransactionlineitem ztp
) ph on vb.tranheaderid = ph.tranheaderid --(16)

inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid

where ph.groupunitsequence is not null --(16)
group by lc.locdisplayid,c.chdisplayid,
case when ph.bettypeid != ALL(v_tfogBettypes) then 'TOTO'
	else 'TFOG' end
	
----52. House syndicate sales amount

union all 
--TOTO, TFOG
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
s.prodid as agentinvoice_productid, 
'52'as sales_type, 
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0))	as totalamount,--(1)(coalesce(s.amount,0))	as totalamount
case when s.bettype = 1 then 'TOTO'
	else 'TFOG' end as sub_prod 
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid, s.prodid,
	case when s.bettype = 1 then 'TOTO'
		else 'TFOG' end


-------25. house syndicate sales amount by sales factor [itoto sales by sales factor

union all 
--TOTO, TFOG
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
3 as agentinvoice_productid,
'25' as sales_type,
sum(coalesce (s.wagertotal,0) - coalesce(s.canceltotal,0))	as totalcount,  --(8)
sum(coalesce(s.salesamount,0)) as totalamount ,
case when s.bettype = 1 then 'TOTO'
	else 'TFOG' end as sub_prod
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,
	case when s.bettype = 1 then 'TOTO'
		else 'TFOG' end

-----40. GST TAX rate
union all 
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
prd.prodid as agentinvoice_productid,
'40'as sales_type,
0 as totalcount, 
gst.gstrate,
prd.prodname as sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst = True
)lc
cross join 
(
	select prodid, prodname from ubt_temp_product where prodid in (2,3,4) --lottery / es
)prd
cross join
(
	select  gstrate from public.ztubt_gstconfig	a  
	where 
	(vactualdate between effectivefrom and enddate) or (vactualdate >=effectivefrom and enddate is null) 
	limit 1 
)gst

union all 
--------59. House syndicate cancel amount - [iTOTO cancellations
--TOTO, TFOG
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid, 
'59'as sales_type, 
count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)	as totalcount, 
sum(coalesce(cb.cancelledamout,0))	as totalamount,
case when itoto.bettype = 1 then 'TOTO'
	else 'TFOG' end as sub_prod
from ubt_temp_cancelledbeticket cb
inner join ubt_temp_iTotolocation itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true
inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cb.prodid = 3  
	and cb.cancelleddate >= vfromdateIGT and cb.cancelleddate < vtodateIGT --(30)

group by lc.locdisplayid,c.chdisplayid,
	case when itoto.bettype = 1 then 'TOTO'
		else 'TFOG' end

union all 
--------60. Player syndicate sales amount by sales factor 
--TOTO, TFOG
select l.locdisplayid	as locdisplayid ,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
s.prodid	as agentinvoice_productid,
'60'	as sales_type, 
sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))as totalcount, --(8)
sum(coalesce(s.salesamount,0)) as totalamount,
case when s.bettype = 1 then 'TOTO'
	else 'TFOG' end as sub_prod
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,s.prodid,
	case when s.bettype = 1 then 'TOTO'
		else 'TFOG' end

union all 

---------69. player syndicate sales amount 

--TOTO, TFOG
select	l.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,  
3 as agentinvoice_productid, 
'69'as sales_type,
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0)) as totalamount,
case when s.bettype = 1 then 'TOTO'
	else 'TFOG' end as sub_prod
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,
	case when s.bettype = 1 then 'TOTO'
		else 'TFOG' end

union all

-----------70 [	 GROUP TOTO Cancel Amount
--TOTO, TFOG
select      lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'70'as sales_type, 
count(distinct gt.grouphostid)	as totalcount,  
sum(coalesce(cbt.cancelledamout,0))	as totalamount,
case when gt.bettype = 1 then 'TOTO'
	else 'TFOG' end as sub_prod
from ubt_temp_cancelledbeticket cbt
inner join ubt_temp_grouptotolocation gt on cbt.ticketserialnumber = gt.ticketserialnumber
inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cbt.prodid = 3 
and cbt.cancelleddate >= vfromdateIGT and cbt.cancelleddate < vtodateIGT 
group by lc.locdisplayid,c.chdisplayid,
	case when gt.bettype = 1 then 'TOTO'
		else 'TFOG' end

union all
-----------------105 Sales Commision Rate
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission,
'' as sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (2,4) --lottery / es
)sal

union all
--TOTO, TFOG
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission,
sp.sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (3)
)sal
cross join (select 'TOTO' as sub_prod union all select 'TFOG' as sub_prod) as sp

union all 

--------108 AT_ON_EZLINK--  NETS
----110	AT_ON_ATM--- Flashpay
---112	AT_ON_CASHCARD

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case a.productname when 'NETS' then '108'	
 when 'Flashpay' then '110' when 'CASHCARD' then '112' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
sum(coalesce(a.amount,0)) as amount,
'' as sub_prod
		from	ubt_temp_location as lc 
left join ubt_temp_chain c on lc.chid = c.chid
left join ubt_temp_terminal  as ter on  ter.locid=lc.locid
left join ubt_temp_resultcashlesslocation a on a.terdisplayid = ter.terdisplayid
		where a.productname in ('NETS','Flashpay','CASHCARD')
		group by lc.locdisplayid,c.chdisplayid,a.productname
		
		
union all 
---------116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor

select loc.locdisplayid, vinvoiceperiodid as agentinvoice_invid, ch.chdisplayid, fin.agentinvoice_productid,
'116'	as sales_type, sum(fin.totalcount), (sum(fin.totalamount) * 100),
fin.sub_prod as sub_prod
		from
		(
			select	a.actualdate,
	a.terdisplayid	as terdisplayid,	
	a.prodid	as agentinvoice_productid,	
	sum(coalesce(a.total,0) - coalesce(can.total,0))	as totalcount, --(8)
	round(trunc(sum(coalesce(a.amount,0)) / 100,2), 2)	as totalamount ,
	a.sub_prod
			from
			(
select cast(pb.createddate as date) actualdate, a.ticketserialnumber, 
sum(a.sales + a.secondsales) as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid,
	case pb.prodid
		when 6 then 5 else pb.prodid
		end as prodid, --(15)
		case when pb.prodid <> 3 then ''
			when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_tfogBettypes)
			) then 'TFOG' 
		else 'TOTO' end as sub_prod
from ubt_temp_getamounttrans a 
inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 

where
pb.iscancelled = false and (
		(
		pb.prodid in (2,3,4) --lottery / es
		and (pb.createddate between vfromdatetimeIGT_UTC and vtodatetimeIGT_UTC )
		
		)
		or --(15)
		(
		pb.prodid in (5,6) --sports / ob
		and (pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC )
		)
		or
		(
		pb.prodid in (1) --horse racing / bmcs
		and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
		)
	)
 
group by pb.createddate , a.ticketserialnumber, pb.terdisplayid, pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
			SELECT 1 
			FROM ztubt_toto_placedbettransactionlineitem pbtlin
			WHERE pb.TranHeaderID = pbtlin.TranHeaderID
				AND pbtlin.bettypeid = ANY(v_tfogBettypes)
		) then 'TFOG' 
		else 'TOTO' end
			)a
			
			left join --(8)
			(
select a.ticketserialnumber,0 as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
	pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_tfogBettypes)
			) then 'TFOG' 
		else 'TOTO' end as sub_prod 
from ubt_temp_getamounttrans a 
inner join ubt_temp_cancelledbeticket cb on a.ticketserialnumber = cb.ticketserialnumber
inner join (select ticketserialnumber,terdisplayid,prodid, TranHeaderID from public.ztubt_placedbettransactionheader)  pb on a.ticketserialnumber = pb.ticketserialnumber
where pb.prodid in (2,3,4) --lottery / es
group by a.ticketserialnumber, pb.terdisplayid, pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_tfogBettypes)
			) then 'TFOG' 
		else 'TOTO' end
			)can on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid and a.prodid = can.prodid and a.sub_prod = can.sub_prod
		group by a.actualdate, a.terdisplayid, a.prodid , a.sub_prod
		)fin
		
		inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join ubt_temp_chain ch on loc.chid = ch.chid
		group by loc.locdisplayid, ch.chdisplayid, fin.agentinvoice_productid, fin.sub_prod;

/*	update ubt_temp_datalocationinvoice tt
		set totalcount = fin.totalcount
		from (	
			select td2.locdisplayid,td2.agentinvoice_finidn,td2.agentinvoice_productid,td2.totalcount
			from  ubt_temp_datalocationinvoice td2 where td2.sales_type = '7'
		)fin  
		where  tt.locdisplayid = fin.locdisplayid and tt.agentinvoice_finidn = fin.agentinvoice_finidn 
		and tt.sales_type ='116'
	;*/
	
-- [2022-04-05] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation

create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('211801001', 4, 'SWEEP','2021-11-18'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vstartperiod,vendperiod);

create temp table if not exists ubt_temp_sales_scandsr_loc
	(
	LocDisplayID varchar(200),
	AgentInvoice_invId varchar(100),
	AgentInvoice_finidn varchar(200),
	AgentInvoice_productId int4,
	Sales_type varchar(100),
	TotalCount int,
	Amount decimal(32, 11)
	);


Insert into ubt_temp_sales_scandsr_loc
SELECT	LOC.LocDisplayID	as LocDisplayID,
		vinvoiceperiodid			as AgentInvoice_invId,
		CH.CHDisplayID		as AgentInvoice_finidn ,
		RS.ProdID			as AgentInvoice_productId,
		'116'					aS sales_type,
		SUM(RS.TotalCount), 
		SUM(RS.Amount) * 100
FROM ubt_temp_sales_scandsr RS
INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
LEFT JOIN ubt_temp_chain CH ON LOC.CHID = CH.CHID
group by LOC.LocDisplayID,CH.CHDisplayID,CH.CHDisplayID, RS.ProdID;


DELETE FROM ubt_temp_datalocationinvoice SAL  USING ubt_temp_sales_scandsr_loc RSLoc
WHERE RSLoc.LocDisplayID = SAL.LocDisplayID AND RSLoc.AgentInvoice_productId = SAL.AgentInvoice_productId
AND SAL.Sales_type = '116';

INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, sub_prod)
	SELECT	RSLoc.LocDisplayID	as LocDisplayID,
			vinvoiceperiodid			as AgentInvoice_invId,
			RSLoc.AgentInvoice_finidn		as AgentInvoice_finidn ,
			RSLoc.AgentInvoice_productId			as AgentInvoice_productId,
			'116'					as sales_type,
			RSLoc.TotalCount, 
			RSLoc.Amount,
			'' as sub_prod
	FROM ubt_temp_sales_scandsr_loc RSLoc;

-- [2022-04-05] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--------119	AT_SALESFACTOR	
CREATE temp TABLE if not exists ubt_temp_salesfactorconfig 
	(
		prodid int4,
		salesfactor numeric(13,12)
	);

	INSERT INTO ubt_temp_salesfactorconfig 
	select A.ProdID, A.SalesFactor  
	FROM public.ztubt_salescomconfig   A 
	WHERE CommissionType=1  AND A.IsDeleted = false AND ProdID IN (2,3,4);

	
	INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, sub_prod)
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor, ''
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid <> 3
		)sfc

		union all
		--TOTO, TFOG
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor, sp.sub_prod
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid = 3
		)sfc
		cross join (select 'TOTO' as sub_prod union all select 'TFOG' as sub_prod) as sp

		union all
--------571	ACT_VALID_FUND_AMT
------572	ACT_RECOVERY_AMT
		
select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case  flag  when 'FUN' then '571' when 'REC' then '572' end sales_type,
0	as totalcount,
(case when flag='FUN' then sum(coalesce(a.amount,0)) * -1
		when flag='REC' then sum(coalesce(a.amount,0)) end)		as amount,
		'' as sub_prod
		from 
		(
			select l.locid, flag, max(a.amount) as amount
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('FUN','REC') AND ProductName = 'Funding and Recovery'
			and l.loctypeid in (2,4) 
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid,c.chdisplayid,flag		

union all 

-------727	ACT_TOTAL_NETAMTDUE	Yes	Net Amt Due

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
--agentinvoice_sales
case  flag  when 'REC' then '-2' when 'FUN' then '-3' end 	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
case  flag  when 'REC' then sum(coalesce(a.amount,0)) when 'FUN' then  (sum(coalesce(a.amount,0))* -1) end as amount,
		'' as sub_prod
		from 
		(
			select l.locid,flag, max(a.amount) as amount, max(a.ct) as ct
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('REC','FUN') and productname = 'Online Adjustment'
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid, c.chdisplayid,flag

	;	
		
		insert into ubt_temp_datalocationinvoice
select	coalesce(db.locdisplayid,cr.locdisplayid)as locdisplayid,
coalesce(db.agentinvoice_invid,cr.agentinvoice_invid)	as agentinvoice_invid,
coalesce(db.agentinvoice_finidn,cr.agentinvoice_finidn)as agentinvoice_finidn ,
0		as agentinvoice_productid,
'727'		as sales_type,
0		as totalcount,
(sum(db.amount) - sum(cr.amount)) as amount,
'' as sub_prod
		from
		(
			select  a.locdisplayid as locdisplayid,
					a.agentinvoice_invid		as agentinvoice_invid, 
					a.agentinvoice_finidn		as agentinvoice_finidn,
					sum(coalesce(a.totalcount,0))			as totalcount,
					sum(coalesce(a.amount,0))as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in
			(
				'2', 		--cancel amount
				'3',		--validation amount
				'7',		--commission amount
				'6', 		-- gst tax amount
				'108', 	--?nets transaction
				'110', 	--?flashpay transaction
				'112', 	--?cashcard transaction
				'571', 	--funding
				'4', 		--rebate
				'61', 	--refund--(6)5, --refund
				'-3' 		-- crd adj
			)		
			and agentinvoice_productid != 31 --(15) exclude offline orders in the net amount due calculation
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn
		) cr
		full outer join 
		(
			select  a.locdisplayid as locdisplayid,
				a.agentinvoice_invid		as agentinvoice_invid, 
				a.agentinvoice_finidn		as agentinvoice_finidn,
				sum(coalesce(a.totalcount,0))as totalcount,
				sum(coalesce(a.amount,0))	as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in('1','572','-2')   --1,	--collection	572, --recovery		-2 --dbt adj
		
			and agentinvoice_productid != 31 
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn	
		) db 
		on db.locdisplayid=cr.locdisplayid and db.agentinvoice_invid=cr.agentinvoice_invid 
		and db.agentinvoice_finidn=cr.agentinvoice_finidn
		group by db.locdisplayid, db.agentinvoice_invid,db.agentinvoice_finidn, 
		cr.locdisplayid, cr.agentinvoice_invid	,cr.agentinvoice_finidn
;

--CLEAR REFUND, REBATE, ADJ, COLLECTION DATA
	DELETE FROM ubt_temp_datalocationinvoice WHERE Sales_type IN('-2', '-3')
	;

-- for both types of toto
INSERT INTO ubt_temp_datalocationinvoice
-- sum tfog and t649
select LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, sum(TotalCount), sum(Amount), ''
from ubt_temp_datalocationinvoice td
where sub_prod in ('TFOG', 'TOTO') and Sales_type not in ('40', '119', '105')
group by LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type

union all

-- config - clone TFOG config for product Toto (t649 and tfog)
select LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, ''
from ubt_temp_datalocationinvoice td
where sub_prod in ('TFOG') and Sales_type in ('40', '119', '105');

UPDATE ubt_temp_datalocationinvoice td--(12)FinalTempDataLocationInvoice--(1)UPDATE TempDataLocationInvoice
		SET agentinvoice_productid = CASE 
					WHEN td.agentinvoice_productid::int = 3 AND td.sub_prod = 'TOTO' THEN 71
					WHEN td.agentinvoice_productid::int = 3 AND td.sub_prod = 'TFOG' THEN 66
					ELSE p.SAPProdID
				END
		from public.ztubt_sap_product  p
		where td.agentinvoice_productid = p.prodid 
;


		return query
		SELECT Distinct
			coalesce(LocDisplayID, '') LocDisplayID
			,coalesce(AgentInvoice_invId, '') as AgentInvoice_invId
			,coalesce(AgentInvoice_finidn, '') as AgentInvoice_finidn
			,coalesce(AgentInvoice_productId, 0) as AgentInvoice_productId
			,coalesce(Sales_type, '') as Sales_type
			,TotalCount
			,Amount
		
		FROM ubt_temp_datalocationinvoice
	WHERE (TotalCount!=0 or Amount!=0) AND (coalesce(AgentInvoice_finidn,'') <> '')
			AND AgentInvoice_invId in(  vinvoiceperiodid ) --(4)
			;

drop table ubt_temp_terminal;
drop table ubt_temp_location;
drop table ubt_temp_chain;
drop table ubt_temp_product;
drop table ubt_temp_cancelledbeticket;
drop table ubt_temp_getamounttrans;
drop table ubt_temp_resultcashlesslocation;
drop table ubt_temp_iTotolocation;
drop table	ubt_temp_groupTotolocation;
drop table  ubt_temp_salesgroupTotolocation;
drop table 	ubt_temp_salesTotolocation;
drop table 	ubt_temp_transamountdetaildata;
drop table	ubt_temp_datalocationinvoice;
drop table 	ubt_temp_salesfactorconfig;
drop table ubt_temp_pbth; 
-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
drop table ubt_temp_sales_scandsr;
drop table ubt_temp_sales_scandsr_loc;
	end;
$$;


ALTER FUNCTION public.sp_ubt_getlocationinvoice_bk20241203(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1165 (class 1255 OID 2214767)
-- Name: sp_ubt_getlocationinvoice_bk20250326(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getlocationinvoice_bk20250326(businessdate date) RETURNS TABLE(locdisplayid character varying, agentinvoice_invid character varying, agentinvoice_finidn character varying, agentinvoice_productid integer, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	vbusinessdate date;
	vinputdate date;
	vstartperiod date;
	vendperiod date;
	vfromdateIGT timestamp;
	vtodateIGT timestamp;
	vfromdatetimeIGT_UTC timestamp;
	vtodatetimeIGT_UTC timestamp;
	vfromdatetimeOB_UTC timestamp;
	vtodatetimeOB_UTC timestamp;
	vfromdatetimeBMCS_UTC timestamp;
	vtodatetimeBMCS_UTC timestamp;
	
	vinvoiceperiodid varchar(100);
	vactualdate date;

	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));
	
	BEGIN	
	select businessdate into  vbusinessdate ;
	select  (vbusinessdate :: date) +  interval '1 DAY' into  vinputdate ;

	select (vbusinessdate :: date) + interval '1 DAY' into  vactualdate ;
	
	
select case when to_char(vinputdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date )- interval '3 day'
else date_trunc('week',vinputdate ::date ) end ,

case when to_char(vinputdate  ::date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date)- interval '1 day'
else date_trunc('week',vinputdate ::date )+ interval '3 day' end 

into  vstartperiod,vendperiod;

select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob,utcfromdatetimebmcs, utctodatetimebmcs

into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
from public.sp_ubt_getcommonubtdates(vstartperiod,vendperiod);

select cast(invoiceperiodid as varchar)
into  vinvoiceperiodid
from public.ztubt_invoiceperiod zi  where startdate=vstartperiod and enddate=vendperiod;



create temp table if not exists ubt_temp_terminal
(
terdisplayid varchar(100),
locid int4
);

create temp table if not exists ubt_temp_location
(
locid int4,
locdisplayid varchar(100),
sweepindicator int4,
loctypeid int4,
isgst bool,
accountnumber varchar(100),
branchid varchar(100),
bankid varchar(100),
locname varchar(100),
isibg bool,
retid int4,
chid int4
);

create temp table if not exists ubt_temp_product
(
ProdID int4,
ProdName varchar(100)
);




insert into ubt_temp_terminal
	select ter.terdisplayid, ter.locid
	from public.ztubt_terminal ter;
	
	insert into ubt_temp_location
	select loc.locid, loc.locdisplayid, loc.sweepindicator,loc.loctypeid,loc.isgst,loc.accountnumber,
	loc.branchid,loc.bankid,loc.locname,loc.isibg,loc.retid,loc.chid	
	from public.ztubt_location loc;
	
	insert into ubt_temp_product
	select pd.prodid, case   pd.prodid when 5 then 'SPORTS' else trim(pd.prodname) end prodname
	from public.ztubt_product pd
	where pd.prodid != 6 ;--(15) remove sports live so that all sports refer to productid = 5 only
	
	insert into ubt_temp_product (prodid, prodname) values (3, 'TOTO MATCH');

--	UPDATE public.ztubt_product SET prodname = 'SPORTS' WHERE ProdID = 5 ;--(15) rename "Sports %" to be "Sports" only
	
	create temp table if not exists ubt_temp_chain
	(
	chid int4,
	chdisplayid varchar(100),
	chname varchar(100)
	);

create temp table if not exists ubt_temp_cancelledbeticket
	(
	ticketserialnumber varchar(500),
	CancelledDate timestamp,
	CancelledAmout numeric(22,2),
	ProdID int4,
	TerDisplayID varchar(100)
	);

	insert into ubt_temp_chain

	select zc.chid, zc.chdisplayid, zc.chname	from public.ztubt_chain zc ;
	
	insert into ubt_temp_cancelledbeticket
	select cb.ticketserialnumber,cb.cancelleddate,cb.cancelledamout,cb.prodid,cb.terdisplayid
	from public.ztubt_cancelledbetticket cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
	on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateigt and vtodateigt ;
	
create index  idx_ubt_cancelledbetticket_tck_prdid_candt on ubt_temp_cancelledbeticket (ticketserialnumber,Prodid, CancelledDate)
;
	
	
	create temp table if not exists ubt_temp_getamounttrans --(12)
(
	ticketserialnumber varchar(500),
	wager numeric(22,2),
	secondwager numeric(22,2),
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2),
	winningamount numeric(22,2) 
);

	INSERT INTO ubt_temp_getamounttrans 
	select * from public.sp_ubt_getamounttransaction(vstartperiod,vendperiod);

create index  idx_ubt_getamounttrans_ticket on ubt_temp_getamounttrans (ticketserialnumber)
;



create temp table if not exists ubt_temp_resultcashlesslocation
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(22, 11),
ct int4
	);
	
	insert into ubt_temp_resultcashlesslocation
	select pd.terdisplayid, 
	case pd.PaymentTypeID  when 'NC' then 'NETS'
	when 	'NN' then 'NETS'
	 when 'NCC' then 'CASHCARD'
	 when 'NFP' then 'Flashpay' end,
	 coalesce(sum(coalesce(pd.paidamount,0)),0), count(distinct pd.paymentdetailid)
from  public.ztubt_paymentdetail  pd 
where pd.paymenttypeid IN ('NC','NN','NCC','NFP')--(7)--nets
and pd.createddate >= vfromdatetimeIGT_UTC 	and pd.createddate < vtodatetimeIGT_UTC --(30)

group by pd.terdisplayid,pd.PaymentTypeID ;

create index  idx_ubt_cashless_terdsplid on ubt_temp_resultcashlesslocation (terdisplayid)
;	
	
	create temp table if not exists ubt_temp_iTotolocation 
	(
TicketSerialNumber VARCHAR(200),
iTotoIndicator bool,
GroupUnitSequence int4,
	bettype int4
	);

	insert into ubt_temp_itotolocation
select distinct ticketserialnumber, itotoindicator, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where (groupunitsequence = 1) or --group toto
 (itotoindicator = true) --itoto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create index  idx_ubt_itotoloc_ticket on ubt_temp_iTotolocation (ticketserialnumber)
;	
	
	create temp table if not exists ubt_temp_groupTotolocation
	(
ticketserialnumber varchar(200),
grouphostid varchar(50),
groupunitsequence int4,
	bettype int4
	);

insert into ubt_temp_grouptotolocation
select distinct ticketserialnumber, grouphostid, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where groupunitsequence is not null --group toto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc );

create index  idx_ubt_grptotoloc_ticket on ubt_temp_groupTotolocation (ticketserialnumber)
;	
-----------------------------------------------------------------

create temp table ubt_temp_pbth as 
select terdisplayid,ticketserialnumber,createddate
from public.ztubt_placedbettransactionheader pbt
where  
	pbt.prodid = 3 
and (pbt.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create temp table if not exists ubt_temp_salesgroupTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);
	

insert into ubt_temp_salesgroupTotolocation (locid, chid, prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100 )--(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, --gb.actualdate, --(10)
	pbth.terdisplayid, 
	--lc.chid,
	3 as prodid, 
	fin.bettype as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1) as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, --(1)sum(coalesce(pbtl.betpriceamount,0))	 as totalamount
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
--from public.ztubt_placedbettransactionheader  pbth
	from ubt_temp_pbth  pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager,
case when can.ticketserialnumber is null then gat.sales else 0 end as sales,
itoto.bettype
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
	(
select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
	
inner join ubt_temp_cancelledbeticket  cb on gat.ticketserialnumber =  cb.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where  
	pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/	

	group by pbth.terdisplayid, (pbth.createddate :: date), fin.bettype--gb.actualdate --(10)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype;
	
create index  idx_ubt_salegrptotoloc_locid_prodid on ubt_temp_salesgroupTotolocation (locid,prodid)
;		

	create temp table if not exists ubt_temp_salesTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	)
;


	INSERT INTO ubt_temp_salesTotolocation(LocID, CHID, ProdID, BetType, WagerTotal, CancelTotal, WagerAmount, SalesAmount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100) --(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, 
	pbth.terdisplayid as terdisplayid,	
	3 as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal,
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
	--from	public.ztubt_placedbettransactionheader pbth
	from ubt_temp_pbth pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager, 
case when can.ticketserialnumber is null then gat.sales else 0 end as sales
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join --(8)
	(
select gat.ticketserialnumber, gat.wager, gat.sales
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
inner join ubt_temp_cancelledbeticket cb on gat.ticketserialnumber = cb.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/
	
	group by pbth.terdisplayid, (pbth.createddate :: date)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype
	;

create index  idx_ubt_saletotoloc_locid_prodid on ubt_temp_salesTotolocation (locid,prodid)
;		

--=================================
--FILL IN TRANS AMOUNT DETAIL DATA
--=================================

create temp table if not exists ubt_temp_transamountdetaildata 
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(32,13),
ct int4,
flag char(3),
transtype char(3),
fromdate date,
todate date
	);

	Insert Into ubt_temp_transamountdetaildata
select 
terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
from public.sp_ubt_gettransamountdetails (vstartperiod,vendperiod);

	/*UPDATE ubt_temp_transamountdetaildata
	SET amount = amount * 100;*/

create index  idx_ubt_transamt_terdisplayid on ubt_temp_transamountdetaildata (terdisplayid)
;	
create index  idx_ubt_transamt_productname on ubt_temp_transamountdetaildata (productname)
;	
create index  idx_ubt_transamt_flag on ubt_temp_transamountdetaildata (flag)
;	
create index  idx_ubt_transamt_transtype on ubt_temp_transamountdetaildata (transtype)
;	
--------------------------------------------------------------------------------------------	
	create temp table if not exists ubt_temp_datalocationinvoice
	(
locdisplayid varchar(200) ,
agentinvoice_invid varchar(100) ,
agentinvoice_finidn varchar(200) ,
agentinvoice_productid int4 ,
sales_type varchar(100) ,
totalcount int4 ,
amount numeric(32, 11),
sub_prod varchar(100)
	) 
	;
 
insert into ubt_temp_datalocationinvoice (locdisplayid, agentinvoice_invid, agentinvoice_finidn, agentinvoice_productid, sales_type, totalcount, amount, sub_prod)
	
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,  
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) 
group by lc.locdisplayid,c.chdisplayid,pr.prodid, a.productname

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) 	as amount,
'' as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid

----------2	AT_CANCELAMT
----------3 AT_VALIDAMT
----------4 AT_VALIDAMT

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.Flag when 'CAN' then '2'
   when 'PAY' then '3'
   when 'RBT' then '4' end as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) * -1	as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('CAN','PAY','RBT') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag, a.productname
	
union all 

-----61	Refund Amount--(5)(6)

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) * -1	as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid, a.productname

--offline orders - refund
	
union all

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
(sum(coalesce(a.amount,0)) * -1) as amount,
'' as sub_prod 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid


union all 
-----6	AT_TAXAMT 
-----7	AT_COMMAMT 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.flag when 'GST' then '6' when 'SAL'then '7' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
(sum(coalesce(a.amount,0)) * -1)as amount,
a.productname as sub_prod
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('GST', 'SAL') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag, a.productname

union all 
------16. AT_FRACVALAMT

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'16'as sales_type,
count(distinct vb.tranheaderid)	as totalcount, --(16) --(1)count(1)as totalcount, 
sum(coalesce(vb.winningamount,0))as totalamount,--(1) sum(coalesce(vb.amount,0))as totalamount
case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
	else 'TOTO MATCH' end as sub_prod
from 
(
	select vb.tranheaderid,vb.winningamount,vb.terdisplayid,vb.createdvalidationdate 
	from public.ztubt_validatedbetticket  vb --(16)
	inner join  public.ztubt_validatedbetticketlifecyclestate  vbt
on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
	where vb.winningamount != 0 and vb.winningamount is not null --(8)
	and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	
)vb
	
inner join
(
	select distinct tranheaderid, grouphostid, groupunitsequence, bettypeid
	from  public.ztubt_toto_placedbettransactionlineitem ztp
) ph on vb.tranheaderid = ph.tranheaderid --(16)

inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid

where ph.groupunitsequence is not null --(16)
group by lc.locdisplayid,c.chdisplayid,
case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
	else 'TOTO MATCH' end
	
----52. House syndicate sales amount

union all 
--TOTO
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
s.prodid as agentinvoice_productid, 
'52'as sales_type, 
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0))	as totalamount,--(1)(coalesce(s.amount,0))	as totalamount
'TOTO' as sub_prod 
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid, s.prodid


-------25. house syndicate sales amount by sales factor [itoto sales by sales factor

union all 
--TOTO
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
3 as agentinvoice_productid,
'25' as sales_type,
sum(coalesce (s.wagertotal,0) - coalesce(s.canceltotal,0))	as totalcount,  --(8)
sum(coalesce(s.salesamount,0)) as totalamount ,
'TOTO' as sub_prod
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid

-----40. GST TAX rate
union all 
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
prd.prodid as agentinvoice_productid,
'40'as sales_type,
0 as totalcount, 
gst.gstrate,
prd.prodname as sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst = True
)lc
cross join 
(
	select prodid, prodname from ubt_temp_product where prodid in (2,3,4) --lottery / es
)prd
cross join
(
	select  gstrate from public.ztubt_gstconfig	a  
	where 
	(vactualdate between effectivefrom and enddate) or (vactualdate >=effectivefrom and enddate is null) 
	limit 1 
)gst

union all 
--------59. House syndicate cancel amount - [iTOTO cancellations
--TOTO
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid, 
'59'as sales_type, 
count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)	as totalcount, 
sum(coalesce(cb.cancelledamout,0))	as totalamount,
'TOTO' as sub_prod
from ubt_temp_cancelledbeticket cb
inner join ubt_temp_iTotolocation itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true
inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cb.prodid = 3  
	and cb.cancelleddate >= vfromdateIGT and cb.cancelleddate < vtodateIGT --(30)

group by lc.locdisplayid,c.chdisplayid

union all 
--------60. Player syndicate sales amount by sales factor 
--TOTO, totomatch
select l.locdisplayid	as locdisplayid ,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
s.prodid	as agentinvoice_productid,
'60'	as sales_type, 
sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))as totalcount, --(8)
sum(coalesce(s.salesamount,0)) as totalamount,
case when s.bettype = 1 then 'TOTO'
	else 'TOTO MATCH' end as sub_prod
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,s.prodid,
	case when s.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end

union all 

---------69. player syndicate sales amount 

--TOTO, totomatch
select	l.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,  
3 as agentinvoice_productid, 
'69'as sales_type,
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0)) as totalamount,
case when s.bettype = 1 then 'TOTO'
	else 'TOTO MATCH' end as sub_prod
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,
	case when s.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end

union all

-----------70 [	 GROUP TOTO Cancel Amount
--TOTO, totomatch
select      lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'70'as sales_type, 
count(distinct gt.grouphostid)	as totalcount,  
sum(coalesce(cbt.cancelledamout,0))	as totalamount,
case when gt.bettype = 1 then 'TOTO'
	else 'TOTO MATCH' end as sub_prod
from ubt_temp_cancelledbeticket cbt
inner join ubt_temp_grouptotolocation gt on cbt.ticketserialnumber = gt.ticketserialnumber
inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cbt.prodid = 3 
and cbt.cancelleddate >= vfromdateIGT and cbt.cancelleddate < vtodateIGT 
group by lc.locdisplayid,c.chdisplayid,
	case when gt.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end

union all
-----------------105 Sales Commision Rate
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission,
'' as sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (2,4) --lottery / es
)sal

union all
--TOTO, totomatch
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission,
sp.sub_prod 
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (3)
)sal
cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp

union all 

--------108 AT_ON_EZLINK--  NETS
----110	AT_ON_ATM--- Flashpay
---112	AT_ON_CASHCARD

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case a.productname when 'NETS' then '108'	
 when 'Flashpay' then '110' when 'CASHCARD' then '112' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
sum(coalesce(a.amount,0)) as amount,
'' as sub_prod
		from	ubt_temp_location as lc 
left join ubt_temp_chain c on lc.chid = c.chid
left join ubt_temp_terminal  as ter on  ter.locid=lc.locid
left join ubt_temp_resultcashlesslocation a on a.terdisplayid = ter.terdisplayid
		where a.productname in ('NETS','Flashpay','CASHCARD')
		group by lc.locdisplayid,c.chdisplayid,a.productname
		
		
union all 
---------116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor

select loc.locdisplayid, vinvoiceperiodid as agentinvoice_invid, ch.chdisplayid, fin.agentinvoice_productid,
'116'	as sales_type, sum(fin.totalcount), (sum(fin.totalamount) * 100),
fin.sub_prod as sub_prod
		from
		(
			select	a.actualdate,
	a.terdisplayid	as terdisplayid,	
	a.prodid	as agentinvoice_productid,	
	sum(coalesce(a.total,0) - coalesce(can.total,0))	as totalcount, --(8)
	round(trunc(sum(coalesce(a.amount,0)) / 100,2), 2)	as totalamount ,
	a.sub_prod
			from
			(
select cast(pb.createddate as date) actualdate, a.ticketserialnumber, 
sum(a.sales + a.secondsales) as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid,
	case pb.prodid
		when 6 then 5 else pb.prodid
		end as prodid, --(15)
		case when pb.prodid <> 3 then ''
			when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
			) then 'TOTO MATCH' 
		else 'TOTO' end as sub_prod
from ubt_temp_getamounttrans a 
inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 

where
pb.iscancelled = false and (
		(
		pb.prodid in (2,3,4) --lottery / es
		and (pb.createddate between vfromdatetimeIGT_UTC and vtodatetimeIGT_UTC )
		
		)
		or --(15)
		(
		pb.prodid in (5,6) --sports / ob
		and (pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC )
		)
		or
		(
		pb.prodid in (1) --horse racing / bmcs
		and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
		)
	)
 
group by pb.createddate , a.ticketserialnumber, pb.terdisplayid, pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
			SELECT 1 
			FROM ztubt_toto_placedbettransactionlineitem pbtlin
			WHERE pb.TranHeaderID = pbtlin.TranHeaderID
				AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
		) then 'TOTO MATCH' 
		else 'TOTO' end
			)a
			
			left join --(8)
			(
select a.ticketserialnumber,0 as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
	pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
			) then 'TOTO MATCH' 
		else 'TOTO' end as sub_prod 
from ubt_temp_getamounttrans a 
inner join ubt_temp_cancelledbeticket cb on a.ticketserialnumber = cb.ticketserialnumber
inner join (select ticketserialnumber,terdisplayid,prodid, TranHeaderID from public.ztubt_placedbettransactionheader)  pb on a.ticketserialnumber = pb.ticketserialnumber
where pb.prodid in (2,3,4) --lottery / es
group by a.ticketserialnumber, pb.terdisplayid, pb.prodid,
	case when pb.prodid <> 3 then ''
		when pb.prodid = 3 and EXISTS (
				SELECT 1 
				FROM ztubt_toto_placedbettransactionlineitem pbtlin
				WHERE pb.TranHeaderID = pbtlin.TranHeaderID
					AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
			) then 'TOTO MATCH' 
		else 'TOTO' end
			)can on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid and a.prodid = can.prodid and a.sub_prod = can.sub_prod
		group by a.actualdate, a.terdisplayid, a.prodid , a.sub_prod
		)fin
		
		inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join ubt_temp_chain ch on loc.chid = ch.chid
		group by loc.locdisplayid, ch.chdisplayid, fin.agentinvoice_productid, fin.sub_prod;

/*	update ubt_temp_datalocationinvoice tt
		set totalcount = fin.totalcount
		from (	
			select td2.locdisplayid,td2.agentinvoice_finidn,td2.agentinvoice_productid,td2.totalcount
			from  ubt_temp_datalocationinvoice td2 where td2.sales_type = '7'
		)fin  
		where  tt.locdisplayid = fin.locdisplayid and tt.agentinvoice_finidn = fin.agentinvoice_finidn 
		and tt.sales_type ='116'
	;*/
	
-- [2022-04-05] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation

create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('211801001', 4, 'SWEEP','2021-11-18'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vstartperiod,vendperiod);

create temp table if not exists ubt_temp_sales_scandsr_loc
	(
	LocDisplayID varchar(200),
	AgentInvoice_invId varchar(100),
	AgentInvoice_finidn varchar(200),
	AgentInvoice_productId int4,
	Sales_type varchar(100),
	TotalCount int,
	Amount decimal(32, 11)
	);


Insert into ubt_temp_sales_scandsr_loc
SELECT	LOC.LocDisplayID	as LocDisplayID,
		vinvoiceperiodid			as AgentInvoice_invId,
		CH.CHDisplayID		as AgentInvoice_finidn ,
		RS.ProdID			as AgentInvoice_productId,
		'116'					aS sales_type,
		SUM(RS.TotalCount), 
		SUM(RS.Amount) * 100
FROM ubt_temp_sales_scandsr RS
INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
LEFT JOIN ubt_temp_chain CH ON LOC.CHID = CH.CHID
group by LOC.LocDisplayID,CH.CHDisplayID,CH.CHDisplayID, RS.ProdID;


DELETE FROM ubt_temp_datalocationinvoice SAL  USING ubt_temp_sales_scandsr_loc RSLoc
WHERE RSLoc.LocDisplayID = SAL.LocDisplayID AND RSLoc.AgentInvoice_productId = SAL.AgentInvoice_productId
AND SAL.Sales_type = '116';

INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, sub_prod)
	SELECT	RSLoc.LocDisplayID	as LocDisplayID,
			vinvoiceperiodid			as AgentInvoice_invId,
			RSLoc.AgentInvoice_finidn		as AgentInvoice_finidn ,
			RSLoc.AgentInvoice_productId			as AgentInvoice_productId,
			'116'					as sales_type,
			RSLoc.TotalCount, 
			RSLoc.Amount,
			'' as sub_prod
	FROM ubt_temp_sales_scandsr_loc RSLoc;

-- [2022-04-05] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--------119	AT_SALESFACTOR	
CREATE temp TABLE if not exists ubt_temp_salesfactorconfig 
	(
		prodid int4,
		salesfactor numeric(13,12)
	);

	INSERT INTO ubt_temp_salesfactorconfig 
	select A.ProdID, A.SalesFactor  
	FROM public.ztubt_salescomconfig   A 
	WHERE CommissionType=1  AND A.IsDeleted = false AND ProdID IN (2,3,4);

	
	INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, sub_prod)
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor, ''
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid <> 3
		)sfc

		union all
		--TOTO, totomatch
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor, sp.sub_prod
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid = 3
		)sfc
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp

		union all
--------571	ACT_VALID_FUND_AMT
------572	ACT_RECOVERY_AMT
		
select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case  flag  when 'FUN' then '571' when 'REC' then '572' end sales_type,
0	as totalcount,
(case when flag='FUN' then sum(coalesce(a.amount,0)) * -1
		when flag='REC' then sum(coalesce(a.amount,0)) end)		as amount,
		'' as sub_prod
		from 
		(
			select l.locid, flag, max(a.amount) as amount
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('FUN','REC') AND ProductName = 'Funding and Recovery'
			and l.loctypeid in (2,4) 
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid,c.chdisplayid,flag		

union all 

-------727	ACT_TOTAL_NETAMTDUE	Yes	Net Amt Due

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
--agentinvoice_sales
case  flag  when 'REC' then '-2' when 'FUN' then '-3' end 	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
case  flag  when 'REC' then sum(coalesce(a.amount,0)) when 'FUN' then  (sum(coalesce(a.amount,0))* -1) end as amount,
		'' as sub_prod
		from 
		(
			select l.locid,flag, max(a.amount) as amount, max(a.ct) as ct
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('REC','FUN') and productname = 'Online Adjustment'
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid, c.chdisplayid,flag

	;	
		
		insert into ubt_temp_datalocationinvoice
select	coalesce(db.locdisplayid,cr.locdisplayid)as locdisplayid,
coalesce(db.agentinvoice_invid,cr.agentinvoice_invid)	as agentinvoice_invid,
coalesce(db.agentinvoice_finidn,cr.agentinvoice_finidn)as agentinvoice_finidn ,
0		as agentinvoice_productid,
'727'		as sales_type,
0		as totalcount,
(sum(db.amount) - sum(cr.amount)) as amount,
'' as sub_prod
		from
		(
			select  a.locdisplayid as locdisplayid,
					a.agentinvoice_invid		as agentinvoice_invid, 
					a.agentinvoice_finidn		as agentinvoice_finidn,
					sum(coalesce(a.totalcount,0))			as totalcount,
					sum(coalesce(a.amount,0))as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in
			(
				'2', 		--cancel amount
				'3',		--validation amount
				'7',		--commission amount
				'6', 		-- gst tax amount
				'108', 	--?nets transaction
				'110', 	--?flashpay transaction
				'112', 	--?cashcard transaction
				'571', 	--funding
				'4', 		--rebate
				'61', 	--refund--(6)5, --refund
				'-3' 		-- crd adj
			)		
			and agentinvoice_productid != 31 --(15) exclude offline orders in the net amount due calculation
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn
		) cr
		full outer join 
		(
			select  a.locdisplayid as locdisplayid,
				a.agentinvoice_invid		as agentinvoice_invid, 
				a.agentinvoice_finidn		as agentinvoice_finidn,
				sum(coalesce(a.totalcount,0))as totalcount,
				sum(coalesce(a.amount,0))	as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in('1','572','-2')   --1,	--collection	572, --recovery		-2 --dbt adj
		
			and agentinvoice_productid != 31 
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn	
		) db 
		on db.locdisplayid=cr.locdisplayid and db.agentinvoice_invid=cr.agentinvoice_invid 
		and db.agentinvoice_finidn=cr.agentinvoice_finidn
		group by db.locdisplayid, db.agentinvoice_invid,db.agentinvoice_finidn, 
		cr.locdisplayid, cr.agentinvoice_invid	,cr.agentinvoice_finidn
;

--CLEAR REFUND, REBATE, ADJ, COLLECTION DATA
	DELETE FROM ubt_temp_datalocationinvoice WHERE Sales_type IN('-2', '-3')
	;

-- for both types of toto
INSERT INTO ubt_temp_datalocationinvoice
-- sum totomatch and t649
select LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, sum(TotalCount), sum(Amount), ''
from ubt_temp_datalocationinvoice td
where sub_prod in ('TOTO MATCH', 'TOTO') and Sales_type not in ('40', '119', '105')
group by LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type

union all

-- config - clone totomatch config for product Toto (t649 and totomatch)
select LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount, ''
from ubt_temp_datalocationinvoice td
where sub_prod in ('TOTO MATCH') and Sales_type in ('40', '119', '105');

UPDATE ubt_temp_datalocationinvoice td--(12)FinalTempDataLocationInvoice--(1)UPDATE TempDataLocationInvoice
		SET agentinvoice_productid = CASE 
					WHEN td.agentinvoice_productid::int = 3 AND td.sub_prod = 'TOTO' THEN 71
					WHEN td.agentinvoice_productid::int = 3 AND td.sub_prod = 'TOTO MATCH' THEN 66
					ELSE p.SAPProdID
				END
		from public.ztubt_sap_product  p
		where td.agentinvoice_productid = p.prodid 
;


		return query
		SELECT Distinct
			coalesce(LocDisplayID, '') LocDisplayID
			,coalesce(AgentInvoice_invId, '') as AgentInvoice_invId
			,coalesce(AgentInvoice_finidn, '') as AgentInvoice_finidn
			,coalesce(AgentInvoice_productId, 0) as AgentInvoice_productId
			,coalesce(Sales_type, '') as Sales_type
			,TotalCount
			,Amount
		
		FROM ubt_temp_datalocationinvoice
	WHERE (TotalCount!=0 or Amount!=0) AND (coalesce(AgentInvoice_finidn,'') <> '')
			AND AgentInvoice_invId in(  vinvoiceperiodid ) --(4)
			;

drop table ubt_temp_terminal;
drop table ubt_temp_location;
drop table ubt_temp_chain;
drop table ubt_temp_product;
drop table ubt_temp_cancelledbeticket;
drop table ubt_temp_getamounttrans;
drop table ubt_temp_resultcashlesslocation;
drop table ubt_temp_iTotolocation;
drop table	ubt_temp_groupTotolocation;
drop table  ubt_temp_salesgroupTotolocation;
drop table 	ubt_temp_salesTotolocation;
drop table 	ubt_temp_transamountdetaildata;
drop table	ubt_temp_datalocationinvoice;
drop table 	ubt_temp_salesfactorconfig;
drop table ubt_temp_pbth; 
-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
drop table ubt_temp_sales_scandsr;
drop table ubt_temp_sales_scandsr_loc;
	end;
$$;


ALTER FUNCTION public.sp_ubt_getlocationinvoice_bk20250326(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1268 (class 1255 OID 2030153)
-- Name: sp_ubt_getlocationinvoice_testorg(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getlocationinvoice_testorg(businessdate date) RETURNS TABLE(locdisplayid character varying, agentinvoice_invid character varying, agentinvoice_finidn character varying, agentinvoice_productid integer, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	vbusinessdate date;
	vinputdate date;
	vstartperiod date;
	vendperiod date;
	vfromdateIGT timestamp;
	vtodateIGT timestamp;
	vfromdatetimeIGT_UTC timestamp;
	vtodatetimeIGT_UTC timestamp;
	vfromdatetimeOB_UTC timestamp;
	vtodatetimeOB_UTC timestamp;
	vfromdatetimeBMCS_UTC timestamp;
	vtodatetimeBMCS_UTC timestamp;
	
	vinvoiceperiodid varchar(100);
	vactualdate date;
	
	BEGIN	
	select businessdate into  vbusinessdate ;
	select  (vbusinessdate :: date) +  interval '1 DAY' into  vinputdate ;

	select (vbusinessdate :: date) + interval '1 DAY' into  vactualdate ;
	
	
select case when to_char(vinputdate:: date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date )- interval '3 day'
else date_trunc('week',vinputdate ::date ) end ,

case when to_char(vinputdate  ::date ,'dy' ) in ('mon','tue','wed','thu')
then date_trunc('week',vinputdate  ::date)- interval '1 day'
else date_trunc('week',vinputdate ::date )+ interval '3 day' end 

into  vstartperiod,vendperiod;

select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,
utcfromdatetimeob,utctodatetimeob,utcfromdatetimebmcs, utctodatetimebmcs

into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
from public.sp_ubt_getcommonubtdates(vstartperiod,vendperiod);

select cast(invoiceperiodid as varchar)
into  vinvoiceperiodid
from public.ztubt_invoiceperiod zi  where startdate=vstartperiod and enddate=vendperiod;



create temp table if not exists ubt_temp_terminal
(
terdisplayid varchar(100),
locid int4
);

create temp table if not exists ubt_temp_location
(
locid int4,
locdisplayid varchar(100),
sweepindicator int4,
loctypeid int4,
isgst bool,
accountnumber varchar(100),
branchid varchar(100),
bankid varchar(100),
locname varchar(100),
isibg bool,
retid int4,
chid int4
);

create temp table if not exists ubt_temp_product
(
ProdID int4,
ProdName varchar(100)
);




insert into ubt_temp_terminal
	select ter.terdisplayid, ter.locid
	from public.ztubt_terminal ter;
	
	insert into ubt_temp_location
	select loc.locid, loc.locdisplayid, loc.sweepindicator,loc.loctypeid,loc.isgst,loc.accountnumber,
	loc.branchid,loc.bankid,loc.locname,loc.isibg,loc.retid,loc.chid	
	from public.ztubt_location loc;
	
	insert into ubt_temp_product
	select pd.prodid, case   pd.prodid when 5 then 'SPORTS' else trim(pd.prodname) end prodname
	from public.ztubt_product pd
	where pd.prodid != 6 ;--(15) remove sports live so that all sports refer to productid = 5 only

--	UPDATE public.ztubt_product SET prodname = 'SPORTS' WHERE ProdID = 5 ;--(15) rename "Sports %" to be "Sports" only
	
	create temp table if not exists ubt_temp_chain
	(
	chid int4,
	chdisplayid varchar(100),
	chname varchar(100)
	);

create temp table if not exists ubt_temp_cancelledbeticket
	(
	ticketserialnumber varchar(500),
	CancelledDate timestamp,
	CancelledAmout numeric(22,2),
	ProdID int4,
	TerDisplayID varchar(100)
	);

	insert into ubt_temp_chain

	select zc.chid, zc.chdisplayid, zc.chname	from public.ztubt_chain zc ;
	
	insert into ubt_temp_cancelledbeticket
	select cb.ticketserialnumber,cb.cancelleddate,cb.cancelledamout,cb.prodid,cb.terdisplayid
	from public.ztubt_cancelledbetticket cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
	on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateigt and vtodateigt ;
	
create index  idx_ubt_cancelledbetticket_tck_prdid_candt on ubt_temp_cancelledbeticket (ticketserialnumber,Prodid, CancelledDate)
;
	
	
	create temp table if not exists ubt_temp_getamounttrans --(12)
(
	ticketserialnumber varchar(500),
	wager numeric(22,2),
	secondwager numeric(22,2),
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2),
	winningamount numeric(22,2) 
);

	INSERT INTO ubt_temp_getamounttrans 
	select * from public.sp_ubt_getamounttransaction(vstartperiod,vendperiod);

create index  idx_ubt_getamounttrans_ticket on ubt_temp_getamounttrans (ticketserialnumber)
;



create temp table if not exists ubt_temp_resultcashlesslocation
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(22, 11),
ct int4
	);
	
	insert into ubt_temp_resultcashlesslocation
	select pd.terdisplayid, 
	case pd.PaymentTypeID  when 'NC' then 'NETS'
	when 	'NN' then 'NETS'
	 when 'NCC' then 'CASHCARD'
	 when 'NFP' then 'Flashpay' end,
	 coalesce(sum(coalesce(pd.paidamount,0)),0), count(distinct pd.paymentdetailid)
from  public.ztubt_paymentdetail  pd 
where pd.paymenttypeid IN ('NC','NN','NCC','NFP')--(7)--nets
and pd.createddate >= vfromdatetimeIGT_UTC 	and pd.createddate < vtodatetimeIGT_UTC --(30)

group by pd.terdisplayid,pd.PaymentTypeID ;

create index  idx_ubt_cashless_terdsplid on ubt_temp_resultcashlesslocation (terdisplayid)
;	
	
	create temp table if not exists ubt_temp_iTotolocation 
	(
TicketSerialNumber VARCHAR(200),
iTotoIndicator bool,
GroupUnitSequence int4
	);

	insert into ubt_temp_itotolocation
select distinct ticketserialnumber, itotoindicator, groupunitsequence
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where (groupunitsequence = 1) or --group toto
 (itotoindicator = true) --itoto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create index  idx_ubt_itotoloc_ticket on ubt_temp_iTotolocation (ticketserialnumber)
;	
	
	create temp table if not exists ubt_temp_groupTotolocation
	(
ticketserialnumber varchar(200),
grouphostid varchar(50),
groupunitsequence int4
	);

insert into ubt_temp_grouptotolocation
select distinct ticketserialnumber, grouphostid, groupunitsequence
from  public.ztubt_placedbettransactionheader  pb
inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
where groupunitsequence is not null --group toto
and (pb.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc );

create index  idx_ubt_grptotoloc_ticket on ubt_temp_groupTotolocation (ticketserialnumber)
;	
-----------------------------------------------------------------

create temp table ubt_temp_pbth as 
select terdisplayid,ticketserialnumber,createddate
from public.ztubt_placedbettransactionheader pbt
where  
	pbt.prodid = 3 
and (pbt.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
;
create temp table if not exists ubt_temp_salesgroupTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);
	

insert into ubt_temp_salesgroupTotolocation (locid, chid, prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100 )--(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, --gb.actualdate, --(10)
	pbth.terdisplayid, 
	--lc.chid,
	3 as prodid, 
	1 as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1) as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, --(1)sum(coalesce(pbtl.betpriceamount,0))	 as totalamount
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
--from public.ztubt_placedbettransactionheader  pbth
	from ubt_temp_pbth  pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager,
case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
	(
select gat.ticketserialnumber, gat.wager, gat.sales 
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
	
inner join ubt_temp_cancelledbeticket  cb on gat.ticketserialnumber =  cb.ticketserialnumber
where itoto.groupunitsequence = 1 --group toto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where  
	pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/	

	group by pbth.terdisplayid, (pbth.createddate :: date) --gb.actualdate --(10)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype;
	
create index  idx_ubt_salegrptotoloc_locid_prodid on ubt_temp_salesgroupTotolocation (locid,prodid)
;		

	create temp table if not exists ubt_temp_salesTotolocation
	(
locid int4,
chid int4,
prodid int4,
bettype int4,
wagertotal int4,--(8)
canceltotal int4,--(8)
wageramount numeric(32, 11), --wager of each product
salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	)
;


	INSERT INTO ubt_temp_salesTotolocation(LocID, CHID, ProdID, BetType, WagerTotal, CancelTotal, WagerAmount, SalesAmount)
	select loc.locid, loc.chid, fin.prodid, fin.bettype, sum(fin.wagertotal), sum(fin.canceltotal), sum(fin.wageramount), 
(sum(fin.salesamount) * 100) --(10)convert back from dollars to cents
from
(
	select  (pbth.createddate :: date) actualdate, 
	pbth.terdisplayid as terdisplayid,	
	3 as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal,
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	round (trunc(sum(coalesce(fin.sales,0)) / 100,2), 2)	as salesamount 
	--from	public.ztubt_placedbettransactionheader pbth
	from ubt_temp_pbth pbth
	inner join 
	(
select gat.ticketserialnumber, gat.wager, 
case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
left join --(9)
(
	
	select cb.ticketserialnumber from ubt_temp_cancelledbeticket cb
)can on gat.ticketserialnumber = can.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join --(8)
	(
select gat.ticketserialnumber, gat.wager, gat.sales 
from ubt_temp_iTotolocation itoto
inner join ubt_temp_getamounttrans gat on itoto.ticketserialnumber = gat.ticketserialnumber
inner join ubt_temp_cancelledbeticket cb on gat.ticketserialnumber = cb.ticketserialnumber
where itoto.itotoindicator = true --itoto
	)can on pbth.ticketserialnumber = can.ticketserialnumber
	
/*	where pbth.prodid = 3 
and (pbth.createddate between vfromdatetimeigt_utc   and vtodatetimeigt_utc )
*/
	
	group by pbth.terdisplayid, (pbth.createddate :: date)
)fin
inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
inner join ubt_temp_location loc on ter.locid = loc.locid
group by loc.locid, loc.chid, fin.prodid, fin.bettype
	;

create index  idx_ubt_saletotoloc_locid_prodid on ubt_temp_salesTotolocation (locid,prodid)
;		

--=================================
--FILL IN TRANS AMOUNT DETAIL DATA
--=================================

create temp table if not exists ubt_temp_transamountdetaildata 
	(
terdisplayid varchar(200),
productname varchar(100),
amount numeric(32,13),
ct int4,
flag char(3),
transtype char(3),
fromdate date,
todate date
	);

	Insert Into ubt_temp_transamountdetaildata
select 
terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
from public.sp_ubt_gettransamountdetails_testorg (vstartperiod,vendperiod);

	/*UPDATE ubt_temp_transamountdetaildata
	SET amount = amount * 100;*/

create index  idx_ubt_transamt_terdisplayid on ubt_temp_transamountdetaildata (terdisplayid)
;	
create index  idx_ubt_transamt_productname on ubt_temp_transamountdetaildata (productname)
;	
create index  idx_ubt_transamt_flag on ubt_temp_transamountdetaildata (flag)
;	
create index  idx_ubt_transamt_transtype on ubt_temp_transamountdetaildata (transtype)
;	
--------------------------------------------------------------------------------------------	
	create temp table if not exists ubt_temp_datalocationinvoice
	(
locdisplayid varchar(200) ,
agentinvoice_invid varchar(100) ,
agentinvoice_finidn varchar(200) ,
agentinvoice_productid int4 ,
sales_type varchar(100) ,
totalcount int4 ,
amount numeric(32, 11) 
	) 
	;
 
insert into ubt_temp_datalocationinvoice (locdisplayid, agentinvoice_invid, agentinvoice_finidn, agentinvoice_productid, sales_type, totalcount, amount)
	
select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,  
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) 
group by lc.locdisplayid,c.chdisplayid,pr.prodid

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'1'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) 	as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='COL' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid

----------2	AT_CANCELAMT
----------3 AT_VALIDAMT
----------4 AT_VALIDAMT

union all 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.Flag when 'CAN' then '2'
   when 'PAY' then '3'
   when 'RBT' then '4' end as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce (a.amount,0)) * -1	as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('CAN','PAY','RBT') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag
	
union all 

-----61	Refund Amount--(5)(6)

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce (a.ct,0))	as totalcount, 
sum(coalesce(a.amount,0)) * -1	as amount  
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype != 'OO' and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by lc.locdisplayid,c.chdisplayid,pr.prodid

--offline orders - refund
	
union all

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
31	as agentinvoice_productid,
'61'	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
(sum(coalesce(a.amount,0)) * -1) as amount 
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where flag='RFD' and transtype = 'OO'
group by lc.locdisplayid,c.chdisplayid


union all 
-----6	AT_TAXAMT 
-----7	AT_COMMAMT 

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid as agentinvoice_finidn ,
pr.prodid	as agentinvoice_productid,
case a.flag when 'GST' then '6' when 'SAL'then '7' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
(sum(coalesce(a.amount,0)) * -1)as amount  
from ubt_temp_transamountdetaildata a
inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
inner join ubt_temp_product pr on a.productname = pr.prodname
left join ubt_temp_chain c on lc.chid = c.chid
where a.flag in ('GST', 'SAL') and pr.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)ltrim(rtrim(productname)) in ('4d lottery','singapore sweep','toto')
group by 	lc.locdisplayid,c.chdisplayid,pr.prodid,a.flag


union all 
------16. AT_FRACVALAMT

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'16'as sales_type,
count(distinct vb.tranheaderid)	as totalcount, --(16) --(1)count(1)as totalcount, 
sum(coalesce(vb.winningamount,0))as totalamount--(1) sum(coalesce(vb.amount,0))as totalamount
from 
(
	select vb.tranheaderid,vb.winningamount,vb.terdisplayid,vb.createdvalidationdate 
	from public.ztubt_validatedbetticket  vb --(16)
	inner join  public.ztubt_validatedbetticketlifecyclestate  vbt
on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
	where vb.winningamount != 0 and vb.winningamount is not null --(8)
	and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	
)vb
	
inner join
(
	select distinct tranheaderid, grouphostid, groupunitsequence 
	from  public.ztubt_toto_placedbettransactionlineitem ztp  
) ph on vb.tranheaderid = ph.tranheaderid --(16)

inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid

where ph.groupunitsequence is not null --(16)
group by lc.locdisplayid,c.chdisplayid

----52. House syndicate sales amount

union all 

select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
s.prodid as agentinvoice_productid, 
'52'as sales_type, 
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0))	as totalamount--(1)(coalesce(s.amount,0))	as totalamount
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid, s.prodid


-------25. house syndicate sales amount by sales factor [itoto sales by sales factor

union all 
select	l.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
3 as agentinvoice_productid,
'25' as sales_type,
sum(coalesce (s.wagertotal,0) - coalesce(s.canceltotal,0))	as totalcount,  --(8)
sum(coalesce(s.salesamount,0)) as totalamount 
from ubt_temp_salestotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid

-----40. GST TAX rate
union all 
select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
prd.prodid as agentinvoice_productid,
'40'as sales_type,
0 as totalcount, 
gst.gstrate
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst = True
)lc
cross join 
(
	select prodid from ubt_temp_product where prodid in (2,3,4) --lottery / es
)prd
cross join
(
	select  gstrate from public.ztubt_gstconfig	a  
	where 
	(vactualdate between effectivefrom and enddate) or (vactualdate >=effectivefrom and enddate is null) 
	limit 1 
)gst

union all 
--------59. House syndicate cancel amount - [iTOTO cancellations

select	lc.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid, 
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid, 
'59'as sales_type, 
count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)	as totalcount, 
sum(coalesce(cb.cancelledamout,0))	as totalamount
from ubt_temp_cancelledbeticket cb
inner join ubt_temp_iTotolocation itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true
inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cb.prodid = 3  
	and cb.cancelleddate >= vfromdateIGT and cb.cancelleddate < vtodateIGT --(30)

group by lc.locdisplayid,c.chdisplayid	

union all 
--------60. Player syndicate sales amount by sales factor 

select l.locdisplayid	as locdisplayid ,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,
s.prodid	as agentinvoice_productid,
'60'	as sales_type, 
sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))as totalcount, --(8)
sum(coalesce(s.salesamount,0)) as totalamount 
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid,s.prodid 

union all 

---------69. player syndicate sales amount 

select	l.locdisplayid as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn,  
3 as agentinvoice_productid, 
'69'as sales_type,
sum(coalesce (s.wagertotal,0))	as totalcount, 
sum(coalesce (s.wageramount,0)) as totalamount
from ubt_temp_salesgrouptotolocation s
inner join ubt_temp_location l on s.locid = l.locid
left join ubt_temp_chain c on l.chid = c.chid
group by l.locdisplayid, c.chdisplayid

union all

-----------70 [	 GROUP TOTO Cancel Amount

select      lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid	as agentinvoice_finidn, 
3 as agentinvoice_productid,
'70'as sales_type, 
count(distinct gt.grouphostid)	as totalcount,  
sum(coalesce(cbt.cancelledamout,0))	as totalamount
from ubt_temp_cancelledbeticket cbt
inner join ubt_temp_grouptotolocation gt on cbt.ticketserialnumber = gt.ticketserialnumber
inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
inner join ubt_temp_location lc on ter.locid = lc.locid
left join ubt_temp_chain c on lc.chid = c.chid
where cbt.prodid = 3 
and cbt.cancelleddate >= vfromdateIGT and cbt.cancelleddate < vtodateIGT 

group by lc.locdisplayid,c.chdisplayid

union all
-----------------105 Sales Commision Rate

select lc.locdisplayid	as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
lc.chdisplayid	as agentinvoice_finidn,
sal.prodid as agentinvoice_productid,
'105' as sales_type,
0 as totalcount,--(1)count(1) as totalcount,
sal.salescommission
from	
(
	select lc.locdisplayid, ch.chdisplayid from ubt_temp_location lc
	left join ubt_temp_chain ch on lc.chid = ch.chid
	where lc.isgst =true
)lc
cross join
(
	select distinct salescommission, prodid from public.ztubt_salescomconfig  a 
	where commissiontype=1 and  isdeleted = false and prodid in (2,3,4) --lottery / es
)sal

union all 

--------108 AT_ON_EZLINK--  NETS
----110	AT_ON_ATM--- Flashpay
---112	AT_ON_CASHCARD

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case a.productname when 'NETS' then '108'	
 when 'Flashpay' then '110' when 'CASHCARD' then '112' end as sales_type,
sum(coalesce(a.ct,0))	as totalcount,
sum(coalesce(a.amount,0))	as amount 
		from	ubt_temp_location as lc 
left join ubt_temp_chain c on lc.chid = c.chid
left join ubt_temp_terminal  as ter on  ter.locid=lc.locid
left join ubt_temp_resultcashlesslocation a on a.terdisplayid = ter.terdisplayid
		where a.productname in ('NETS','Flashpay','CASHCARD')
		group by lc.locdisplayid,c.chdisplayid,a.productname
		
		
union all 
---------116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor

select loc.locdisplayid, vinvoiceperiodid as agentinvoice_invid, ch.chdisplayid, fin.agentinvoice_productid,
'116'	as sales_type, sum(fin.totalcount), (sum(fin.totalamount) * 100) 
		from
		(
			select	a.actualdate,
	a.terdisplayid	as terdisplayid,	
	a.prodid	as agentinvoice_productid,	
	sum(coalesce(a.total,0) - coalesce(can.total,0))	as totalcount, --(8)
	round(trunc(sum(coalesce(a.amount,0)) / 100,2), 2)	as totalamount 
	
			from
			(
select cast(pb.createddate as date) actualdate, a.ticketserialnumber, 
sum(a.sales + a.secondsales) as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid,
	case pb.prodid
		when 6 then 5 else pb.prodid
		end as prodid --(15)
from ubt_temp_getamounttrans a 
inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 

where
pb.iscancelled = false and (
		(
		pb.prodid in (2,3,4) --lottery / es
		and (pb.createddate between vfromdatetimeIGT_UTC and vtodatetimeIGT_UTC )
		
		)
		or --(15)
		(
		pb.prodid in (5,6) --sports / ob
		and (pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC )
		)
		or
		(
		pb.prodid in (1) --horse racing / bmcs
		and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
		)
	)
 
group by pb.createddate , a.ticketserialnumber, pb.terdisplayid, pb.prodid
			)a
			
			left join --(8)
			(
select a.ticketserialnumber,0 as amount, count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
pb.prodid
from ubt_temp_getamounttrans a 
inner join ubt_temp_cancelledbeticket cb on a.ticketserialnumber = cb.ticketserialnumber
inner join (select ticketserialnumber,terdisplayid,prodid from public.ztubt_placedbettransactionheader)  pb on a.ticketserialnumber = pb.ticketserialnumber
where pb.prodid in (2,3,4) --lottery / es
group by a.ticketserialnumber, pb.terdisplayid, pb.prodid
			)can on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid and a.prodid = can.prodid
		group by a.actualdate,		a.terdisplayid, a.prodid 
		)fin
		
		inner join ubt_temp_terminal ter on fin.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join ubt_temp_chain ch on loc.chid = ch.chid
		group by loc.locdisplayid, ch.chdisplayid, fin.agentinvoice_productid;

		
	 
/*	update ubt_temp_datalocationinvoice tt
		set totalcount = fin.totalcount
		from (	
			select td2.locdisplayid,td2.agentinvoice_finidn,td2.agentinvoice_productid,td2.totalcount
			from  ubt_temp_datalocationinvoice td2 where td2.sales_type = '7'
		)fin  
		where  tt.locdisplayid = fin.locdisplayid and tt.agentinvoice_finidn = fin.agentinvoice_finidn 
		and tt.sales_type ='116'
	;*/
	
-- [2022-04-05] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation

create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('211801001', 4, 'SWEEP','2021-11-18'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vstartperiod,vendperiod);

create temp table if not exists ubt_temp_sales_scandsr_loc
	(
	LocDisplayID varchar(200),
	AgentInvoice_invId varchar(100),
	AgentInvoice_finidn varchar(200),
	AgentInvoice_productId int4,
	Sales_type varchar(100),
	TotalCount int,
	Amount decimal(32, 11)
	);


Insert into ubt_temp_sales_scandsr_loc
SELECT	LOC.LocDisplayID	as LocDisplayID,
		vinvoiceperiodid			as AgentInvoice_invId,
		CH.CHDisplayID		as AgentInvoice_finidn ,
		RS.ProdID			as AgentInvoice_productId,
		'116'					aS sales_type,
		SUM(RS.TotalCount), 
		SUM(RS.Amount) * 100
FROM ubt_temp_sales_scandsr RS
INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
LEFT JOIN ubt_temp_chain CH ON LOC.CHID = CH.CHID
group by LOC.LocDisplayID,CH.CHDisplayID,CH.CHDisplayID, RS.ProdID;


DELETE FROM ubt_temp_datalocationinvoice SAL  USING ubt_temp_sales_scandsr_loc RSLoc
WHERE RSLoc.LocDisplayID = SAL.LocDisplayID AND RSLoc.AgentInvoice_productId = SAL.AgentInvoice_productId
AND SAL.Sales_type = '116';

INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount)
	SELECT	RSLoc.LocDisplayID	as LocDisplayID,
			vinvoiceperiodid			as AgentInvoice_invId,
			RSLoc.AgentInvoice_finidn		as AgentInvoice_finidn ,
			RSLoc.AgentInvoice_productId			as AgentInvoice_productId,
			'116'					as sales_type,
			RSLoc.TotalCount, 
			RSLoc.Amount
	FROM ubt_temp_sales_scandsr_loc RSLoc;

-- [2022-04-05] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--------119	AT_SALESFACTOR	
CREATE temp TABLE if not exists ubt_temp_salesfactorconfig 
	(
		prodid int4,
		salesfactor numeric(13,12)
	);

	INSERT INTO ubt_temp_salesfactorconfig 
	select A.ProdID, A.SalesFactor  
	FROM public.ztubt_salescomconfig   A 
	WHERE CommissionType=1  AND A.IsDeleted = false AND ProdID IN (2,3,4);

	
	INSERT INTO ubt_temp_datalocationinvoice(LocDisplayID, AgentInvoice_invId, AgentInvoice_finidn, AgentInvoice_productId, Sales_type, TotalCount, Amount)
		select loc.locdisplayid, vinvoiceperiodid	as agentinvoice_invid, loc.chdisplayid, sfc.prodid, '119', 0, sfc.salesfactor
		from 
		(
			select loc.locdisplayid, ch.chdisplayid from ubt_temp_location loc
			inner join ubt_temp_chain ch on loc.chid = ch.chid
		)loc
		cross join 
		(
			select sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc
		)sfc

		union all
--------571	ACT_VALID_FUND_AMT
------572	ACT_RECOVERY_AMT
		
select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
case  flag  when 'FUN' then '571' when 'REC' then '572' end sales_type,
0	as totalcount,
(case when flag='FUN' then sum(coalesce(a.amount,0)) * -1
		when flag='REC' then sum(coalesce(a.amount,0)) end)		as amount 
		from 
		(
			select l.locid, flag, max(a.amount) as amount
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('FUN','REC') AND ProductName = 'Funding and Recovery'
			and l.loctypeid in (2,4) 
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid,c.chdisplayid,flag		

union all 

-------727	ACT_TOTAL_NETAMTDUE	Yes	Net Amt Due

select	lc.locdisplayid		as locdisplayid,
vinvoiceperiodid	as agentinvoice_invid,
c.chdisplayid		as agentinvoice_finidn ,
0	as agentinvoice_productid,
--agentinvoice_sales
case  flag  when 'REC' then '-2' when 'FUN' then '-3' end 	as sales_type,
sum(coalesce(a.ct,0))	as totalcount, 
case  flag  when 'REC' then sum(coalesce(a.amount,0)) when 'FUN' then  (sum(coalesce(a.amount,0))* -1) end as amount 
		from 
		(
			select l.locid,flag, max(a.amount) as amount, max(a.ct) as ct
			from ubt_temp_transamountdetaildata a
			inner join ubt_temp_terminal t on a.terdisplayid = t.terdisplayid
			inner join ubt_temp_location l on t.locid = l.locid
			where flag in ('REC','FUN') and productname = 'Online Adjustment'
			group by l.locid,flag
		)a 
		inner join ubt_temp_location lc on a.locid = lc.locid
		left join ubt_temp_chain c on lc.chid = c.chid
		group by lc.locdisplayid, c.chdisplayid,flag

	;	
		
		insert into ubt_temp_datalocationinvoice
select	coalesce(db.locdisplayid,cr.locdisplayid)as locdisplayid,
coalesce(db.agentinvoice_invid,cr.agentinvoice_invid)	as agentinvoice_invid,
coalesce(db.agentinvoice_finidn,cr.agentinvoice_finidn)as agentinvoice_finidn ,
0		as agentinvoice_productid,
'727'		as sales_type,
0		as totalcount,
(sum(db.amount) - sum(cr.amount))			as amount 
		from
		(
			select  a.locdisplayid as locdisplayid,
					a.agentinvoice_invid		as agentinvoice_invid, 
					a.agentinvoice_finidn		as agentinvoice_finidn,
					sum(coalesce(a.totalcount,0))			as totalcount,
					sum(coalesce(a.amount,0))as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in
			(
				'2', 		--cancel amount
				'3',		--validation amount
				'7',		--commission amount
				'6', 		-- gst tax amount
				'108', 	--?nets transaction
				'110', 	--?flashpay transaction
				'112', 	--?cashcard transaction
				'571', 	--funding
				'4', 		--rebate
				'61', 	--refund--(6)5, --refund
				'-3' 		-- crd adj
			)		
			and agentinvoice_productid != 31 --(15) exclude offline orders in the net amount due calculation
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn
		) cr
		full outer join 
		(
			select  a.locdisplayid as locdisplayid,
				a.agentinvoice_invid		as agentinvoice_invid, 
				a.agentinvoice_finidn		as agentinvoice_finidn,
				sum(coalesce(a.totalcount,0))as totalcount,
				sum(coalesce(a.amount,0))	as amount 
			from  ubt_temp_datalocationinvoice a where sales_type in('1','572','-2')   --1,	--collection	572, --recovery		-2 --dbt adj
		
			and agentinvoice_productid != 31 
			group by a.locdisplayid	, a.agentinvoice_invid,a.agentinvoice_finidn	
		) db 
		on db.locdisplayid=cr.locdisplayid and db.agentinvoice_invid=cr.agentinvoice_invid 
		and db.agentinvoice_finidn=cr.agentinvoice_finidn
		group by db.locdisplayid, db.agentinvoice_invid,db.agentinvoice_finidn, 
		cr.locdisplayid, cr.agentinvoice_invid	,cr.agentinvoice_finidn
;

--CLEAR REFUND, REBATE, ADJ, COLLECTION DATA
	DELETE FROM ubt_temp_datalocationinvoice WHERE Sales_type IN('-2', '-3')
	;

UPDATE ubt_temp_datalocationinvoice td--(12)FinalTempDataLocationInvoice--(1)UPDATE TempDataLocationInvoice
		set agentinvoice_productid = p.sapprodid
		from public.ztubt_sap_product  p
		where td.agentinvoice_productid = p.prodid 
;


		return query
		SELECT Distinct
			coalesce(LocDisplayID, '') LocDisplayID
			,coalesce(AgentInvoice_invId, '') as AgentInvoice_invId
			,coalesce(AgentInvoice_finidn, '') as AgentInvoice_finidn
			,coalesce(AgentInvoice_productId, 0) as AgentInvoice_productId
			,coalesce(Sales_type, '') as Sales_type
			,TotalCount
			,Amount
		
		FROM ubt_temp_datalocationinvoice
	WHERE (TotalCount!=0 or Amount!=0) AND (coalesce(AgentInvoice_finidn,'') <> '')
			AND AgentInvoice_invId in(  vinvoiceperiodid ) --(4)
			;

drop table ubt_temp_terminal;
drop table ubt_temp_location;
drop table ubt_temp_chain;
drop table ubt_temp_product;
drop table ubt_temp_cancelledbeticket;
drop table ubt_temp_getamounttrans;
drop table ubt_temp_resultcashlesslocation;
drop table ubt_temp_iTotolocation;
drop table	ubt_temp_groupTotolocation;
drop table  ubt_temp_salesgroupTotolocation;
drop table 	ubt_temp_salesTotolocation;
drop table 	ubt_temp_transamountdetaildata;
drop table	ubt_temp_datalocationinvoice;
drop table 	ubt_temp_salesfactorconfig;
drop table ubt_temp_pbth; 
-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
drop table ubt_temp_sales_scandsr;
drop table ubt_temp_sales_scandsr_loc;
	end;
$$;


ALTER FUNCTION public.sp_ubt_getlocationinvoice_testorg(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1143 (class 1255 OID 24787)
-- Name: sp_ubt_getoperatinghours(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getoperatinghours(transactiondate date) RETURNS
TABLE(locationname character varying, locationid character varying, terminalid character varying, opentime text, signondate text, signontime text, firstsaletime text, firsthourcount integer, closetime text, signoffdate text, signofftime text, lastsaletime text, lasthourcount integer)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	FromDate timestamp ;
	ToDate timestamp;
	ConvertToSGT int4;
	ConvertToUTC int4;
	FromDateUTC timestamp ;
	ToDateUTC timestamp ;
	
	BEGIN	
		Select(TransactionDate - interval '0 Day') into FromDate;
	
		select (((date_part('day', current_timestamp at time zone 'utc')- date_part('day', current_timestamp)) *24) + (date_part('hour',current_timestamp at time zone 'utc'  )- date_part('hour',current_timestamp )))
		into ConvertToUTC;
	
	    select (((date_part('day',current_timestamp)- date_part('day', current_timestamp at time zone 'utc')) *24) + (date_part('hour',current_timestamp  )- date_part('hour',current_timestamp at time zone 'utc' )))
	    into ConvertToSGT;
	   
		SELECT 
		   PreviousPeriodDateTime  ,
		   PeriodDateTime  into FromDate, ToDate
	    FROM ztubt_getbusinessdate_perhost zgp 
	    WHERE ActualDate = FromDate
	    ORDER BY PreviousPeriodDateTime DESC, PeriodDateTime desc
	    limit 1 ;
	   
	    select(FromDate + ( ConvertToUTC * interval'1 Hour' ) ) into  FromDateUTC;
	    select( ToDate + ( ConvertToUTC * interval'1 Hour' )) into  ToDateUTC;

	    
	    create temp table if not exists ubt_temp_t
	     (
		    TerDisplayID VARCHAR(200),
		    SessionStartDateTime timestamp,
		    SessionEndDateTime timestamp,
		    SessionStartDateTimeUTC timestamp,
		    SessionEndDateTimeUTC timestamp,
		    SweepIndicator int4
	    );
	    
	    create temp table if not exists ubt_temp_count
	     (
		   TerDisplayID VARCHAR(200),
		   FirstDate timestamp,
		   FirstCount int4,
		   LastCount int4,
		   TranHeaderLineItemId VARCHAR(500)
	     );
	    
	     

	    insert into ubt_temp_t 
	    select SESS.TerDisplayID, MIN(SessionStartDateTime) AS SessionStartDateTime, MAX(SessionEndDateTime) AS SessionEndDateTime,
	    MIN(SessionStartDateTime + (convertToUTC * interval'1 Hour')) AS SessionStartDateTime, MAX( SessionEndDateTime + (convertToUTC * interval'1 Hour')) AS SessionEndDateTime,--convert to UTC--(3)
	    LOC.SweepIndicator
	    FROM ztubt_session SESS
	    inner join ztubt_terminal ter on SESS.TerDisplayID=ter.TerDisplayID
	    inner join ztubt_location LOC on TER.LocID=LOC.LocID
	    WHERE SessionStartDateTime >= FromDate
	    AND SessionStartDateTime <= ToDate
	    GROUP BY SESS.TerDisplayID, LOC.SweepIndicator ;
	    
	   

	--collection
		--all product
		insert into ubt_temp_count
		SELECT F.TerDisplayID, F.FirstDate, F.FirstCount,  F.LastCount, F.TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tha.TerDisplayID, 
			tha.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				 tha.CreatedDate >= tt.SessionStartDateTimeUTC
				AND tha.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp 
				) then 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				tha.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp 
				AND tha.CreatedDate <= tt.SessionEndDateTimeUTC
				) then 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_placedbettransactionheader tha ON tt.TerDisplayID = tha.TerDisplayID 
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate LCS ON tha.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'PB06'
			LEFT JOIN ztubt_toto_placedbettransactionlineitem PBTL ON tha.TranHeaderID = PBTL.TranHeaderID --TOTO
			LEFT JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN ON tha.TranHeaderID = PBTLN.TranHeaderID 
			LEFT JOIN ztubt_sweep_placedbettransactionlineitem SPPBTL on SPPBTL.TranLineItemID=PBTLN.TranLineItemID
			WHERE 
			(tha.CreatedDate >= FromDateUTC
			AND tha.CreatedDate <= ToDateUTC)
			and tha.isExchangeTicket=False and IsBetRejectedByTrader=False
			AND (PBTL.GroupUnitSequence = 1 OR PBTL.GroupUnitSequence IS NULL) --for group toto
			AND (PBTLN.IsSoldOut IS NULL OR (PBTLN.IsSoldOut IS NOT NULL AND PBTLN.IsSoldOut = False)) --for sweep
			AND (tt.SweepIndicator IS NULL OR (tt.SweepIndicator IS NOT NULL AND SPPBTL.IsPrinted IS NOT NULL))
		)F
		
		UNION ALL
		SELECT F.TerDisplayID, F.FirstDate, F.FirstCount,  F.LastCount, F.TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID, 
			tha.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				tha.CreatedDate >= tt.SessionStartDateTimeUTC
				AND tha.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				tha.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND tha.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_placedbettransactionheader tha ON tt.TerDisplayID = tha.TerDisplayID 
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate LCS ON tha.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID  = 'PB03'
			INNER JOIN ztubt_sweep_placedbettransactionlineitem PBTL ON tha.TranHeaderID = PBTL.TranHeaderID 
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN ON PBTL.TranLineItemID = PBTLN.TranLineItemID AND PBTLN.IsSoldOut = False
			WHERE 
			(tha.CreatedDate >= FromDateUTC
			AND tha.CreatedDate <= ToDateUTC)
			AND IsBetRejectedByTrader = False
			AND (tt.SweepIndicator IS NOT NULL AND IsPrinted IS NULL)
		)F
		
	    UNION ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, F.TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID,
			C.CancelledDate
			AS FirstDate,
			CASE
				WHEN (
				C.CancelledDate >= tt.SessionStartDateTime
				AND C.CancelledDate <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
						CASE
				WHEN (
				C.CancelledDate >= ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
				AND C.CancelledDate <= tt.SessionEndDateTime
				) THEN 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_cancelledbetticket C ON  tt.TerDisplayID = C.TerDisplayID 
			INNER JOIN ztubt_cancelledbetticketlifecyclestate LCS ON C.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'CB06'
			INNER JOIN ztubt_placedbettransactionheader tha ON C.TranHeaderID = tha.TranHeaderID
			LEFT JOIN ztubt_toto_placedbettransactionlineitem PBTL ON C.TranHeaderID = PBTL.TranHeaderID
			WHERE 
			(C.CancelledDate >= FromDate
			AND C.CancelledDate <= ToDate)
			AND ((PBTL.GroupUnitSequence IS NOT NULL AND C.CancelledAmout != 0) OR PBTL.GroupUnitSequence IS NULL) --for group toto
			AND tha.IsBetRejectedByTrader = False
		)F
		
		union ALL (4)
		SELECT TerDisplayID, NULL, FirstCount AS FirstCount,LastCount AS LastCount, NULL
		FROM 
		(

			SELECT TerDisplayID, Types, TotalAmount,FirstDate, FirstCount, LastCount
			FROM
				(
					SELECT tt.TerDisplayID, V.TranHeaderID AS HeaderID, coalesce (WinningAmount,0) AS VALIDATED, coalesce (RebateAmount,0) AS LOSING_BET_REBATE, coalesce (RefundAmount,0) AS REFUNDED,
					V.ValidationDate
					AS FirstDate,
					CASE
						WHEN (
						V.ValidationDate >= tt.SessionStartDateTime
						AND V.ValidationDate <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
						)  then 1
						ELSE NULL
					END AS FirstCount,
					CASE
						WHEN (
						V.ValidationDate >=  ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
						AND V.ValidationDate <= tt.SessionEndDateTime
						)  THEN 1
						ELSE NULL 
					END AS LastCount
					FROM ubt_temp_t tt
					INNER JOIN ztubt_validatedbetticket V ON tt.TerDisplayID = V.TerDisplayID
					INNER JOIN ztubt_validatedbetticketlifecyclestate  LCS ON V.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'VB06'
					WHERE 
					V.ValidationDate >= FromDate
					and V.ValidationDate <= ToDate
				) p
				cross join lateral (
				values (p.VALIDATED, 'VALIDATED'),
				       (p.LOSING_BET_REBATE, 'LOSING_BET_REBATE'),
				       (p.REFUNDED, 'REFUNDED')	
				)b(TotalAmount, Types)
			) a	
			WHERE TotalAmount != 0
				
				/*UNPIVOT
				(
					TotalAmount For Types IN
						([VALIDATED],  [LOSING BET REBATE], [REFUNDED])
				) AS unpvt*/
		
		
		union ALL
		SELECT H.TerDisplayID, NULL, FirstCount,LastCount, TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID, PBTL.TranHeaderID, 
			PBTL.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				PBTL.CreatedDate >= tt.SessionStartDateTimeUTC
				AND PBTL.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				PBTL.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND PBTL.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN 1
				ELSE NULL
			END AS LastCount
			FROM ubt_temp_t tt
			INNER JOIN ztubt_horse_placedbettransactionlineitem PBTL on PBTL.TerDisplayID=tt.TerDisplayID
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate PBLC ON PBTL.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06' 
			WHERE PBTL.BoardRebateAmount > 0 AND PBTL.BoardRebateAmount IS NOT NULL
			AND (PBTL.CreatedDate >= FromDateUTC
			AND PBTL.CreatedDate <= ToDateUTC)
		) H
		
		union ALL
		SELECT F.TerDisplayID, NULL, FirstCount, LastCount, TransactionHeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			 PBT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				PB.TransactionTime >= tt.SessionStartDateTime
				AND PB.TransactionTime <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				PB.TransactionTime >= ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
				AND PB.TransactionTime <= tt.SessionEndDateTime
				) THEN 1
				ELSE NULL
			END AS LastCount
			, PB.TransactionHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_admissionvouchertransaction PBT ON tt.TerDisplayID = PBT.TerDisplayID
			INNER JOIN ztubt_offlineproductheader PB ON PBT.HeaderID = PB.TransactionHeaderID
			WHERE PBT.IsActive = True
			AND  (PB.TransactionTime >= FromDate
			AND  PB.TransactionTime <= ToDate)
		)F
		
		
		union ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, CharityTransactionID
		FROM
		(
			SELECT tt.TerDisplayID,
			CT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				CT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND CT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN CT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				CT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND CT.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN CT.RepeatedTicket
				ELSE 0
			END AS LastCount
			,CT.CharityTransactionID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_charitytickettransaction CT ON CT.TerDisplayID = tt.TerDisplayID
			WHERE 
			CT.CreatedDate >= FromDateUTC
			AND  CT.CreatedDate <= ToDateUTC
		)F
		
		union ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount,HeaderID
		FROM
		(
			select tt.TerDisplayID,
			ST.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				ST.CreatedDate >=  tt.SessionStartDateTimeUTC
				AND ST.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN ST.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				ST.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND ST.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN ST.RepeatedTicket
				ELSE 0
			END AS LastCount
			,ST.HeaderID
			from ubt_temp_t tt
			INNER JOIN ztubt_spatransaction ST ON ST.TerDisplayID = tt.TerDisplayID
			WHERE 
			ST.CreatedDate >= FromDateUTC
			AND  ST.CreatedDate <= ToDateUTC
		)F
		
				
		union ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, HeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			TCT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				TCT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND TCT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN TCT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				TCT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND TCT.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN TCT.RepeatedTicket
				else 0
			END AS LastCount
			,TCT.HeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_topupcardtransaction TCT ON TCT.TerDisplayID = tt.TerDisplayID
			WHERE 
			TCT.CreatedDate >= FromDateUTC
			AND  TCT.CreatedDate <= ToDateUTC
		)F
		
		union ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount,F.LastCount, HeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			 THT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				 THT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND  THT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN  THT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				 THT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				 AND THT.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN  THT.RepeatedTicket
				ELSE 0
			END AS LastCount
			, THT.HeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_totohongbaotransaction THT ON THT.TerDisplayID = tt.TerDisplayID
			WHERE 
			THT.CreatedDate >= FromDateUTC
			AND  THT.CreatedDate <= ToDateUTC
		)F ;
		
	 return QUERY
		SELECT loc.LocName AS LocationName,
		loc.LocDisplayID  AS LocationID,
        ter.TerDisplayID AS TerminalID,
	    to_char(oh.OpenTime::time , 'HH24:MI:ss' ) AS OpenTime,
	    to_char(tt.SessionStartDateTime::date, 'dd.MM.yyyy') AS SignOnDate,
	    to_char(tt.SessionStartDateTime::time,'HH24:MI:ss' ) AS SignOnTime,
	    to_char( TCount.FirstSaleDateTime +( 8 * interval'1 hour'), 'HH24:MI:ss') AS FirstSaleTime, --convert to SGT--(2)
	    Coalesce(TCount.FirstHourCount, 0):: int AS FirstHourCount,
	    to_char(oh.CloseTime::time , 'HH24:MI:ss' ) AS CloseTime,
	    to_char(tt.SessionEndDateTime::date, 'dd.MM.yyyy') AS SignOffDate,
	    to_char(tt.SessionEndDateTime::time,'HH24:MI:ss' ) AS SignOffTime,
	    to_char( TCount.LastSaleDateTime +( 8 * interval'1 hour'), 'HH24:MI:ss') AS LastSaleTime,
	    Coalesce(TCount.LastHourCount, 0):: int AS LastHourCount
		FROM ztubt_terminal ter 
	    LEFT JOIN ztubt_operatinghours oh 
		ON oh.LocID = ter.LocID
		AND oh.IsDeleted = False
		AND oh.DayNo = (case  extract(dow from  date (FromDate - interval '1 Day')) when 7 then 1 else
			extract(dow from  date (FromDate - interval '1 Day'))+1 end)
	    LEFT JOIN ztubt_location loc
			ON loc.LocID = ter.LocID
			AND loc.IsDeleted = False
	    LEFT JOIN ubt_temp_t tt ON ter.TerDisplayID = tt.TerDisplayID
	    LEFT JOIN
	    (
		SELECT TerDisplayID, min(FirstDate) as FirstSaleDateTime, SUM(FirstCount) AS FirstHourCount, max(FirstDate) as LastSaleDateTime, sum(LastCount) as LastHourCount
		from ubt_temp_count
		GROUP BY TerDisplayID
	    ) TCount on ter.TerDisplayID = TCount.TerDisplayID
	    WHERE ter.IsDeleted = False
	    ORDER BY loc.LocName,  ter.TerDisplayID;
	    
	   
	   
	   drop table if exists ubt_temp_t;
	   drop table if exists ubt_temp_count;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getoperatinghours(transactiondate date) OWNER TO sp_postgres;

--
-- TOC entry 1142 (class 1255 OID 24790)
-- Name: sp_ubt_getoperatinghours_bkp(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getoperatinghours_bkp(transactiondate date) RETURNS TABLE(locationname character varying, locationid character varying, terminalid character varying, opentime text, signondate text, signontime text, firstsaletime text, firsthourcount integer, closetime text, signoffdate text, signofftime text, lastsaletime text, lasthourcount integer)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	FromDate timestamp ;
	ToDate timestamp;
	ConvertToSGT int4;
	ConvertToUTC int4;
	FromDateUTC timestamp ;
	ToDateUTC timestamp ;
	
	BEGIN	
		Select(TransactionDate - interval'1 Day') into FromDate;
		select (((date_part('day',current_timestamp at time zone 'utc')- date_part('day', current_timestamp)) *24) + (date_part('hour',current_timestamp at time zone 'utc'  )- date_part('hour',current_timestamp )))
		into ConvertToUTC;
	    select (((date_part('day',current_timestamp)- date_part('day', current_timestamp at time zone 'utc' )) *24) + (date_part('hour',current_timestamp  )- date_part('hour',current_timestamp at time zone 'utc' )))
	    into ConvertToSGT;
		SELECT 
		   PreviousPeriodDateTime  ,
		   PeriodDateTime  into FromDate, ToDate
	    FROM ztubt_getbusinessdate_perhost zgp 
	    WHERE ActualDate = FromDate
	    ORDER BY PreviousPeriodDateTime DESC, PeriodDateTime desc
	    limit 1 ;
	    select(FromDate + ( ConvertToUTC * interval'1 Hour' ) ) into  FromDateUTC;
	    select( ToDate + ( ConvertToUTC * interval'1 Hour' )) into  ToDateUTC;

	    
	    create temp table if not exists ubt_temp_t
	     (
		    TerDisplayID VARCHAR(200),
		    SessionStartDateTime timestamp,
		    SessionEndDateTime timestamp,
		    SessionStartDateTimeUTC timestamp,
		    SessionEndDateTimeUTC timestamp,
		    SweepIndicator int4
	    );
	    
	    create temp table if not exists ubt_temp_count
	     (
		   TerDisplayID VARCHAR(200),
		   FirstDate timestamp,
		   FirstCount int4,
		   LastCount int4,
		   TranHeaderLineItemId VARCHAR(500)
	     );
	    
	     

	    insert into ubt_temp_t 
	    select SESS.TerDisplayID, MIN(SessionStartDateTime) AS SessionStartDateTime, MAX(SessionEndDateTime) AS SessionEndDateTime,
	    MIN(SessionStartDateTime + (convertToUTC * interval'1 Hour')) AS SessionStartDateTime, MAX( SessionEndDateTime + (convertToUTC * interval'1 Hour')) AS SessionEndDateTime,--convert to UTC--(3)
	    LOC.SweepIndicator
	    FROM ztubt_session SESS
	    inner join ztubt_terminal ter on SESS.TerDisplayID=ter.TerDisplayID
	    inner join ztubt_location LOC on TER.LocID=LOC.LocID
	    WHERE SessionStartDateTime >= FromDate
	    AND SessionStartDateTime <= ToDate
	    GROUP BY SESS.TerDisplayID, LOC.SweepIndicator ;
	    
	   

	--collection
		--all product
		insert into ubt_temp_count
		SELECT F.TerDisplayID, F.FirstDate, F.FirstCount,  F.LastCount, F.TranHeaderID    (1)
		FROM
		(
			SELECT DISTINCT 
			tha.TerDisplayID, 
			tha.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				 tha.CreatedDate >= tt.SessionStartDateTimeUTC
				AND tha.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp 
				) then 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				tha.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp 
				AND tha.CreatedDate <= tt.SessionEndDateTimeUTC
				) then 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_placedbettransactionheader tha ON tt.TerDisplayID = tha.TerDisplayID 
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate LCS ON tha.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'PB06'
			LEFT JOIN ztubt_toto_placedbettransactionlineitem PBTL ON tha.TranHeaderID = PBTL.TranHeaderID --TOTO
			LEFT JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN ON tha.TranHeaderID = PBTLN.TranHeaderID 
			LEFT JOIN ztubt_sweep_placedbettransactionlineitem SPPBTL on SPPBTL.TranLineItemID=PBTLN.TranLineItemID
			WHERE 
			(tha.CreatedDate >= FromDateUTC
			AND tha.CreatedDate <= ToDateUTC)
			and tha.isExchangeTicket=False and IsBetRejectedByTrader=False
			AND (PBTL.GroupUnitSequence = 1 OR PBTL.GroupUnitSequence IS NULL) --for group toto
			AND (PBTLN.IsSoldOut IS NULL OR (PBTLN.IsSoldOut IS NOT NULL AND PBTLN.IsSoldOut = False)) --for sweep
			AND (tt.SweepIndicator IS NULL OR (tt.SweepIndicator IS NOT NULL AND SPPBTL.IsPrinted IS NOT NULL))
		)F
		
		UNION ALL
		SELECT F.TerDisplayID, F.FirstDate, F.FirstCount,  F.LastCount, F.TranHeaderID    (2)
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID, 
			tha.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				tha.CreatedDate >= tt.SessionStartDateTimeUTC
				AND tha.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				tha.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND tha.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_placedbettransactionheader tha ON tt.TerDisplayID = tha.TerDisplayID 
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate LCS ON tha.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID  = 'PB03'
			INNER JOIN ztubt_sweep_placedbettransactionlineitem PBTL ON tha.TranHeaderID = PBTL.TranHeaderID 
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN ON PBTL.TranLineItemID = PBTLN.TranLineItemID AND PBTLN.IsSoldOut = False
			WHERE 
			(tha.CreatedDate >= FromDateUTC
			AND tha.CreatedDate <= ToDateUTC)
			AND IsBetRejectedByTrader = False
			AND (tt.SweepIndicator IS NOT NULL AND IsPrinted IS NULL)
		)F
		
	    UNION ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, F.TranHeaderID   (3)
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID,
			C.CancelledDate
			AS FirstDate,
			CASE
				WHEN (
				C.CancelledDate >= tt.SessionStartDateTime
				AND C.CancelledDate <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
						CASE
				WHEN (
				C.CancelledDate >= ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
				AND C.CancelledDate <= tt.SessionEndDateTime
				) THEN 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_cancelledbetticket C ON  tt.TerDisplayID = C.TerDisplayID 
			INNER JOIN ztubt_cancelledbetticketlifecyclestate LCS ON C.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'CB06'
			INNER JOIN ztubt_placedbettransactionheader tha ON C.TranHeaderID = tha.TranHeaderID
			LEFT JOIN ztubt_toto_placedbettransactionlineitem PBTL ON C.TranHeaderID = PBTL.TranHeaderID
			WHERE 
			(C.CancelledDate >= FromDate
			AND C.CancelledDate <= ToDate)
			AND ((PBTL.GroupUnitSequence IS NOT NULL AND C.CancelledAmout != 0) OR PBTL.GroupUnitSequence IS NULL) --for group toto
			AND tha.IsBetRejectedByTrader = False
		)F
		
		union ALL (4)
		SELECT TerDisplayID, NULL, FirstCount AS FirstCount,LastCount AS LastCount, NULL  
		FROM 
		(

			SELECT TerDisplayID, Types, TotalAmount,FirstDate, FirstCount, LastCount
			FROM
				(
					SELECT tt.TerDisplayID, V.TranHeaderID AS HeaderID, coalesce (WinningAmount,0) AS VALIDATED, coalesce (RebateAmount,0) AS LOSING_BET_REBATE, coalesce (RefundAmount,0) AS REFUNDED,
					V.ValidationDate
					AS FirstDate,
					CASE
						WHEN (
						V.ValidationDate >= tt.SessionStartDateTime
						AND V.ValidationDate <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
						)  then 1
						ELSE NULL
					END AS FirstCount,
					CASE
						WHEN (
						V.ValidationDate >=  ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
						AND V.ValidationDate <= tt.SessionEndDateTime
						)  THEN 1
						ELSE NULL 
					END AS LastCount
					FROM ubt_temp_t tt
					INNER JOIN ztubt_validatedbetticket V ON tt.TerDisplayID = V.TerDisplayID
					INNER JOIN ztubt_validatedbetticketlifecyclestate  LCS ON V.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'VB06'
					WHERE 
					V.ValidationDate >= FromDate
					and V.ValidationDate <= ToDate
				) p
				cross join lateral (
				values (p.VALIDATED, 'VALIDATED'),
				       (p.LOSING_BET_REBATE, 'LOSING_BET_REBATE'),
				       (p.REFUNDED, 'REFUNDED')	
				)b(TotalAmount, Types)
			) a	
			WHERE TotalAmount != 0
				
				/*UNPIVOT
				(
					TotalAmount For Types IN
						([VALIDATED],  [LOSING BET REBATE], [REFUNDED])
				) AS unpvt*/
		
		
		union ALL (5)
		SELECT H.TerDisplayID, NULL, FirstCount,LastCount, TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID, PBTL.TranHeaderID, 
			PBTL.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				PBTL.CreatedDate >= tt.SessionStartDateTimeUTC
				AND PBTL.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				PBTL.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND PBTL.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN 1
				ELSE NULL
			END AS LastCount
			FROM ubt_temp_t tt
			INNER JOIN ztubt_horse_placedbettransactionlineitem PBTL on PBTL.TerDisplayID=tt.TerDisplayID
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate PBLC ON PBTL.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06' 
			WHERE PBTL.BoardRebateAmount > 0 AND PBTL.BoardRebateAmount IS NOT NULL
			AND (PBTL.CreatedDate >= FromDateUTC
			AND PBTL.CreatedDate <= ToDateUTC)
		) H
		
		union ALL (6)
		SELECT F.TerDisplayID, NULL, FirstCount, LastCount, TransactionHeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			 PBT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				PB.TransactionTime >= tt.SessionStartDateTime
				AND PB.TransactionTime <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				PB.TransactionTime >= ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
				AND PB.TransactionTime <= tt.SessionEndDateTime
				) THEN 1
				ELSE NULL
			END AS LastCount
			, PB.TransactionHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_admissionvouchertransaction PBT ON tt.TerDisplayID = PBT.TerDisplayID
			INNER JOIN ztubt_offlineproductheader PB ON PBT.HeaderID = PB.TransactionHeaderID
			WHERE PBT.IsActive = True
			AND  (PB.TransactionTime >= FromDate
			AND  PB.TransactionTime <= ToDate)
		)F
		
		
		union ALL (7)
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, CharityTransactionID
		FROM
		(
			SELECT tt.TerDisplayID,
			CT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				CT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND CT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN CT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				CT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND CT.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN CT.RepeatedTicket
				ELSE 0
			END AS LastCount
			,CT.CharityTransactionID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_charitytickettransaction CT ON CT.TerDisplayID = tt.TerDisplayID
			WHERE 
			CT.CreatedDate >= FromDateUTC
			AND  CT.CreatedDate <= ToDateUTC
		)F
		
		union ALL (8)
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount,HeaderID
		FROM
		(
			select tt.TerDisplayID,
			ST.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				ST.CreatedDate >=  tt.SessionStartDateTimeUTC
				AND ST.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN ST.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				ST.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND ST.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN ST.RepeatedTicket
				ELSE 0
			END AS LastCount
			,ST.HeaderID
			from ubt_temp_t tt
			INNER JOIN ztubt_spatransaction ST ON ST.TerDisplayID = tt.TerDisplayID
			WHERE 
			ST.CreatedDate >= FromDateUTC
			AND  ST.CreatedDate <= ToDateUTC
		)F
		
				
		union ALL (9)
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, HeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			TCT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				TCT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND TCT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN TCT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				TCT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND TCT.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN TCT.RepeatedTicket
				else 0
			END AS LastCount
			,TCT.HeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_topupcardtransaction TCT ON TCT.TerDisplayID = tt.TerDisplayID
			WHERE 
			TCT.CreatedDate >= FromDateUTC
			AND  TCT.CreatedDate <= ToDateUTC
		)F
		
		union ALL (10)
		SELECT F.TerDisplayID, NULL, F.FirstCount,F.LastCount, HeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			 THT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				 THT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND  THT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN  THT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				 THT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				 AND THT.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN  THT.RepeatedTicket
				ELSE 0
			END AS LastCount
			, THT.HeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_totohongbaotransaction THT ON THT.TerDisplayID = tt.TerDisplayID
			WHERE 
			THT.CreatedDate >= FromDateUTC
			AND  THT.CreatedDate <= ToDateUTC
		)F ;
		
	 return QUERY
		SELECT loc.LocName AS LocationName,
		loc.LocDisplayID  AS LocationID,
        ter.TerDisplayID AS TerminalID,
	    to_char(oh.OpenTime::time , 'HH24:MI:ss' ) AS OpenTime,
	    to_char(tt.SessionStartDateTime::date, 'dd.MM.yyyy') AS SignOnDate,
	    to_char(tt.SessionStartDateTime::time,'HH24:MI:ss' ) AS SignOnTime,
	    to_char( TCount.FirstSaleDateTime +( 8 * interval'1 hour'), 'HH24:MI:ss') AS FirstSaleTime, --convert to SGT--(2)
	    Coalesce(TCount.FirstHourCount, 0):: int AS FirstHourCount,
	    to_char(oh.CloseTime::time , 'HH24:MI:ss' ) AS CloseTime,
	    to_char(tt.SessionEndDateTime::date, 'dd.MM.yyyy') AS SignOffDate,
	    to_char(tt.SessionEndDateTime::time,'HH24:MI:ss' ) AS SignOffTime,
	    to_char( TCount.LastSaleDateTime +( 8 * interval'1 hour'), 'HH24:MI:ss') AS LastSaleTime,
	    Coalesce(TCount.LastHourCount, 0):: int AS LastHourCount
		FROM ztubt_terminal ter 
	    LEFT JOIN ztubt_operatinghours oh 
		ON oh.LocID = ter.LocID
		AND oh.IsDeleted = False
		AND oh.DayNo = (case  extract(dow from  date (FromDate - interval '1 Day')) when 7 then 1 else
			extract(dow from  date (FromDate - interval '1 Day'))+1 end)
	    LEFT JOIN ztubt_location loc
			ON loc.LocID = ter.LocID
			AND loc.IsDeleted = False
	    LEFT JOIN ubt_temp_t tt ON ter.TerDisplayID = tt.TerDisplayID
	    LEFT JOIN
	    (
		SELECT TerDisplayID, min(FirstDate) as FirstSaleDateTime, SUM(FirstCount) AS FirstHourCount, max(FirstDate) as LastSaleDateTime, sum(LastCount) as LastHourCount
		from ubt_temp_count
		GROUP BY TerDisplayID
	    ) TCount on ter.TerDisplayID = TCount.TerDisplayID
	    WHERE ter.IsDeleted = False
	    ORDER BY loc.LocName,  ter.TerDisplayID;
	    
	   
	   
	   drop table if exists ubt_temp_t;
	   drop table if exists ubt_temp_count;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getoperatinghours_bkp(transactiondate date) OWNER TO consultant01;

--
-- TOC entry 1137 (class 1255 OID 485609)
-- Name: sp_ubt_getoperatinghours_calendar_day(date); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_ubt_getoperatinghours_calendar_day(transactiondate date) RETURNS TABLE(locationname character varying, locationid character varying, terminalid character varying, opentime text, signondate text, signontime text, firstsaletime text, firsthourcount integer, closetime text, signoffdate text, signofftime text, lastsaletime text, lasthourcount integer)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	
	declare 
	FromDate timestamp ;
	ToDate timestamp;
	ConvertToSGT int4;
	ConvertToUTC int4;
	FromDateUTC timestamp ;
	ToDateUTC timestamp ;
	
	BEGIN	
		Select(TransactionDate - interval '0 Day') into FromDate;
    	Select(TransactionDate + interval '1 Day') into ToDate;
	
		select (((date_part('day',current_timestamp at time zone 'utc')- date_part('day', current_timestamp)) *24) + (date_part('hour',current_timestamp at time zone 'utc'  )- date_part('hour',current_timestamp )))
		into ConvertToUTC;
	
	    select (((date_part('day',current_timestamp)- date_part('day', current_timestamp at time zone 'utc' )) *24) + (date_part('hour',current_timestamp  )- date_part('hour',current_timestamp at time zone 'utc' )))
	    into ConvertToSGT;
	   
	   
	    select(FromDate + ( ConvertToUTC * interval'1 Hour' ) ) into  FromDateUTC;
	    select( ToDate + ( ConvertToUTC * interval'1 Hour' )) into  ToDateUTC;

	    
	    create temp table if not exists ubt_temp_t
	     (
		    TerDisplayID VARCHAR(200),
		    SessionStartDateTime timestamp,
		    SessionEndDateTime timestamp,
		    SessionStartDateTimeUTC timestamp,
		    SessionEndDateTimeUTC timestamp,
		    SweepIndicator int4
	    );
	    
	    create temp table if not exists ubt_temp_count
	     (
		   TerDisplayID VARCHAR(200),
		   FirstDate timestamp,
		   FirstCount int4,
		   LastCount int4,
		   TranHeaderLineItemId VARCHAR(500)
	     );
	    
	     

	    insert into ubt_temp_t 
	    select SESS.TerDisplayID, MIN(SessionStartDateTime) AS SessionStartDateTime, MAX(SessionEndDateTime) AS SessionEndDateTime,
	    MIN(SessionStartDateTime + (convertToUTC * interval'1 Hour')) AS SessionStartDateTime, MAX( SessionEndDateTime + (convertToUTC * interval'1 Hour')) AS SessionEndDateTime,--convert to UTC--(3)
	    LOC.SweepIndicator
	    FROM ztubt_session SESS
	    inner join ztubt_terminal ter on SESS.TerDisplayID=ter.TerDisplayID
	    inner join ztubt_location LOC on TER.LocID=LOC.LocID
	    WHERE SessionStartDateTime >= FromDate
	    AND SessionStartDateTime <= ToDate
	    GROUP BY SESS.TerDisplayID, LOC.SweepIndicator ;
	    
	   

	--collection
		--all product
		insert into ubt_temp_count
		SELECT F.TerDisplayID, F.FirstDate, F.FirstCount,  F.LastCount, F.TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tha.TerDisplayID, 
			tha.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				 tha.CreatedDate >= tt.SessionStartDateTimeUTC
				AND tha.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp 
				) then 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				tha.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp 
				AND tha.CreatedDate <= tt.SessionEndDateTimeUTC
				) then 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_placedbettransactionheader tha ON tt.TerDisplayID = tha.TerDisplayID 
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate LCS ON tha.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'PB06'
			LEFT JOIN ztubt_toto_placedbettransactionlineitem PBTL ON tha.TranHeaderID = PBTL.TranHeaderID --TOTO
			LEFT JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN ON tha.TranHeaderID = PBTLN.TranHeaderID 
			LEFT JOIN ztubt_sweep_placedbettransactionlineitem SPPBTL on SPPBTL.TranLineItemID=PBTLN.TranLineItemID
			WHERE 
			(tha.CreatedDate >= FromDateUTC
			AND tha.CreatedDate <= ToDateUTC)
			and tha.isExchangeTicket=False and IsBetRejectedByTrader=False
			AND (PBTL.GroupUnitSequence = 1 OR PBTL.GroupUnitSequence IS NULL) --for group toto
			AND (PBTLN.IsSoldOut IS NULL OR (PBTLN.IsSoldOut IS NOT NULL AND PBTLN.IsSoldOut = False)) --for sweep
			AND (tt.SweepIndicator IS NULL OR (tt.SweepIndicator IS NOT NULL AND SPPBTL.IsPrinted IS NOT NULL))
		)F
		
		UNION ALL
		SELECT F.TerDisplayID, F.FirstDate, F.FirstCount,  F.LastCount, F.TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID, 
			tha.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				tha.CreatedDate >= tt.SessionStartDateTimeUTC
				AND tha.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				tha.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND tha.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_placedbettransactionheader tha ON tt.TerDisplayID = tha.TerDisplayID 
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate LCS ON tha.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID  = 'PB03'
			INNER JOIN ztubt_sweep_placedbettransactionlineitem PBTL ON tha.TranHeaderID = PBTL.TranHeaderID 
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN ON PBTL.TranLineItemID = PBTLN.TranLineItemID AND PBTLN.IsSoldOut = False
			WHERE 
			(tha.CreatedDate >= FromDateUTC
			AND tha.CreatedDate <= ToDateUTC)
			AND IsBetRejectedByTrader = False
			AND (tt.SweepIndicator IS NOT NULL AND IsPrinted IS NULL)
		)F
		
	    UNION ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, F.TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID,
			C.CancelledDate
			AS FirstDate,
			CASE
				WHEN (
				C.CancelledDate >= tt.SessionStartDateTime
				AND C.CancelledDate <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
						CASE
				WHEN (
				C.CancelledDate >= ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
				AND C.CancelledDate <= tt.SessionEndDateTime
				) THEN 1
				ELSE NULL
			END AS LastCount
			,tha.TranHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_cancelledbetticket C ON  tt.TerDisplayID = C.TerDisplayID 
			INNER JOIN ztubt_cancelledbetticketlifecyclestate LCS ON C.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'CB06'
			INNER JOIN ztubt_placedbettransactionheader tha ON C.TranHeaderID = tha.TranHeaderID
			LEFT JOIN ztubt_toto_placedbettransactionlineitem PBTL ON C.TranHeaderID = PBTL.TranHeaderID
			WHERE 
			(C.CancelledDate >= FromDate
			AND C.CancelledDate <= ToDate)
			AND ((PBTL.GroupUnitSequence IS NOT NULL AND C.CancelledAmout != 0) OR PBTL.GroupUnitSequence IS NULL) --for group toto
			AND tha.IsBetRejectedByTrader = False
		)F
		
		union ALL
		SELECT TerDisplayID, NULL, FirstCount AS FirstCount,LastCount AS LastCount, NULL
		FROM 
		(

			SELECT TerDisplayID, Types, TotalAmount,FirstDate, FirstCount, LastCount
			FROM
				(
					SELECT tt.TerDisplayID, V.TranHeaderID AS HeaderID, coalesce (WinningAmount,0) AS VALIDATED, coalesce (RebateAmount,0) AS LOSING_BET_REBATE, coalesce (RefundAmount,0) AS REFUNDED,
					V.ValidationDate
					AS FirstDate,
					CASE
						WHEN (
						V.ValidationDate >= tt.SessionStartDateTime
						AND V.ValidationDate <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
						)  then 1
						ELSE NULL
					END AS FirstCount,
					CASE
						WHEN (
						V.ValidationDate >=  ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
						AND V.ValidationDate <= tt.SessionEndDateTime
						)  THEN 1
						ELSE NULL 
					END AS LastCount
					FROM ubt_temp_t tt
					INNER JOIN ztubt_validatedbetticket V ON tt.TerDisplayID = V.TerDisplayID
					INNER JOIN ztubt_validatedbetticketlifecyclestate  LCS ON V.TranHeaderID = LCS.TranHeaderID AND BetStateTypeID = 'VB06'
					WHERE 
					V.ValidationDate >= FromDate
					and V.ValidationDate <= ToDate
				) p
				cross join lateral (
				values (p.VALIDATED, 'VALIDATED'),
				       (p.LOSING_BET_REBATE, 'LOSING_BET_REBATE'),
				       (p.REFUNDED, 'REFUNDED')	
				)b(TotalAmount, Types)
			) a	
			WHERE TotalAmount != 0
				
				/*UNPIVOT
				(
					TotalAmount For Types IN
						([VALIDATED],  [LOSING BET REBATE], [REFUNDED])
				) AS unpvt*/
		
		
		union ALL
		SELECT H.TerDisplayID, NULL, FirstCount,LastCount, TranHeaderID
		FROM
		(
			SELECT DISTINCT 
			tt.TerDisplayID, PBTL.TranHeaderID, 
			PBTL.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				PBTL.CreatedDate >= tt.SessionStartDateTimeUTC
				AND PBTL.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				PBTL.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND PBTL.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN 1
				ELSE NULL
			END AS LastCount
			FROM ubt_temp_t tt
			INNER JOIN ztubt_horse_placedbettransactionlineitem PBTL on PBTL.TerDisplayID=tt.TerDisplayID
			INNER JOIN ztubt_placedbettransactionheaderlifecyclestate PBLC ON PBTL.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06' 
			WHERE PBTL.BoardRebateAmount > 0 AND PBTL.BoardRebateAmount IS NOT NULL
			AND (PBTL.CreatedDate >= FromDateUTC
			AND PBTL.CreatedDate <= ToDateUTC)
		) H
		
		union ALL
		SELECT F.TerDisplayID, NULL, FirstCount, LastCount, TransactionHeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			 PBT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				PB.TransactionTime >= tt.SessionStartDateTime
				AND PB.TransactionTime <= ( tt.SessionStartDateTime + INTERVAL'1 Hour') :: timestamp
				) THEN 1
				ELSE NULL
			END AS FirstCount,
			CASE
				WHEN (
				PB.TransactionTime >= ( tt.SessionEndDateTime - INTERVAL'1 Hour') :: timestamp
				AND PB.TransactionTime <= tt.SessionEndDateTime
				) THEN 1
				ELSE NULL
			END AS LastCount
			, PB.TransactionHeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_admissionvouchertransaction PBT ON tt.TerDisplayID = PBT.TerDisplayID
			INNER JOIN ztubt_offlineproductheader PB ON PBT.HeaderID = PB.TransactionHeaderID
			WHERE PBT.IsActive = True
			AND  (PB.TransactionTime >= FromDate
			AND  PB.TransactionTime <= ToDate)
		)F
		
		
		union ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, CharityTransactionID
		FROM
		(
			SELECT tt.TerDisplayID,
			CT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				CT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND CT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN CT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				CT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND CT.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN CT.RepeatedTicket
				ELSE 0
			END AS LastCount
			,CT.CharityTransactionID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_charitytickettransaction CT ON CT.TerDisplayID = tt.TerDisplayID
			WHERE 
			CT.CreatedDate >= FromDateUTC
			AND  CT.CreatedDate <= ToDateUTC
		)F
		
		union ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount,HeaderID
		FROM
		(
			select tt.TerDisplayID,
			ST.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				ST.CreatedDate >=  tt.SessionStartDateTimeUTC
				AND ST.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN ST.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				ST.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND ST.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN ST.RepeatedTicket
				ELSE 0
			END AS LastCount
			,ST.HeaderID
			from ubt_temp_t tt
			INNER JOIN ztubt_spatransaction ST ON ST.TerDisplayID = tt.TerDisplayID
			WHERE 
			ST.CreatedDate >= FromDateUTC
			AND  ST.CreatedDate <= ToDateUTC
		)F
		
				
		union ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount, F.LastCount, HeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			TCT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				TCT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND TCT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN TCT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				TCT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				AND TCT.CreatedDate <=  tt.SessionEndDateTimeUTC
				) THEN TCT.RepeatedTicket
				else 0
			END AS LastCount
			,TCT.HeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_topupcardtransaction TCT ON TCT.TerDisplayID = tt.TerDisplayID
			WHERE 
			TCT.CreatedDate >= FromDateUTC
			AND  TCT.CreatedDate <= ToDateUTC
		)F
		
		union ALL
		SELECT F.TerDisplayID, NULL, F.FirstCount,F.LastCount, HeaderID
		FROM
		(
			SELECT tt.TerDisplayID,
			 THT.CreatedDate
			AS FirstDate,
			CASE
				WHEN (
				 THT.CreatedDate >= tt.SessionStartDateTimeUTC
				AND  THT.CreatedDate <= ( tt.SessionStartDateTimeUTC + INTERVAL'1 Hour') :: timestamp
				) THEN  THT.RepeatedTicket
				ELSE 0
			END AS FirstCount,
			CASE
				WHEN (
				 THT.CreatedDate >= ( tt.SessionEndDateTimeUTC - INTERVAL'1 Hour') :: timestamp
				 AND THT.CreatedDate <= tt.SessionEndDateTimeUTC
				) THEN  THT.RepeatedTicket
				ELSE 0
			END AS LastCount
			, THT.HeaderID
			FROM ubt_temp_t tt
			INNER JOIN ztubt_totohongbaotransaction THT ON THT.TerDisplayID = tt.TerDisplayID
			WHERE 
			THT.CreatedDate >= FromDateUTC
			AND  THT.CreatedDate <= ToDateUTC
		)F ;
		
	 return QUERY
		SELECT loc.LocName AS LocationName,
		loc.LocDisplayID  AS LocationID,
        ter.TerDisplayID AS TerminalID,
	    to_char(oh.OpenTime::time , 'HH24:MI:ss' ) AS OpenTime,
	    to_char(tt.SessionStartDateTime::date, 'dd.MM.yyyy') AS SignOnDate,
	    to_char(tt.SessionStartDateTime::time,'HH24:MI:ss' ) AS SignOnTime,
	    to_char( TCount.FirstSaleDateTime +( 8 * interval'1 hour'), 'HH24:MI:ss') AS FirstSaleTime, --convert to SGT--(2)
	    Coalesce(TCount.FirstHourCount, 0):: int AS FirstHourCount,
	    to_char(oh.CloseTime::time , 'HH24:MI:ss' ) AS CloseTime,
	    to_char(tt.SessionEndDateTime::date, 'dd.MM.yyyy') AS SignOffDate,
	    to_char(tt.SessionEndDateTime::time,'HH24:MI:ss' ) AS SignOffTime,
	    to_char( TCount.LastSaleDateTime +( 8 * interval'1 hour'), 'HH24:MI:ss') AS LastSaleTime,
	    Coalesce(TCount.LastHourCount, 0):: int AS LastHourCount
		FROM ztubt_terminal ter 
	    LEFT JOIN ztubt_operatinghours oh 
		ON oh.LocID = ter.LocID
		AND oh.IsDeleted = False
		AND oh.DayNo = (case  extract(dow from  date (FromDate - interval '1 Day')) when 7 then 1 else
			extract(dow from  date (FromDate - interval '1 Day'))+1 end)
	    LEFT JOIN ztubt_location loc
			ON loc.LocID = ter.LocID
			AND loc.IsDeleted = False
			####################
	    LEFT JOIN ubt_temp_t tt ON ter.TerDisplayID = tt.TerDisplayID
		###############
	    LEFT JOIN
	    (
		SELECT TerDisplayID, min(FirstDate) as FirstSaleDateTime, SUM(FirstCount) AS FirstHourCount, max(FirstDate) as LastSaleDateTime, sum(LastCount) as LastHourCount
		from ubt_temp_count
		GROUP BY TerDisplayID
	    ) TCount on ter.TerDisplayID = TCount.TerDisplayID
	    WHERE ter.IsDeleted = False
	    ORDER BY loc.LocName,  ter.TerDisplayID;
	    
	   
	   
	   drop table if exists ubt_temp_t;
	   drop table if exists ubt_temp_count;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_getoperatinghours_calendar_day(transactiondate date) OWNER TO postgres;

--
-- TOC entry 1279 (class 1255 OID 1259291)
-- Name: sp_ubt_getpaynowclaim(date, text, text); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getpaynowclaim(inbusinessdate date, nric_passphrase text, nric_initvector text) RETURNS TABLE(cartid character varying, transactionid character varying, ticketserialnumber character varying, ticketclaimstatus character varying, claimmode character varying, ticketcount integer, creditamt numeric, transactionfee numeric, validationamt numeric, transactiondate date, businessdate date, idtype character varying, nric character varying)
    LANGUAGE plpgsql
    AS $$

declare
	vFromDateTimeIGT	timestamp;
	vToDateTimeIGT		timestamp;

	-- Decrypt
	key_size INT := 256;
	first_to_last_digest BYTEA;
    output_buffer BYTEA;
    resultt BYTEA;
    generatedd INT := 0;
    positionn INT := 0;
    outputOffset INT;
    i INT;
    leftt int;
    required int;
    copyy int;
    counter bytea;
    div_res double precision;
    A INT;

begin	
	-- Get From-To Date
	select 
		fromdatetimeigt,
		todatetimeigt
	into
		vFromDateTimeIGT,
		vToDateTimeIGT
	from
	public.sp_ubt_getcommonubtdates
	(inbusinessdate, inbusinessdate);

	-- Decrypt
	first_to_last_digest := digest(nric_passphrase, 'sha1');
    FOR i IN 1..98 LOOP
        first_to_last_digest := digest(first_to_last_digest, 'sha1');
    END LOOP;
    output_buffer := digest(first_to_last_digest, 'sha1');

    resultt := '';
    WHILE generatedd < key_size / 8 LOOP

        outputOffset := positionn % octet_length(output_buffer);

        if outputOffset = 0 and positionn != 0 then
	        div_res := positionn /octet_length(output_buffer);
	        counter := encode(convert_to(div_res::text,'SQL_ASCII'),'hex');
            output_buffer := digest(convert_to(div_res::text,'SQL_ASCII')||first_to_last_digest, 'sha1');
        END IF;
       
		leftt := octet_length(output_buffer) - outputOffset;
        required := key_size / 8 - generatedd;
        copyy = LEAST(leftt, required);
       
        --resultt := concat_bytea(output_buffer,resultt,outputOffset,generatedd,copyy);
        if (octet_length(resultt) - generatedd - copyy) < 0 then A := 0;
		else A := (octet_length(resultt) - generatedd - copyy);
		end if;
        resultt := substr(resultt, 1, generatedd) || substr(output_buffer, outputOffset + 1, copyy) || substr(resultt, generatedd + copyy + 1, A);

     	generatedd := generatedd + copyy;
        positionn := positionn + copyy;   
    END LOOP;
   

	CREATE TEMPORARY TABLE ubt_tmp_claim AS
    SELECT 
    	zp.cartid::character varying,
    	zv.tickettransactionid::character varying as transactionid,
    	zv.ticketserialnumber as ticketserialnumber,
    	zp.transactionstatus as ticketclaimstatus,
    	'PAYNOW'::character varying as claimmode,
        CASE WHEN zv.ticketserialnumber is null or zv.ticketserialnumber = '' THEN 0
        	ELSE 1
        	END as ticketcount,
    	COALESCE(zp.netamount/100, 0) AS creditamt,
    	COALESCE(zp.transactionfee/100, 0) as transactionfee,
    	COALESCE(zv.amount/100, 0) as validationamt,
        cast(zp.updateddatetime as DATE) as transactiondate,
        inbusinessdate as businessdate,
        'NRIC'::character varying as idtype,
        case 
        	when zp.documentno = '' or zp.documentno is null then ''
        	else convert_from(decrypt_iv(
    			decode(zp.documentno, 'base64'), 
    			decode(encode(resultt, 'hex'),'hex'),
    			convert_to(nric_initvector,'utf8'),
  				'aes-cbc'),
  			'UTF8')::character varying 
  		end as nric
    FROM ztubt_paynowtransaction zp 
    LEFT JOIN ztubt_validatedbetticket zv on zp.cartid = zv.cartid 
    WHERE 1=1
	AND zp.updateddatetime >= vFromDateTimeIGT  
	AND zp.updateddatetime < vToDateTimeIGT
    AND zp.paymenttypeid = 'PNRIC';

    RETURN QUERY select * FROM ubt_tmp_claim r;
   
    -- Clean up temporary tables
    DROP TABLE IF EXISTS ubt_tmp_claim;

end;
$$;


ALTER FUNCTION public.sp_ubt_getpaynowclaim(inbusinessdate date, nric_passphrase text, nric_initvector text) OWNER TO sp_postgres;

--
-- TOC entry 1291 (class 1255 OID 1278780)
-- Name: sp_ubt_getpaynowdatabyterminal(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getpaynowdatabyterminal(inbusinessdate date) RETURNS TABLE(terdisplayid integer, locdisplayid integer, totalamount numeric, totalfee numeric, paymenttypeid character varying, businessdate date, datefrom date, dateto date, timefrom time without time zone, timeto time without time zone)
    LANGUAGE plpgsql
    AS $$

declare
	status_pnqr text[];
	status_pnric text[];
	vFromDateTimeIGT	timestamp;
	vToDateTimeIGT		timestamp;

begin
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

	-- Get From-To Date
	select 
		fromdatetimeigt,
		todatetimeigt
	into
		vFromDateTimeIGT,
		vToDateTimeIGT
	from
	public.sp_ubt_getcommonubtdates
	(inbusinessdate, inbusinessdate);

--	create temp table ubt_temp_busdatehost2 as
--	select distinct * from public.ztubt_getbusinessdate_perhost 
--	where previousperioddatetime is not null
--	and host =2;

    CREATE TEMPORARY TABLE IF NOT EXISTS ubt_tmp_paynowtransaction
    (
        terdisplayid int4,
        locdisplayid int4,
        totalamount NUMERIC(32, 2),
        totalfee NUMERIC(32, 2),
        paymenttypeid VARCHAR(20),
        businessdate DATE,
        datefrom DATE,
        dateto DATE,
        timefrom TIME,
        timeto TIME
    );

    INSERT INTO ubt_tmp_paynowtransaction
    SELECT
        cast(zt.terdisplayid as int4) as terdisplayid,
        cast(zl.locdisplayid as int4) as locdisplayid,
        SUM(COALESCE(zp.netamount/100, 0)) AS totalamount,
        SUM(COALESCE(zp.transactionfee/100, 0)) AS totalfee,
        zp.paymenttypeid,
--      zgp.actualdate as businessdate,
        inbusinessdate as businessdate,
        vFromDateTimeIGT::DATE as datefrom,
        vToDateTimeIGT::DATE as dateto,
        vFromDateTimeIGT::TIME as timefrom,
        vToDateTimeIGT::TIME as timeto
    FROM
        ztubt_paynowtransaction zp
        LEFT JOIN ztubt_cart zc ON zp.cartid = zc.cartid  
		LEFT JOIN ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
		LEFT JOIN ztubt_location zl ON zt.LocID = zl.LocID 
--		LEFT JOIN ubt_temp_busdatehost2 zgp 
-- 			on (zp.updateddatetime between zgp.previousperioddatetime and zgp.perioddatetime)
    where
    	((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
			or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
		)
		AND zp.updateddatetime >= vFromDateTimeIGT  
		AND zp.updateddatetime < vToDateTimeIGT
    GROUP BY
        zp.paymenttypeid, CAST(zp.updateddatetime AS DATE), zt.terdisplayid, zl.locdisplayid;

    RETURN QUERY SELECT * FROM ubt_tmp_paynowtransaction;
   
    -- Clean up temporary tables
    DROP TABLE IF EXISTS ubt_tmp_paynowtransaction;
   	--DROP TABLE IF EXISTS  ubt_temp_busdatehost2;

end;
$$;


ALTER FUNCTION public.sp_ubt_getpaynowdatabyterminal(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1272 (class 1255 OID 1258669)
-- Name: sp_ubt_getpaynowsuccessstatus(character varying); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getpaynowsuccessstatus(paymenttype character varying) RETURNS text[]
    LANGUAGE plpgsql
    AS $$
DECLARE
    results text[];
BEGIN
    IF upper(paymentType) = 'PNQR' THEN
        results := ARRAY['01'];
    ELSEIF upper(paymentType) = 'PNRIC' THEN
        results := ARRAY['01', '03', '04'];
    ELSE
        results := ARRAY[]::text[];
    END IF;

    RETURN results;
END;
$$;


ALTER FUNCTION public.sp_ubt_getpaynowsuccessstatus(paymenttype character varying) OWNER TO sp_postgres;

--
-- TOC entry 1286 (class 1255 OID 1251352)
-- Name: sp_ubt_getreconciliationdaily_bk(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getreconciliationdaily_bk(ptransactiondate date) RETURNS TABLE(calday date, transactiondate timestamp without time zone, valuedate date, retailer_id integer, paymenttypeid character varying, transaction_amount numeric, transaction_fee numeric, bank_amount numeric, transactionreference character varying, bankstatusdl character varying)
    LANGUAGE plpgsql
    AS $$

BEGIN
    CREATE TEMPORARY TABLE IF NOT EXISTS ubt_tmp_reconciliation (
    	calday date,
        transactiondate timestamp,
        valuedate DATE,
        retailer_id INT,
        paymenttypeid VARCHAR(20),
        transaction_amount NUMERIC,
        transaction_fee NUMERIC,
        bank_amount NUMERIC,
        transactionreference varchar(30),
        bankstatusdl varchar(2)
    );

    INSERT INTO ubt_tmp_reconciliation
    select
    	cast(zr.transactiondate as date) as calday,
        cast(zr.transactiondate as timestamp) AS transactiondate,
        CAST(zr.valuedate AS DATE) AS valuedate,
        CAST(SUBSTRING(zl.locdisplayid FROM '[1-9][0-9]*') AS INT) AS retailer_id,
        zr.paymenttypeid,
        COALESCE(zr.netamount, 0)AS transaction_amount,
        COALESCE(zr.transactionfeedl, 0) AS transaction_fee,
        COALESCE(bankamount,0) as bank_amount,
        zr.transactionreference,
        zr.bankstatusdl
    FROM
        public.ztubt_reconciliationresult zr
    LEFT JOIN
        ztubt_cart zc ON zr.cartiddl = zc.cartid
        AND zc.cartid IS NOT NULL
    LEFT JOIN
        ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID
    LEFT JOIN
        ztubt_location zl ON zt.LocID = zl.LocID
    WHERE 1 = 1
        AND zr.paymenttypeid IN ('PNQR', 'PNRIC')
        AND CAST(zr.transactiondate AS DATE) = ptransactiondate
        AND zc.cartid IS NOT NULL
;

    RETURN QUERY SELECT * FROM ubt_tmp_reconciliation;
    
    -- Clean up temporary tables
    DROP TABLE IF EXISTS ubt_tmp_reconciliation;
END;
$$;


ALTER FUNCTION public.sp_ubt_getreconciliationdaily_bk(ptransactiondate date) OWNER TO sp_postgres;

--
-- TOC entry 1288 (class 1255 OID 1748540)
-- Name: sp_ubt_getrtshopcloud(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud(inbusinessdate date)
 RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vGST_Branch varchar;
vInputTax varchar;
vOutputTax varchar;
vGSTRate numeric; --percentage
vARCode_Q_Retailer varchar; -- OCBC QR Code for PNQR
vARCode_Q_Branch varchar; -- OCBC QR Code for PNQR
vARCode_P_Retailer varchar; -- UOB QR Code for Paynow
vARCode_P_Branch varchar; -- UOB QR Code for Paynow

begin
		--01-Nov-2022: Change to replace GST taxcode with variable
	/*	PRD
			
	select 'S3' into vOutputTax;
	select '24100110' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100120' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100121' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100111' into vARCode_P_Branch; -- UOB QR Code for Paynow
	*/		
	-- UAT
	select case when InBusinessDate <= date '2022-10-31' then 'ZA'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'YA'
				when InBusinessDate >= date '2024-01-01' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-10-31' then 'P1'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'P2'
				when InBusinessDate >= date '2024-01-01' then 'P3'
			end into vInputTax;

	select 'S3' into vOutputTax;
	select '24100060' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100061' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100062' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100063' into vARCode_P_Branch; -- UOB QR Code for Paynow

	-- End

	-- GST Config
	SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
    FROM ztubt_gstconfig zg
    WHERE inbusinessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
    ORDER BY zg.effectivefrom
    LIMIT 1;

   	-- Store common config into temp table
	create temporary table if not exists ubt_tmp_rtshop_config 
	(
		ConfigKey VARCHAR(50),
		ConfigValue VARCHAR(100)
	);
	INSERT INTO ubt_tmp_rtshop_config(ConfigKey, ConfigValue) VALUES('vGST_Branch', vGST_Branch);
	INSERT INTO ubt_tmp_rtshop_config(ConfigKey, ConfigValue) VALUES('vInputTax', vInputTax);
   
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);
	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_paynow_FirstDate
	(
		Amt numeric(32,3),
		Fee numeric(32,3),
		ProductName VARCHAR(100),
		TerDisplayID VARCHAR(200)
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);

	insert into ubt_tmp_paynow_FirstDate
	select
		SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'PaynowQR' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') and amount <> 0
		group by terdisplayid
	union select
		SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'Paynow' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('Paynow [+trans fee]', 'Paynow') and amount <> 0
		group by terdisplayid;

	-- Add Paynow to ubt_tmp_V2_TAD_FirstDate
	insert into ubt_tmp_V2_TAD_FirstDate 
	select
		terdisplayid, ProductName, (a.Amt - a.Fee) as Amount,
		0 as ct, 'CAS' as FLAG, 'CL' as TransType,
		InBusinessDate as FromDate, InBusinessDate as InToDate
		from ubt_tmp_paynow_FirstDate a;
	DROP TABLE IF EXISTS ubt_tmp_paynow_FirstDate;

insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	frompublic.
	sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;


--Paynow Charges

	-- calculate Paynow QR charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL21', 'Y5', '01', 
			vARCode_Q_Retailer, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL22', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL23', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	
	-- calculate Paynow charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL24', 'Y5', '01', 
			vARCode_P_Retailer, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL25', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL26', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow QR charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL27', 'Y5', '01', 
			vARCode_Q_Branch, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL28', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL29', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL30', 'Y5', '01', 
			vARCode_P_Branch, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL31', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL32', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

--PAYNOW, PAYNOWQR - Daily Settlement
	
	-- calculate PAYNOW QR for retailer
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType in (2,4);

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL33', 'Y8', '11', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL34', 'Y8', '01', 
			vARCode_Q_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW for retailer
	
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType in (2,4);
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL35', 'Y8', '01', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL36', 'Y8', '11', 
			vARCode_P_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW QR for branches
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL37', 'Y8', '11', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL38', 'Y8', '01', 
			vARCode_Q_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate PAYNOW for branch
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL39', 'Y8', '01', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL40', 'Y8', '11', 
			vARCode_P_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- END

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;
	
	DROP TABLE IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE IF EXISTS ubt_tmp_V2_LocationTempData;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
					terdisplayid,
					prodname,
					amount,
					ticketcount ,
					FLAG,
					TransType,
					vPeriodStartDate as FromDate,
					vPeriodEndDate as InToDate
					from public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);

				create temporary table if not exists ubt_tmp_paynow_SecondDate
				(
					Amt numeric(32,3),
					Fee numeric(32,3),
					ProductName VARCHAR(100),
					TerDisplayID VARCHAR(200)
				);
				insert into ubt_tmp_paynow_SecondDate
				select
					SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					'PaynowQR' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') 
					group by terdisplayid
				union select
					SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					 'Paynow' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('Paynow [+trans fee]', 'Paynow') 
					group by terdisplayid;

				-- Add Paynow to ubt_tmp_V2_TAD_SecondDate
				insert into ubt_tmp_V2_TAD_SecondDate 
				select
					terdisplayid, ProductName, (a.Amt - a.Fee) as amount,
					0 as ticketcount, 'CAS' as FLAG, 'CL' as TransType,
					vPeriodStartDate as FromDate, vPeriodEndDate as InToDate
					from ubt_tmp_paynow_SecondDate a;
				DROP TABLE IF EXISTS ubt_tmp_paynow_SecondDate;

				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_SecondDate (FLAG, ProductName);

				end if;

	select public.sp_ubt_getrtshopcloud_sports(inbusinessdate, vSeq) into vSeq;
	select public.sp_ubt_getrtshopcloud_hr(inbusinessdate, vSeq) into vSeq;


	return query 
		select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
		, a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
		coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
		a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
		a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
		a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
		a.Amount, a.Product, a.DrawNumber, a.Customer
        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_rtshop_config;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1299 (class 1255 OID 1930734)
-- Name: sp_ubt_getrtshopcloud11(); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud11() RETURNS TABLE(saptaxbaseamount numeric, amt numeric)
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vSeq Int4:=1;
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vPeriodStartDate date;
vGST_Branch varchar;
vInputTax varchar;
vOutputTax varchar;
vGSTRate numeric; --percentage
vARCode_Q_Retailer varchar; -- OCBC QR Code for PNQR
vARCode_Q_Branch varchar; -- OCBC QR Code for PNQR
vARCode_P_Retailer varchar; -- UOB QR Code for Paynow
vARCode_P_Branch varchar; -- UOB QR Code for Paynow

begin
	

	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		SAPTaxBaseAmount numeric(15,0) ,
		Amount numeric(32,11)
	);

SELECT 4.3 into vTotalAmount;


	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud

		VALUES
		(
			NULL,
			vTotalAmount
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + 0.09*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		VALUES
		(
			
			NULL, 
			vBaseAmount
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		VALUES
		(
			vBaseAmount, 
			vTotalAmount
		);
		select 1 into vFlagIsInsert;
	end if;
	
return query 
		select *
        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;


DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud11() OWNER TO sp_postgres;

--
-- TOC entry 1124 (class 1255 OID 350219)
-- Name: sp_ubt_getrtshopcloud_bk20240314(date); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_bk20240314(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$
declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vHQLocation varchar:='008888';
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vTotalTempAmountPerLocation int4:=0;
vGST_Branch varchar;
vInputTax varchar;

begin
	
		--01-Nov-2022: Change to replace GST taxcode with variable
	/*	PRD
	select case when InBusinessDate <= date '2022-12-31' then 'ZA'
				when InBusinessDate >= date '2023-01-01' and InBusinessDate <= date '2023-12-31' then 'YA'
				when InBusinessDate >= date '2024-01-01' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-12-31' then 'P1'
				when InBusinessDate >= date '2023-01-01' and InBusinessDate <= date '2023-12-31' then 'P2'
				when InBusinessDate >= date '2024-01-01' then 'P3'
			end into vInputTax;
	*/		
	-- UAT
	select case when InBusinessDate <= date '2022-10-31' then 'ZA'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-10-30' then 'YA'
				when InBusinessDate >= date '2023-10-31' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-10-31' then 'P1'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-10-30' then 'P2'
				when InBusinessDate >= date '2023-10-31' then 'P3'
			end into vInputTax;
	
	
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount ,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);
	
insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline 		Orders'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (5, 6)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'PAY';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
			select 1 into vFlagIsInsert;
	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch

	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO' and LocDisplayID  <>vHQLocation; 

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

	--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA', '40', 
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA', '15', 
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select 
	coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN'  then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;
	
	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA', '01', 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA', '50', 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;	

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
	
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
				terdisplayid,
				prodname,
				amount,
				ticketcount ,
				FLAG,
				TransType,
				vPeriodStartDate as FromDate,
				vPeriodEndDate as InToDate
				from
				public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);
				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_FirstDate (FLAG, ProductName);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN 				('SPORTS', 'Offline Orders'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
				
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, 				T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
		 		 end),0) as Amount		
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select 	coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;
				IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, 				loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
  				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;
		
--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

                        return query             
                                         select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
                                         , a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
                                         coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
                                         a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
                                         a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
                                         a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
                                         a.Amount, a.Product, a.DrawNumber, a.Customer
                        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;
							
DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;

end;
$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_bk20240314(inbusinessdate date) OWNER TO postgres;

--
-- TOC entry 1144 (class 1255 OID 923719)
-- Name: sp_ubt_getrtshopcloud_bk202407_epayment(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_bk202407_epayment(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
-- vHQLocation varchar:='008888';
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vTotalTempAmountPerLocation int4:=0;
vGST_Branch varchar;
vInputTax varchar;
vOutputTax varchar;
vGSTRate numeric; --percentage
vARCode_Q_Retailer varchar; -- OCBC QR Code for PNQR
vARCode_Q_Branch varchar; -- OCBC QR Code for PNQR
vARCode_P_Retailer varchar; -- UOB QR Code for Paynow
vARCode_P_Branch varchar; -- UOB QR Code for Paynow

begin
	
		--01-Nov-2022: Change to replace GST taxcode with variable
	/*	PRD
	select case when InBusinessDate <= date '2022-12-31' then 'ZA'
				when InBusinessDate >= date '2023-01-01' and InBusinessDate <= date '2023-12-31' then 'YA'
				when InBusinessDate >= date '2024-01-01' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-12-31' then 'P1'
				when InBusinessDate >= date '2023-01-01' and InBusinessDate <= date '2023-12-31' then 'P2'
				when InBusinessDate >= date '2024-01-01' then 'P3'
			end into vInputTax;
			
	select 'S3' into vOutputTax;
	select '24100110' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100120' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100121' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100111' into vARCode_P_Branch; -- UOB QR Code for Paynow
	*/		
	-- UAT
	select case when InBusinessDate <= date '2022-10-31' then 'ZA'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-10-30' then 'YA'
				when InBusinessDate >= date '2023-10-31' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-10-31' then 'P1'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-10-30' then 'P2'
				when InBusinessDate >= date '2023-10-31' then 'P3'
			end into vInputTax;

	select 'S3' into vOutputTax;
	select '24100060' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100061' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100062' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100063' into vARCode_P_Branch; -- UOB QR Code for Paynow

	-- End

	-- GST Config
	SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
    FROM ztubt_gstconfig zg
    WHERE inbusinessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
    ORDER BY zg.effectivefrom
    LIMIT 1;
	
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_paynow_FirstDate
	(
		Amt numeric(32,3),
		Fee numeric(32,3),
		ProductName VARCHAR(100),
		TerDisplayID VARCHAR(200)
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);
	
	insert into ubt_tmp_paynow_FirstDate
	select
		SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'PaynowQR' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') and amount <> 0
		group by terdisplayid
	union select
		SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'Paynow' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('Paynow [+trans fee]', 'Paynow') and amount <> 0
		group by terdisplayid;

	-- Add Paynow to ubt_tmp_V2_TAD_FirstDate
	insert into ubt_tmp_V2_TAD_FirstDate 
	select
		terdisplayid, ProductName, (a.Amt - a.Fee) as Amount,
		0 as ct, 'CAS' as FLAG, 'CL' as TransType,
		InBusinessDate as FromDate, InBusinessDate as InToDate
		from ubt_tmp_paynow_FirstDate a;
	DROP TABLE IF EXISTS ubt_tmp_paynow_FirstDate;
			
insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline 		Orders'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (5, 6)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'PAY';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
			select 1 into vFlagIsInsert;
	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	-- 2023Jan25 - Include HQLocation 8888
	-- when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' then coalesce(amount,0) 
	when LocType =1 and flag='PAY' then coalesce(amount,0) 
	when LocType =1 and flag='RBT' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	-- 2023Jan25 - Include HQLocation 8888
	-- WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	WHERE LocType =1 AND FLAG = 'PAY';
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch

	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO'; 

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

	--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	-- Inclusive of Paynow QR Branch
	SELECT vTotalAmount - sum_paynowqr AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' THEN amount ELSE 0 END) AS sum_paynowqr
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '40' ELSE '15' END,
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '15' ELSE '40' END,
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select
	-- 2023Jan25 - Include HQLocation 8888
	-- coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	-- when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	coalesce (sum(case when LocType =1 and flag='PAY' then coalesce(amount,0)
	when LocType =1 and flag='RFD' and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN' then coalesce(amount,0)
--	when LocType =1 and productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(amount,0) -- Inclusive of Paynow Branch
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;

	-- Inclusive of Paynow Branch
	SELECT vTotalAmount + sum_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' THEN amount ELSE 0 END) AS sum_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '01' ELSE '50' END, 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '50' ELSE '01' END, 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

		if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--Paynow Charges

	-- calculate Paynow QR charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL21', 'Y5', '01', 
			vARCode_Q_Retailer, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + vGSTRate*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL22', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL23', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	
	-- calculate Paynow charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL24', 'Y5', '01', 
			vARCode_P_Retailer, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + vGSTRate*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL25', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL26', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow QR charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL27', 'Y5', '01', 
			vARCode_Q_Branch, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + vGSTRate*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL28', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL29', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL30', 'Y5', '01', 
			vARCode_P_Branch, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + vGSTRate*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL31', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL32', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

--PAYNOW, PAYNOWQR - Daily Settlement
	
	-- calculate PAYNOW QR for retailer
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType in (2,4);

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL33', 'Y8', '11', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL34', 'Y8', '01', 
			vARCode_Q_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW for retailer
	
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType in (2,4);
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL35', 'Y8', '01', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL36', 'Y8', '11', 
			vARCode_P_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW QR for branches
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL37', 'Y8', '11', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL38', 'Y8', '01', 
			vARCode_Q_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate PAYNOW for branch
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL39', 'Y8', '01', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL40', 'Y8', '11', 
			vARCode_P_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- END

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
	
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
					terdisplayid,
					prodname,
					amount,
					ticketcount ,
					FLAG,
					TransType,
					vPeriodStartDate as FromDate,
					vPeriodEndDate as InToDate
					from public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);

				create temporary table if not exists ubt_tmp_paynow_SecondDate
				(
					Amt numeric(32,3),
					Fee numeric(32,3),
					ProductName VARCHAR(100),
					TerDisplayID VARCHAR(200)
				);
				insert into ubt_tmp_paynow_SecondDate
				select
					SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					'PaynowQR' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') 
					group by terdisplayid
				union select
					SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					 'Paynow' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('Paynow [+trans fee]', 'Paynow') 
					group by terdisplayid;

				-- Add Paynow to ubt_tmp_V2_TAD_SecondDate
				insert into ubt_tmp_V2_TAD_SecondDate 
				select
					terdisplayid, ProductName, (a.Amt - a.Fee) as amount,
					0 as ticketcount, 'CAS' as FLAG, 'CL' as TransType,
					vPeriodStartDate as FromDate, vPeriodEndDate as InToDate
					from ubt_tmp_paynow_SecondDate a;
				DROP TABLE IF EXISTS ubt_tmp_paynow_SecondDate;

				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_SecondDate (FLAG, ProductName);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN 				('SPORTS', 'Offline Orders'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
				
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, 				T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
				 when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				 when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		 end),0) as Amount
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				-- IBG PAYMENTS
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud		
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;

			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;

			IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
				when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
  				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;

--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

                        return query             
                                         select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
                                         , a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
                                         coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
                                         a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
                                         a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
                                         a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
                                         a.Amount, a.Product, a.DrawNumber, a.Customer
                        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;
							
DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_bk202407_epayment(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1223 (class 1255 OID 2392115)
-- Name: sp_ubt_getrtshopcloud_bk20250310(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_bk20250310(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vGST_Branch varchar;
vInputTax varchar;
vOutputTax varchar;
vGSTRate numeric; --percentage
vARCode_Q_Retailer varchar; -- OCBC QR Code for PNQR
vARCode_Q_Branch varchar; -- OCBC QR Code for PNQR
vARCode_P_Retailer varchar; -- UOB QR Code for Paynow
vARCode_P_Branch varchar; -- UOB QR Code for Paynow

begin
		--01-Nov-2022: Change to replace GST taxcode with variable
	/*	PRD
			
	select 'S3' into vOutputTax;
	select '24100110' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100120' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100121' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100111' into vARCode_P_Branch; -- UOB QR Code for Paynow
	*/		
	-- UAT
	select case when InBusinessDate <= date '2022-10-31' then 'ZA'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'YA'
				when InBusinessDate >= date '2024-01-01' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-10-31' then 'P1'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'P2'
				when InBusinessDate >= date '2024-01-01' then 'P3'
			end into vInputTax;

	select 'S3' into vOutputTax;
	select '24100060' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100061' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100062' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100063' into vARCode_P_Branch; -- UOB QR Code for Paynow

	-- End

	-- GST Config
	SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
    FROM ztubt_gstconfig zg
    WHERE inbusinessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
    ORDER BY zg.effectivefrom
    LIMIT 1;

   	-- Store common config into temp table
	create temporary table if not exists ubt_tmp_rtshop_config 
	(
		ConfigKey VARCHAR(50),
		ConfigValue VARCHAR(100)
	);
	INSERT INTO ubt_tmp_rtshop_config(ConfigKey, ConfigValue) VALUES('vGST_Branch', vGST_Branch);
	INSERT INTO ubt_tmp_rtshop_config(ConfigKey, ConfigValue) VALUES('vInputTax', vInputTax);
   
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);
	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_paynow_FirstDate
	(
		Amt numeric(32,3),
		Fee numeric(32,3),
		ProductName VARCHAR(100),
		TerDisplayID VARCHAR(200)
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);

	insert into ubt_tmp_paynow_FirstDate
	select
		SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'PaynowQR' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') and amount <> 0
		group by terdisplayid
	union select
		SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'Paynow' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('Paynow [+trans fee]', 'Paynow') and amount <> 0
		group by terdisplayid;

	-- Add Paynow to ubt_tmp_V2_TAD_FirstDate
	insert into ubt_tmp_V2_TAD_FirstDate 
	select
		terdisplayid, ProductName, (a.Amt - a.Fee) as Amount,
		0 as ct, 'CAS' as FLAG, 'CL' as TransType,
		InBusinessDate as FromDate, InBusinessDate as InToDate
		from ubt_tmp_paynow_FirstDate a;
	DROP TABLE IF EXISTS ubt_tmp_paynow_FirstDate;

insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;


--Paynow Charges

	-- calculate Paynow QR charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL21', 'Y5', '01', 
			vARCode_Q_Retailer, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL22', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL23', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	
	-- calculate Paynow charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL24', 'Y5', '01', 
			vARCode_P_Retailer, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL25', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL26', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow QR charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL27', 'Y5', '01', 
			vARCode_Q_Branch, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL28', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL29', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL30', 'Y5', '01', 
			vARCode_P_Branch, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL31', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL32', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

--PAYNOW, PAYNOWQR - Daily Settlement
	
	-- calculate PAYNOW QR for retailer
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType in (2,4);

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL33', 'Y8', '11', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL34', 'Y8', '01', 
			vARCode_Q_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW for retailer
	
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType in (2,4);
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL35', 'Y8', '01', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL36', 'Y8', '11', 
			vARCode_P_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW QR for branches
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL37', 'Y8', '11', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL38', 'Y8', '01', 
			vARCode_Q_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate PAYNOW for branch
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL39', 'Y8', '01', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL40', 'Y8', '11', 
			vARCode_P_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- END

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;
	
	DROP TABLE IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE IF EXISTS ubt_tmp_V2_LocationTempData;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
					terdisplayid,
					prodname,
					amount,
					ticketcount ,
					FLAG,
					TransType,
					vPeriodStartDate as FromDate,
					vPeriodEndDate as InToDate
					from public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);

				create temporary table if not exists ubt_tmp_paynow_SecondDate
				(
					Amt numeric(32,3),
					Fee numeric(32,3),
					ProductName VARCHAR(100),
					TerDisplayID VARCHAR(200)
				);
				insert into ubt_tmp_paynow_SecondDate
				select
					SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					'PaynowQR' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') 
					group by terdisplayid
				union select
					SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					 'Paynow' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('Paynow [+trans fee]', 'Paynow') 
					group by terdisplayid;

				-- Add Paynow to ubt_tmp_V2_TAD_SecondDate
				insert into ubt_tmp_V2_TAD_SecondDate 
				select
					terdisplayid, ProductName, (a.Amt - a.Fee) as amount,
					0 as ticketcount, 'CAS' as FLAG, 'CL' as TransType,
					vPeriodStartDate as FromDate, vPeriodEndDate as InToDate
					from ubt_tmp_paynow_SecondDate a;
				DROP TABLE IF EXISTS ubt_tmp_paynow_SecondDate;

				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_SecondDate (FLAG, ProductName);

				end if;

	select public.sp_ubt_getrtshopcloud_sports(inbusinessdate, vSeq) into vSeq;
	select public.sp_ubt_getrtshopcloud_hr(inbusinessdate, vSeq) into vSeq;


	return query 
		select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
		, a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
		coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
		a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
		a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
		a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
		a.Amount, a.Product, a.DrawNumber, a.Customer
        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_rtshop_config;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_bk20250310(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1120 (class 1255 OID 220348)
-- Name: sp_ubt_getrtshopcloud_bkup_gst_change(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_bkup_gst_change(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$
declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vHQLocation varchar:='008888';
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vTotalTempAmountPerLocation int4:=0;

begin
	
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount ,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);
	
insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline 		Orders'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (5, 6)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000011', 'ZA',
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMM IN ADV FOR RETAILERS', '12540004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'PAY';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
			select 1 into vFlagIsInsert;
	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000011', 'ZA',
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch

	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO' and LocDisplayID  <>vHQLocation; 

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

	--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA', '40', 
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA', '15', 
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select 
	coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN'  then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;
	
	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA', '01', 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA', '50', 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;	

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
	
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
				terdisplayid,
				prodname,
				amount,
				ticketcount ,
				FLAG,
				TransType,
				vPeriodStartDate as FromDate,
				vPeriodEndDate as InToDate
				from
				public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);
				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_FirstDate (FLAG, ProductName);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN 				('SPORTS', 'Offline Orders'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
				
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, 				T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', 'P1', 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
		 		 end),0) as Amount		
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select 	coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;
				IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, 				loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
  				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;
		
--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

                        return query             
                                         select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
                                         , a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
                                         coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
                                         a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
                                         a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
                                         a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
                                         a.Amount, a.Product, a.DrawNumber, a.Customer
                        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;
							
DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;

end;
$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_bkup_gst_change(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1287 (class 1255 OID 1741638)
-- Name: sp_ubt_getrtshopcloud_epayment_prod(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_epayment_prod(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
-- vHQLocation varchar:='008888';
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vTotalTempAmountPerLocation int4:=0;
vGST_Branch varchar;
vInputTax varchar;
vOutputTax varchar;
vGSTRate numeric; --percentage
vARCode_Q_Retailer varchar; -- OCBC QR Code for PNQR
vARCode_Q_Branch varchar; -- OCBC QR Code for PNQR
vARCode_P_Retailer varchar; -- UOB QR Code for Paynow
vARCode_P_Branch varchar; -- UOB QR Code for Paynow

begin

		--01-Nov-2022: Change to replace GST taxcode with variable
	--PRD
	select case when InBusinessDate <= date '2022-10-31' then 'ZA'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'YA'
				when InBusinessDate >= date '2024-01-01' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-10-31' then 'P1'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'P2'
				when InBusinessDate >= date '2024-01-01' then 'P3'
			end into vInputTax;
			
	select 'S3' into vOutputTax;
	select '24100110' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100120' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100121' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100111' into vARCode_P_Branch; -- UOB QR Code for Paynow
	-- End PRD
	
	/* UAT
	select case when InBusinessDate <= date '2022-10-31' then 'ZA'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-10-30' then 'YA'
				when InBusinessDate >= date '2023-10-31' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-10-31' then 'P1'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-10-30' then 'P2'
				when InBusinessDate >= date '2023-10-31' then 'P3'
			end into vInputTax;

	select 'S3' into vOutputTax;
	select '24100060' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100061' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100062' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100063' into vARCode_P_Branch; -- UOB QR Code for Paynow
	-- End UAT */

	-- GST Config
	SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
    FROM ztubt_gstconfig zg
    WHERE inbusinessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
    ORDER BY zg.effectivefrom
    LIMIT 1;
	
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_paynow_FirstDate
	(
		Amt numeric(32,3),
		Fee numeric(32,3),
		ProductName VARCHAR(100),
		TerDisplayID VARCHAR(200)
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);
	
	insert into ubt_tmp_paynow_FirstDate
	select
		SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'PaynowQR' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') and amount <> 0
		group by terdisplayid
	union select
		SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'Paynow' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('Paynow [+trans fee]', 'Paynow') and amount <> 0
		group by terdisplayid;

	-- Add Paynow to ubt_tmp_V2_TAD_FirstDate
	insert into ubt_tmp_V2_TAD_FirstDate 
	select
		terdisplayid, ProductName, (a.Amt - a.Fee) as Amount,
		0 as ct, 'CAS' as FLAG, 'CL' as TransType,
		InBusinessDate as FromDate, InBusinessDate as InToDate
		from ubt_tmp_paynow_FirstDate a;
	DROP TABLE IF EXISTS ubt_tmp_paynow_FirstDate;
			
insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline 		Orders'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (5, 6)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'PAY';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
			select 1 into vFlagIsInsert;
	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	-- 2023Jan25 - Include HQLocation 8888
	-- when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' then coalesce(amount,0) 
	when LocType =1 and flag='PAY' then coalesce(amount,0) 
	when LocType =1 and flag='RBT' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	-- 2023Jan25 - Include HQLocation 8888
	-- WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	WHERE LocType =1 AND FLAG = 'PAY';
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch

	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO'; 

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

	--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	-- Inclusive of Paynow QR Branch
	SELECT vTotalAmount - sum_paynowqr AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' THEN amount ELSE 0 END) AS sum_paynowqr
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '40' ELSE '15' END,
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '15' ELSE '40' END,
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select
	-- 2023Jan25 - Include HQLocation 8888
	-- coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	-- when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	coalesce (sum(case when LocType =1 and flag='PAY' then coalesce(amount,0)
	when LocType =1 and flag='RFD' and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN' then coalesce(amount,0)
--	when LocType =1 and productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(amount,0) -- Inclusive of Paynow Branch
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;

	-- Inclusive of Paynow Branch
	SELECT vTotalAmount + sum_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' THEN amount ELSE 0 END) AS sum_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '01' ELSE '50' END, 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '50' ELSE '01' END, 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

		if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--Paynow Charges

	-- calculate Paynow QR charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL21', 'Y5', '01', 
			vARCode_Q_Retailer, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + vGSTRate*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL22', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL23', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	
	-- calculate Paynow charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL24', 'Y5', '01', 
			vARCode_P_Retailer, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + vGSTRate*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL25', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL26', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow QR charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL27', 'Y5', '01', 
			vARCode_Q_Branch, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + vGSTRate*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL28', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL29', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL30', 'Y5', '01', 
			vARCode_P_Branch, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := round( vTotalAmount*100/(100 + vGSTRate*100), 2 ); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL31', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL32', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

--PAYNOW, PAYNOWQR - Daily Settlement
	
	-- calculate PAYNOW QR for retailer
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType in (2,4);

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL33', 'Y8', '11', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL34', 'Y8', '01', 
			vARCode_Q_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW for retailer
	
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType in (2,4);
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL35', 'Y8', '01', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL36', 'Y8', '11', 
			vARCode_P_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW QR for branches
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL37', 'Y8', '11', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL38', 'Y8', '01', 
			vARCode_Q_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate PAYNOW for branch
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL39', 'Y8', '01', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL40', 'Y8', '11', 
			vARCode_P_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- END

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
	
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
					terdisplayid,
					prodname,
					amount,
					ticketcount ,
					FLAG,
					TransType,
					vPeriodStartDate as FromDate,
					vPeriodEndDate as InToDate
					from public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);

				create temporary table if not exists ubt_tmp_paynow_SecondDate
				(
					Amt numeric(32,3),
					Fee numeric(32,3),
					ProductName VARCHAR(100),
					TerDisplayID VARCHAR(200)
				);
				insert into ubt_tmp_paynow_SecondDate
				select
					SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					'PaynowQR' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') 
					group by terdisplayid
				union select
					SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					 'Paynow' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('Paynow [+trans fee]', 'Paynow') 
					group by terdisplayid;

				-- Add Paynow to ubt_tmp_V2_TAD_SecondDate
				insert into ubt_tmp_V2_TAD_SecondDate 
				select
					terdisplayid, ProductName, (a.Amt - a.Fee) as amount,
					0 as ticketcount, 'CAS' as FLAG, 'CL' as TransType,
					vPeriodStartDate as FromDate, vPeriodEndDate as InToDate
					from ubt_tmp_paynow_SecondDate a;
				DROP TABLE IF EXISTS ubt_tmp_paynow_SecondDate;

				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_SecondDate (FLAG, ProductName);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline Orders'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
				
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
				 when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				 when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		 end),0) as Amount
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				-- IBG PAYMENTS
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud		
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;

			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;

			IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
				when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
  				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;

--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

                        return query             
                                         select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
                                         , a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
                                         coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
                                         a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
                                         a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
                                         a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
                                         a.Amount, a.Product, a.DrawNumber, a.Customer
                        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;
							
DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_epayment_prod(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1123 (class 1255 OID 349382)
-- Name: sp_ubt_getrtshopcloud_gstchange(date); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_gstchange(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$
declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vHQLocation varchar:='008888';
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vTotalTempAmountPerLocation int4:=0;
vGST_TaxCode varchar;

begin

	--01-Nov-2022: Change to replace GST taxcode with variable
	select case when InBusinessDate <= date '2022-12-31' then 'ZA1'
				when InBusinessDate >= date '2023-01-01' and InBusinessDate <= date '2023-12-31' then 'YA'
				when InBusinessDate >= date '2024-01-01' then 'XA'
			end into vGST_TaxCode;
	
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount ,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);
	
insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline 		Orders'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (5, 6)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000011', vGST_TaxCode,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMM IN ADV FOR RETAILERS', '12540004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'PAY';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
			select 1 into vFlagIsInsert;
	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, '', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000011', vGST_TaxCode,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch

	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO' and LocDisplayID  <>vHQLocation; 

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

	--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA', '40', 
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA', '15', 
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select 
	coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN'  then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;
	
	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA', '01', 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA', '50', 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;	

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
	
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
				terdisplayid,
				prodname,
				amount,
				ticketcount ,
				FLAG,
				TransType,
				vPeriodStartDate as FromDate,
				vPeriodEndDate as InToDate
				from
				public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);
				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_FirstDate (FLAG, ProductName);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN 				('SPORTS', 'Offline Orders'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
				
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, 				T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', 'P1', 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
		 		 end),0) as Amount		
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select 	coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;
				IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, '', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, 				loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
  				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;
		
--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

                        return query             
                                         select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
                                         , a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
                                         coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
                                         a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
                                         a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
                                         a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
                                         a.Amount, a.Product, a.DrawNumber, a.Customer
                        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;
							
DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;

end;
$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_gstchange(inbusinessdate date) OWNER TO postgres;

--
-- TOC entry 1227 (class 1255 OID 2398008)
-- Name: sp_ubt_getrtshopcloud_hr(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_hr(inbusinessdate date, vseq integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vTotalTempAmountPerLocation int4:=0;
vInputTax varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vInputTax');
vGSTRate numeric;
vLocDisplayID text;
vOutputTax varchar;

begin

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

-- GST Config
SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
FROM ztubt_gstconfig zg
WHERE inbusinessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
ORDER BY zg.effectivefrom
LIMIT 1;
-- GST config for Gate Admission
select 'S3' into vOutputTax;

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('HORSE RACING','Gate Admission'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (1)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814009', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000013', '',
			null, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	--WHERE LocType IN (2, 4) AND FLAG = 'PAY'
    WHERE LocType IN (2, 4) AND (FLAG = 'PAY' OR (FLAG = 'RFD' AND type <> 'OO'));

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815016', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
	
--Calculate Rebate Amount by Retailer: Added on 24-Sep-2024 by Hitachi
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
    WHERE LocType IN (2, 4) AND FLAG = 'RBT';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REBATE FOR RETAILERS', '21100211', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer
--
--	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
--	FROM ubt_tmp_V2_LocationTempData
--	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';
--
--	IF vTotalAmount <> 0 then
--	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL6', 'Y8', '40', 
--			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, 'HORSE RACING', '', ''
--		);
--			select 1 into vFlagIsInsert;
--	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	-- 2023Jan25 - Include HQLocation 8888
	-- when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' then coalesce(amount,0) 
	when LocType =1 and flag='PAY' then coalesce(amount,0) 
	when LocType =1 and flag='RBT' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'HORSE RACING', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814009', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000013', '',
			null, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	-- 2023Jan25 - Include HQLocation 8888
	-- WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	--WHERE LocType =1 AND FLAG = 'PAY';
    WHERE LocType =1 AND (FLAG = 'PAY' OR (FLAG = 'RFD' AND type <> 'OO'));
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815016', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
	
--Calculate Rebate Amount by Branches: Added on 24-Sep-2024 by Hitachi
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
    WHERE LocType = 1 AND FLAG = 'RBT';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REBATE FOR BRANCHES', '21100211', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch
--
--	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
--	FROM ubt_tmp_V2_LocationTempData
--	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO'; 
--
--	IF vTotalAmount <> 0 then
--	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL20', 'Y8', '40', 
--			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, 'HORSE RACING', '', ''
--		);
--
--		select 1 into vFlagIsInsert;
--	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;
-----------------------------------------------------------------------
--BRANCHES GATE ADMISSION
	--Calculate Invoice Amount For Branches
	create temporary table if not exists ubt_tmp_gateadmission 
	(
		LocDisplayID VARCHAR(100),
		Amount numeric(32, 3)
	);

	insert into ubt_tmp_gateadmission
	select LocDisplayID,
	coalesce (sum(case 
	when LocType =1 and flag='COL' and ProductName='Gate Admission' then coalesce(amount,0)
	end),0)as amount 
	from ubt_tmp_V2_LocationTempData
	group by LocDisplayID;

	----Invoice for Branches
	select sum(amount) as amount into vTotalAmount
	from ubt_tmp_gateadmission;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL21', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'HORSE RACING', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Gate Admission is for customers who are paying to watch Horse Racing
	FOR vLocDisplayID, vTotalAmount, vBaseAmount IN 
        SELECT LocDisplayID ,amount ,amount * 100 / (100 + vGSTRate * 100)
        FROM ubt_tmp_gateadmission
    LOOP
		vTotalAmount := vTotalAmount - vBaseAmount; -- GST

		IF vTotalAmount <> 0 then
			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
			(
				IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
				DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
				SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
				SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
				Amount, Product, DrawNumber, Customer)
			VALUES
			(
				NULL, inBusinessDate, NULL, vSeq,
				vl_DocDate, 'MCOL23', 'Y8', '50', 
				'', 'GATEADMISSION ' || to_char(inBusinessDate,'DD/MM/YYYY')||'-RET NO-' || vLocDisplayID, '22000000', vOutputTax,
				vBaseAmount, '', '',  'SGD', 
				vTotalAmount, 'HORSE RACING', '', ''
			);
			select 1 into vFlagIsInsert;
		END IF;
		IF vBaseAmount <> 0 THEN
            INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
            (
                IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
                DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
                SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
                SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
                Amount, Product, DrawNumber, Customer
            )
            VALUES
            (
                NULL, inBusinessDate, NULL, vSeq,
                vl_DocDate, 'MCOL22', 'Y8', '50', 
                '', 'GATEADMISSION ' || to_char(inBusinessDate, 'DD/MM/YYYY')||'-RET NO-' || vLocDisplayID, '41090020', '',
                NULL, '', '', 'SGD', 
                vBaseAmount, 'HORSE RACING', '', vLocDisplayID
            );
            SELECT 1 INTO vFlagIsInsert;
		END IF;
	END LOOP;

    	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;
-------------------------------------------------------------------
--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO'
	or (Loctype= 1 AND FLAG = 'COL' AND ProductName='Gate Admission');
	-- Inclusive of Paynow QR Branch
--	SELECT vTotalAmount - sum_paynowqr AS amount into vTotalAmount
--	FROM (SELECT
--		SUM(CASE WHEN productname = 'PaynowQR' THEN amount ELSE 0 END) AS sum_paynowqr
--	  FROM  ubt_tmp_V2_LocationTempData 
--	  WHERE flag = 'CAS' and type='CL' and LocType =1
--	) tmp;

	IF vTotalAmount <> 0 then	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '40' ELSE '15' END,
			'', 'HR CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '15' ELSE '40' END,
			'23100000', 'HR CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select
	-- 2023Jan25 - Include HQLocation 8888
	-- coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	-- when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	coalesce (sum(case when LocType =1 and flag='PAY' then coalesce(amount,0)
	when LocType =1 and flag='RFD' and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN' then coalesce(amount,0)
	when LocType =1 and flag='RBT' then coalesce(amount,0) --2024Sep24: include Rebate
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;

	-- Inclusive of Paynow Branch
--	SELECT vTotalAmount + sum_paynow AS amount into vTotalAmount
--	FROM (SELECT
--		SUM(CASE WHEN productname = 'Paynow' THEN amount ELSE 0 END) AS sum_paynow
--	  FROM  ubt_tmp_V2_LocationTempData 
--	  WHERE flag = 'CAS' and type='CL' and LocType =1
--	) tmp;

	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '01' ELSE '50' END, 
			'23100000', 'HR CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '50' ELSE '01' END, 
			'', 'HR CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

		if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('HORSE RACING'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
				 --when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				 --when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		 end),0) as Amount
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				-- IBG PAYMENTS
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud		
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;

			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;

			IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
				--when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				--when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'HORSE RACING', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;

--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;



	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;	
	DROP TABLE  IF EXISTS ubt_tmp_gateadmission;

    return vSeq;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_hr(inbusinessdate date, vseq integer) OWNER TO sp_postgres;

--
-- TOC entry 1131 (class 1255 OID 1953155)
-- Name: sp_ubt_getrtshopcloud_hr_bk20240924(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_hr_bk20240924(inbusinessdate date, vseq integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vTotalTempAmountPerLocation int4:=0;
vInputTax varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vInputTax');

begin

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('HORSE RACING'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (1)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814009', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000013', '',
			null, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	--WHERE LocType IN (2, 4) AND FLAG = 'PAY'
    WHERE LocType IN (2, 4) AND (FLAG = 'PAY' OR (FLAG = 'RFD' AND type <> 'OO'));

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815016', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer
--
--	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
--	FROM ubt_tmp_V2_LocationTempData
--	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';
--
--	IF vTotalAmount <> 0 then
--	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL6', 'Y8', '40', 
--			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, 'HORSE RACING', '', ''
--		);
--			select 1 into vFlagIsInsert;
--	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	-- 2023Jan25 - Include HQLocation 8888
	-- when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' then coalesce(amount,0) 
	when LocType =1 and flag='PAY' then coalesce(amount,0) 
	when LocType =1 and flag='RBT' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'HORSE RACING', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814009', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000013', '',
			null, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	-- 2023Jan25 - Include HQLocation 8888
	-- WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	--WHERE LocType =1 AND FLAG = 'PAY';
    WHERE LocType =1 AND (FLAG = 'PAY' OR (FLAG = 'RFD' AND type <> 'OO'));
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815016', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch
--
--	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
--	FROM ubt_tmp_V2_LocationTempData
--	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO'; 
--
--	IF vTotalAmount <> 0 then
--	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL20', 'Y8', '40', 
--			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, 'HORSE RACING', '', ''
--		);
--
--		select 1 into vFlagIsInsert;
--	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	-- Inclusive of Paynow QR Branch
--	SELECT vTotalAmount - sum_paynowqr AS amount into vTotalAmount
--	FROM (SELECT
--		SUM(CASE WHEN productname = 'PaynowQR' THEN amount ELSE 0 END) AS sum_paynowqr
--	  FROM  ubt_tmp_V2_LocationTempData 
--	  WHERE flag = 'CAS' and type='CL' and LocType =1
--	) tmp;

	IF vTotalAmount <> 0 then	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '40' ELSE '15' END,
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '15' ELSE '40' END,
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select
	-- 2023Jan25 - Include HQLocation 8888
	-- coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	-- when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	coalesce (sum(case when LocType =1 and flag='PAY' then coalesce(amount,0)
	when LocType =1 and flag='RFD' and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;

	-- Inclusive of Paynow Branch
--	SELECT vTotalAmount + sum_paynow AS amount into vTotalAmount
--	FROM (SELECT
--		SUM(CASE WHEN productname = 'Paynow' THEN amount ELSE 0 END) AS sum_paynow
--	  FROM  ubt_tmp_V2_LocationTempData 
--	  WHERE flag = 'CAS' and type='CL' and LocType =1
--	) tmp;

	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '01' ELSE '50' END, 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '50' ELSE '01' END, 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

		if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('HORSE RACING'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
				 --when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				 --when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		 end),0) as Amount
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				-- IBG PAYMENTS
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud		
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;

			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;

			IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
				--when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				--when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'HORSE RACING', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;

--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;



	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;	

    return vSeq;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_hr_bk20240924(inbusinessdate date, vseq integer) OWNER TO sp_postgres;

--
-- TOC entry 1094 (class 1255 OID 1881314)
-- Name: sp_ubt_getrtshopcloud_hr_bk20250326(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_hr_bk20250326(inbusinessdate date, vseq integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vTotalTempAmountPerLocation int4:=0;
vInputTax varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vInputTax');

begin

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('HORSE RACING'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (1)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814009', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000013', '',
			null, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	--WHERE LocType IN (2, 4) AND FLAG = 'PAY'
    WHERE LocType IN (2, 4) AND (FLAG = 'PAY' OR (FLAG = 'RFD' AND type <> 'OO'));

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815016', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
	
--Calculate Rebate Amount by Retailer: Added on 24-Sep-2024 by Hitachi
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
    WHERE LocType IN (2, 4) AND FLAG = 'RBT';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REBATE FOR RETAILERS', '21100211', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer
--
--	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
--	FROM ubt_tmp_V2_LocationTempData
--	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';
--
--	IF vTotalAmount <> 0 then
--	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL6', 'Y8', '40', 
--			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, 'HORSE RACING', '', ''
--		);
--			select 1 into vFlagIsInsert;
--	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	-- 2023Jan25 - Include HQLocation 8888
	-- when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' then coalesce(amount,0) 
	when LocType =1 and flag='PAY' then coalesce(amount,0) 
	when LocType =1 and flag='RBT' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'HORSE RACING', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814009', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000013', '',
			null, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	-- 2023Jan25 - Include HQLocation 8888
	-- WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	--WHERE LocType =1 AND FLAG = 'PAY';
    WHERE LocType =1 AND (FLAG = 'PAY' OR (FLAG = 'RFD' AND type <> 'OO'));
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815016', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
	
--Calculate Rebate Amount by Branches: Added on 24-Sep-2024 by Hitachi
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
    WHERE LocType = 1 AND FLAG = 'RBT';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REBATE FOR BRANCHES', '21100211', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch
--
--	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
--	FROM ubt_tmp_V2_LocationTempData
--	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO'; 
--
--	IF vTotalAmount <> 0 then
--	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL20', 'Y8', '40', 
--			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, 'HORSE RACING', '', ''
--		);
--
--		select 1 into vFlagIsInsert;
--	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	-- Inclusive of Paynow QR Branch
--	SELECT vTotalAmount - sum_paynowqr AS amount into vTotalAmount
--	FROM (SELECT
--		SUM(CASE WHEN productname = 'PaynowQR' THEN amount ELSE 0 END) AS sum_paynowqr
--	  FROM  ubt_tmp_V2_LocationTempData 
--	  WHERE flag = 'CAS' and type='CL' and LocType =1
--	) tmp;

	IF vTotalAmount <> 0 then	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '40' ELSE '15' END,
			'', 'HR CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '15' ELSE '40' END,
			'23100000', 'HR CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select
	-- 2023Jan25 - Include HQLocation 8888
	-- coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	-- when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	coalesce (sum(case when LocType =1 and flag='PAY' then coalesce(amount,0)
	when LocType =1 and flag='RFD' and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN' then coalesce(amount,0)
	when LocType =1 and flag='RBT' then coalesce(amount,0) --2024Sep24: include Rebate
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;

	-- Inclusive of Paynow Branch
--	SELECT vTotalAmount + sum_paynow AS amount into vTotalAmount
--	FROM (SELECT
--		SUM(CASE WHEN productname = 'Paynow' THEN amount ELSE 0 END) AS sum_paynow
--	  FROM  ubt_tmp_V2_LocationTempData 
--	  WHERE flag = 'CAS' and type='CL' and LocType =1
--	) tmp;

	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '01' ELSE '50' END, 
			'23100000', 'HR CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '50' ELSE '01' END, 
			'', 'HR CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'HORSE RACING', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

		if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('HORSE RACING'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
				 --when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				 --when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		 end),0) as Amount
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				-- IBG PAYMENTS
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud		
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;

			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;

			IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'HORSE RACING', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
				--when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				--when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'HORSE RACING', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;

--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;



	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;	

    return vSeq;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_hr_bk20250326(inbusinessdate date, vseq integer) OWNER TO sp_postgres;

--
-- TOC entry 1117 (class 1255 OID 1881783)
-- Name: sp_ubt_getrtshopcloud_prod(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_prod(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vGST_Branch varchar;
vInputTax varchar;
vOutputTax varchar;
vGSTRate numeric; --percentage
vARCode_Q_Retailer varchar; -- OCBC QR Code for PNQR
vARCode_Q_Branch varchar; -- OCBC QR Code for PNQR
vARCode_P_Retailer varchar; -- UOB QR Code for Paynow
vARCode_P_Branch varchar; -- UOB QR Code for Paynow

begin
		--01-Nov-2022: Change to replace GST taxcode with variable
	--	PRD
	select case when InBusinessDate <= date '2022-10-31' then 'ZA'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'YA'
				when InBusinessDate >= date '2024-01-01' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-10-31' then 'P1'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'P2'
				when InBusinessDate >= date '2024-01-01' then 'P3'
			end into vInputTax;
			
	select 'S3' into vOutputTax;
	select '24100110' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100120' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100121' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100111' into vARCode_P_Branch; -- UOB QR Code for Paynow
	-- End Prod
			
	/*-- UAT

	select 'S3' into vOutputTax;
	select '24100060' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100061' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100062' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100063' into vARCode_P_Branch; -- UOB QR Code for Paynow

	-- End */

	-- GST Config
	SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
    FROM ztubt_gstconfig zg
    WHERE inbusinessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
    ORDER BY zg.effectivefrom
    LIMIT 1;

   	-- Store common config into temp table
	create temporary table if not exists ubt_tmp_rtshop_config 
	(
		ConfigKey VARCHAR(50),
		ConfigValue VARCHAR(100)
	);
	INSERT INTO ubt_tmp_rtshop_config(ConfigKey, ConfigValue) VALUES('vGST_Branch', vGST_Branch);
	INSERT INTO ubt_tmp_rtshop_config(ConfigKey, ConfigValue) VALUES('vInputTax', vInputTax);
   
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);
	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_paynow_FirstDate
	(
		Amt numeric(32,3),
		Fee numeric(32,3),
		ProductName VARCHAR(100),
		TerDisplayID VARCHAR(200)
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails(InBusinessDate,InBusinessDate);

	insert into ubt_tmp_paynow_FirstDate
	select
		SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'PaynowQR' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') and amount <> 0
		group by terdisplayid
	union select
		SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'Paynow' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('Paynow [+trans fee]', 'Paynow') and amount <> 0
		group by terdisplayid;

	-- Add Paynow to ubt_tmp_V2_TAD_FirstDate
	insert into ubt_tmp_V2_TAD_FirstDate 
	select
		terdisplayid, ProductName, (a.Amt - a.Fee) as Amount,
		0 as ct, 'CAS' as FLAG, 'CL' as TransType,
		InBusinessDate as FromDate, InBusinessDate as InToDate
		from ubt_tmp_paynow_FirstDate a;
	DROP TABLE IF EXISTS ubt_tmp_paynow_FirstDate;

insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;


--Paynow Charges

	-- calculate Paynow QR charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL21', 'Y5', '01', 
			vARCode_Q_Retailer, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL22', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL23', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	
	-- calculate Paynow charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL24', 'Y5', '01', 
			vARCode_P_Retailer, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL25', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL26', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow QR charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL27', 'Y5', '01', 
			vARCode_Q_Branch, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL28', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL29', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL30', 'Y5', '01', 
			vARCode_P_Branch, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL31', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL32', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

--PAYNOW, PAYNOWQR - Daily Settlement
	
	-- calculate PAYNOW QR for retailer
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType in (2,4);

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL33', 'Y8', '11', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL34', 'Y8', '01', 
			vARCode_Q_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW for retailer
	
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType in (2,4);
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL35', 'Y8', '01', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL36', 'Y8', '11', 
			vARCode_P_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW QR for branches
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL37', 'Y8', '11', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL38', 'Y8', '01', 
			vARCode_Q_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate PAYNOW for branch
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL39', 'Y8', '01', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL40', 'Y8', '11', 
			vARCode_P_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- END

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;
	
	DROP TABLE IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE IF EXISTS ubt_tmp_V2_LocationTempData;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
					terdisplayid,
					prodname,
					amount,
					ticketcount ,
					FLAG,
					TransType,
					vPeriodStartDate as FromDate,
					vPeriodEndDate as InToDate
					from public.sp_ubt_gettransamountdetails(vPeriodStartDate,vPeriodEndDate);

				create temporary table if not exists ubt_tmp_paynow_SecondDate
				(
					Amt numeric(32,3),
					Fee numeric(32,3),
					ProductName VARCHAR(100),
					TerDisplayID VARCHAR(200)
				);
				insert into ubt_tmp_paynow_SecondDate
				select
					SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					'PaynowQR' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') 
					group by terdisplayid
				union select
					SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					 'Paynow' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('Paynow [+trans fee]', 'Paynow') 
					group by terdisplayid;

				-- Add Paynow to ubt_tmp_V2_TAD_SecondDate
				insert into ubt_tmp_V2_TAD_SecondDate 
				select
					terdisplayid, ProductName, (a.Amt - a.Fee) as amount,
					0 as ticketcount, 'CAS' as FLAG, 'CL' as TransType,
					vPeriodStartDate as FromDate, vPeriodEndDate as InToDate
					from ubt_tmp_paynow_SecondDate a;
				DROP TABLE IF EXISTS ubt_tmp_paynow_SecondDate;

				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_SecondDate (FLAG, ProductName);

				end if;

	select public.sp_ubt_getrtshopcloud_sports(inbusinessdate, vSeq) into vSeq;
	select public.sp_ubt_getrtshopcloud_hr(inbusinessdate, vSeq) into vSeq;


	return query 
		select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
		, a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
		coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
		a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
		a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
		a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
		a.Amount, a.Product, a.DrawNumber, a.Customer
        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_rtshop_config;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_prod(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1295 (class 1255 OID 1881312)
-- Name: sp_ubt_getrtshopcloud_sports(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_sports(inbusinessdate date, vseq integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vTotalTempAmountPerLocation int4:=0;
vGST_Branch varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vGST_Branch');
vInputTax varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vInputTax');

begin

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);


insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline 		Orders'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (5, 6)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'PAY';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);
			select 1 into vFlagIsInsert;
	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	-- 2023Jan25 - Include HQLocation 8888
	-- when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' then coalesce(amount,0) 
	when LocType =1 and flag='PAY' then coalesce(amount,0) 
	when LocType =1 and flag='RBT' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'SPORTS', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	-- 2023Jan25 - Include HQLocation 8888
	-- WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	WHERE LocType =1 AND FLAG = 'PAY';
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch

	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO'; 

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

	--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	-- Inclusive of Paynow QR Branch
	SELECT vTotalAmount - sum_paynowqr AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' THEN amount ELSE 0 END) AS sum_paynowqr
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '40' ELSE '15' END,
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '15' ELSE '40' END,
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select
	-- 2023Jan25 - Include HQLocation 8888
	-- coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	-- when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	coalesce (sum(case when LocType =1 and flag='PAY' then coalesce(amount,0)
	when LocType =1 and flag='RFD' and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN' then coalesce(amount,0)
--	when LocType =1 and productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(amount,0) -- Inclusive of Paynow Branch
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;

	-- Inclusive of Paynow Branch
	SELECT vTotalAmount + sum_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' THEN amount ELSE 0 END) AS sum_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '01' ELSE '50' END, 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '50' ELSE '01' END, 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

		if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;


	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN 				('SPORTS', 'Offline Orders'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, 				T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
				 when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				 when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		 end),0) as Amount
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				-- IBG PAYMENTS
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud		
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;

			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;

			IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
				when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'SPORTS', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;

--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

							

	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;	

    return vSeq;					
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_sports(inbusinessdate date, vseq integer) OWNER TO sp_postgres;

--
-- TOC entry 1224 (class 1255 OID 2392119)
-- Name: sp_ubt_getrtshopcloud_sports_bk20250310(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_sports_bk20250310(inbusinessdate date, vseq integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vTotalTempAmountPerLocation int4:=0;
vGST_Branch varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vGST_Branch');
vInputTax varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vInputTax');

begin

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);


insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline 		Orders'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (5, 6)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'PAY';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);
			select 1 into vFlagIsInsert;
	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	-- 2023Jan25 - Include HQLocation 8888
	-- when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' then coalesce(amount,0) 
	when LocType =1 and flag='PAY' then coalesce(amount,0) 
	when LocType =1 and flag='RBT' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'SPORTS', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	-- 2023Jan25 - Include HQLocation 8888
	-- WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	WHERE LocType =1 AND FLAG = 'PAY';
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch

	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO'; 

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

	--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	-- Inclusive of Paynow QR Branch
	SELECT vTotalAmount - sum_paynowqr AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' THEN amount ELSE 0 END) AS sum_paynowqr
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '40' ELSE '15' END,
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '15' ELSE '40' END,
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select
	-- 2023Jan25 - Include HQLocation 8888
	-- coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	-- when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	coalesce (sum(case when LocType =1 and flag='PAY' then coalesce(amount,0)
	when LocType =1 and flag='RFD' and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN' then coalesce(amount,0)
--	when LocType =1 and productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(amount,0) -- Inclusive of Paynow Branch
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;

	-- Inclusive of Paynow Branch
	SELECT vTotalAmount + sum_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' THEN amount ELSE 0 END) AS sum_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '01' ELSE '50' END, 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '50' ELSE '01' END, 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

		if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;


	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN 				('SPORTS', 'Offline Orders'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, 				T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
				 when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				 when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		 end),0) as Amount
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				-- IBG PAYMENTS
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud		
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;

			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;

			IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
				when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'SPORTS', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;

--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

							

	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;	

    return vSeq;					
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_sports_bk20250310(inbusinessdate date, vseq integer) OWNER TO sp_postgres;

--
-- TOC entry 1225 (class 1255 OID 2392317)
-- Name: sp_ubt_getrtshopcloud_sports_testgateadmission(date, integer); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_sports_testgateadmission(inbusinessdate date, vseq integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vTotalTempAmountPerLocation int4:=0;
vGST_Branch varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vGST_Branch');
vInputTax varchar := (SELECT ConfigValue FROM ubt_tmp_rtshop_config where ConfigKey = 'vInputTax');

begin

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);

	create temporary table if not exists ubt_tmp_V2_TSNWagerSalesAmountData 
	(
		TerDisplayID varchar(100), 
		LocID int4,
		LocType int4,
		Wager numeric(22, 2), 
		Sales numeric(22, 11)
	);


insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	(FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN ('SPORTS', 'Offline 		Orders','Gate Admission'))) 
	OR FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');
		
insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;
	--GET Wager, Sales amount per TSN
	--Calculate and get wager and sales amount

	INSERT INTO ubt_tmp_V2_TSNWagerSalesAmountData
		SELECT GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID,
		ROUND(trunc(SUM(coalesce (Wager,0)) / 100,2), 2) * 100 AS Wager, --ROUND(SUM(coalesce (Wager,0)) / 100, 2,1)
		ROUND (trunc(SUM(coalesce (Sales,0)) / 100,2), 2) * 100 AS Sales--ROUND (SUM(coalesce (Sales,0)) / 100, 2,1)
		FROM
		(
			SELECT gat.TicketSerialNumber, T.TerDisplayID, L.LocID, L.LocTypeID, 
			CASE WHEN PBTH.IsCancelled = false THEN Wager ELSE 0 END AS Wager, 
			CASE WHEN PBTH.IsCancelled = false THEN Sales ELSE 0 END AS Sales
			FROM ubt_tmp_V2_GAT gat
			INNER JOIN ztubt_placedbettransactionheader pbth ON 			gat.TicketSerialNumber=pbth.TicketSerialNumber
			INNER JOIN ztubt_Terminal t ON PBTH.TerDisplayID = t.TerDisplayID
			INNER JOIN ztubt_Location l ON t.LocID = l.LocID
			WHERE pbth.ProdID IN (5, 6)
		)GAT
		GROUP BY GAT.TerDisplayID, GAT.LocID, GAT.LocTypeID;
	

	--RETAILERS NORMAL
	--Calculate Invoice Amount For Retailers
	
	select 
	coalesce (sum(case when LocType in(2,4) and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType in(2,4) and flag='CAN'then coalesce(amount,0)
	when LocType in(2,4) and flag='RFD' and type<>'OO'then coalesce(amount,0) 
	when LocType in(2,4) and flag='PAY'then coalesce(amount,0) 
	when LocType in(2,4) and flag='SAL'then coalesce(amount,0) 
	when LocType in(2,4) and flag='RBT'then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;
	
	if vTotalAmount<>0 then
	
	insert into ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL1', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'21100091', 'INVOICE FOR RETAILERS', '12100001', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Retailers

	select coalesce(sum(coalesce(Sales,0)),0) as amount into vTotalAmount 
	from ubt_tmp_V2_TSNWagerSalesAmountData where locType in(2,4)	;

	if vTotalAmount<>0 then

	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, InBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL2', 'Y8', '50', 
			'', 'SALES IN ADV FOR RETAILERS', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Retailers
	
	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4); 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  +vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType IN (2, 4);

	if vTotalAmount<>0 then
	
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inbusinessdate, NULL, vSeq,
			vl_DocDate, 'MCOL3', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR RETAILERS', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- Start of change: Added on 07-Aug-2023: Added Product and Customer
--Calculate Sales Comm Amount For Retailers
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'SAL'; 

	IF vTotalAmount <> 0  then
	
--		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
--		(
--			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
--			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
--			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
--			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
--			Amount, Product, DrawNumber, Customer)
--		VALUES
--		(
--			NULL, inBusinessDate, NULL, vSeq,
--			vl_DocDate, 'MCOL4', 'Y8', '40', 
--			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
--			NULL, '', '',  'SGD', 
--			vTotalAmount, '', '', ''
--		);
	


			INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		
		select 
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL4', 'Y8', '40', 
			'', 'SALES COMMISSION FOR RETAILERS', '50200010', '',
			NULL, '', '',  'SGD', 
			coalesce(SUM(Amount),0)*-1, ProductName, '', LocDisplayID
		FROM ubt_tmp_V2_LocationTempData
		WHERE LocType IN (2, 4) AND FLAG = 'SAL' and amount <>0
		group by ProductName, LocDisplayID;
	
		select 1 into vFlagIsInsert;
	end if;

-- End of change: Added on 07-Aug-2023: Added Product and Customer

--Calculate Prizes Paid Amount by Retailer
	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'PAY';

	
	IF vTotalAmount <> 0  then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL5', 'Y8', '40', 
			'', 'PRIZES PAID BY RETAILERS', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Retailer

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType IN (2, 4) AND FLAG = 'RFD' and type<> 'OO';

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL6', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-RETAILERS', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);
			select 1 into vFlagIsInsert;
	end if;				
			if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;
--BRANCHES NORMAL
	--Calculate Invoice Amount For Branches
	select 
	coalesce (sum(case 
	when LocType =1 and flag='COL' and type<>'OO'then coalesce(amount,0)
	when LocType =1 and flag='CAN'then coalesce(amount,0)
	-- 2023Jan25 - Include HQLocation 8888
	-- when LocType =1 and flag='RFD' and type<>'OO' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='PAY' and LocDisplayID<>vHQLocation then coalesce(amount,0) 
	-- when LocType =1 and flag='RBT' and LocDisplayID<>vHQLocation then coalesce(amount,0)
	when LocType =1 and flag='RFD' and type<>'OO' then coalesce(amount,0) 
	when LocType =1 and flag='PAY' then coalesce(amount,0) 
	when LocType =1 and flag='RBT' then coalesce(amount,0)
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	if vTotalAmount<>0 then
	INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL16', 'Y8', CASE WHEN vTotalAmount >= 0 THEN '01' ELSE '11' END, 
			'23100000', 'INVOICE FOR BRANCHES', '12100003', '',
			NULL, '', '',  'SGD', 
			CASE WHEN vTotalAmount >= 0 THEN vTotalAmount ELSE vTotalAmount * -1 END, 'SPORTS', '', ''
		);
	
		select 1 into vFlagIsInsert;
	end if;

	--Calculate Sales Amount For Branches

	SELECT coalesce(SUM(coalesce(sales,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType =1; 
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL17', 'Y8', '50', 
			'', 'SALES IN ADV FOR BRANCHES', '21814004', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	--Calculate GST Amount For Branches

	select coalesce(sum(coalesce( Wager,0)),0)
		  -coalesce(sum(coalesce( Sales,0)),0) as amt into vTotalAmount
	from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1; 
	
	select coalesce(sum(coalesce( Sales,0)),0)
		  + vTotalAmount as amt into vBaseAmount
    from ubt_tmp_V2_TSNWagerSalesAmountData
	WHERE LocType=1;
	

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL18', 'Y8', '50', 
			'', 'GOOD & SERVICES TAX FOR BRANCHES', '22000011', vGST_Branch,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;
--Calculate Prizes Paid Amount by Branch

	SELECT coalesce(SUM(Amount),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	-- 2023Jan25 - Include HQLocation 8888
	-- WHERE LocType =1 AND FLAG = 'PAY' and LocDisplayID <> vHQLocation;
	WHERE LocType =1 AND FLAG = 'PAY';
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL19', 'Y8', '40', 
			'', 'PRIZES PAID BY BRANCHES', '21815007', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

--Calculate Redemption Collection Amount by Branch

	SELECT coalesce(SUM(coalesce(Amount,0)),0)*-1 as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	WHERE LocType =1 AND FLAG = 'RFD' and type<> 'OO'; 

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL20', 'Y8', '40', 
			'', 'REDEMPTION COLLECTION-BRANCHES', '21816001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	END if;

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;
		
	select 0 into vFlagIsInsert;

	--CASH RECEIPTS
	--Calculate Cash Receipts Amount

	SELECT coalesce(SUM(coalesce(Amount,0)),0) as amt into vTotalAmount 
	FROM ubt_tmp_V2_LocationTempData
	 WHERE LocType =1 AND FLAG = 'COL' and type<> 'OO';

	-- Inclusive of Paynow QR Branch
	SELECT vTotalAmount - sum_paynowqr AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' THEN amount ELSE 0 END) AS sum_paynowqr
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP1', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '40' ELSE '15' END,
			'', 'CASH RECEIPTS', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP2', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '15' ELSE '40' END,
			'23100000', 'CASH RECEIPTS', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	IF vFlagIsInsert = 1 then
	
		select vSeq+1 into vSeq;
	end if;

	select 0 into vFlagIsInsert;

	--CASH PAYMENTS 
	--Calculate Cash Payout Amount

	select
	-- 2023Jan25 - Include HQLocation 8888
	-- coalesce (sum(case when LocType =1 and flag='PAY' and LocDisplayID <> vHQLocation then 	coalesce(amount,0)
	-- when LocType =1 and flag='RFD' and LocDisplayID <> vHQLocation and Type <> 'OO' then coalesce(amount,0)
	coalesce (sum(case when LocType =1 and flag='PAY' then coalesce(amount,0)
	when LocType =1 and flag='RFD' and Type <> 'OO' then coalesce(amount,0)
	when LocType =1 and flag='CAN' then coalesce(amount,0)
--	when LocType =1 and productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(amount,0) -- Inclusive of Paynow Branch
	end),0)as amount into vTotalAmount
	from ubt_tmp_V2_LocationTempData;

	select vTotalAmount*-1 into vTotalAmount;

	-- Inclusive of Paynow Branch
	SELECT vTotalAmount + sum_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' THEN amount ELSE 0 END) AS sum_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and type='CL' and LocType =1
	) tmp;

	if vTotalAmount<>0 then

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP3', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '01' ELSE '50' END, 
			'23100000', 'CASH PAYMENTS ', '12100003', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MDEP4', 'YA',
			CASE WHEN vTotalAmount > 0 THEN '50' ELSE '01' END, 
			'', 'CASH PAYMENTS ', '10010001', '',
			NULL, '', '',  'SGD', 
			abs(vTotalAmount), 'SPORTS', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

		if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
			end if;		
		select 0 into vFlagIsInsert;


	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	create temporary table if not exists ubt_tmp_V2_TerminalForInvoicePeriodData 
				(
					TerDisplayID varchar(100),
					ProductName varchar(100),
					Amount decimal(32, 3),
					FLAG char(5),
					Type char(5)
				);

				create temporary table if not exists ubt_tmp_V2_LocationInvoicePeriodData (
					LocID INT,
					LocDisplayID VARCHAR(100),
					LocName VARCHAR(100),
					LocType int,
					IsIBG bool,
					IsGST bool,
					ProductName varchar(100),
					Amount numeric(32, 3),
					FLAG varchar(20),
					Type varchar(25)
				);

				INSERT INTO ubt_tmp_V2_TerminalForInvoicePeriodData
				SELECT TerDisplayID, ProductName, Amount, FLAG, TransType
				FROM ubt_tmp_V2_TAD_SecondDate
				WHERE (FLAG IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL') AND (ProductName IN 				('SPORTS', 'Offline Orders'))) 
				OR FLAG NOT IN('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, 				T.ProductName, MAX(T.Amount), T.FLAG, T.Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData T
				INNER JOIN public.ztubt_Terminal Ter ON T.TerDisplayID = Ter.TerDisplayID 
				INNER JOIN public.ztubt_Location Loc ON Ter.LocID = Loc.LocID 
				WHERE FLAG IN ('FUN','REC')
				GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,
				T.ProductName, T.FLAG, T.type;
			
				INSERT INTO ubt_tmp_V2_LocationInvoicePeriodData
				SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 				SUM(Amount) AS Amount, FLAG, Type
				FROM ubt_tmp_V2_TerminalForInvoicePeriodData td 
				INNER JOIN public.ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
				INNER JOIN public.ztubt_Location l ON t.LocID = l.LocID
				WHERE --t.IsDeleted = 0 AND l.IsDeleted = 0 AND 
				FLAG NOT IN ('FUN','REC')
				GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName,
				FLAG, type;

				--CONVERT TO CENTS
				UPDATE ubt_tmp_V2_LocationInvoicePeriodData SET Amount = Amount * 100 where 1=1;

				--INPUT TAX ON SALES COMMISSION TO RETAILERS 
				--Calculate GST on Sales Comms For Retailers
				
			select coalesce(sum(Amount),0)*-1 into vTotalAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'GST';
		
			select coalesce(sum(Amount),0)*-1 into vBaseAmount
			from ubt_tmp_V2_LocationInvoicePeriodData
			WHERE LocType IN (2,4) AND FLAG = 'SAL'and IsGST=true;
		
			IF vTotalAmount <> 0 then
				
					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX1', 'Y5', '11', 
						'21100091', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MTAX2', 'Y5', '40', 
						'', 'INPUT TAX ON SALES COMMISSION TO RETAILERS', '22005000', vInputTax, 
						vBaseAmount, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
				if vFlagIsInsert=1 then
				select vSeq+1 into vSeq;
				end if;
				select 0 into vFlagIsInsert;
						
			create temporary table if not exists ubt_tmp_V2_Tab 
				(
					LocID INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_Tab
				select LocID,
		 			coalesce (sum(case when flag='COL' and type<>'OO' then coalesce(amount,0)--INFLOW
		 		 when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		 when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		 when flag='GST' then coalesce(amount,0)--GST
				 when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				 when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		 end),0) as Amount
				 from ubt_tmp_V2_LocationInvoicePeriodData
				 where isIBG=true and loctype in(2,4)
				 group by LocID;
				
				select coalesce(sum(Amount),0) as amt into vTotalAmount 
				from ubt_tmp_V2_Tab where Amount<0;
			
				if vTotalAmount<0 then
			 
				-- IBG PAYMENTS
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud		
				(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP5', 'YA',  '01', 
						'21100091', 'IBG PAYMENTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP6', 'YA', '50', 
						'', 'IBG PAYMENTS', '11003010', '',
						NULL, '', '',  'SGD', 
						vTotalAmount * -1, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;
			
				IF vFlagIsInsert = 1 then 
				select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;

			--IBG RECEIPTS
			--Calculate IBG Amount for IBG Retailer
			select coalesce(SUM(Amount),0) into vTotalAmount
			FROM ubt_tmp_V2_Tab WHERE Amount > 0;

			IF vTotalAmount > 0 then
				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, InBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP7', 'YA', '40', 
						'', 'IBG RECEIPTS', '11003060', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
					(
						IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
						DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
						SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
						SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
						Amount, Product, DrawNumber, Customer)
					VALUES
					(
						NULL, inBusinessDate, NULL, vSeq,
						vl_DocDate, 'MDEP8', 'YA', '15', 
						'21100091', 'IBG RECEIPTS', '12100001', '',
						NULL, '', '',  'SGD', 
						vTotalAmount, 'SPORTS', '', ''
					);

					select 1 into vFlagIsInsert;
				end if;

				IF vFlagIsInsert = 1 then
				
					select vSeq+1 into vSeq;
				end if;

				select 1 into vFlagIsInsert;
			
			
			--MANUAL PAYMENT ENDED DD/MM/YYYY-NON IBG RETAILERS
			
				create temporary table if not exists ubt_tmp_V2_TempAmountPerLocation 
				(
					LocID INT,
					LocDisplayID VARCHAR(200),
					LocName VARCHAR(100),
					Seq INT,
					Amount numeric(32, 3)
				);

				INSERT INTO ubt_tmp_V2_TempAmountPerLocation
				SELECT A.LocID, A.LocDisplayID, A.LocName, A.Seq, A.Amount
				from (SELECT loc.LocID, loc.LocDisplayID, loc.LocName, ROW_NUMBER()OVER(ORDER BY loc.LocID, loc.LocName ) + vSeq - 1 AS Seq, coalesce(sum(case when flag='COL' and type<>'OO' then 				coalesce(amount,0)--INFLOW
		 		when flag in('CAN','PAY','RFD','RBT') and type<>'OO' then coalesce(amount,0)--OUTFLOW
		 		when flag='SAL' then coalesce(amount,0)--SALES COMMISION
		 		when flag='GST' then coalesce(amount,0)--GST
				when productname = 'PaynowQR' and flag='CAS' and type='CL' then coalesce(-amount,0)--PaynowQR(Incoming)
				when productname = 'Paynow' and flag='CAS' and type='CL' then coalesce(-amount,0)--Paynow(Outcoming)
		 		end),0) as Amount
		 		fROM ubt_tmp_V2_LocationInvoicePeriodData loc
						WHERE loc.IsIBG <> true AND loc.LocType IN (2, 4)
						GROUP BY loc.LocID, loc.LocDisplayID, loc.LocName
				)A	where A.Amount<>0;	
				
				select count(1) into vTotalTempAmountPerLocation from ubt_tmp_V2_TempAmountPerLocation;

				IF vTotalTempAmountPerLocation > 0 then
				
				SELECT MAX(Seq) + 1 into vSeq
				FROM ubt_tmp_V2_TempAmountPerLocation;
				end if;

				INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
				(
					IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
					DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
					SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
					SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
					Amount, Product, DrawNumber, Customer
				)
								
				SELECT NULL, inBusinessDate, 
				NULL, Loc.Seq,
				vl_DocDate, 
				CASE WHEN Amount >= 0 AND constant = 1 THEN
					'MPYT1'
				WHEN Amount >= 0 AND constant = 2 THEN
					'MPYT2'
				WHEN Amount < 0 AND constant = 1 THEN
					'MPYT3'
				ELSE
					'MPYT4'
				END, 'Y6', 
				CASE WHEN (Amount >= 0 AND constant = 1) OR (Amount < 0 AND constant = 2) THEN
					'11'
				ELSE
					'01'
				END,
				CASE WHEN constant = 1 THEN
					'21100091'
				ELSE
					loc.LocDisplayID
				END, 
				CASE WHEN constant = 1 THEN
				'MANUAL PAYMENT ENDED ' || to_char(inBusinessDate, 'DD/MM/YYYY') || '-NON IBG RETAILERS'
				ELSE
					LEFT('MANUAL PAYMENT ENDED ' || to_char(inBusinessDate,'DD/MM/YYYY') || '-' || loc.LocName, 50)
				END, '12100001', '',
				NULL, '', '', 'SGD', CASE WHEN Amount >= 0 THEN Amount ELSE Amount * -1 END,
				'SPORTS', '', ''
				FROM 
				(VALUES (1), (2)) AS TempTable(constant),  
				ubt_tmp_V2_TempAmountPerLocation loc
				GROUP BY loc.Seq, loc.LocID, loc.LocDisplayID, loc.LocName, TempTable.constant, Amount;
			end if;

--			return query 			
--					select coalesce(a.IDMMBusinessDay,'000000000000') as IDMMBusinessDay
--					, a.BusinessDate, coalesce(a.ItemID,'000000000000') as ItemID, 
--					coalesce(a.TransactionID,'000000000000') as TransactionID , 
--					a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey, 
--					a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode, 
--					a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
--					a.Amount, a.Product, a.DrawNumber, a.Customer
--			from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

							

	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationTempData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TSNWagerSalesAmountData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TerminalForInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_LocationInvoicePeriodData;
	DROP TABLE  IF EXISTS ubt_tmp_V2_Tab;
	DROP TABLE  IF EXISTS ubt_tmp_V2_TempAmountPerLocation;	

    return vSeq;					
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_sports_testgateadmission(inbusinessdate date, vseq integer) OWNER TO sp_postgres;

--
-- TOC entry 1226 (class 1255 OID 2392319)
-- Name: sp_ubt_getrtshopcloud_testgateadmission(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getrtshopcloud_testgateadmission(inbusinessdate date) RETURNS TABLE(idmmbusinessday character varying, businessdate date, itemid character varying, transactionid character varying, documentdate date, linecode character varying, sapdoctype character varying, sappostingkey character varying, sapcontrolacctcode character varying, linetext character varying, glnumber character varying, saptaxcode character varying, saptaxbaseamount numeric, cccode character varying, sapassignment character varying, currencycode character varying, amt numeric, product character varying, drawnumber character varying, customer character varying)
    LANGUAGE plpgsql
    AS $$

declare
vTotalAmount numeric;
vSeq Int4:=1;
vl_DocDate date:=inbusinessdate+ interval '1 DAY';
vFlagIsInsert Int4:=0;
vBaseAmount numeric;
vnowDayName int4:= extract(dow from inbusinessdate);
vPeriodStartDate date;
vPeriodEndDate date:=inbusinessdate;
vGST_Branch varchar;
vInputTax varchar;
vOutputTax varchar;
vGSTRate numeric; --percentage
vARCode_Q_Retailer varchar; -- OCBC QR Code for PNQR
vARCode_Q_Branch varchar; -- OCBC QR Code for PNQR
vARCode_P_Retailer varchar; -- UOB QR Code for Paynow
vARCode_P_Branch varchar; -- UOB QR Code for Paynow

begin
		--01-Nov-2022: Change to replace GST taxcode with variable
	/*	PRD
			
	select 'S3' into vOutputTax;
	select '24100110' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100120' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100121' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100111' into vARCode_P_Branch; -- UOB QR Code for Paynow
	*/		
	-- UAT
	select case when InBusinessDate <= date '2022-10-31' then 'ZA'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'YA'
				when InBusinessDate >= date '2024-01-01' then 'XA'
			end into vGST_Branch;
			
	select case when InBusinessDate <= date '2022-10-31' then 'P1'
				when InBusinessDate >= date '2022-11-01' and InBusinessDate <= date '2023-12-31' then 'P2'
				when InBusinessDate >= date '2024-01-01' then 'P3'
			end into vInputTax;

	select 'S3' into vOutputTax;
	select '24100060' into vARCode_Q_Retailer; -- OCBC QR Code for PNQR
	select '24100061' into vARCode_Q_Branch; -- OCBC QR Code for PNQR
	select '24100062' into vARCode_P_Retailer; -- UOB QR Code for Paynow
	select '24100063' into vARCode_P_Branch; -- UOB QR Code for Paynow

	-- End

	-- GST Config
	SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
    FROM ztubt_gstconfig zg
    WHERE inbusinessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
    ORDER BY zg.effectivefrom
    LIMIT 1;

   	-- Store common config into temp table
	create temporary table if not exists ubt_tmp_rtshop_config 
	(
		ConfigKey VARCHAR(50),
		ConfigValue VARCHAR(100)
	);
	INSERT INTO ubt_tmp_rtshop_config(ConfigKey, ConfigValue) VALUES('vGST_Branch', vGST_Branch);
	INSERT INTO ubt_tmp_rtshop_config(ConfigKey, ConfigValue) VALUES('vInputTax', vInputTax);
   
	create temporary table if not exists ubt_tmp_V2_TB_RTMS_RTShopCloud
	(
		--SportsMainID int4 IDENTITY(1,1) NOT  PRIMARY KEY,
		IDMMBusinessDay varchar,--int4--changed to varhcar for '000000000000' format ,
		BusinessDate date ,
		ItemID int4 ,
		TransactionID int4 ,
		DocumentDate date ,
		LineCode varchar(12) ,
		SAPDocType varchar(2) ,
		SAPPostingKey varchar(2) ,
		SAPControlAcctCode varchar(15) ,
		LineText varchar(50) ,
		GLNumber varchar(10) ,
		SAPTaxCode varchar(10) ,
		SAPTaxBaseAmount numeric(15,0) ,
		CCCode varchar(10) ,
		SAPAssignment varchar(18) ,
		CurrencyCode varchar(3) ,
		Amount numeric(32,11) ,
		Product varchar(18) ,
		DrawNumber varchar(18) ,
		Customer varchar(10) 
	);

	create temporary table if not exists ubt_tmp_V2_TerminalTempData 
	(
		TerDisplayID varchar(100),
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG char(5),
		Type char(5)
	);

	create temporary table if not exists ubt_tmp_V2_LocationTempData 
	(
		LocID int4,
		LocDisplayID VARCHAR(100),
		LocName VARCHAR(100),
		LocType int4,
		IsIBG bool,
		IsGST bool,
		ProductName varchar(100),
		Amount numeric(32, 3),
		FLAG varchar(20),
		Type varchar(25),
		IsHQ bool
	);
	create temporary table if not exists  ubt_tmp_V2_TAD_FirstDate
	(
		TerDisplayID VARCHAR(200),
		ProductName VARCHAR(100),
		Amount numeric(32,3), 
		Ct int4,
		FLAG CHAR(3),
		TransType CHAR(2),
		FromDate Date,
		ToDate Date
		--INDEX TempTransAmountDetailBusiessDateIndex NONCLUSTERED(FLAG, ProductName) 
	);

	create temporary table if not exists ubt_tmp_paynow_FirstDate
	(
		Amt numeric(32,3),
		Fee numeric(32,3),
		ProductName VARCHAR(100),
		TerDisplayID VARCHAR(200)
	);

	create temporary table if not exists ubt_tmp_V2_GAT
	(
		TicketSerialNumber VARCHAR(500),
		Wager numeric(22,2), 
		SecondWager numeric(22,2),
		Sales numeric(22, 11),
		SecondSales numeric(22, 11),
		SalesComm numeric(22, 11),
		SecondSalesComm numeric(22, 11),
		GST numeric(22, 11),
		SecondGST numeric(22, 11),
		ReturnAmount numeric(22,2), 
		WinningAmount numeric(22,2) 
	);

	insert into ubt_tmp_V2_TAD_FirstDate
	select
	terdisplayid,
	prodname,
	amount,
	ticketcount,
	FLAG,
	TransType,
	InBusinessDate as FromDate,
	InBusinessDate as InToDate
	from
	public.sp_ubt_gettransamountdetails_testgateadmission(InBusinessDate,InBusinessDate);

	insert into ubt_tmp_paynow_FirstDate
	select
		SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'PaynowQR' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') and amount <> 0
		group by terdisplayid
	union select
		SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
		SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
		'Paynow' as ProductName, terdisplayid
		from ubt_tmp_V2_TAD_FirstDate
		where flag='CAS' and ProductName in ('Paynow [+trans fee]', 'Paynow') and amount <> 0
		group by terdisplayid;

	-- Add Paynow to ubt_tmp_V2_TAD_FirstDate
	insert into ubt_tmp_V2_TAD_FirstDate 
	select
		terdisplayid, ProductName, (a.Amt - a.Fee) as Amount,
		0 as ct, 'CAS' as FLAG, 'CL' as TransType,
		InBusinessDate as FromDate, InBusinessDate as InToDate
		from ubt_tmp_paynow_FirstDate a;
	DROP TABLE IF EXISTS ubt_tmp_paynow_FirstDate;

insert into ubt_tmp_V2_GAT
	select
	ticketserialnumber,
	wager, 
	secondwager,
	sales ,
	secondsales,
	salescomm,
	secondsalescomm,
	gst,
	secondgst,
	returnamount,
	winningamount
	from
	public.sp_ubt_getamounttransaction (InBusinessDate,	InBusinessDate);

	CREATE INDEX V2_NCI_FlagProdName_1 ON ubt_tmp_V2_TAD_FirstDate(FLAG,ProductName);

insert into ubt_tmp_V2_TerminalTempData
select 
	TerDisplayID,
	ProductName,
	Amount, 
	FLAG,
	TransType
	from ubt_tmp_V2_TAD_FirstDate
	where 
	FLAG NOT IN ('CAN', 'COL', 'GST', 'PAY', 'RBT', 'RFD', 'SAL');

insert into ubt_tmp_V2_LocationTempData
	SELECT Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST, T.ProductName, 	MAX(T.Amount), T.FLAG, T.Type, Loc.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData T
		INNER JOIN ztubt_terminal Ter ON T.TerDisplayID = Ter.TerDisplayID  
		INNER JOIN ztubt_location Loc ON Ter.LocID = Loc.LocID  
		WHERE FLAG IN ('FUN','REC')
		GROUP BY Loc.LocID, Loc.LocDisplayID, Loc.LocName, Loc.LocTypeID, Loc.IsIBG, Loc.IsGST,T.ProductName,
		T.FLAG, T.Type, Loc.IsHQ
	union all 	
	SELECT l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, 
	SUM(Amount) as Amount, FLAG,Type, l.IsHQ 
	FROM ubt_tmp_V2_TerminalTempData td 
		INNER JOIN ztubt_terminal t ON td.TerDisplayID = t.TerDisplayID
		INNER JOIN ztubt_location l ON t.LocID = l.LocID
		WHERE FLAG NOT IN ('FUN','REC')
		GROUP BY l.LocID, l.LocDisplayID, l.LocName, l.LocTypeID, l.IsIBG, l.IsGST, ProductName, FLAG, Type, 		l.IsHQ;
	
	--CONVERT TO CENTS
	update ubt_tmp_V2_LocationTempData set Amount=Amount*100 where 1=1;


--Paynow Charges

	-- calculate Paynow QR charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL21', 'Y5', '01', 
			vARCode_Q_Retailer, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL22', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL23', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	
	-- calculate Paynow charges for retailer
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType in (2,4)
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL24', 'Y5', '01', 
			vARCode_P_Retailer, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL25', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL26', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow QR charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'PaynowQR' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL27', 'Y5', '01', 
			vARCode_Q_Branch, 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL28', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL29', 'Y5', '50', 
			'', 'PAYNOW QR TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT E-PYT BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate Paynow charges for branch
	
	SELECT sum_transfee_paynow AS amount into vTotalAmount
	FROM (SELECT
		SUM(CASE WHEN productname = 'Paynow' and type = 'TF' THEN amount ELSE 0 END) AS sum_transfee_paynow
	  FROM  ubt_tmp_V2_LocationTempData 
	  WHERE flag = 'CAS' and LocType =1
	) tmp;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL30', 'Y5', '01', 
			vARCode_P_Branch, 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vBaseAmount := vTotalAmount*100/(100 + vGSTRate*100); -- Sales
	IF vBaseAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL31', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '41090007', '',
			NULL, '2001200000', '',  'SGD', 
			vBaseAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	vTotalAmount := vTotalAmount - vBaseAmount; -- GST
	IF vTotalAmount <> 0 then
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL32', 'Y5', '50', 
			'', 'PAYNOW TXN ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' - UBT PZ CLAIM BANK FEE', '22000000', vOutputTax,
			vBaseAmount, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

--PAYNOW, PAYNOWQR - Daily Settlement
	
	-- calculate PAYNOW QR for retailer
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType in (2,4);

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL33', 'Y8', '11', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL34', 'Y8', '01', 
			vARCode_Q_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW for retailer
	
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType in (2,4);
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL35', 'Y8', '01', 
			'21100091', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100001', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL36', 'Y8', '11', 
			vARCode_P_Retailer, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' RET-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;
	-- calculate PAYNOW QR for branches
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM ubt_tmp_V2_LocationTempData 
	WHERE productname = 'PaynowQR' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL37', 'Y8', '11', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL38', 'Y8', '01', 
			vARCode_Q_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW QR', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

	if vFlagIsInsert=1 then
			select vSeq+1 into vSeq;
	end if;		
	select 0 into vFlagIsInsert;

	-- calculate PAYNOW for branch
	SELECT SUM(amount) AS amount into vTotalAmount
	FROM  ubt_tmp_V2_LocationTempData 
	WHERE productname = 'Paynow' and flag = 'CAS' and type = 'CL' and LocType =1;
	
	select vTotalAmount*-1 into vTotalAmount;

	IF vTotalAmount <> 0 then
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL39', 'Y8', '01', 
			'23100000', 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100003', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);
	
		INSERT INTO ubt_tmp_V2_TB_RTMS_RTShopCloud
		(
			IDMMBusinessDay, BusinessDate, ItemID, TransactionID, 
			DocumentDate, LineCode, SAPDocType, SAPPostingKey, 
			SAPControlAcctCode, LineText, GLNumber, SAPTaxCode, 
			SAPTaxBaseAmount, CCCode, SAPAssignment, CurrencyCode,
			Amount, Product, DrawNumber, Customer)
		VALUES
		(
			NULL, inBusinessDate, NULL, vSeq,
			vl_DocDate, 'MCOL40', 'Y8', '11', 
			vARCode_P_Branch, 'GAMING INVOICE ON ' || to_char(inBusinessDate,'DD/MM/YYYY') || ' BR-PAYNOW', '12100000', '',
			NULL, '', '',  'SGD', 
			vTotalAmount, '', '', ''
		);

		select 1 into vFlagIsInsert;
	end if;

-- END

	IF vFlagIsInsert = 1 then 
	
		select vSeq+1 into vSeq;
	end if;

	select 1 into vFlagIsInsert;
	
	DROP TABLE IF EXISTS ubt_tmp_V2_TerminalTempData;
	DROP TABLE IF EXISTS ubt_tmp_V2_LocationTempData;

	--INVOICE PERIOD DATA
	if vNowDayName in(0,4) then
	select case when vNowDayName=0 then inbusinessdate+ interval '-2 DAY'
	when vNowDayName=4 then inbusinessdate+ interval '-3 DAY'
	end as PeriodStartDate into vPeriodStartDate; 
				create temporary table if not exists  ubt_tmp_V2_TAD_SecondDate
				(
					TerDisplayID VARCHAR(200),
					ProductName VARCHAR(100),
					Amount numeric(32, 11), 
					Ct INT,
					FLAG CHAR(3),
					TransType CHAR(2),
					FromDate Date,
					ToDate Date
					--INDEX TempTransAmountDetailPeriodDateIndex NONCLUSTERED(FLAG, ProductName) 
				);

				insert into ubt_tmp_V2_TAD_SecondDate
				select
					terdisplayid,
					prodname,
					amount,
					ticketcount ,
					FLAG,
					TransType,
					vPeriodStartDate as FromDate,
					vPeriodEndDate as InToDate
					from public.sp_ubt_gettransamountdetails_testgateadmission(vPeriodStartDate,vPeriodEndDate);

				create temporary table if not exists ubt_tmp_paynow_SecondDate
				(
					Amt numeric(32,3),
					Fee numeric(32,3),
					ProductName VARCHAR(100),
					TerDisplayID VARCHAR(200)
				);
				insert into ubt_tmp_paynow_SecondDate
				select
					SUM(CASE WHEN ProductName = 'PaynowQR [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'PaynowQR' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					'PaynowQR' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('PaynowQR [+trans fee]', 'PaynowQR') 
					group by terdisplayid
				union select
					SUM(CASE WHEN ProductName = 'Paynow [+trans fee]' THEN amount ELSE 0 END) as Amt,
					SUM(CASE WHEN ProductName = 'Paynow' and TransType = 'TF' THEN amount ELSE 0 END) AS Fee,
					 'Paynow' as ProductName, terdisplayid
					from ubt_tmp_V2_TAD_SecondDate
					where flag='CAS' and amount <> 0 and ProductName in ('Paynow [+trans fee]', 'Paynow') 
					group by terdisplayid;

				-- Add Paynow to ubt_tmp_V2_TAD_SecondDate
				insert into ubt_tmp_V2_TAD_SecondDate 
				select
					terdisplayid, ProductName, (a.Amt - a.Fee) as amount,
					0 as ticketcount, 'CAS' as FLAG, 'CL' as TransType,
					vPeriodStartDate as FromDate, vPeriodEndDate as InToDate
					from ubt_tmp_paynow_SecondDate a;
				DROP TABLE IF EXISTS ubt_tmp_paynow_SecondDate;

				CREATE INDEX V2_NCI_FlagProdName_2 ON ubt_tmp_V2_TAD_SecondDate (FLAG, ProductName);

				end if;

	select public.sp_ubt_getrtshopcloud_sports_testgateadmission(inbusinessdate, vSeq) into vSeq;
	select public.sp_ubt_getrtshopcloud_hr_testgateadmission(inbusinessdate, vSeq) into vSeq;


	return query 
		select coalesce(LPAD(a.IDMMBusinessDay,12,'0'),'000000000000')::varchar as IDMMBusinessDay
		, a.BusinessDate, coalesce(LPAD(a.ItemID::varchar,12,'0'),'000000000000')::varchar as ItemID,
		coalesce(LPAD(a.TransactionID::varchar,12,'0'),'000000000000')::varchar as TransactionID ,
		a.DocumentDate, a.LineCode, a.SAPDocType, a.SAPPostingKey,
		a.SAPControlAcctCode, a.LineText, a.GLNumber, a.SAPTaxCode,
		a.SAPTaxBaseAmount, a.CCCode, a.SAPAssignment, a.CurrencyCode,
		a.Amount, a.Product, a.DrawNumber, a.Customer
        from ubt_tmp_V2_TB_RTMS_RTShopCloud a;

DROP TABLE  IF EXISTS ubt_tmp_V2_GAT;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_FirstDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TAD_SecondDate;
DROP TABLE  IF EXISTS ubt_tmp_V2_TB_RTMS_RTShopCloud;
DROP TABLE  IF EXISTS ubt_tmp_rtshop_config;
end;

$$;


ALTER FUNCTION public.sp_ubt_getrtshopcloud_testgateadmission(inbusinessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1197 (class 1255 OID 24796)
-- Name: sp_ubt_getsalescommreport(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getsalescommreport(in_generateddate date) RETURNS TABLE(chainhead character varying, locationid character varying, locationname character varying, productname character varying, invoicedate text, salescomamount numeric, gstcomamount numeric, adjsalescom numeric, adjgstcom numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare
	
rec_dates 			record;
vNonHostFromDate 	timestamp;
vNonHostToDate 		timestamp;


c_get_dates cursor for
select startdate , enddate 
	from public.ztubt_invoiceperiod zi where 1=1
	and extract(year from startdate) = extract(year from in_GeneratedDate-1) 
	and extract(month from enddate) = extract(month from in_GeneratedDate-1) ;

begin
	
	create temporary table if not exists ubt_temp_salescomm(
 				 locDisplayID varchar(100)
				,locName varchar(100)
				,locid int4
				,chid int4
 				,prodname varchar(50)
 				,comm_amount numeric
 				,gst_amount numeric
 				,InvoiceDate text); 
	
 	create temporary table if not exists ubt_temp_nonhost(
 				nonHostFromDate timestamp,
 				nonHostToDate timestamp,
 				nonHostFromDateUTC timestamp,
 				nonHostToDateUTC timestamp);
 			
 	create temporary table if not exists ubt_temp_adjustment(
 				locid int4,
 				comm_adj_amt numeric,
 				gst_adj_amt numeric);
 			
	open c_get_dates;
	loop
		fetch c_get_dates into rec_dates;
		exit when not found;
	
--		raise notice 'Start:%',rec_dates.StartDate;
--		raise notice 'End:%',rec_dates.EndDate;
		
		insert into ubt_temp_salescomm
		select zl.locDisplayId,zl.locName,zl.locid,zl.chid
		, tran.prodname
		, sum(case when tran.flag = 'SAL' then abs(tran.amount) else 0 end ) comm_amt
		, sum(case when tran.flag = 'GST' then abs(tran.amount) else 0 end ) gst_amt
		, cast(rec_dates.StartDate as text) || ' - ' || cast(rec_dates.EndDate as text) as InvoiceDate
		from 
		public.ztubt_location zl inner join
		public.ztubt_terminal zt on (zl.locid = zt.locid) left outer join
	--  07-Apr-2022: Hira - removed sp_ubt_gettransamountdetails with subset sp_ubt_gtad_salescomm
	--	public.sp_ubt_gettransamountdetails(rec_dates.StartDate,rec_dates.EndDate) tran
		public.sp_ubt_gtad_salescomm(rec_dates.StartDate,rec_dates.EndDate) tran
		on (zt.terdisplayid = tran.terdisplayid and tran.flag in ('SAL','GST'))
		where zl.locTypeID in (2,4)
		group by zl.locDisplayId,zl.locName,zl.locid,zl.chid, tran.prodname
		;
		
		insert into ubt_temp_nonhost
		select fromdatetimenonhost,todatetimenonhost,utcfromdatetimenonhost,utctodatetimenonhost
		from public.sp_ubt_getcommonubtdates(rec_dates.StartDate,rec_dates.EndDate);
	
	end loop;
	close c_get_dates;

--	return query
--	select * from ubt_temp_salescomm;

	vNonHostFromDate = (select min(nonHostFromDate) from ubt_temp_nonhost);
	vNonHostToDate = (select max(nonHostToDate) from ubt_temp_nonhost);
	
--	raise notice 'vNonHostFromDate:%',vNonHostFromDate;
--	raise notice 'vNonHostToDate:%',vNonHostToDate;
	
	insert into ubt_temp_adjustment
		select adj.locid 
		, sum(case when lkp.fld2value = 'CCOM' then adj.adjustmentamount/100 else 0 end) 
		- sum(case when lkp.fld2value = 'DCOM' then adj.adjustmentamount/100 else 0 end) COM_ADJ_AMT
		, sum(case when lkp.fld2value = 'CGST' then adj.adjustmentamount/100 else 0 end) 
		- sum(case when lkp.fld2value = 'DGST' then adj.adjustmentamount/100 else 0 end) COM_GST_AMT
		from public.ztubt_adjustinvoice adj 
		inner join ztubt_location zl on adj.locid =zl.locid 
		inner join public.ztubt_lookupvalueconfig lkp 
		on (cast(adj.adjustmentcode as varchar)= lkp.fld1value
			and lkp.configname = 'RTMS_AdjustmentCode' 
			and lkp.fld2value in ('CCOM','DCOM','CGST','DGST'))
		where 1=1
		and adj.approvalstatus =1
		and zl.loctypeid in (2,4)
		and adj.createddatetime >= vNonHostFromDate
		and adj.createddatetime < vNonHostToDate
		group by adj.locid;
	
	return query
	select 
	zc.chname as ChainHead,
	uts.locDisplayId as LocationID,
	uts.LocName as LocationName,
	case 
		when uts.prodname in ('4D Lottery','TOTO','SINGAPORE SWEEP') then cast('1Lottery' as varchar)
		when uts.prodname in ('SPORTS') then cast('2Sports' as varchar)
		when uts.prodname in ('HORSE RACING') then cast('3Horse Racing' as varchar)
	end as ProductName,
	uts.InvoiceDate as InvoiceDate,
	sum(uts.comm_amount) as SalesComAmount,
	sum(uts.gst_amount) as GstComAmount,
--	sum(coalesce(uta.comm_adj_amt,0)) as AdjSalesCom,
--	sum(coalesce(uta.gst_adj_amt,0)) as AdjGstCom
	0 as AdjSalesCom,
	0 as AdjGstCom
	from ubt_temp_salescomm uts
	left outer join public.ztubt_chain zc on (uts.chid =zc.chid)
--	left outer join ubt_temp_adjustment uta on (uts.locid = uta.locid)
	where 1=1
	group by zc.chname,uts.locDisplayId,uts.LocName,uts.InvoiceDate
	,case 
		when uts.prodname in ('4D Lottery','TOTO','SINGAPORE SWEEP') then cast('1Lottery' as varchar)
		when uts.prodname in ('SPORTS') then cast('2Sports' as varchar)
		when uts.prodname in ('HORSE RACING') then cast('3Horse Racing' as varchar)
	end
	union all 
	select 	ChainHead, LocationID, LocationName,ProductName,InvoiceDate
	, sum(SalesComAmount) SalesComAmount, sum(GstComAmount) GstComAmount
	, sum(coalesce(uta.comm_adj_amt,0)) as AdjSalesCom
	, sum(coalesce(uta.gst_adj_amt,0)) as AdjGstCom
	from 
	(select 
		zc.chname as ChainHead, uts.locid as locid,
		uts.locDisplayId as LocationID,
		uts.LocName as LocationName,
		cast('4Total' as varchar) ProductName,
		uts.InvoiceDate as InvoiceDate,
		sum(uts.comm_amount) as SalesComAmount,
		sum(uts.gst_amount) as GstComAmount
		from ubt_temp_salescomm uts
		left outer join public.ztubt_chain zc on (uts.chid =zc.chid)
		where 1=1
		group by zc.chname,uts.locDisplayId,uts.LocName,uts.InvoiceDate, uts.locid)sub
	left outer join ubt_temp_adjustment uta on (sub.locid = uta.locid)
	group by ChainHead, LocationID, LocationName,ProductName,InvoiceDate
	;
	
	drop table ubt_temp_salescomm;
	drop table ubt_temp_nonhost;
	drop table ubt_temp_adjustment;

end;

$$;


ALTER FUNCTION public.sp_ubt_getsalescommreport(in_generateddate date) OWNER TO consultant01;

--
-- TOC entry 1100 (class 1255 OID 24799)
-- Name: sp_ubt_getsalescommreport_bkp(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getsalescommreport_bkp(in_generateddate date) RETURNS TABLE(chainhead character varying, locationid character varying, locationname character varying, productname character varying, invoicedate text, salescomamount numeric, gstcomamount numeric, adjsalescom numeric, adjgstcom numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare
	
rec_dates 			record;
vNonHostFromDate 	timestamp;
vNonHostToDate 		timestamp;


c_get_dates cursor for
select startdate , enddate 
	from public.ztubt_invoiceperiod zi where 1=1
	and extract(year from startdate) = extract(year from in_GeneratedDate-1) 
	and extract(month from enddate) = extract(month from in_GeneratedDate-1) ;

begin
	
	create temporary table if not exists ubt_temp_salescomm(
 				 locDisplayID varchar(100)
				,locName varchar(100)
				,locid int4
				,chid int4
 				,prodname varchar(50)
 				,comm_amount numeric
 				,gst_amount numeric
 				,InvoiceDate text); 
	
 	create temporary table if not exists ubt_temp_nonhost(
 				nonHostFromDate timestamp,
 				nonHostToDate timestamp,
 				nonHostFromDateUTC timestamp,
 				nonHostToDateUTC timestamp);
 			
 	create temporary table if not exists ubt_temp_adjustment(
 				locid int4,
 				comm_adj_amt numeric,
 				gst_adj_amt numeric);
 			
	open c_get_dates;
	loop
		fetch c_get_dates into rec_dates;
		exit when not found;
	
--		raise notice 'Start:%',rec_dates.StartDate;
--		raise notice 'End:%',rec_dates.EndDate;
		
		insert into ubt_temp_salescomm
		select zl.locDisplayId,zl.locName,zl.locid,zl.chid
		, tran.prodname
		, sum(case when tran.flag = 'SAL' then abs(tran.amount) else 0 end ) comm_amt
		, sum(case when tran.flag = 'GST' then abs(tran.amount) else 0 end ) gst_amt
		, cast(rec_dates.StartDate as text) || ' - ' || cast(rec_dates.EndDate as text) as InvoiceDate
		from 
		public.ztubt_location zl inner join
		public.ztubt_terminal zt on (zl.locid = zt.locid) left outer join
		public.sp_ubt_gtad_salescomm(rec_dates.StartDate,rec_dates.EndDate) tran
		on (zt.terdisplayid = tran.terdisplayid and tran.flag in ('SAL','GST'))
		where zl.locTypeID in (2,4)
		group by zl.locDisplayId,zl.locName,zl.locid,zl.chid, tran.prodname
		;
		
		insert into ubt_temp_nonhost
		select fromdatetimenonhost,todatetimenonhost,utcfromdatetimenonhost,utctodatetimenonhost
		from public.sp_ubt_getcommonubtdates(rec_dates.StartDate,rec_dates.EndDate);
	
	end loop;
	close c_get_dates;

--	return query
--	select * from ubt_temp_salescomm;

	vNonHostFromDate = (select min(nonHostFromDate) from ubt_temp_nonhost);
	vNonHostToDate = (select max(nonHostToDate) from ubt_temp_nonhost);
	
--	raise notice 'vNonHostFromDate:%',vNonHostFromDate;
--	raise notice 'vNonHostToDate:%',vNonHostToDate;
	
	insert into ubt_temp_adjustment
		select adj.locid 
		, sum(case when lkp.fld2value = 'CCOM' then adj.adjustmentamount/100 else 0 end) 
		- sum(case when lkp.fld2value = 'DCOM' then adj.adjustmentamount/100 else 0 end) COM_ADJ_AMT
		, sum(case when lkp.fld2value = 'CGST' then adj.adjustmentamount/100 else 0 end) 
		- sum(case when lkp.fld2value = 'DGST' then adj.adjustmentamount/100 else 0 end) COM_GST_AMT
		from public.ztubt_adjustinvoice adj 
		inner join public.ztubt_lookupvalueconfig lkp 
		on (cast(adj.adjustmentcode as varchar)= lkp.fld1value
			and lkp.configname = 'RTMS_AdjustmentCode' 
			and lkp.fld2value in ('CCOM','DCOM','CGST','DGST'))
		where 1=1
		and adj.createddatetime >= vNonHostFromDate
		and adj.createddatetime < vNonHostToDate
		group by adj.locid;
	
	return query
	select 
	zc.chname as ChainHead,
	uts.locDisplayId as LocationID,
	uts.LocName as LocationName,
	case 
		when uts.prodname in ('4D Lottery','TOTO','SINGAPORE SWEEP') then cast('1Lottery' as varchar)
		when uts.prodname in ('SPORTS') then cast('2Sports' as varchar)
		when uts.prodname in ('HORSE RACING') then cast('3Horse Racing' as varchar)
	end as ProductName,
	uts.InvoiceDate as InvoiceDate,
	sum(uts.comm_amount) as SalesComAmount,
	sum(uts.gst_amount) as GstComAmount,
--	sum(coalesce(uta.comm_adj_amt,0)) as AdjSalesCom,
--	sum(coalesce(uta.gst_adj_amt,0)) as AdjGstCom
	0 as AdjSalesCom,
	0 as AdjGstCom
	from ubt_temp_salescomm uts
	left outer join public.ztubt_chain zc on (uts.chid =zc.chid)
--	left outer join ubt_temp_adjustment uta on (uts.locid = uta.locid)
	where 1=1
	group by zc.chname,uts.locDisplayId,uts.LocName,uts.InvoiceDate
	,case 
		when uts.prodname in ('4D Lottery','TOTO','SINGAPORE SWEEP') then cast('1Lottery' as varchar)
		when uts.prodname in ('SPORTS') then cast('2Sports' as varchar)
		when uts.prodname in ('HORSE RACING') then cast('3Horse Racing' as varchar)
	end
	union all 
	select 	ChainHead, ChainHead, LocationName,ProductName,InvoiceDate
	, sum(SalesComAmount) SalesComAmount, sum(GstComAmount) GstComAmount
	, sum(coalesce(uta.comm_adj_amt,0)) as AdjSalesCom
	, sum(coalesce(uta.gst_adj_amt,0)) as AdjGstCom
	from 
	(select 
		zc.chname as ChainHead, uts.locid as locid,
		uts.locDisplayId as LocationID,
		uts.LocName as LocationName,
		cast('4Total' as varchar) ProductName,
		uts.InvoiceDate as InvoiceDate,
		sum(uts.comm_amount) as SalesComAmount,
		sum(uts.gst_amount) as GstComAmount
		from ubt_temp_salescomm uts
		left outer join public.ztubt_chain zc on (uts.chid =zc.chid)
		where 1=1
		group by zc.chname,uts.locDisplayId,uts.LocName,uts.InvoiceDate, uts.locid)sub
	left outer join ubt_temp_adjustment uta on (sub.locid = uta.locid)
	group by ChainHead, ChainHead, LocationName,ProductName,InvoiceDate
	;
	
	drop table ubt_temp_salescomm;
	drop table ubt_temp_nonhost;
	drop table ubt_temp_adjustment;

end;

$$;


ALTER FUNCTION public.sp_ubt_getsalescommreport_bkp(in_generateddate date) OWNER TO consultant01;

--
-- TOC entry 1101 (class 1255 OID 24802)
-- Name: sp_ubt_getsweepsalespersrterminal(date, date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getsweepsalespersrterminal(in_fromdate date, in_todate date) RETURNS TABLE(terdisplayid character varying, prodid integer, prodname character varying, actualdate date, totalcount numeric, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;

begin

	select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt
	into vFromDateTimeIGT, vToDateTimeIGT, vUTCFromDateTimeIGT, vUTCToDateTimeIGT
	from public.sp_ubt_getcommonubtdates(in_fromdate,in_todate);



	create temp table ubt_temp_businessDateFunction as
	select * from ztubt_getbusinessdate_perhost zgp 
	where cast(previousperioddatetime as date) 
		between cast(vFromDateTimeIGT as date) and cast(vToDateTimeIGT as date)
	and host =1;


	CREATE temp TABLE ubt_temp_ResultSalesComWithDate 
	(
		TicketSerialNumber varchar(200),
		TerDisplayID varchar(100),
		ProdID int,
		Dt DATE,
		SalesCommAmount DECIMAL(32, 12),
		SalesFactorAmount DECIMAL(32, 12),
		SecondSalesCommAmount DECIMAL(32, 12),
		SecondSalesFactorAmount DECIMAL(32, 12)
	);
	
	INSERT INTO   ubt_temp_ResultSalesComWithDate(TicketSerialNumber, TerDisplayID, ProdID, Dt, SalesCommAmount, SalesFactorAmount, SecondSalesCommAmount, SecondSalesFactorAmount)
	SELECT        PBTH.TicketSerialNumber, ter.TerDisplayID, PBTH.ProdID, GB.ActualDate, SUM(coalesce(PBTLN.SalesCommAmount,0)) SalesCommAmount, SUM(coalesce(PBTLN.SalesFactorAmount,0)) SalesFactorAmount, 0, 0
	FROM          public.ztubt_placedbettransactionheader PBTH 
				  INNER JOIN (SELECT  T.TerDisplayID, T.LocID, Loc.SweepIndicator
							FROM public.ztubt_location LOC 
							INNER JOIN public.ztubt_terminal T ON LOC.LocID = T.LocID
							WHERE (LOC.SweepIndicator IS NOT NULL OR LOC.SweepIndicator <> 0)) ter ON ter.TerDisplayID = PBTH.TerDisplayID
				  INNER JOIN public.ztubt_sweep_placedbettransactionlineitem PBTL ON PBTH.TranHeaderID = PBTL.TranHeaderID 
				  INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber PBTLN ON PBTL.TranLineItemID = PBTLN.TranLineItemID  AND PBTLN.IsSoldOut = false AND PBTH.TranHeaderID = PBTL.TranHeaderID 
				  INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate PBLC ON PBLC.TranHeaderID = PBTH.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
--				  LEFT JOIN ubt_temp_businessDateFunction GB ON DATEADD(HOUR,8,PBTH.CreatedDate) BETWEEN GB.PreviousPeriodDateTime AND GB.PeriodDateTime
				  LEFT JOIN ubt_temp_businessDateFunction GB ON PBTH.CreatedDate BETWEEN gb.previousperioddatetimeutc and gb.perioddatetimeutc
	WHERE 1=1
	and PBTH.CreatedDate BETWEEN vUTCFromDateTimeIGT AND vUTCToDateTimeIGT
	GROUP BY PBTH.TicketSerialNumber, ter.TerDisplayID, PBTH.ProdID, GB.ActualDate;



	CREATE temp TABLE ubt_temp_CancelledSalesComWithDate 
	(
		TicketSerialNumber varchar(200),
		TerDisplayID varchar(100),
		ProdID int,
		Dt DATE,
		SalesCommAmount DECIMAL(32, 12),
		SalesFactorAmount DECIMAL(32, 12),
		SecondSalesCommAmount DECIMAL(32, 12),
		SecondSalesFactorAmount DECIMAL(32, 12)
	);

	---------------------------------------------------------
	--Cancellation including cross day
	---------------------------------------------------------
	INSERT INTO   ubt_temp_CancelledSalesComWithDate(TicketSerialNumber, TerDisplayID, ProdID, Dt, SalesCommAmount, SalesFactorAmount, SecondSalesCommAmount, SecondSalesFactorAmount)
	SELECT CBT.TicketSerialNumber, CBT.TerDisplayID, CBT.ProdID, GB.ActualDate, SUM(coalesce(PBTLN.SalesCommAmount,0)) SalesCommAmount, SUM(coalesce(PBTLN.SalesFactorAmount,0)) SalesFactorAmount, 0, 0
	FROM public.ztubt_cancelledbetticket CBT 
	INNER JOIN (SELECT  T.TerDisplayID, T.LocID, Loc.SweepIndicator
				FROM public.ztubt_location LOC 
				INNER JOIN public.ztubt_terminal T ON LOC.LocID = T.LocID
				WHERE (LOC.SweepIndicator IS NOT NULL OR LOC.SweepIndicator <> 0)) ter ON ter.TerDisplayID = CBT.TerDisplayID
	INNER JOIN public.ztubt_sweep_placedbettransactionlineitem PBTL ON CBT.TranHeaderID = PBTL.TranHeaderID 
	INNER JOIN public.ztubt_sweep_placedbettransactionlineitemNumber PBTLN ON PBTL.TranLineItemID = PBTLN.TranLineItemID  AND PBTLN.IsSoldOut = false AND CBT.TranHeaderID = PBTL.TranHeaderID 
	INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC  ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
	LEFT JOIN ubt_temp_businessDateFunction GB ON CBT.CancelledDate BETWEEN GB.PreviousPeriodDateTime AND GB.PeriodDateTime
	WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
	AND PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 days'
	AND PBTLN.CreatedDate < vUTCToDateTimeIGT
	GROUP BY CBT.TicketSerialNumber, CBT.TerDisplayID, CBT.ProdID, GB.ActualDate;


	
	return query
	SELECT PB.TerDisplayID
		 , PB.ProdID::int
		 , PR.ProdName
		 , PB.ActualDate
		 , SUM(coalesce(PB.TotalCount,0))as TotalCount
		 , ROUND(trunc(SUM(coalesce(PB.Amount,0)) / 100, 2),2) as Amount --(1) Convert from cents to dollar then truncate the sales amount with 2 dp
	FROM (SELECT  GATR.TerDisplayID AS TerDisplayID, GATR.ProdID AS ProdID, GATR.Dt as ActualDate,COUNT(DISTINCT GATR.TicketSerialNumber) AS TotalCount, SUM(coalesce(GATR.Sales,0)) as Amount
			FROM
			(
				SELECT RSC.TerDisplayID, RSC.ProdID, RSC.Dt, RSC.TicketSerialNumber, (coalesce(SUM(RSC.SalesFactorAmount),0)+ coalesce(SUM(RSC.SecondSalesFactorAmount),0)) AS Sales
				FROM ubt_temp_ResultSalesComWithDate RSC
				GROUP BY RSC.TerDisplayID, RSC.ProdID, RSC.Dt, RSC.TicketSerialNumber
			) GATR
			GROUP BY GATR.TerDisplayID, GATR.ProdID, GATR.Dt
			union all 
			SELECT  GATC.TerDisplayID AS TerDisplayID, GATC.ProdID AS ProdID, GATC.Dt as ActualDate,	(0-COUNT(DISTINCT GATC.TicketSerialNumber)) AS TotalCount, (0-SUM(coalesce(GATC.Sales,0))) as Amount
			FROM
			(
				SELECT CSC.TerDisplayID, CSC.ProdID, CSC.Dt, CSC.TicketSerialNumber,  (coalesce(SUM(CSC.SalesFactorAmount),0)+ coalesce(SUM(CSC.SecondSalesFactorAmount),0)) AS Sales
				FROM ubt_temp_CancelledSalesComWithDate CSC
				GROUP BY CSC.TerDisplayID, CSC.ProdID, CSC.Dt, CSC.TicketSerialNumber
			) GATC
			GROUP BY GATC.TerDisplayID, GATC.ProdID, GATC.Dt
			) PB
	LEFT JOIN public.ztubt_product PR ON PB.ProdID = PR.ProdID                                                                                                                                                                                                                               
	GROUP BY PB.TerDisplayID, PB.ProdID, PR.ProdName, PB.ActualDate;
	
	
	drop table ubt_temp_businessDateFunction;
	drop table ubt_temp_ResultSalesComWithDate;
	drop table ubt_temp_CancelledSalesComWithDate;

end;
$$;


ALTER FUNCTION public.sp_ubt_getsweepsalespersrterminal(in_fromdate date, in_todate date) OWNER TO consultant01;

--
-- TOC entry 1129 (class 1255 OID 2160658)
-- Name: sp_ubt_getsweepsalespersrterminal_testmt18(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getsweepsalespersrterminal_testmt18(in_fromdate date, in_todate date) RETURNS TABLE(terdisplayid character varying, prodid integer, prodname character varying, actualdate date, totalcount numeric, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;

begin

	select fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt
	into vFromDateTimeIGT, vToDateTimeIGT, vUTCFromDateTimeIGT, vUTCToDateTimeIGT
	from public.sp_ubt_getcommonubtdates(in_fromdate,in_todate);



	create temp table ubt_temp_businessDateFunction as
	select * from ztubt_getbusinessdate_perhost zgp 
	where cast(previousperioddatetime as date) 
		between cast(vFromDateTimeIGT as date) and cast(vToDateTimeIGT as date)
	and host =1;


	CREATE temp TABLE ubt_temp_ResultSalesComWithDate 
	(
		TicketSerialNumber varchar(200),
		TerDisplayID varchar(100),
		ProdID int,
		Dt DATE,
		SalesCommAmount DECIMAL(32, 12),
		SalesFactorAmount DECIMAL(32, 12),
		SecondSalesCommAmount DECIMAL(32, 12),
		SecondSalesFactorAmount DECIMAL(32, 12)
	);
	
	INSERT INTO   ubt_temp_ResultSalesComWithDate(TicketSerialNumber, TerDisplayID, ProdID, Dt, SalesCommAmount, SalesFactorAmount, SecondSalesCommAmount, SecondSalesFactorAmount)
	SELECT        PBTH.TicketSerialNumber, ter.TerDisplayID, PBTH.ProdID, GB.ActualDate, SUM(coalesce(PBTLN.SalesCommAmount,0)) SalesCommAmount, SUM(coalesce(PBTLN.SalesFactorAmount,0)) SalesFactorAmount, 0, 0
	FROM          public.ztubt_placedbettransactionheader PBTH 
				  INNER JOIN (SELECT  T.TerDisplayID, T.LocID, Loc.SweepIndicator
							FROM public.ztubt_location LOC 
							INNER JOIN public.ztubt_terminal T ON LOC.LocID = T.LocID
							WHERE (LOC.SweepIndicator IS NOT NULL OR LOC.SweepIndicator <> 0)) ter ON ter.TerDisplayID = PBTH.TerDisplayID
				  INNER JOIN public.ztubt_sweep_placedbettransactionlineitem PBTL ON PBTH.TranHeaderID = PBTL.TranHeaderID 
				  INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber PBTLN ON PBTL.TranLineItemID = PBTLN.TranLineItemID  AND PBTLN.IsSoldOut = false AND PBTH.TranHeaderID = PBTL.TranHeaderID 
				  INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate PBLC ON PBLC.TranHeaderID = PBTH.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'
--				  LEFT JOIN ubt_temp_businessDateFunction GB ON DATEADD(HOUR,8,PBTH.CreatedDate) BETWEEN GB.PreviousPeriodDateTime AND GB.PeriodDateTime
				  LEFT JOIN ubt_temp_businessDateFunction GB ON PBTH.CreatedDate BETWEEN gb.previousperioddatetimeutc and gb.perioddatetimeutc
	WHERE 1=1
	and PBTH.CreatedDate BETWEEN vUTCFromDateTimeIGT AND vUTCToDateTimeIGT
	GROUP BY PBTH.TicketSerialNumber, ter.TerDisplayID, PBTH.ProdID, GB.ActualDate;



	CREATE temp TABLE ubt_temp_CancelledSalesComWithDate 
	(
		TicketSerialNumber varchar(200),
		TerDisplayID varchar(100),
		ProdID int,
		Dt DATE,
		SalesCommAmount DECIMAL(32, 12),
		SalesFactorAmount DECIMAL(32, 12),
		SecondSalesCommAmount DECIMAL(32, 12),
		SecondSalesFactorAmount DECIMAL(32, 12)
	);

	---------------------------------------------------------
	--Cancellation including cross day
	---------------------------------------------------------
	INSERT INTO   ubt_temp_CancelledSalesComWithDate(TicketSerialNumber, TerDisplayID, ProdID, Dt, SalesCommAmount, SalesFactorAmount, SecondSalesCommAmount, SecondSalesFactorAmount)
	SELECT CBT.TicketSerialNumber, CBT.TerDisplayID, CBT.ProdID, GB.ActualDate, SUM(coalesce(PBTLN.SalesCommAmount,0)) SalesCommAmount, SUM(coalesce(PBTLN.SalesFactorAmount,0)) SalesFactorAmount, 0, 0
	FROM public.ztubt_cancelledbetticket CBT 
	INNER JOIN (SELECT  T.TerDisplayID, T.LocID, Loc.SweepIndicator
				FROM public.ztubt_location LOC 
				INNER JOIN public.ztubt_terminal T ON LOC.LocID = T.LocID
				WHERE (LOC.SweepIndicator IS NOT NULL OR LOC.SweepIndicator <> 0)) ter ON ter.TerDisplayID = CBT.TerDisplayID
	INNER JOIN public.ztubt_sweep_placedbettransactionlineitem PBTL ON CBT.TranHeaderID = PBTL.TranHeaderID 
	INNER JOIN public.ztubt_sweep_placedbettransactionlineitemNumber PBTLN ON PBTL.TranLineItemID = PBTLN.TranLineItemID  AND PBTLN.IsSoldOut = false AND CBT.TranHeaderID = PBTL.TranHeaderID 
	INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC  ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
	LEFT JOIN ubt_temp_businessDateFunction GB ON CBT.CancelledDate BETWEEN GB.PreviousPeriodDateTime AND GB.PeriodDateTime
	WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
	AND PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 days'
	AND PBTLN.CreatedDate < vUTCToDateTimeIGT
	GROUP BY CBT.TicketSerialNumber, CBT.TerDisplayID, CBT.ProdID, GB.ActualDate;


	
	return query
	SELECT PB.TerDisplayID
		 , PB.ProdID::int
		 , PR.ProdName
		 , PB.ActualDate
		 , SUM(coalesce(PB.TotalCount,0))as TotalCount
		 , ROUND(trunc(SUM(coalesce(PB.Amount,0)) / 100, 2),2) as Amount --(1) Convert from cents to dollar then truncate the sales amount with 2 dp
	FROM (SELECT  GATR.TerDisplayID AS TerDisplayID, GATR.ProdID AS ProdID, GATR.Dt as ActualDate,COUNT(DISTINCT GATR.TicketSerialNumber) AS TotalCount, SUM(coalesce(GATR.Sales,0)) as Amount
			FROM
			(
				SELECT RSC.TerDisplayID, RSC.ProdID, RSC.Dt, RSC.TicketSerialNumber, (coalesce(SUM(RSC.SalesFactorAmount),0)+ coalesce(SUM(RSC.SecondSalesFactorAmount),0)) AS Sales
				FROM ubt_temp_ResultSalesComWithDate RSC
				GROUP BY RSC.TerDisplayID, RSC.ProdID, RSC.Dt, RSC.TicketSerialNumber
			) GATR
			GROUP BY GATR.TerDisplayID, GATR.ProdID, GATR.Dt
			union all 
			SELECT  GATC.TerDisplayID AS TerDisplayID, GATC.ProdID AS ProdID, GATC.Dt as ActualDate,	(0-COUNT(DISTINCT GATC.TicketSerialNumber)) AS TotalCount, (0-SUM(coalesce(GATC.Sales,0))) as Amount
			FROM
			(
				SELECT CSC.TerDisplayID, CSC.ProdID, CSC.Dt, CSC.TicketSerialNumber,  (coalesce(SUM(CSC.SalesFactorAmount),0)+ coalesce(SUM(CSC.SecondSalesFactorAmount),0)) AS Sales
				FROM ubt_temp_CancelledSalesComWithDate CSC
				GROUP BY CSC.TerDisplayID, CSC.ProdID, CSC.Dt, CSC.TicketSerialNumber
			) GATC
			GROUP BY GATC.TerDisplayID, GATC.ProdID, GATC.Dt
			) PB
	LEFT JOIN public.ztubt_product PR ON PB.ProdID = PR.ProdID                                                                                                                                                                                                                               
	GROUP BY PB.TerDisplayID, PB.ProdID, PR.ProdName, PB.ActualDate;
	
	
	--drop table ubt_temp_businessDateFunction;
	--drop table ubt_temp_ResultSalesComWithDate;
	--drop table ubt_temp_CancelledSalesComWithDate;

end;
$$;


ALTER FUNCTION public.sp_ubt_getsweepsalespersrterminal_testmt18(in_fromdate date, in_todate date) OWNER TO sp_postgres;

--
-- TOC entry 1221 (class 1255 OID 2387081)
-- Name: sp_ubt_getterminalinvoice(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getterminalinvoice(businessdate date) RETURNS TABLE(terdisplayid character varying, transactiondate date, prodid integer, locdisplayid character varying, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
vbusinessdate date;
vinputdate date;
vstartperiod date;
vendperiod date;
vfromdateIGT timestamp;--@BusinessDateFrom
vtodateIGT timestamp;--@BusinessDateTo
vfromdatetimeIGT_UTC timestamp;
vtodatetimeIGT_UTC timestamp;
vfromdatetimeOB_UTC timestamp;
vtodatetimeOB_UTC timestamp;
vfromdatetimeNonHost_UTC timestamp;
vtodatetimeNonHost_UTC timestamp;
vfromdatetimeBMCS_UTC timestamp;
vtodatetimeBMCS_UTC timestamp;
vGSTRate numeric; --percentage

vactualdate date;
/*DECLARE @BusinessDateFromDATETIME;
DECLARE @BusinessDateToDATETIME;
DECLARE @l_PeriodFromDateNonHostUTCDATETIME
DECLARE @l_PeriodToDateNonHostUTCDATETIME
DECLARE @InsertedDateDATETIME;
DECLARE @l_PeriodFromDateIGTUTC DATETIME
DECLARE @l_PeriodToDateIGTUTC DATETIME
DECLARE @l_PeriodFromDateOBUTC DATETIME --(15)
DECLARE @l_PeriodToDateOBUTC DATETIME --(15)

*/

v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

BEGIN

select businessdate into vbusinessdate;

-- GST Config
SELECT COALESCE(gstrate , 0)/100 INTO vGSTRate
FROM ztubt_gstconfig zg
WHERE businessdate BETWEEN zg.effectivefrom AND COALESCE(zg.enddate , 'infinity'::date)
ORDER BY zg.effectivefrom
LIMIT 1;
	
create temp table if not exists ubt_temp_TmpTerLocPrdSalesAmt
	( 
	terdisplayid varchar(200),
	transactiondate timestamp,
	prodid int4,
	locdisplayid varchar(200),
	sales_type varchar(100),
	totalcount int4,
	amount numeric(32, 11),
	sub_prod varchar(100)
	);


create temp table ubt_temp_terminal as 
	Select Ter.TerDisplayID, Ter.LocID  FROM public.ztubt_Terminal Ter;

create temp table ubt_temp_product as 
	Select PD.ProdID,
	case PD.prodid when 5 then 'SPORTS' else trim(PD.ProdName) end as ProdName  FROM public.ztubt_Product PD
	WHERE PD.ProdID != 6 ;--(15) remove Sports Live so that all Sports refer to ProductID = 5 only

insert into ubt_temp_product (prodid, prodname) values (3, 'TOTO MATCH');


create temp table ubt_temp_Location as
	Select Loc.LocID, Loc.LocDisplayID, Loc.SweepIndicator,Loc.LocTypeID,Loc.IsGST,Loc.AccountNumber,
	Loc.BranchID,Loc.Bankid,Loc.LocName,Loc.IsIBG,Loc.RetID,LOC.CHID
	from public.ztubt_location  Loc;

--GetcommondatesfroUBT

	select 
	fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,utcfromdatetimeob,utctodatetimeob,
	utcfromdatetimenonhost,utctodatetimenonhost, utcfromdatetimebmcs, utctodatetimebmcs
	into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeNonHost_UTC ,
	vtodatetimeNonHost_UTC,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
	from public.sp_ubt_getcommonubtdates(vbusinessdate,vbusinessdate);


create temp table if not exists ubt_temp_TmpTicketByWageAndSales 
	(
	ticketserialnumber varchar(500),
	wager numeric(22,2), 
	secondwager numeric(22,2), 
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2), 
	winningamount numeric(22,2) 
	);

-- from function getamounttransaction

INSERT INTO ubt_temp_TmpTicketByWageAndSales
 select * from  public.sp_ubt_getamounttransaction(vbusinessdate,vbusinessdate);




create temp table if not exists ubt_temp_ResultCashlessInTerminal 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(22, 11),
	ct int4
	);

insert into ubt_temp_ResultCashlessInTerminal

	select  pd.terdisplayid, 'NETS', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NC','NN') 
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC 
	group by pd.terdisplayid
	
	union all 
	select pd.terdisplayid, 'CASHCARD', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NCC') --cashcard
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	
	union all
	
	select pd.terdisplayid, 'Flashpay', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NFP') --Flashpay
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	;

create temp table if not exists ubt_temp_iTOTO
	(
	ticketserialnumber varchar(200),
	itotoindicator bool,
	groupunitsequence int4,
	bettype int4
	)
;
INSERT INTO ubt_temp_iTOTO
	select distinct ticketserialnumber, itotoindicator, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where ((groupunitsequence = 1) --group toto
	or (itotoindicator = true)) --itoto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
;


create temp table if not exists ubt_temp_GroupTOTO
	(
	ticketserialnumber varchar(200),
	grouphostid varchar(50),
	groupunitsequence int4,
	bettype int4
	);

insert into ubt_temp_grouptoto
	select distinct ticketserialnumber, grouphostid, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where groupunitsequence is not null --group toto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC  )
;

create temp table ubt_temp_CancelledBetTicketState as 
	select cb.cartid,cb.terdisplayid,cb.ticketserialnumber,cb.tranheaderid,cb.cancelleddate ,cb.cancelledamout,cb.prodid 
	from  public.ztubt_cancelledbetticket  cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
   on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateIGT and vtodateIGT
;


create temp table if not exists ubt_temp_SalesGroupToto
(
	terdisplayid varchar(200),
	prodid int4,
	locdisplayid varchar(200),
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --Sales of each product (Wager * Sales Factor)
);

insert into ubt_temp_SalesGroupToto(terdisplayid, prodid, locdisplayid,bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid, 
	3 as prodid, 
	loc.locdisplayid as locdisplayid,
	fin.bettype as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal,  
	count(distinct can.ticketserialnumber)	as canceltotal,
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
		
		left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)can on pbth.ticketserialnumber = can.ticketserialnumber
		
	where  
	pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by  ter.terdisplayid,loc.locdisplayid, fin.bettype
	;

create temp table if not exists ubt_temp_salestoto 
	(
	terdisplayid varchar(200),
	locdisplayid varchar(200),
	prodid int4,
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);

insert into ubt_temp_salestoto(terdisplayid, locdisplayid,prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid		as terdisplayid,	
	loc.locdisplayid			as locdisplayid,
	3		as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1)		as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	public.ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)can on pbth.ticketserialnumber = can.ticketserialnumber

	where pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by ter.terdisplayid,loc.locdisplayid
	;

--FILL IN TRANS AMOUNT DETAIL DATA
		
create temp table if not exists ubt_temp_transamountdetaildata 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(32, 13),
	ct int4,
	flag char(3),
	transtype char(2),
	fromdate date,
	todate date
	);
Insert Into ubt_temp_transamountdetaildata
	select terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
	from public.sp_ubt_gettransamountdetails(vbusinessdate,vbusinessdate);


-- insert all data

insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='COL' and transtype != 'OO' and prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all
	
	--offline orders - wager
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	case when a.productname <> 'Gate Admission' then 31
		 when a.productname = 'Gate Admission' then 99 end as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' 
	group by loc.locdisplayid,ter.terdisplayid,case when a.productname <> 'Gate Admission' then 31
		 											when a.productname = 'Gate Admission' then 99 end
	
	union ALL
	-- Gate Admission - Sales
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	99 as prodid,
	loc.locdisplayid as locdisplayid,
	'116'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	--sum(coalesce(amount,0)*(1-vGSTRate))as amount,
	sum(coalesce(amount,0)*(100 / (100 + vGSTRate * 100)))as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' and a.productname = 'Gate Admission' 
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	
	----2	AT_CANCELAMT	Yes	cancel amount
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'2'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='CAN' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	
	---3	AT_VALIDAMT	Yes	validation amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'3'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='PAY' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---4	Rebate Amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'4'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod  
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RBT' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	union all
	--61	Refund Amount--(4)(5)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RFD' AND TransType != 'OO' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	--offline orders - refund
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
		where flag='RFD' AND TransType = 'OO' 
		group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--6	AT_TAXAMT 	Yes	tax amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'6'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='GST' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---7	AT_COMMAMT	Yes	commission amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'7'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='SAL' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
		
	------16. AT_FRACVALAMT  Show fractional validation amounts [Validation amounts for GROUP TOTO - This is a subset of Sales Type  3]
	union all
	
	select	ter.terdisplayid				as terdisplayid,
	vbusinessdate transactiondate,
	3		as prodid,
	loc.locdisplayid	as locdisplayid,
	'16'		as sales_type,
	count(distinct vb.tranheaderid)	as totalcount, 
	sum(coalesce(vb.winningamount,0))	as totalamount,
	case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	from --(1)
	(
		select vb.tranheaderid,vb.winningamount,vb.cartid,vb.terdisplayid,vb.createdvalidationdate 
		from public.ztubt_validatedbetticket  vb --(16)
		inner join public.ztubt_validatedbetticketlifecyclestate  vbt
		on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
		where vb.winningamount != 0 and vb.winningamount is not null --(8)
		and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	)vb
	inner join 
	(
		select distinct tranheaderid, grouphostid, groupunitsequence, bettypeid from public.ztubt_toto_placedbettransactionlineitem
	)ph on vb.tranheaderid = ph.tranheaderid --(16)
	inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where ph.groupunitsequence is not null --(16)
	group by loc.locdisplayid,ter.terdisplayid,
	case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
		else 'TOTO MATCH' end
	
	union all 
	--52. House syndicate sales amount - [iTOTO sales  this is a subset of sales type 1]
	--TOTO
	select	s.terdisplayid			as terdisplayid,
	vbusinessdate	as transactiondate, 
	s.prodid	as prodid, 
	s.locdisplayid as locdisplayid,
	'52' as sales_type, 
	sum(coalesce(s.wagertotal,0))		as totalcount, 
	sum(coalesce(s.wageramount,0))	as totalamount,
	'TOTO' as sub_prod
	from ubt_temp_salestoto s
	group by s.terdisplayid, s.prodid, s.locdisplayid
		
	union all 
	--25. House syndicate sales amount by sales factor [iTOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO
	select	s.terdisplayid	as terdisplayid,
	vbusinessdate		as transactiondate, 
	3	as prodid,
	s.locdisplayid	as locdisplayid,
	'25'	as sales_type,
	sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))		as totalcount, 
	trunc(sum(coalesce(s.salesamount,0)) / 100 , 2) * 100	as totalamount ,
	'TOTO' as sub_prod 
	from ubt_temp_salestoto s
	group by s.locdisplayid,s.terdisplayid
	
	union all 
	--40. GST TAX rate--------------------------------------------------------------------
	
	select	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate,
	prd.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'40'		as sales_type,
	0		as totalcount ,
	gst.gstrate,
	prd.prodname as sub_prod
	from	
	(
		select loc.locdisplayid, ter.terdisplayid from ubt_temp_location loc
		inner join ubt_temp_terminal ter on loc.locid = ter.locid
		where loc.isgst = true
	)loc
	cross join 
	(
		select * from ubt_temp_product where prodid in (2,3,4) --lottery / es
	)prd
	cross join
	(
		select gstrate from public.ztubt_gstconfig a 
		where (vbusinessdate between effectivefrom and enddate) or (vbusinessdate >=effectivefrom and enddate is null) limit 1
		--check this code
	)gst
	
	union all 
--59. House syndicate cancel amount - [iTOTO cancellations  This is a Sub Set of Sales Type 2]
	--TOTO
	select	cb.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	3		as prodid, 
	loc.locdisplayid as locdisplayid,
	'59'		as sales_type, 
	count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)as totalcount, 
	sum(coalesce (cb.cancelledamout,0))as totalamount,
	'TOTO' as sub_prod
	from ubt_temp_cancelledbetticketstate cb 
	inner join ubt_temp_itoto itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true 
	inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where cb.prodid = 3 --(1)and tpbtli.itotoindicator = 1
	 and cb.cancelleddate between vfromdateIGT and vtodateIGT
	group by cb.terdisplayid,loc.locdisplayid
	
	union all 
	---60. Player syndicate sales amount by sales factor - [GROUP TOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO, totomatch
	SELECT S.TerDisplayID AS TerDisplayID ,
	 vbusinessdate	AS TransactionDate, 
	S.ProdID	AS ProdID,
	S.LocDisplayID AS LocDisplayID,
	'60' AS sales_type, 
	SUM(coalesce(S.WagerTotal,0)  - coalesce(S.CancelTotal,0))	AS TotalCount,--(8)
	trunc(SUM(coalesce(s.SalesAmount,0)) / 100 , 2) * 100	AS TotalAmount,
	case when S.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY  S.TerDisplayID,S.ProdID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end

	union all 
	
	--69. Player syndicate sales amount - [GROUP TOTO Sales  This is a subset of Sales Type 1]----------
	--TOTO, totomatch
	SELECT	S.TerDisplayID			AS TerDisplayID,
	vbusinessdate	AS TransactionDate,
	3 AS ProdID, 
	S.LocDisplayID AS LocDisplayID,
	'69' AS sales_type,
	SUM(COALESCE(S.WagerTotal,0))AS TotalCount, 
	SUM(COALESCE(S.WagerAmount,0))		AS TotalAmount,--(1)COALESCE(S.Amount,0)		AS TotalAmount
	case when S.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY S.TerDisplayID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end

	union all
	--70 [	 GROUP TOTO Cancel Amount  This is a subset of Sales Type 2]-----------------------------------
	--TOTO, totomatch
	select			cbt.terdisplayid as terdisplayid,
	vbusinessdate	as transactiondate, 
	3				as prodid,
	loc.locdisplayid	as locdisplayid,
	'70'				as sales_type, 
	count(distinct gt.grouphostid)	as totalcount, 
	sum(coalesce (cbt.cancelledamout,0))	as totalamount,
	case when gt.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	from ubt_temp_cancelledbetticketstate cbt
	inner join ubt_temp_grouptoto gt on cbt.ticketserialnumber = gt.ticketserialnumber
	inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where  cbt.prodid = 3  
	and cbt.cancelleddate between vfromdateIGT and vtodateIGT 
	group by cbt.terdisplayid,loc.locdisplayid,
		case when gt.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end
	
	union all 
	--105 Sales Commision Rate
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
    '' as sub_prod
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid in (2,4) --lottery / es
		)sal
		
	union all 
	--TOTO, totomatch
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
	sp.sub_prod 
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid = 3 
		)sal
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp
		
	union all 
	--108 AT_ON_EZLINK----------------------------------------------------------------------- 
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'108'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'NETS'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--110	AT_ON_ATM	Yes	Flashpay transaction --------------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'110'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'Flashpay'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--112	AT_ON_CASHCARD	Yes	Cashcard transaction------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'112'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'CASHCARD'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all
	---116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor-------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	a.prodid as prodid,
	loc.locdisplayid		as locdisplayid,
	'116'		as sales_type,
	sum(coalesce(a.total,0)  - coalesce(can.total,0))	as totalcount, --(8)
	trunc(sum(coalesce(a.amount,0)) / 100, 2) * 100 as totalamount,
	a.sub_prod as sub_prod
  	from 
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
			case
				when pb.prodid=6 then 5 --prematch and live to be one same prodid
				else pb.prodid	end as prodid, --(15)
			case when pb.prodid <> 3 then ''
				when pb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE pb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
					) then 'TOTO MATCH' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 
			where pb.iscancelled = false and (
					(
					pb.prodid in (2,3,4) --lottery / es
					and pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC 

					)
					or --(15)
					(
					pb.prodid in (5,6) --sports / ob
					and pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC
					)
					or 
					(
					pb.prodid in (1) --horse racing / bmcs
					and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
					)
				)
			group by a.ticketserialnumber, pb.terdisplayid, pb.prodid,
				case when pb.prodid <> 3 then ''  
					when pb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE pb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
						) then 'TOTO MATCH' 
					else 'TOTO' end
		)a
		inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join --(8)
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, cb.terdisplayid, cb.prodid,
			case when cb.prodid <> 3 then ''  
				when cb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE cb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
					) then 'TOTO MATCH' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join ubt_temp_cancelledbetticketstate cb on a.ticketserialnumber = cb.ticketserialnumber
			where cb.prodid in (2,3,4) --lottery / es
			group by a.ticketserialnumber, cb.terdisplayid, cb.prodid,
				case when cb.prodid <> 3 then ''  
					when cb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE cb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
						) then 'TOTO MATCH' 
					else 'TOTO' end
		)can 
			on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid
			and a.prodid = can.prodid and a.sub_prod = can.sub_prod
		
		group by loc.locdisplayid,ter.terdisplayid,a.prodid, a.sub_prod
	;	
/*	UPDATE T
		SET TotalCount = T.TotalCount
		FROM 
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 116
		)T
		INNER JOIN
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 7
		)FIN ON T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
	--end modify (9)*/

/*update ubt_temp_TmpTerLocPrdSalesAmt T 
set TotalCount = FIN.TotalCount
from (
		SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = '7'
		)FIN 
	where 
	T.sales_type='116' and 
	T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
*/

-- [2022-04-01] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation
create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('001811006', 4, 'TOTO','2021-11-24'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vbusinessdate, vbusinessdate);




DELETE  FROM ubt_temp_tmpterlocprdsalesamt SAL USING ubt_temp_sales_scandsr RS 
where  SAL.TerDisplayID = RS.TerDisplayID 
AND RS.ProdID = SAL.ProdID
AND SAL.Sales_type = '116';




INSERT INTO ubt_temp_tmpterlocprdsalesamt(TerDisplayId, TransactionDate, ProdID, LocDisplayID, Sales_type, TotalCount, Amount, sub_prod)
	SELECT	RS.TerDisplayID	as TerDisplayID,
			vbusinessdate			AS TransactionDate, 
			RS.ProdID			AS ProdID,
			LOC.LocDisplayID		AS LocDisplayID,
			'116'					aS sales_type,
			RS.TotalCount, 
			RS.Amount*100,
			'' as sub_prod
	FROM ubt_temp_sales_scandsr RS
	INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
	INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
	where RS.ActualDate = vbusinessdate;

-- [2022-04-01] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--119	at_salesfactor	yes	sales factor-------------------------------
create temp table if not exists ubt_temp_salesfactorconfig
	(
		prodid int4,
		salesfactor numeric(13,12)
	)
	;
insert into ubt_temp_salesfactorconfig
	select a.prodid, a.salesfactor  from  public.ztubt_salescomconfig  a 
	where commissiontype=1  and a.isdeleted = false and prodid in (2,3,4)
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, '' 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc  where sfc.prodid <> 3
		)sfc
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, sp.sub_prod 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid = 3
		)sfc
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp
;

insert into 	ubt_temp_tmpterlocprdsalesamt
		SELECT	coalesce(DB.TerDisplayID,CR.TerDisplayID)					AS TerDisplayID,
				coalesce(DB.TransactionDate,CR.TransactionDate)			AS TransactionDate, 
				0														AS ProdID,
				coalesce(DB.LocDisplayID,CR.LocDisplayID)					AS LocDisplayID,
				'727'														AS sales_type,
				0														AS TotalCount,
				SUM(coalesce(DB.Amount,0)) - SUM(coalesce(CR.Amount,0))		AS Amount,
			    '' as sub_prod
		FROM
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type in
			(
				'2', --cancel amount
				'3',	--validation amount
				'7',	--commission amount
				--(7)6, -- GST tax amount
				'108', --NETS transaction
				'110', --Flashpay transaction
				'112', --Cashcard transaction
				--(4)-1 -- refund and rebate
				'4', --rebate
				'61' --refund--(5)5 --refund
			 )
			--  AND (prodid :: int) != 31  --(15) exclude offline orders in the net amount due calculation
			AND (prodid :: int) not in (31,99)
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) CR
		FULL OUTER JOIN 
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type ='1'	--collection
			-- AND (prodid :: int)!= 31 
			AND (prodid :: int) not in (31,99)
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) DB ON DB.LocDisplayID=CR.LocDisplayID AND DB.TransactionDate=CR.TransactionDate AND DB.TerDisplayID=CR.TerDisplayID
		GROUP BY DB.TerDisplayID, DB.TransactionDate, DB.LocDisplayID,CR.TerDisplayID,CR.TransactionDate, CR.LocDisplayID					
;	

-- for both types of toto
INSERT INTO ubt_temp_tmpterlocprdsalesamt
-- sum totomatch and t649
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, sum(totalcount), sum(amount), ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TOTO MATCH', 'TOTO') and Sales_type not in ('40', '119', '105')
group by terdisplayid, transactiondate, prodid, locdisplayid, sales_type
union all

-- config - clone totomatch config for product Toto (t649 and totomatch)
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TOTO MATCH') and Sales_type in ('40', '119', '105');

	
	UPDATE ubt_temp_tmpterlocprdsalesamt td
	SET ProdID = CASE 
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO' THEN 71
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO MATCH' THEN 66
					ELSE p.SAPProdID
				END
	FROM public.ztubt_sap_product p
	WHERE td.ProdID::int = p.prodid;

return query
SELECT DISTINCT 
			coalesce(TerDisplayID, '')
			,(TransactionDate :: Date)
			,coalesce(ProdID :: int, 0)
			,coalesce(LocDisplayID, '')
			,coalesce(Sales_type, '')
			,TotalCount
			,Amount
		FROM ubt_temp_tmpterlocprdsalesamt --(12) ubt_temp_FinalTempData--(1)FROM ubt_temp_TmpTerLocPrdSalesAmt
		WHERE (TotalCount!=0 or Amount!=0)
		AND (TransactionDate :: DATE) = vbusinessdate
;
	drop table if exists ubt_temp_tmpterlocprdsalesamt;
	drop table if exists ubt_temp_tmpticketbywageandsales;
	drop table if exists ubt_temp_resultcashlessinterminal;
	drop table if exists ubt_temp_grouptoto;
	drop table if exists ubt_temp_itoto;
	drop table if exists ubt_temp_location;
	drop table if exists ubt_temp_product;
	drop table if exists ubt_temp_salesfactorconfig;
	drop table if exists ubt_temp_salesgrouptoto;
	drop table if exists ubt_temp_salestoto;
	drop table if exists ubt_temp_terminal;
	drop table if exists ubt_temp_transamountdetaildata;
	drop table if exists ubt_temp_cancelledbetticketstate;
	-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
	drop table if exists ubt_temp_sales_scandsr;
	
		
end
;
$$;


ALTER FUNCTION public.sp_ubt_getterminalinvoice(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1102 (class 1255 OID 24805)
-- Name: sp_ubt_getterminalinvoice_bk20240704(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_getterminalinvoice_bk20240704(businessdate date) RETURNS TABLE(terdisplayid character varying, transactiondate date, prodid integer, locdisplayid character varying, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
vbusinessdate date;
vinputdate date;
vstartperiod date;
vendperiod date;
vfromdateIGT timestamp;--@BusinessDateFrom
vtodateIGT timestamp;--@BusinessDateTo
vfromdatetimeIGT_UTC timestamp;
vtodatetimeIGT_UTC timestamp;
vfromdatetimeOB_UTC timestamp;
vtodatetimeOB_UTC timestamp;
vfromdatetimeNonHost_UTC timestamp;
vtodatetimeNonHost_UTC timestamp;

vactualdate date;
/*DECLARE @BusinessDateFromDATETIME;
DECLARE @BusinessDateToDATETIME;
DECLARE @l_PeriodFromDateNonHostUTCDATETIME
DECLARE @l_PeriodToDateNonHostUTCDATETIME
DECLARE @InsertedDateDATETIME;
DECLARE @l_PeriodFromDateIGTUTC DATETIME
DECLARE @l_PeriodToDateIGTUTC DATETIME
DECLARE @l_PeriodFromDateOBUTC DATETIME --(15)
DECLARE @l_PeriodToDateOBUTC DATETIME --(15)

*/

BEGIN

select businessdate into vbusinessdate;


create temp table if not exists ubt_temp_TmpTerLocPrdSalesAmt
	( 
	terdisplayid varchar(200),
	transactiondate timestamp,
	prodid int4,
	locdisplayid varchar(200),
	sales_type varchar(100),
	totalcount int4,
	amount numeric(32, 11)      
	);


create temp table ubt_temp_terminal as 
	Select Ter.TerDisplayID, Ter.LocID  FROM public.ztubt_Terminal Ter;

create temp table ubt_temp_product as 
	Select PD.ProdID,
	case PD.prodid when 5 then 'SPORTS' else trim(PD.ProdName) end as ProdName  FROM public.ztubt_Product PD
	WHERE PD.ProdID != 6 ;--(15) remove Sports Live so that all Sports refer to ProductID = 5 only


create temp table ubt_temp_Location as
	Select Loc.LocID, Loc.LocDisplayID, Loc.SweepIndicator,Loc.LocTypeID,Loc.IsGST,Loc.AccountNumber,
	Loc.BranchID,Loc.Bankid,Loc.LocName,Loc.IsIBG,Loc.RetID,LOC.CHID
	from public.ztubt_location  Loc;

--GetcommondatesfroUBT

	select 
	fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,utcfromdatetimeob,utctodatetimeob,
	utcfromdatetimenonhost,utctodatetimenonhost
	into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeNonHost_UTC ,
	vtodatetimeNonHost_UTC 
	from public.sp_ubt_getcommonubtdates(vbusinessdate,vbusinessdate);


create temp table if not exists ubt_temp_TmpTicketByWageAndSales 
	(
	ticketserialnumber varchar(500),
	wager numeric(22,2), 
	secondwager numeric(22,2), 
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2), 
	winningamount numeric(22,2) 
	);

-- from function getamounttransaction

INSERT INTO ubt_temp_TmpTicketByWageAndSales
 select * from  public.sp_ubt_getamounttransaction(vbusinessdate,vbusinessdate);




create temp table if not exists ubt_temp_ResultCashlessInTerminal 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(22, 11),
	ct int4
	);

insert into ubt_temp_ResultCashlessInTerminal

	select  pd.terdisplayid, 'NETS', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NC','NN') 
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC 
	group by pd.terdisplayid
	
	union all 
	select pd.terdisplayid, 'CASHCARD', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NCC') --cashcard
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	
	union all
	
	select pd.terdisplayid, 'Flashpay', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NFP') --Flashpay
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	;

create temp table if not exists ubt_temp_iTOTO
	(
	ticketserialnumber varchar(200),
	itotoindicator bool,
	groupunitsequence int4
	)
;
INSERT INTO ubt_temp_iTOTO
	select distinct ticketserialnumber, itotoindicator, groupunitsequence
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where ((groupunitsequence = 1) --group toto
	or (itotoindicator = true)) --itoto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
;


create temp table if not exists ubt_temp_GroupTOTO
	(
	ticketserialnumber varchar(200),
	grouphostid varchar(50),
	groupunitsequence int4
	);

insert into ubt_temp_grouptoto
	select distinct ticketserialnumber, grouphostid, groupunitsequence
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where groupunitsequence is not null --group toto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC  )
;

create temp table ubt_temp_CancelledBetTicketState as 
	select cb.cartid,cb.terdisplayid,cb.ticketserialnumber,cb.tranheaderid,cb.cancelleddate ,cb.cancelledamout,cb.prodid 
	from  public.ztubt_cancelledbetticket  cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
   on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateIGT and vtodateIGT
;


create temp table if not exists ubt_temp_SalesGroupToto
(
	terdisplayid varchar(200),
	prodid int4,
	locdisplayid varchar(200),
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --Sales of each product (Wager * Sales Factor)
);

insert into ubt_temp_SalesGroupToto(terdisplayid, prodid, locdisplayid,bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid, 
	3 as prodid, 
	loc.locdisplayid as locdisplayid,
	1 as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal,  
	count(distinct can.ticketserialnumber)	as canceltotal,
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
		
		left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)can on pbth.ticketserialnumber = can.ticketserialnumber
		
	where  
	pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by  ter.terdisplayid,loc.locdisplayid
	;

create temp table if not exists ubt_temp_salestoto 
	(
	terdisplayid varchar(200),
	locdisplayid varchar(200),
	prodid int4,
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);

insert into ubt_temp_salestoto(terdisplayid, locdisplayid,prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid		as terdisplayid,	
	loc.locdisplayid			as locdisplayid,
	3		as prodid, 
	1		as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1)		as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	public.ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)can on pbth.ticketserialnumber = can.ticketserialnumber

	where pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by ter.terdisplayid,loc.locdisplayid	
	;

--FILL IN TRANS AMOUNT DETAIL DATA
		
create temp table if not exists ubt_temp_transamountdetaildata 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(32, 13),
	ct int4,
	flag char(3),
	transtype char(2),
	fromdate date,
	todate date
	);
Insert Into ubt_temp_transamountdetaildata
	select terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
	from public.sp_ubt_gettransamountdetails (vbusinessdate,vbusinessdate);


-- insert all data

insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='COL' and transtype != 'OO' and prd.prodid in (2,3,4,5) --(15)add sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	
	--offline orders - wager
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' 
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	
	----2	AT_CANCELAMT	Yes	cancel amount
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'2'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='CAN' and  prd.prodid in (2,3,4,5) --(15)add sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	
	---3	AT_VALIDAMT	Yes	validation amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'3'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='PAY' and  prd.prodid in (2,3,4,5) --(15)add sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	---4	Rebate Amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'4'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RBT' and  prd.prodid in (2,3,4,5) --(15)add sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all
	--61	Refund Amount--(4)(5)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RFD' AND TransType != 'OO' and  prd.prodid in (2,3,4,5) --(15)add sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	--offline orders - refund
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
		where flag='RFD' AND TransType = 'OO' 
		group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--6	AT_TAXAMT 	Yes	tax amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'6'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='GST' AND prd.prodid in (2,3,4,5) --(15)add sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	---7	AT_COMMAMT	Yes	commission amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'7'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='SAL' AND prd.prodid in (2,3,4,5) --(15)add sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
		
	------16. AT_FRACVALAMT  Show fractional validation amounts [Validation amounts for GROUP TOTO - This is a subset of Sales Type  3]
	union all
	
	select	ter.terdisplayid				as terdisplayid,
	vbusinessdate transactiondate,
	3		as prodid,
	loc.locdisplayid	as locdisplayid,
	'16'		as sales_type,
	count(distinct vb.tranheaderid)	as totalcount, 
	sum(coalesce(vb.winningamount,0))	as totalamount
	from --(1)
	(
		select vb.tranheaderid,vb.winningamount,vb.cartid,vb.terdisplayid,vb.createdvalidationdate 
		from public.ztubt_validatedbetticket  vb --(16)
		inner join public.ztubt_validatedbetticketlifecyclestate  vbt
		on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
		where vb.winningamount != 0 and vb.winningamount is not null --(8)
		and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	)vb
	inner join 
	(
		select distinct tranheaderid, grouphostid, groupunitsequence from  public.ztubt_toto_placedbettransactionlineitem  
	)ph on vb.tranheaderid = ph.tranheaderid --(16)
	inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where ph.groupunitsequence is not null --(16)
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--52. House syndicate sales amount - [iTOTO sales  this is a subset of sales type 1]
	
	select	s.terdisplayid			as terdisplayid,
	vbusinessdate	as transactiondate, 
	s.prodid	as prodid, 
	s.locdisplayid as locdisplayid,
	'52' as sales_type, 
	sum(coalesce(s.wagertotal,0))		as totalcount, 
	sum(coalesce(s.wageramount,0))	as totalamount
	from ubt_temp_salestoto s
	group by s.terdisplayid, s.prodid, s.locdisplayid
		
	union all 
	--25. House syndicate sales amount by sales factor [iTOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	select	s.terdisplayid	as terdisplayid,
	vbusinessdate		as transactiondate, 
	3	as prodid,
	s.locdisplayid	as locdisplayid,
	'25'	as sales_type,
	sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))		as totalcount, 
	trunc(sum(coalesce(s.salesamount,0)) / 100 , 2) * 100	as totalamount  
	from ubt_temp_salestoto s
	group by s.locdisplayid,s.terdisplayid
	
	union all 
	--40. GST TAX rate--------------------------------------------------------------------
	
	select	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate,
	prd.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'40'		as sales_type,
	0		as totalcount ,
	gst.gstrate
	from	
	(
		select loc.locdisplayid, ter.terdisplayid from ubt_temp_location loc
		inner join ubt_temp_terminal ter on loc.locid = ter.locid
		where loc.isgst = true
	)loc
	cross join 
	(
		select * from ubt_temp_product where prodid in (2,3,4) --lottery / es
	)prd
	cross join
	(
		select gstrate from public.ztubt_gstconfig a 
		where (vbusinessdate between effectivefrom and enddate) or (vbusinessdate >=effectivefrom and enddate is null) limit 1
		--check this code
	)gst
	
	union all 
--59. House syndicate cancel amount - [iTOTO cancellations  This is a Sub Set of Sales Type 2]
	
	select	cb.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	3		as prodid, 
	loc.locdisplayid as locdisplayid,
	'59'		as sales_type, 
	count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)as totalcount, 
	sum(coalesce (cb.cancelledamout,0))as totalamount
	from ubt_temp_cancelledbetticketstate cb 
	
	inner join ubt_temp_itoto itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true 
	inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where cb.prodid = 3 --(1)and tpbtli.itotoindicator = 1
	 and cb.cancelleddate between vfromdateIGT and vtodateIGT
	group by cb.terdisplayid,loc.locdisplayid
	
	union all 
	---60. Player syndicate sales amount by sales factor - [GROUP TOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	SELECT S.TerDisplayID AS TerDisplayID ,
	 vbusinessdate	AS TransactionDate, 
	S.ProdID	AS ProdID,
	S.LocDisplayID AS LocDisplayID,
	'60' AS sales_type, 
	SUM(coalesce(S.WagerTotal,0)  - coalesce(S.CancelTotal,0))	AS TotalCount,--(8)
	trunc(SUM(coalesce(s.SalesAmount,0)) / 100 , 2) * 100	AS TotalAmount  
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY  S.TerDisplayID,S.ProdID, S.LocDisplayID

	union all 
	
	--69. Player syndicate sales amount - [GROUP TOTO Sales  This is a subset of Sales Type 1]----------
	
	SELECT	S.TerDisplayID			AS TerDisplayID,
	vbusinessdate	AS TransactionDate,
	3 AS ProdID, 
	S.LocDisplayID AS LocDisplayID,
	'69' AS sales_type,
	SUM(COALESCE(S.WagerTotal,0))AS TotalCount, 
	SUM(COALESCE(S.WagerAmount,0))		AS TotalAmount--(1)COALESCE(S.Amount,0)		AS TotalAmount
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY S.TerDisplayID, S.LocDisplayID

	union all
	--70 [	 GROUP TOTO Cancel Amount  This is a subset of Sales Type 2]-----------------------------------
	select			cbt.terdisplayid as terdisplayid,
	vbusinessdate	as transactiondate, 
	3				as prodid,
	loc.locdisplayid	as locdisplayid,
	'70'				as sales_type, 
	count(distinct gt.grouphostid)	as totalcount, 
	sum(coalesce (cbt.cancelledamout,0))	as totalamount
	from ubt_temp_cancelledbetticketstate cbt
	inner join ubt_temp_grouptoto gt on cbt.ticketserialnumber = gt.ticketserialnumber
	inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where  cbt.prodid = 3  
	and cbt.cancelleddate between vfromdateIGT and vtodateIGT 
	group by cbt.terdisplayid,loc.locdisplayid	
	
	union all 
	--105 Sales Commision Rate
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid in (2,3,4) --lottery / es
		)sal
		
	union all 
	--108 AT_ON_EZLINK----------------------------------------------------------------------- 
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'108'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'NETS'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--110	AT_ON_ATM	Yes	Flashpay transaction --------------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'110'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'Flashpay'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--112	AT_ON_CASHCARD	Yes	Cashcard transaction------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'112'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'CASHCARD'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all
	---116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor-------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	a.prodid as prodid,
	loc.locdisplayid		as locdisplayid,
	'116'		as sales_type,
	sum(coalesce(a.total,0)  - coalesce(can.total,0))	as totalcount, --(8)
	trunc(sum(coalesce(a.amount,0)) / 100, 2) * 100 as totalamount  
  	from 
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
			case
				when pb.prodid=6 then 5 --prematch and live to be one same prodid
				else pb.prodid	end as prodid --(15)
			from ubt_temp_tmpticketbywageandsales a 
			inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 
			where pb.iscancelled = false and (
					(
					pb.prodid in (2,3,4) --lottery / es
					and pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC 

					)
					or --(15)
					(
					pb.prodid in (5,6) --sports / ob
					and pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC
					)
				)
			group by a.ticketserialnumber, pb.terdisplayid, pb.prodid
		)a
		inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join --(8)
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, cb.terdisplayid, cb.prodid
			from ubt_temp_tmpticketbywageandsales a 
			inner join ubt_temp_cancelledbetticketstate cb on a.ticketserialnumber = cb.ticketserialnumber
			where cb.prodid in (2,3,4) --lottery / es
			group by a.ticketserialnumber, cb.terdisplayid, cb.prodid
		)can 
			on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid
			and a.prodid = can.prodid
		
		group by loc.locdisplayid,ter.terdisplayid,a.prodid
	;	
/*	UPDATE T
		SET TotalCount = T.TotalCount
		FROM 
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 116
		)T
		INNER JOIN
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 7
		)FIN ON T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
	--end modify (9)*/

/*update ubt_temp_TmpTerLocPrdSalesAmt T 
set TotalCount = FIN.TotalCount
from (
		SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = '7'
		)FIN 
	where 
	T.sales_type='116' and 
	T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
*/

-- [2022-04-01] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation
create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('001811006', 4, 'TOTO','2021-11-24'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vbusinessdate, vbusinessdate);




DELETE  FROM ubt_temp_tmpterlocprdsalesamt SAL USING ubt_temp_sales_scandsr RS 
where  SAL.TerDisplayID = RS.TerDisplayID 
AND RS.ProdID = SAL.ProdID
AND SAL.Sales_type = '116';




INSERT INTO ubt_temp_tmpterlocprdsalesamt(TerDisplayId, TransactionDate, ProdID, LocDisplayID, Sales_type, TotalCount, Amount)
	SELECT	RS.TerDisplayID	as TerDisplayID,
			vbusinessdate			AS TransactionDate, 
			RS.ProdID			AS ProdID,
			LOC.LocDisplayID		AS LocDisplayID,
			'116'					aS sales_type,
			RS.TotalCount, 
			RS.Amount*100
	FROM ubt_temp_sales_scandsr RS
	INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
	INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
	where RS.ActualDate = vbusinessdate;

-- [2022-04-01] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--119	at_salesfactor	yes	sales factor-------------------------------
create temp table if not exists ubt_temp_salesfactorconfig
	(
		prodid int4,
		salesfactor numeric(13,12)
	)
	;
insert into ubt_temp_salesfactorconfig
	select a.prodid, a.salesfactor  from  public.ztubt_salescomconfig  a 
	where commissiontype=1  and a.isdeleted = false and prodid in (2,3,4)
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc
		)sfc
;

insert into 	ubt_temp_tmpterlocprdsalesamt
		SELECT	coalesce(DB.TerDisplayID,CR.TerDisplayID)					AS TerDisplayID,
				coalesce(DB.TransactionDate,CR.TransactionDate)			AS TransactionDate, 
				0														AS ProdID,
				coalesce(DB.LocDisplayID,CR.LocDisplayID)					AS LocDisplayID,
				'727'														AS sales_type,
				0														AS TotalCount,
				SUM(coalesce(DB.Amount,0)) - SUM(coalesce(CR.Amount,0))		AS Amount 
		FROM
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type in
			(
				'2', --cancel amount
				'3',	--validation amount
				'7',	--commission amount
				--(7)6, -- GST tax amount
				'108', --NETS transaction
				'110', --Flashpay transaction
				'112', --Cashcard transaction
				--(4)-1 -- refund and rebate
				'4', --rebate
				'61' --refund--(5)5 --refund
			 )
			 AND (prodid :: int) != 31  --(15) exclude offline orders in the net amount due calculation
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) CR
		FULL OUTER JOIN 
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type ='1'	--collection
			AND (prodid :: int)!= 31 
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) DB ON DB.LocDisplayID=CR.LocDisplayID AND DB.TransactionDate=CR.TransactionDate AND DB.TerDisplayID=CR.TerDisplayID
		GROUP BY DB.TerDisplayID, DB.TransactionDate, DB.LocDisplayID,CR.TerDisplayID,CR.TransactionDate, CR.LocDisplayID					
;		
	
	UPDATE ubt_temp_tmpterlocprdsalesamt td
		set ProdID = p.SAPProdID
		from public.ztubt_sap_product  p
		where (td.ProdID :: int) = p.prodid 
;	
return query
SELECT DISTINCT 
			coalesce(TerDisplayID, '')
			,(TransactionDate :: Date)
			,coalesce(ProdID :: int, 0)
			,coalesce(LocDisplayID, '')
			,coalesce(Sales_type, '')
			,TotalCount
			,Amount
		FROM ubt_temp_tmpterlocprdsalesamt --(12) ubt_temp_FinalTempData--(1)FROM ubt_temp_TmpTerLocPrdSalesAmt
		WHERE (TotalCount!=0 or Amount!=0)
		AND (TransactionDate :: DATE) = vbusinessdate
;
	drop table if exists ubt_temp_tmpterlocprdsalesamt;
	drop table if exists ubt_temp_tmpticketbywageandsales;
	drop table if exists ubt_temp_resultcashlessinterminal;
	drop table if exists ubt_temp_grouptoto;
	drop table if exists ubt_temp_itoto;
	drop table if exists ubt_temp_location;
	drop table if exists ubt_temp_product;
	drop table if exists ubt_temp_salesfactorconfig;
	drop table if exists ubt_temp_salesgrouptoto;
	drop table if exists ubt_temp_salestoto;
	drop table if exists ubt_temp_terminal;
	drop table if exists ubt_temp_transamountdetaildata;
	drop table if exists ubt_temp_cancelledbetticketstate;
	-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
	drop table if exists ubt_temp_sales_scandsr;
	
		
end
;
$$;


ALTER FUNCTION public.sp_ubt_getterminalinvoice_bk20240704(businessdate date) OWNER TO consultant01;

--
-- TOC entry 1146 (class 1255 OID 2005646)
-- Name: sp_ubt_getterminalinvoice_bk20241010(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getterminalinvoice_bk20241010(businessdate date) RETURNS TABLE(terdisplayid character varying, transactiondate date, prodid integer, locdisplayid character varying, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
vbusinessdate date;
vinputdate date;
vstartperiod date;
vendperiod date;
vfromdateIGT timestamp;--@BusinessDateFrom
vtodateIGT timestamp;--@BusinessDateTo
vfromdatetimeIGT_UTC timestamp;
vtodatetimeIGT_UTC timestamp;
vfromdatetimeOB_UTC timestamp;
vtodatetimeOB_UTC timestamp;
vfromdatetimeNonHost_UTC timestamp;
vtodatetimeNonHost_UTC timestamp;
vfromdatetimeBMCS_UTC timestamp;
vtodatetimeBMCS_UTC timestamp;

vactualdate date;
/*DECLARE @BusinessDateFromDATETIME;
DECLARE @BusinessDateToDATETIME;
DECLARE @l_PeriodFromDateNonHostUTCDATETIME
DECLARE @l_PeriodToDateNonHostUTCDATETIME
DECLARE @InsertedDateDATETIME;
DECLARE @l_PeriodFromDateIGTUTC DATETIME
DECLARE @l_PeriodToDateIGTUTC DATETIME
DECLARE @l_PeriodFromDateOBUTC DATETIME --(15)
DECLARE @l_PeriodToDateOBUTC DATETIME --(15)

*/

BEGIN

select businessdate into vbusinessdate;


create temp table if not exists ubt_temp_TmpTerLocPrdSalesAmt
	( 
	terdisplayid varchar(200),
	transactiondate timestamp,
	prodid int4,
	locdisplayid varchar(200),
	sales_type varchar(100),
	totalcount int4,
	amount numeric(32, 11)      
	);


create temp table ubt_temp_terminal as 
	Select Ter.TerDisplayID, Ter.LocID  FROM public.ztubt_Terminal Ter;

create temp table ubt_temp_product as 
	Select PD.ProdID,
	case PD.prodid when 5 then 'SPORTS' else trim(PD.ProdName) end as ProdName  FROM public.ztubt_Product PD
	WHERE PD.ProdID != 6 ;--(15) remove Sports Live so that all Sports refer to ProductID = 5 only


create temp table ubt_temp_Location as
	Select Loc.LocID, Loc.LocDisplayID, Loc.SweepIndicator,Loc.LocTypeID,Loc.IsGST,Loc.AccountNumber,
	Loc.BranchID,Loc.Bankid,Loc.LocName,Loc.IsIBG,Loc.RetID,LOC.CHID
	from public.ztubt_location  Loc;

--GetcommondatesfroUBT

	select 
	fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,utcfromdatetimeob,utctodatetimeob,
	utcfromdatetimenonhost,utctodatetimenonhost, utcfromdatetimebmcs, utctodatetimebmcs
	into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeNonHost_UTC ,
	vtodatetimeNonHost_UTC,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
	from public.sp_ubt_getcommonubtdates(vbusinessdate,vbusinessdate);


create temp table if not exists ubt_temp_TmpTicketByWageAndSales 
	(
	ticketserialnumber varchar(500),
	wager numeric(22,2), 
	secondwager numeric(22,2), 
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2), 
	winningamount numeric(22,2) 
	);

-- from function getamounttransaction

INSERT INTO ubt_temp_TmpTicketByWageAndSales
 select * from  public.sp_ubt_getamounttransaction(vbusinessdate,vbusinessdate);




create temp table if not exists ubt_temp_ResultCashlessInTerminal 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(22, 11),
	ct int4
	);

insert into ubt_temp_ResultCashlessInTerminal

	select  pd.terdisplayid, 'NETS', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NC','NN') 
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC 
	group by pd.terdisplayid
	
	union all 
	select pd.terdisplayid, 'CASHCARD', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NCC') --cashcard
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	
	union all
	
	select pd.terdisplayid, 'Flashpay', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NFP') --Flashpay
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	;

create temp table if not exists ubt_temp_iTOTO
	(
	ticketserialnumber varchar(200),
	itotoindicator bool,
	groupunitsequence int4
	)
;
INSERT INTO ubt_temp_iTOTO
	select distinct ticketserialnumber, itotoindicator, groupunitsequence
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where ((groupunitsequence = 1) --group toto
	or (itotoindicator = true)) --itoto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
;


create temp table if not exists ubt_temp_GroupTOTO
	(
	ticketserialnumber varchar(200),
	grouphostid varchar(50),
	groupunitsequence int4
	);

insert into ubt_temp_grouptoto
	select distinct ticketserialnumber, grouphostid, groupunitsequence
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where groupunitsequence is not null --group toto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC  )
;

create temp table ubt_temp_CancelledBetTicketState as 
	select cb.cartid,cb.terdisplayid,cb.ticketserialnumber,cb.tranheaderid,cb.cancelleddate ,cb.cancelledamout,cb.prodid 
	from  public.ztubt_cancelledbetticket  cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
   on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateIGT and vtodateIGT
;


create temp table if not exists ubt_temp_SalesGroupToto
(
	terdisplayid varchar(200),
	prodid int4,
	locdisplayid varchar(200),
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --Sales of each product (Wager * Sales Factor)
);

insert into ubt_temp_SalesGroupToto(terdisplayid, prodid, locdisplayid,bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid, 
	3 as prodid, 
	loc.locdisplayid as locdisplayid,
	1 as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal,  
	count(distinct can.ticketserialnumber)	as canceltotal,
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
		
		left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)can on pbth.ticketserialnumber = can.ticketserialnumber
		
	where  
	pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by  ter.terdisplayid,loc.locdisplayid
	;

create temp table if not exists ubt_temp_salestoto 
	(
	terdisplayid varchar(200),
	locdisplayid varchar(200),
	prodid int4,
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);

insert into ubt_temp_salestoto(terdisplayid, locdisplayid,prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid		as terdisplayid,	
	loc.locdisplayid			as locdisplayid,
	3		as prodid, 
	1		as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1)		as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	public.ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)can on pbth.ticketserialnumber = can.ticketserialnumber

	where pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by ter.terdisplayid,loc.locdisplayid	
	;

--FILL IN TRANS AMOUNT DETAIL DATA
		
create temp table if not exists ubt_temp_transamountdetaildata 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(32, 13),
	ct int4,
	flag char(3),
	transtype char(2),
	fromdate date,
	todate date
	);
Insert Into ubt_temp_transamountdetaildata
	select terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
	from public.sp_ubt_gettransamountdetails (vbusinessdate,vbusinessdate);


-- insert all data

insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='COL' and transtype != 'OO' and prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	
	--offline orders - wager
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' 
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	
	----2	AT_CANCELAMT	Yes	cancel amount
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'2'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='CAN' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	
	---3	AT_VALIDAMT	Yes	validation amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'3'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='PAY' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	---4	Rebate Amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'4'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RBT' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all
	--61	Refund Amount--(4)(5)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RFD' AND TransType != 'OO' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	--offline orders - refund
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
		where flag='RFD' AND TransType = 'OO' 
		group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--6	AT_TAXAMT 	Yes	tax amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'6'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='GST' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	---7	AT_COMMAMT	Yes	commission amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'7'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='SAL' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
		
	------16. AT_FRACVALAMT  Show fractional validation amounts [Validation amounts for GROUP TOTO - This is a subset of Sales Type  3]
	union all
	
	select	ter.terdisplayid				as terdisplayid,
	vbusinessdate transactiondate,
	3		as prodid,
	loc.locdisplayid	as locdisplayid,
	'16'		as sales_type,
	count(distinct vb.tranheaderid)	as totalcount, 
	sum(coalesce(vb.winningamount,0))	as totalamount
	from --(1)
	(
		select vb.tranheaderid,vb.winningamount,vb.cartid,vb.terdisplayid,vb.createdvalidationdate 
		from public.ztubt_validatedbetticket  vb --(16)
		inner join public.ztubt_validatedbetticketlifecyclestate  vbt
		on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
		where vb.winningamount != 0 and vb.winningamount is not null --(8)
		and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	)vb
	inner join 
	(
		select distinct tranheaderid, grouphostid, groupunitsequence from  public.ztubt_toto_placedbettransactionlineitem  
	)ph on vb.tranheaderid = ph.tranheaderid --(16)
	inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where ph.groupunitsequence is not null --(16)
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--52. House syndicate sales amount - [iTOTO sales  this is a subset of sales type 1]
	
	select	s.terdisplayid			as terdisplayid,
	vbusinessdate	as transactiondate, 
	s.prodid	as prodid, 
	s.locdisplayid as locdisplayid,
	'52' as sales_type, 
	sum(coalesce(s.wagertotal,0))		as totalcount, 
	sum(coalesce(s.wageramount,0))	as totalamount
	from ubt_temp_salestoto s
	group by s.terdisplayid, s.prodid, s.locdisplayid
		
	union all 
	--25. House syndicate sales amount by sales factor [iTOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	select	s.terdisplayid	as terdisplayid,
	vbusinessdate		as transactiondate, 
	3	as prodid,
	s.locdisplayid	as locdisplayid,
	'25'	as sales_type,
	sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))		as totalcount, 
	trunc(sum(coalesce(s.salesamount,0)) / 100 , 2) * 100	as totalamount  
	from ubt_temp_salestoto s
	group by s.locdisplayid,s.terdisplayid
	
	union all 
	--40. GST TAX rate--------------------------------------------------------------------
	
	select	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate,
	prd.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'40'		as sales_type,
	0		as totalcount ,
	gst.gstrate
	from	
	(
		select loc.locdisplayid, ter.terdisplayid from ubt_temp_location loc
		inner join ubt_temp_terminal ter on loc.locid = ter.locid
		where loc.isgst = true
	)loc
	cross join 
	(
		select * from ubt_temp_product where prodid in (2,3,4) --lottery / es
	)prd
	cross join
	(
		select gstrate from public.ztubt_gstconfig a 
		where (vbusinessdate between effectivefrom and enddate) or (vbusinessdate >=effectivefrom and enddate is null) limit 1
		--check this code
	)gst
	
	union all 
--59. House syndicate cancel amount - [iTOTO cancellations  This is a Sub Set of Sales Type 2]
	
	select	cb.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	3		as prodid, 
	loc.locdisplayid as locdisplayid,
	'59'		as sales_type, 
	count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)as totalcount, 
	sum(coalesce (cb.cancelledamout,0))as totalamount
	from ubt_temp_cancelledbetticketstate cb 
	
	inner join ubt_temp_itoto itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true 
	inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where cb.prodid = 3 --(1)and tpbtli.itotoindicator = 1
	 and cb.cancelleddate between vfromdateIGT and vtodateIGT
	group by cb.terdisplayid,loc.locdisplayid
	
	union all 
	---60. Player syndicate sales amount by sales factor - [GROUP TOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	SELECT S.TerDisplayID AS TerDisplayID ,
	 vbusinessdate	AS TransactionDate, 
	S.ProdID	AS ProdID,
	S.LocDisplayID AS LocDisplayID,
	'60' AS sales_type, 
	SUM(coalesce(S.WagerTotal,0)  - coalesce(S.CancelTotal,0))	AS TotalCount,--(8)
	trunc(SUM(coalesce(s.SalesAmount,0)) / 100 , 2) * 100	AS TotalAmount  
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY  S.TerDisplayID,S.ProdID, S.LocDisplayID

	union all 
	
	--69. Player syndicate sales amount - [GROUP TOTO Sales  This is a subset of Sales Type 1]----------
	
	SELECT	S.TerDisplayID			AS TerDisplayID,
	vbusinessdate	AS TransactionDate,
	3 AS ProdID, 
	S.LocDisplayID AS LocDisplayID,
	'69' AS sales_type,
	SUM(COALESCE(S.WagerTotal,0))AS TotalCount, 
	SUM(COALESCE(S.WagerAmount,0))		AS TotalAmount--(1)COALESCE(S.Amount,0)		AS TotalAmount
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY S.TerDisplayID, S.LocDisplayID

	union all
	--70 [	 GROUP TOTO Cancel Amount  This is a subset of Sales Type 2]-----------------------------------
	select			cbt.terdisplayid as terdisplayid,
	vbusinessdate	as transactiondate, 
	3				as prodid,
	loc.locdisplayid	as locdisplayid,
	'70'				as sales_type, 
	count(distinct gt.grouphostid)	as totalcount, 
	sum(coalesce (cbt.cancelledamout,0))	as totalamount
	from ubt_temp_cancelledbetticketstate cbt
	inner join ubt_temp_grouptoto gt on cbt.ticketserialnumber = gt.ticketserialnumber
	inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where  cbt.prodid = 3  
	and cbt.cancelleddate between vfromdateIGT and vtodateIGT 
	group by cbt.terdisplayid,loc.locdisplayid	
	
	union all 
	--105 Sales Commision Rate
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid in (2,3,4) --lottery / es
		)sal
		
	union all 
	--108 AT_ON_EZLINK----------------------------------------------------------------------- 
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'108'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'NETS'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--110	AT_ON_ATM	Yes	Flashpay transaction --------------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'110'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'Flashpay'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--112	AT_ON_CASHCARD	Yes	Cashcard transaction------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'112'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'CASHCARD'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all
	---116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor-------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	a.prodid as prodid,
	loc.locdisplayid		as locdisplayid,
	'116'		as sales_type,
	sum(coalesce(a.total,0)  - coalesce(can.total,0))	as totalcount, --(8)
	trunc(sum(coalesce(a.amount,0)) / 100, 2) * 100 as totalamount  
  	from 
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
			case
				when pb.prodid=6 then 5 --prematch and live to be one same prodid
				else pb.prodid	end as prodid --(15)
			from ubt_temp_tmpticketbywageandsales a 
			inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 
			where pb.iscancelled = false and (
					(
					pb.prodid in (2,3,4) --lottery / es
					and pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC 

					)
					or --(15)
					(
					pb.prodid in (5,6) --sports / ob
					and pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC
					)
					or 
					(
					pb.prodid in (1) --horse racing / bmcs
					and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
					)
				)
			group by a.ticketserialnumber, pb.terdisplayid, pb.prodid
		)a
		inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join --(8)
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, cb.terdisplayid, cb.prodid
			from ubt_temp_tmpticketbywageandsales a 
			inner join ubt_temp_cancelledbetticketstate cb on a.ticketserialnumber = cb.ticketserialnumber
			where cb.prodid in (2,3,4) --lottery / es
			group by a.ticketserialnumber, cb.terdisplayid, cb.prodid
		)can 
			on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid
			and a.prodid = can.prodid
		
		group by loc.locdisplayid,ter.terdisplayid,a.prodid
	;	
/*	UPDATE T
		SET TotalCount = T.TotalCount
		FROM 
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 116
		)T
		INNER JOIN
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 7
		)FIN ON T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
	--end modify (9)*/

/*update ubt_temp_TmpTerLocPrdSalesAmt T 
set TotalCount = FIN.TotalCount
from (
		SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = '7'
		)FIN 
	where 
	T.sales_type='116' and 
	T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
*/

-- [2022-04-01] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation
create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('001811006', 4, 'TOTO','2021-11-24'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vbusinessdate, vbusinessdate);




DELETE  FROM ubt_temp_tmpterlocprdsalesamt SAL USING ubt_temp_sales_scandsr RS 
where  SAL.TerDisplayID = RS.TerDisplayID 
AND RS.ProdID = SAL.ProdID
AND SAL.Sales_type = '116';




INSERT INTO ubt_temp_tmpterlocprdsalesamt(TerDisplayId, TransactionDate, ProdID, LocDisplayID, Sales_type, TotalCount, Amount)
	SELECT	RS.TerDisplayID	as TerDisplayID,
			vbusinessdate			AS TransactionDate, 
			RS.ProdID			AS ProdID,
			LOC.LocDisplayID		AS LocDisplayID,
			'116'					aS sales_type,
			RS.TotalCount, 
			RS.Amount*100
	FROM ubt_temp_sales_scandsr RS
	INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
	INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
	where RS.ActualDate = vbusinessdate;

-- [2022-04-01] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--119	at_salesfactor	yes	sales factor-------------------------------
create temp table if not exists ubt_temp_salesfactorconfig
	(
		prodid int4,
		salesfactor numeric(13,12)
	)
	;
insert into ubt_temp_salesfactorconfig
	select a.prodid, a.salesfactor  from  public.ztubt_salescomconfig  a 
	where commissiontype=1  and a.isdeleted = false and prodid in (2,3,4)
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc
		)sfc
;

insert into 	ubt_temp_tmpterlocprdsalesamt
		SELECT	coalesce(DB.TerDisplayID,CR.TerDisplayID)					AS TerDisplayID,
				coalesce(DB.TransactionDate,CR.TransactionDate)			AS TransactionDate, 
				0														AS ProdID,
				coalesce(DB.LocDisplayID,CR.LocDisplayID)					AS LocDisplayID,
				'727'														AS sales_type,
				0														AS TotalCount,
				SUM(coalesce(DB.Amount,0)) - SUM(coalesce(CR.Amount,0))		AS Amount 
		FROM
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type in
			(
				'2', --cancel amount
				'3',	--validation amount
				'7',	--commission amount
				--(7)6, -- GST tax amount
				'108', --NETS transaction
				'110', --Flashpay transaction
				'112', --Cashcard transaction
				--(4)-1 -- refund and rebate
				'4', --rebate
				'61' --refund--(5)5 --refund
			 )
			 AND (prodid :: int) != 31  --(15) exclude offline orders in the net amount due calculation
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) CR
		FULL OUTER JOIN 
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type ='1'	--collection
			AND (prodid :: int)!= 31 
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) DB ON DB.LocDisplayID=CR.LocDisplayID AND DB.TransactionDate=CR.TransactionDate AND DB.TerDisplayID=CR.TerDisplayID
		GROUP BY DB.TerDisplayID, DB.TransactionDate, DB.LocDisplayID,CR.TerDisplayID,CR.TransactionDate, CR.LocDisplayID					
;		
	
	UPDATE ubt_temp_tmpterlocprdsalesamt td
		set ProdID = p.SAPProdID
		from public.ztubt_sap_product  p
		where (td.ProdID :: int) = p.prodid 
;	
return query
SELECT DISTINCT 
			coalesce(TerDisplayID, '')
			,(TransactionDate :: Date)
			,coalesce(ProdID :: int, 0)
			,coalesce(LocDisplayID, '')
			,coalesce(Sales_type, '')
			,TotalCount
			,Amount
		FROM ubt_temp_tmpterlocprdsalesamt --(12) ubt_temp_FinalTempData--(1)FROM ubt_temp_TmpTerLocPrdSalesAmt
		WHERE (TotalCount!=0 or Amount!=0)
		AND (TransactionDate :: DATE) = vbusinessdate
;
	drop table if exists ubt_temp_tmpterlocprdsalesamt;
	drop table if exists ubt_temp_tmpticketbywageandsales;
	drop table if exists ubt_temp_resultcashlessinterminal;
	drop table if exists ubt_temp_grouptoto;
	drop table if exists ubt_temp_itoto;
	drop table if exists ubt_temp_location;
	drop table if exists ubt_temp_product;
	drop table if exists ubt_temp_salesfactorconfig;
	drop table if exists ubt_temp_salesgrouptoto;
	drop table if exists ubt_temp_salestoto;
	drop table if exists ubt_temp_terminal;
	drop table if exists ubt_temp_transamountdetaildata;
	drop table if exists ubt_temp_cancelledbetticketstate;
	-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
	drop table if exists ubt_temp_sales_scandsr;
	
		
end
;
$$;


ALTER FUNCTION public.sp_ubt_getterminalinvoice_bk20241010(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1273 (class 1255 OID 1541799)
-- Name: sp_ubt_getterminalinvoice_bk20241203(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getterminalinvoice_bk20241203(businessdate date) RETURNS TABLE(terdisplayid character varying, transactiondate date, prodid integer, locdisplayid character varying, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
vbusinessdate date;
vinputdate date;
vstartperiod date;
vendperiod date;
vfromdateIGT timestamp;--@BusinessDateFrom
vtodateIGT timestamp;--@BusinessDateTo
vfromdatetimeIGT_UTC timestamp;
vtodatetimeIGT_UTC timestamp;
vfromdatetimeOB_UTC timestamp;
vtodatetimeOB_UTC timestamp;
vfromdatetimeNonHost_UTC timestamp;
vtodatetimeNonHost_UTC timestamp;
vfromdatetimeBMCS_UTC timestamp;
vtodatetimeBMCS_UTC timestamp;

vactualdate date;
/*DECLARE @BusinessDateFromDATETIME;
DECLARE @BusinessDateToDATETIME;
DECLARE @l_PeriodFromDateNonHostUTCDATETIME
DECLARE @l_PeriodToDateNonHostUTCDATETIME
DECLARE @InsertedDateDATETIME;
DECLARE @l_PeriodFromDateIGTUTC DATETIME
DECLARE @l_PeriodToDateIGTUTC DATETIME
DECLARE @l_PeriodFromDateOBUTC DATETIME --(15)
DECLARE @l_PeriodToDateOBUTC DATETIME --(15)

*/

v_tfogBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettfogbettypes()));

BEGIN

select businessdate into vbusinessdate;


create temp table if not exists ubt_temp_TmpTerLocPrdSalesAmt
	( 
	terdisplayid varchar(200),
	transactiondate timestamp,
	prodid int4,
	locdisplayid varchar(200),
	sales_type varchar(100),
	totalcount int4,
	amount numeric(32, 11),
	sub_prod varchar(100)
	);


create temp table ubt_temp_terminal as 
	Select Ter.TerDisplayID, Ter.LocID  FROM public.ztubt_Terminal Ter;

create temp table ubt_temp_product as 
	Select PD.ProdID,
	case PD.prodid when 5 then 'SPORTS' else trim(PD.ProdName) end as ProdName  FROM public.ztubt_Product PD
	WHERE PD.ProdID != 6 ;--(15) remove Sports Live so that all Sports refer to ProductID = 5 only

insert into ubt_temp_product (prodid, prodname) values (3, 'TFOG');


create temp table ubt_temp_Location as
	Select Loc.LocID, Loc.LocDisplayID, Loc.SweepIndicator,Loc.LocTypeID,Loc.IsGST,Loc.AccountNumber,
	Loc.BranchID,Loc.Bankid,Loc.LocName,Loc.IsIBG,Loc.RetID,LOC.CHID
	from public.ztubt_location  Loc;

--GetcommondatesfroUBT

	select 
	fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,utcfromdatetimeob,utctodatetimeob,
	utcfromdatetimenonhost,utctodatetimenonhost, utcfromdatetimebmcs, utctodatetimebmcs
	into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeNonHost_UTC ,
	vtodatetimeNonHost_UTC,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
	from public.sp_ubt_getcommonubtdates(vbusinessdate,vbusinessdate);


create temp table if not exists ubt_temp_TmpTicketByWageAndSales 
	(
	ticketserialnumber varchar(500),
	wager numeric(22,2), 
	secondwager numeric(22,2), 
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2), 
	winningamount numeric(22,2) 
	);

-- from function getamounttransaction

INSERT INTO ubt_temp_TmpTicketByWageAndSales
 select * from  public.sp_ubt_getamounttransaction(vbusinessdate,vbusinessdate);




create temp table if not exists ubt_temp_ResultCashlessInTerminal 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(22, 11),
	ct int4
	);

insert into ubt_temp_ResultCashlessInTerminal

	select  pd.terdisplayid, 'NETS', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NC','NN') 
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC 
	group by pd.terdisplayid
	
	union all 
	select pd.terdisplayid, 'CASHCARD', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NCC') --cashcard
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	
	union all
	
	select pd.terdisplayid, 'Flashpay', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NFP') --Flashpay
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	;

create temp table if not exists ubt_temp_iTOTO
	(
	ticketserialnumber varchar(200),
	itotoindicator bool,
	groupunitsequence int4,
	bettype int4
	)
;
INSERT INTO ubt_temp_iTOTO
	select distinct ticketserialnumber, itotoindicator, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_tfogBettypes) THEN 1 --TOTO
        else 2 --TFOG
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where ((groupunitsequence = 1) --group toto
	or (itotoindicator = true)) --itoto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
;


create temp table if not exists ubt_temp_GroupTOTO
	(
	ticketserialnumber varchar(200),
	grouphostid varchar(50),
	groupunitsequence int4,
	bettype int4
	);

insert into ubt_temp_grouptoto
	select distinct ticketserialnumber, grouphostid, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_tfogBettypes) THEN 1 --TOTO
        else 2 --TFOG
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where groupunitsequence is not null --group toto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC  )
;

create temp table ubt_temp_CancelledBetTicketState as 
	select cb.cartid,cb.terdisplayid,cb.ticketserialnumber,cb.tranheaderid,cb.cancelleddate ,cb.cancelledamout,cb.prodid 
	from  public.ztubt_cancelledbetticket  cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
   on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateIGT and vtodateIGT
;


create temp table if not exists ubt_temp_SalesGroupToto
(
	terdisplayid varchar(200),
	prodid int4,
	locdisplayid varchar(200),
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --Sales of each product (Wager * Sales Factor)
);

insert into ubt_temp_SalesGroupToto(terdisplayid, prodid, locdisplayid,bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid, 
	3 as prodid, 
	loc.locdisplayid as locdisplayid,
	fin.bettype as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal,  
	count(distinct can.ticketserialnumber)	as canceltotal,
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
		
		left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)can on pbth.ticketserialnumber = can.ticketserialnumber
		
	where  
	pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by  ter.terdisplayid,loc.locdisplayid, fin.bettype
	;

create temp table if not exists ubt_temp_salestoto 
	(
	terdisplayid varchar(200),
	locdisplayid varchar(200),
	prodid int4,
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);

insert into ubt_temp_salestoto(terdisplayid, locdisplayid,prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid		as terdisplayid,	
	loc.locdisplayid			as locdisplayid,
	3		as prodid, 
	fin.bettype as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1)		as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	public.ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)can on pbth.ticketserialnumber = can.ticketserialnumber

	where pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by ter.terdisplayid,loc.locdisplayid, fin.bettype
	;

--FILL IN TRANS AMOUNT DETAIL DATA
		
create temp table if not exists ubt_temp_transamountdetaildata 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(32, 13),
	ct int4,
	flag char(3),
	transtype char(2),
	fromdate date,
	todate date
	);
Insert Into ubt_temp_transamountdetaildata
	select terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
	from public.sp_ubt_gettransamountdetails (vbusinessdate,vbusinessdate);


-- insert all data

insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='COL' and transtype != 'OO' and prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all
	
	--offline orders - wager
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' 
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	
	----2	AT_CANCELAMT	Yes	cancel amount
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'2'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='CAN' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	
	---3	AT_VALIDAMT	Yes	validation amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'3'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='PAY' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---4	Rebate Amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'4'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod  
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RBT' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	union all
	--61	Refund Amount--(4)(5)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RFD' AND TransType != 'OO' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	--offline orders - refund
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
		where flag='RFD' AND TransType = 'OO' 
		group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--6	AT_TAXAMT 	Yes	tax amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'6'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='GST' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---7	AT_COMMAMT	Yes	commission amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'7'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='SAL' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
		
	------16. AT_FRACVALAMT  Show fractional validation amounts [Validation amounts for GROUP TOTO - This is a subset of Sales Type  3]
	union all
	
	select	ter.terdisplayid				as terdisplayid,
	vbusinessdate transactiondate,
	3		as prodid,
	loc.locdisplayid	as locdisplayid,
	'16'		as sales_type,
	count(distinct vb.tranheaderid)	as totalcount, 
	sum(coalesce(vb.winningamount,0))	as totalamount,
	case when ph.bettypeid != ALL(v_tfogBettypes) then 'TOTO'
		else 'TFOG' end as sub_prod 
	from --(1)
	(
		select vb.tranheaderid,vb.winningamount,vb.cartid,vb.terdisplayid,vb.createdvalidationdate 
		from public.ztubt_validatedbetticket  vb --(16)
		inner join public.ztubt_validatedbetticketlifecyclestate  vbt
		on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
		where vb.winningamount != 0 and vb.winningamount is not null --(8)
		and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	)vb
	inner join 
	(
		select distinct tranheaderid, grouphostid, groupunitsequence, bettypeid from public.ztubt_toto_placedbettransactionlineitem
	)ph on vb.tranheaderid = ph.tranheaderid --(16)
	inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where ph.groupunitsequence is not null --(16)
	group by loc.locdisplayid,ter.terdisplayid,
	case when ph.bettypeid != ALL(v_tfogBettypes) then 'TOTO'
		else 'TFOG' end
	
	union all 
	--52. House syndicate sales amount - [iTOTO sales  this is a subset of sales type 1]
	--TOTO, TFOG
	select	s.terdisplayid			as terdisplayid,
	vbusinessdate	as transactiondate, 
	s.prodid	as prodid, 
	s.locdisplayid as locdisplayid,
	'52' as sales_type, 
	sum(coalesce(s.wagertotal,0))		as totalcount, 
	sum(coalesce(s.wageramount,0))	as totalamount,
	case when s.bettype = 1 then 'TOTO'
		else 'TFOG' end as sub_prod
	from ubt_temp_salestoto s
	group by s.terdisplayid, s.prodid, s.locdisplayid,
		case when s.bettype = 1 then 'TOTO'
		else 'TFOG' end
		
	union all 
	--25. House syndicate sales amount by sales factor [iTOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO, TFOG
	select	s.terdisplayid	as terdisplayid,
	vbusinessdate		as transactiondate, 
	3	as prodid,
	s.locdisplayid	as locdisplayid,
	'25'	as sales_type,
	sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))		as totalcount, 
	trunc(sum(coalesce(s.salesamount,0)) / 100 , 2) * 100	as totalamount ,
	case when s.bettype = 1 then 'TOTO'
		else 'TFOG' end as sub_prod 
	from ubt_temp_salestoto s
	group by s.locdisplayid,s.terdisplayid,
		case when s.bettype = 1 then 'TOTO'
		else 'TFOG' end
	
	union all 
	--40. GST TAX rate--------------------------------------------------------------------
	
	select	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate,
	prd.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'40'		as sales_type,
	0		as totalcount ,
	gst.gstrate,
	prd.prodname as sub_prod
	from	
	(
		select loc.locdisplayid, ter.terdisplayid from ubt_temp_location loc
		inner join ubt_temp_terminal ter on loc.locid = ter.locid
		where loc.isgst = true
	)loc
	cross join 
	(
		select * from ubt_temp_product where prodid in (2,3,4) --lottery / es
	)prd
	cross join
	(
		select gstrate from public.ztubt_gstconfig a 
		where (vbusinessdate between effectivefrom and enddate) or (vbusinessdate >=effectivefrom and enddate is null) limit 1
		--check this code
	)gst
	
	union all 
--59. House syndicate cancel amount - [iTOTO cancellations  This is a Sub Set of Sales Type 2]
	--TOTO, TFOG
	select	cb.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	3		as prodid, 
	loc.locdisplayid as locdisplayid,
	'59'		as sales_type, 
	count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)as totalcount, 
	sum(coalesce (cb.cancelledamout,0))as totalamount,
	case when itoto.bettype = 1 then 'TOTO'
		else 'TFOG' end
	from ubt_temp_cancelledbetticketstate cb 
	inner join ubt_temp_itoto itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true 
	inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where cb.prodid = 3 --(1)and tpbtli.itotoindicator = 1
	 and cb.cancelleddate between vfromdateIGT and vtodateIGT
	group by cb.terdisplayid,loc.locdisplayid,
		case when itoto.bettype = 1 then 'TOTO'
			else 'TFOG' end
	
	union all 
	---60. Player syndicate sales amount by sales factor - [GROUP TOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO, TFOG
	SELECT S.TerDisplayID AS TerDisplayID ,
	 vbusinessdate	AS TransactionDate, 
	S.ProdID	AS ProdID,
	S.LocDisplayID AS LocDisplayID,
	'60' AS sales_type, 
	SUM(coalesce(S.WagerTotal,0)  - coalesce(S.CancelTotal,0))	AS TotalCount,--(8)
	trunc(SUM(coalesce(s.SalesAmount,0)) / 100 , 2) * 100	AS TotalAmount,
	case when S.bettype = 1 then 'TOTO'
		else 'TFOG' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY  S.TerDisplayID,S.ProdID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TFOG' end

	union all 
	
	--69. Player syndicate sales amount - [GROUP TOTO Sales  This is a subset of Sales Type 1]----------
	--TOTO, TFOG
	SELECT	S.TerDisplayID			AS TerDisplayID,
	vbusinessdate	AS TransactionDate,
	3 AS ProdID, 
	S.LocDisplayID AS LocDisplayID,
	'69' AS sales_type,
	SUM(COALESCE(S.WagerTotal,0))AS TotalCount, 
	SUM(COALESCE(S.WagerAmount,0))		AS TotalAmount,--(1)COALESCE(S.Amount,0)		AS TotalAmount
	case when S.bettype = 1 then 'TOTO'
		else 'TFOG' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY S.TerDisplayID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TFOG' end

	union all
	--70 [	 GROUP TOTO Cancel Amount  This is a subset of Sales Type 2]-----------------------------------
	--TOTO, TFOG
	select			cbt.terdisplayid as terdisplayid,
	vbusinessdate	as transactiondate, 
	3				as prodid,
	loc.locdisplayid	as locdisplayid,
	'70'				as sales_type, 
	count(distinct gt.grouphostid)	as totalcount, 
	sum(coalesce (cbt.cancelledamout,0))	as totalamount,
	case when gt.bettype = 1 then 'TOTO'
		else 'TFOG' end as sub_prod 
	from ubt_temp_cancelledbetticketstate cbt
	inner join ubt_temp_grouptoto gt on cbt.ticketserialnumber = gt.ticketserialnumber
	inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where  cbt.prodid = 3  
	and cbt.cancelleddate between vfromdateIGT and vtodateIGT 
	group by cbt.terdisplayid,loc.locdisplayid,
		case when gt.bettype = 1 then 'TOTO'
			else 'TFOG' end
	
	union all 
	--105 Sales Commision Rate
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
    '' as sub_prod
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid in (2,4) --lottery / es
		)sal
		
	union all 
	--TOTO, TFOG
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
	sp.sub_prod 
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid = 3 
		)sal
		cross join (select 'TOTO' as sub_prod union all select 'TFOG' as sub_prod) as sp
		
	union all 
	--108 AT_ON_EZLINK----------------------------------------------------------------------- 
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'108'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'NETS'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--110	AT_ON_ATM	Yes	Flashpay transaction --------------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'110'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'Flashpay'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--112	AT_ON_CASHCARD	Yes	Cashcard transaction------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'112'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'CASHCARD'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all
	---116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor-------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	a.prodid as prodid,
	loc.locdisplayid		as locdisplayid,
	'116'		as sales_type,
	sum(coalesce(a.total,0)  - coalesce(can.total,0))	as totalcount, --(8)
	trunc(sum(coalesce(a.amount,0)) / 100, 2) * 100 as totalamount,
	a.sub_prod as sub_prod
  	from 
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
			case
				when pb.prodid=6 then 5 --prematch and live to be one same prodid
				else pb.prodid	end as prodid, --(15)
			case when pb.prodid <> 3 then ''
				when pb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE pb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_tfogBettypes)
					) then 'TFOG' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 
			where pb.iscancelled = false and (
					(
					pb.prodid in (2,3,4) --lottery / es
					and pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC 

					)
					or --(15)
					(
					pb.prodid in (5,6) --sports / ob
					and pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC
					)
					or 
					(
					pb.prodid in (1) --horse racing / bmcs
					and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
					)
				)
			group by a.ticketserialnumber, pb.terdisplayid, pb.prodid,
				case when pb.prodid <> 3 then ''  
					when pb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE pb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_tfogBettypes)
						) then 'TFOG' 
					else 'TOTO' end
		)a
		inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join --(8)
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, cb.terdisplayid, cb.prodid,
			case when cb.prodid <> 3 then ''  
				when cb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE cb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_tfogBettypes)
					) then 'TFOG' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join ubt_temp_cancelledbetticketstate cb on a.ticketserialnumber = cb.ticketserialnumber
			where cb.prodid in (2,3,4) --lottery / es
			group by a.ticketserialnumber, cb.terdisplayid, cb.prodid,
				case when cb.prodid <> 3 then ''  
					when cb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE cb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_tfogBettypes)
						) then 'TFOG' 
					else 'TOTO' end
		)can 
			on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid
			and a.prodid = can.prodid and a.sub_prod = can.sub_prod
		
		group by loc.locdisplayid,ter.terdisplayid,a.prodid, a.sub_prod
	;	
/*	UPDATE T
		SET TotalCount = T.TotalCount
		FROM 
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 116
		)T
		INNER JOIN
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 7
		)FIN ON T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
	--end modify (9)*/

/*update ubt_temp_TmpTerLocPrdSalesAmt T 
set TotalCount = FIN.TotalCount
from (
		SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = '7'
		)FIN 
	where 
	T.sales_type='116' and 
	T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
*/

-- [2022-04-01] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation
create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('001811006', 4, 'TOTO','2021-11-24'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vbusinessdate, vbusinessdate);




DELETE  FROM ubt_temp_tmpterlocprdsalesamt SAL USING ubt_temp_sales_scandsr RS 
where  SAL.TerDisplayID = RS.TerDisplayID 
AND RS.ProdID = SAL.ProdID
AND SAL.Sales_type = '116';




INSERT INTO ubt_temp_tmpterlocprdsalesamt(TerDisplayId, TransactionDate, ProdID, LocDisplayID, Sales_type, TotalCount, Amount, sub_prod)
	SELECT	RS.TerDisplayID	as TerDisplayID,
			vbusinessdate			AS TransactionDate, 
			RS.ProdID			AS ProdID,
			LOC.LocDisplayID		AS LocDisplayID,
			'116'					aS sales_type,
			RS.TotalCount, 
			RS.Amount*100,
			'' as sub_prod
	FROM ubt_temp_sales_scandsr RS
	INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
	INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
	where RS.ActualDate = vbusinessdate;

-- [2022-04-01] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--119	at_salesfactor	yes	sales factor-------------------------------
create temp table if not exists ubt_temp_salesfactorconfig
	(
		prodid int4,
		salesfactor numeric(13,12)
	)
	;
insert into ubt_temp_salesfactorconfig
	select a.prodid, a.salesfactor  from  public.ztubt_salescomconfig  a 
	where commissiontype=1  and a.isdeleted = false and prodid in (2,3,4)
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, '' 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc  where sfc.prodid <> 3
		)sfc
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, sp.sub_prod 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid = 3
		)sfc
		cross join (select 'TOTO' as sub_prod union all select 'TFOG' as sub_prod) as sp
;

insert into 	ubt_temp_tmpterlocprdsalesamt
		SELECT	coalesce(DB.TerDisplayID,CR.TerDisplayID)					AS TerDisplayID,
				coalesce(DB.TransactionDate,CR.TransactionDate)			AS TransactionDate, 
				0														AS ProdID,
				coalesce(DB.LocDisplayID,CR.LocDisplayID)					AS LocDisplayID,
				'727'														AS sales_type,
				0														AS TotalCount,
				SUM(coalesce(DB.Amount,0)) - SUM(coalesce(CR.Amount,0))		AS Amount,
			    '' as sub_prod
		FROM
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type in
			(
				'2', --cancel amount
				'3',	--validation amount
				'7',	--commission amount
				--(7)6, -- GST tax amount
				'108', --NETS transaction
				'110', --Flashpay transaction
				'112', --Cashcard transaction
				--(4)-1 -- refund and rebate
				'4', --rebate
				'61' --refund--(5)5 --refund
			 )
			 AND (prodid :: int) != 31  --(15) exclude offline orders in the net amount due calculation
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) CR
		FULL OUTER JOIN 
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type ='1'	--collection
			AND (prodid :: int)!= 31 
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) DB ON DB.LocDisplayID=CR.LocDisplayID AND DB.TransactionDate=CR.TransactionDate AND DB.TerDisplayID=CR.TerDisplayID
		GROUP BY DB.TerDisplayID, DB.TransactionDate, DB.LocDisplayID,CR.TerDisplayID,CR.TransactionDate, CR.LocDisplayID					
;	

-- for both types of toto
INSERT INTO ubt_temp_tmpterlocprdsalesamt
-- sum tfog and t649
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, sum(totalcount), sum(amount), ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TFOG', 'TOTO') and Sales_type not in ('40', '119', '105')
group by terdisplayid, transactiondate, prodid, locdisplayid, sales_type
union all

-- config - clone TFOG config for product Toto (t649 and tfog)
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TFOG') and Sales_type in ('40', '119', '105');

	
	UPDATE ubt_temp_tmpterlocprdsalesamt td
	SET ProdID = CASE 
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO' THEN 71
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TFOG' THEN 66
					ELSE p.SAPProdID
				END
	FROM public.ztubt_sap_product p
	WHERE td.ProdID::int = p.prodid;

return query
SELECT DISTINCT 
			coalesce(TerDisplayID, '')
			,(TransactionDate :: Date)
			,coalesce(ProdID :: int, 0)
			,coalesce(LocDisplayID, '')
			,coalesce(Sales_type, '')
			,TotalCount
			,Amount
		FROM ubt_temp_tmpterlocprdsalesamt --(12) ubt_temp_FinalTempData--(1)FROM ubt_temp_TmpTerLocPrdSalesAmt
		WHERE (TotalCount!=0 or Amount!=0)
		AND (TransactionDate :: DATE) = vbusinessdate
;
	drop table if exists ubt_temp_tmpterlocprdsalesamt;
	drop table if exists ubt_temp_tmpticketbywageandsales;
	drop table if exists ubt_temp_resultcashlessinterminal;
	drop table if exists ubt_temp_grouptoto;
	drop table if exists ubt_temp_itoto;
	drop table if exists ubt_temp_location;
	drop table if exists ubt_temp_product;
	drop table if exists ubt_temp_salesfactorconfig;
	drop table if exists ubt_temp_salesgrouptoto;
	drop table if exists ubt_temp_salestoto;
	drop table if exists ubt_temp_terminal;
	drop table if exists ubt_temp_transamountdetaildata;
	drop table if exists ubt_temp_cancelledbetticketstate;
	-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
	drop table if exists ubt_temp_sales_scandsr;
	
		
end
;
$$;


ALTER FUNCTION public.sp_ubt_getterminalinvoice_bk20241203(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1214 (class 1255 OID 2381804)
-- Name: sp_ubt_getterminalinvoice_bk20250310(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getterminalinvoice_bk20250310(businessdate date) RETURNS TABLE(terdisplayid character varying, transactiondate date, prodid integer, locdisplayid character varying, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
vbusinessdate date;
vinputdate date;
vstartperiod date;
vendperiod date;
vfromdateIGT timestamp;--@BusinessDateFrom
vtodateIGT timestamp;--@BusinessDateTo
vfromdatetimeIGT_UTC timestamp;
vtodatetimeIGT_UTC timestamp;
vfromdatetimeOB_UTC timestamp;
vtodatetimeOB_UTC timestamp;
vfromdatetimeNonHost_UTC timestamp;
vtodatetimeNonHost_UTC timestamp;
vfromdatetimeBMCS_UTC timestamp;
vtodatetimeBMCS_UTC timestamp;

vactualdate date;
/*DECLARE @BusinessDateFromDATETIME;
DECLARE @BusinessDateToDATETIME;
DECLARE @l_PeriodFromDateNonHostUTCDATETIME
DECLARE @l_PeriodToDateNonHostUTCDATETIME
DECLARE @InsertedDateDATETIME;
DECLARE @l_PeriodFromDateIGTUTC DATETIME
DECLARE @l_PeriodToDateIGTUTC DATETIME
DECLARE @l_PeriodFromDateOBUTC DATETIME --(15)
DECLARE @l_PeriodToDateOBUTC DATETIME --(15)

*/

v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

BEGIN

select businessdate into vbusinessdate;


create temp table if not exists ubt_temp_TmpTerLocPrdSalesAmt
	( 
	terdisplayid varchar(200),
	transactiondate timestamp,
	prodid int4,
	locdisplayid varchar(200),
	sales_type varchar(100),
	totalcount int4,
	amount numeric(32, 11),
	sub_prod varchar(100)
	);


create temp table ubt_temp_terminal as 
	Select Ter.TerDisplayID, Ter.LocID  FROM public.ztubt_Terminal Ter;

create temp table ubt_temp_product as 
	Select PD.ProdID,
	case PD.prodid when 5 then 'SPORTS' else trim(PD.ProdName) end as ProdName  FROM public.ztubt_Product PD
	WHERE PD.ProdID != 6 ;--(15) remove Sports Live so that all Sports refer to ProductID = 5 only

insert into ubt_temp_product (prodid, prodname) values (3, 'TOTO MATCH');


create temp table ubt_temp_Location as
	Select Loc.LocID, Loc.LocDisplayID, Loc.SweepIndicator,Loc.LocTypeID,Loc.IsGST,Loc.AccountNumber,
	Loc.BranchID,Loc.Bankid,Loc.LocName,Loc.IsIBG,Loc.RetID,LOC.CHID
	from public.ztubt_location  Loc;

--GetcommondatesfroUBT

	select 
	fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,utcfromdatetimeob,utctodatetimeob,
	utcfromdatetimenonhost,utctodatetimenonhost, utcfromdatetimebmcs, utctodatetimebmcs
	into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeNonHost_UTC ,
	vtodatetimeNonHost_UTC,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
	from public.sp_ubt_getcommonubtdates(vbusinessdate,vbusinessdate);


create temp table if not exists ubt_temp_TmpTicketByWageAndSales 
	(
	ticketserialnumber varchar(500),
	wager numeric(22,2), 
	secondwager numeric(22,2), 
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2), 
	winningamount numeric(22,2) 
	);

-- from function getamounttransaction

INSERT INTO ubt_temp_TmpTicketByWageAndSales
 select * from  public.sp_ubt_getamounttransaction(vbusinessdate,vbusinessdate);




create temp table if not exists ubt_temp_ResultCashlessInTerminal 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(22, 11),
	ct int4
	);

insert into ubt_temp_ResultCashlessInTerminal

	select  pd.terdisplayid, 'NETS', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NC','NN') 
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC 
	group by pd.terdisplayid
	
	union all 
	select pd.terdisplayid, 'CASHCARD', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NCC') --cashcard
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	
	union all
	
	select pd.terdisplayid, 'Flashpay', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NFP') --Flashpay
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	;

create temp table if not exists ubt_temp_iTOTO
	(
	ticketserialnumber varchar(200),
	itotoindicator bool,
	groupunitsequence int4,
	bettype int4
	)
;
INSERT INTO ubt_temp_iTOTO
	select distinct ticketserialnumber, itotoindicator, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where ((groupunitsequence = 1) --group toto
	or (itotoindicator = true)) --itoto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
;


create temp table if not exists ubt_temp_GroupTOTO
	(
	ticketserialnumber varchar(200),
	grouphostid varchar(50),
	groupunitsequence int4,
	bettype int4
	);

insert into ubt_temp_grouptoto
	select distinct ticketserialnumber, grouphostid, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where groupunitsequence is not null --group toto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC  )
;

create temp table ubt_temp_CancelledBetTicketState as 
	select cb.cartid,cb.terdisplayid,cb.ticketserialnumber,cb.tranheaderid,cb.cancelleddate ,cb.cancelledamout,cb.prodid 
	from  public.ztubt_cancelledbetticket  cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
   on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateIGT and vtodateIGT
;


create temp table if not exists ubt_temp_SalesGroupToto
(
	terdisplayid varchar(200),
	prodid int4,
	locdisplayid varchar(200),
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --Sales of each product (Wager * Sales Factor)
);

insert into ubt_temp_SalesGroupToto(terdisplayid, prodid, locdisplayid,bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid, 
	3 as prodid, 
	loc.locdisplayid as locdisplayid,
	fin.bettype as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal,  
	count(distinct can.ticketserialnumber)	as canceltotal,
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
		
		left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)can on pbth.ticketserialnumber = can.ticketserialnumber
		
	where  
	pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by  ter.terdisplayid,loc.locdisplayid, fin.bettype
	;

create temp table if not exists ubt_temp_salestoto 
	(
	terdisplayid varchar(200),
	locdisplayid varchar(200),
	prodid int4,
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);

insert into ubt_temp_salestoto(terdisplayid, locdisplayid,prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid		as terdisplayid,	
	loc.locdisplayid			as locdisplayid,
	3		as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1)		as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	public.ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)can on pbth.ticketserialnumber = can.ticketserialnumber

	where pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by ter.terdisplayid,loc.locdisplayid
	;

--FILL IN TRANS AMOUNT DETAIL DATA
		
create temp table if not exists ubt_temp_transamountdetaildata 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(32, 13),
	ct int4,
	flag char(3),
	transtype char(2),
	fromdate date,
	todate date
	);
Insert Into ubt_temp_transamountdetaildata
	select terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
	from public.sp_ubt_gettransamountdetails (vbusinessdate,vbusinessdate);


-- insert all data

insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='COL' and transtype != 'OO' and prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all
	
	--offline orders - wager
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' 
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	
	----2	AT_CANCELAMT	Yes	cancel amount
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'2'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='CAN' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	
	---3	AT_VALIDAMT	Yes	validation amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'3'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='PAY' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---4	Rebate Amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'4'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod  
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RBT' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	union all
	--61	Refund Amount--(4)(5)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RFD' AND TransType != 'OO' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	--offline orders - refund
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
		where flag='RFD' AND TransType = 'OO' 
		group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--6	AT_TAXAMT 	Yes	tax amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'6'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='GST' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---7	AT_COMMAMT	Yes	commission amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'7'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='SAL' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
		
	------16. AT_FRACVALAMT  Show fractional validation amounts [Validation amounts for GROUP TOTO - This is a subset of Sales Type  3]
	union all
	
	select	ter.terdisplayid				as terdisplayid,
	vbusinessdate transactiondate,
	3		as prodid,
	loc.locdisplayid	as locdisplayid,
	'16'		as sales_type,
	count(distinct vb.tranheaderid)	as totalcount, 
	sum(coalesce(vb.winningamount,0))	as totalamount,
	case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	from --(1)
	(
		select vb.tranheaderid,vb.winningamount,vb.cartid,vb.terdisplayid,vb.createdvalidationdate 
		from public.ztubt_validatedbetticket  vb --(16)
		inner join public.ztubt_validatedbetticketlifecyclestate  vbt
		on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
		where vb.winningamount != 0 and vb.winningamount is not null --(8)
		and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	)vb
	inner join 
	(
		select distinct tranheaderid, grouphostid, groupunitsequence, bettypeid from public.ztubt_toto_placedbettransactionlineitem
	)ph on vb.tranheaderid = ph.tranheaderid --(16)
	inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where ph.groupunitsequence is not null --(16)
	group by loc.locdisplayid,ter.terdisplayid,
	case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
		else 'TOTO MATCH' end
	
	union all 
	--52. House syndicate sales amount - [iTOTO sales  this is a subset of sales type 1]
	--TOTO
	select	s.terdisplayid			as terdisplayid,
	vbusinessdate	as transactiondate, 
	s.prodid	as prodid, 
	s.locdisplayid as locdisplayid,
	'52' as sales_type, 
	sum(coalesce(s.wagertotal,0))		as totalcount, 
	sum(coalesce(s.wageramount,0))	as totalamount,
	'TOTO' as sub_prod
	from ubt_temp_salestoto s
	group by s.terdisplayid, s.prodid, s.locdisplayid
		
	union all 
	--25. House syndicate sales amount by sales factor [iTOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO
	select	s.terdisplayid	as terdisplayid,
	vbusinessdate		as transactiondate, 
	3	as prodid,
	s.locdisplayid	as locdisplayid,
	'25'	as sales_type,
	sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))		as totalcount, 
	trunc(sum(coalesce(s.salesamount,0)) / 100 , 2) * 100	as totalamount ,
	'TOTO' as sub_prod 
	from ubt_temp_salestoto s
	group by s.locdisplayid,s.terdisplayid
	
	union all 
	--40. GST TAX rate--------------------------------------------------------------------
	
	select	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate,
	prd.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'40'		as sales_type,
	0		as totalcount ,
	gst.gstrate,
	prd.prodname as sub_prod
	from	
	(
		select loc.locdisplayid, ter.terdisplayid from ubt_temp_location loc
		inner join ubt_temp_terminal ter on loc.locid = ter.locid
		where loc.isgst = true
	)loc
	cross join 
	(
		select * from ubt_temp_product where prodid in (2,3,4) --lottery / es
	)prd
	cross join
	(
		select gstrate from public.ztubt_gstconfig a 
		where (vbusinessdate between effectivefrom and enddate) or (vbusinessdate >=effectivefrom and enddate is null) limit 1
		--check this code
	)gst
	
	union all 
--59. House syndicate cancel amount - [iTOTO cancellations  This is a Sub Set of Sales Type 2]
	--TOTO
	select	cb.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	3		as prodid, 
	loc.locdisplayid as locdisplayid,
	'59'		as sales_type, 
	count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)as totalcount, 
	sum(coalesce (cb.cancelledamout,0))as totalamount,
	'TOTO' as sub_prod
	from ubt_temp_cancelledbetticketstate cb 
	inner join ubt_temp_itoto itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true 
	inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where cb.prodid = 3 --(1)and tpbtli.itotoindicator = 1
	 and cb.cancelleddate between vfromdateIGT and vtodateIGT
	group by cb.terdisplayid,loc.locdisplayid
	
	union all 
	---60. Player syndicate sales amount by sales factor - [GROUP TOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO, totomatch
	SELECT S.TerDisplayID AS TerDisplayID ,
	 vbusinessdate	AS TransactionDate, 
	S.ProdID	AS ProdID,
	S.LocDisplayID AS LocDisplayID,
	'60' AS sales_type, 
	SUM(coalesce(S.WagerTotal,0)  - coalesce(S.CancelTotal,0))	AS TotalCount,--(8)
	trunc(SUM(coalesce(s.SalesAmount,0)) / 100 , 2) * 100	AS TotalAmount,
	case when S.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY  S.TerDisplayID,S.ProdID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end

	union all 
	
	--69. Player syndicate sales amount - [GROUP TOTO Sales  This is a subset of Sales Type 1]----------
	--TOTO, totomatch
	SELECT	S.TerDisplayID			AS TerDisplayID,
	vbusinessdate	AS TransactionDate,
	3 AS ProdID, 
	S.LocDisplayID AS LocDisplayID,
	'69' AS sales_type,
	SUM(COALESCE(S.WagerTotal,0))AS TotalCount, 
	SUM(COALESCE(S.WagerAmount,0))		AS TotalAmount,--(1)COALESCE(S.Amount,0)		AS TotalAmount
	case when S.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY S.TerDisplayID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end

	union all
	--70 [	 GROUP TOTO Cancel Amount  This is a subset of Sales Type 2]-----------------------------------
	--TOTO, totomatch
	select			cbt.terdisplayid as terdisplayid,
	vbusinessdate	as transactiondate, 
	3				as prodid,
	loc.locdisplayid	as locdisplayid,
	'70'				as sales_type, 
	count(distinct gt.grouphostid)	as totalcount, 
	sum(coalesce (cbt.cancelledamout,0))	as totalamount,
	case when gt.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	from ubt_temp_cancelledbetticketstate cbt
	inner join ubt_temp_grouptoto gt on cbt.ticketserialnumber = gt.ticketserialnumber
	inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where  cbt.prodid = 3  
	and cbt.cancelleddate between vfromdateIGT and vtodateIGT 
	group by cbt.terdisplayid,loc.locdisplayid,
		case when gt.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end
	
	union all 
	--105 Sales Commision Rate
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
    '' as sub_prod
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid in (2,4) --lottery / es
		)sal
		
	union all 
	--TOTO, totomatch
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
	sp.sub_prod 
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid = 3 
		)sal
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp
		
	union all 
	--108 AT_ON_EZLINK----------------------------------------------------------------------- 
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'108'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'NETS'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--110	AT_ON_ATM	Yes	Flashpay transaction --------------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'110'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'Flashpay'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--112	AT_ON_CASHCARD	Yes	Cashcard transaction------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'112'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'CASHCARD'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all
	---116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor-------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	a.prodid as prodid,
	loc.locdisplayid		as locdisplayid,
	'116'		as sales_type,
	sum(coalesce(a.total,0)  - coalesce(can.total,0))	as totalcount, --(8)
	trunc(sum(coalesce(a.amount,0)) / 100, 2) * 100 as totalamount,
	a.sub_prod as sub_prod
  	from 
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
			case
				when pb.prodid=6 then 5 --prematch and live to be one same prodid
				else pb.prodid	end as prodid, --(15)
			case when pb.prodid <> 3 then ''
				when pb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE pb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
					) then 'TOTO MATCH' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 
			where pb.iscancelled = false and (
					(
					pb.prodid in (2,3,4) --lottery / es
					and pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC 

					)
					or --(15)
					(
					pb.prodid in (5,6) --sports / ob
					and pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC
					)
					or 
					(
					pb.prodid in (1) --horse racing / bmcs
					and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
					)
				)
			group by a.ticketserialnumber, pb.terdisplayid, pb.prodid,
				case when pb.prodid <> 3 then ''  
					when pb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE pb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
						) then 'TOTO MATCH' 
					else 'TOTO' end
		)a
		inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join --(8)
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, cb.terdisplayid, cb.prodid,
			case when cb.prodid <> 3 then ''  
				when cb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE cb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
					) then 'TOTO MATCH' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join ubt_temp_cancelledbetticketstate cb on a.ticketserialnumber = cb.ticketserialnumber
			where cb.prodid in (2,3,4) --lottery / es
			group by a.ticketserialnumber, cb.terdisplayid, cb.prodid,
				case when cb.prodid <> 3 then ''  
					when cb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE cb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
						) then 'TOTO MATCH' 
					else 'TOTO' end
		)can 
			on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid
			and a.prodid = can.prodid and a.sub_prod = can.sub_prod
		
		group by loc.locdisplayid,ter.terdisplayid,a.prodid, a.sub_prod
	;	
/*	UPDATE T
		SET TotalCount = T.TotalCount
		FROM 
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 116
		)T
		INNER JOIN
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 7
		)FIN ON T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
	--end modify (9)*/

/*update ubt_temp_TmpTerLocPrdSalesAmt T 
set TotalCount = FIN.TotalCount
from (
		SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = '7'
		)FIN 
	where 
	T.sales_type='116' and 
	T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
*/

-- [2022-04-01] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation
create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('001811006', 4, 'TOTO','2021-11-24'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vbusinessdate, vbusinessdate);




DELETE  FROM ubt_temp_tmpterlocprdsalesamt SAL USING ubt_temp_sales_scandsr RS 
where  SAL.TerDisplayID = RS.TerDisplayID 
AND RS.ProdID = SAL.ProdID
AND SAL.Sales_type = '116';




INSERT INTO ubt_temp_tmpterlocprdsalesamt(TerDisplayId, TransactionDate, ProdID, LocDisplayID, Sales_type, TotalCount, Amount, sub_prod)
	SELECT	RS.TerDisplayID	as TerDisplayID,
			vbusinessdate			AS TransactionDate, 
			RS.ProdID			AS ProdID,
			LOC.LocDisplayID		AS LocDisplayID,
			'116'					aS sales_type,
			RS.TotalCount, 
			RS.Amount*100,
			'' as sub_prod
	FROM ubt_temp_sales_scandsr RS
	INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
	INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
	where RS.ActualDate = vbusinessdate;

-- [2022-04-01] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--119	at_salesfactor	yes	sales factor-------------------------------
create temp table if not exists ubt_temp_salesfactorconfig
	(
		prodid int4,
		salesfactor numeric(13,12)
	)
	;
insert into ubt_temp_salesfactorconfig
	select a.prodid, a.salesfactor  from  public.ztubt_salescomconfig  a 
	where commissiontype=1  and a.isdeleted = false and prodid in (2,3,4)
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, '' 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc  where sfc.prodid <> 3
		)sfc
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, sp.sub_prod 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid = 3
		)sfc
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp
;

insert into 	ubt_temp_tmpterlocprdsalesamt
		SELECT	coalesce(DB.TerDisplayID,CR.TerDisplayID)					AS TerDisplayID,
				coalesce(DB.TransactionDate,CR.TransactionDate)			AS TransactionDate, 
				0														AS ProdID,
				coalesce(DB.LocDisplayID,CR.LocDisplayID)					AS LocDisplayID,
				'727'														AS sales_type,
				0														AS TotalCount,
				SUM(coalesce(DB.Amount,0)) - SUM(coalesce(CR.Amount,0))		AS Amount,
			    '' as sub_prod
		FROM
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type in
			(
				'2', --cancel amount
				'3',	--validation amount
				'7',	--commission amount
				--(7)6, -- GST tax amount
				'108', --NETS transaction
				'110', --Flashpay transaction
				'112', --Cashcard transaction
				--(4)-1 -- refund and rebate
				'4', --rebate
				'61' --refund--(5)5 --refund
			 )
			 AND (prodid :: int) != 31  --(15) exclude offline orders in the net amount due calculation
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) CR
		FULL OUTER JOIN 
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type ='1'	--collection
			AND (prodid :: int)!= 31 
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) DB ON DB.LocDisplayID=CR.LocDisplayID AND DB.TransactionDate=CR.TransactionDate AND DB.TerDisplayID=CR.TerDisplayID
		GROUP BY DB.TerDisplayID, DB.TransactionDate, DB.LocDisplayID,CR.TerDisplayID,CR.TransactionDate, CR.LocDisplayID					
;	

-- for both types of toto
INSERT INTO ubt_temp_tmpterlocprdsalesamt
-- sum totomatch and t649
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, sum(totalcount), sum(amount), ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TOTO MATCH', 'TOTO') and Sales_type not in ('40', '119', '105')
group by terdisplayid, transactiondate, prodid, locdisplayid, sales_type
union all

-- config - clone totomatch config for product Toto (t649 and totomatch)
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TOTO MATCH') and Sales_type in ('40', '119', '105');

	
	UPDATE ubt_temp_tmpterlocprdsalesamt td
	SET ProdID = CASE 
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO' THEN 71
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO MATCH' THEN 66
					ELSE p.SAPProdID
				END
	FROM public.ztubt_sap_product p
	WHERE td.ProdID::int = p.prodid;

return query
SELECT DISTINCT 
			coalesce(TerDisplayID, '')
			,(TransactionDate :: Date)
			,coalesce(ProdID :: int, 0)
			,coalesce(LocDisplayID, '')
			,coalesce(Sales_type, '')
			,TotalCount
			,Amount
		FROM ubt_temp_tmpterlocprdsalesamt --(12) ubt_temp_FinalTempData--(1)FROM ubt_temp_TmpTerLocPrdSalesAmt
		WHERE (TotalCount!=0 or Amount!=0)
		AND (TransactionDate :: DATE) = vbusinessdate
;
	drop table if exists ubt_temp_tmpterlocprdsalesamt;
	drop table if exists ubt_temp_tmpticketbywageandsales;
	drop table if exists ubt_temp_resultcashlessinterminal;
	drop table if exists ubt_temp_grouptoto;
	drop table if exists ubt_temp_itoto;
	drop table if exists ubt_temp_location;
	drop table if exists ubt_temp_product;
	drop table if exists ubt_temp_salesfactorconfig;
	drop table if exists ubt_temp_salesgrouptoto;
	drop table if exists ubt_temp_salestoto;
	drop table if exists ubt_temp_terminal;
	drop table if exists ubt_temp_transamountdetaildata;
	drop table if exists ubt_temp_cancelledbetticketstate;
	-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
	drop table if exists ubt_temp_sales_scandsr;
	
		
end
;
$$;


ALTER FUNCTION public.sp_ubt_getterminalinvoice_bk20250310(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1164 (class 1255 OID 2212536)
-- Name: sp_ubt_getterminalinvoice_bk20250326(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getterminalinvoice_bk20250326(businessdate date) RETURNS TABLE(terdisplayid character varying, transactiondate date, prodid integer, locdisplayid character varying, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
vbusinessdate date;
vinputdate date;
vstartperiod date;
vendperiod date;
vfromdateIGT timestamp;--@BusinessDateFrom
vtodateIGT timestamp;--@BusinessDateTo
vfromdatetimeIGT_UTC timestamp;
vtodatetimeIGT_UTC timestamp;
vfromdatetimeOB_UTC timestamp;
vtodatetimeOB_UTC timestamp;
vfromdatetimeNonHost_UTC timestamp;
vtodatetimeNonHost_UTC timestamp;
vfromdatetimeBMCS_UTC timestamp;
vtodatetimeBMCS_UTC timestamp;

vactualdate date;
/*DECLARE @BusinessDateFromDATETIME;
DECLARE @BusinessDateToDATETIME;
DECLARE @l_PeriodFromDateNonHostUTCDATETIME
DECLARE @l_PeriodToDateNonHostUTCDATETIME
DECLARE @InsertedDateDATETIME;
DECLARE @l_PeriodFromDateIGTUTC DATETIME
DECLARE @l_PeriodToDateIGTUTC DATETIME
DECLARE @l_PeriodFromDateOBUTC DATETIME --(15)
DECLARE @l_PeriodToDateOBUTC DATETIME --(15)

*/

v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

BEGIN

select businessdate into vbusinessdate;


create temp table if not exists ubt_temp_TmpTerLocPrdSalesAmt
	( 
	terdisplayid varchar(200),
	transactiondate timestamp,
	prodid int4,
	locdisplayid varchar(200),
	sales_type varchar(100),
	totalcount int4,
	amount numeric(32, 11),
	sub_prod varchar(100)
	);


create temp table ubt_temp_terminal as 
	Select Ter.TerDisplayID, Ter.LocID  FROM public.ztubt_Terminal Ter;

create temp table ubt_temp_product as 
	Select PD.ProdID,
	case PD.prodid when 5 then 'SPORTS' else trim(PD.ProdName) end as ProdName  FROM public.ztubt_Product PD
	WHERE PD.ProdID != 6 ;--(15) remove Sports Live so that all Sports refer to ProductID = 5 only

insert into ubt_temp_product (prodid, prodname) values (3, 'TOTO MATCH');


create temp table ubt_temp_Location as
	Select Loc.LocID, Loc.LocDisplayID, Loc.SweepIndicator,Loc.LocTypeID,Loc.IsGST,Loc.AccountNumber,
	Loc.BranchID,Loc.Bankid,Loc.LocName,Loc.IsIBG,Loc.RetID,LOC.CHID
	from public.ztubt_location  Loc;

--GetcommondatesfroUBT

	select 
	fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,utcfromdatetimeob,utctodatetimeob,
	utcfromdatetimenonhost,utctodatetimenonhost, utcfromdatetimebmcs, utctodatetimebmcs
	into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeNonHost_UTC ,
	vtodatetimeNonHost_UTC,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
	from public.sp_ubt_getcommonubtdates(vbusinessdate,vbusinessdate);


create temp table if not exists ubt_temp_TmpTicketByWageAndSales 
	(
	ticketserialnumber varchar(500),
	wager numeric(22,2), 
	secondwager numeric(22,2), 
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2), 
	winningamount numeric(22,2) 
	);

-- from function getamounttransaction

INSERT INTO ubt_temp_TmpTicketByWageAndSales
 select * from  public.sp_ubt_getamounttransaction(vbusinessdate,vbusinessdate);




create temp table if not exists ubt_temp_ResultCashlessInTerminal 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(22, 11),
	ct int4
	);

insert into ubt_temp_ResultCashlessInTerminal

	select  pd.terdisplayid, 'NETS', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NC','NN') 
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC 
	group by pd.terdisplayid
	
	union all 
	select pd.terdisplayid, 'CASHCARD', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NCC') --cashcard
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	
	union all
	
	select pd.terdisplayid, 'Flashpay', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NFP') --Flashpay
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	;

create temp table if not exists ubt_temp_iTOTO
	(
	ticketserialnumber varchar(200),
	itotoindicator bool,
	groupunitsequence int4,
	bettype int4
	)
;
INSERT INTO ubt_temp_iTOTO
	select distinct ticketserialnumber, itotoindicator, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where ((groupunitsequence = 1) --group toto
	or (itotoindicator = true)) --itoto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
;


create temp table if not exists ubt_temp_GroupTOTO
	(
	ticketserialnumber varchar(200),
	grouphostid varchar(50),
	groupunitsequence int4,
	bettype int4
	);

insert into ubt_temp_grouptoto
	select distinct ticketserialnumber, grouphostid, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where groupunitsequence is not null --group toto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC  )
;

create temp table ubt_temp_CancelledBetTicketState as 
	select cb.cartid,cb.terdisplayid,cb.ticketserialnumber,cb.tranheaderid,cb.cancelleddate ,cb.cancelledamout,cb.prodid 
	from  public.ztubt_cancelledbetticket  cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
   on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateIGT and vtodateIGT
;


create temp table if not exists ubt_temp_SalesGroupToto
(
	terdisplayid varchar(200),
	prodid int4,
	locdisplayid varchar(200),
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --Sales of each product (Wager * Sales Factor)
);

insert into ubt_temp_SalesGroupToto(terdisplayid, prodid, locdisplayid,bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid, 
	3 as prodid, 
	loc.locdisplayid as locdisplayid,
	fin.bettype as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal,  
	count(distinct can.ticketserialnumber)	as canceltotal,
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
		
		left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)can on pbth.ticketserialnumber = can.ticketserialnumber
		
	where  
	pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by  ter.terdisplayid,loc.locdisplayid, fin.bettype
	;

create temp table if not exists ubt_temp_salestoto 
	(
	terdisplayid varchar(200),
	locdisplayid varchar(200),
	prodid int4,
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);

insert into ubt_temp_salestoto(terdisplayid, locdisplayid,prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid		as terdisplayid,	
	loc.locdisplayid			as locdisplayid,
	3		as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1)		as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	public.ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)can on pbth.ticketserialnumber = can.ticketserialnumber

	where pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by ter.terdisplayid,loc.locdisplayid
	;

--FILL IN TRANS AMOUNT DETAIL DATA
		
create temp table if not exists ubt_temp_transamountdetaildata 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(32, 13),
	ct int4,
	flag char(3),
	transtype char(2),
	fromdate date,
	todate date
	);
Insert Into ubt_temp_transamountdetaildata
	select terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
	from public.sp_ubt_gettransamountdetails (vbusinessdate,vbusinessdate);


-- insert all data

insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='COL' and transtype != 'OO' and prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all
	
	--offline orders - wager
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' 
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	
	----2	AT_CANCELAMT	Yes	cancel amount
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'2'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='CAN' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	
	---3	AT_VALIDAMT	Yes	validation amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'3'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='PAY' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---4	Rebate Amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'4'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod  
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RBT' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	union all
	--61	Refund Amount--(4)(5)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RFD' AND TransType != 'OO' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	--offline orders - refund
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
		where flag='RFD' AND TransType = 'OO' 
		group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--6	AT_TAXAMT 	Yes	tax amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'6'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='GST' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---7	AT_COMMAMT	Yes	commission amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'7'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='SAL' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
		
	------16. AT_FRACVALAMT  Show fractional validation amounts [Validation amounts for GROUP TOTO - This is a subset of Sales Type  3]
	union all
	
	select	ter.terdisplayid				as terdisplayid,
	vbusinessdate transactiondate,
	3		as prodid,
	loc.locdisplayid	as locdisplayid,
	'16'		as sales_type,
	count(distinct vb.tranheaderid)	as totalcount, 
	sum(coalesce(vb.winningamount,0))	as totalamount,
	case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	from --(1)
	(
		select vb.tranheaderid,vb.winningamount,vb.cartid,vb.terdisplayid,vb.createdvalidationdate 
		from public.ztubt_validatedbetticket  vb --(16)
		inner join public.ztubt_validatedbetticketlifecyclestate  vbt
		on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
		where vb.winningamount != 0 and vb.winningamount is not null --(8)
		and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	)vb
	inner join 
	(
		select distinct tranheaderid, grouphostid, groupunitsequence, bettypeid from public.ztubt_toto_placedbettransactionlineitem
	)ph on vb.tranheaderid = ph.tranheaderid --(16)
	inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where ph.groupunitsequence is not null --(16)
	group by loc.locdisplayid,ter.terdisplayid,
	case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
		else 'TOTO MATCH' end
	
	union all 
	--52. House syndicate sales amount - [iTOTO sales  this is a subset of sales type 1]
	--TOTO
	select	s.terdisplayid			as terdisplayid,
	vbusinessdate	as transactiondate, 
	s.prodid	as prodid, 
	s.locdisplayid as locdisplayid,
	'52' as sales_type, 
	sum(coalesce(s.wagertotal,0))		as totalcount, 
	sum(coalesce(s.wageramount,0))	as totalamount,
	'TOTO' as sub_prod
	from ubt_temp_salestoto s
	group by s.terdisplayid, s.prodid, s.locdisplayid
		
	union all 
	--25. House syndicate sales amount by sales factor [iTOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO
	select	s.terdisplayid	as terdisplayid,
	vbusinessdate		as transactiondate, 
	3	as prodid,
	s.locdisplayid	as locdisplayid,
	'25'	as sales_type,
	sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))		as totalcount, 
	trunc(sum(coalesce(s.salesamount,0)) / 100 , 2) * 100	as totalamount ,
	'TOTO' as sub_prod 
	from ubt_temp_salestoto s
	group by s.locdisplayid,s.terdisplayid
	
	union all 
	--40. GST TAX rate--------------------------------------------------------------------
	
	select	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate,
	prd.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'40'		as sales_type,
	0		as totalcount ,
	gst.gstrate,
	prd.prodname as sub_prod
	from	
	(
		select loc.locdisplayid, ter.terdisplayid from ubt_temp_location loc
		inner join ubt_temp_terminal ter on loc.locid = ter.locid
		where loc.isgst = true
	)loc
	cross join 
	(
		select * from ubt_temp_product where prodid in (2,3,4) --lottery / es
	)prd
	cross join
	(
		select gstrate from public.ztubt_gstconfig a 
		where (vbusinessdate between effectivefrom and enddate) or (vbusinessdate >=effectivefrom and enddate is null) limit 1
		--check this code
	)gst
	
	union all 
--59. House syndicate cancel amount - [iTOTO cancellations  This is a Sub Set of Sales Type 2]
	--TOTO
	select	cb.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	3		as prodid, 
	loc.locdisplayid as locdisplayid,
	'59'		as sales_type, 
	count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)as totalcount, 
	sum(coalesce (cb.cancelledamout,0))as totalamount,
	'TOTO' as sub_prod
	from ubt_temp_cancelledbetticketstate cb 
	inner join ubt_temp_itoto itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true 
	inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where cb.prodid = 3 --(1)and tpbtli.itotoindicator = 1
	 and cb.cancelleddate between vfromdateIGT and vtodateIGT
	group by cb.terdisplayid,loc.locdisplayid
	
	union all 
	---60. Player syndicate sales amount by sales factor - [GROUP TOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO, totomatch
	SELECT S.TerDisplayID AS TerDisplayID ,
	 vbusinessdate	AS TransactionDate, 
	S.ProdID	AS ProdID,
	S.LocDisplayID AS LocDisplayID,
	'60' AS sales_type, 
	SUM(coalesce(S.WagerTotal,0)  - coalesce(S.CancelTotal,0))	AS TotalCount,--(8)
	trunc(SUM(coalesce(s.SalesAmount,0)) / 100 , 2) * 100	AS TotalAmount,
	case when S.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY  S.TerDisplayID,S.ProdID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end

	union all 
	
	--69. Player syndicate sales amount - [GROUP TOTO Sales  This is a subset of Sales Type 1]----------
	--TOTO, totomatch
	SELECT	S.TerDisplayID			AS TerDisplayID,
	vbusinessdate	AS TransactionDate,
	3 AS ProdID, 
	S.LocDisplayID AS LocDisplayID,
	'69' AS sales_type,
	SUM(COALESCE(S.WagerTotal,0))AS TotalCount, 
	SUM(COALESCE(S.WagerAmount,0))		AS TotalAmount,--(1)COALESCE(S.Amount,0)		AS TotalAmount
	case when S.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY S.TerDisplayID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end

	union all
	--70 [	 GROUP TOTO Cancel Amount  This is a subset of Sales Type 2]-----------------------------------
	--TOTO, totomatch
	select			cbt.terdisplayid as terdisplayid,
	vbusinessdate	as transactiondate, 
	3				as prodid,
	loc.locdisplayid	as locdisplayid,
	'70'				as sales_type, 
	count(distinct gt.grouphostid)	as totalcount, 
	sum(coalesce (cbt.cancelledamout,0))	as totalamount,
	case when gt.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	from ubt_temp_cancelledbetticketstate cbt
	inner join ubt_temp_grouptoto gt on cbt.ticketserialnumber = gt.ticketserialnumber
	inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where  cbt.prodid = 3  
	and cbt.cancelleddate between vfromdateIGT and vtodateIGT 
	group by cbt.terdisplayid,loc.locdisplayid,
		case when gt.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end
	
	union all 
	--105 Sales Commision Rate
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
    '' as sub_prod
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid in (2,4) --lottery / es
		)sal
		
	union all 
	--TOTO, totomatch
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
	sp.sub_prod 
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid = 3 
		)sal
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp
		
	union all 
	--108 AT_ON_EZLINK----------------------------------------------------------------------- 
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'108'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'NETS'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--110	AT_ON_ATM	Yes	Flashpay transaction --------------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'110'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'Flashpay'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--112	AT_ON_CASHCARD	Yes	Cashcard transaction------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'112'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'CASHCARD'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all
	---116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor-------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	a.prodid as prodid,
	loc.locdisplayid		as locdisplayid,
	'116'		as sales_type,
	sum(coalesce(a.total,0)  - coalesce(can.total,0))	as totalcount, --(8)
	trunc(sum(coalesce(a.amount,0)) / 100, 2) * 100 as totalamount,
	a.sub_prod as sub_prod
  	from 
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
			case
				when pb.prodid=6 then 5 --prematch and live to be one same prodid
				else pb.prodid	end as prodid, --(15)
			case when pb.prodid <> 3 then ''
				when pb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE pb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
					) then 'TOTO MATCH' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 
			where pb.iscancelled = false and (
					(
					pb.prodid in (2,3,4) --lottery / es
					and pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC 

					)
					or --(15)
					(
					pb.prodid in (5,6) --sports / ob
					and pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC
					)
					or 
					(
					pb.prodid in (1) --horse racing / bmcs
					and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
					)
				)
			group by a.ticketserialnumber, pb.terdisplayid, pb.prodid,
				case when pb.prodid <> 3 then ''  
					when pb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE pb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
						) then 'TOTO MATCH' 
					else 'TOTO' end
		)a
		inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join --(8)
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, cb.terdisplayid, cb.prodid,
			case when cb.prodid <> 3 then ''  
				when cb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE cb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
					) then 'TOTO MATCH' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join ubt_temp_cancelledbetticketstate cb on a.ticketserialnumber = cb.ticketserialnumber
			where cb.prodid in (2,3,4) --lottery / es
			group by a.ticketserialnumber, cb.terdisplayid, cb.prodid,
				case when cb.prodid <> 3 then ''  
					when cb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE cb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
						) then 'TOTO MATCH' 
					else 'TOTO' end
		)can 
			on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid
			and a.prodid = can.prodid and a.sub_prod = can.sub_prod
		
		group by loc.locdisplayid,ter.terdisplayid,a.prodid, a.sub_prod
	;	
/*	UPDATE T
		SET TotalCount = T.TotalCount
		FROM 
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 116
		)T
		INNER JOIN
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 7
		)FIN ON T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
	--end modify (9)*/

/*update ubt_temp_TmpTerLocPrdSalesAmt T 
set TotalCount = FIN.TotalCount
from (
		SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = '7'
		)FIN 
	where 
	T.sales_type='116' and 
	T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
*/

-- [2022-04-01] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation
create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('001811006', 4, 'TOTO','2021-11-24'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vbusinessdate, vbusinessdate);




DELETE  FROM ubt_temp_tmpterlocprdsalesamt SAL USING ubt_temp_sales_scandsr RS 
where  SAL.TerDisplayID = RS.TerDisplayID 
AND RS.ProdID = SAL.ProdID
AND SAL.Sales_type = '116';




INSERT INTO ubt_temp_tmpterlocprdsalesamt(TerDisplayId, TransactionDate, ProdID, LocDisplayID, Sales_type, TotalCount, Amount, sub_prod)
	SELECT	RS.TerDisplayID	as TerDisplayID,
			vbusinessdate			AS TransactionDate, 
			RS.ProdID			AS ProdID,
			LOC.LocDisplayID		AS LocDisplayID,
			'116'					aS sales_type,
			RS.TotalCount, 
			RS.Amount*100,
			'' as sub_prod
	FROM ubt_temp_sales_scandsr RS
	INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
	INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
	where RS.ActualDate = vbusinessdate;

-- [2022-04-01] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--119	at_salesfactor	yes	sales factor-------------------------------
create temp table if not exists ubt_temp_salesfactorconfig
	(
		prodid int4,
		salesfactor numeric(13,12)
	)
	;
insert into ubt_temp_salesfactorconfig
	select a.prodid, a.salesfactor  from  public.ztubt_salescomconfig  a 
	where commissiontype=1  and a.isdeleted = false and prodid in (2,3,4)
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, '' 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc  where sfc.prodid <> 3
		)sfc
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, sp.sub_prod 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid = 3
		)sfc
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp
;

insert into 	ubt_temp_tmpterlocprdsalesamt
		SELECT	coalesce(DB.TerDisplayID,CR.TerDisplayID)					AS TerDisplayID,
				coalesce(DB.TransactionDate,CR.TransactionDate)			AS TransactionDate, 
				0														AS ProdID,
				coalesce(DB.LocDisplayID,CR.LocDisplayID)					AS LocDisplayID,
				'727'														AS sales_type,
				0														AS TotalCount,
				SUM(coalesce(DB.Amount,0)) - SUM(coalesce(CR.Amount,0))		AS Amount,
			    '' as sub_prod
		FROM
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type in
			(
				'2', --cancel amount
				'3',	--validation amount
				'7',	--commission amount
				--(7)6, -- GST tax amount
				'108', --NETS transaction
				'110', --Flashpay transaction
				'112', --Cashcard transaction
				--(4)-1 -- refund and rebate
				'4', --rebate
				'61' --refund--(5)5 --refund
			 )
			 AND (prodid :: int) != 31  --(15) exclude offline orders in the net amount due calculation
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) CR
		FULL OUTER JOIN 
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type ='1'	--collection
			AND (prodid :: int)!= 31 
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) DB ON DB.LocDisplayID=CR.LocDisplayID AND DB.TransactionDate=CR.TransactionDate AND DB.TerDisplayID=CR.TerDisplayID
		GROUP BY DB.TerDisplayID, DB.TransactionDate, DB.LocDisplayID,CR.TerDisplayID,CR.TransactionDate, CR.LocDisplayID					
;	

-- for both types of toto
INSERT INTO ubt_temp_tmpterlocprdsalesamt
-- sum totomatch and t649
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, sum(totalcount), sum(amount), ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TOTO MATCH', 'TOTO') and Sales_type not in ('40', '119', '105')
group by terdisplayid, transactiondate, prodid, locdisplayid, sales_type
union all

-- config - clone totomatch config for product Toto (t649 and totomatch)
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TOTO MATCH') and Sales_type in ('40', '119', '105');

	
	UPDATE ubt_temp_tmpterlocprdsalesamt td
	SET ProdID = CASE 
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO' THEN 71
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO MATCH' THEN 66
					ELSE p.SAPProdID
				END
	FROM public.ztubt_sap_product p
	WHERE td.ProdID::int = p.prodid;

return query
SELECT DISTINCT 
			coalesce(TerDisplayID, '')
			,(TransactionDate :: Date)
			,coalesce(ProdID :: int, 0)
			,coalesce(LocDisplayID, '')
			,coalesce(Sales_type, '')
			,TotalCount
			,Amount
		FROM ubt_temp_tmpterlocprdsalesamt --(12) ubt_temp_FinalTempData--(1)FROM ubt_temp_TmpTerLocPrdSalesAmt
		WHERE (TotalCount!=0 or Amount!=0)
		AND (TransactionDate :: DATE) = vbusinessdate
;
	drop table if exists ubt_temp_tmpterlocprdsalesamt;
	drop table if exists ubt_temp_tmpticketbywageandsales;
	drop table if exists ubt_temp_resultcashlessinterminal;
	drop table if exists ubt_temp_grouptoto;
	drop table if exists ubt_temp_itoto;
	drop table if exists ubt_temp_location;
	drop table if exists ubt_temp_product;
	drop table if exists ubt_temp_salesfactorconfig;
	drop table if exists ubt_temp_salesgrouptoto;
	drop table if exists ubt_temp_salestoto;
	drop table if exists ubt_temp_terminal;
	drop table if exists ubt_temp_transamountdetaildata;
	drop table if exists ubt_temp_cancelledbetticketstate;
	-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
	drop table if exists ubt_temp_sales_scandsr;
	
		
end
;
$$;


ALTER FUNCTION public.sp_ubt_getterminalinvoice_bk20250326(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1212 (class 1255 OID 2474934)
-- Name: sp_ubt_getterminalinvoice_bk20250506_fixbugga(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getterminalinvoice_bk20250506_fixbugga(businessdate date) RETURNS TABLE(terdisplayid character varying, transactiondate date, prodid integer, locdisplayid character varying, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
vbusinessdate date;
vinputdate date;
vstartperiod date;
vendperiod date;
vfromdateIGT timestamp;--@BusinessDateFrom
vtodateIGT timestamp;--@BusinessDateTo
vfromdatetimeIGT_UTC timestamp;
vtodatetimeIGT_UTC timestamp;
vfromdatetimeOB_UTC timestamp;
vtodatetimeOB_UTC timestamp;
vfromdatetimeNonHost_UTC timestamp;
vtodatetimeNonHost_UTC timestamp;
vfromdatetimeBMCS_UTC timestamp;
vtodatetimeBMCS_UTC timestamp;

vactualdate date;
/*DECLARE @BusinessDateFromDATETIME;
DECLARE @BusinessDateToDATETIME;
DECLARE @l_PeriodFromDateNonHostUTCDATETIME
DECLARE @l_PeriodToDateNonHostUTCDATETIME
DECLARE @InsertedDateDATETIME;
DECLARE @l_PeriodFromDateIGTUTC DATETIME
DECLARE @l_PeriodToDateIGTUTC DATETIME
DECLARE @l_PeriodFromDateOBUTC DATETIME --(15)
DECLARE @l_PeriodToDateOBUTC DATETIME --(15)

*/

v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

BEGIN

select businessdate into vbusinessdate;


create temp table if not exists ubt_temp_TmpTerLocPrdSalesAmt
	( 
	terdisplayid varchar(200),
	transactiondate timestamp,
	prodid int4,
	locdisplayid varchar(200),
	sales_type varchar(100),
	totalcount int4,
	amount numeric(32, 11),
	sub_prod varchar(100)
	);


create temp table ubt_temp_terminal as 
	Select Ter.TerDisplayID, Ter.LocID  FROM public.ztubt_Terminal Ter;

create temp table ubt_temp_product as 
	Select PD.ProdID,
	case PD.prodid when 5 then 'SPORTS' else trim(PD.ProdName) end as ProdName  FROM public.ztubt_Product PD
	WHERE PD.ProdID != 6 ;--(15) remove Sports Live so that all Sports refer to ProductID = 5 only

insert into ubt_temp_product (prodid, prodname) values (3, 'TOTO MATCH');


create temp table ubt_temp_Location as
	Select Loc.LocID, Loc.LocDisplayID, Loc.SweepIndicator,Loc.LocTypeID,Loc.IsGST,Loc.AccountNumber,
	Loc.BranchID,Loc.Bankid,Loc.LocName,Loc.IsIBG,Loc.RetID,LOC.CHID
	from public.ztubt_location  Loc;

--GetcommondatesfroUBT

	select 
	fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,utcfromdatetimeob,utctodatetimeob,
	utcfromdatetimenonhost,utctodatetimenonhost, utcfromdatetimebmcs, utctodatetimebmcs
	into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeNonHost_UTC ,
	vtodatetimeNonHost_UTC,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
	from public.sp_ubt_getcommonubtdates(vbusinessdate,vbusinessdate);


create temp table if not exists ubt_temp_TmpTicketByWageAndSales 
	(
	ticketserialnumber varchar(500),
	wager numeric(22,2), 
	secondwager numeric(22,2), 
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2), 
	winningamount numeric(22,2) 
	);

-- from function getamounttransaction

INSERT INTO ubt_temp_TmpTicketByWageAndSales
 select * from  public.sp_ubt_getamounttransaction(vbusinessdate,vbusinessdate);




create temp table if not exists ubt_temp_ResultCashlessInTerminal 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(22, 11),
	ct int4
	);

insert into ubt_temp_ResultCashlessInTerminal

	select  pd.terdisplayid, 'NETS', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NC','NN') 
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC 
	group by pd.terdisplayid
	
	union all 
	select pd.terdisplayid, 'CASHCARD', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NCC') --cashcard
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	
	union all
	
	select pd.terdisplayid, 'Flashpay', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NFP') --Flashpay
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	;

create temp table if not exists ubt_temp_iTOTO
	(
	ticketserialnumber varchar(200),
	itotoindicator bool,
	groupunitsequence int4,
	bettype int4
	)
;
INSERT INTO ubt_temp_iTOTO
	select distinct ticketserialnumber, itotoindicator, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where ((groupunitsequence = 1) --group toto
	or (itotoindicator = true)) --itoto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
;


create temp table if not exists ubt_temp_GroupTOTO
	(
	ticketserialnumber varchar(200),
	grouphostid varchar(50),
	groupunitsequence int4,
	bettype int4
	);

insert into ubt_temp_grouptoto
	select distinct ticketserialnumber, grouphostid, groupunitsequence,
	case 
        when pbt.bettypeid != ALL(v_totomatchBettypes) THEN 1 --TOTO
        else 2 --totomatch
    end AS bettype
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where groupunitsequence is not null --group toto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC  )
;

create temp table ubt_temp_CancelledBetTicketState as 
	select cb.cartid,cb.terdisplayid,cb.ticketserialnumber,cb.tranheaderid,cb.cancelleddate ,cb.cancelledamout,cb.prodid 
	from  public.ztubt_cancelledbetticket  cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
   on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateIGT and vtodateIGT
;


create temp table if not exists ubt_temp_SalesGroupToto
(
	terdisplayid varchar(200),
	prodid int4,
	locdisplayid varchar(200),
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --Sales of each product (Wager * Sales Factor)
);

insert into ubt_temp_SalesGroupToto(terdisplayid, prodid, locdisplayid,bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid, 
	3 as prodid, 
	loc.locdisplayid as locdisplayid,
	fin.bettype as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal,  
	count(distinct can.ticketserialnumber)	as canceltotal,
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
		
		left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales, itoto.bettype
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)can on pbth.ticketserialnumber = can.ticketserialnumber
		
	where  
	pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by  ter.terdisplayid,loc.locdisplayid, fin.bettype
	;

create temp table if not exists ubt_temp_salestoto 
	(
	terdisplayid varchar(200),
	locdisplayid varchar(200),
	prodid int4,
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);

insert into ubt_temp_salestoto(terdisplayid, locdisplayid,prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid		as terdisplayid,	
	loc.locdisplayid			as locdisplayid,
	3		as prodid, 
	1 as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1)		as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	public.ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)can on pbth.ticketserialnumber = can.ticketserialnumber

	where pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by ter.terdisplayid,loc.locdisplayid
	;

--FILL IN TRANS AMOUNT DETAIL DATA
		
create temp table if not exists ubt_temp_transamountdetaildata 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(32, 13),
	ct int4,
	flag char(3),
	transtype char(2),
	fromdate date,
	todate date
	);
Insert Into ubt_temp_transamountdetaildata
	select terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
	from public.sp_ubt_gettransamountdetails(vbusinessdate,vbusinessdate);


-- insert all data

insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='COL' and transtype != 'OO' and prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all
	
	--offline orders - wager
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	case when a.productname <> 'Gate Admission' then 31
		 when a.productname = 'Gate Admission' then 99 end as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' 
	group by loc.locdisplayid,ter.terdisplayid,case when a.productname <> 'Gate Admission' then 31
		 											when a.productname = 'Gate Admission' then 99 end
	
	union all 
	
	----2	AT_CANCELAMT	Yes	cancel amount
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'2'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='CAN' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	
	---3	AT_VALIDAMT	Yes	validation amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'3'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='PAY' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---4	Rebate Amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'4'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod  
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RBT' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	union all
	--61	Refund Amount--(4)(5)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RFD' AND TransType != 'OO' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
	union all 
	--offline orders - refund
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	'' as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
		where flag='RFD' AND TransType = 'OO' 
		group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--6	AT_TAXAMT 	Yes	tax amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'6'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='GST' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname

	union all 
	---7	AT_COMMAMT	Yes	commission amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'7'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount,
	a.productname as sub_prod 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='SAL' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid, a.productname
	
		
	------16. AT_FRACVALAMT  Show fractional validation amounts [Validation amounts for GROUP TOTO - This is a subset of Sales Type  3]
	union all
	
	select	ter.terdisplayid				as terdisplayid,
	vbusinessdate transactiondate,
	3		as prodid,
	loc.locdisplayid	as locdisplayid,
	'16'		as sales_type,
	count(distinct vb.tranheaderid)	as totalcount, 
	sum(coalesce(vb.winningamount,0))	as totalamount,
	case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	from --(1)
	(
		select vb.tranheaderid,vb.winningamount,vb.cartid,vb.terdisplayid,vb.createdvalidationdate 
		from public.ztubt_validatedbetticket  vb --(16)
		inner join public.ztubt_validatedbetticketlifecyclestate  vbt
		on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
		where vb.winningamount != 0 and vb.winningamount is not null --(8)
		and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	)vb
	inner join 
	(
		select distinct tranheaderid, grouphostid, groupunitsequence, bettypeid from public.ztubt_toto_placedbettransactionlineitem
	)ph on vb.tranheaderid = ph.tranheaderid --(16)
	inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where ph.groupunitsequence is not null --(16)
	group by loc.locdisplayid,ter.terdisplayid,
	case when ph.bettypeid != ALL(v_totomatchBettypes) then 'TOTO'
		else 'TOTO MATCH' end
	
	union all 
	--52. House syndicate sales amount - [iTOTO sales  this is a subset of sales type 1]
	--TOTO
	select	s.terdisplayid			as terdisplayid,
	vbusinessdate	as transactiondate, 
	s.prodid	as prodid, 
	s.locdisplayid as locdisplayid,
	'52' as sales_type, 
	sum(coalesce(s.wagertotal,0))		as totalcount, 
	sum(coalesce(s.wageramount,0))	as totalamount,
	'TOTO' as sub_prod
	from ubt_temp_salestoto s
	group by s.terdisplayid, s.prodid, s.locdisplayid
		
	union all 
	--25. House syndicate sales amount by sales factor [iTOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO
	select	s.terdisplayid	as terdisplayid,
	vbusinessdate		as transactiondate, 
	3	as prodid,
	s.locdisplayid	as locdisplayid,
	'25'	as sales_type,
	sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))		as totalcount, 
	trunc(sum(coalesce(s.salesamount,0)) / 100 , 2) * 100	as totalamount ,
	'TOTO' as sub_prod 
	from ubt_temp_salestoto s
	group by s.locdisplayid,s.terdisplayid
	
	union all 
	--40. GST TAX rate--------------------------------------------------------------------
	
	select	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate,
	prd.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'40'		as sales_type,
	0		as totalcount ,
	gst.gstrate,
	prd.prodname as sub_prod
	from	
	(
		select loc.locdisplayid, ter.terdisplayid from ubt_temp_location loc
		inner join ubt_temp_terminal ter on loc.locid = ter.locid
		where loc.isgst = true
	)loc
	cross join 
	(
		select * from ubt_temp_product where prodid in (2,3,4) --lottery / es
	)prd
	cross join
	(
		select gstrate from public.ztubt_gstconfig a 
		where (vbusinessdate between effectivefrom and enddate) or (vbusinessdate >=effectivefrom and enddate is null) limit 1
		--check this code
	)gst
	
	union all 
--59. House syndicate cancel amount - [iTOTO cancellations  This is a Sub Set of Sales Type 2]
	--TOTO
	select	cb.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	3		as prodid, 
	loc.locdisplayid as locdisplayid,
	'59'		as sales_type, 
	count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)as totalcount, 
	sum(coalesce (cb.cancelledamout,0))as totalamount,
	'TOTO' as sub_prod
	from ubt_temp_cancelledbetticketstate cb 
	inner join ubt_temp_itoto itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true 
	inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where cb.prodid = 3 --(1)and tpbtli.itotoindicator = 1
	 and cb.cancelleddate between vfromdateIGT and vtodateIGT
	group by cb.terdisplayid,loc.locdisplayid
	
	union all 
	---60. Player syndicate sales amount by sales factor - [GROUP TOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	--TOTO, totomatch
	SELECT S.TerDisplayID AS TerDisplayID ,
	 vbusinessdate	AS TransactionDate, 
	S.ProdID	AS ProdID,
	S.LocDisplayID AS LocDisplayID,
	'60' AS sales_type, 
	SUM(coalesce(S.WagerTotal,0)  - coalesce(S.CancelTotal,0))	AS TotalCount,--(8)
	trunc(SUM(coalesce(s.SalesAmount,0)) / 100 , 2) * 100	AS TotalAmount,
	case when S.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY  S.TerDisplayID,S.ProdID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end

	union all 
	
	--69. Player syndicate sales amount - [GROUP TOTO Sales  This is a subset of Sales Type 1]----------
	--TOTO, totomatch
	SELECT	S.TerDisplayID			AS TerDisplayID,
	vbusinessdate	AS TransactionDate,
	3 AS ProdID, 
	S.LocDisplayID AS LocDisplayID,
	'69' AS sales_type,
	SUM(COALESCE(S.WagerTotal,0))AS TotalCount, 
	SUM(COALESCE(S.WagerAmount,0))		AS TotalAmount,--(1)COALESCE(S.Amount,0)		AS TotalAmount
	case when S.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY S.TerDisplayID, S.LocDisplayID,
		case when S.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end

	union all
	--70 [	 GROUP TOTO Cancel Amount  This is a subset of Sales Type 2]-----------------------------------
	--TOTO, totomatch
	select			cbt.terdisplayid as terdisplayid,
	vbusinessdate	as transactiondate, 
	3				as prodid,
	loc.locdisplayid	as locdisplayid,
	'70'				as sales_type, 
	count(distinct gt.grouphostid)	as totalcount, 
	sum(coalesce (cbt.cancelledamout,0))	as totalamount,
	case when gt.bettype = 1 then 'TOTO'
		else 'TOTO MATCH' end as sub_prod 
	from ubt_temp_cancelledbetticketstate cbt
	inner join ubt_temp_grouptoto gt on cbt.ticketserialnumber = gt.ticketserialnumber
	inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where  cbt.prodid = 3  
	and cbt.cancelleddate between vfromdateIGT and vtodateIGT 
	group by cbt.terdisplayid,loc.locdisplayid,
		case when gt.bettype = 1 then 'TOTO'
			else 'TOTO MATCH' end
	
	union all 
	--105 Sales Commision Rate
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
    '' as sub_prod
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid in (2,4) --lottery / es
		)sal
		
	union all 
	--TOTO, totomatch
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission,
	sp.sub_prod 
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid = 3 
		)sal
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp
		
	union all 
	--108 AT_ON_EZLINK----------------------------------------------------------------------- 
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'108'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'NETS'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--110	AT_ON_ATM	Yes	Flashpay transaction --------------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'110'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'Flashpay'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--112	AT_ON_CASHCARD	Yes	Cashcard transaction------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'112'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount,
	'' as sub_prod
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'CASHCARD'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all
	---116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor-------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	a.prodid as prodid,
	loc.locdisplayid		as locdisplayid,
	'116'		as sales_type,
	sum(coalesce(a.total,0)  - coalesce(can.total,0))	as totalcount, --(8)
	trunc(sum(coalesce(a.amount,0)) / 100, 2) * 100 as totalamount,
	a.sub_prod as sub_prod
  	from 
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
			case
				when pb.prodid=6 then 5 --prematch and live to be one same prodid
				else pb.prodid	end as prodid, --(15)
			case when pb.prodid <> 3 then ''
				when pb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE pb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
					) then 'TOTO MATCH' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 
			where pb.iscancelled = false and (
					(
					pb.prodid in (2,3,4) --lottery / es
					and pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC 

					)
					or --(15)
					(
					pb.prodid in (5,6) --sports / ob
					and pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC
					)
					or 
					(
					pb.prodid in (1) --horse racing / bmcs
					and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
					)
				)
			group by a.ticketserialnumber, pb.terdisplayid, pb.prodid,
				case when pb.prodid <> 3 then ''  
					when pb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE pb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
						) then 'TOTO MATCH' 
					else 'TOTO' end
		)a
		inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join --(8)
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, cb.terdisplayid, cb.prodid,
			case when cb.prodid <> 3 then ''  
				when cb.prodid = 3 and EXISTS (
						SELECT 1 
						FROM ztubt_toto_placedbettransactionlineitem pbtlin
						WHERE cb.TranHeaderID = pbtlin.TranHeaderID
							AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
					) then 'TOTO MATCH' 
				else 'TOTO' end as sub_prod
			from ubt_temp_tmpticketbywageandsales a 
			inner join ubt_temp_cancelledbetticketstate cb on a.ticketserialnumber = cb.ticketserialnumber
			where cb.prodid in (2,3,4) --lottery / es
			group by a.ticketserialnumber, cb.terdisplayid, cb.prodid,
				case when cb.prodid <> 3 then ''  
					when cb.prodid = 3 and EXISTS (
							SELECT 1 
							FROM ztubt_toto_placedbettransactionlineitem pbtlin
							WHERE cb.TranHeaderID = pbtlin.TranHeaderID
								AND pbtlin.bettypeid = ANY(v_totomatchBettypes)
						) then 'TOTO MATCH' 
					else 'TOTO' end
		)can 
			on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid
			and a.prodid = can.prodid and a.sub_prod = can.sub_prod
		
		group by loc.locdisplayid,ter.terdisplayid,a.prodid, a.sub_prod
	;	
/*	UPDATE T
		SET TotalCount = T.TotalCount
		FROM 
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 116
		)T
		INNER JOIN
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 7
		)FIN ON T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
	--end modify (9)*/

/*update ubt_temp_TmpTerLocPrdSalesAmt T 
set TotalCount = FIN.TotalCount
from (
		SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = '7'
		)FIN 
	where 
	T.sales_type='116' and 
	T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
*/

-- [2022-04-01] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation
create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('001811006', 4, 'TOTO','2021-11-24'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vbusinessdate, vbusinessdate);




DELETE  FROM ubt_temp_tmpterlocprdsalesamt SAL USING ubt_temp_sales_scandsr RS 
where  SAL.TerDisplayID = RS.TerDisplayID 
AND RS.ProdID = SAL.ProdID
AND SAL.Sales_type = '116';




INSERT INTO ubt_temp_tmpterlocprdsalesamt(TerDisplayId, TransactionDate, ProdID, LocDisplayID, Sales_type, TotalCount, Amount, sub_prod)
	SELECT	RS.TerDisplayID	as TerDisplayID,
			vbusinessdate			AS TransactionDate, 
			RS.ProdID			AS ProdID,
			LOC.LocDisplayID		AS LocDisplayID,
			'116'					aS sales_type,
			RS.TotalCount, 
			RS.Amount*100,
			'' as sub_prod
	FROM ubt_temp_sales_scandsr RS
	INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
	INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
	where RS.ActualDate = vbusinessdate;

-- [2022-04-01] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--119	at_salesfactor	yes	sales factor-------------------------------
create temp table if not exists ubt_temp_salesfactorconfig
	(
		prodid int4,
		salesfactor numeric(13,12)
	)
	;
insert into ubt_temp_salesfactorconfig
	select a.prodid, a.salesfactor  from  public.ztubt_salescomconfig  a 
	where commissiontype=1  and a.isdeleted = false and prodid in (2,3,4)
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, '' 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc  where sfc.prodid <> 3
		)sfc
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, sub_prod)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor, sp.sub_prod 
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc where sfc.prodid = 3
		)sfc
		cross join (select 'TOTO' as sub_prod union all select 'TOTO MATCH' as sub_prod) as sp
;

insert into 	ubt_temp_tmpterlocprdsalesamt
		SELECT	coalesce(DB.TerDisplayID,CR.TerDisplayID)					AS TerDisplayID,
				coalesce(DB.TransactionDate,CR.TransactionDate)			AS TransactionDate, 
				0														AS ProdID,
				coalesce(DB.LocDisplayID,CR.LocDisplayID)					AS LocDisplayID,
				'727'														AS sales_type,
				0														AS TotalCount,
				SUM(coalesce(DB.Amount,0)) - SUM(coalesce(CR.Amount,0))		AS Amount,
			    '' as sub_prod
		FROM
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type in
			(
				'2', --cancel amount
				'3',	--validation amount
				'7',	--commission amount
				--(7)6, -- GST tax amount
				'108', --NETS transaction
				'110', --Flashpay transaction
				'112', --Cashcard transaction
				--(4)-1 -- refund and rebate
				'4', --rebate
				'61' --refund--(5)5 --refund
			 )
			--  AND (prodid :: int) != 31  --(15) exclude offline orders in the net amount due calculation
			AND (prodid :: int) not in (31,99)
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) CR
		FULL OUTER JOIN 
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type ='1'	--collection
			-- AND (prodid :: int)!= 31 
			AND (prodid :: int) not in (31,99)
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) DB ON DB.LocDisplayID=CR.LocDisplayID AND DB.TransactionDate=CR.TransactionDate AND DB.TerDisplayID=CR.TerDisplayID
		GROUP BY DB.TerDisplayID, DB.TransactionDate, DB.LocDisplayID,CR.TerDisplayID,CR.TransactionDate, CR.LocDisplayID					
;	

-- for both types of toto
INSERT INTO ubt_temp_tmpterlocprdsalesamt
-- sum totomatch and t649
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, sum(totalcount), sum(amount), ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TOTO MATCH', 'TOTO') and Sales_type not in ('40', '119', '105')
group by terdisplayid, transactiondate, prodid, locdisplayid, sales_type
union all

-- config - clone totomatch config for product Toto (t649 and totomatch)
select terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount, ''
from ubt_temp_tmpterlocprdsalesamt td
where sub_prod in ('TOTO MATCH') and Sales_type in ('40', '119', '105');

	
	UPDATE ubt_temp_tmpterlocprdsalesamt td
	SET ProdID = CASE 
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO' THEN 71
					WHEN td.ProdID::int = 3 AND td.sub_prod = 'TOTO MATCH' THEN 66
					ELSE p.SAPProdID
				END
	FROM public.ztubt_sap_product p
	WHERE td.ProdID::int = p.prodid;

return query
SELECT DISTINCT 
			coalesce(TerDisplayID, '')
			,(TransactionDate :: Date)
			,coalesce(ProdID :: int, 0)
			,coalesce(LocDisplayID, '')
			,coalesce(Sales_type, '')
			,TotalCount
			,Amount
		FROM ubt_temp_tmpterlocprdsalesamt --(12) ubt_temp_FinalTempData--(1)FROM ubt_temp_TmpTerLocPrdSalesAmt
		WHERE (TotalCount!=0 or Amount!=0)
		AND (TransactionDate :: DATE) = vbusinessdate
;
	drop table if exists ubt_temp_tmpterlocprdsalesamt;
	drop table if exists ubt_temp_tmpticketbywageandsales;
	drop table if exists ubt_temp_resultcashlessinterminal;
	drop table if exists ubt_temp_grouptoto;
	drop table if exists ubt_temp_itoto;
	drop table if exists ubt_temp_location;
	drop table if exists ubt_temp_product;
	drop table if exists ubt_temp_salesfactorconfig;
	drop table if exists ubt_temp_salesgrouptoto;
	drop table if exists ubt_temp_salestoto;
	drop table if exists ubt_temp_terminal;
	drop table if exists ubt_temp_transamountdetaildata;
	drop table if exists ubt_temp_cancelledbetticketstate;
	-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
	drop table if exists ubt_temp_sales_scandsr;
	
		
end
;
$$;


ALTER FUNCTION public.sp_ubt_getterminalinvoice_bk20250506_fixbugga(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1270 (class 1255 OID 2030161)
-- Name: sp_ubt_getterminalinvoice_testorg(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_getterminalinvoice_testorg(businessdate date) RETURNS TABLE(terdisplayid character varying, transactiondate date, prodid integer, locdisplayid character varying, sales_type character varying, totalcount integer, amount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

declare 
vbusinessdate date;
vinputdate date;
vstartperiod date;
vendperiod date;
vfromdateIGT timestamp;--@BusinessDateFrom
vtodateIGT timestamp;--@BusinessDateTo
vfromdatetimeIGT_UTC timestamp;
vtodatetimeIGT_UTC timestamp;
vfromdatetimeOB_UTC timestamp;
vtodatetimeOB_UTC timestamp;
vfromdatetimeNonHost_UTC timestamp;
vtodatetimeNonHost_UTC timestamp;
vfromdatetimeBMCS_UTC timestamp;
vtodatetimeBMCS_UTC timestamp;

vactualdate date;
/*DECLARE @BusinessDateFromDATETIME;
DECLARE @BusinessDateToDATETIME;
DECLARE @l_PeriodFromDateNonHostUTCDATETIME
DECLARE @l_PeriodToDateNonHostUTCDATETIME
DECLARE @InsertedDateDATETIME;
DECLARE @l_PeriodFromDateIGTUTC DATETIME
DECLARE @l_PeriodToDateIGTUTC DATETIME
DECLARE @l_PeriodFromDateOBUTC DATETIME --(15)
DECLARE @l_PeriodToDateOBUTC DATETIME --(15)

*/

BEGIN

select businessdate into vbusinessdate;


create temp table if not exists ubt_temp_TmpTerLocPrdSalesAmt
	( 
	terdisplayid varchar(200),
	transactiondate timestamp,
	prodid int4,
	locdisplayid varchar(200),
	sales_type varchar(100),
	totalcount int4,
	amount numeric(32, 11)      
	);


create temp table ubt_temp_terminal as 
	Select Ter.TerDisplayID, Ter.LocID  FROM public.ztubt_Terminal Ter;

create temp table ubt_temp_product as 
	Select PD.ProdID,
	case PD.prodid when 5 then 'SPORTS' else trim(PD.ProdName) end as ProdName  FROM public.ztubt_Product PD
	WHERE PD.ProdID != 6 ;--(15) remove Sports Live so that all Sports refer to ProductID = 5 only


create temp table ubt_temp_Location as
	Select Loc.LocID, Loc.LocDisplayID, Loc.SweepIndicator,Loc.LocTypeID,Loc.IsGST,Loc.AccountNumber,
	Loc.BranchID,Loc.Bankid,Loc.LocName,Loc.IsIBG,Loc.RetID,LOC.CHID
	from public.ztubt_location  Loc;

--GetcommondatesfroUBT

	select 
	fromdatetimeigt,todatetimeigt,utcfromdatetimeigt,utctodatetimeigt,utcfromdatetimeob,utctodatetimeob,
	utcfromdatetimenonhost,utctodatetimenonhost, utcfromdatetimebmcs, utctodatetimebmcs
	into 
	vfromdateIGT ,
	vtodateIGT ,
	vfromdatetimeIGT_UTC ,
	vtodatetimeIGT_UTC ,
	vfromdatetimeOB_UTC ,
	vtodatetimeOB_UTC ,
	vfromdatetimeNonHost_UTC ,
	vtodatetimeNonHost_UTC,
	vfromdatetimeBMCS_UTC,
	vtodatetimeBMCS_UTC
	from public.sp_ubt_getcommonubtdates(vbusinessdate,vbusinessdate);


create temp table if not exists ubt_temp_TmpTicketByWageAndSales 
	(
	ticketserialnumber varchar(500),
	wager numeric(22,2), 
	secondwager numeric(22,2), 
	sales numeric(22, 11),
	secondsales numeric(22, 11),
	salescomm numeric(22, 11),
	secondsalescomm numeric(22, 11),
	gst numeric(22, 11),
	secondgst numeric(22, 11),
	returnamount numeric(22,2), 
	winningamount numeric(22,2) 
	);

-- from function getamounttransaction

INSERT INTO ubt_temp_TmpTicketByWageAndSales
 select * from  public.sp_ubt_getamounttransaction(vbusinessdate,vbusinessdate);




create temp table if not exists ubt_temp_ResultCashlessInTerminal 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(22, 11),
	ct int4
	);

insert into ubt_temp_ResultCashlessInTerminal

	select  pd.terdisplayid, 'NETS', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NC','NN') 
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC 
	group by pd.terdisplayid
	
	union all 
	select pd.terdisplayid, 'CASHCARD', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NCC') --cashcard
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	
	union all
	
	select pd.terdisplayid, 'Flashpay', coalesce (sum(coalesce (pd.paidamount,0)),0), count(distinct pd.paymentdetailid) 
	from public.ztubt_paymentdetail pd 
	where pd.paymenttypeid in ('NFP') --Flashpay
	and pd.createddate >= vfromdatetimeNonHost_UTC
	and pd.createddate < vtodatetimeNonHost_UTC
	group by pd.terdisplayid
	;

create temp table if not exists ubt_temp_iTOTO
	(
	ticketserialnumber varchar(200),
	itotoindicator bool,
	groupunitsequence int4
	)
;
INSERT INTO ubt_temp_iTOTO
	select distinct ticketserialnumber, itotoindicator, groupunitsequence
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where ((groupunitsequence = 1) --group toto
	or (itotoindicator = true)) --itoto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
;


create temp table if not exists ubt_temp_GroupTOTO
	(
	ticketserialnumber varchar(200),
	grouphostid varchar(50),
	groupunitsequence int4
	);

insert into ubt_temp_grouptoto
	select distinct ticketserialnumber, grouphostid, groupunitsequence
	from public.ztubt_placedbettransactionheader  pb
	inner join public.ztubt_toto_placedbettransactionlineitem  pbt on pb.tranheaderid = pbt.tranheaderid
	where groupunitsequence is not null --group toto
	and (pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC  )
;

create temp table ubt_temp_CancelledBetTicketState as 
	select cb.cartid,cb.terdisplayid,cb.ticketserialnumber,cb.tranheaderid,cb.cancelleddate ,cb.cancelledamout,cb.prodid 
	from  public.ztubt_cancelledbetticket  cb 
	inner join public.ztubt_cancelledbetticketlifecyclestate cbt 
   on cb.tranheaderid = cbt.tranheaderid and cbt.betstatetypeid = 'CB06'
	where cb.cancelleddate between vfromdateIGT and vtodateIGT
;


create temp table if not exists ubt_temp_SalesGroupToto
(
	terdisplayid varchar(200),
	prodid int4,
	locdisplayid varchar(200),
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --Sales of each product (Wager * Sales Factor)
);

insert into ubt_temp_SalesGroupToto(terdisplayid, prodid, locdisplayid,bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid, 
	3 as prodid, 
	loc.locdisplayid as locdisplayid,
	1 as bettype, 
	count(distinct fin.ticketserialnumber)	as wagertotal,  
	count(distinct can.ticketserialnumber)	as canceltotal,
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
		
		left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.groupunitsequence = 1 --group toto
		)can on pbth.ticketserialnumber = can.ticketserialnumber
		
	where  
	pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by  ter.terdisplayid,loc.locdisplayid
	;

create temp table if not exists ubt_temp_salestoto 
	(
	terdisplayid varchar(200),
	locdisplayid varchar(200),
	prodid int4,
	bettype int4,
	wagertotal int4,--(8)
	canceltotal int4,--(8)
	wageramount numeric(32, 11), --wager of each product
	salesamount numeric(32, 11)  --sales of each product (wager * sales factor)
	);

insert into ubt_temp_salestoto(terdisplayid, locdisplayid,prodid, bettype, wagertotal, canceltotal, wageramount, salesamount)
	select ter.terdisplayid		as terdisplayid,	
	loc.locdisplayid			as locdisplayid,
	3		as prodid, 
	1		as bettype,
	count(distinct fin.ticketserialnumber)	as wagertotal, --(1)count(1)		as totalcount, 
	count(distinct can.ticketserialnumber)	as canceltotal,--(8)
	sum(coalesce(fin.wager,0))	as wageramount, 
	sum(coalesce(fin.sales,0))	as salesamount
	from	public.ztubt_placedbettransactionheader pbth 
	inner join ubt_temp_terminal ter  on pbth.terdisplayid=ter.terdisplayid
	inner join ubt_temp_location loc  on ter.locid=loc.locid
	inner join 
		(
		select gat.ticketserialnumber, gat.wager, case when can.ticketserialnumber is null then gat.sales else 0 end as sales  
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		left join ubt_temp_cancelledbetticketstate can on gat.ticketserialnumber = can.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)fin on pbth.ticketserialnumber = fin.ticketserialnumber
	left join 
		(
		select gat.ticketserialnumber, gat.wager, gat.sales 
		from ubt_temp_itoto itoto
		inner join ubt_temp_tmpticketbywageandsales gat on itoto.ticketserialnumber = gat.ticketserialnumber
		inner join ubt_temp_cancelledbetticketstate cb on gat.ticketserialnumber = cb.ticketserialnumber
		where itoto.itotoindicator = true --itoto
		)can on pbth.ticketserialnumber = can.ticketserialnumber

	where pbth.prodid = 3 
	and (pbth.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC )
	group by ter.terdisplayid,loc.locdisplayid	
	;

--FILL IN TRANS AMOUNT DETAIL DATA
		
create temp table if not exists ubt_temp_transamountdetaildata 
	(
	terdisplayid varchar(200),
	productname varchar(100),
	amount numeric(32, 13),
	ct int4,
	flag char(3),
	transtype char(2),
	fromdate date,
	todate date
	);
Insert Into ubt_temp_transamountdetaildata
	select terdisplayid,	trim(prodname),(amount * 100)	,ticketcount,	flag,transtype
	from public.sp_ubt_gettransamountdetails_testorg (vbusinessdate,vbusinessdate);


-- insert all data

insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='COL' and transtype != 'OO' and prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	
	--offline orders - wager
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'1'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	sum(coalesce(amount,0))as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where flag='COL' and transtype = 'OO' 
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	
	----2	AT_CANCELAMT	Yes	cancel amount
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'2'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='CAN' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	
	---3	AT_VALIDAMT	Yes	validation amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'3'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='PAY' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	---4	Rebate Amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'4'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RBT' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all
	--61	Refund Amount--(4)(5)
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='RFD' AND TransType != 'OO' and  prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	--offline orders - refund
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	31	as prodid,
	loc.locdisplayid as locdisplayid,
	'61'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
		where flag='RFD' AND TransType = 'OO' 
		group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--6	AT_TAXAMT 	Yes	tax amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'6'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='GST' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
	union all 
	---7	AT_COMMAMT	Yes	commission amount
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate	as transactiondate,
	prd.prodid	as prodid,
	loc.locdisplayid as locdisplayid,
	'7'	as sales_type,
	sum(coalesce(a.ct,0))	as totalcount, 
	(sum(coalesce(amount,0)) * -1)as amount 
	from ubt_temp_transamountdetaildata a
	inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	inner join ubt_temp_product prd on a.productname = prd.prodname
		where flag='SAL' AND prd.prodid in (1,2,3,4,5) --(15)add horse racing, sports --(8)productname in ('4d lottery','singapore sweep','toto')
		group by loc.locdisplayid,ter.terdisplayid,prd.prodid
	
		
	------16. AT_FRACVALAMT  Show fractional validation amounts [Validation amounts for GROUP TOTO - This is a subset of Sales Type  3]
	union all
	
	select	ter.terdisplayid				as terdisplayid,
	vbusinessdate transactiondate,
	3		as prodid,
	loc.locdisplayid	as locdisplayid,
	'16'		as sales_type,
	count(distinct vb.tranheaderid)	as totalcount, 
	sum(coalesce(vb.winningamount,0))	as totalamount
	from --(1)
	(
		select vb.tranheaderid,vb.winningamount,vb.cartid,vb.terdisplayid,vb.createdvalidationdate 
		from public.ztubt_validatedbetticket  vb --(16)
		inner join public.ztubt_validatedbetticketlifecyclestate  vbt
		on vb.tranheaderid = vbt.tranheaderid and vbt.betstatetypeid = 'VB06'
		where vb.winningamount != 0 and vb.winningamount is not null --(8)
		and vb.createdvalidationdate >= vfromdatetimeIGT_UTC and vb.createdvalidationdate < vtodatetimeIGT_UTC --(16)
	)vb
	inner join 
	(
		select distinct tranheaderid, grouphostid, groupunitsequence from  public.ztubt_toto_placedbettransactionlineitem  
	)ph on vb.tranheaderid = ph.tranheaderid --(16)
	inner join ubt_temp_terminal ter on vb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where ph.groupunitsequence is not null --(16)
	group by loc.locdisplayid,ter.terdisplayid
	
	union all 
	--52. House syndicate sales amount - [iTOTO sales  this is a subset of sales type 1]
	
	select	s.terdisplayid			as terdisplayid,
	vbusinessdate	as transactiondate, 
	s.prodid	as prodid, 
	s.locdisplayid as locdisplayid,
	'52' as sales_type, 
	sum(coalesce(s.wagertotal,0))		as totalcount, 
	sum(coalesce(s.wageramount,0))	as totalamount
	from ubt_temp_salestoto s
	group by s.terdisplayid, s.prodid, s.locdisplayid
		
	union all 
	--25. House syndicate sales amount by sales factor [iTOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	select	s.terdisplayid	as terdisplayid,
	vbusinessdate		as transactiondate, 
	3	as prodid,
	s.locdisplayid	as locdisplayid,
	'25'	as sales_type,
	sum(coalesce(s.wagertotal,0) - coalesce(s.canceltotal,0))		as totalcount, 
	trunc(sum(coalesce(s.salesamount,0)) / 100 , 2) * 100	as totalamount  
	from ubt_temp_salestoto s
	group by s.locdisplayid,s.terdisplayid
	
	union all 
	--40. GST TAX rate--------------------------------------------------------------------
	
	select	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate,
	prd.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'40'		as sales_type,
	0		as totalcount ,
	gst.gstrate
	from	
	(
		select loc.locdisplayid, ter.terdisplayid from ubt_temp_location loc
		inner join ubt_temp_terminal ter on loc.locid = ter.locid
		where loc.isgst = true
	)loc
	cross join 
	(
		select * from ubt_temp_product where prodid in (2,3,4) --lottery / es
	)prd
	cross join
	(
		select gstrate from public.ztubt_gstconfig a 
		where (vbusinessdate between effectivefrom and enddate) or (vbusinessdate >=effectivefrom and enddate is null) limit 1
		--check this code
	)gst
	
	union all 
--59. House syndicate cancel amount - [iTOTO cancellations  This is a Sub Set of Sales Type 2]
	
	select	cb.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	3		as prodid, 
	loc.locdisplayid as locdisplayid,
	'59'		as sales_type, 
	count(distinct cb.ticketserialnumber)	as totalcount, --(1)count(1)as totalcount, 
	sum(coalesce (cb.cancelledamout,0))as totalamount
	from ubt_temp_cancelledbetticketstate cb 
	
	inner join ubt_temp_itoto itoto on cb.ticketserialnumber = itoto.ticketserialnumber and itoto.itotoindicator = true 
	inner join ubt_temp_terminal ter on cb.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where cb.prodid = 3 --(1)and tpbtli.itotoindicator = 1
	 and cb.cancelleddate between vfromdateIGT and vtodateIGT
	group by cb.terdisplayid,loc.locdisplayid
	
	union all 
	---60. Player syndicate sales amount by sales factor - [GROUP TOTO Sales by Sales Factor  This is a subset of Sales Type 116]
	SELECT S.TerDisplayID AS TerDisplayID ,
	 vbusinessdate	AS TransactionDate, 
	S.ProdID	AS ProdID,
	S.LocDisplayID AS LocDisplayID,
	'60' AS sales_type, 
	SUM(coalesce(S.WagerTotal,0)  - coalesce(S.CancelTotal,0))	AS TotalCount,--(8)
	trunc(SUM(coalesce(s.SalesAmount,0)) / 100 , 2) * 100	AS TotalAmount  
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY  S.TerDisplayID,S.ProdID, S.LocDisplayID

	union all 
	
	--69. Player syndicate sales amount - [GROUP TOTO Sales  This is a subset of Sales Type 1]----------
	
	SELECT	S.TerDisplayID			AS TerDisplayID,
	vbusinessdate	AS TransactionDate,
	3 AS ProdID, 
	S.LocDisplayID AS LocDisplayID,
	'69' AS sales_type,
	SUM(COALESCE(S.WagerTotal,0))AS TotalCount, 
	SUM(COALESCE(S.WagerAmount,0))		AS TotalAmount--(1)COALESCE(S.Amount,0)		AS TotalAmount
	FROM ubt_temp_SalesGROUPToto S
	GROUP BY S.TerDisplayID, S.LocDisplayID

	union all
	--70 [	 GROUP TOTO Cancel Amount  This is a subset of Sales Type 2]-----------------------------------
	select			cbt.terdisplayid as terdisplayid,
	vbusinessdate	as transactiondate, 
	3				as prodid,
	loc.locdisplayid	as locdisplayid,
	'70'				as sales_type, 
	count(distinct gt.grouphostid)	as totalcount, 
	sum(coalesce (cbt.cancelledamout,0))	as totalamount
	from ubt_temp_cancelledbetticketstate cbt
	inner join ubt_temp_grouptoto gt on cbt.ticketserialnumber = gt.ticketserialnumber
	inner join ubt_temp_terminal ter on cbt.terdisplayid = ter.terdisplayid
	inner join ubt_temp_location loc on ter.locid = loc.locid
	where  cbt.prodid = 3  
	and cbt.cancelleddate between vfromdateIGT and vtodateIGT 
	group by cbt.terdisplayid,loc.locdisplayid	
	
	union all 
	--105 Sales Commision Rate
	select 	loc.terdisplayid as terdisplayid,
	vbusinessdate		as transactiondate, 
	sal.prodid		as prodid,
	loc.locdisplayid	as locdisplayid,
	'105'				as sales_type, 
	0				as totalcount, 
	sal.salescommission
		from	
		(
			select loc.locdisplayid, ter.terdisplayid 
			from ubt_temp_location loc
			inner join ubt_temp_terminal ter on loc.locid = ter.locid
			where loc.isgst = true
		)loc
		cross join
		(
			select distinct salescommission, prodid 
			from public.ztubt_salescomconfig    a 
			where commissiontype=1 and  isdeleted = false and prodid in (2,3,4) --lottery / es
		)sal
		
	union all 
	--108 AT_ON_EZLINK----------------------------------------------------------------------- 
	
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'108'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'NETS'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--110	AT_ON_ATM	Yes	Flashpay transaction --------------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'110'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'Flashpay'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all 
	--112	AT_ON_CASHCARD	Yes	Cashcard transaction------------------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	0		as prodid,
	loc.locdisplayid		as locdisplayid,
	'112'		as sales_type,
	sum(coalesce(a.ct,0))	as totalcount,
	sum(coalesce(a.amount,0))as amount 
	from	ubt_temp_location as loc 
	left join ubt_temp_terminal as ter on  ter.locid=loc.locid
	left join ubt_temp_resultcashlessinterminal a on a.terdisplayid = ter.terdisplayid
	where a.productname = 'CASHCARD'
	group by ter.terdisplayid,loc.locdisplayid
	
	union all
	---116	AT_NOSPPL_SALAMT 	Yes	Sales multiplied by sales factor-------------------------------
	select	ter.terdisplayid	as terdisplayid,
	vbusinessdate as transactiondate, 
	a.prodid as prodid,
	loc.locdisplayid		as locdisplayid,
	'116'		as sales_type,
	sum(coalesce(a.total,0)  - coalesce(can.total,0))	as totalcount, --(8)
	trunc(sum(coalesce(a.amount,0)) / 100, 2) * 100 as totalamount  
  	from 
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, pb.terdisplayid, 
			case
				when pb.prodid=6 then 5 --prematch and live to be one same prodid
				else pb.prodid	end as prodid --(15)
			from ubt_temp_tmpticketbywageandsales a 
			inner join public.ztubt_placedbettransactionheader  pb on a.ticketserialnumber=pb.ticketserialnumber 
			where pb.iscancelled = false and (
					(
					pb.prodid in (2,3,4) --lottery / es
					and pb.createddate between vfromdatetimeIGT_UTC   and vtodatetimeIGT_UTC 

					)
					or --(15)
					(
					pb.prodid in (5,6) --sports / ob
					and pb.createddate between vfromdatetimeOB_UTC and vtodatetimeOB_UTC
					)
					or 
					(
					pb.prodid in (1) --horse racing / bmcs
					and pb.createddate between vfromdatetimeBMCS_UTC and vtodatetimeBMCS_UTC
					)
				)
			group by a.ticketserialnumber, pb.terdisplayid, pb.prodid
		)a
		inner join ubt_temp_terminal ter on a.terdisplayid = ter.terdisplayid
		inner join ubt_temp_location loc on ter.locid = loc.locid
		left join --(8)
		(
			select a.ticketserialnumber, sum(a.sales + a.secondsales) as amount, 
			count(distinct a.ticketserialnumber) as total, cb.terdisplayid, cb.prodid
			from ubt_temp_tmpticketbywageandsales a 
			inner join ubt_temp_cancelledbetticketstate cb on a.ticketserialnumber = cb.ticketserialnumber
			where cb.prodid in (2,3,4) --lottery / es
			group by a.ticketserialnumber, cb.terdisplayid, cb.prodid
		)can 
			on a.ticketserialnumber = can.ticketserialnumber and a.terdisplayid = can.terdisplayid
			and a.prodid = can.prodid
		
		group by loc.locdisplayid,ter.terdisplayid,a.prodid
	;	
/*	UPDATE T
		SET TotalCount = T.TotalCount
		FROM 
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 116
		)T
		INNER JOIN
		(
			SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = 7
		)FIN ON T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
	--end modify (9)*/

/*update ubt_temp_TmpTerLocPrdSalesAmt T 
set TotalCount = FIN.TotalCount
from (
		SELECT LocDisplayID,TerDisplayId,ProdID,TotalCount FROM  ubt_temp_TmpTerLocPrdSalesAmt WHERE Sales_type = '7'
		)FIN 
	where 
	T.sales_type='116' and 
	T.LocDisplayID = FIN.LocDisplayID AND T.TerDisplayId = FIN.TerDisplayId AND T.ProdID = FIN.ProdID ;
*/

-- [2022-04-01] wf: Start handling for Sweep Consignee and Sweep Retailer Cancellation
create temp table if not exists ubt_temp_sales_scandsr
	(
	TerDisplayID varchar(200),
	ProdID int4,
	ProductName varchar(100),
	ActualDate Date,
	TotalCount int,
	Amount decimal(32, 11)
	);

Insert Into ubt_temp_sales_scandsr
--values ('001811006', 4, 'TOTO','2021-11-24'::date, 99, 100);
select *  from public.sp_ubt_getsweepsalespersrterminal(vbusinessdate, vbusinessdate);




DELETE  FROM ubt_temp_tmpterlocprdsalesamt SAL USING ubt_temp_sales_scandsr RS 
where  SAL.TerDisplayID = RS.TerDisplayID 
AND RS.ProdID = SAL.ProdID
AND SAL.Sales_type = '116';




INSERT INTO ubt_temp_tmpterlocprdsalesamt(TerDisplayId, TransactionDate, ProdID, LocDisplayID, Sales_type, TotalCount, Amount)
	SELECT	RS.TerDisplayID	as TerDisplayID,
			vbusinessdate			AS TransactionDate, 
			RS.ProdID			AS ProdID,
			LOC.LocDisplayID		AS LocDisplayID,
			'116'					aS sales_type,
			RS.TotalCount, 
			RS.Amount*100
	FROM ubt_temp_sales_scandsr RS
	INNER JOIN ubt_temp_terminal TER ON RS.TerDisplayID = TER.TerDisplayID
	INNER JOIN ubt_temp_location LOC ON TER.LocID = LOC.LocID
	where RS.ActualDate = vbusinessdate;

-- [2022-04-01] wf: End handling for Sweep Consignee and Sweep Retailer Cancellation

--119	at_salesfactor	yes	sales factor-------------------------------
create temp table if not exists ubt_temp_salesfactorconfig
	(
		prodid int4,
		salesfactor numeric(13,12)
	)
	;
insert into ubt_temp_salesfactorconfig
	select a.prodid, a.salesfactor  from  public.ztubt_salescomconfig  a 
	where commissiontype=1  and a.isdeleted = false and prodid in (2,3,4)
;
insert into ubt_temp_tmpterlocprdsalesamt(terdisplayid, transactiondate, prodid, locdisplayid, sales_type, totalcount, amount)
		select ter.terdisplayid, vbusinessdate, sfc.prodid, ter.locdisplayid, '119', 0, sfc.salesfactor
		from 
		(
			select ter.terdisplayid, loc.locdisplayid from ubt_temp_terminal ter
			inner join ubt_temp_location loc on ter.locid = loc.locid
		)ter
		cross join 
		(
			select distinct sfc.prodid,sfc.salesfactor from ubt_temp_salesfactorconfig sfc
		)sfc
;

insert into 	ubt_temp_tmpterlocprdsalesamt
		SELECT	coalesce(DB.TerDisplayID,CR.TerDisplayID)					AS TerDisplayID,
				coalesce(DB.TransactionDate,CR.TransactionDate)			AS TransactionDate, 
				0														AS ProdID,
				coalesce(DB.LocDisplayID,CR.LocDisplayID)					AS LocDisplayID,
				'727'														AS sales_type,
				0														AS TotalCount,
				SUM(coalesce(DB.Amount,0)) - SUM(coalesce(CR.Amount,0))		AS Amount 
		FROM
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type in
			(
				'2', --cancel amount
				'3',	--validation amount
				'7',	--commission amount
				--(7)6, -- GST tax amount
				'108', --NETS transaction
				'110', --Flashpay transaction
				'112', --Cashcard transaction
				--(4)-1 -- refund and rebate
				'4', --rebate
				'61' --refund--(5)5 --refund
			 )
			 AND (prodid :: int) != 31  --(15) exclude offline orders in the net amount due calculation
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) CR
		FULL OUTER JOIN 
		(
			SELECT A.TerDisplayID			AS TerDisplayID,
					A.TransactionDate		AS TransactionDate, 
					A.LocDisplayID			AS LocDisplayID,
					SUM(coalesce(TotalCount,0))			AS TotalCount,
					SUM(coalesce(Amount,0))				AS Amount 
			FROM  ubt_temp_tmpterlocprdsalesamt A where sales_type ='1'	--collection
			AND (prodid :: int)!= 31 
			GROUP BY A.TerDisplayID, A.TransactionDate, A.LocDisplayID
		) DB ON DB.LocDisplayID=CR.LocDisplayID AND DB.TransactionDate=CR.TransactionDate AND DB.TerDisplayID=CR.TerDisplayID
		GROUP BY DB.TerDisplayID, DB.TransactionDate, DB.LocDisplayID,CR.TerDisplayID,CR.TransactionDate, CR.LocDisplayID					
;		
	
	UPDATE ubt_temp_tmpterlocprdsalesamt td
		set ProdID = p.SAPProdID
		from public.ztubt_sap_product  p
		where (td.ProdID :: int) = p.prodid 
;	
return query
SELECT DISTINCT 
			coalesce(TerDisplayID, '')
			,(TransactionDate :: Date)
			,coalesce(ProdID :: int, 0)
			,coalesce(LocDisplayID, '')
			,coalesce(Sales_type, '')
			,TotalCount
			,Amount
		FROM ubt_temp_tmpterlocprdsalesamt --(12) ubt_temp_FinalTempData--(1)FROM ubt_temp_TmpTerLocPrdSalesAmt
		WHERE (TotalCount!=0 or Amount!=0)
		AND (TransactionDate :: DATE) = vbusinessdate
;
	drop table if exists ubt_temp_tmpterlocprdsalesamt;
	drop table if exists ubt_temp_tmpticketbywageandsales;
	drop table if exists ubt_temp_resultcashlessinterminal;
	drop table if exists ubt_temp_grouptoto;
	drop table if exists ubt_temp_itoto;
	drop table if exists ubt_temp_location;
	drop table if exists ubt_temp_product;
	drop table if exists ubt_temp_salesfactorconfig;
	drop table if exists ubt_temp_salesgrouptoto;
	drop table if exists ubt_temp_salestoto;
	drop table if exists ubt_temp_terminal;
	drop table if exists ubt_temp_transamountdetaildata;
	drop table if exists ubt_temp_cancelledbetticketstate;
	-- [2022-04-01] wf: drop temp table created for Sweep Consignee and Sweep Retailer Cancellation
	drop table if exists ubt_temp_sales_scandsr;
	
		
end
;
$$;


ALTER FUNCTION public.sp_ubt_getterminalinvoice_testorg(businessdate date) OWNER TO sp_postgres;

--
-- TOC entry 1113 (class 1255 OID 1908370)
-- Name: sp_ubt_gettotomatchbettypes(); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettotomatchbettypes() RETURNS TABLE(bettypeid text)
    LANGUAGE plpgsql
    AS $$
BEGIN
    RETURN QUERY
    VALUES
        ('M AN'),
        ('M 2'),
        ('M 3'),
        ('M 4');
END;
$$;


ALTER FUNCTION public.sp_ubt_gettotomatchbettypes() OWNER TO sp_postgres;

--
-- TOC entry 1269 (class 1255 OID 1158330)
-- Name: sp_ubt_gettransactionamountdetails_bk240320(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransactionamountdetails_bk240320(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
	
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
--		union all
--		
--		-- 4D ProdID=2 SAL
--		select tl.terdisplayid
--		, '4D Lottery' ProdName
--		, 'SAL' Flag
--		, salescomamt
--		, ticketcount
--		, actualdate
--		from 
--		ubt_temp_terminal_loc tl left outer join (
--		select 
--		  pbth.terdisplayid 
--		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
--		, count(distinct pbth.ticketserialnumber) ticketcount
--		, zgp.actualdate
--		from 
--		 ztubt_placedbettransactionheader pbth 
--		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
--		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
--		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 inner join ztubt_drawdates dd
--		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join ubt_temp_busdatehost2 zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
---- 			and zgp.host = 2
-- 			)
--	 	where 1=1
--		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
--		and pbtlin.CreatedDate < vUTCToDateTimeIGT
--		and pbth.prodid= 2
--		and pbthlcs.betstatetypeid = 'PB06'
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
--		group by pbth.terdisplayid, zgp.actualdate)sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		
--		union all
--		
--		-- TOTO ProdID=3 SAL
--		select tl.terdisplayid
--		, 'TOTO' ProdName
--		, 'SAL' Flag
--		, salescomamt
--		, ticketcount
--		, actualdate
--		from 
--		ubt_temp_terminal_loc tl left outer join (
--		select 
--		  pbth.terdisplayid 
--		, sum(pbtlin.salescommamount) salescomamt
--		, count(distinct pbth.ticketserialnumber) ticketcount
--		, zgp.actualdate
--		from 
--		 ztubt_placedbettransactionheader pbth 
--		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
--		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
--		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join ubt_temp_busdatehost2 zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
---- 			and zgp.host = 2
-- 			)
--		where 1=1
--		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
--		and pbtlin.CreatedDate < vUTCToDateTimeIGT
--		and pbth.prodid= 3
--		and pbthlcs.betstatetypeid = 'PB06'
--		and coalesce(pbtlin.groupunitsequence,1) = 1 
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
--		group by pbth.terdisplayid, zgp.actualdate) sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		
--		union all
--		
--		-- SWEEP ProdID=4 SAL
--		select tl.terdisplayid
--		, 'SINGAPORE SWEEP' ProdName
--		, 'SAL' Flag
--		, salescomamt
--		, ticketcount
--		, actualdate
--		from 
--		ubt_temp_terminal_loc tl left outer join (
--		select 
--		  pbth.terdisplayid 
--		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
--		, count(distinct pbth.ticketserialnumber) ticketcount
--		, zgp.actualdate
--		from 
--		 ztubt_placedbettransactionheader pbth 
--		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
--		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
--		 left outer join ubt_temp_busdatehost2 zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
---- 			and zgp.host = 2
-- 			)
--		where 1=1
--		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
--		and pbtlin.CreatedDate < vUTCToDateTimeIGT
--		and pbth.prodid= 4
----		and Case
----			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
----			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
----			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
----			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
----			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
----			else 5 end = 1
--		group by pbth.terdisplayid, zgp.actualdate) sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		
--		union all 
--		
--		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
--		select tl.terdisplayid
--			, 'SINGAPORE SWEEP' ProdName
--			, 'SAL' Flag
--			, salescomamt
--			, ticketcount
--			, actualdate
--		from 
--		ubt_temp_terminal_loc tl left outer join (
--		SELECT        PBTH.TerDisplayID, GB.ActualDate,
--		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
--		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
--		FROM       
--			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
--				, CBT.TerDisplayID, CBT.CancelledAmout
--			FROM public.ztubt_cancelledbetticket CBT 
--			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
--				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
--			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
--			) PBTH
--			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
--			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
--			LEFT JOIN ubt_temp_busdatehost2 GB 
--			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
----			and gb.host = 2
--		WHERE PBTH.ProdID = 4
--		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
--		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
--		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		
--		union all
--		
--		-- SPORTS ProdID=5,6 SAL
--		select tl.terdisplayid
--		, 'SPORTS' ProdName
--		, 'SAL' Flag
--		, salescomamt
--		, ticketcount
--		, actualdate
--		from 
--		ubt_temp_terminal_loc tl left outer join (
--		select 
--		  terdisplayid 
--		, sum(coalesce(salescommAmount,0))  salescomamt
--		, sum(ticketcount) ticketcount
--		, actualdate
--		from 
--			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
--			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
--			 from ztubt_placedbettransactionheader pbth 
--			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
--		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
--		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join ubt_temp_busdatehost3 zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
---- 			and zgp.host = 3
-- 			)
--		where 1=1
--		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
--		and pbtlin.CreatedDate < vUTCToDateTimeOB
--		and pbth.prodid in (5,6)
--		and pbthlcs.betstatetypeid = 'PB06'
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
--		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
--			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
--		group by terdisplayid, actualdate) sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		
--		union all 
--		
----------------------------------------------------------------------------------------------------
--	-- HorseRacing ProdID=1 COL
--		select 
--		  tl.terdisplayid as TerDisplayID
--		, 'HORSE RACING' ProdName
--		, 'COL' Flag
--		, sum(COLAmount) Amount
--		, SUM(TicketCount) TicketCount
--		, null actualdate
--		from ztubt_terminal tl left outer join (
--			select pbtlin.terdisplayid
--			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
--					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
--			, count(distinct pbtlin.tranheaderid) TicketCount
--			from 
--			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
--			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
----			 left outer join public.ztubt_getbusinessdate_perhost zgp 
----	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
----	 			and zgp.host = 1)
--	 		where 1=1
--			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
--			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
--			and pbthlcs.betstatetypeid = 'PB06'
--			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
--			on (tl.terdisplayid = sq.terdisplayid)
--		group by tl.terdisplayid
--		
--		union all
--		
--	-- 4D ProdID=2 COL
--		select tl.terdisplayid
--		, '4D Lottery' ProdName
--		, 'COL' Flag
--		, COLAmount
--		, ticketcount
--		, null actualdate
--		from 
--		ztubt_terminal tl left outer join (
--		select 
--		  pbth.terdisplayid 
--		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
--		, count(distinct pbth.ticketserialnumber) ticketcount
--		from 
--		 ztubt_placedbettransactionheader pbth 
--		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
--		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
--		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 inner join ztubt_drawdates dd
--		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
----		 left outer join public.ztubt_getbusinessdate_perhost zgp 
---- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
---- 			and zgp.host = 2)
--	 	where 1=1
--		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
--		and pbtlin.CreatedDate < vUTCToDateTimeIGT
--		and pbth.prodid= 2
--		and pbthlcs.betstatetypeid = 'PB06'
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end in  (1,2)
--		group by pbth.terdisplayid)sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		
--		union all 
--		
--		-- TOTO ProdID=3 COL
--		select tl.terdisplayid
--		, 'TOTO' ProdName
--		, 'COL' Flag
--		, sum(COLAmount) COLAmount
--		, sum(ticketcount) ticketcount
--		, null actualdate
--		from 
--		ztubt_terminal tl left outer join (
--		select 
--		  pbth.terdisplayid 
--		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
--					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
--					else sum(pbtlin.betPriceAmount) end 
--					),2) COLAmount
--		, count(distinct pbth.ticketserialnumber) ticketcount
--		from 
--		 ztubt_placedbettransactionheader pbth 
--		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
--		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
--		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
----		 left outer join public.ztubt_getbusinessdate_perhost zgp 
---- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
---- 			and zgp.host = 2)
--		where 1=1
--		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
--		and pbtlin.CreatedDate < vUTCToDateTimeIGT
--		and pbth.prodid= 3
--		and pbthlcs.betstatetypeid = 'PB06'
--		and coalesce(pbtlin.groupunitsequence,1) = 1 
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end in (1,2)
--		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		group by tl.terdisplayid
--		
--		union all
--		
--	-- SWEEP ProdID=4 COL PB06 PB03
--		select tl.terdisplayid
--		, 'SINGAPORE SWEEP' ProdName
--		, 'COL' Flag
--		, COLAmount
--		, ticketcount
--		, null actualdate
--		from 
--		ztubt_terminal tl left outer join (
--		select 
--		  pbth.terdisplayid 
--		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
--		, count(distinct pbth.tickettransactionid) ticketcount
--		from 
--		 ztubt_placedbettransactionheader pbth 
--		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
--	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
--	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
--		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
--		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
--		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
--		 inner join ztubt_location zl on (zt.locid=zl.locid)
----		 left outer join public.ztubt_getbusinessdate_perhost zgp 
---- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
---- 			and zgp.host = 2)
--		where 1=1
--		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
--		and pbtlin.CreatedDate < vUTCToDateTimeIGT
--		and pbth.prodid= 4
--		and ((pbthlcs.betstatetypeid = 'PB06' and 
--			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
--			or
--			(pbthlcs.betstatetypeid = 'PB03' and 
--			(pbtl.isprinted is null and zl.sweepindicator is not null)))
--		group by pbth.terdisplayid) sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		
--		
--		union all
--	
--		-- SPORTS ProdID=5,6 COL
--		select tl.terdisplayid
--		, 'SPORTS' ProdName
--		, 'COL' Flag
--		, COLAmount
--		, ticketcount
--		, null actualdate
--		from 
--		ztubt_terminal tl left outer join (
--		select 
--		  terdisplayid 
--		, Round(sum(betamount),2) COLAmount
--		, count(distinct tranheaderid) ticketcount
----		, actualdate
--		from 
--			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
--			 from ztubt_placedbettransactionheader pbth 
--			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
--			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
--			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
--	-- 			and zgp.host = 3)
--			where 1=1
--			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
--			and pbtlin.CreatedDate < vUTCToDateTimeOB
--			and pbth.prodid in (5,6)
--			and pbthlcs.betstatetypeid = 'PB06'
--			and Case
--				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--				else 5 end in (1,2)
--			)a
--		group by terdisplayid
----		, zgp.actualdate
--		) sq
--		on (tl.terdisplayid = sq.terdisplayid)
--		
--		union all
--------------------------------------------------------------------------------------------------		
--	-- PAY
--		select 
--		 tpv.terDisplayID
--		,tpv.prodname
--		,'PAY' Flag
--		, (total_amount) PAYAmount
--		, ticketCount
--		, null actualDate
--		from ubt_temp_ter_prod_val tpv left outer join (
--			select terdisplayid
--			,"types" || '-' || prodname as prodname
--			, sum(total_amount) total_amount
--			, count(total_amount) ticketCount
--			from (
--			select zv.terdisplayid 
--			, case when zp.prodid in (5,6) then 'SPORTS' else trim(zp.prodname) end as prodname
--			, zp.prodid
--			, zv.winningamount , zv.rebateamount , zv.refundamount 
--			from ztubt_validatedbetticket zv 
--			inner join ztubt_product zp on (zv.prodid=zp.prodid)
--			inner join ztubt_validatedbetticketlifecyclestate zvlc 
--				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
--			where 1=1
--			and (--bmcs
--				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
--				and zv.createdvalidationdate < vUTCToDateTimeBMCS
--				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
--				--wf: 230517 update to segragate time range condition by product
--				and zv.prodid in (1)
--			  or -- igt
--			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
--				and zv.createdvalidationdate < vUTCToDateTimeIGT 
--				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
--				--wf: 230517 update to segragate time range condition by product
--				and zv.prodid in (2,3,4)
--			  or -- ob
--			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
--				and zv.createdvalidationdate < vUTCToDateTimeOB
--				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
--				--wf: 230517 update to segragate time range condition by product
--				and zv.prodid in (5,6)
--				)
--			--wf: 230517 update to segragate time range condition by product
--			--and zv.prodid in (1,2,3,4,5,6)
--			)sub1 
--			cross join lateral ( -- Unpivoting
--			values ('VALIDATED',sub1.WinningAmount),
--			('LOSING BET REBATE',sub1.RebateAmount),
--			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
--			where 1=1
--			and total_amount<>0
--			group by terdisplayid ,"types" || '-' || prodname 
--		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
----		where total_amount <>0
----		group by  tpv.terDisplayID,tpv.prodname
--
--		union all
--		
--		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
--		select 
--		  tl.terdisplayid as TerDisplayID
--		, 'LOSING BET REBATE-HORSE RACING' ProdName
--		, 'PAY' Flag
--		, Round(sum(COLAmount),2) Amount
--		, SUM(TicketCount) TicketCount
--		, null actualdate
--		from ubt_temp_terminal_loc tl left outer join (
--			select pbtlin.terdisplayid
----			, zgp.actualdate
--			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
--					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
--			, count(distinct pbtlin.tranheaderid) TicketCount
--			from 
--			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
--			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
--			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
----			 left outer join public.ztubt_getbusinessdate_perhost zgp 
----	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
----	 			and zgp.host = 1)
--	 		where 1=1
--			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
--			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
--			and pbthlcs.betstatetypeid = 'PB06'
--			group by pbtlin.terdisplayid,pbtlin.bettypeid
----			, zgp.actualdate
--			) sq
--			on (tl.terdisplayid = sq.terdisplayid)
--		group by tl.terdisplayid
----		, actualdate
--		
--	-- PAY
--	
--		union all
--------------------------------------------------------------------------------------------------		
--	-- CAN
--		-- CAN Prodid=1
--		select tp.terdisplayid
--		, tp.prodname
--		, 'CAN' Flag
--		, CANAmount
--		, TicketCount
--		, null AcutalDate
--		from ubt_temp_ter_prod tp left outer join (
--		select cbt.terdisplayid 
--		, round(sum(cbt.cancelledamout),2) CANAmount
--		, count(cbt.tranheaderid) TicketCount
--		from ztubt_placedbettransactionheader pbth 
--		inner join ztubt_cancelledbetticket cbt 
--			on (pbth.tranheaderid = cbt.tranheaderid)
--		inner join ztubt_cancelledbetticketlifecyclestate cblc 
--			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
--		where pbth.prodid =1
--		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
--		and cbt.cancelleddate < vToDateTimeBMCS
--		group by cbt.terdisplayid )sq
--		on (tp.terdisplayid = sq.terdisplayid)
--		where tp.prodname = 'HORSE RACING'
--		
--		union all 
--		
--		-- CAN Prodid=2,3
--		select tp.terdisplayid
--		, tp.prodname
--		, 'CAN' Flag
--		, CANAmount
--		, TicketCount
--		, null AcutalDate
--		from ubt_temp_ter_prod tp left outer join (
--		select cbt.terdisplayid , zp.prodname
--		, round(sum(cbt.cancelledamout),2) CANAmount
--		, count(cbt.tranheaderid) TicketCount
--		from ztubt_placedbettransactionheader pbth 
--		inner join ztubt_product zp 
--			on (pbth.prodid = zp.prodid)
--		inner join ztubt_cancelledbetticket cbt 
--			on (pbth.tranheaderid = cbt.tranheaderid)
--		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
--		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
--		and cbt.cancelleddate < vToDateTimeIGT
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end in (2)
--		group by cbt.terdisplayid, zp.prodname )sq
--		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
--		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO')
--		
--		union all
--		
--		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
--		-- CAN Prodid=4
--		select tp.terdisplayid
--		, tp.prodname
--		, 'CAN' Flag
--		, CANAmount
--		, TicketCount
--		, null AcutalDate
--		from ubt_temp_ter_prod tp left outer join (
--		SELECT CBT.TerDisplayID, PD.ProdName
--		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
--		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
--			, CBT.TerDisplayID, CBT.CancelledAmout
--		FROM public.ztubt_cancelledbetticket CBT 
--		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
--			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
--		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
--		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
--		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
--		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
--		where tp.prodname = 'SINGAPORE SWEEP'
--		
--		union all
--		
--		-- CAN prodid=5,6
--		select tp.terdisplayid
--		, tp.prodname
--		, 'CAN' Flag
--		, CANAmount
--		, TicketCount
--		, null AcutalDate
--		from ubt_temp_ter_prod tp left outer join (
--		select cbt.terdisplayid 
--		, round(sum(cbt.cancelledamout),2) CANAmount
--		, count(cbt.tranheaderid) TicketCount
--		from ztubt_placedbettransactionheader pbth 
--		inner join ztubt_cancelledbetticket cbt 
--			on (pbth.tranheaderid = cbt.tranheaderid)
--		inner join ztubt_cancelledbetticketlifecyclestate cblc 
--			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
--		where pbth.prodid in(5,6)
--		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
--		and cbt.cancelleddate < vToDateTimeOB
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end in (1,2)
--		group by cbt.terdisplayid )sq
--		on (tp.terdisplayid = sq.terdisplayid)
--		where tp.prodname = 'SPORTS'
--		
--	-- CAN
--		union all
--------------------------------------------------------------------------------------------------
--	-- CAS
--		select zt.terdisplayid
--		, 'NETS' as prodname
--		, 'CAS' Flag
--		, CASAmount
--		, TicketCount
--		, null AcutalDate
--		from ztubt_terminal zt left outer join (
--		select terdisplayid 
--		, sum(paidamount) as CASAmount 
--		, count(distinct paymentdetailid) as TicketCount 
--		from public.ztubt_paymentdetail zp where 1=1
--		and paymenttypeid in ('NC','NN')
--		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
--		and zp.createddate < vUTCToDateTimeNH
--		group by terdisplayid ) sq
--		 on (zt.terdisplayid=sq.terdisplayid)
--		 
--		union all 
--		
--		select zt.terdisplayid
--		, 'CASHCARD/Flashpay'
--		, 'CAS' Flag
--		, CASAmount
--		, TicketCount
--		, null AcutalDate
--		from ztubt_terminal zt left outer join (
--		select terdisplayid 
--		, sum(paidamount) as CASAmount 
--		, count(distinct paymentdetailid) as TicketCount 
--		from public.ztubt_paymentdetail zp where 1=1
--		and paymenttypeid in ('NCC','NFP')
--		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
--		and zp.createddate < vUTCToDateTimeNH
--		group by terdisplayid  )sq
--		on (zt.terdisplayid=sq.terdisplayid)
--		
--		------ Paynow, PaynowQR ------
--		union all
--		
--		select zt.terdisplayid
--		, 'Paynow [+trans fee]'
--		, 'CAS' Flag
--		, CASAmount
--		, TicketCount
--		, null AcutalDate
--		from ztubt_terminal zt left outer join (
--		select 
--		zt.terdisplayid 
--		, sum(-zp.netamount + zp.transactionfee) as CASAmount -- netamount + transfee
--		, count(distinct paymentdetailid) as TicketCount 
--		from ztubt_terminal zt 
--		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
--		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
--		where zp.paymenttypeid = 'PNRIC'
--		and zp.transactionstatus in ('01','03','04')
--		and zp.updateddatetime >= vUTCFromDateTimeNH --use updateddatetime instead of transactiondate 
--		and zp.updateddatetime < vUTCToDateTimeNH
--		group by zt.terdisplayid  ) sq
--		on (zt.terdisplayid=sq.terdisplayid)
--		
--		union all
--		
--		select zt.terdisplayid
--		, 'PaynowQR [+trans fee]'
--		, 'CAS' Flag
--		, CASAmount
--		, TicketCount
--		, null AcutalDate
--		from ztubt_terminal zt left outer join (
--		select 
--		zt.terdisplayid 
--		, sum(zp.netamount + zp.transactionfee) as CASAmount  -- netamount + transfee
--		, count(distinct paymentdetailid) as TicketCount 
--		from ztubt_terminal zt 
--		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
--		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
--		where zp.paymenttypeid = 'PNQR'
--		and zp.transactionstatus = '01'
--		and zp.updateddatetime >= vUTCFromDateTimeNH --use updateddatetime instead of transactiondate
--		and zp.updateddatetime < vUTCToDateTimeNH
--		group by zt.terdisplayid  ) sq
--		on (zt.terdisplayid=sq.terdisplayid)
--		
--		union all
--		-- transfee PayNow
--		select zt.terdisplayid
--		, 'Paynow'
--		, 'CAS' Flag
--		, CASAmount
--		, TicketCount
--		, null AcutalDate
--		from ztubt_terminal zt left outer join (
--		select 
--		zt.terdisplayid 
--		, sum(zp.transactionfee) as CASAmount  -- transfee
--		, count(distinct paymentdetailid) as TicketCount 
--		from ztubt_terminal zt 
--		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
--		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
--		where zp.paymenttypeid = 'PNRIC'
--		and zp.transactionstatus in ('01','03','04')
--		and zp.updateddatetime >= vUTCFromDateTimeNH --use updateddatetime instead of transactiondate
--		and zp.updateddatetime < vUTCToDateTimeNH
--		group by zt.terdisplayid  ) sq
--		on (zt.terdisplayid=sq.terdisplayid)
--		
--		union all
--		-- transfee PayNowQR
--		select zt.terdisplayid
--		, 'PaynowQR'
--		, 'CAS' Flag
--		, CASAmount
--		, TicketCount
--		, null AcutalDate
--		from ztubt_terminal zt left outer join (
--		select 
--		zt.terdisplayid 
--		, sum(zp.transactionfee) as CASAmount  -- transfee
--		, count(distinct paymentdetailid) as TicketCount 
--		from ztubt_terminal zt 
--		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
--		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
--		where zp.paymenttypeid = 'PNQR'
--		and zp.transactionstatus = '01'
--		and zp.updateddatetime >= vUTCFromDateTimeNH --use updateddatetime instead of transactiondate 
--		and zp.updateddatetime < vUTCToDateTimeNH
--		group by zt.terdisplayid  ) sq
--		on (zt.terdisplayid=sq.terdisplayid)
--		
--		
--	-- CAS
--		union all
--------------------------------------------------------------------------------------------------		
--	-- COL Offline Orders
--		 select 
--		 zt.terdisplayid
--		, 'Offline Orders' as prodname
--		, 'COL' Flag
--		, oo_col_amount
--		, TicketCount
--		, null AcutalDate
--		 from ztubt_terminal zt left outer join (
--		 select pb.terdisplayid 
--		 , sum(pbt.amount) oo_col_amount
--		 , count(1) TicketCount
--		 from ztubt_offlineproductheader pb 
--		 inner join ztubt_admissionvouchertransaction pbt
--		 	on (pb.transactionheaderid = pbt.headerid)
--		where 1=1
--		and pbt.isactive=true 
--		and pbt.transactiontype=1
--		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
--		and pb.transactiontime < vToDateTimeNH
--		group by pb.terdisplayid 
--		union all 
--		 select pb.terdisplayid 
--		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
--		 , sum(pbt.repeatedTicket) TicketCount
--		 from ztubt_offlineproductheader pb 
--		 inner join ztubt_charitytickettransaction pbt 
--			on (pb.transactionheaderid = pbt.headerid )
--		where 1=1
--		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
--		and pb.transactiontime < vToDateTimeNH
--		group by pb.terdisplayid 
--		union all 
--		 select pb.terdisplayid 
--		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
--		 , sum(pbt.repeatedTicket) TicketCount
--		 from ztubt_offlineproductheader pb 
--		 inner join ztubt_spatransaction pbt 
--			on (pb.transactionheaderid = pbt.headerid )
--		where 1=1
--		and pbt.transactiontype=1
--		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
--		and pb.transactiontime < vToDateTimeNH
--		group by pb.terdisplayid 
--		union all 
--		 select pb.terdisplayid 
--		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
--		 , sum(pbt.repeatedTicket) TicketCount
--		 from ztubt_offlineproductheader pb 
--		 inner join ztubt_topupcardtransaction pbt 
--			on (pb.transactionheaderid = pbt.headerid )
--		where 1=1
--		and pbt.transactiontype=1
--		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
--		and pb.transactiontime < vToDateTimeNH
--		group by pb.terdisplayid 
--		union all 
--		 select pb.terdisplayid 
--		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
--		 , sum(pbt.repeatedTicket) TicketCount
--		 from ztubt_offlineproductheader pb 
--		 inner join ztubt_totohongbaotransaction pbt 
--			on (pb.transactionheaderid = pbt.headerid )
--		where 1=1
--		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
--		and pb.transactiontime < vToDateTimeNH
--		group by pb.terdisplayid 
--		)sq
--		on (zt.terdisplayid = sq.terdisplayid)
--	
--	-- COL Offline Orders
--		union all
--------------------------------------------------------------------------------------------------		
--	
--	-- RFD Offline Orders
--		 select 
--		 zt.terdisplayid
--		, 'Offline Orders' as prodname
--		, 'RFD' Flag
--		, oo_col_amount
--		, TicketCount
--		, null AcutalDate
--		 from ztubt_terminal zt left outer join (
--		 select pb.terdisplayid 
--		 , sum(pbt.amount) oo_col_amount
--		 , count(1) TicketCount
--		 from ztubt_offlineproductheader pb 
--		 inner join ztubt_admissionvouchertransaction pbt
--		 	on (pb.transactionheaderid = pbt.headerid)
--		where 1=1
--		and pbt.isactive=true 
--		and pbt.transactiontype in (2,3)
--		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
--		and pb.transactiontime < vToDateTimeNH
--		group by pb.terdisplayid 
--		union all 
--		 select pb.terdisplayid 
--		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
--		 , sum(pbt.repeatedTicket) TicketCount
--		 from ztubt_offlineproductheader pb 
--		 inner join ztubt_spatransaction pbt 
--			on (pb.transactionheaderid = pbt.headerid )
--		where 1=1
--		and pbt.transactiontype=2
--		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
--		and pb.transactiontime < vToDateTimeNH
--		group by pb.terdisplayid 
--		union all 
--		 select pb.terdisplayid 
--		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
--		 , sum(pbt.repeatedTicket) TicketCount
--		 from ztubt_offlineproductheader pb 
--		 inner join ztubt_topupcardtransaction pbt 
--			on (pb.transactionheaderid = pbt.headerid )
--		where 1=1
--		and pbt.transactiontype=2
--		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
--		and pb.transactiontime < vToDateTimeNH
--		group by pb.terdisplayid 
--		)sq
--		on (zt.terdisplayid = sq.terdisplayid)	
--		
		union all
--------------------------------------------------------------------------------------------------
--		
--		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then round(a.amount*zg.gstrate*0.01,2) else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, sum(amount) amount , sum(TicketCount) TicketCount 
					from ubt_temp_trans_amt where flag='SAL'
					group by terdisplayid, prodname,actualDate,flag) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	select * from ubt_temp_trans_amt
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
--drop table ubt_temp_trans_final;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_pro
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransactionamountdetails_bk240320(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1179 (class 1255 OID 24808)
-- Name: sp_ubt_gettransactiondataforinterval(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransactiondataforinterval(startdatetime timestamp without time zone, enddatetime timestamp without time zone) RETURNS TABLE(uuid character varying, tranheaderid character varying, transactiontype integer, productid integer, bettypeid character varying, selection text, businessdate date, transactiontimestamp timestamp without time zone, terminalid character varying, userid character varying, locationid character varying, boardseqnumber character varying, entrymethod integer, numboards integer, numdraws integer, drawid character varying, ebetslipinfo_mobnbr character varying, numsimplebets integer, qpflag integer, nummarks integer, bulkid character varying, itoto_numparts text, itoto_totalparts text, grptoto_numparts text, eventid character varying, leaguecode character varying, liveindicator character, eventname text, market text, odds character varying, matchkickoff character varying, wager1 numeric, wager2 numeric, sales1 numeric, sales2 numeric, salescomm1 numeric, salescomm2 numeric, gst1 numeric, gst2 numeric, returnamount numeric, winningamount numeric, paymentmode character varying, cartid character varying, betlinerebateamount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
declare
startdate TIMESTAMP;
enddate timestamp;
bmcs_startdate timestamp;
igt_startdate timestamp;
ob_startdate timestamp;
bmcs_enddate timestamp;
igt_enddate timestamp;
ob_enddate timestamp;
bmcs_currentbusinessdate date;
igt_currentbusinessdate date;
ob_currentbusinessdate date;
bmcs_nextbusinessdate date;
igt_nextbusinessdate date;
ob_nextbusinessdate date;
bmcs_previousbusinessdate date;
igt_previousbusinessdate date;
ob_previousbusinessdate date;
startdateUTC timestamp;
enddateUTC timestamp;
v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

BEGIN
	
	
select 
startdatetime ,
enddatetime ,

fromdatetimebmcs ,
fromdatetimeigt ,
fromdatetimeob ,

todatetimebmcs ,
todatetimeigt ,
todatetimeob ,

(fromdatetimebmcs  ::DATE) ,
(fromdatetimeigt  :: DATE) ,
(fromdatetimeob  :: DATE) ,

(fromdatetimebmcs  ::DATE) + interval '1 Day' ,
(fromdatetimeigt  :: DATE) + interval '1 Day' ,
(fromdatetimeob  :: DATE) + interval '1 Day' ,

(fromdatetimebmcs  ::DATE)- interval '1 Day'  ,
(fromdatetimeigt  :: DATE)- interval '1 Day' ,
(fromdatetimeob  :: DATE) - interval '1 Day' ,

(startdatetime - interval '8 hour')  ,
(enddatetime - interval '8 hour')  

into 

startdate ,
enddate ,

bmcs_startdate ,
igt_startdate ,
ob_startdate ,

bmcs_enddate ,
igt_enddate ,
ob_enddate ,

bmcs_currentbusinessdate ,
igt_currentbusinessdate ,
ob_currentbusinessdate ,

bmcs_nextbusinessdate ,
igt_nextbusinessdate ,
ob_nextbusinessdate ,

bmcs_previousbusinessdate ,
igt_previousbusinessdate ,
ob_previousbusinessdate ,

startdateUTC ,
enddateUTC 
from public.sp_ubt_getcommonubtdates(StartDatetime ,StartDatetime );





--ubt_temp_placebettransaction #PBVBCBT

 create temporary table if not exists ubt_temp_placebettransaction(  
  TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(10),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  CreatedDate timestamp,
  RequestID varchar(40),
  UserDisplayID varchar(40),
  CartID varchar(50),
  TransactionType int4
 );

 


insert INTO ubt_temp_placebettransaction(TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket,TerDisplayID,CreatedDate,RequestID,UserDisplayID,CartID,TransactionType)

 
 SELECT TicketSerialNumber, PB.TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket
 ,TerDisplayID,PB.CreatedDate,RequestID,UserDisplayID,CartID, 1  TransactionType
  FROM public.ztubt_placedbettransactionheader PB  
  INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate  PBLC ON PB.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'  
  WHERE
	(PB.CreatedDate >= startdateUTC And PB.CreatedDate <= enddateUTC)
	  
  Union 
  SELECT VB.TicketSerialNumber, VB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader
  ,PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,VB.UserDisplayID,VB.CartID, 3 TransactionType
  FROM public.ztubt_validatedbetticket  VB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON VB.TicketSerialNumber = PB.TicketSerialNumber  
  INNER JOIN public.ztubt_validatedbetticketlifecyclestate VBLC ON VB.TranHeaderID = VBLC.TranHeaderID AND VBLC.BetStateTypeID = 'VB06'  
  WHERE VB.ValidationTypeID IN ('VALD', 'RFND') 
  AND   (VB.CreatedValidationDate >= startdateUTC And VB.CreatedValidationDate <= enddateUTC)
  Union
  SELECT CB.TicketSerialNumber, CB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader,
 
   PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,CB.UserDisplayID,CB.CartID,5 TransactionType
  
  FROM public.ztubt_CancelledBetTicket CB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON CB.TicketSerialNumber = PB.TicketSerialNumber
  INNER JOIN public.ztubt_cancelledbetticketlifecyclestate  CBLC ON CBLC.TranHeaderID = PB.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'  
  WHERE (PB.IsBetRejectedByTrader ) = FALSE AND (CB.CancelledDate >= startdate And CB.CancelledDate <= enddate)
  ;

 create index idx_ubt_ticketserialnumber on ubt_temp_placebettransaction(TicketSerialNumber);
 create index idx_ubt_tranheaderid on ubt_temp_placebettransaction(TranHeaderID);
create index idx_ubt_prodid on ubt_temp_placebettransaction(prodid);
create index idx_ubt_CreatedDate on ubt_temp_placebettransaction(CreatedDate);
create index idx_ubt_TransactionType on ubt_temp_placebettransaction(TransactionType);
 
 create temporary table if not exists ubt_temp_placebettransaction_type
 (TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(50),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  TransactionTypeTotal int4)
  ;
 
 insert into ubt_temp_placebettransaction_type
 
  Select TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID,
   IsBetRejectedByTrader,IsExchangeTicket, TerDisplayID
  ,SUM(TransactionType) TransactionTypeTotal 
  from ubt_temp_placebettransaction
  Group By TicketSerialNumber, TranHeaderID, DeviceID, EntryMethodID, ProdID, 
  IsExchangeTicket, TerDisplayID, IsBetRejectedByTrader
  ;
 
 create index idx_ubt_transaction_type_ticketserialnumber on ubt_temp_placebettransaction_type(TicketSerialNumber);
create index idx_ubt_transaction_type_tranheaderid on ubt_temp_placebettransaction_type(TranHeaderID);
create index idx_ubt_transaction_type_prodid on ubt_temp_placebettransaction_type(ProdID);
create index idx_ubt_transaction_type_isbetrejectedbytrader on ubt_temp_placebettransaction_type(IsBetRejectedByTrader);
create index idx_ubt_transaction_type_isexchangeticket on ubt_temp_placebettransaction_type(IsExchangeTicket);
create index idx_ubt_transaction_type_terdisplayid on ubt_temp_placebettransaction_type(TerDisplayID);
create index idx_ubt_transaction_type_transactiontypetotal on ubt_temp_placebettransaction_type(TransactionTypeTotal);
  
  --ubt_temp_placebettransaction_type #PBDVBCBT
  
   -----------------------------------------------------------------  
 --BET TYPE 
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_bettype  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemnumberid varchar(50),  
  bettypeid varchar(2)
 )  
 ; 
  

  
 --4D  
 INSERT INTO ubt_temp_bettype  
 SELECT
 PBVBCBT.TicketSerialNumber,  
 PBTLI.TranLineItemID,  
 CASE  
  WHEN PBTLI.BetTypeID = 'ORD' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN '0'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '5'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '10'  
   END  
  WHEN PBTLI.BetTypeID = 'SYS' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN   
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '1'  
WHEN PBTLI.Permutation = 12 THEN '2'  
  WHEN PBTLI.Permutation = 4 THEN '3'  
  WHEN PBTLI.Permutation = 6 THEN '4'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '6'  
  WHEN PBTLI.Permutation = 12 THEN '7'  
  WHEN PBTLI.Permutation = 4 THEN '8'  
  WHEN PBTLI.Permutation = 6 THEN '9'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
   CASE  
  WHEN PBTLI.Permutation = 24 THEN '11'  
  WHEN PBTLI.Permutation = 12 THEN '12'  
  WHEN PBTLI.Permutation = 4 THEN '13'  
  WHEN PBTLI.Permutation = 6 THEN '14'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'IBET' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '27'  
  WHEN PBTLI.Permutation = 12 THEN '28'  
  WHEN PBTLI.Permutation = 4 THEN '29'  
  WHEN PBTLI.Permutation = 6 THEN '30'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '31'  
  WHEN PBTLI.Permutation = 12 THEN '32'  
  WHEN PBTLI.Permutation = 4 THEN '33'  
  WHEN PBTLI.Permutation = 6 THEN '34'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '35'  
  WHEN PBTLI.Permutation = 12 THEN '36'  
  WHEN PBTLI.Permutation = 4 THEN '37'  
  WHEN PBTLI.Permutation = 6 THEN '38'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'ROLL' THEN  
   CASE  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '15'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber)= 2 THEN '16'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '17'  
  ELSE '18'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN 
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '19'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '20'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '21'  
  ELSE '22'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '23'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '24'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '25'  
  ELSE '26'  
 END  
   END  
 END AS BetTypeID  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitem   PBTLI ON PBVBCBT.TranHeaderID = PBTLI.TranHeaderID  
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON PBTLI.TranLineItemID = PBTLIN.TranLineItemID  
 WHERE PBVBCBT.ProdId = 2
 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0
and 
 ((PBTLIN.CreatedDate >= startdateUTC And PBTLIN.CreatedDate <= enddateUTC 
 and  PBVBCBT.TransactionTypeTotal In (1, 4, 6))	or  PBVBCBT.TransactionTypeTotal In (3,5))


 union all 
----TOTO

 
 select
 pbt.ticketserialnumber,   
 pbtli.tranlineitemid,  
 case pbtli.bettypeid   
  WHEN 'ORD'   THEN '0'  
  WHEN 'SYSR'  THEN '1'  
  WHEN 'SYS7'  THEN '2'  
  WHEN 'SYS8'  THEN '3'  
  WHEN 'SYS9'  THEN '4'  
  WHEN 'SYS10' THEN '5'  
  WHEN 'SYS11' THEN '6'  
  WHEN 'SYS12' THEN '7'  
  --totomatch
  WHEN 'M 4'  THEN '16'  
  WHEN 'M 3' THEN '17'  
  WHEN 'M 2' THEN '18'  
  WHEN 'M AN' THEN '19'  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_toto_placedbettransactionlineitem pbtli  on pbt.tranheaderid = pbtli.tranheaderid  
 where pbt.prodid = 3 and  
  ((pbtli.createddate >= startdateutc and pbtli.createddate <= enddateutc and  
  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))
 
 union all
 
 ---SWEEP

 select
 pbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 '0' as bettypeid   
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_sweep_placedbettransactionlineitemnumber pbtlin on pbt.tranheaderid = pbtlin.tranheaderid  
 where   pbt.prodid = 4
 and issoldout  <> true and 
 ((pbtlin.createddate >= startdateutc and pbtlin.createddate <= enddateutc
 and  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))

 --SPORT
 union all
 select
 pbvbcbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 case scat.categoryid when 1 
 then 
 case pbtli.accumulatorid   
  WHEN 'ACC4' THEN '4F'  
  WHEN 'DBL' THEN 'D'  
  WHEN 'SGL' THEN 'S'  
  WHEN 'TBL' THEN 'T'  
  END 
 WHEN 2 THEN 'S'
  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbvbcbt 
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on pbvbcbt.tranheaderid = pbtli.tranheaderid  
 inner  join public.ztubt_sports_placedbettransactionlineitemnumber  pbtlin on pbtli.tranlineitemid = pbtlin.tranlineitemid 
 inner join public.ztubt_sportevent se on pbtlin.eventid = se.eventid  
 inner join public.ztubt_sporttype st on se.typeid = st.typeid  
 inner join public.ztubt_sportclass sc on st.classid = sc.classid  
 inner join public.ztubt_sportcategory scat on sc.categoryid = scat.categoryid 
 where (scat.categoryid= 1)  or (scat.categoryid=2 and pbvbcbt.prodid in (5,6) )
 
 group by pbvbcbt.ticketserialnumber,pbtlin.tranlineitemid, scat.categoryid,pbtli.accumulatorid 
 ;
 
create index  ind_ticketsrno on ubt_temp_bettype(ticketserialnumber);
 -----------------------------------------------------------------  
 --DETAIL OF HORSE  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_horsedetail  
 (  
  ticketserialnumber varchar(500),  
  entrymethod int4,  
  betlinerebateamount numeric(22,2) 
 )  
 ;

 insert into ubt_temp_horsedetail
 
 
 SELECT ADP.TicketSerialNumber,
  CASE ADP.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 SUM(ADP.Amount) AS BetLineRebateAmount  
 FROM  
 (  
  SELECT   PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, EntryMethodID,  
  CASE WHEN BetTypeID = 'W-P'  
THEN (coalesce(PBTL.BoardRebateAmount,0))  
   ELSE SUM(coalesce(PBTL.BoardRebateAmount,0))   
  END AS Amount
  
  FROM ubt_temp_placebettransaction_type PBVBCBT 
  INNER JOIN   public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCBT.TranHeaderID = PBTL.TranHeaderID  
	WHERE  PBVBCBT.ProdID = 1 and 
	((PBTL.CreatedDate >= startdateUTC And PBTL.CreatedDate <= enddateUTC 	
AND PBVBCBT.TransactionTypeTotal In (1, 4, 6) ) or PBVBCBT.TransactionTypeTotal in (3,5))
  GROUP BY  PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BoardRebateAmount, EntryMethodID
 )ADP  
 GROUP BY ADP.TicketSerialNumber, ADP.EntryMethodID
 ;
 
create index idx_ubt_horse_ticketsrno on ubt_temp_horsedetail(TicketSerialNumber);
 -----------------------------------------------------------------  
 --DETAIL OF LOTTERY  
 -----------------------------------------------------------------  
  
 create temporary table if not exists ubt_temp_numboards  
 (  
  ticketserialnumber varchar(500),  
  numboards int4,  
  bulkid varchar(50)
 ) ; 
  
 INSERT INTO ubt_temp_NumBoards  
 --4D
 SELECT DISTINCT PBT.TicketSerialNumber,   
 COUNT(z4dln.TranLineItemID) AS NumBoards,  
 NULL AS BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN   public.ztubt_4d_placedbettransactionlineitemnumber  z4dln ON PBT.TranHeaderID = z4dln.TranHeaderID  
 WHERE PBT.ProdID = 2 and  coalesce(z4dln.BigBetAcceptedWager, 0) + coalesce(z4dln.SmallBetAcceptedWager, 0) > 0 AND
 ((z4dln.CreatedDate >= StartDateUTC And z4dln.CreatedDate <= EndDateUTC  
  AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 
 GROUP BY PBT.TicketSerialNumber 
 
 
 union all 
 --TOTO
 
 select pbvbcbt.ticketserialnumber,   
 count(pbtl.tranlineitemid) as numboards,  
 null as bulkid  
 from ubt_temp_placebettransaction_type pbvbcbt   
 inner join  public.ztubt_toto_placedbettransactionlineitem  pbtl on pbvbcbt.tranheaderid = pbtl.tranheaderid  
 where   pbvbcbt.prodid = 3 and  
 ((pbtl.createddate >= startdateUTC and pbtl.createddate <= enddateUTC and
  pbvbcbt.transactiontypetotal in (1, 4, 6)) or pbvbcbt.transactiontypetotal in (3,5))
 group by pbvbcbt.ticketserialnumber  

 
 union  all 
 
 --SWEEP
 SELECT PBT.TicketSerialNumber,   
 COUNT(PLN.TranLineItemID) AS NumBoards,  
 BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitem  PL ON PBT.TranHeaderID = PL.TranHeaderID  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitemnumber  PLN ON PL.TranLineItemID = PLN.TranLineItemID  
 WHERE  PBT.ProdID = 4 AND IsSoldOut <> true and
 ((PLN.CreatedDate >= StartDateUTC And PLN.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  
 GROUP BY PBT.TicketSerialNumber, BulkID 
 
 ;
create index idx_ubt_numboard_ticketsrno on ubt_temp_numboards (TicketSerialNumber);

create temporary table ubt_temp_LotteryDraw
( TicketSerialNumber varchar (200),
HostDrawDatesId varchar(20)
)
 ;
	insert into ubt_temp_LotteryDraw
Select PBTT.TicketSerialNumber, CAST(zdm.HostDrawDatesId AS VARCHAR) HostDrawDatesId

	FROM ubt_temp_placebettransaction_type PBTT  
	INNER JOIN public.ztubt_drawdates zdm  ON PBTT.TranHeaderID = zdm.TranHeaderID   
	Where  PBTT.ProdID In (2,3,4) 

;	
create index idx_ubt_lotterydraws_ticketsrno on ubt_temp_LotteryDraw (TicketSerialNumber,HostDrawDatesId);

create temporary table ubt_temp_numdraws
( TicketSerialNumber varchar (200),
NumDraws int4,
Drawid varchar(50)
)
 ;
	insert into ubt_temp_numdraws
	SELECT
	LD.TicketSerialNumber,
	Count(1) NumDraws,
	string_agg(CAST(LD.HostDrawDatesId AS varchar),',' ) as Drawid

	From ubt_temp_LotteryDraw LD 
	Group By LD.TicketSerialNumber

;
	
create index idx_ubt_numdraws_ticketsrno on ubt_temp_numdraws (TicketSerialNumber);

 create temporary table if not exists ubt_temp_lotterydetail  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemid varchar(50),  
  boardseqnumber int,  
  entrymethod int,  
  numboards int,  
  numdraws int,  
  drawid varchar(500),  
  ebetslipinfo_mobnbr varchar(100),  
  numsimplebets int4,  
  qpflag int4,  
  nummarks int4,  
  bulkid varchar(50), --(5)  
  itoto_numparts text, -- varchar(max)  
  itoto_totalparts text,   --varchar(max)
  grptoto_numparts text   --varchar(max)
 )  
  
 ;
 create temporary table if not exists ubt_temp_TotoSeq (  
  TranLineItemID varchar(50),  
  Seq INT4  
 )  
  ;
 create temporary table if not exists ubt_Temp_TotoGroup ( 
  GroupHostID varchar(50),  
  GroupToto INT4 
 ) ; 
  
 INSERT INTO ubt_temp_TotoSeq  
 SELECT LIN.TranLineItemID, MAX(LIN.Sequence) AS Seq  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join  public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitemnumber  LIN on LI.TranLineItemID = LIN.TranLineItemID
 WHERE PBT.ProdID = 3 and 
 ((LI.CreatedDate >= StartDateUTC And LI.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY LIN.TranLineItemID  
 ;
 
 INSERT INTO ubt_Temp_TotoGroup 
 SELECT LI2.GroupHostID, MAX(LI2.GroupUnitSequence) AS GroupToto  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitem LI2 on LI.GroupHostID = LI2.GroupHostID
 WHERE PBT.ProdID = 3
 AND LI.GroupHostID <> '00000000-0000-0000-0000-000000000000' AND LI.GroupUnitSequence IS NOT NULL 
 GROUP BY LI2.GroupHostID
 
 ;
 --4D
 
 INSERT INTO ubt_Temp_LotteryDetail  
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
   PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
   PBVBCBT.TransactionTypeTotal In (1, 4, 6)  

union all 

 
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)

 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
 PBVBCBT.TransactionTypeTotal in (3,5)
  
union all
 
 --TOTO  
  
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE 
  WHEN TOTO.BetTypeID = ANY(v_totomatchBettypes) THEN 1
  WHEN TOTO.BetTypeID = 'ORD' THEN 1  
  WHEN TOTO.BetTypeID = 'SYSR' THEN 44  
  WHEN TOTO.BetTypeID = 'SYS7' THEN 7  
  WHEN TOTO.BetTypeID = 'SYS8' THEN 28  
  WHEN TOTO.BetTypeID = 'SYS9' THEN 84  
  WHEN TOTO.BetTypeID = 'SYS10' THEN 210  
  WHEN TOTO.BetTypeID = 'SYS11' THEN 462  
  WHEN TOTO.BetTypeID = 'SYS12' THEN 924 
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and 
 TOTO.CreatedDate >= StartDateUTC And TOTO.CreatedDate <= EndDateUTC   
 AND PBVBCBT.TransactionTypeTotal In (1, 4, 6)
 
 union all 
 
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE 
  WHEN TOTO.BetTypeID = ANY(v_totomatchBettypes) THEN 1
  WHEN TOTO.BetTypeID = 'ORD' THEN 1
  WHEN TOTO.BetTypeID = 'SYSR' THEN 44
  WHEN TOTO.BetTypeID = 'SYS7' THEN 7
  WHEN TOTO.BetTypeID = 'SYS8' THEN 28
  WHEN TOTO.BetTypeID = 'SYS9' THEN 84
  WHEN TOTO.BetTypeID = 'SYS10' THEN 210
  WHEN TOTO.BetTypeID = 'SYS11' THEN 462 
  WHEN TOTO.BetTypeID = 'SYS12' THEN 924
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and PBVBCBT.TransactionTypeTotal in (3,5)
 
 union all 
 
 --SWEEP
 
 SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and 
PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
  PBVBCBT.TransactionTypeTotal In (1, 4, 6)
  
  union all 
  
  SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and PBVBCBT.TransactionTypeTotal In (3,5)

;
 
create index idx_ubt_lotterydetail_ticketsrno  on ubt_Temp_LotteryDetail(TicketSerialNumber);
create index idx_ubt_lotterydetail_tranlineitemid  on ubt_Temp_LotteryDetail(TranLineItemID);
 -----------------------------------------------------------------  
 --DETAIL OF SPORTS  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_Liveindidcator  
 (  
  TicketSerialNumber VARCHAR(500),  
  LiveIndicator CHAR(1)  
 )  
  ;
 INSERT INTO ubt_temp_Liveindidcator  
 SELECT din.TicketSerialNumber,   
 CASE  
  WHEN (din.HasBetInRun = TRUE) AND (din.CreatedDate BETWEEN din.StartTime AND din.SuspendTime) THEN 'Y'  
  ELSE 'N'  
 END AS LiveIndicator  
 FROM  
 (  
  SELECT ROW_NUMBER() OVER (PARTITION BY SPBN.TranHeaderID 
  							ORDER BY SPBN.TranLineItemID
--		  					ORDER BY split_part(SPBN.tranlineitemid,'-',5)
--									,split_part(SPBN.tranlineitemid,'-',4)
--									,split_part(SPBN.tranlineitemid,'-',3)
--									,split_part(SPBN.tranlineitemid,'-',2)
--									,split_part(SPBN.tranlineitemid,'-',1)
  							) AS ROWNUM,
  PBVBCBT.TicketSerialNumber, SE.HasBetInRun, SE.StartTime, SE.SuspendTime, SPBN.CreatedDate  
  FROM ubt_temp_placebettransaction_type PBVBCBT
  INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  SPBN ON PBVBCBT.TranHeaderID = SPBN.TranHeaderID  
  INNER join public.ztubt_sportevent SE ON SPBN.EventID = SE.EventId  
  WHERE PBVBCBT.ProdID IN(5,6)
 )din  
 WHERE din.ROWNUM = 1  
;
create index idx_ubt_liveindicator_ticketsrno  on ubt_temp_Liveindidcator(TicketSerialNumber); 

 create temporary table if not exists ubt_temp_sportsdetail
 (  
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID Varchar(50),--(1)  
  EntryMethod INT4,  
  EventID VARCHAR(500),  
  LeagueCode VARCHAR(500),  
  LiveIndicator CHAR(1),  
  EventName text,  
  BetTypeName text,  
  Selection VARCHAR(500),  
  SelectionOdds VARCHAR(500),  
  StartTime VARCHAR(500),  
  BetType VARCHAR(500)
 )  
  ;
 INSERT INTO ubt_temp_sportsdetail  
 SELECT PBVBCBT.TicketSerialNumber,   
 PLN.TranLineItemID,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 PLN.EventID AS EventID,  
 SL.LeagueCode AS LeagueCode,  
 LI.LiveIndicator :: char AS LiveIndicator,  
 PLN.EventName AS EventName,  
 PLN.BetTypeName AS BetTypeName,  
 PLN.SelectionName AS Selection,  
 PLN.SelectionOdds AS SelectionOdds,  
 --to_char(SE.StartTime, 'yyyyMMdd HHmmss') AS StartTime, b.BetTypeID 
to_char(SE.StartTime, 'yyyyMMdd HH24miss') AS StartTime, b.BetTypeID 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  PLN ON PBVBCBT.TranHeaderID = PLN.TranHeaderID
 INNER JOIN public.ztubt_sportevent  SE ON PLN.EventID = SE.EventId  
 INNER JOIN public.ztubt_sporttype  ST ON SE.TypeId = ST.TypeId  
 INNER JOIN public.ztubt_sportleagueinfo  SL ON REPLACE(ST.Name, '|', '') = REPLACE(SL.Name, '|', '')  
 INNER JOIN ubt_temp_Liveindidcator LI ON PBVBCBT.TicketSerialNumber = LI.TicketSerialNumber  
 inner join ubt_temp_bettype b on b.TranLineItemNumberID = PLN.TranLineItemID  
 LEFT JOIN public.ztubt_entrymethod  EM ON PBVBCBT.EntryMethodID = EM.EntryMethodID  
 WHERE PBVBCBT.ProdID IN (5,6)  
 GROUP BY PBVBCBT.TicketSerialNumber, PLN.TranLineItemID, PBVBCBT.EntryMethodID, PLN.EventID, SL.LeagueCode, 
 LI.LiveIndicator, PLN.EventName, PLN.BetTypeName, PLN.SelectionOdds, SE.StartTime,  b.BetTypeID, PLN.SelectionName  
 ;

create index idx_ubt_sportdetail_ on ubt_temp_sportsdetail(TicketSerialNumber,TranLineItemID);
 
  
 -------------------------------------------------------------------------  
 --GET TRANSACTION (COLLECTION, VALIDATION, CANCELLATION) PER AD HOC TIME  
 -------------------------------------------------------------------------  
 create temporary table if not exists ubt_temp_trans  
 (  
  EntryMethodID VARCHAR(10),  --(S5)
  ProdID int4,  --(S5)
  IsBetRejectedByTrader bool, --(S5)
  TicketSerialNumber VARCHAR(200),  
  UUID VARCHAR(33),  
  TransactionType INT4,  
  TransactionDate timestamp,  
  TerminalID VARCHAR(100),  
  UserID VARCHAR(100),  
  LocationID VARCHAR(200),  
  CartID varchar(50),  
  TranHeaderID varchar(50)
 )  
   ;
-------COLLECTION--------------
   
 --HORSE RACING  
  INSERT INTO ubt_temp_trans  
  SELECT  
  PB.EntryMethodID, 
  PB.ProdID,  --(S5)
  PB.IsBetRejectedByTrader , --(S5)
  PB.TicketSerialNumber AS TSN,  
  PB.RequestID AS UUID,  
  1 AS TransactionType, --Wager  
  ( PB.CreatedDate + interval '8 hour'),  
 PB.TerDisplayID AS TerminalID,  PB.UserDisplayID AS UserID,  L.LocDisplayID AS LocationID,  
  PB.CartID,  
  PB.TranHeaderID  
  FROM ubt_temp_placebettransaction PB  
  INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.terdisplayid  
  LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
  WHERE PB.ProdID  in (1, 2, 3, 4, 5, 6) and  
   PB.TransactionType = 1 
 AND  (PB.CreatedDate >= StartDateUTC And PB.CreatedDate <= EndDateUTC) 
 
  --ProdID = 1 --HORSE RACING
  --ProdId=2,3,4 Lottery
  --prodid=5,6 sports
  
  ------------VALIDATION -----------
  
  
  
union all 
--Horse Racing

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID = 1 
 AND (coalesce (zv.WinningAmount,0) > 0 OR coalesce (zv.RebateReclaim,0) > 0) 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 --Lottery(prod id (2,3,4)  & Sports prodid (5,6)
 union all 
 

 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 zv.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (2,3,4)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 union all 
 
 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' -- Issue:Fixed on 20220221 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 
 
union all 
--refund

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 61 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (5, 6) 
 AND  zv.ValidationTypeID = 'RFND' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
---- ----CANCELLATION-------------------
 union all
 --Horse racing prodid (1) & Lottery prodid (2,3,4)
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID =1 --HORSE RACING  
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 

 union all 
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 cbt.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (2,3,4)  -- Lottery
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
union all
 --Sports
 
  SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)   --SPORTS
 AND PB.TransactionType = 5 
 AND PB.IsBetRejectedByTrader = false 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
 ;

create index idx_ubt_trans_ticketserialnumber on ubt_temp_trans(TicketSerialNumber);
create index idx_ubt_trans_tranheaderid on ubt_temp_trans(TranHeaderID);
  --FINAL RESULT OF TRANSACTIONAL VIEW  
 -----------------------------------------------------------------  
  
  
 create temporary table if not exists ubt_temp_transactionamount(
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID varchar(50),  
  Wager numeric(22,2), 
  SecondWager numeric(22,2), 
  Sales numeric(22, 11),  
  SecondSales numeric(22, 11),  
  SalesComm numeric(22, 11),  
  SecondSalesComm numeric(22, 11),  
  GST numeric(22, 11),  
  SecondGST numeric(22, 11),  
  ReturnAmount  numeric(22,2),  
  WinningAmount  numeric(22,2),  
  RefundAmount  numeric(22,2),  
  RebateReclaim  numeric(22,2)
 )  
  
 ;
 --COLLECTION 
 
 
 create temporary table if not exists ubt_temp_resultwager  
(  
ProdID int4,
 TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
 Wager numeric(22,2), 
 SecondWager numeric(22,2)
)  
;
 insert into ubt_temp_resultwager
 select 1::int4 ProdID, amtw.TicketSerialNumber, null , SUM(amtw.Amount) AS Wager, 0 AS SecondWager  
 FROM  
(  
SELECT   PBVBCB.TicketSerialNumber, PBTL.TranHeaderID,  
CASE WHEN BetTypeID = 'W-P' 
THEN (coalesce (PBTL.BetPriceAmount,0))  
ELSE SUM(coalesce (PBTL.BetPriceAmount,0))   
END AS Amount,  
COUNT(DISTINCT PBVBCB.TicketSerialNumber) Ct, 'COL' AS Flag,'CH' AS TransType  
FROM  
ubt_temp_placebettransaction_type PBVBCB 
INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCB.TranHeaderID = PBTL.TranHeaderID 
WHERE PBVBCB.ProdID = 1
and ((PBTL.CreatedDate >= StartDateUTC And PBTL.CreatedDate <= EndDateUTC
AND PBVBCB.TransactionTypeTotal In (1, 4, 6) ) or PBVBCB.TransactionTypeTotal in (3,5))

GROUP BY  PBVBCB.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BetPriceAmount 	
)amtw  
GROUP BY amtw.TicketSerialNumber

union all 

--4D

SELECT  2::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BigBetAcceptedWager,0)) AS Wager, SUM(coalesce (zdp.SmallBetAcceptedWager,0)) AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  
INNER JOIN public.ztubt_drawdates zd   ON zd.TranHeaderID = zdp.TranHeaderID   
WHERE  PBT.ProdID = 2 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >=StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID  


union all 
--toto

SELECT  3::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BetPriceAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  

WHERE  PBT.ProdID = 3 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 

--sweep

SELECT   4::int4 ProdID, PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.BetPriceAmount,0)) AS Wager, 0 AS SecondWager 
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = False  
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zplc   ON zplc.TranHeaderID = PBT.TranHeaderID  
INNER JOIN (select terdisplayid,Locid from public.ztubt_terminal ) Ter  ON PBT.TerDisplayID = Ter.TerDisplayID
INNER JOIN (Select * from  public.ztubt_location) Loc  ON Ter.LocID = Loc.LocID
WHERE ( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zplc.BetStateTypeID = 'PB06' ) 	
		OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zplc.BetStateTypeID = 'PB03' ) )
AND PBT.ProdID=4
AND ((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 

--sports

SELECT   FIN.ProdID ProdID, FIN.TicketSerialNumber, NULL, SUM(coalesce (FIN.BetAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
(  
select PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, BetAmount, TicketSerialNumber  
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sports_placedbettransactionlineitem zsp  ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE   
PBT.ProdID IN (5, 6) AND PBT.IsBetRejectedByTrader != TRUE 
GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet, AccumulatorID, BetAmount, TicketSerialNumber  
)FIN  
GROUP BY FIN.TicketSerialNumber, FIN.ProdID 
;

create index idx_ubt_resultwager_TicketSerialNumber  on ubt_temp_resultwager(TicketSerialNumber);
create index idx_ubt_resultwager_tranlineitemid  on ubt_temp_resultwager(TranLineItemID);

--For Sales Comm, Sales Factor and Output GST  
create temporary table if not exists ubt_temp_resultsalescomwithdate  
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 SalesCommAmount numeric(32, 12),  
 SalesFactorAmount numeric(32, 12),  
 SecondSalesCommAmount numeric(32, 12),  
 SecondSalesFactorAmount numeric(32, 12),  
 GSTRate numeric(10, 2)
)  ;
  
--Toto

insert into ubt_temp_resultsalescomwithdate
select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmount,0)) SalesCommAmount,
SUM(coalesce (zdp.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
	ubt_temp_placebettransaction_type PBT  
	Inner jOin public.ztubt_toto_placedbettransactionlineitem  zdp   ON PBT.TranHeaderID = zdp.TranHeaderID
WHERE  PBT.ProdID = 3 
AND PBT.IsExchangeTicket = FALSE  
AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <=EndDateUTC
AND  PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 
--horse

SELECT amt.TicketSerialNumber, NULL  , SUM(amt.SalesCommAmount) , SUM(amt.SalesFactorAmount)  , 0 , 0  
FROM  
(  
 SELECT   PBT.TicketSerialNumber, zhp.TranHeaderID,  
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesCommAmount,0))  
  ELSE SUM(coalesce (zhp.SalesCommAmount,0))   
 END AS SalesCommAmount,   
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesFactorAmount,0))  
  ELSE SUM(coalesce (zhp.SalesFactorAmount,0))   
 END AS SalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT  
	 INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  zhp ON PBT.TranHeaderID = zhp.TranHeaderID  
	 INNER JOIN (select Terdisplayid,LocID from public.ztubt_terminal zt) Ter ON PBT.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0   
	 where PBT.ProdID = 1 and 
	 (
	 	(zhp.CreatedDate >= StartDateUTC 
	 	 And zhp.CreatedDate <= EndDateUTC
	  	 AND PBT.TransactionTypeTotal In (1, 4, 6)) 
	  or 
	  	(PBT.TransactionTypeTotal In (3, 5))
	 )  
 GROUP BY PBT.TicketSerialNumber, zhp.TranHeaderID, zhp.CreatedDate::Date
 , BetTypeID, SalesCommAmount, SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber


union all 

--4D

select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmountBig,0)) SalesCommAmount, 
 SUM(coalesce (zdp.SalesFactorAmountBig,0)) SalesFactorAmount, SUM(coalesce (zdp.SalesCommAmountSmall,0)) SecondSalesCommAmount
, SUM(coalesce (zdp.SalesFactorAmountSmall,0)) SecondSalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT   
	 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber zdp   ON zdp.TranHeaderID = PBT.TranHeaderID  
	 INNER JOIN  public.ztubt_drawdates zd ON zd.TranHeaderID = PBT.TranHeaderID --(7)  
 where PBT.ProdID = 2 and 
  ((zdp.CreatedDate >= StartDateUTC  And zdp.CreatedDate <=EndDateUTC
   AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  AND PBT.IsExchangeTicket = false 
 GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID

union all 

--sweeep

SELECT  PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (zspn.SalesFactorAmount,0)) SalesFactorAmount, 0, 0  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = FALSE 
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zpls   ON zpls.TranHeaderID = PBT.TranHeaderID 
 INNER JOIN (Select terdisplayid, Locid from public.ztubt_terminal ) Ter ON PBT.TerDisplayID = Ter.TerDisplayID 
 INNER JOIN (Select locid,locdisplayid,sweepindicator from public.ztubt_location ) Loc ON Ter.LocID = Loc.LocID 
WHERE PBT.ProdID=4  and 
( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zpls.BetStateTypeID = 'PB06' ) 	
	OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zpls.BetStateTypeID = 'PB03' ) )
and
((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC

	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	
GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 
--Sports

select amt.TicketSerialNumber, NULL , SUM(coalesce (amt.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (amt.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
(  
 SELECT PBT.ProdID ProductName, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, SalesCommAmount, TicketSerialNumber, SalesFactorAmount  
 FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN  public.ztubt_sports_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE PBT.ProdID IN (5,6)
 AND
 PBT.IsBetRejectedByTrader=false 
 GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,
 AccumulatorID, SalesCommAmount, TicketSerialNumber, (zsp.CreatedDate :: date), SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber
;

create index idx_ubt_resulsalescomwithdate_ticket on ubt_temp_resultsalescomwithdate(TicketSerialNumber);
create index idx_ubt_resulsalescomwithdate_tranlineitemid on ubt_temp_resultsalescomwithdate(TranLineItemID);


 create temporary table if not exists ubt_temp_resultsalesandcomm   
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 Sales numeric(32, 12),  
 SecondSales numeric(32, 12),
 SalesComm numeric(22, 11),  
 SecondSalesComm numeric(22, 11)
)  
  ;
INSERT INTO ubt_temp_resultsalesandcomm  
SELECT FIN.TicketSerialNumber, FIN.TranLineItemID, SUM(FIN.SalesFactorAmount), 
SUM(FIN.SecondSalesFactorAmount), SUM(FIN.SalesCommAmount), SUM(FIN.SecondSalesCommAmount)  
FROM ubt_temp_resultsalescomwithdate FIN  
GROUP BY FIN.TicketSerialNumber, FIN.TranLineItemID  

;

create index idx_ubt_resulsalescom_ticket on ubt_temp_resultsalesandcomm(TicketSerialNumber);
create index idx_ubt_resulsalescom_tranlineitemid on ubt_temp_resultsalesandcomm(TranLineItemID);

---------------------------------------------------------  
--GST (OUTPUT GST = WAGER - SALES)  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultGST   
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
GST numeric(22, 11),  
SecondGST numeric(22, 11)
) ; 
   
--LOTTERY(2,3,4) and Horse(1) and Sports(5,6)

INSERT INTO ubt_temp_resultGST   
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber AND w.TranLineItemID = S.TranLineItemID  
WHERE w.ProdID IN (2, 3, 4) 
union all 
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber 
WHERE w.ProdID IN (1,5,6) 

;

create index idx_ubt_resultGST_ticket on ubt_temp_resultGST(TicketSerialNumber);
create index idx_ubt_resultGST_tranlineitemid on ubt_temp_resultGST(TranLineItemID);

---------------------------------------------------------  
--VALIDATION  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultvalidation 
(   
TicketSerialNumber VARCHAR(200),  
ReturnAmount numeric(22,2), 
WinningAmount numeric(22,2),
RefundAmount numeric(22,2), 
RebateReclaim numeric(22,2) 
)  
  
;
INSERT INTO ubt_temp_resultvalidation  
SELECT zv.TicketSerialNumber,   
zv.WinningAmount AS ReturnAmount,  
CASE WHEN coalesce(zv.WinningAmount, 0) > 0 THEN  
zv.WinningAmount - (SUM(RW.Wager)/coalesce (COUNT(RW.TicketSerialNumber),1)) - (SUM(RW.SecondWager)/coalesce(COUNT(RW.TicketSerialNumber),1)) --(6) 
ELSE  0
  
END AS WinningAmount, --(4)  
zv.RefundAmount, zv.RebateReclaim --(1)  
FROM ubt_temp_resultwager RW  
 INNER join public.ztubt_validatedbetticket zv   ON RW.TicketSerialNumber = zv.TicketSerialNumber  
 INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvlc   ON zv.TranHeaderID = zvlc.TranHeaderID AND zvlc.BetStateTypeID = 'VB06'  
 WHERE zv.ValidationTypeID IN ('VALD', 'RFND') --(1)  
 GROUP BY zv.TicketSerialNumber, zv.WinningAmount, zv.RefundAmount, zv.RebateReclaim
 
 ;

create index idx_ubt_resultvalidation_ticket on ubt_temp_resultvalidation(TicketSerialNumber);
 ---------------------------------------------------------  
--VALIDATION EXCHANGE TICKET  
---------------------------------------------------------  
  
create temporary table if not exists ubt_temp_resultvalidationexchange
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
WinningAmount numeric(22,2), 
RefundAmount numeric(22,2),  
RebateReclaim numeric(22,2) 
)  
;
 
INSERT INTO ubt_temp_resultvalidationexchange  
select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_4d_placedbettransactionlineitem zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=2 And PBT.IsExchangeTicket= true

union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=3 And PBT.IsExchangeTicket= TRUE
   
union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=4 And PBT.IsExchangeTicket= TRUE

;

create index idx_ubt_resultvalidationexc_ticket on ubt_temp_resultvalidationexchange(TicketSerialNumber);
create index idx_ubt_resultvalidationexc_tranlinetiemid on ubt_temp_resultvalidationexchange(TranLineItemID);
---------------------------------------------------------  
--FINAL RESULT  
---------------------------------------------------------  

--HORSE RACING(1), lOTEERY(2,3,4), SPORTS(5,6)
 INSERT INTO ubt_temp_transactionamount  
SELECT W.TicketSerialNumber, W.TranLineItemID, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (2, 3, 4)
GROUP BY W.TicketSerialNumber, W.TranLineItemID  

union all
SELECT W.TicketSerialNumber, null, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber --AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber --AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (1, 5,6)
GROUP BY W.TicketSerialNumber  


union all 

select TicketSerialNumber, TranLineItemID, 0 AS Wager, 0 AS SecondWager, 0 AS Sales, 0 AS SecondSales, 
0 AS SalesCom, 0 AS SecondSalesCom, 0 AS GST, 0 AS SecondGST, WinningAmount, WinningAmount, RefundAmount, RebateReclaim  
FROM ubt_temp_resultvalidationexchange 

;

create index idx_ubt_transactionamt_ticket on ubt_temp_transactionamount(TicketSerialNumber);
create index idx_ubt_transactionamt_tranlineitemid on ubt_temp_transactionamount(TranLineItemID);

create temporary table if not exists ubt_temp_transactiondata
(
		--transid bigint  ,--primary key clustered,
		uuid varchar(33) ,
		transactiontype int4 ,
		productid int4 ,
		bettypeid varchar(2) ,
		selection text ,
		businessdate date ,
		transactiontimestamp timestamp ,
		terminalid varchar(100) ,
		userid varchar(100) ,
		locationid varchar(200) ,
		cartid varchar(50) ,
		tranheaderid varchar(50) ,
		boardseqnumber varchar(50) ,
		entrymethod int4 ,
		numboards int4 ,
		numdraws int ,
		drawid varchar(500) ,
		ebetslipinfo_mobnbr varchar(100) ,
		numsimplebets int4 ,
		qpflag int4 ,
		nummarks int4 ,
		bulkid varchar(50) ,
		itoto_numparts text ,
		itoto_totalparts text ,
		grptoto_numparts text ,
		eventid varchar(500) ,
		leaguecode varchar(500) ,
		liveindicator char(1) ,
		eventname text ,
		market text ,
		odds varchar(500) ,
		matchkickoff varchar(500) ,
		wager1 numeric(22, 2) ,
		wager2 numeric(22, 2) ,
		sales1 numeric(22, 11) ,
		sales2 numeric(22, 11) ,
		salescomm1 numeric(22, 11) ,
		salescomm2 numeric(22, 11) ,
		gst1 numeric(22, 11) ,
		gst2 numeric(22, 11) ,
		returnamount numeric(22, 2) ,
		winningamount numeric(22, 2) ,
		betlinerebateamount numeric(22, 2) ,
		paymentmode varchar(2) 
	)
;
create temporary table if not exists ubt_temp_final_lotteryselect
(  
	ticketserialnumber varchar(500),  
	tranlineitemid varchar(50),  
	selection text
)   
;
 --HORSE RACING  

INSERT INTO ubt_temp_final_lotteryselect  
SELECT PBT.TicketSerialNumber, NULL AS TranLineItemID,   
 string_agg(CAST(PL.BetLineAnnotation AS VARCHAR)  ,',') AS BetLineAnnotation 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN public.ztubt_horse_placedbettransactionlineitem PL ON PBT.TranHeaderID = PL.TranHeaderID  
 WHERE  PBT.ProdID=1 and 
 ((PL.CreatedDate >= StartDateUTC And PL.CreatedDate <=EndDateUTC
 And PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY PBT.TicketSerialNumber, PBT.TranHeaderID

--4D
 union all 
 
 select TicketSerialNumber, TranLineItemID, (pbtln.SelectedBetNumber :: varchar(10))   
from ubt_temp_placebettransaction_type PBT   
inner join public.ztubt_4d_placedbettransactionlineitemnumber  pbtln on PBT.TranHeaderID = pbtln.TranHeaderID
WHERE PBT.ProdID = 2 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))


union all 
--toto
select TicketSerialNumber, pbtln.TranLineItemID, string_agg((ztp.singleBetNumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT  
inner join public.ztubt_toto_placedbettransactionlineitem   pbtln on PBT.TranHeaderID = pbtln.TranHeaderID  
inner join public.ztubt_toto_placedbettransactionlineitemnumber ztp on pbtln.tranlineitemid =ztp.tranlineitemid 
WHERE PBT.ProdID = 3 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID

--sweep
union all 

select TicketSerialNumber, pbtln.TranLineItemID, string_agg((pbtln.selectednumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT
inner join public.ztubt_sweep_placedbettransactionlineitemnumber  pbtln on pbtln.tranheaderid =PBT.tranheaderid 
WHERE PBT.ProdID = 4 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID


--sports

union all 

select pb.ticketserialnumber,   
 pln.tranlineitemid as tranlineitemid,  
 pln.selectionname as selection  
 from ubt_temp_placebettransaction_type ph   
 inner join public.ztubt_sports_placedbettransactionlineitemnumber  pln  on ph.tranheaderid = pln.tranheaderid
 inner join ubt_temp_placebettransaction_type pb on ph.ticketserialnumber = pb.ticketserialnumber --(2)  
 where pb.prodid in (5, 6)
 group by pb.ticketserialnumber, pln.tranlineitemid, pln.selectionname

;
 
create index idx_ubt_lotteryselect_ticket on ubt_temp_final_lotteryselect(ticketserialnumber);
create index idx_ubt_lotteryselect_tranlineitemid on ubt_temp_final_lotteryselect(tranlineitemid);
 --=====================================================================================  
---Transaction Data Interface table-----------------------------------------------------
 --=====================================================================================
 
 --LOTTERY (Per UUID and boards under one TSN)  
 insert into ubt_temp_transactiondata  
 select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid,  s.selection as selection,  
 case when t.transactiondate < igt_startdate then igt_previousbusinessdate 
 when t.transactiondate > igt_enddate then igt_nextbusinessdate
 else igt_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid, t.locationid, t.cartid, t.tranheaderid,  
 -----lottery section  
 coalesce(concat(t.uuid , ' - ' ,right(concat('00' , cast (ld.boardseqnumber as varchar)),2)), t.uuid) as boardseqnumber,  
 ld.entrymethod,   ld.numboards, ld.numdraws, ld.drawid,ld.ebetslipinfo_mobnbr, ld.numsimplebets,ld.qpflag,
 ld.nummarks,   ld.bulkid,  ld.itoto_numparts,ld.itoto_totalparts, ld.grptoto_numparts,    

 -----sports section  
 null, null, null, null, null, null, null,

 -----value amount section  
 coalesce(amt.wager, 0) as wager,   
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then   amt.returnamount else 0  end as returnamount,
 case when transactiontype = 3 then   amt.winningamount else 0 end as winningamount,  
  null,
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_Temp_LotteryDetail ld on t.ticketserialnumber = ld.ticketserialnumber and bt.tranlineitemnumberid = ld.tranlineitemid   
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber and ld.tranlineitemid = s.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber and ld.tranlineitemid = amt.tranlineitemid  
 where t.prodid in (2,3,4) and bettypeid is not null and t.isbetrejectedbytrader = false
 and (t.transactiondate between startdate and enddate) 
  
 order by t.uuid  
 ; 
 insert into ubt_temp_transactiondata  
-- union all 
 
 --HORSE RACING (Per UUID)  

 select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid, --(19) bt.bettypeid as bettypeid,  
 s.selection as selection,  
  case when t.transactiondate < bmcs_startdate then bmcs_previousbusinessdate
	  when t.transactiondate > bmcs_enddate then bmcs_nextbusinessdate
	  else bmcs_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,  t.userid,t.locationid,t.cartid, t.tranheaderid,
   
 -----lottery section  
 t.uuid as boardseqnumber,  
 case t.entrymethodid  
  WHEN 'MANUAL' THEN 0  
  WHEN 'BETSLIP' THEN 2  
  WHEN 'EDIT' THEN 10  
  WHEN 'EBETSLIP' THEN 16  
 end as entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
 
 -----sports section   
 null,null,null,null,null,null,null,
 
 -----value amount section   
 coalesce(amt.wager, 0) as wager,  
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then amt.returnamount else 0 end as returnamount,  
 case when transactiontype = 3 then amt.winningamount else 0 end as winningamount,
 case when t.transactiontype = 3 then amt.rebatereclaim else coalesce(hd.betlinerebateamount,0)   end as betlinerebateamount, 
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_temp_HorseDetail hd on t.ticketserialnumber = hd.ticketserialnumber
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber 
 where t.prodid = 1 and t.isbetrejectedbytrader = false and (t.transactiondate::timestamp between startdate and enddate)
 order by t.uuid  

 ; insert into ubt_temp_transactiondata 
-- union all 
  --SPORTS (Per UUID)  For Bet Placement
 
 select  
 t.uuid,   t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 sd.bettype as bettypeid,  
 sd.selection as selection,  
  case when t.transactiondate < ob_startdate then ob_previousbusinessdate 
 when t.transactiondate > ob_enddate then ob_nextbusinessdate
 else ob_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid,   t.locationid,   t.cartid,   t.tranheaderid,  
 -----lottery section  
 t.uuid as boardseqnumber,   sd.entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
  -----sports section   
 sd.eventid,   sd.leaguecode,   sd.liveindicator,   sd.eventname,   sd.bettypename,  
 sd.selectionodds,   sd.starttime,  
 -----value amount section   
 amt.wager as wager,  
 amt.secondwager as secondwager,  
 pbtli.salesfactoramount as sales,
 amt.secondsales as secondsales,  
 coalesce(amt.salescomm, 0) as salescomm, 
 coalesce(amt.secondsalescomm,0) as secondsalescomm, 
 coalesce(amt.gst,0) as gst, 
 amt.secondgst as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount  else 0 end as returnamount, 
 case when transactiontype = 3 then amt.winningamount   else 0 end as winningamount,
  null as betlinerebateamount,  
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 inner join   public.ztubt_sports_placedbettransactionlineitem  pbtli on t.tranheaderid = pbtli.tranheaderid  
 inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid 
 left join ubt_temp_sportsdetail sd on t.ticketserialnumber = sd.ticketserialnumber and pbtli.tranlineitemid = sd.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber  
 where 
pbvbcbtdis.transactiontypetotal in (1,4,6) 
 and t.prodid in (5, 6) and t.isbetrejectedbytrader = false and ( t.transactiondate between startdate and enddate)
 order by t.uuid  
 ;
  insert into ubt_temp_transactiondata 
-- union all 
 
select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 sd.bettype as bettypeid,   sd.selection as selection,  
 case when t.transactiondate < ob_startdate then ob_previousbusinessdate 
 when t.transactiondate > ob_enddate then ob_nextbusinessdate
 else ob_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid,   t.locationid,   t.cartid,   t.tranheaderid,  
 -----lottery section  
 t.uuid as boardseqnumber,   sd.entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
  -----sports section   
 sd.eventid,   sd.leaguecode,   sd.liveindicator,   sd.eventname,   sd.bettypename,   
 sd.selectionodds,   sd.starttime,  
 -----value amount section   
 amt.wager as wager,  
 amt.secondwager as secondwager,  
 pbtli.salesfactoramount as sales,
 amt.secondsales as secondsales,  
 coalesce(amt.salescomm, 0) as salescomm, 
 coalesce(amt.secondsalescomm,0) as secondsalescomm, 
 coalesce(amt.gst,0) as gst, 
 amt.secondgst as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount else 0  end as returnamount,
 case when transactiontype = 3 then amt.winningamount else 0  end as  winningamount,
 null as betlinerebateamount,  
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on t.tranheaderid = pbtli.tranheaderid  
 inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid 
 left join ubt_temp_sportsdetail sd on t.ticketserialnumber = sd.ticketserialnumber and pbtli.tranlineitemid = sd.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber  
 where pbvbcbtdis.transactiontypetotal in (3,5) 
 and t.prodid in (5, 6) and t.isbetrejectedbytrader = false and (t.transactiondate between startdate and enddate)
 order by t.uuid  

 ;
create index idx_ubt_transdata_uuid on  ubt_temp_transactiondata(uuid );
create index idx_ubt_transdata_productid  on  ubt_temp_transactiondata(productid );
create index idx_ubt_transdata_selection  on  ubt_temp_transactiondata(selection );
create index idx_ubt_transdata_businessdate  on  ubt_temp_transactiondata(businessdate );
create index idx_ubt_transdata_tranheaderid  on  ubt_temp_transactiondata(tranheaderid  );

--Interface table output-------
return query
	SELECT UUID ,
	TRANHEADERID,
	TRANSACTIONTYPE,
	PRODUCTID,
	BETTYPEID,
	SELECTION,
	BUSINESSDATE, 
	--TRANSACTIONTIMESTAMP,
	to_char(TRANSACTIONTIMESTAMP,'yyyy-MM-dd HH24:mi:ss') ::timestamp as TRANSACTIONTIMESTAMP, -- For FR include second 04 Apr 2022
	TERMINALID,
	USERID,
	LOCATIONID,
	BOARDSEQNUMBER,
	coalesce(ENTRYMETHOD,0),
	coalesce(NUMBOARDS,0),
	coalesce(NUMDRAWS,0),
	coalesce(DRAWID,''),
	coalesce(EBETSLIPINFO_MOBNBR,''),
	coalesce(NUMSIMPLEBETS,0),
	coalesce(QPFLAG,0),
	coalesce(NUMMARKS,0),
	coalesce(BULKID,'') ,
	coalesce(ITOTO_NUMPARTS,''),
	ITOTO_TOTALPARTS,
	GRPTOTO_NUMPARTS,
	EVENTID,
	LEAGUECODE, 
	LIVEINDICATOR,
	EVENTNAME,
	MARKET,
	ODDS,
	MATCHKICKOFF,
	WAGER1,
	WAGER2,
	SALES1,
	SALES2,
	SALESCOMM1,
	SALESCOMM2,
	GST1,
	coalesce(GST2,0),
	RETURNAMOUNT,
	WINNINGAMOUNT, 
	PAYMENTMODE, 
	CARTID ,
	coalesce(BETLINEREBATEAMOUNT,0)
			from ubt_temp_transactiondata
			where TransactionTimestamp >= StartDate
			and TransactionTimestamp <= EndDate
	 ;

drop table 	ubt_temp_placebettransaction_type;
drop table	ubt_temp_LotteryDraw;
drop table	ubt_temp_numdraws;
drop table	ubt_Temp_LotteryDetail;
drop table	ubt_temp_NumBoards;
drop table	ubt_temp_HorseDetail;
drop table	ubt_temp_TotoSeq;
drop table	ubt_Temp_TotoGroup;
drop table	ubt_temp_Liveindidcator;
drop table	ubt_temp_sportsdetail;
drop table	ubt_temp_placebettransaction;
drop table	ubt_temp_bettype;
drop table	ubt_temp_trans;
drop table	ubt_temp_transactionamount;
drop table	ubt_temp_resultwager;
drop table	ubt_temp_resultsalescomwithdate;
drop table	ubt_temp_resultsalesandcomm ;
drop table	ubt_temp_resultGST;
drop table	ubt_temp_resultvalidation;
drop table	ubt_temp_resultvalidationexchange;
drop table	ubt_temp_transactiondata;
drop table	ubt_temp_final_lotteryselect;

END;
$$;


ALTER FUNCTION public.sp_ubt_gettransactiondataforinterval(startdatetime timestamp without time zone, enddatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1300 (class 1255 OID 2004961)
-- Name: sp_ubt_gettransactiondataforinterval_bk20241010(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransactiondataforinterval_bk20241010(startdatetime timestamp without time zone, enddatetime timestamp without time zone) RETURNS TABLE(uuid character varying, tranheaderid character varying, transactiontype integer, productid integer, bettypeid character varying, selection text, businessdate date, transactiontimestamp timestamp without time zone, terminalid character varying, userid character varying, locationid character varying, boardseqnumber character varying, entrymethod integer, numboards integer, numdraws integer, drawid character varying, ebetslipinfo_mobnbr character varying, numsimplebets integer, qpflag integer, nummarks integer, bulkid character varying, itoto_numparts text, itoto_totalparts text, grptoto_numparts text, eventid character varying, leaguecode character varying, liveindicator character, eventname text, market text, odds character varying, matchkickoff character varying, wager1 numeric, wager2 numeric, sales1 numeric, sales2 numeric, salescomm1 numeric, salescomm2 numeric, gst1 numeric, gst2 numeric, returnamount numeric, winningamount numeric, paymentmode character varying, cartid character varying, betlinerebateamount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
declare
startdate TIMESTAMP;
enddate timestamp;
bmcs_startdate timestamp;
igt_startdate timestamp;
ob_startdate timestamp;
bmcs_enddate timestamp;
igt_enddate timestamp;
ob_enddate timestamp;
bmcs_currentbusinessdate date;
igt_currentbusinessdate date;
ob_currentbusinessdate date;
bmcs_nextbusinessdate date;
igt_nextbusinessdate date;
ob_nextbusinessdate date;
bmcs_previousbusinessdate date;
igt_previousbusinessdate date;
ob_previousbusinessdate date;
startdateUTC timestamp;
enddateUTC timestamp;

BEGIN
	
	
select 
startdatetime ,
enddatetime ,

fromdatetimebmcs ,
fromdatetimeigt ,
fromdatetimeob ,

todatetimebmcs ,
todatetimeigt ,
todatetimeob ,

(fromdatetimebmcs  ::DATE) ,
(fromdatetimeigt  :: DATE) ,
(fromdatetimeob  :: DATE) ,

(fromdatetimebmcs  ::DATE) + interval '1 Day' ,
(fromdatetimeigt  :: DATE) + interval '1 Day' ,
(fromdatetimeob  :: DATE) + interval '1 Day' ,

(fromdatetimebmcs  ::DATE)- interval '1 Day'  ,
(fromdatetimeigt  :: DATE)- interval '1 Day' ,
(fromdatetimeob  :: DATE) - interval '1 Day' ,

(startdatetime - interval '8 hour')  ,
(enddatetime - interval '8 hour')  

into 

startdate ,
enddate ,

bmcs_startdate ,
igt_startdate ,
ob_startdate ,

bmcs_enddate ,
igt_enddate ,
ob_enddate ,

bmcs_currentbusinessdate ,
igt_currentbusinessdate ,
ob_currentbusinessdate ,

bmcs_nextbusinessdate ,
igt_nextbusinessdate ,
ob_nextbusinessdate ,

bmcs_previousbusinessdate ,
igt_previousbusinessdate ,
ob_previousbusinessdate ,

startdateUTC ,
enddateUTC 
from public.sp_ubt_getcommonubtdates(StartDatetime ,StartDatetime );





--ubt_temp_placebettransaction #PBVBCBT

 create temporary table if not exists ubt_temp_placebettransaction(  
  TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(10),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  CreatedDate timestamp,
  RequestID varchar(40),
  UserDisplayID varchar(40),
  CartID varchar(50),
  TransactionType int4
 );

 


insert INTO ubt_temp_placebettransaction(TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket,TerDisplayID,CreatedDate,RequestID,UserDisplayID,CartID,TransactionType)

 
 SELECT TicketSerialNumber, PB.TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket
 ,TerDisplayID,PB.CreatedDate,RequestID,UserDisplayID,CartID, 1  TransactionType
  FROM public.ztubt_placedbettransactionheader PB  
  INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate  PBLC ON PB.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'  
  WHERE
	(PB.CreatedDate >= startdateUTC And PB.CreatedDate <= enddateUTC)
	  
  Union 
  SELECT VB.TicketSerialNumber, VB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader
  ,PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,VB.UserDisplayID,VB.CartID, 3 TransactionType
  FROM public.ztubt_validatedbetticket  VB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON VB.TicketSerialNumber = PB.TicketSerialNumber  
  INNER JOIN public.ztubt_validatedbetticketlifecyclestate VBLC ON VB.TranHeaderID = VBLC.TranHeaderID AND VBLC.BetStateTypeID = 'VB06'  
  WHERE VB.ValidationTypeID IN ('VALD', 'RFND') 
  AND   (VB.CreatedValidationDate >= startdateUTC And VB.CreatedValidationDate <= enddateUTC)
  Union
  SELECT CB.TicketSerialNumber, CB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader,
 
   PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,CB.UserDisplayID,CB.CartID,5 TransactionType
  
  FROM public.ztubt_CancelledBetTicket CB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON CB.TicketSerialNumber = PB.TicketSerialNumber
  INNER JOIN public.ztubt_cancelledbetticketlifecyclestate  CBLC ON CBLC.TranHeaderID = PB.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'  
  WHERE (PB.IsBetRejectedByTrader ) = FALSE AND (CB.CancelledDate >= startdate And CB.CancelledDate <= enddate)
  ;

 create index idx_ubt_ticketserialnumber on ubt_temp_placebettransaction(TicketSerialNumber);
 create index idx_ubt_tranheaderid on ubt_temp_placebettransaction(TranHeaderID);
create index idx_ubt_prodid on ubt_temp_placebettransaction(prodid);
create index idx_ubt_CreatedDate on ubt_temp_placebettransaction(CreatedDate);
create index idx_ubt_TransactionType on ubt_temp_placebettransaction(TransactionType);
 
 create temporary table if not exists ubt_temp_placebettransaction_type
 (TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(50),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  TransactionTypeTotal int4)
  ;
 
 insert into ubt_temp_placebettransaction_type
 
  Select TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID,
   IsBetRejectedByTrader,IsExchangeTicket, TerDisplayID
  ,SUM(TransactionType) TransactionTypeTotal 
  from ubt_temp_placebettransaction
  Group By TicketSerialNumber, TranHeaderID, DeviceID, EntryMethodID, ProdID, 
  IsExchangeTicket, TerDisplayID, IsBetRejectedByTrader
  ;
 
 create index idx_ubt_transaction_type_ticketserialnumber on ubt_temp_placebettransaction_type(TicketSerialNumber);
create index idx_ubt_transaction_type_tranheaderid on ubt_temp_placebettransaction_type(TranHeaderID);
create index idx_ubt_transaction_type_prodid on ubt_temp_placebettransaction_type(ProdID);
create index idx_ubt_transaction_type_isbetrejectedbytrader on ubt_temp_placebettransaction_type(IsBetRejectedByTrader);
create index idx_ubt_transaction_type_isexchangeticket on ubt_temp_placebettransaction_type(IsExchangeTicket);
create index idx_ubt_transaction_type_terdisplayid on ubt_temp_placebettransaction_type(TerDisplayID);
create index idx_ubt_transaction_type_transactiontypetotal on ubt_temp_placebettransaction_type(TransactionTypeTotal);
  
  --ubt_temp_placebettransaction_type #PBDVBCBT
  
   -----------------------------------------------------------------  
 --BET TYPE 
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_bettype  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemnumberid varchar(50),  
  bettypeid varchar(2)
 )  
 ; 
  

  
 --4D  
 INSERT INTO ubt_temp_bettype  
 SELECT
 PBVBCBT.TicketSerialNumber,  
 PBTLI.TranLineItemID,  
 CASE  
  WHEN PBTLI.BetTypeID = 'ORD' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN '0'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '5'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '10'  
   END  
  WHEN PBTLI.BetTypeID = 'SYS' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN   
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '1'  
WHEN PBTLI.Permutation = 12 THEN '2'  
  WHEN PBTLI.Permutation = 4 THEN '3'  
  WHEN PBTLI.Permutation = 6 THEN '4'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '6'  
  WHEN PBTLI.Permutation = 12 THEN '7'  
  WHEN PBTLI.Permutation = 4 THEN '8'  
  WHEN PBTLI.Permutation = 6 THEN '9'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
   CASE  
  WHEN PBTLI.Permutation = 24 THEN '11'  
  WHEN PBTLI.Permutation = 12 THEN '12'  
  WHEN PBTLI.Permutation = 4 THEN '13'  
  WHEN PBTLI.Permutation = 6 THEN '14'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'IBET' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '27'  
  WHEN PBTLI.Permutation = 12 THEN '28'  
  WHEN PBTLI.Permutation = 4 THEN '29'  
  WHEN PBTLI.Permutation = 6 THEN '30'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '31'  
  WHEN PBTLI.Permutation = 12 THEN '32'  
  WHEN PBTLI.Permutation = 4 THEN '33'  
  WHEN PBTLI.Permutation = 6 THEN '34'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '35'  
  WHEN PBTLI.Permutation = 12 THEN '36'  
  WHEN PBTLI.Permutation = 4 THEN '37'  
  WHEN PBTLI.Permutation = 6 THEN '38'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'ROLL' THEN  
   CASE  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '15'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber)= 2 THEN '16'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '17'  
  ELSE '18'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN 
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '19'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '20'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '21'  
  ELSE '22'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '23'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '24'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '25'  
  ELSE '26'  
 END  
   END  
 END AS BetTypeID  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitem   PBTLI ON PBVBCBT.TranHeaderID = PBTLI.TranHeaderID  
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON PBTLI.TranLineItemID = PBTLIN.TranLineItemID  
 WHERE PBVBCBT.ProdId = 2
 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0
and 
 ((PBTLIN.CreatedDate >= startdateUTC And PBTLIN.CreatedDate <= enddateUTC 
 and  PBVBCBT.TransactionTypeTotal In (1, 4, 6))	or  PBVBCBT.TransactionTypeTotal In (3,5))


 union all 
----TOTO

 
 select
 pbt.ticketserialnumber,   
 pbtli.tranlineitemid,  
 case pbtli.bettypeid   
  WHEN 'ORD'   THEN '0'  
  WHEN 'SYSR'  THEN '1'  
  WHEN 'SYS7'  THEN '2'  
  WHEN 'SYS8'  THEN '3'  
  WHEN 'SYS9'  THEN '4'  
  WHEN 'SYS10' THEN '5'  
  WHEN 'SYS11' THEN '6'  
  WHEN 'SYS12' THEN '7'  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_toto_placedbettransactionlineitem pbtli  on pbt.tranheaderid = pbtli.tranheaderid  
 where pbt.prodid = 3 and  
  ((pbtli.createddate >= startdateutc and pbtli.createddate <= enddateutc and  
  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))
 
 union all
 
 ---SWEEP

 select
 pbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 '0' as bettypeid   
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_sweep_placedbettransactionlineitemnumber pbtlin on pbt.tranheaderid = pbtlin.tranheaderid  
 where   pbt.prodid = 4
 and issoldout  <> true and 
 ((pbtlin.createddate >= startdateutc and pbtlin.createddate <= enddateutc
 and  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))

 --SPORT
 union all
 select
 pbvbcbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 case scat.categoryid when 1 
 then 
 case pbtli.accumulatorid   
  WHEN 'ACC4' THEN '4F'  
  WHEN 'DBL' THEN 'D'  
  WHEN 'SGL' THEN 'S'  
  WHEN 'TBL' THEN 'T'  
  END 
 WHEN 2 THEN 'S'
  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbvbcbt 
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on pbvbcbt.tranheaderid = pbtli.tranheaderid  
 inner  join public.ztubt_sports_placedbettransactionlineitemnumber  pbtlin on pbtli.tranlineitemid = pbtlin.tranlineitemid 
 inner join public.ztubt_sportevent se on pbtlin.eventid = se.eventid  
 inner join public.ztubt_sporttype st on se.typeid = st.typeid  
 inner join public.ztubt_sportclass sc on st.classid = sc.classid  
 inner join public.ztubt_sportcategory scat on sc.categoryid = scat.categoryid 
 where (scat.categoryid= 1)  or (scat.categoryid=2 and pbvbcbt.prodid in (5,6) )
 
 group by pbvbcbt.ticketserialnumber,pbtlin.tranlineitemid, scat.categoryid,pbtli.accumulatorid 
 ;
 
create index  ind_ticketsrno on ubt_temp_bettype(ticketserialnumber);
 -----------------------------------------------------------------  
 --DETAIL OF HORSE  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_horsedetail  
 (  
  ticketserialnumber varchar(500),  
  entrymethod int4,  
  betlinerebateamount numeric(22,2) 
 )  
 ;

 insert into ubt_temp_horsedetail
 
 
 SELECT ADP.TicketSerialNumber,
  CASE ADP.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 SUM(ADP.Amount) AS BetLineRebateAmount  
 FROM  
 (  
  SELECT   PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, EntryMethodID,  
  CASE WHEN BetTypeID = 'W-P'  
THEN (coalesce(PBTL.BoardRebateAmount,0))  
   ELSE SUM(coalesce(PBTL.BoardRebateAmount,0))   
  END AS Amount
  
  FROM ubt_temp_placebettransaction_type PBVBCBT 
  INNER JOIN   public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCBT.TranHeaderID = PBTL.TranHeaderID  
	WHERE  PBVBCBT.ProdID = 1 and 
	((PBTL.CreatedDate >= startdateUTC And PBTL.CreatedDate <= enddateUTC 	
AND PBVBCBT.TransactionTypeTotal In (1, 4, 6) ) or PBVBCBT.TransactionTypeTotal in (3,5))
  GROUP BY  PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BoardRebateAmount, EntryMethodID
 )ADP  
 GROUP BY ADP.TicketSerialNumber, ADP.EntryMethodID
 ;
 
create index idx_ubt_horse_ticketsrno on ubt_temp_horsedetail(TicketSerialNumber);
 -----------------------------------------------------------------  
 --DETAIL OF LOTTERY  
 -----------------------------------------------------------------  
  
 create temporary table if not exists ubt_temp_numboards  
 (  
  ticketserialnumber varchar(500),  
  numboards int4,  
  bulkid varchar(50)
 ) ; 
  
 INSERT INTO ubt_temp_NumBoards  
 --4D
 SELECT DISTINCT PBT.TicketSerialNumber,   
 COUNT(z4dln.TranLineItemID) AS NumBoards,  
 NULL AS BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN   public.ztubt_4d_placedbettransactionlineitemnumber  z4dln ON PBT.TranHeaderID = z4dln.TranHeaderID  
 WHERE PBT.ProdID = 2 and  coalesce(z4dln.BigBetAcceptedWager, 0) + coalesce(z4dln.SmallBetAcceptedWager, 0) > 0 AND
 ((z4dln.CreatedDate >= StartDateUTC And z4dln.CreatedDate <= EndDateUTC  
  AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 
 GROUP BY PBT.TicketSerialNumber 
 
 
 union all 
 --TOTO
 
 select pbvbcbt.ticketserialnumber,   
 count(pbtl.tranlineitemid) as numboards,  
 null as bulkid  
 from ubt_temp_placebettransaction_type pbvbcbt   
 inner join  public.ztubt_toto_placedbettransactionlineitem  pbtl on pbvbcbt.tranheaderid = pbtl.tranheaderid  
 where   pbvbcbt.prodid = 3 and  
 ((pbtl.createddate >= startdateUTC and pbtl.createddate <= enddateUTC and
  pbvbcbt.transactiontypetotal in (1, 4, 6)) or pbvbcbt.transactiontypetotal in (3,5))
 group by pbvbcbt.ticketserialnumber  

 
 union  all 
 
 --SWEEP
 SELECT PBT.TicketSerialNumber,   
 COUNT(PLN.TranLineItemID) AS NumBoards,  
 BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitem  PL ON PBT.TranHeaderID = PL.TranHeaderID  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitemnumber  PLN ON PL.TranLineItemID = PLN.TranLineItemID  
 WHERE  PBT.ProdID = 4 AND IsSoldOut <> true and
 ((PLN.CreatedDate >= StartDateUTC And PLN.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  
 GROUP BY PBT.TicketSerialNumber, BulkID 
 
 ;
create index idx_ubt_numboard_ticketsrno on ubt_temp_numboards (TicketSerialNumber);

create temporary table ubt_temp_LotteryDraw
( TicketSerialNumber varchar (200),
HostDrawDatesId varchar(20)
)
 ;
	insert into ubt_temp_LotteryDraw
Select PBTT.TicketSerialNumber, CAST(zdm.HostDrawDatesId AS VARCHAR) HostDrawDatesId

	FROM ubt_temp_placebettransaction_type PBTT  
	INNER JOIN public.ztubt_drawdates zdm  ON PBTT.TranHeaderID = zdm.TranHeaderID   
	Where  PBTT.ProdID In (2,3,4) 

;	
create index idx_ubt_lotterydraws_ticketsrno on ubt_temp_LotteryDraw (TicketSerialNumber,HostDrawDatesId);

create temporary table ubt_temp_numdraws
( TicketSerialNumber varchar (200),
NumDraws int4,
Drawid varchar(50)
)
 ;
	insert into ubt_temp_numdraws
	SELECT
	LD.TicketSerialNumber,
	Count(1) NumDraws,
	string_agg(CAST(LD.HostDrawDatesId AS varchar),',' ) as Drawid

	From ubt_temp_LotteryDraw LD 
	Group By LD.TicketSerialNumber

;
	
create index idx_ubt_numdraws_ticketsrno on ubt_temp_numdraws (TicketSerialNumber);

 create temporary table if not exists ubt_temp_lotterydetail  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemid varchar(50),  
  boardseqnumber int,  
  entrymethod int,  
  numboards int,  
  numdraws int,  
  drawid varchar(500),  
  ebetslipinfo_mobnbr varchar(100),  
  numsimplebets int4,  
  qpflag int4,  
  nummarks int4,  
  bulkid varchar(50), --(5)  
  itoto_numparts text, -- varchar(max)  
  itoto_totalparts text,   --varchar(max)
  grptoto_numparts text   --varchar(max)
 )  
  
 ;
 create temporary table if not exists ubt_temp_TotoSeq (  
  TranLineItemID varchar(50),  
  Seq INT4  
 )  
  ;
 create temporary table if not exists ubt_Temp_TotoGroup ( 
  GroupHostID varchar(50),  
  GroupToto INT4 
 ) ; 
  
 INSERT INTO ubt_temp_TotoSeq  
 SELECT LIN.TranLineItemID, MAX(LIN.Sequence) AS Seq  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join  public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitemnumber  LIN on LI.TranLineItemID = LIN.TranLineItemID
 WHERE PBT.ProdID = 3 and 
 ((LI.CreatedDate >= StartDateUTC And LI.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY LIN.TranLineItemID  
 ;
 
 INSERT INTO ubt_Temp_TotoGroup 
 SELECT LI2.GroupHostID, MAX(LI2.GroupUnitSequence) AS GroupToto  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitem LI2 on LI.GroupHostID = LI2.GroupHostID
 WHERE PBT.ProdID = 3
 AND LI.GroupHostID <> '00000000-0000-0000-0000-000000000000' AND LI.GroupUnitSequence IS NOT NULL 
 GROUP BY LI2.GroupHostID
 
 ;
 --4D
 
 INSERT INTO ubt_Temp_LotteryDetail  
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
   PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
   PBVBCBT.TransactionTypeTotal In (1, 4, 6)  

union all 

 
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)

 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
 PBVBCBT.TransactionTypeTotal in (3,5)
  
union all
 
 --TOTO  
  
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE TOTO.BetTypeID  
  WHEN 'ORD'   THEN 1  
  WHEN 'SYSR'  THEN 44  
  WHEN 'SYS7'  THEN 7  
  WHEN 'SYS8'  THEN 28  
  WHEN 'SYS9'  THEN 84  
  WHEN 'SYS10' THEN 210  
  WHEN 'SYS11' THEN 462  
  WHEN 'SYS12' THEN 924  
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and 
 TOTO.CreatedDate >= StartDateUTC And TOTO.CreatedDate <= EndDateUTC   
 AND PBVBCBT.TransactionTypeTotal In (1, 4, 6)
 
 union all 
 
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE TOTO.BetTypeID  
  WHEN 'ORD'   THEN 1  
  WHEN 'SYSR'  THEN 44  
  WHEN 'SYS7'  THEN 7  
  WHEN 'SYS8'  THEN 28  
  WHEN 'SYS9'  THEN 84  
  WHEN 'SYS10' THEN 210  
  WHEN 'SYS11' THEN 462  
  WHEN 'SYS12' THEN 924  
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and PBVBCBT.TransactionTypeTotal in (3,5)
 
 union all 
 
 --SWEEP
 
 SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and 
PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
  PBVBCBT.TransactionTypeTotal In (1, 4, 6)
  
  union all 
  
  SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and PBVBCBT.TransactionTypeTotal In (3,5)

;
 
create index idx_ubt_lotterydetail_ticketsrno  on ubt_Temp_LotteryDetail(TicketSerialNumber);
create index idx_ubt_lotterydetail_tranlineitemid  on ubt_Temp_LotteryDetail(TranLineItemID);
 -----------------------------------------------------------------  
 --DETAIL OF SPORTS  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_Liveindidcator  
 (  
  TicketSerialNumber VARCHAR(500),  
  LiveIndicator CHAR(1)  
 )  
  ;
 INSERT INTO ubt_temp_Liveindidcator  
 SELECT din.TicketSerialNumber,   
 CASE  
  WHEN (din.HasBetInRun = TRUE) AND (din.CreatedDate BETWEEN din.StartTime AND din.SuspendTime) THEN 'Y'  
  ELSE 'N'  
 END AS LiveIndicator  
 FROM  
 (  
  SELECT ROW_NUMBER() OVER (PARTITION BY SPBN.TranHeaderID 
  							ORDER BY SPBN.TranLineItemID
--		  					ORDER BY split_part(SPBN.tranlineitemid,'-',5)
--									,split_part(SPBN.tranlineitemid,'-',4)
--									,split_part(SPBN.tranlineitemid,'-',3)
--									,split_part(SPBN.tranlineitemid,'-',2)
--									,split_part(SPBN.tranlineitemid,'-',1)
  							) AS ROWNUM,
  PBVBCBT.TicketSerialNumber, SE.HasBetInRun, SE.StartTime, SE.SuspendTime, SPBN.CreatedDate  
  FROM ubt_temp_placebettransaction_type PBVBCBT
  INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  SPBN ON PBVBCBT.TranHeaderID = SPBN.TranHeaderID  
  INNER join public.ztubt_sportevent SE ON SPBN.EventID = SE.EventId  
  WHERE PBVBCBT.ProdID IN(5,6)
 )din  
 WHERE din.ROWNUM = 1  
;
create index idx_ubt_liveindicator_ticketsrno  on ubt_temp_Liveindidcator(TicketSerialNumber); 

 create temporary table if not exists ubt_temp_sportsdetail
 (  
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID Varchar(50),--(1)  
  EntryMethod INT4,  
  EventID VARCHAR(500),  
  LeagueCode VARCHAR(500),  
  LiveIndicator CHAR(1),  
  EventName text,  
  BetTypeName text,  
  Selection VARCHAR(500),  
  SelectionOdds VARCHAR(500),  
  StartTime VARCHAR(500),  
  BetType VARCHAR(500)
 )  
  ;
 INSERT INTO ubt_temp_sportsdetail  
 SELECT PBVBCBT.TicketSerialNumber,   
 PLN.TranLineItemID,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 PLN.EventID AS EventID,  
 SL.LeagueCode AS LeagueCode,  
 LI.LiveIndicator :: char AS LiveIndicator,  
 PLN.EventName AS EventName,  
 PLN.BetTypeName AS BetTypeName,  
 PLN.SelectionName AS Selection,  
 PLN.SelectionOdds AS SelectionOdds,  
 --to_char(SE.StartTime, 'yyyyMMdd HHmmss') AS StartTime, b.BetTypeID 
to_char(SE.StartTime, 'yyyyMMdd HH24miss') AS StartTime, b.BetTypeID 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  PLN ON PBVBCBT.TranHeaderID = PLN.TranHeaderID
 INNER JOIN public.ztubt_sportevent  SE ON PLN.EventID = SE.EventId  
 INNER JOIN public.ztubt_sporttype  ST ON SE.TypeId = ST.TypeId  
 INNER JOIN public.ztubt_sportleagueinfo  SL ON REPLACE(ST.Name, '|', '') = REPLACE(SL.Name, '|', '')  
 INNER JOIN ubt_temp_Liveindidcator LI ON PBVBCBT.TicketSerialNumber = LI.TicketSerialNumber  
 inner join ubt_temp_bettype b on b.TranLineItemNumberID = PLN.TranLineItemID  
 LEFT JOIN public.ztubt_entrymethod  EM ON PBVBCBT.EntryMethodID = EM.EntryMethodID  
 WHERE PBVBCBT.ProdID IN (5,6)  
 GROUP BY PBVBCBT.TicketSerialNumber, PLN.TranLineItemID, PBVBCBT.EntryMethodID, PLN.EventID, SL.LeagueCode, 
 LI.LiveIndicator, PLN.EventName, PLN.BetTypeName, PLN.SelectionOdds, SE.StartTime,  b.BetTypeID, PLN.SelectionName  
 ;

create index idx_ubt_sportdetail_ on ubt_temp_sportsdetail(TicketSerialNumber,TranLineItemID);
 
  
 -------------------------------------------------------------------------  
 --GET TRANSACTION (COLLECTION, VALIDATION, CANCELLATION) PER AD HOC TIME  
 -------------------------------------------------------------------------  
 create temporary table if not exists ubt_temp_trans  
 (  
  EntryMethodID VARCHAR(10),  --(S5)
  ProdID int4,  --(S5)
  IsBetRejectedByTrader bool, --(S5)
  TicketSerialNumber VARCHAR(200),  
  UUID VARCHAR(33),  
  TransactionType INT4,  
  TransactionDate timestamp,  
  TerminalID VARCHAR(100),  
  UserID VARCHAR(100),  
  LocationID VARCHAR(200),  
  CartID varchar(50),  
  TranHeaderID varchar(50)
 )  
   ;
-------COLLECTION--------------
   
 --HORSE RACING  
  INSERT INTO ubt_temp_trans  
  SELECT  
  PB.EntryMethodID, 
  PB.ProdID,  --(S5)
  PB.IsBetRejectedByTrader , --(S5)
  PB.TicketSerialNumber AS TSN,  
  PB.RequestID AS UUID,  
  1 AS TransactionType, --Wager  
  ( PB.CreatedDate + interval '8 hour'),  
 PB.TerDisplayID AS TerminalID,  PB.UserDisplayID AS UserID,  L.LocDisplayID AS LocationID,  
  PB.CartID,  
  PB.TranHeaderID  
  FROM ubt_temp_placebettransaction PB  
  INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.terdisplayid  
  LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
  WHERE PB.ProdID  in (1, 2, 3, 4, 5, 6) and  
   PB.TransactionType = 1 
 AND  (PB.CreatedDate >= StartDateUTC And PB.CreatedDate <= EndDateUTC) 
 
  --ProdID = 1 --HORSE RACING
  --ProdId=2,3,4 Lottery
  --prodid=5,6 sports
  
  ------------VALIDATION -----------
  
  
  
union all 
--Horse Racing

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID = 1 
 AND (coalesce (zv.WinningAmount,0) > 0 OR coalesce (zv.RebateReclaim,0) > 0) 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 --Lottery(prod id (2,3,4)  & Sports prodid (5,6)
 union all 
 

 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 zv.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (2,3,4)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 union all 
 
 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' -- Issue:Fixed on 20220221 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 
 
union all 
--refund

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 61 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (5, 6) 
 AND  zv.ValidationTypeID = 'RFND' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
---- ----CANCELLATION-------------------
 union all
 --Horse racing prodid (1) & Lottery prodid (2,3,4)
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID =1 --HORSE RACING  
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 

 union all 
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 cbt.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (2,3,4)  -- Lottery
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
union all
 --Sports
 
  SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)   --SPORTS
 AND PB.TransactionType = 5 
 AND PB.IsBetRejectedByTrader = false 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
 ;

create index idx_ubt_trans_ticketserialnumber on ubt_temp_trans(TicketSerialNumber);
create index idx_ubt_trans_tranheaderid on ubt_temp_trans(TranHeaderID);
  --FINAL RESULT OF TRANSACTIONAL VIEW  
 -----------------------------------------------------------------  
  
  
 create temporary table if not exists ubt_temp_transactionamount(
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID varchar(50),  
  Wager numeric(22,2), 
  SecondWager numeric(22,2), 
  Sales numeric(22, 11),  
  SecondSales numeric(22, 11),  
  SalesComm numeric(22, 11),  
  SecondSalesComm numeric(22, 11),  
  GST numeric(22, 11),  
  SecondGST numeric(22, 11),  
  ReturnAmount  numeric(22,2),  
  WinningAmount  numeric(22,2),  
  RefundAmount  numeric(22,2),  
  RebateReclaim  numeric(22,2)
 )  
  
 ;
 --COLLECTION 
 
 
 create temporary table if not exists ubt_temp_resultwager  
(  
ProdID int4,
 TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
 Wager numeric(22,2), 
 SecondWager numeric(22,2)
)  
;
 insert into ubt_temp_resultwager
 select 1::int4 ProdID, amtw.TicketSerialNumber, null , SUM(amtw.Amount) AS Wager, 0 AS SecondWager  
 FROM  
(  
SELECT   PBVBCB.TicketSerialNumber, PBTL.TranHeaderID,  
CASE WHEN BetTypeID = 'W-P' 
THEN (coalesce (PBTL.BetPriceAmount,0))  
ELSE SUM(coalesce (PBTL.BetPriceAmount,0))   
END AS Amount,  
COUNT(DISTINCT PBVBCB.TicketSerialNumber) Ct, 'COL' AS Flag,'CH' AS TransType  
FROM  
ubt_temp_placebettransaction_type PBVBCB 
INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCB.TranHeaderID = PBTL.TranHeaderID 
WHERE PBVBCB.ProdID = 1
and ((PBTL.CreatedDate >= StartDateUTC And PBTL.CreatedDate <= EndDateUTC
AND PBVBCB.TransactionTypeTotal In (1, 4, 6) ) or PBVBCB.TransactionTypeTotal in (3,5))

GROUP BY  PBVBCB.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BetPriceAmount 	
)amtw  
GROUP BY amtw.TicketSerialNumber

union all 

--4D

SELECT  2::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BigBetAcceptedWager,0)) AS Wager, SUM(coalesce (zdp.SmallBetAcceptedWager,0)) AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  
INNER JOIN public.ztubt_drawdates zd   ON zd.TranHeaderID = zdp.TranHeaderID   
WHERE  PBT.ProdID = 2 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >=StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID  


union all 
--toto

SELECT  3::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BetPriceAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  

WHERE  PBT.ProdID = 3 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 

--sweep

SELECT   4::int4 ProdID, PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.BetPriceAmount,0)) AS Wager, 0 AS SecondWager 
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = False  
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zplc   ON zplc.TranHeaderID = PBT.TranHeaderID  
INNER JOIN (select terdisplayid,Locid from public.ztubt_terminal ) Ter  ON PBT.TerDisplayID = Ter.TerDisplayID
INNER JOIN (Select * from  public.ztubt_location) Loc  ON Ter.LocID = Loc.LocID
WHERE ( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zplc.BetStateTypeID = 'PB06' ) 	
		OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zplc.BetStateTypeID = 'PB03' ) )
AND PBT.ProdID=4
AND ((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 

--sports

SELECT   FIN.ProdID ProdID, FIN.TicketSerialNumber, NULL, SUM(coalesce (FIN.BetAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
(  
select PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, BetAmount, TicketSerialNumber  
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sports_placedbettransactionlineitem zsp  ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE   
PBT.ProdID IN (5, 6) AND PBT.IsBetRejectedByTrader != TRUE 
GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet, AccumulatorID, BetAmount, TicketSerialNumber  
)FIN  
GROUP BY FIN.TicketSerialNumber, FIN.ProdID 
;

create index idx_ubt_resultwager_TicketSerialNumber  on ubt_temp_resultwager(TicketSerialNumber);
create index idx_ubt_resultwager_tranlineitemid  on ubt_temp_resultwager(TranLineItemID);

--For Sales Comm, Sales Factor and Output GST  
create temporary table if not exists ubt_temp_resultsalescomwithdate  
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 SalesCommAmount numeric(32, 12),  
 SalesFactorAmount numeric(32, 12),  
 SecondSalesCommAmount numeric(32, 12),  
 SecondSalesFactorAmount numeric(32, 12),  
 GSTRate numeric(10, 2)
)  ;
  
--Toto

insert into ubt_temp_resultsalescomwithdate
select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmount,0)) SalesCommAmount,
SUM(coalesce (zdp.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
	ubt_temp_placebettransaction_type PBT  
	Inner jOin public.ztubt_toto_placedbettransactionlineitem  zdp   ON PBT.TranHeaderID = zdp.TranHeaderID
WHERE  PBT.ProdID = 3 
AND PBT.IsExchangeTicket = FALSE  
AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <=EndDateUTC
AND  PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 
--horse

SELECT amt.TicketSerialNumber, NULL  , SUM(amt.SalesCommAmount) , SUM(amt.SalesFactorAmount)  , 0 , 0  
FROM  
(  
 SELECT   PBT.TicketSerialNumber, zhp.TranHeaderID,  
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesCommAmount,0))  
  ELSE SUM(coalesce (zhp.SalesCommAmount,0))   
 END AS SalesCommAmount,   
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesFactorAmount,0))  
  ELSE SUM(coalesce (zhp.SalesFactorAmount,0))   
 END AS SalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT  
	 INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  zhp ON PBT.TranHeaderID = zhp.TranHeaderID  
	 INNER JOIN (select Terdisplayid,LocID from public.ztubt_terminal zt) Ter ON PBT.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0   
	 where PBT.ProdID = 1 and 
	 (
	 	(zhp.CreatedDate >= StartDateUTC 
	 	 And zhp.CreatedDate <= EndDateUTC
	  	 AND PBT.TransactionTypeTotal In (1, 4, 6)) 
	  or 
	  	(PBT.TransactionTypeTotal In (3, 5))
	 )  
 GROUP BY PBT.TicketSerialNumber, zhp.TranHeaderID, zhp.CreatedDate::Date
 , BetTypeID, SalesCommAmount, SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber


union all 

--4D

select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmountBig,0)) SalesCommAmount, 
 SUM(coalesce (zdp.SalesFactorAmountBig,0)) SalesFactorAmount, SUM(coalesce (zdp.SalesCommAmountSmall,0)) SecondSalesCommAmount
, SUM(coalesce (zdp.SalesFactorAmountSmall,0)) SecondSalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT   
	 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber zdp   ON zdp.TranHeaderID = PBT.TranHeaderID  
	 INNER JOIN  public.ztubt_drawdates zd ON zd.TranHeaderID = PBT.TranHeaderID --(7)  
 where PBT.ProdID = 2 and 
  ((zdp.CreatedDate >= StartDateUTC  And zdp.CreatedDate <=EndDateUTC
   AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  AND PBT.IsExchangeTicket = false 
 GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID

union all 

--sweeep

SELECT  PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (zspn.SalesFactorAmount,0)) SalesFactorAmount, 0, 0  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = FALSE 
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zpls   ON zpls.TranHeaderID = PBT.TranHeaderID 
 INNER JOIN (Select terdisplayid, Locid from public.ztubt_terminal ) Ter ON PBT.TerDisplayID = Ter.TerDisplayID 
 INNER JOIN (Select locid,locdisplayid,sweepindicator from public.ztubt_location ) Loc ON Ter.LocID = Loc.LocID 
WHERE PBT.ProdID=4  and 
( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zpls.BetStateTypeID = 'PB06' ) 	
	OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zpls.BetStateTypeID = 'PB03' ) )
and
((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC

	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	
GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 
--Sports

select amt.TicketSerialNumber, NULL , SUM(coalesce (amt.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (amt.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
(  
 SELECT PBT.ProdID ProductName, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, SalesCommAmount, TicketSerialNumber, SalesFactorAmount  
 FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN  public.ztubt_sports_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE PBT.ProdID IN (5,6)
 AND
 PBT.IsBetRejectedByTrader=false 
 GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,
 AccumulatorID, SalesCommAmount, TicketSerialNumber, (zsp.CreatedDate :: date), SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber
;

create index idx_ubt_resulsalescomwithdate_ticket on ubt_temp_resultsalescomwithdate(TicketSerialNumber);
create index idx_ubt_resulsalescomwithdate_tranlineitemid on ubt_temp_resultsalescomwithdate(TranLineItemID);


 create temporary table if not exists ubt_temp_resultsalesandcomm   
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 Sales numeric(32, 12),  
 SecondSales numeric(32, 12),
 SalesComm numeric(22, 11),  
 SecondSalesComm numeric(22, 11)
)  
  ;
INSERT INTO ubt_temp_resultsalesandcomm  
SELECT FIN.TicketSerialNumber, FIN.TranLineItemID, SUM(FIN.SalesFactorAmount), 
SUM(FIN.SecondSalesFactorAmount), SUM(FIN.SalesCommAmount), SUM(FIN.SecondSalesCommAmount)  
FROM ubt_temp_resultsalescomwithdate FIN  
GROUP BY FIN.TicketSerialNumber, FIN.TranLineItemID  

;

create index idx_ubt_resulsalescom_ticket on ubt_temp_resultsalesandcomm(TicketSerialNumber);
create index idx_ubt_resulsalescom_tranlineitemid on ubt_temp_resultsalesandcomm(TranLineItemID);

---------------------------------------------------------  
--GST (OUTPUT GST = WAGER - SALES)  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultGST   
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
GST numeric(22, 11),  
SecondGST numeric(22, 11)
) ; 
   
--LOTTERY(2,3,4) and Horse(1) and Sports(5,6)

INSERT INTO ubt_temp_resultGST   
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber AND w.TranLineItemID = S.TranLineItemID  
WHERE w.ProdID IN (2, 3, 4) 
union all 
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber 
WHERE w.ProdID IN (1,5,6) 

;

create index idx_ubt_resultGST_ticket on ubt_temp_resultGST(TicketSerialNumber);
create index idx_ubt_resultGST_tranlineitemid on ubt_temp_resultGST(TranLineItemID);

---------------------------------------------------------  
--VALIDATION  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultvalidation 
(   
TicketSerialNumber VARCHAR(200),  
ReturnAmount numeric(22,2), 
WinningAmount numeric(22,2),
RefundAmount numeric(22,2), 
RebateReclaim numeric(22,2) 
)  
  
;
INSERT INTO ubt_temp_resultvalidation  
SELECT zv.TicketSerialNumber,   
zv.WinningAmount AS ReturnAmount,  
CASE WHEN coalesce(zv.WinningAmount, 0) > 0 THEN  
zv.WinningAmount - (SUM(RW.Wager)/coalesce (COUNT(RW.TicketSerialNumber),1)) - (SUM(RW.SecondWager)/coalesce(COUNT(RW.TicketSerialNumber),1)) --(6) 
ELSE  0
  
END AS WinningAmount, --(4)  
zv.RefundAmount, zv.RebateReclaim --(1)  
FROM ubt_temp_resultwager RW  
 INNER join public.ztubt_validatedbetticket zv   ON RW.TicketSerialNumber = zv.TicketSerialNumber  
 INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvlc   ON zv.TranHeaderID = zvlc.TranHeaderID AND zvlc.BetStateTypeID = 'VB06'  
 WHERE zv.ValidationTypeID IN ('VALD', 'RFND') --(1)  
 GROUP BY zv.TicketSerialNumber, zv.WinningAmount, zv.RefundAmount, zv.RebateReclaim
 
 ;

create index idx_ubt_resultvalidation_ticket on ubt_temp_resultvalidation(TicketSerialNumber);
 ---------------------------------------------------------  
--VALIDATION EXCHANGE TICKET  
---------------------------------------------------------  
  
create temporary table if not exists ubt_temp_resultvalidationexchange
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
WinningAmount numeric(22,2), 
RefundAmount numeric(22,2),  
RebateReclaim numeric(22,2) 
)  
;
 
INSERT INTO ubt_temp_resultvalidationexchange  
select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_4d_placedbettransactionlineitem zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=2 And PBT.IsExchangeTicket= true

union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=3 And PBT.IsExchangeTicket= TRUE
   
union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=4 And PBT.IsExchangeTicket= TRUE

;

create index idx_ubt_resultvalidationexc_ticket on ubt_temp_resultvalidationexchange(TicketSerialNumber);
create index idx_ubt_resultvalidationexc_tranlinetiemid on ubt_temp_resultvalidationexchange(TranLineItemID);
---------------------------------------------------------  
--FINAL RESULT  
---------------------------------------------------------  

--HORSE RACING(1), lOTEERY(2,3,4), SPORTS(5,6)
 INSERT INTO ubt_temp_transactionamount  
SELECT W.TicketSerialNumber, W.TranLineItemID, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (2, 3, 4)
GROUP BY W.TicketSerialNumber, W.TranLineItemID  

union all
SELECT W.TicketSerialNumber, null, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber --AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber --AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (1, 5,6)
GROUP BY W.TicketSerialNumber  


union all 

select TicketSerialNumber, TranLineItemID, 0 AS Wager, 0 AS SecondWager, 0 AS Sales, 0 AS SecondSales, 
0 AS SalesCom, 0 AS SecondSalesCom, 0 AS GST, 0 AS SecondGST, WinningAmount, WinningAmount, RefundAmount, RebateReclaim  
FROM ubt_temp_resultvalidationexchange 

;

create index idx_ubt_transactionamt_ticket on ubt_temp_transactionamount(TicketSerialNumber);
create index idx_ubt_transactionamt_tranlineitemid on ubt_temp_transactionamount(TranLineItemID);

create temporary table if not exists ubt_temp_transactiondata
(
		--transid bigint  ,--primary key clustered,
		uuid varchar(33) ,
		transactiontype int4 ,
		productid int4 ,
		bettypeid varchar(2) ,
		selection text ,
		businessdate date ,
		transactiontimestamp timestamp ,
		terminalid varchar(100) ,
		userid varchar(100) ,
		locationid varchar(200) ,
		cartid varchar(50) ,
		tranheaderid varchar(50) ,
		boardseqnumber varchar(50) ,
		entrymethod int4 ,
		numboards int4 ,
		numdraws int ,
		drawid varchar(500) ,
		ebetslipinfo_mobnbr varchar(100) ,
		numsimplebets int4 ,
		qpflag int4 ,
		nummarks int4 ,
		bulkid varchar(50) ,
		itoto_numparts text ,
		itoto_totalparts text ,
		grptoto_numparts text ,
		eventid varchar(500) ,
		leaguecode varchar(500) ,
		liveindicator char(1) ,
		eventname text ,
		market text ,
		odds varchar(500) ,
		matchkickoff varchar(500) ,
		wager1 numeric(22, 2) ,
		wager2 numeric(22, 2) ,
		sales1 numeric(22, 11) ,
		sales2 numeric(22, 11) ,
		salescomm1 numeric(22, 11) ,
		salescomm2 numeric(22, 11) ,
		gst1 numeric(22, 11) ,
		gst2 numeric(22, 11) ,
		returnamount numeric(22, 2) ,
		winningamount numeric(22, 2) ,
		betlinerebateamount numeric(22, 2) ,
		paymentmode varchar(2) 
	)
;
create temporary table if not exists ubt_temp_final_lotteryselect
(  
	ticketserialnumber varchar(500),  
	tranlineitemid varchar(50),  
	selection text
)   
;
 --HORSE RACING  

INSERT INTO ubt_temp_final_lotteryselect  
SELECT PBT.TicketSerialNumber, NULL AS TranLineItemID,   
 string_agg(CAST(PL.BetLineAnnotation AS VARCHAR)  ,',') AS BetLineAnnotation 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN public.ztubt_horse_placedbettransactionlineitem PL ON PBT.TranHeaderID = PL.TranHeaderID  
 WHERE  PBT.ProdID=1 and 
 ((PL.CreatedDate >= StartDateUTC And PL.CreatedDate <=EndDateUTC
 And PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY PBT.TicketSerialNumber, PBT.TranHeaderID

--4D
 union all 
 
 select TicketSerialNumber, TranLineItemID, (pbtln.SelectedBetNumber :: varchar(10))   
from ubt_temp_placebettransaction_type PBT   
inner join public.ztubt_4d_placedbettransactionlineitemnumber  pbtln on PBT.TranHeaderID = pbtln.TranHeaderID
WHERE PBT.ProdID = 2 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))


union all 
--toto
select TicketSerialNumber, pbtln.TranLineItemID, string_agg((ztp.singleBetNumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT  
inner join public.ztubt_toto_placedbettransactionlineitem   pbtln on PBT.TranHeaderID = pbtln.TranHeaderID  
inner join public.ztubt_toto_placedbettransactionlineitemnumber ztp on pbtln.tranlineitemid =ztp.tranlineitemid 
WHERE PBT.ProdID = 3 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID

--sweep
union all 

select TicketSerialNumber, pbtln.TranLineItemID, string_agg((pbtln.selectednumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT
inner join public.ztubt_sweep_placedbettransactionlineitemnumber  pbtln on pbtln.tranheaderid =PBT.tranheaderid 
WHERE PBT.ProdID = 4 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID


--sports

union all 

select pb.ticketserialnumber,   
 pln.tranlineitemid as tranlineitemid,  
 pln.selectionname as selection  
 from ubt_temp_placebettransaction_type ph   
 inner join public.ztubt_sports_placedbettransactionlineitemnumber  pln  on ph.tranheaderid = pln.tranheaderid
 inner join ubt_temp_placebettransaction_type pb on ph.ticketserialnumber = pb.ticketserialnumber --(2)  
 where pb.prodid in (5, 6)
 group by pb.ticketserialnumber, pln.tranlineitemid, pln.selectionname

;
 
create index idx_ubt_lotteryselect_ticket on ubt_temp_final_lotteryselect(ticketserialnumber);
create index idx_ubt_lotteryselect_tranlineitemid on ubt_temp_final_lotteryselect(tranlineitemid);
 --=====================================================================================  
---Transaction Data Interface table-----------------------------------------------------
 --=====================================================================================
 
 --LOTTERY (Per UUID and boards under one TSN)  
 insert into ubt_temp_transactiondata  
 select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid,  s.selection as selection,  
 case when t.transactiondate < igt_startdate then igt_previousbusinessdate 
 when t.transactiondate > igt_enddate then igt_nextbusinessdate
 else igt_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid, t.locationid, t.cartid, t.tranheaderid,  
 -----lottery section  
 coalesce(concat(t.uuid , ' - ' ,right(concat('00' , cast (ld.boardseqnumber as varchar)),2)), t.uuid) as boardseqnumber,  
 ld.entrymethod,   ld.numboards, ld.numdraws, ld.drawid,ld.ebetslipinfo_mobnbr, ld.numsimplebets,ld.qpflag,
 ld.nummarks,   ld.bulkid,  ld.itoto_numparts,ld.itoto_totalparts, ld.grptoto_numparts,    

 -----sports section  
 null, null, null, null, null, null, null,

 -----value amount section  
 coalesce(amt.wager, 0) as wager,   
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then   amt.returnamount else 0  end as returnamount,
 case when transactiontype = 3 then   amt.winningamount else 0 end as winningamount,  
  null,
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_Temp_LotteryDetail ld on t.ticketserialnumber = ld.ticketserialnumber and bt.tranlineitemnumberid = ld.tranlineitemid   
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber and ld.tranlineitemid = s.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber and ld.tranlineitemid = amt.tranlineitemid  
 where t.prodid in (2,3,4) and bettypeid is not null and t.isbetrejectedbytrader = false
 and (t.transactiondate between startdate and enddate) 
  
 order by t.uuid  
 ; 
 insert into ubt_temp_transactiondata  
-- union all 
 
 --HORSE RACING (Per UUID)  

 select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid, --(19) bt.bettypeid as bettypeid,  
 s.selection as selection,  
  case when t.transactiondate < bmcs_startdate then bmcs_previousbusinessdate
	  when t.transactiondate > bmcs_enddate then bmcs_nextbusinessdate
	  else bmcs_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,  t.userid,t.locationid,t.cartid, t.tranheaderid,
   
 -----lottery section  
 t.uuid as boardseqnumber,  
 case t.entrymethodid  
  WHEN 'MANUAL' THEN 0  
  WHEN 'BETSLIP' THEN 2  
  WHEN 'EDIT' THEN 10  
  WHEN 'EBETSLIP' THEN 16  
 end as entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
 
 -----sports section   
 null,null,null,null,null,null,null,
 
 -----value amount section   
 coalesce(amt.wager, 0) as wager,  
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then amt.returnamount else 0 end as returnamount,  
 case when transactiontype = 3 then amt.winningamount else 0 end as winningamount,
 case when t.transactiontype = 3 then amt.rebatereclaim else coalesce(hd.betlinerebateamount,0)   end as betlinerebateamount, 
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_temp_HorseDetail hd on t.ticketserialnumber = hd.ticketserialnumber
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber 
 where t.prodid = 1 and t.isbetrejectedbytrader = false and (t.transactiondate::timestamp between startdate and enddate)
 order by t.uuid  

 ; insert into ubt_temp_transactiondata 
-- union all 
  --SPORTS (Per UUID)  For Bet Placement
 
 select  
 t.uuid,   t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 sd.bettype as bettypeid,  
 sd.selection as selection,  
  case when t.transactiondate < ob_startdate then ob_previousbusinessdate 
 when t.transactiondate > ob_enddate then ob_nextbusinessdate
 else ob_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid,   t.locationid,   t.cartid,   t.tranheaderid,  
 -----lottery section  
 t.uuid as boardseqnumber,   sd.entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
  -----sports section   
 sd.eventid,   sd.leaguecode,   sd.liveindicator,   sd.eventname,   sd.bettypename,  
 sd.selectionodds,   sd.starttime,  
 -----value amount section   
 amt.wager as wager,  
 amt.secondwager as secondwager,  
 pbtli.salesfactoramount as sales,
 amt.secondsales as secondsales,  
 coalesce(amt.salescomm, 0) as salescomm, 
 coalesce(amt.secondsalescomm,0) as secondsalescomm, 
 coalesce(amt.gst,0) as gst, 
 amt.secondgst as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount  else 0 end as returnamount, 
 case when transactiontype = 3 then amt.winningamount   else 0 end as winningamount,
  null as betlinerebateamount,  
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 inner join   public.ztubt_sports_placedbettransactionlineitem  pbtli on t.tranheaderid = pbtli.tranheaderid  
 inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid 
 left join ubt_temp_sportsdetail sd on t.ticketserialnumber = sd.ticketserialnumber and pbtli.tranlineitemid = sd.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber  
 where 
pbvbcbtdis.transactiontypetotal in (1,4,6) 
 and t.prodid in (5, 6) and t.isbetrejectedbytrader = false and ( t.transactiondate between startdate and enddate)
 order by t.uuid  
 ;
  insert into ubt_temp_transactiondata 
-- union all 
 
select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 sd.bettype as bettypeid,   sd.selection as selection,  
 case when t.transactiondate < ob_startdate then ob_previousbusinessdate 
 when t.transactiondate > ob_enddate then ob_nextbusinessdate
 else ob_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid,   t.locationid,   t.cartid,   t.tranheaderid,  
 -----lottery section  
 t.uuid as boardseqnumber,   sd.entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
  -----sports section   
 sd.eventid,   sd.leaguecode,   sd.liveindicator,   sd.eventname,   sd.bettypename,   
 sd.selectionodds,   sd.starttime,  
 -----value amount section   
 amt.wager as wager,  
 amt.secondwager as secondwager,  
 pbtli.salesfactoramount as sales,
 amt.secondsales as secondsales,  
 coalesce(amt.salescomm, 0) as salescomm, 
 coalesce(amt.secondsalescomm,0) as secondsalescomm, 
 coalesce(amt.gst,0) as gst, 
 amt.secondgst as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount else 0  end as returnamount,
 case when transactiontype = 3 then amt.winningamount else 0  end as  winningamount,
 null as betlinerebateamount,  
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on t.tranheaderid = pbtli.tranheaderid  
 inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid 
 left join ubt_temp_sportsdetail sd on t.ticketserialnumber = sd.ticketserialnumber and pbtli.tranlineitemid = sd.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber  
 where pbvbcbtdis.transactiontypetotal in (3,5) 
 and t.prodid in (5, 6) and t.isbetrejectedbytrader = false and (t.transactiondate between startdate and enddate)
 order by t.uuid  

 ;
create index idx_ubt_transdata_uuid on  ubt_temp_transactiondata(uuid );
create index idx_ubt_transdata_productid  on  ubt_temp_transactiondata(productid );
create index idx_ubt_transdata_selection  on  ubt_temp_transactiondata(selection );
create index idx_ubt_transdata_businessdate  on  ubt_temp_transactiondata(businessdate );
create index idx_ubt_transdata_tranheaderid  on  ubt_temp_transactiondata(tranheaderid  );

--Interface table output-------
return query
	SELECT UUID ,
	TRANHEADERID,
	TRANSACTIONTYPE,
	PRODUCTID,
	BETTYPEID,
	SELECTION,
	BUSINESSDATE, 
	--TRANSACTIONTIMESTAMP,
	to_char(TRANSACTIONTIMESTAMP,'yyyy-MM-dd HH24:mi:ss') ::timestamp as TRANSACTIONTIMESTAMP, -- For FR include second 04 Apr 2022
	TERMINALID,
	USERID,
	LOCATIONID,
	BOARDSEQNUMBER,
	coalesce(ENTRYMETHOD,0),
	coalesce(NUMBOARDS,0),
	coalesce(NUMDRAWS,0),
	coalesce(DRAWID,''),
	coalesce(EBETSLIPINFO_MOBNBR,''),
	coalesce(NUMSIMPLEBETS,0),
	coalesce(QPFLAG,0),
	coalesce(NUMMARKS,0),
	coalesce(BULKID,'') ,
	coalesce(ITOTO_NUMPARTS,''),
	ITOTO_TOTALPARTS,
	GRPTOTO_NUMPARTS,
	EVENTID,
	LEAGUECODE, 
	LIVEINDICATOR,
	EVENTNAME,
	MARKET,
	ODDS,
	MATCHKICKOFF,
	WAGER1,
	WAGER2,
	SALES1,
	SALES2,
	SALESCOMM1,
	SALESCOMM2,
	GST1,
	coalesce(GST2,0),
	RETURNAMOUNT,
	WINNINGAMOUNT, 
	PAYMENTMODE, 
	CARTID ,
	coalesce(BETLINEREBATEAMOUNT,0)
			from ubt_temp_transactiondata
			where TransactionTimestamp >= StartDate
			and TransactionTimestamp <= EndDate
	 ;

drop table 	ubt_temp_placebettransaction_type;
drop table	ubt_temp_LotteryDraw;
drop table	ubt_temp_numdraws;
drop table	ubt_Temp_LotteryDetail;
drop table	ubt_temp_NumBoards;
drop table	ubt_temp_HorseDetail;
drop table	ubt_temp_TotoSeq;
drop table	ubt_Temp_TotoGroup;
drop table	ubt_temp_Liveindidcator;
drop table	ubt_temp_sportsdetail;
drop table	ubt_temp_placebettransaction;
drop table	ubt_temp_bettype;
drop table	ubt_temp_trans;
drop table	ubt_temp_transactionamount;
drop table	ubt_temp_resultwager;
drop table	ubt_temp_resultsalescomwithdate;
drop table	ubt_temp_resultsalesandcomm ;
drop table	ubt_temp_resultGST;
drop table	ubt_temp_resultvalidation;
drop table	ubt_temp_resultvalidationexchange;
drop table	ubt_temp_transactiondata;
drop table	ubt_temp_final_lotteryselect;

END;
$$;


ALTER FUNCTION public.sp_ubt_gettransactiondataforinterval_bk20241010(startdatetime timestamp without time zone, enddatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1230 (class 1255 OID 2011874)
-- Name: sp_ubt_gettransactiondataforinterval_test(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransactiondataforinterval_test(startdatetime timestamp without time zone, enddatetime timestamp without time zone) RETURNS TABLE(uuid character varying, tranheaderid character varying, transactiontype integer, productid integer, bettypeid character varying, selection text, businessdate date, transactiontimestamp timestamp without time zone, terminalid character varying, userid character varying, locationid character varying, boardseqnumber character varying, entrymethod integer, numboards integer, numdraws integer, drawid character varying, ebetslipinfo_mobnbr character varying, numsimplebets integer, qpflag integer, nummarks integer, bulkid character varying, itoto_numparts text, itoto_totalparts text, grptoto_numparts text, eventid character varying, leaguecode character varying, liveindicator character, eventname text, market text, odds character varying, matchkickoff character varying, wager1 numeric, wager2 numeric, sales1 numeric, sales2 numeric, salescomm1 numeric, salescomm2 numeric, gst1 numeric, gst2 numeric, returnamount numeric, winningamount numeric, paymentmode character varying, cartid character varying, betlinerebateamount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
declare
startdate TIMESTAMP;
enddate timestamp;
bmcs_startdate timestamp;
igt_startdate timestamp;
ob_startdate timestamp;
bmcs_enddate timestamp;
igt_enddate timestamp;
ob_enddate timestamp;
bmcs_currentbusinessdate date;
igt_currentbusinessdate date;
ob_currentbusinessdate date;
bmcs_nextbusinessdate date;
igt_nextbusinessdate date;
ob_nextbusinessdate date;
bmcs_previousbusinessdate date;
igt_previousbusinessdate date;
ob_previousbusinessdate date;
startdateUTC timestamp;
enddateUTC timestamp;
v_tfogBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettfogbettypes()));

BEGIN
	
	
select 
startdatetime ,
enddatetime ,

fromdatetimebmcs ,
fromdatetimeigt ,
fromdatetimeob ,

todatetimebmcs ,
todatetimeigt ,
todatetimeob ,

(fromdatetimebmcs  ::DATE) ,
(fromdatetimeigt  :: DATE) ,
(fromdatetimeob  :: DATE) ,

(fromdatetimebmcs  ::DATE) + interval '1 Day' ,
(fromdatetimeigt  :: DATE) + interval '1 Day' ,
(fromdatetimeob  :: DATE) + interval '1 Day' ,

(fromdatetimebmcs  ::DATE)- interval '1 Day'  ,
(fromdatetimeigt  :: DATE)- interval '1 Day' ,
(fromdatetimeob  :: DATE) - interval '1 Day' ,

(startdatetime - interval '8 hour')  ,
(enddatetime - interval '8 hour')  

into 

startdate ,
enddate ,

bmcs_startdate ,
igt_startdate ,
ob_startdate ,

bmcs_enddate ,
igt_enddate ,
ob_enddate ,

bmcs_currentbusinessdate ,
igt_currentbusinessdate ,
ob_currentbusinessdate ,

bmcs_nextbusinessdate ,
igt_nextbusinessdate ,
ob_nextbusinessdate ,

bmcs_previousbusinessdate ,
igt_previousbusinessdate ,
ob_previousbusinessdate ,

startdateUTC ,
enddateUTC 
from public.sp_ubt_getcommonubtdates(StartDatetime ,StartDatetime );





--ubt_temp_placebettransaction #PBVBCBT

 create temporary table if not exists ubt_temp_placebettransaction(  
  TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(10),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  CreatedDate timestamp,
  RequestID varchar(40),
  UserDisplayID varchar(40),
  CartID varchar(50),
  TransactionType int4
 );

 


insert INTO ubt_temp_placebettransaction(TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket,TerDisplayID,CreatedDate,RequestID,UserDisplayID,CartID,TransactionType)

 
 SELECT TicketSerialNumber, PB.TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket
 ,TerDisplayID,PB.CreatedDate,RequestID,UserDisplayID,CartID, 1  TransactionType
  FROM public.ztubt_placedbettransactionheader PB  
  INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate  PBLC ON PB.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'  
  WHERE
	(PB.CreatedDate >= startdateUTC And PB.CreatedDate <= enddateUTC)
	  
  Union 
  SELECT VB.TicketSerialNumber, VB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader
  ,PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,VB.UserDisplayID,VB.CartID, 3 TransactionType
  FROM public.ztubt_validatedbetticket  VB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON VB.TicketSerialNumber = PB.TicketSerialNumber  
  INNER JOIN public.ztubt_validatedbetticketlifecyclestate VBLC ON VB.TranHeaderID = VBLC.TranHeaderID AND VBLC.BetStateTypeID = 'VB06'  
  WHERE VB.ValidationTypeID IN ('VALD', 'RFND') 
  AND   (VB.CreatedValidationDate >= startdateUTC And VB.CreatedValidationDate <= enddateUTC)
  Union
  SELECT CB.TicketSerialNumber, CB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader,
 
   PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,CB.UserDisplayID,CB.CartID,5 TransactionType
  
  FROM public.ztubt_CancelledBetTicket CB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON CB.TicketSerialNumber = PB.TicketSerialNumber
  INNER JOIN public.ztubt_cancelledbetticketlifecyclestate  CBLC ON CBLC.TranHeaderID = PB.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'  
  WHERE (PB.IsBetRejectedByTrader ) = FALSE AND (CB.CancelledDate >= startdate And CB.CancelledDate <= enddate)
  ;

 create index idx_ubt_ticketserialnumber on ubt_temp_placebettransaction(TicketSerialNumber);
 create index idx_ubt_tranheaderid on ubt_temp_placebettransaction(TranHeaderID);
create index idx_ubt_prodid on ubt_temp_placebettransaction(prodid);
create index idx_ubt_CreatedDate on ubt_temp_placebettransaction(CreatedDate);
create index idx_ubt_TransactionType on ubt_temp_placebettransaction(TransactionType);
 
 create temporary table if not exists ubt_temp_placebettransaction_type
 (TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(50),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  TransactionTypeTotal int4)
  ;
 
 insert into ubt_temp_placebettransaction_type
 
  Select TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID,
   IsBetRejectedByTrader,IsExchangeTicket, TerDisplayID
  ,SUM(TransactionType) TransactionTypeTotal 
  from ubt_temp_placebettransaction
  Group By TicketSerialNumber, TranHeaderID, DeviceID, EntryMethodID, ProdID, 
  IsExchangeTicket, TerDisplayID, IsBetRejectedByTrader
  ;
 
 create index idx_ubt_transaction_type_ticketserialnumber on ubt_temp_placebettransaction_type(TicketSerialNumber);
create index idx_ubt_transaction_type_tranheaderid on ubt_temp_placebettransaction_type(TranHeaderID);
create index idx_ubt_transaction_type_prodid on ubt_temp_placebettransaction_type(ProdID);
create index idx_ubt_transaction_type_isbetrejectedbytrader on ubt_temp_placebettransaction_type(IsBetRejectedByTrader);
create index idx_ubt_transaction_type_isexchangeticket on ubt_temp_placebettransaction_type(IsExchangeTicket);
create index idx_ubt_transaction_type_terdisplayid on ubt_temp_placebettransaction_type(TerDisplayID);
create index idx_ubt_transaction_type_transactiontypetotal on ubt_temp_placebettransaction_type(TransactionTypeTotal);
  
  --ubt_temp_placebettransaction_type #PBDVBCBT
  
   -----------------------------------------------------------------  
 --BET TYPE 
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_bettype  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemnumberid varchar(50),  
  bettypeid varchar(2)
 )  
 ; 
  

  
 --4D  
 INSERT INTO ubt_temp_bettype  
 SELECT
 PBVBCBT.TicketSerialNumber,  
 PBTLI.TranLineItemID,  
 CASE  
  WHEN PBTLI.BetTypeID = 'ORD' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN '0'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '5'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '10'  
   END  
  WHEN PBTLI.BetTypeID = 'SYS' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN   
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '1'  
WHEN PBTLI.Permutation = 12 THEN '2'  
  WHEN PBTLI.Permutation = 4 THEN '3'  
  WHEN PBTLI.Permutation = 6 THEN '4'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '6'  
  WHEN PBTLI.Permutation = 12 THEN '7'  
  WHEN PBTLI.Permutation = 4 THEN '8'  
  WHEN PBTLI.Permutation = 6 THEN '9'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
   CASE  
  WHEN PBTLI.Permutation = 24 THEN '11'  
  WHEN PBTLI.Permutation = 12 THEN '12'  
  WHEN PBTLI.Permutation = 4 THEN '13'  
  WHEN PBTLI.Permutation = 6 THEN '14'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'IBET' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '27'  
  WHEN PBTLI.Permutation = 12 THEN '28'  
  WHEN PBTLI.Permutation = 4 THEN '29'  
  WHEN PBTLI.Permutation = 6 THEN '30'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '31'  
  WHEN PBTLI.Permutation = 12 THEN '32'  
  WHEN PBTLI.Permutation = 4 THEN '33'  
  WHEN PBTLI.Permutation = 6 THEN '34'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '35'  
  WHEN PBTLI.Permutation = 12 THEN '36'  
  WHEN PBTLI.Permutation = 4 THEN '37'  
  WHEN PBTLI.Permutation = 6 THEN '38'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'ROLL' THEN  
   CASE  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '15'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber)= 2 THEN '16'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '17'  
  ELSE '18'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN 
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '19'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '20'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '21'  
  ELSE '22'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '23'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '24'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '25'  
  ELSE '26'  
 END  
   END  
 END AS BetTypeID  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitem   PBTLI ON PBVBCBT.TranHeaderID = PBTLI.TranHeaderID  
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON PBTLI.TranLineItemID = PBTLIN.TranLineItemID  
 WHERE PBVBCBT.ProdId = 2
 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0
and 
 ((PBTLIN.CreatedDate >= startdateUTC And PBTLIN.CreatedDate <= enddateUTC 
 and  PBVBCBT.TransactionTypeTotal In (1, 4, 6))	or  PBVBCBT.TransactionTypeTotal In (3,5))


 union all 
----TOTO

 
 select
 pbt.ticketserialnumber,   
 pbtli.tranlineitemid,  
 case pbtli.bettypeid   
  WHEN 'ORD'   THEN '0'  
  WHEN 'SYSR'  THEN '1'  
  WHEN 'SYS7'  THEN '2'  
  WHEN 'SYS8'  THEN '3'  
  WHEN 'SYS9'  THEN '4'  
  WHEN 'SYS10' THEN '5'  
  WHEN 'SYS11' THEN '6'  
  WHEN 'SYS12' THEN '7'  
  --TFOG
  WHEN 'FO4N'  THEN '16'  
  WHEN 'FO3N' THEN '17'  
  WHEN 'FO2N' THEN '18'  
  WHEN 'FO1AN' THEN '19'  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_toto_placedbettransactionlineitem pbtli  on pbt.tranheaderid = pbtli.tranheaderid  
 where pbt.prodid = 3 and  
  ((pbtli.createddate >= startdateutc and pbtli.createddate <= enddateutc and  
  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))
 
 union all
 
 ---SWEEP

 select
 pbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 '0' as bettypeid   
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_sweep_placedbettransactionlineitemnumber pbtlin on pbt.tranheaderid = pbtlin.tranheaderid  
 where   pbt.prodid = 4
 and issoldout  <> true and 
 ((pbtlin.createddate >= startdateutc and pbtlin.createddate <= enddateutc
 and  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))

 --SPORT
 union all
 select
 pbvbcbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 case scat.categoryid when 1 
 then 
 case pbtli.accumulatorid   
  WHEN 'ACC4' THEN '4F'  
  WHEN 'DBL' THEN 'D'  
  WHEN 'SGL' THEN 'S'  
  WHEN 'TBL' THEN 'T'  
  END 
 WHEN 2 THEN 'S'
  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbvbcbt 
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on pbvbcbt.tranheaderid = pbtli.tranheaderid  
 inner  join public.ztubt_sports_placedbettransactionlineitemnumber  pbtlin on pbtli.tranlineitemid = pbtlin.tranlineitemid 
 inner join public.ztubt_sportevent se on pbtlin.eventid = se.eventid  
 inner join public.ztubt_sporttype st on se.typeid = st.typeid  
 inner join public.ztubt_sportclass sc on st.classid = sc.classid  
 inner join public.ztubt_sportcategory scat on sc.categoryid = scat.categoryid 
 where (scat.categoryid= 1)  or (scat.categoryid=2 and pbvbcbt.prodid in (5,6) )
 
 group by pbvbcbt.ticketserialnumber,pbtlin.tranlineitemid, scat.categoryid,pbtli.accumulatorid 
 ;
 
create index  ind_ticketsrno on ubt_temp_bettype(ticketserialnumber);
 -----------------------------------------------------------------  
 --DETAIL OF HORSE  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_horsedetail  
 (  
  ticketserialnumber varchar(500),  
  entrymethod int4,  
  betlinerebateamount numeric(22,2) 
 )  
 ;

 insert into ubt_temp_horsedetail
 
 
 SELECT ADP.TicketSerialNumber,
  CASE ADP.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 SUM(ADP.Amount) AS BetLineRebateAmount  
 FROM  
 (  
  SELECT   PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, EntryMethodID,  
  CASE WHEN BetTypeID = 'W-P'  
THEN (coalesce(PBTL.BoardRebateAmount,0))  
   ELSE SUM(coalesce(PBTL.BoardRebateAmount,0))   
  END AS Amount
  
  FROM ubt_temp_placebettransaction_type PBVBCBT 
  INNER JOIN   public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCBT.TranHeaderID = PBTL.TranHeaderID  
	WHERE  PBVBCBT.ProdID = 1 and 
	((PBTL.CreatedDate >= startdateUTC And PBTL.CreatedDate <= enddateUTC 	
AND PBVBCBT.TransactionTypeTotal In (1, 4, 6) ) or PBVBCBT.TransactionTypeTotal in (3,5))
  GROUP BY  PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BoardRebateAmount, EntryMethodID
 )ADP  
 GROUP BY ADP.TicketSerialNumber, ADP.EntryMethodID
 ;
 
create index idx_ubt_horse_ticketsrno on ubt_temp_horsedetail(TicketSerialNumber);
 -----------------------------------------------------------------  
 --DETAIL OF LOTTERY  
 -----------------------------------------------------------------  
  
 create temporary table if not exists ubt_temp_numboards  
 (  
  ticketserialnumber varchar(500),  
  numboards int4,  
  bulkid varchar(50)
 ) ; 
  
 INSERT INTO ubt_temp_NumBoards  
 --4D
 SELECT DISTINCT PBT.TicketSerialNumber,   
 COUNT(z4dln.TranLineItemID) AS NumBoards,  
 NULL AS BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN   public.ztubt_4d_placedbettransactionlineitemnumber  z4dln ON PBT.TranHeaderID = z4dln.TranHeaderID  
 WHERE PBT.ProdID = 2 and  coalesce(z4dln.BigBetAcceptedWager, 0) + coalesce(z4dln.SmallBetAcceptedWager, 0) > 0 AND
 ((z4dln.CreatedDate >= StartDateUTC And z4dln.CreatedDate <= EndDateUTC  
  AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 
 GROUP BY PBT.TicketSerialNumber 
 
 
 union all 
 --TOTO
 
 select pbvbcbt.ticketserialnumber,   
 count(pbtl.tranlineitemid) as numboards,  
 null as bulkid  
 from ubt_temp_placebettransaction_type pbvbcbt   
 inner join  public.ztubt_toto_placedbettransactionlineitem  pbtl on pbvbcbt.tranheaderid = pbtl.tranheaderid  
 where   pbvbcbt.prodid = 3 and  
 ((pbtl.createddate >= startdateUTC and pbtl.createddate <= enddateUTC and
  pbvbcbt.transactiontypetotal in (1, 4, 6)) or pbvbcbt.transactiontypetotal in (3,5))
 group by pbvbcbt.ticketserialnumber  

 
 union  all 
 
 --SWEEP
 SELECT PBT.TicketSerialNumber,   
 COUNT(PLN.TranLineItemID) AS NumBoards,  
 BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitem  PL ON PBT.TranHeaderID = PL.TranHeaderID  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitemnumber  PLN ON PL.TranLineItemID = PLN.TranLineItemID  
 WHERE  PBT.ProdID = 4 AND IsSoldOut <> true and
 ((PLN.CreatedDate >= StartDateUTC And PLN.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  
 GROUP BY PBT.TicketSerialNumber, BulkID 
 
 ;
create index idx_ubt_numboard_ticketsrno on ubt_temp_numboards (TicketSerialNumber);

create temporary table ubt_temp_LotteryDraw
( TicketSerialNumber varchar (200),
HostDrawDatesId varchar(20)
)
 ;
	insert into ubt_temp_LotteryDraw
Select PBTT.TicketSerialNumber, CAST(zdm.HostDrawDatesId AS VARCHAR) HostDrawDatesId

	FROM ubt_temp_placebettransaction_type PBTT  
	INNER JOIN public.ztubt_drawdates zdm  ON PBTT.TranHeaderID = zdm.TranHeaderID   
	Where  PBTT.ProdID In (2,3,4) 

;	
create index idx_ubt_lotterydraws_ticketsrno on ubt_temp_LotteryDraw (TicketSerialNumber,HostDrawDatesId);

create temporary table ubt_temp_numdraws
( TicketSerialNumber varchar (200),
NumDraws int4,
Drawid varchar(50)
)
 ;
	insert into ubt_temp_numdraws
	SELECT
	LD.TicketSerialNumber,
	Count(1) NumDraws,
	string_agg(CAST(LD.HostDrawDatesId AS varchar),',' ) as Drawid

	From ubt_temp_LotteryDraw LD 
	Group By LD.TicketSerialNumber

;
	
create index idx_ubt_numdraws_ticketsrno on ubt_temp_numdraws (TicketSerialNumber);

 create temporary table if not exists ubt_temp_lotterydetail  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemid varchar(50),  
  boardseqnumber int,  
  entrymethod int,  
  numboards int,  
  numdraws int,  
  drawid varchar(500),  
  ebetslipinfo_mobnbr varchar(100),  
  numsimplebets int4,  
  qpflag int4,  
  nummarks int4,  
  bulkid varchar(50), --(5)  
  itoto_numparts text, -- varchar(max)  
  itoto_totalparts text,   --varchar(max)
  grptoto_numparts text   --varchar(max)
 )  
  
 ;
 create temporary table if not exists ubt_temp_TotoSeq (  
  TranLineItemID varchar(50),  
  Seq INT4  
 )  
  ;
 create temporary table if not exists ubt_Temp_TotoGroup ( 
  GroupHostID varchar(50),  
  GroupToto INT4 
 ) ; 
  
 INSERT INTO ubt_temp_TotoSeq  
 SELECT LIN.TranLineItemID, MAX(LIN.Sequence) AS Seq  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join  public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitemnumber  LIN on LI.TranLineItemID = LIN.TranLineItemID
 WHERE PBT.ProdID = 3 and 
 ((LI.CreatedDate >= StartDateUTC And LI.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY LIN.TranLineItemID  
 ;
 
 INSERT INTO ubt_Temp_TotoGroup 
 SELECT LI2.GroupHostID, MAX(LI2.GroupUnitSequence) AS GroupToto  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitem LI2 on LI.GroupHostID = LI2.GroupHostID
 WHERE PBT.ProdID = 3
 AND LI.GroupHostID <> '00000000-0000-0000-0000-000000000000' AND LI.GroupUnitSequence IS NOT NULL 
 GROUP BY LI2.GroupHostID
 
 ;
 --4D
 
 INSERT INTO ubt_Temp_LotteryDetail  
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
   PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
   PBVBCBT.TransactionTypeTotal In (1, 4, 6)  

union all 

 
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)

 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
 PBVBCBT.TransactionTypeTotal in (3,5)
  
union all
 
 --TOTO  
  
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE 
  WHEN TOTO.BetTypeID = ANY(v_tfogBettypes) THEN 1
  WHEN TOTO.BetTypeID = 'ORD' THEN 1  
  WHEN TOTO.BetTypeID = 'SYSR' THEN 44  
  WHEN TOTO.BetTypeID = 'SYS7' THEN 7  
  WHEN TOTO.BetTypeID = 'SYS8' THEN 28  
  WHEN TOTO.BetTypeID = 'SYS9' THEN 84  
  WHEN TOTO.BetTypeID = 'SYS10' THEN 210  
  WHEN TOTO.BetTypeID = 'SYS11' THEN 462  
  WHEN TOTO.BetTypeID = 'SYS12' THEN 924 
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and 
 TOTO.CreatedDate >= StartDateUTC And TOTO.CreatedDate <= EndDateUTC   
 AND PBVBCBT.TransactionTypeTotal In (1, 4, 6)
 
 union all 
 
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE 
  WHEN TOTO.BetTypeID = ANY(v_tfogBettypes) THEN 1
  WHEN TOTO.BetTypeID = 'ORD' THEN 1  
  WHEN TOTO.BetTypeID = 'SYSR' THEN 44  
  WHEN TOTO.BetTypeID = 'SYS7' THEN 7  
  WHEN TOTO.BetTypeID = 'SYS8' THEN 28  
  WHEN TOTO.BetTypeID = 'SYS9' THEN 84  
  WHEN TOTO.BetTypeID = 'SYS10' THEN 210  
  WHEN TOTO.BetTypeID = 'SYS11' THEN 462  
  WHEN TOTO.BetTypeID = 'SYS12' THEN 924 
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and PBVBCBT.TransactionTypeTotal in (3,5)
 
 union all 
 
 --SWEEP
 
 SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and 
PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
  PBVBCBT.TransactionTypeTotal In (1, 4, 6)
  
  union all 
  
  SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and PBVBCBT.TransactionTypeTotal In (3,5)

;
 
create index idx_ubt_lotterydetail_ticketsrno  on ubt_Temp_LotteryDetail(TicketSerialNumber);
create index idx_ubt_lotterydetail_tranlineitemid  on ubt_Temp_LotteryDetail(TranLineItemID);
 -----------------------------------------------------------------  
 --DETAIL OF SPORTS  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_Liveindidcator  
 (  
  TicketSerialNumber VARCHAR(500),  
  LiveIndicator CHAR(1)  
 )  
  ;
 INSERT INTO ubt_temp_Liveindidcator  
 SELECT din.TicketSerialNumber,   
 CASE  
  WHEN (din.HasBetInRun = TRUE) AND (din.CreatedDate BETWEEN din.StartTime AND din.SuspendTime) THEN 'Y'  
  ELSE 'N'  
 END AS LiveIndicator  
 FROM  
 (  
  SELECT ROW_NUMBER() OVER (PARTITION BY SPBN.TranHeaderID 
  							ORDER BY SPBN.TranLineItemID
--		  					ORDER BY split_part(SPBN.tranlineitemid,'-',5)
--									,split_part(SPBN.tranlineitemid,'-',4)
--									,split_part(SPBN.tranlineitemid,'-',3)
--									,split_part(SPBN.tranlineitemid,'-',2)
--									,split_part(SPBN.tranlineitemid,'-',1)
  							) AS ROWNUM,
  PBVBCBT.TicketSerialNumber, SE.HasBetInRun, SE.StartTime, SE.SuspendTime, SPBN.CreatedDate  
  FROM ubt_temp_placebettransaction_type PBVBCBT
  INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  SPBN ON PBVBCBT.TranHeaderID = SPBN.TranHeaderID  
  INNER join public.ztubt_sportevent SE ON SPBN.EventID = SE.EventId  
  WHERE PBVBCBT.ProdID IN(5,6)
 )din  
 WHERE din.ROWNUM = 1  
;
create index idx_ubt_liveindicator_ticketsrno  on ubt_temp_Liveindidcator(TicketSerialNumber); 

 create temporary table if not exists ubt_temp_sportsdetail
 (  
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID Varchar(50),--(1)  
  EntryMethod INT4,  
  EventID VARCHAR(500),  
  LeagueCode VARCHAR(500),  
  LiveIndicator CHAR(1),  
  EventName text,  
  BetTypeName text,  
  Selection VARCHAR(500),  
  SelectionOdds VARCHAR(500),  
  StartTime VARCHAR(500),  
  BetType VARCHAR(500)
 )  
  ;
 INSERT INTO ubt_temp_sportsdetail  
 SELECT PBVBCBT.TicketSerialNumber,   
 PLN.TranLineItemID,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 PLN.EventID AS EventID,  
 SL.LeagueCode AS LeagueCode,  
 LI.LiveIndicator :: char AS LiveIndicator,  
 PLN.EventName AS EventName,  
 PLN.BetTypeName AS BetTypeName,  
 PLN.SelectionName AS Selection,  
 PLN.SelectionOdds AS SelectionOdds,  
 --to_char(SE.StartTime, 'yyyyMMdd HHmmss') AS StartTime, b.BetTypeID 
to_char(SE.StartTime, 'yyyyMMdd HH24miss') AS StartTime, b.BetTypeID 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  PLN ON PBVBCBT.TranHeaderID = PLN.TranHeaderID
 INNER JOIN public.ztubt_sportevent  SE ON PLN.EventID = SE.EventId  
 INNER JOIN public.ztubt_sporttype  ST ON SE.TypeId = ST.TypeId  
 INNER JOIN public.ztubt_sportleagueinfo  SL ON REPLACE(ST.Name, '|', '') = REPLACE(SL.Name, '|', '')  
 INNER JOIN ubt_temp_Liveindidcator LI ON PBVBCBT.TicketSerialNumber = LI.TicketSerialNumber  
 inner join ubt_temp_bettype b on b.TranLineItemNumberID = PLN.TranLineItemID  
 LEFT JOIN public.ztubt_entrymethod  EM ON PBVBCBT.EntryMethodID = EM.EntryMethodID  
 WHERE PBVBCBT.ProdID IN (5,6)  
 GROUP BY PBVBCBT.TicketSerialNumber, PLN.TranLineItemID, PBVBCBT.EntryMethodID, PLN.EventID, SL.LeagueCode, 
 LI.LiveIndicator, PLN.EventName, PLN.BetTypeName, PLN.SelectionOdds, SE.StartTime,  b.BetTypeID, PLN.SelectionName  
 ;

create index idx_ubt_sportdetail_ on ubt_temp_sportsdetail(TicketSerialNumber,TranLineItemID);
 
  
 -------------------------------------------------------------------------  
 --GET TRANSACTION (COLLECTION, VALIDATION, CANCELLATION) PER AD HOC TIME  
 -------------------------------------------------------------------------  
 create temporary table if not exists ubt_temp_trans  
 (  
  EntryMethodID VARCHAR(10),  --(S5)
  ProdID int4,  --(S5)
  IsBetRejectedByTrader bool, --(S5)
  TicketSerialNumber VARCHAR(200),  
  UUID VARCHAR(33),  
  TransactionType INT4,  
  TransactionDate timestamp,  
  TerminalID VARCHAR(100),  
  UserID VARCHAR(100),  
  LocationID VARCHAR(200),  
  CartID varchar(50),  
  TranHeaderID varchar(50),
  LocID int4
 )  
   ;
-------COLLECTION--------------
   
 --HORSE RACING  
  INSERT INTO ubt_temp_trans  
  SELECT  
  PB.EntryMethodID, 
  PB.ProdID,  --(S5)
  PB.IsBetRejectedByTrader , --(S5)
  PB.TicketSerialNumber AS TSN,  
  PB.RequestID AS UUID,  
  1 AS TransactionType, --Wager  
  ( PB.CreatedDate + interval '8 hour'),  
 PB.TerDisplayID AS TerminalID,  PB.UserDisplayID AS UserID,  L.LocDisplayID AS LocationID,  
  PB.CartID,  
  PB.TranHeaderID  ,
  T.LocID
  FROM ubt_temp_placebettransaction PB  
  INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.terdisplayid  
  LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
  WHERE PB.ProdID  in (1, 2, 3, 4, 5, 6) and  
   PB.TransactionType = 1 
 AND  (PB.CreatedDate >= StartDateUTC And PB.CreatedDate <= EndDateUTC) 
 
  --ProdID = 1 --HORSE RACING
  --ProdId=2,3,4 Lottery
  --prodid=5,6 sports
  
  ------------VALIDATION -----------
  
  
  
union all 
--Horse Racing

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  ,
  T.LocID
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID = 1 
 AND (coalesce (zv.WinningAmount,0) > 0 OR coalesce (zv.RebateReclaim,0) > 0) 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 --Lottery(prod id (2,3,4)  & Sports prodid (5,6)
 union all 
 

 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 zv.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  ,
  T.LocID
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (2,3,4)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 union all 
 
 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  ,
  T.LocID
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' -- Issue:Fixed on 20220221 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 
 
union all 
--refund

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 61 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  ,
  T.LocID
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (5, 6) 
 AND  zv.ValidationTypeID = 'RFND' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
---- ----CANCELLATION-------------------
 union all
 --Horse racing prodid (1) & Lottery prodid (2,3,4)
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  ,
  T.LocID
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID =1 --HORSE RACING  
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 

 union all 
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 cbt.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  ,
  T.LocID
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (2,3,4)  -- Lottery
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
union all
 --Sports
 
  SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  ,
  T.LocID
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)   --SPORTS
 AND PB.TransactionType = 5 
 AND PB.IsBetRejectedByTrader = false 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
 ;

create index idx_ubt_trans_ticketserialnumber on ubt_temp_trans(TicketSerialNumber);
create index idx_ubt_trans_tranheaderid on ubt_temp_trans(TranHeaderID);
  --FINAL RESULT OF TRANSACTIONAL VIEW  
 -----------------------------------------------------------------  
  
  
 create temporary table if not exists ubt_temp_transactionamount(
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID varchar(50),  
  Wager numeric(22,2), 
  SecondWager numeric(22,2), 
  Sales numeric(22, 11),  
  SecondSales numeric(22, 11),  
  SalesComm numeric(22, 11),  
  SecondSalesComm numeric(22, 11),  
  GST numeric(22, 11),  
  SecondGST numeric(22, 11),  
  ReturnAmount  numeric(22,2),  
  WinningAmount  numeric(22,2),  
  RefundAmount  numeric(22,2),  
  RebateReclaim  numeric(22,2)
 )  
  
 ;
 --COLLECTION 
 
 
 create temporary table if not exists ubt_temp_resultwager  
(  
ProdID int4,
 TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
 Wager numeric(22,2), 
 SecondWager numeric(22,2)
)  
;
 insert into ubt_temp_resultwager
 select 1::int4 ProdID, amtw.TicketSerialNumber, null , SUM(amtw.Amount) AS Wager, 0 AS SecondWager  
 FROM  
(  
SELECT   PBVBCB.TicketSerialNumber, PBTL.TranHeaderID,  
CASE WHEN BetTypeID = 'W-P' 
THEN (coalesce (PBTL.BetPriceAmount,0))  
ELSE SUM(coalesce (PBTL.BetPriceAmount,0))   
END AS Amount,  
COUNT(DISTINCT PBVBCB.TicketSerialNumber) Ct, 'COL' AS Flag,'CH' AS TransType  
FROM  
ubt_temp_placebettransaction_type PBVBCB 
INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCB.TranHeaderID = PBTL.TranHeaderID 
WHERE PBVBCB.ProdID = 1
and ((PBTL.CreatedDate >= StartDateUTC And PBTL.CreatedDate <= EndDateUTC
AND PBVBCB.TransactionTypeTotal In (1, 4, 6) ) or PBVBCB.TransactionTypeTotal in (3,5))

GROUP BY  PBVBCB.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BetPriceAmount 	
)amtw  
GROUP BY amtw.TicketSerialNumber

union all 

--4D

SELECT  2::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BigBetAcceptedWager,0)) AS Wager, SUM(coalesce (zdp.SmallBetAcceptedWager,0)) AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  
INNER JOIN public.ztubt_drawdates zd   ON zd.TranHeaderID = zdp.TranHeaderID   
WHERE  PBT.ProdID = 2 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >=StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID  


union all 
--toto

SELECT  3::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BetPriceAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  

WHERE  PBT.ProdID = 3 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 

--sweep

SELECT   4::int4 ProdID, PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.BetPriceAmount,0)) AS Wager, 0 AS SecondWager 
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = False  
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zplc   ON zplc.TranHeaderID = PBT.TranHeaderID  
INNER JOIN (select terdisplayid,Locid from public.ztubt_terminal ) Ter  ON PBT.TerDisplayID = Ter.TerDisplayID
INNER JOIN (Select * from  public.ztubt_location) Loc  ON Ter.LocID = Loc.LocID
WHERE ( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zplc.BetStateTypeID = 'PB06' ) 	
		OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zplc.BetStateTypeID = 'PB03' ) )
AND PBT.ProdID=4
AND ((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 

--sports

SELECT   FIN.ProdID ProdID, FIN.TicketSerialNumber, NULL, SUM(coalesce (FIN.BetAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
(  
select PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, BetAmount, TicketSerialNumber  
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sports_placedbettransactionlineitem zsp  ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE   
PBT.ProdID IN (5, 6) AND PBT.IsBetRejectedByTrader != TRUE 
GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet, AccumulatorID, BetAmount, TicketSerialNumber  
)FIN  
GROUP BY FIN.TicketSerialNumber, FIN.ProdID 
;

create index idx_ubt_resultwager_TicketSerialNumber  on ubt_temp_resultwager(TicketSerialNumber);
create index idx_ubt_resultwager_tranlineitemid  on ubt_temp_resultwager(TranLineItemID);

--For Sales Comm, Sales Factor and Output GST  
create temporary table if not exists ubt_temp_resultsalescomwithdate  
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 SalesCommAmount numeric(32, 12),  
 SalesFactorAmount numeric(32, 12),  
 SecondSalesCommAmount numeric(32, 12),  
 SecondSalesFactorAmount numeric(32, 12),  
 GSTRate numeric(10, 2)
)  ;
  
--Toto

insert into ubt_temp_resultsalescomwithdate
select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmount,0)) SalesCommAmount,
SUM(coalesce (zdp.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
	ubt_temp_placebettransaction_type PBT  
	Inner jOin public.ztubt_toto_placedbettransactionlineitem  zdp   ON PBT.TranHeaderID = zdp.TranHeaderID
WHERE  PBT.ProdID = 3 
AND PBT.IsExchangeTicket = FALSE  
AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <=EndDateUTC
AND  PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 
--horse

SELECT amt.TicketSerialNumber, NULL  , SUM(amt.SalesCommAmount) , SUM(amt.SalesFactorAmount)  , 0 , 0  
FROM  
(  
 SELECT   PBT.TicketSerialNumber, zhp.TranHeaderID,  
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesCommAmount,0))  
  ELSE SUM(coalesce (zhp.SalesCommAmount,0))   
 END AS SalesCommAmount,   
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesFactorAmount,0))  
  ELSE SUM(coalesce (zhp.SalesFactorAmount,0))   
 END AS SalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT  
	 INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  zhp ON PBT.TranHeaderID = zhp.TranHeaderID  
	 INNER JOIN (select Terdisplayid,LocID from public.ztubt_terminal zt) Ter ON PBT.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0   
	 where PBT.ProdID = 1 and 
	 (
	 	(zhp.CreatedDate >= StartDateUTC 
	 	 And zhp.CreatedDate <= EndDateUTC
	  	 AND PBT.TransactionTypeTotal In (1, 4, 6)) 
	  or 
	  	(PBT.TransactionTypeTotal In (3, 5))
	 )  
 GROUP BY PBT.TicketSerialNumber, zhp.TranHeaderID, zhp.CreatedDate::Date
 , BetTypeID, SalesCommAmount, SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber


union all 

--4D

select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmountBig,0)) SalesCommAmount, 
 SUM(coalesce (zdp.SalesFactorAmountBig,0)) SalesFactorAmount, SUM(coalesce (zdp.SalesCommAmountSmall,0)) SecondSalesCommAmount
, SUM(coalesce (zdp.SalesFactorAmountSmall,0)) SecondSalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT   
	 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber zdp   ON zdp.TranHeaderID = PBT.TranHeaderID  
	 INNER JOIN  public.ztubt_drawdates zd ON zd.TranHeaderID = PBT.TranHeaderID --(7)  
 where PBT.ProdID = 2 and 
  ((zdp.CreatedDate >= StartDateUTC  And zdp.CreatedDate <=EndDateUTC
   AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  AND PBT.IsExchangeTicket = false 
 GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID

union all 

--sweeep

SELECT  PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (zspn.SalesFactorAmount,0)) SalesFactorAmount, 0, 0  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = FALSE 
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zpls   ON zpls.TranHeaderID = PBT.TranHeaderID 
 INNER JOIN (Select terdisplayid, Locid from public.ztubt_terminal ) Ter ON PBT.TerDisplayID = Ter.TerDisplayID 
 INNER JOIN (Select locid,locdisplayid,sweepindicator from public.ztubt_location ) Loc ON Ter.LocID = Loc.LocID 
WHERE PBT.ProdID=4  and 
( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zpls.BetStateTypeID = 'PB06' ) 	
	OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zpls.BetStateTypeID = 'PB03' ) )
and
((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC

	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	
GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 
--Sports

select amt.TicketSerialNumber, NULL , SUM(coalesce (amt.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (amt.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
(  
 SELECT PBT.ProdID ProductName, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, SalesCommAmount, TicketSerialNumber, SalesFactorAmount  
 FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN  public.ztubt_sports_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE PBT.ProdID IN (5,6)
 AND
 PBT.IsBetRejectedByTrader=false 
 GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,
 AccumulatorID, SalesCommAmount, TicketSerialNumber, (zsp.CreatedDate :: date), SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber
;

create index idx_ubt_resulsalescomwithdate_ticket on ubt_temp_resultsalescomwithdate(TicketSerialNumber);
create index idx_ubt_resulsalescomwithdate_tranlineitemid on ubt_temp_resultsalescomwithdate(TranLineItemID);


 create temporary table if not exists ubt_temp_resultsalesandcomm   
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 Sales numeric(32, 12),  
 SecondSales numeric(32, 12),
 SalesComm numeric(22, 11),  
 SecondSalesComm numeric(22, 11)
)  
  ;
INSERT INTO ubt_temp_resultsalesandcomm  
SELECT FIN.TicketSerialNumber, FIN.TranLineItemID, SUM(FIN.SalesFactorAmount), 
SUM(FIN.SecondSalesFactorAmount), SUM(FIN.SalesCommAmount), SUM(FIN.SecondSalesCommAmount)  
FROM ubt_temp_resultsalescomwithdate FIN  
GROUP BY FIN.TicketSerialNumber, FIN.TranLineItemID  

;

create index idx_ubt_resulsalescom_ticket on ubt_temp_resultsalesandcomm(TicketSerialNumber);
create index idx_ubt_resulsalescom_tranlineitemid on ubt_temp_resultsalesandcomm(TranLineItemID);

---------------------------------------------------------  
--GST (OUTPUT GST = WAGER - SALES)  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultGST   
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
GST numeric(22, 11),  
SecondGST numeric(22, 11)
) ; 
   
--LOTTERY(2,3,4) and Horse(1) and Sports(5,6)

INSERT INTO ubt_temp_resultGST   
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber AND w.TranLineItemID = S.TranLineItemID  
WHERE w.ProdID IN (2, 3, 4) 
union all 
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber 
WHERE w.ProdID IN (1,5,6) 

;

create index idx_ubt_resultGST_ticket on ubt_temp_resultGST(TicketSerialNumber);
create index idx_ubt_resultGST_tranlineitemid on ubt_temp_resultGST(TranLineItemID);

---------------------------------------------------------  
--VALIDATION  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultvalidation 
(   
TicketSerialNumber VARCHAR(200),  
ReturnAmount numeric(22,2), 
WinningAmount numeric(22,2),
RefundAmount numeric(22,2), 
RebateReclaim numeric(22,2) 
)  
  
;
INSERT INTO ubt_temp_resultvalidation  
SELECT zv.TicketSerialNumber,   
zv.WinningAmount AS ReturnAmount,  
CASE WHEN coalesce(zv.WinningAmount, 0) > 0 THEN  
zv.WinningAmount - (SUM(RW.Wager)/coalesce (COUNT(RW.TicketSerialNumber),1)) - (SUM(RW.SecondWager)/coalesce(COUNT(RW.TicketSerialNumber),1)) --(6) 
ELSE  0
  
END AS WinningAmount, --(4)  
zv.RefundAmount, zv.RebateReclaim --(1)  
FROM ubt_temp_resultwager RW  
 INNER join public.ztubt_validatedbetticket zv   ON RW.TicketSerialNumber = zv.TicketSerialNumber  
 INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvlc   ON zv.TranHeaderID = zvlc.TranHeaderID AND zvlc.BetStateTypeID = 'VB06'  
 WHERE zv.ValidationTypeID IN ('VALD', 'RFND') --(1)  
 GROUP BY zv.TicketSerialNumber, zv.WinningAmount, zv.RefundAmount, zv.RebateReclaim
 
 ;

create index idx_ubt_resultvalidation_ticket on ubt_temp_resultvalidation(TicketSerialNumber);
 ---------------------------------------------------------  
--VALIDATION EXCHANGE TICKET  
---------------------------------------------------------  
  
create temporary table if not exists ubt_temp_resultvalidationexchange
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
WinningAmount numeric(22,2), 
RefundAmount numeric(22,2),  
RebateReclaim numeric(22,2) 
)  
;
 
INSERT INTO ubt_temp_resultvalidationexchange  
select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_4d_placedbettransactionlineitem zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=2 And PBT.IsExchangeTicket= true

union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=3 And PBT.IsExchangeTicket= TRUE
   
union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=4 And PBT.IsExchangeTicket= TRUE

;

create index idx_ubt_resultvalidationexc_ticket on ubt_temp_resultvalidationexchange(TicketSerialNumber);
create index idx_ubt_resultvalidationexc_tranlinetiemid on ubt_temp_resultvalidationexchange(TranLineItemID);
---------------------------------------------------------  
--FINAL RESULT  
---------------------------------------------------------  

--HORSE RACING(1), lOTEERY(2,3,4), SPORTS(5,6)
 INSERT INTO ubt_temp_transactionamount  
SELECT W.TicketSerialNumber, W.TranLineItemID, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (2, 3, 4)
GROUP BY W.TicketSerialNumber, W.TranLineItemID  

union all
SELECT W.TicketSerialNumber, null, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber --AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber --AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (1, 5,6)
GROUP BY W.TicketSerialNumber  


union all 

select TicketSerialNumber, TranLineItemID, 0 AS Wager, 0 AS SecondWager, 0 AS Sales, 0 AS SecondSales, 
0 AS SalesCom, 0 AS SecondSalesCom, 0 AS GST, 0 AS SecondGST, WinningAmount, WinningAmount, RefundAmount, RebateReclaim  
FROM ubt_temp_resultvalidationexchange 

;

create index idx_ubt_transactionamt_ticket on ubt_temp_transactionamount(TicketSerialNumber);
create index idx_ubt_transactionamt_tranlineitemid on ubt_temp_transactionamount(TranLineItemID);

create temporary table if not exists ubt_temp_transactiondata
(
		--transid bigint  ,--primary key clustered,
		uuid varchar(33) ,
		transactiontype int4 ,
		productid int4 ,
		bettypeid varchar(2) ,
		selection text ,
		businessdate date ,
		transactiontimestamp timestamp ,
		terminalid varchar(100) ,
		userid varchar(100) ,
		locationid varchar(200) ,
		cartid varchar(50) ,
		tranheaderid varchar(50) ,
		boardseqnumber varchar(50) ,
		entrymethod int4 ,
		numboards int4 ,
		numdraws int ,
		drawid varchar(500) ,
		ebetslipinfo_mobnbr varchar(100) ,
		numsimplebets int4 ,
		qpflag int4 ,
		nummarks int4 ,
		bulkid varchar(50) ,
		itoto_numparts text ,
		itoto_totalparts text ,
		grptoto_numparts text ,
		eventid varchar(500) ,
		leaguecode varchar(500) ,
		liveindicator char(1) ,
		eventname text ,
		market text ,
		odds varchar(500) ,
		matchkickoff varchar(500) ,
		wager1 numeric(22, 2) ,
		wager2 numeric(22, 2) ,
		sales1 numeric(22, 11) ,
		sales2 numeric(22, 11) ,
		salescomm1 numeric(22, 11) ,
		salescomm2 numeric(22, 11) ,
		gst1 numeric(22, 11) ,
		gst2 numeric(22, 11) ,
		returnamount numeric(22, 2) ,
		winningamount numeric(22, 2) ,
		betlinerebateamount numeric(22, 2) ,
		paymentmode varchar(2) 
	)
;
create temporary table if not exists ubt_temp_final_lotteryselect
(  
	ticketserialnumber varchar(500),  
	tranlineitemid varchar(50),  
	selection text
)   
;
 --HORSE RACING  

INSERT INTO ubt_temp_final_lotteryselect  
SELECT PBT.TicketSerialNumber, NULL AS TranLineItemID,   
 string_agg(CAST(PL.BetLineAnnotation AS VARCHAR)  ,',') AS BetLineAnnotation 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN public.ztubt_horse_placedbettransactionlineitem PL ON PBT.TranHeaderID = PL.TranHeaderID  
 WHERE  PBT.ProdID=1 and 
 ((PL.CreatedDate >= StartDateUTC And PL.CreatedDate <=EndDateUTC
 And PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY PBT.TicketSerialNumber, PBT.TranHeaderID

--4D
 union all 
 
 select TicketSerialNumber, TranLineItemID, (pbtln.SelectedBetNumber :: varchar(10))   
from ubt_temp_placebettransaction_type PBT   
inner join public.ztubt_4d_placedbettransactionlineitemnumber  pbtln on PBT.TranHeaderID = pbtln.TranHeaderID
WHERE PBT.ProdID = 2 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))


union all 
--toto
select TicketSerialNumber, pbtln.TranLineItemID, string_agg((ztp.singleBetNumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT  
inner join public.ztubt_toto_placedbettransactionlineitem   pbtln on PBT.TranHeaderID = pbtln.TranHeaderID  
inner join public.ztubt_toto_placedbettransactionlineitemnumber ztp on pbtln.tranlineitemid =ztp.tranlineitemid 
WHERE PBT.ProdID = 3 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID

--sweep
union all 

select TicketSerialNumber, pbtln.TranLineItemID, string_agg((pbtln.selectednumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT
inner join public.ztubt_sweep_placedbettransactionlineitemnumber  pbtln on pbtln.tranheaderid =PBT.tranheaderid 
WHERE PBT.ProdID = 4 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID


--sports

union all 

select pb.ticketserialnumber,   
 pln.tranlineitemid as tranlineitemid,  
 pln.selectionname as selection  
 from ubt_temp_placebettransaction_type ph   
 inner join public.ztubt_sports_placedbettransactionlineitemnumber  pln  on ph.tranheaderid = pln.tranheaderid
 inner join ubt_temp_placebettransaction_type pb on ph.ticketserialnumber = pb.ticketserialnumber --(2)  
 where pb.prodid in (5, 6)
 group by pb.ticketserialnumber, pln.tranlineitemid, pln.selectionname

;
 
create index idx_ubt_lotteryselect_ticket on ubt_temp_final_lotteryselect(ticketserialnumber);
create index idx_ubt_lotteryselect_tranlineitemid on ubt_temp_final_lotteryselect(tranlineitemid);
 --=====================================================================================  
---Transaction Data Interface table-----------------------------------------------------
 --=====================================================================================
 --LOTTERY (Per UUID and boards under one TSN)  
 insert into ubt_temp_transactiondata  
 select  
 t.LocID,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid,  s.selection as selection,  
 case when t.transactiondate < igt_startdate then igt_previousbusinessdate 
 when t.transactiondate > igt_enddate then igt_nextbusinessdate
 else igt_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid, t.locationid, t.cartid, t.tranheaderid,  
 -----lottery section  
 coalesce(concat(t.uuid , ' - ' ,right(concat('00' , cast (ld.boardseqnumber as varchar)),2)), t.uuid) as boardseqnumber,  
 ld.entrymethod,   ld.numboards, ld.numdraws, ld.drawid,ld.ebetslipinfo_mobnbr, ld.numsimplebets,ld.qpflag,
 ld.nummarks,   ld.bulkid,  ld.itoto_numparts,ld.itoto_totalparts, ld.grptoto_numparts,    

 -----sports section  
 null, null, null, null, null, null, null,

 -----value amount section  
 coalesce(amt.wager, 0) as wager,   
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then   amt.returnamount else 0  end as returnamount,
 case when transactiontype = 3 then   amt.winningamount else 0 end as winningamount,  
  null,
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_Temp_LotteryDetail ld on t.ticketserialnumber = ld.ticketserialnumber and bt.tranlineitemnumberid = ld.tranlineitemid   
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber and ld.tranlineitemid = s.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber and ld.tranlineitemid = amt.tranlineitemid  
 where t.prodid in (2,3,4) and bettypeid is not null and t.isbetrejectedbytrader = false
 and (t.transactiondate between startdate and enddate) 
  
 order by t.uuid  
 ; 
 insert into ubt_temp_transactiondata  
-- union all 
 
 --HORSE RACING (Per UUID)  

 select  
 t.LocID,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid, --(19) bt.bettypeid as bettypeid,  
 s.selection as selection,  
  case when t.transactiondate < bmcs_startdate then bmcs_previousbusinessdate
	  when t.transactiondate > bmcs_enddate then bmcs_nextbusinessdate
	  else bmcs_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,  t.userid,t.locationid,t.cartid, t.tranheaderid,
   
 -----lottery section  
 t.uuid as boardseqnumber,  
 case t.entrymethodid  
  WHEN 'MANUAL' THEN 0  
  WHEN 'BETSLIP' THEN 2  
  WHEN 'EDIT' THEN 10  
  WHEN 'EBETSLIP' THEN 16  
 end as entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
 
 -----sports section   
 null,null,null,null,null,null,null,
 
 -----value amount section   
 coalesce(amt.wager, 0) as wager,  
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then amt.returnamount else 0 end as returnamount,  
 case when transactiontype = 3 then amt.winningamount else 0 end as winningamount,
 case when t.transactiontype = 3 then amt.rebatereclaim else coalesce(hd.betlinerebateamount,0)   end as betlinerebateamount, 
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_temp_HorseDetail hd on t.ticketserialnumber = hd.ticketserialnumber
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber 
 where t.prodid = 1 and t.isbetrejectedbytrader = false and (t.transactiondate::timestamp between startdate and enddate)
 order by t.uuid  

 ; 
create index idx_ubt_transdata_uuid on  ubt_temp_transactiondata(uuid );
create index idx_ubt_transdata_productid  on  ubt_temp_transactiondata(productid );
create index idx_ubt_transdata_selection  on  ubt_temp_transactiondata(selection );
create index idx_ubt_transdata_businessdate  on  ubt_temp_transactiondata(businessdate );
create index idx_ubt_transdata_tranheaderid  on  ubt_temp_transactiondata(tranheaderid  );

--Interface table output-------
return query
	SELECT UUID ,
	TRANHEADERID,
	TRANSACTIONTYPE,
	PRODUCTID,
	BETTYPEID,
	SELECTION,
	BUSINESSDATE, 
	--TRANSACTIONTIMESTAMP,
	to_char(TRANSACTIONTIMESTAMP,'yyyy-MM-dd HH24:mi:ss') ::timestamp as TRANSACTIONTIMESTAMP, -- For FR include second 04 Apr 2022
	TERMINALID,
	USERID,
	LOCATIONID,
	BOARDSEQNUMBER,
	coalesce(ENTRYMETHOD,0),
	coalesce(NUMBOARDS,0),
	coalesce(NUMDRAWS,0),
	coalesce(DRAWID,''),
	coalesce(EBETSLIPINFO_MOBNBR,''),
	coalesce(NUMSIMPLEBETS,0),
	coalesce(QPFLAG,0),
	coalesce(NUMMARKS,0),
	coalesce(BULKID,'') ,
	coalesce(ITOTO_NUMPARTS,''),
	ITOTO_TOTALPARTS,
	GRPTOTO_NUMPARTS,
	EVENTID,
	LEAGUECODE, 
	LIVEINDICATOR,
	EVENTNAME,
	MARKET,
	ODDS,
	MATCHKICKOFF,
	WAGER1,
	WAGER2,
	SALES1,
	SALES2,
	SALESCOMM1,
	SALESCOMM2,
	GST1,
	coalesce(GST2,0),
	RETURNAMOUNT,
	WINNINGAMOUNT, 
	PAYMENTMODE, 
	CARTID ,
	coalesce(BETLINEREBATEAMOUNT,0)
			from ubt_temp_transactiondata
			where TransactionTimestamp >= StartDate
			and TransactionTimestamp <= EndDate
	 ;

drop table 	ubt_temp_placebettransaction_type;
drop table	ubt_temp_LotteryDraw;
drop table	ubt_temp_numdraws;
drop table	ubt_Temp_LotteryDetail;
drop table	ubt_temp_NumBoards;
drop table	ubt_temp_HorseDetail;
drop table	ubt_temp_TotoSeq;
drop table	ubt_Temp_TotoGroup;
drop table	ubt_temp_Liveindidcator;
drop table	ubt_temp_sportsdetail;
drop table	ubt_temp_placebettransaction;
drop table	ubt_temp_bettype;
drop table	ubt_temp_trans;
drop table	ubt_temp_transactionamount;
drop table	ubt_temp_resultwager;
drop table	ubt_temp_resultsalescomwithdate;
drop table	ubt_temp_resultsalesandcomm ;
drop table	ubt_temp_resultGST;
drop table	ubt_temp_resultvalidation;
drop table	ubt_temp_resultvalidationexchange;
drop table	ubt_temp_transactiondata;
drop table	ubt_temp_final_lotteryselect;

END;
$$;


ALTER FUNCTION public.sp_ubt_gettransactiondataforinterval_test(startdatetime timestamp without time zone, enddatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1177 (class 1255 OID 2359067)
-- Name: sp_ubt_gettransactiondataforinterval_test2025(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransactiondataforinterval_test2025(startdatetime timestamp without time zone, enddatetime timestamp without time zone) RETURNS TABLE(uuid character varying, tranheaderid character varying, transactiontype integer, productid integer, bettypeid character varying, selection text, businessdate date, transactiontimestamp timestamp without time zone, terminalid character varying, userid character varying, locationid character varying, boardseqnumber character varying, entrymethod integer, numboards integer, numdraws integer, drawid character varying, ebetslipinfo_mobnbr character varying, numsimplebets integer, qpflag integer, nummarks integer, bulkid character varying, itoto_numparts text, itoto_totalparts text, grptoto_numparts text, eventid character varying, leaguecode character varying, liveindicator character, eventname text, market text, odds character varying, matchkickoff character varying, wager1 numeric, wager2 numeric, sales1 numeric, sales2 numeric, salescomm1 numeric, salescomm2 numeric, gst1 numeric, gst2 numeric, returnamount numeric, winningamount numeric, paymentmode character varying, cartid character varying, betlinerebateamount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
declare
startdate TIMESTAMP;
enddate timestamp;
bmcs_startdate timestamp;
igt_startdate timestamp;
ob_startdate timestamp;
bmcs_enddate timestamp;
igt_enddate timestamp;
ob_enddate timestamp;
bmcs_currentbusinessdate date;
igt_currentbusinessdate date;
ob_currentbusinessdate date;
bmcs_nextbusinessdate date;
igt_nextbusinessdate date;
ob_nextbusinessdate date;
bmcs_previousbusinessdate date;
igt_previousbusinessdate date;
ob_previousbusinessdate date;
startdateUTC timestamp;
enddateUTC timestamp;
v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

BEGIN
	
	
select 
startdatetime ,
enddatetime ,

fromdatetimebmcs ,
fromdatetimeigt ,
fromdatetimeob ,

todatetimebmcs ,
todatetimeigt ,
todatetimeob ,

(fromdatetimebmcs  ::DATE) ,
(fromdatetimeigt  :: DATE) ,
(fromdatetimeob  :: DATE) ,

(fromdatetimebmcs  ::DATE) + interval '1 Day' ,
(fromdatetimeigt  :: DATE) + interval '1 Day' ,
(fromdatetimeob  :: DATE) + interval '1 Day' ,

(fromdatetimebmcs  ::DATE)- interval '1 Day'  ,
(fromdatetimeigt  :: DATE)- interval '1 Day' ,
(fromdatetimeob  :: DATE) - interval '1 Day' ,

(startdatetime - interval '8 hour')  ,
(enddatetime - interval '8 hour')  

into 

startdate ,
enddate ,

bmcs_startdate ,
igt_startdate ,
ob_startdate ,

bmcs_enddate ,
igt_enddate ,
ob_enddate ,

bmcs_currentbusinessdate ,
igt_currentbusinessdate ,
ob_currentbusinessdate ,

bmcs_nextbusinessdate ,
igt_nextbusinessdate ,
ob_nextbusinessdate ,

bmcs_previousbusinessdate ,
igt_previousbusinessdate ,
ob_previousbusinessdate ,

startdateUTC ,
enddateUTC 
from public.sp_ubt_getcommonubtdates(StartDatetime ,StartDatetime );





--ubt_temp_placebettransaction #PBVBCBT

 create temporary table if not exists ubt_temp_placebettransaction(  
  TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(10),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  CreatedDate timestamp,
  RequestID varchar(40),
  UserDisplayID varchar(40),
  CartID varchar(50),
  TransactionType int4
 );

 


insert INTO ubt_temp_placebettransaction(TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket,TerDisplayID,CreatedDate,RequestID,UserDisplayID,CartID,TransactionType)

 
 SELECT TicketSerialNumber, PB.TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket
 ,TerDisplayID,PB.CreatedDate,RequestID,UserDisplayID,CartID, 1  TransactionType
  FROM public.ztubt_placedbettransactionheader PB  
  INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate  PBLC ON PB.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'  
  WHERE
	(PB.CreatedDate >= startdateUTC And PB.CreatedDate <= enddateUTC)
	  
  Union 
  SELECT VB.TicketSerialNumber, VB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader
  ,PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,VB.UserDisplayID,VB.CartID, 3 TransactionType
  FROM public.ztubt_validatedbetticket  VB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON VB.TicketSerialNumber = PB.TicketSerialNumber  
  INNER JOIN public.ztubt_validatedbetticketlifecyclestate VBLC ON VB.TranHeaderID = VBLC.TranHeaderID AND VBLC.BetStateTypeID = 'VB06'  
  WHERE VB.ValidationTypeID IN ('VALD', 'RFND') 
  AND   (VB.CreatedValidationDate >= startdateUTC And VB.CreatedValidationDate <= enddateUTC)
  Union
  SELECT CB.TicketSerialNumber, CB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader,
 
   PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,CB.UserDisplayID,CB.CartID,5 TransactionType
  
  FROM public.ztubt_CancelledBetTicket CB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON CB.TicketSerialNumber = PB.TicketSerialNumber
  INNER JOIN public.ztubt_cancelledbetticketlifecyclestate  CBLC ON CBLC.TranHeaderID = PB.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'  
  WHERE (PB.IsBetRejectedByTrader ) = FALSE AND (CB.CancelledDate >= startdate And CB.CancelledDate <= enddate)
  ;

 create index idx_ubt_ticketserialnumber on ubt_temp_placebettransaction(TicketSerialNumber);
 create index idx_ubt_tranheaderid on ubt_temp_placebettransaction(TranHeaderID);
create index idx_ubt_prodid on ubt_temp_placebettransaction(prodid);
create index idx_ubt_CreatedDate on ubt_temp_placebettransaction(CreatedDate);
create index idx_ubt_TransactionType on ubt_temp_placebettransaction(TransactionType);
 
 create temporary table if not exists ubt_temp_placebettransaction_type
 (TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(50),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  TransactionTypeTotal int4)
  ;
 
 insert into ubt_temp_placebettransaction_type
 
  Select TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID,
   IsBetRejectedByTrader,IsExchangeTicket, TerDisplayID
  ,SUM(TransactionType) TransactionTypeTotal 
  from ubt_temp_placebettransaction
  Group By TicketSerialNumber, TranHeaderID, DeviceID, EntryMethodID, ProdID, 
  IsExchangeTicket, TerDisplayID, IsBetRejectedByTrader
  ;
 
 create index idx_ubt_transaction_type_ticketserialnumber on ubt_temp_placebettransaction_type(TicketSerialNumber);
create index idx_ubt_transaction_type_tranheaderid on ubt_temp_placebettransaction_type(TranHeaderID);
create index idx_ubt_transaction_type_prodid on ubt_temp_placebettransaction_type(ProdID);
create index idx_ubt_transaction_type_isbetrejectedbytrader on ubt_temp_placebettransaction_type(IsBetRejectedByTrader);
create index idx_ubt_transaction_type_isexchangeticket on ubt_temp_placebettransaction_type(IsExchangeTicket);
create index idx_ubt_transaction_type_terdisplayid on ubt_temp_placebettransaction_type(TerDisplayID);
create index idx_ubt_transaction_type_transactiontypetotal on ubt_temp_placebettransaction_type(TransactionTypeTotal);
  
  --ubt_temp_placebettransaction_type #PBDVBCBT
  
   -----------------------------------------------------------------  
 --BET TYPE 
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_bettype  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemnumberid varchar(50),  
  bettypeid varchar(2)
 )  
 ; 
  

  
 --4D  
 INSERT INTO ubt_temp_bettype  
 SELECT
 PBVBCBT.TicketSerialNumber,  
 PBTLI.TranLineItemID,  
 CASE  
  WHEN PBTLI.BetTypeID = 'ORD' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN '0'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '5'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '10'  
   END  
  WHEN PBTLI.BetTypeID = 'SYS' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN   
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '1'  
WHEN PBTLI.Permutation = 12 THEN '2'  
  WHEN PBTLI.Permutation = 4 THEN '3'  
  WHEN PBTLI.Permutation = 6 THEN '4'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '6'  
  WHEN PBTLI.Permutation = 12 THEN '7'  
  WHEN PBTLI.Permutation = 4 THEN '8'  
  WHEN PBTLI.Permutation = 6 THEN '9'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
   CASE  
  WHEN PBTLI.Permutation = 24 THEN '11'  
  WHEN PBTLI.Permutation = 12 THEN '12'  
  WHEN PBTLI.Permutation = 4 THEN '13'  
  WHEN PBTLI.Permutation = 6 THEN '14'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'IBET' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '27'  
  WHEN PBTLI.Permutation = 12 THEN '28'  
  WHEN PBTLI.Permutation = 4 THEN '29'  
  WHEN PBTLI.Permutation = 6 THEN '30'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '31'  
  WHEN PBTLI.Permutation = 12 THEN '32'  
  WHEN PBTLI.Permutation = 4 THEN '33'  
  WHEN PBTLI.Permutation = 6 THEN '34'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '35'  
  WHEN PBTLI.Permutation = 12 THEN '36'  
  WHEN PBTLI.Permutation = 4 THEN '37'  
  WHEN PBTLI.Permutation = 6 THEN '38'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'ROLL' THEN  
   CASE  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '15'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber)= 2 THEN '16'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '17'  
  ELSE '18'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN 
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '19'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '20'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '21'  
  ELSE '22'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '23'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '24'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '25'  
  ELSE '26'  
 END  
   END  
 END AS BetTypeID  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitem   PBTLI ON PBVBCBT.TranHeaderID = PBTLI.TranHeaderID  
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON PBTLI.TranLineItemID = PBTLIN.TranLineItemID  
 WHERE PBVBCBT.ProdId = 2
 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0
and 
 ((PBTLIN.CreatedDate >= startdateUTC And PBTLIN.CreatedDate <= enddateUTC 
 and  PBVBCBT.TransactionTypeTotal In (1, 4, 6))	or  PBVBCBT.TransactionTypeTotal In (3,5))


 union all 
----TOTO

 
 select
 pbt.ticketserialnumber,   
 pbtli.tranlineitemid,  
 case pbtli.bettypeid   
  WHEN 'ORD'   THEN '0'  
  WHEN 'SYSR'  THEN '1'  
  WHEN 'SYS7'  THEN '2'  
  WHEN 'SYS8'  THEN '3'  
  WHEN 'SYS9'  THEN '4'  
  WHEN 'SYS10' THEN '5'  
  WHEN 'SYS11' THEN '6'  
  WHEN 'SYS12' THEN '7'  
  --totomatch
  WHEN 'M 4'  THEN '16'  
  WHEN 'M 3' THEN '17'  
  WHEN 'M 2' THEN '18'  
  WHEN 'M AN' THEN '19'  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_toto_placedbettransactionlineitem pbtli  on pbt.tranheaderid = pbtli.tranheaderid  
 where pbt.prodid = 3 and  
  ((pbtli.createddate >= startdateutc and pbtli.createddate <= enddateutc and  
  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))
 
 union all
 
 ---SWEEP

 select
 pbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 '0' as bettypeid   
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_sweep_placedbettransactionlineitemnumber pbtlin on pbt.tranheaderid = pbtlin.tranheaderid  
 where   pbt.prodid = 4
 and issoldout  <> true and 
 ((pbtlin.createddate >= startdateutc and pbtlin.createddate <= enddateutc
 and  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))

 --SPORT
 union all
 select
 pbvbcbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 case scat.categoryid when 1 
 then 
 case pbtli.accumulatorid   
  WHEN 'ACC4' THEN '4F'  
  WHEN 'DBL' THEN 'D'  
  WHEN 'SGL' THEN 'S'  
  WHEN 'TBL' THEN 'T'  
  END 
 WHEN 2 THEN 'S'
  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbvbcbt 
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on pbvbcbt.tranheaderid = pbtli.tranheaderid  
 inner  join public.ztubt_sports_placedbettransactionlineitemnumber  pbtlin on pbtli.tranlineitemid = pbtlin.tranlineitemid 
 inner join public.ztubt_sportevent se on pbtlin.eventid = se.eventid  
 inner join public.ztubt_sporttype st on se.typeid = st.typeid  
 inner join public.ztubt_sportclass sc on st.classid = sc.classid  
 inner join public.ztubt_sportcategory scat on sc.categoryid = scat.categoryid 
 where (scat.categoryid= 1)  or (scat.categoryid=2 and pbvbcbt.prodid in (5,6) )
 
 group by pbvbcbt.ticketserialnumber,pbtlin.tranlineitemid, scat.categoryid,pbtli.accumulatorid 
 ;
 
create index  ind_ticketsrno on ubt_temp_bettype(ticketserialnumber);
 -----------------------------------------------------------------  
 --DETAIL OF HORSE  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_horsedetail  
 (  
  ticketserialnumber varchar(500),  
  entrymethod int4,  
  betlinerebateamount numeric(22,2) 
 )  
 ;

 insert into ubt_temp_horsedetail
 
 
 SELECT ADP.TicketSerialNumber,
  CASE ADP.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 SUM(ADP.Amount) AS BetLineRebateAmount  
 FROM  
 (  
  SELECT   PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, EntryMethodID,  
  CASE WHEN BetTypeID = 'W-P'  
THEN (coalesce(PBTL.BoardRebateAmount,0))  
   ELSE SUM(coalesce(PBTL.BoardRebateAmount,0))   
  END AS Amount
  
  FROM ubt_temp_placebettransaction_type PBVBCBT 
  INNER JOIN   public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCBT.TranHeaderID = PBTL.TranHeaderID  
	WHERE  PBVBCBT.ProdID = 1 and 
	((PBTL.CreatedDate >= startdateUTC And PBTL.CreatedDate <= enddateUTC 	
AND PBVBCBT.TransactionTypeTotal In (1, 4, 6) ) or PBVBCBT.TransactionTypeTotal in (3,5))
  GROUP BY  PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BoardRebateAmount, EntryMethodID
 )ADP  
 GROUP BY ADP.TicketSerialNumber, ADP.EntryMethodID
 ;
 
create index idx_ubt_horse_ticketsrno on ubt_temp_horsedetail(TicketSerialNumber);
 -----------------------------------------------------------------  
 --DETAIL OF LOTTERY  
 -----------------------------------------------------------------  
  
 create temporary table if not exists ubt_temp_numboards  
 (  
  ticketserialnumber varchar(500),  
  numboards int4,  
  bulkid varchar(50)
 ) ; 
  
 INSERT INTO ubt_temp_NumBoards  
 --4D
 SELECT DISTINCT PBT.TicketSerialNumber,   
 COUNT(z4dln.TranLineItemID) AS NumBoards,  
 NULL AS BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN   public.ztubt_4d_placedbettransactionlineitemnumber  z4dln ON PBT.TranHeaderID = z4dln.TranHeaderID  
 WHERE PBT.ProdID = 2 and  coalesce(z4dln.BigBetAcceptedWager, 0) + coalesce(z4dln.SmallBetAcceptedWager, 0) > 0 AND
 ((z4dln.CreatedDate >= StartDateUTC And z4dln.CreatedDate <= EndDateUTC  
  AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 
 GROUP BY PBT.TicketSerialNumber 
 
 
 union all 
 --TOTO
 
 select pbvbcbt.ticketserialnumber,   
 count(pbtl.tranlineitemid) as numboards,  
 null as bulkid  
 from ubt_temp_placebettransaction_type pbvbcbt   
 inner join  public.ztubt_toto_placedbettransactionlineitem  pbtl on pbvbcbt.tranheaderid = pbtl.tranheaderid  
 where   pbvbcbt.prodid = 3 and  
 ((pbtl.createddate >= startdateUTC and pbtl.createddate <= enddateUTC and
  pbvbcbt.transactiontypetotal in (1, 4, 6)) or pbvbcbt.transactiontypetotal in (3,5))
 group by pbvbcbt.ticketserialnumber  

 
 union  all 
 
 --SWEEP
 SELECT PBT.TicketSerialNumber,   
 COUNT(PLN.TranLineItemID) AS NumBoards,  
 BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitem  PL ON PBT.TranHeaderID = PL.TranHeaderID  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitemnumber  PLN ON PL.TranLineItemID = PLN.TranLineItemID  
 WHERE  PBT.ProdID = 4 AND IsSoldOut <> true and
 ((PLN.CreatedDate >= StartDateUTC And PLN.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  
 GROUP BY PBT.TicketSerialNumber, BulkID 
 
 ;
create index idx_ubt_numboard_ticketsrno on ubt_temp_numboards (TicketSerialNumber);

create temporary table ubt_temp_LotteryDraw
( TicketSerialNumber varchar (200),
HostDrawDatesId varchar(20)
)
 ;
	insert into ubt_temp_LotteryDraw
Select PBTT.TicketSerialNumber, CAST(zdm.HostDrawDatesId AS VARCHAR) HostDrawDatesId

	FROM ubt_temp_placebettransaction_type PBTT  
	INNER JOIN public.ztubt_drawdates zdm  ON PBTT.TranHeaderID = zdm.TranHeaderID   
	Where  PBTT.ProdID In (2,3,4) 

;	
create index idx_ubt_lotterydraws_ticketsrno on ubt_temp_LotteryDraw (TicketSerialNumber,HostDrawDatesId);

create temporary table ubt_temp_numdraws
( TicketSerialNumber varchar (200),
NumDraws int4,
Drawid varchar(50)
)
 ;
	insert into ubt_temp_numdraws
	SELECT
	LD.TicketSerialNumber,
	Count(1) NumDraws,
	string_agg(CAST(LD.HostDrawDatesId AS varchar),',' ) as Drawid

	From ubt_temp_LotteryDraw LD 
	Group By LD.TicketSerialNumber

;
	
create index idx_ubt_numdraws_ticketsrno on ubt_temp_numdraws (TicketSerialNumber);

 create temporary table if not exists ubt_temp_lotterydetail  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemid varchar(50),  
  boardseqnumber int,  
  entrymethod int,  
  numboards int,  
  numdraws int,  
  drawid varchar(500),  
  ebetslipinfo_mobnbr varchar(100),  
  numsimplebets int4,  
  qpflag int4,  
  nummarks int4,  
  bulkid varchar(50), --(5)  
  itoto_numparts text, -- varchar(max)  
  itoto_totalparts text,   --varchar(max)
  grptoto_numparts text   --varchar(max)
 )  
  
 ;
 create temporary table if not exists ubt_temp_TotoSeq (  
  TranLineItemID varchar(50),  
  Seq INT4  
 )  
  ;
 create temporary table if not exists ubt_Temp_TotoGroup ( 
  GroupHostID varchar(50),  
  GroupToto INT4 
 ) ; 
  
 INSERT INTO ubt_temp_TotoSeq  
 SELECT LIN.TranLineItemID, MAX(LIN.Sequence) AS Seq  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join  public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitemnumber  LIN on LI.TranLineItemID = LIN.TranLineItemID
 WHERE PBT.ProdID = 3 and 
 ((LI.CreatedDate >= StartDateUTC And LI.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY LIN.TranLineItemID  
 ;
 
 INSERT INTO ubt_Temp_TotoGroup 
 SELECT LI2.GroupHostID, MAX(LI2.GroupUnitSequence) AS GroupToto  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitem LI2 on LI.GroupHostID = LI2.GroupHostID
 WHERE PBT.ProdID = 3
 AND LI.GroupHostID <> '00000000-0000-0000-0000-000000000000' AND LI.GroupUnitSequence IS NOT NULL 
 GROUP BY LI2.GroupHostID
 
 ;
 --4D
 
 INSERT INTO ubt_Temp_LotteryDetail  
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
   PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
   PBVBCBT.TransactionTypeTotal In (1, 4, 6)  

union all 

 
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)

 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
 PBVBCBT.TransactionTypeTotal in (3,5)
  
union all
 
 --TOTO  
  
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE 
  WHEN TOTO.BetTypeID = ANY(v_totomatchBettypes) THEN 1
  WHEN TOTO.BetTypeID = 'ORD' THEN 1  
  WHEN TOTO.BetTypeID = 'SYSR' THEN 44  
  WHEN TOTO.BetTypeID = 'SYS7' THEN 7  
  WHEN TOTO.BetTypeID = 'SYS8' THEN 28  
  WHEN TOTO.BetTypeID = 'SYS9' THEN 84  
  WHEN TOTO.BetTypeID = 'SYS10' THEN 210  
  WHEN TOTO.BetTypeID = 'SYS11' THEN 462  
  WHEN TOTO.BetTypeID = 'SYS12' THEN 924 
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and 
 TOTO.CreatedDate >= StartDateUTC And TOTO.CreatedDate <= EndDateUTC   
 AND PBVBCBT.TransactionTypeTotal In (1, 4, 6)
 
 union all 
 
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE 
  WHEN TOTO.BetTypeID = ANY(v_totomatchBettypes) THEN 1
  WHEN TOTO.BetTypeID = 'ORD' THEN 1
  WHEN TOTO.BetTypeID = 'SYSR' THEN 44
  WHEN TOTO.BetTypeID = 'SYS7' THEN 7
  WHEN TOTO.BetTypeID = 'SYS8' THEN 28
  WHEN TOTO.BetTypeID = 'SYS9' THEN 84
  WHEN TOTO.BetTypeID = 'SYS10' THEN 210
  WHEN TOTO.BetTypeID = 'SYS11' THEN 462 
  WHEN TOTO.BetTypeID = 'SYS12' THEN 924
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and PBVBCBT.TransactionTypeTotal in (3,5)
 
 union all 
 
 --SWEEP
 
 SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and 
PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
  PBVBCBT.TransactionTypeTotal In (1, 4, 6)
  
  union all 
  
  SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and PBVBCBT.TransactionTypeTotal In (3,5)

;
 
create index idx_ubt_lotterydetail_ticketsrno  on ubt_Temp_LotteryDetail(TicketSerialNumber);
create index idx_ubt_lotterydetail_tranlineitemid  on ubt_Temp_LotteryDetail(TranLineItemID);
 -----------------------------------------------------------------  
 --DETAIL OF SPORTS  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_Liveindidcator  
 (  
  TicketSerialNumber VARCHAR(500),  
  LiveIndicator CHAR(1)  
 )  
  ;
 INSERT INTO ubt_temp_Liveindidcator  
 SELECT din.TicketSerialNumber,   
 CASE  
  WHEN (din.HasBetInRun = TRUE) AND (din.CreatedDate BETWEEN din.StartTime AND din.SuspendTime) THEN 'Y'  
  ELSE 'N'  
 END AS LiveIndicator  
 FROM  
 (  
  SELECT ROW_NUMBER() OVER (PARTITION BY SPBN.TranHeaderID 
  							ORDER BY SPBN.TranLineItemID
--		  					ORDER BY split_part(SPBN.tranlineitemid,'-',5)
--									,split_part(SPBN.tranlineitemid,'-',4)
--									,split_part(SPBN.tranlineitemid,'-',3)
--									,split_part(SPBN.tranlineitemid,'-',2)
--									,split_part(SPBN.tranlineitemid,'-',1)
  							) AS ROWNUM,
  PBVBCBT.TicketSerialNumber, SE.HasBetInRun, SE.StartTime, SE.SuspendTime, SPBN.CreatedDate  
  FROM ubt_temp_placebettransaction_type PBVBCBT
  INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  SPBN ON PBVBCBT.TranHeaderID = SPBN.TranHeaderID  
  INNER join public.ztubt_sportevent SE ON SPBN.EventID = SE.EventId  
  WHERE PBVBCBT.ProdID IN(5,6)
 )din  
 WHERE din.ROWNUM = 1  
;
create index idx_ubt_liveindicator_ticketsrno  on ubt_temp_Liveindidcator(TicketSerialNumber); 

 create temporary table if not exists ubt_temp_sportsdetail
 (  
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID Varchar(50),--(1)  
  EntryMethod INT4,  
  EventID VARCHAR(500),  
  LeagueCode VARCHAR(500),  
  LiveIndicator CHAR(1),  
  EventName text,  
  BetTypeName text,  
  Selection VARCHAR(500),  
  SelectionOdds VARCHAR(500),  
  StartTime VARCHAR(500),  
  BetType VARCHAR(500)
 )  
  ;
 INSERT INTO ubt_temp_sportsdetail  
 SELECT PBVBCBT.TicketSerialNumber,   
 PLN.TranLineItemID,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 PLN.EventID AS EventID,  
 SL.LeagueCode AS LeagueCode,  
 LI.LiveIndicator :: char AS LiveIndicator,  
 PLN.EventName AS EventName,  
 PLN.BetTypeName AS BetTypeName,  
 PLN.SelectionName AS Selection,  
 PLN.SelectionOdds AS SelectionOdds,  
 --to_char(SE.StartTime, 'yyyyMMdd HHmmss') AS StartTime, b.BetTypeID 
to_char(SE.StartTime, 'yyyyMMdd HH24miss') AS StartTime, b.BetTypeID 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  PLN ON PBVBCBT.TranHeaderID = PLN.TranHeaderID
 INNER JOIN public.ztubt_sportevent  SE ON PLN.EventID = SE.EventId  
 INNER JOIN public.ztubt_sporttype  ST ON SE.TypeId = ST.TypeId  
 INNER JOIN public.ztubt_sportleagueinfo  SL ON REPLACE(ST.Name, '|', '') = REPLACE(SL.Name, '|', '')  
 INNER JOIN ubt_temp_Liveindidcator LI ON PBVBCBT.TicketSerialNumber = LI.TicketSerialNumber  
 inner join ubt_temp_bettype b on b.TranLineItemNumberID = PLN.TranLineItemID  
 LEFT JOIN public.ztubt_entrymethod  EM ON PBVBCBT.EntryMethodID = EM.EntryMethodID  
 WHERE PBVBCBT.ProdID IN (5,6)  
 GROUP BY PBVBCBT.TicketSerialNumber, PLN.TranLineItemID, PBVBCBT.EntryMethodID, PLN.EventID, SL.LeagueCode, 
 LI.LiveIndicator, PLN.EventName, PLN.BetTypeName, PLN.SelectionOdds, SE.StartTime,  b.BetTypeID, PLN.SelectionName  
 ;

create index idx_ubt_sportdetail_ on ubt_temp_sportsdetail(TicketSerialNumber,TranLineItemID);
 
  
 -------------------------------------------------------------------------  
 --GET TRANSACTION (COLLECTION, VALIDATION, CANCELLATION) PER AD HOC TIME  
 -------------------------------------------------------------------------  
 create temporary table if not exists ubt_temp_trans  
 (  
  EntryMethodID VARCHAR(10),  --(S5)
  ProdID int4,  --(S5)
  IsBetRejectedByTrader bool, --(S5)
  TicketSerialNumber VARCHAR(200),  
  UUID VARCHAR(33),  
  TransactionType INT4,  
  TransactionDate timestamp,  
  TerminalID VARCHAR(100),  
  UserID VARCHAR(100),  
  LocationID VARCHAR(200),  
  CartID varchar(50),  
  TranHeaderID varchar(50)
 )  
   ;
-------COLLECTION--------------
   
 --HORSE RACING  
  INSERT INTO ubt_temp_trans  
  SELECT  
  PB.EntryMethodID, 
  PB.ProdID,  --(S5)
  PB.IsBetRejectedByTrader , --(S5)
  PB.TicketSerialNumber AS TSN,  
  PB.RequestID AS UUID,  
  1 AS TransactionType, --Wager  
  ( PB.CreatedDate + interval '8 hour'),  
 PB.TerDisplayID AS TerminalID,  PB.UserDisplayID AS UserID,  L.LocDisplayID AS LocationID,  
  PB.CartID,  
  PB.TranHeaderID  
  FROM ubt_temp_placebettransaction PB  
  INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.terdisplayid  
  LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
  WHERE PB.ProdID  in (1, 2, 3, 4, 5, 6) and  
   PB.TransactionType = 1 
 AND  (PB.CreatedDate >= StartDateUTC And PB.CreatedDate <= EndDateUTC) 
 
  --ProdID = 1 --HORSE RACING
  --ProdId=2,3,4 Lottery
  --prodid=5,6 sports
  
  ------------VALIDATION -----------
  
  
  
union all 
--Horse Racing

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID = 1 
 AND (coalesce (zv.WinningAmount,0) > 0 OR coalesce (zv.RebateReclaim,0) > 0) 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 --Lottery(prod id (2,3,4)  & Sports prodid (5,6)
 union all 
 

 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 zv.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (2,3,4)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 union all 
 
 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' -- Issue:Fixed on 20220221 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 
 
union all 
--refund

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 61 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (1,2,3,4,5, 6) -- LA: add refund hr, lottery: 1,2,3,4 
 AND  zv.ValidationTypeID = 'RFND' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
---- ----CANCELLATION-------------------
 union all
 --Horse racing prodid (1) & Lottery prodid (2,3,4)
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID =1 --HORSE RACING  
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 

 union all 
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 cbt.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (2,3,4)  -- Lottery
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
union all
 --Sports
 
  SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)   --SPORTS
 AND PB.TransactionType = 5 
 AND PB.IsBetRejectedByTrader = false 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
 ;

create index idx_ubt_trans_ticketserialnumber on ubt_temp_trans(TicketSerialNumber);
create index idx_ubt_trans_tranheaderid on ubt_temp_trans(TranHeaderID);
  --FINAL RESULT OF TRANSACTIONAL VIEW  
 -----------------------------------------------------------------  
  
  
 create temporary table if not exists ubt_temp_transactionamount(
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID varchar(50),  
  Wager numeric(22,2), 
  SecondWager numeric(22,2), 
  Sales numeric(22, 11),  
  SecondSales numeric(22, 11),  
  SalesComm numeric(22, 11),  
  SecondSalesComm numeric(22, 11),  
  GST numeric(22, 11),  
  SecondGST numeric(22, 11),  
  ReturnAmount  numeric(22,2),  
  WinningAmount  numeric(22,2),  
  RefundAmount  numeric(22,2),  
  RebateReclaim  numeric(22,2)
 )  
  
 ;
 --COLLECTION 
 
 
 create temporary table if not exists ubt_temp_resultwager  
(  
ProdID int4,
 TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
 Wager numeric(22,2), 
 SecondWager numeric(22,2)
)  
;
 insert into ubt_temp_resultwager
 select 1::int4 ProdID, amtw.TicketSerialNumber, null , SUM(amtw.Amount) AS Wager, 0 AS SecondWager  
 FROM  
(  
SELECT   PBVBCB.TicketSerialNumber, PBTL.TranHeaderID,  
CASE WHEN BetTypeID = 'W-P' 
THEN (coalesce (PBTL.BetPriceAmount,0))  
ELSE SUM(coalesce (PBTL.BetPriceAmount,0))   
END AS Amount,  
COUNT(DISTINCT PBVBCB.TicketSerialNumber) Ct, 'COL' AS Flag,'CH' AS TransType  
FROM  
ubt_temp_placebettransaction_type PBVBCB 
INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCB.TranHeaderID = PBTL.TranHeaderID 
WHERE PBVBCB.ProdID = 1
and ((PBTL.CreatedDate >= StartDateUTC And PBTL.CreatedDate <= EndDateUTC
AND PBVBCB.TransactionTypeTotal In (1, 4, 6) ) or PBVBCB.TransactionTypeTotal in (3,5))

GROUP BY  PBVBCB.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BetPriceAmount 	
)amtw  
GROUP BY amtw.TicketSerialNumber

union all 

--4D

SELECT  2::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BigBetAcceptedWager,0)) AS Wager, SUM(coalesce (zdp.SmallBetAcceptedWager,0)) AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  
INNER JOIN public.ztubt_drawdates zd   ON zd.TranHeaderID = zdp.TranHeaderID   
WHERE  PBT.ProdID = 2 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >=StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID  


union all 
--toto

SELECT  3::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BetPriceAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  

WHERE  PBT.ProdID = 3 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 

--sweep

SELECT   4::int4 ProdID, PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.BetPriceAmount,0)) AS Wager, 0 AS SecondWager 
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = False  
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zplc   ON zplc.TranHeaderID = PBT.TranHeaderID  
INNER JOIN (select terdisplayid,Locid from public.ztubt_terminal ) Ter  ON PBT.TerDisplayID = Ter.TerDisplayID
INNER JOIN (Select * from  public.ztubt_location) Loc  ON Ter.LocID = Loc.LocID
WHERE ( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zplc.BetStateTypeID = 'PB06' ) 	
		OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zplc.BetStateTypeID = 'PB03' ) )
AND PBT.ProdID=4
AND ((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 

--sports

SELECT   FIN.ProdID ProdID, FIN.TicketSerialNumber, NULL, SUM(coalesce (FIN.BetAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
(  
select PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, BetAmount, TicketSerialNumber  
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sports_placedbettransactionlineitem zsp  ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE   
PBT.ProdID IN (5, 6) AND PBT.IsBetRejectedByTrader != TRUE 
GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet, AccumulatorID, BetAmount, TicketSerialNumber  
)FIN  
GROUP BY FIN.TicketSerialNumber, FIN.ProdID 
;

create index idx_ubt_resultwager_TicketSerialNumber  on ubt_temp_resultwager(TicketSerialNumber);
create index idx_ubt_resultwager_tranlineitemid  on ubt_temp_resultwager(TranLineItemID);

--For Sales Comm, Sales Factor and Output GST  
create temporary table if not exists ubt_temp_resultsalescomwithdate  
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 SalesCommAmount numeric(32, 12),  
 SalesFactorAmount numeric(32, 12),  
 SecondSalesCommAmount numeric(32, 12),  
 SecondSalesFactorAmount numeric(32, 12),  
 GSTRate numeric(10, 2)
)  ;
  
--Toto

insert into ubt_temp_resultsalescomwithdate
select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmount,0)) SalesCommAmount,
SUM(coalesce (zdp.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
	ubt_temp_placebettransaction_type PBT  
	Inner jOin public.ztubt_toto_placedbettransactionlineitem  zdp   ON PBT.TranHeaderID = zdp.TranHeaderID
WHERE  PBT.ProdID = 3 
AND PBT.IsExchangeTicket = FALSE  
AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <=EndDateUTC
AND  PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 
--horse

SELECT amt.TicketSerialNumber, NULL  , SUM(amt.SalesCommAmount) , SUM(amt.SalesFactorAmount)  , 0 , 0  
FROM  
(  
 SELECT   PBT.TicketSerialNumber, zhp.TranHeaderID,  
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesCommAmount,0))  
  ELSE SUM(coalesce (zhp.SalesCommAmount,0))   
 END AS SalesCommAmount,   
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesFactorAmount,0))  
  ELSE SUM(coalesce (zhp.SalesFactorAmount,0))   
 END AS SalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT  
	 INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  zhp ON PBT.TranHeaderID = zhp.TranHeaderID  
	 INNER JOIN (select Terdisplayid,LocID from public.ztubt_terminal zt) Ter ON PBT.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0   
	 where PBT.ProdID = 1 and 
	 (
	 	(zhp.CreatedDate >= StartDateUTC 
	 	 And zhp.CreatedDate <= EndDateUTC
	  	 AND PBT.TransactionTypeTotal In (1, 4, 6)) 
	  or 
	  	(PBT.TransactionTypeTotal In (3, 5))
	 )  
 GROUP BY PBT.TicketSerialNumber, zhp.TranHeaderID, zhp.CreatedDate::Date
 , BetTypeID, SalesCommAmount, SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber


union all 

--4D

select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmountBig,0)) SalesCommAmount, 
 SUM(coalesce (zdp.SalesFactorAmountBig,0)) SalesFactorAmount, SUM(coalesce (zdp.SalesCommAmountSmall,0)) SecondSalesCommAmount
, SUM(coalesce (zdp.SalesFactorAmountSmall,0)) SecondSalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT   
	 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber zdp   ON zdp.TranHeaderID = PBT.TranHeaderID  
	 INNER JOIN  public.ztubt_drawdates zd ON zd.TranHeaderID = PBT.TranHeaderID --(7)  
 where PBT.ProdID = 2 and 
  ((zdp.CreatedDate >= StartDateUTC  And zdp.CreatedDate <=EndDateUTC
   AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  AND PBT.IsExchangeTicket = false 
 GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID

union all 

--sweeep

SELECT  PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (zspn.SalesFactorAmount,0)) SalesFactorAmount, 0, 0  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = FALSE 
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zpls   ON zpls.TranHeaderID = PBT.TranHeaderID 
 INNER JOIN (Select terdisplayid, Locid from public.ztubt_terminal ) Ter ON PBT.TerDisplayID = Ter.TerDisplayID 
 INNER JOIN (Select locid,locdisplayid,sweepindicator from public.ztubt_location ) Loc ON Ter.LocID = Loc.LocID 
WHERE PBT.ProdID=4  and 
( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zpls.BetStateTypeID = 'PB06' ) 	
	OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zpls.BetStateTypeID = 'PB03' ) )
and
((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC

	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	
GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 
--Sports

select amt.TicketSerialNumber, NULL , SUM(coalesce (amt.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (amt.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
(  
 SELECT PBT.ProdID ProductName, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, SalesCommAmount, TicketSerialNumber, SalesFactorAmount  
 FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN  public.ztubt_sports_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE PBT.ProdID IN (5,6)
 AND
 PBT.IsBetRejectedByTrader=false 
 GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,
 AccumulatorID, SalesCommAmount, TicketSerialNumber, (zsp.CreatedDate :: date), SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber
;

create index idx_ubt_resulsalescomwithdate_ticket on ubt_temp_resultsalescomwithdate(TicketSerialNumber);
create index idx_ubt_resulsalescomwithdate_tranlineitemid on ubt_temp_resultsalescomwithdate(TranLineItemID);


 create temporary table if not exists ubt_temp_resultsalesandcomm   
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 Sales numeric(32, 12),  
 SecondSales numeric(32, 12),
 SalesComm numeric(22, 11),  
 SecondSalesComm numeric(22, 11)
)  
  ;
INSERT INTO ubt_temp_resultsalesandcomm  
SELECT FIN.TicketSerialNumber, FIN.TranLineItemID, SUM(FIN.SalesFactorAmount), 
SUM(FIN.SecondSalesFactorAmount), SUM(FIN.SalesCommAmount), SUM(FIN.SecondSalesCommAmount)  
FROM ubt_temp_resultsalescomwithdate FIN  
GROUP BY FIN.TicketSerialNumber, FIN.TranLineItemID  

;

create index idx_ubt_resulsalescom_ticket on ubt_temp_resultsalesandcomm(TicketSerialNumber);
create index idx_ubt_resulsalescom_tranlineitemid on ubt_temp_resultsalesandcomm(TranLineItemID);

---------------------------------------------------------  
--GST (OUTPUT GST = WAGER - SALES)  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultGST   
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
GST numeric(22, 11),  
SecondGST numeric(22, 11)
) ; 
   
--LOTTERY(2,3,4) and Horse(1) and Sports(5,6)

INSERT INTO ubt_temp_resultGST   
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber AND w.TranLineItemID = S.TranLineItemID  
WHERE w.ProdID IN (2, 3, 4) 
union all 
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber 
WHERE w.ProdID IN (1,5,6) 

;

create index idx_ubt_resultGST_ticket on ubt_temp_resultGST(TicketSerialNumber);
create index idx_ubt_resultGST_tranlineitemid on ubt_temp_resultGST(TranLineItemID);

---------------------------------------------------------  
--VALIDATION  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultvalidation 
(   
TicketSerialNumber VARCHAR(200),  
ReturnAmount numeric(22,2), 
WinningAmount numeric(22,2),
RefundAmount numeric(22,2), 
RebateReclaim numeric(22,2) 
)  
  
;
INSERT INTO ubt_temp_resultvalidation  
SELECT zv.TicketSerialNumber,   
zv.WinningAmount AS ReturnAmount,  
CASE WHEN coalesce(zv.WinningAmount, 0) > 0 THEN  
zv.WinningAmount - (SUM(RW.Wager)/coalesce (COUNT(RW.TicketSerialNumber),1)) - (SUM(RW.SecondWager)/coalesce(COUNT(RW.TicketSerialNumber),1)) --(6) 
ELSE  0
  
END AS WinningAmount, --(4)  
zv.RefundAmount, zv.RebateReclaim --(1)  
FROM ubt_temp_resultwager RW  
 INNER join public.ztubt_validatedbetticket zv   ON RW.TicketSerialNumber = zv.TicketSerialNumber  
 INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvlc   ON zv.TranHeaderID = zvlc.TranHeaderID AND zvlc.BetStateTypeID = 'VB06'  
 WHERE zv.ValidationTypeID IN ('VALD', 'RFND') --(1)  
 GROUP BY zv.TicketSerialNumber, zv.WinningAmount, zv.RefundAmount, zv.RebateReclaim
 
 ;

create index idx_ubt_resultvalidation_ticket on ubt_temp_resultvalidation(TicketSerialNumber);
 ---------------------------------------------------------  
--VALIDATION EXCHANGE TICKET  
---------------------------------------------------------  
  
create temporary table if not exists ubt_temp_resultvalidationexchange
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
WinningAmount numeric(22,2), 
RefundAmount numeric(22,2),  
RebateReclaim numeric(22,2) 
)  
;
 
INSERT INTO ubt_temp_resultvalidationexchange  
select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_4d_placedbettransactionlineitem zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=2 And PBT.IsExchangeTicket= true

union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=3 And PBT.IsExchangeTicket= TRUE
   
union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=4 And PBT.IsExchangeTicket= TRUE

;

create index idx_ubt_resultvalidationexc_ticket on ubt_temp_resultvalidationexchange(TicketSerialNumber);
create index idx_ubt_resultvalidationexc_tranlinetiemid on ubt_temp_resultvalidationexchange(TranLineItemID);
---------------------------------------------------------  
--FINAL RESULT  
---------------------------------------------------------  

--HORSE RACING(1), lOTEERY(2,3,4), SPORTS(5,6)
 INSERT INTO ubt_temp_transactionamount  
SELECT W.TicketSerialNumber, W.TranLineItemID, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (2, 3, 4)
GROUP BY W.TicketSerialNumber, W.TranLineItemID  

union all
SELECT W.TicketSerialNumber, null, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber --AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber --AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (1, 5,6)
GROUP BY W.TicketSerialNumber  


union all 

select TicketSerialNumber, TranLineItemID, 0 AS Wager, 0 AS SecondWager, 0 AS Sales, 0 AS SecondSales, 
0 AS SalesCom, 0 AS SecondSalesCom, 0 AS GST, 0 AS SecondGST, WinningAmount, WinningAmount, RefundAmount, RebateReclaim  
FROM ubt_temp_resultvalidationexchange 

;

create index idx_ubt_transactionamt_ticket on ubt_temp_transactionamount(TicketSerialNumber);
create index idx_ubt_transactionamt_tranlineitemid on ubt_temp_transactionamount(TranLineItemID);

create temporary table if not exists ubt_temp_transactiondata
(
		--transid bigint  ,--primary key clustered,
		uuid varchar(33) ,
		transactiontype int4 ,
		productid int4 ,
		bettypeid varchar(2) ,
		selection text ,
		businessdate date ,
		transactiontimestamp timestamp ,
		terminalid varchar(100) ,
		userid varchar(100) ,
		locationid varchar(200) ,
		cartid varchar(50) ,
		tranheaderid varchar(50) ,
		boardseqnumber varchar(50) ,
		entrymethod int4 ,
		numboards int4 ,
		numdraws int ,
		drawid varchar(500) ,
		ebetslipinfo_mobnbr varchar(100) ,
		numsimplebets int4 ,
		qpflag int4 ,
		nummarks int4 ,
		bulkid varchar(50) ,
		itoto_numparts text ,
		itoto_totalparts text ,
		grptoto_numparts text ,
		eventid varchar(500) ,
		leaguecode varchar(500) ,
		liveindicator char(1) ,
		eventname text ,
		market text ,
		odds varchar(500) ,
		matchkickoff varchar(500) ,
		wager1 numeric(22, 2) ,
		wager2 numeric(22, 2) ,
		sales1 numeric(22, 11) ,
		sales2 numeric(22, 11) ,
		salescomm1 numeric(22, 11) ,
		salescomm2 numeric(22, 11) ,
		gst1 numeric(22, 11) ,
		gst2 numeric(22, 11) ,
		returnamount numeric(22, 2) ,
		winningamount numeric(22, 2) ,
		betlinerebateamount numeric(22, 2) ,
		paymentmode varchar(2) 
	)
;
create temporary table if not exists ubt_temp_final_lotteryselect
(  
	ticketserialnumber varchar(500),  
	tranlineitemid varchar(50),  
	selection text
)   
;
 --HORSE RACING  

INSERT INTO ubt_temp_final_lotteryselect  
SELECT PBT.TicketSerialNumber, NULL AS TranLineItemID,   
 string_agg(CAST(PL.BetLineAnnotation AS VARCHAR)  ,',') AS BetLineAnnotation 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN public.ztubt_horse_placedbettransactionlineitem PL ON PBT.TranHeaderID = PL.TranHeaderID  
 WHERE  PBT.ProdID=1 and 
 ((PL.CreatedDate >= StartDateUTC And PL.CreatedDate <=EndDateUTC
 And PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY PBT.TicketSerialNumber, PBT.TranHeaderID

--4D
 union all 
 
 select TicketSerialNumber, TranLineItemID, (pbtln.SelectedBetNumber :: varchar(10))   
from ubt_temp_placebettransaction_type PBT   
inner join public.ztubt_4d_placedbettransactionlineitemnumber  pbtln on PBT.TranHeaderID = pbtln.TranHeaderID
WHERE PBT.ProdID = 2 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))


union all 
--toto
select TicketSerialNumber, pbtln.TranLineItemID, string_agg((ztp.singleBetNumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT  
inner join public.ztubt_toto_placedbettransactionlineitem   pbtln on PBT.TranHeaderID = pbtln.TranHeaderID  
inner join public.ztubt_toto_placedbettransactionlineitemnumber ztp on pbtln.tranlineitemid =ztp.tranlineitemid 
WHERE PBT.ProdID = 3 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID

--sweep
union all 

select TicketSerialNumber, pbtln.TranLineItemID, string_agg((pbtln.selectednumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT
inner join public.ztubt_sweep_placedbettransactionlineitemnumber  pbtln on pbtln.tranheaderid =PBT.tranheaderid 
WHERE PBT.ProdID = 4 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID


--sports

union all 

select pb.ticketserialnumber,   
 pln.tranlineitemid as tranlineitemid,  
 pln.selectionname as selection  
 from ubt_temp_placebettransaction_type ph   
 inner join public.ztubt_sports_placedbettransactionlineitemnumber  pln  on ph.tranheaderid = pln.tranheaderid
 inner join ubt_temp_placebettransaction_type pb on ph.ticketserialnumber = pb.ticketserialnumber --(2)  
 where pb.prodid in (5, 6)
 group by pb.ticketserialnumber, pln.tranlineitemid, pln.selectionname

;
 
create index idx_ubt_lotteryselect_ticket on ubt_temp_final_lotteryselect(ticketserialnumber);
create index idx_ubt_lotteryselect_tranlineitemid on ubt_temp_final_lotteryselect(tranlineitemid);
 --=====================================================================================  
---Transaction Data Interface table-----------------------------------------------------
 --=====================================================================================
 
 --LOTTERY (Per UUID and boards under one TSN)  
 insert into ubt_temp_transactiondata  
 select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid,  s.selection as selection,  
 case when t.transactiondate < igt_startdate then igt_previousbusinessdate 
 when t.transactiondate > igt_enddate then igt_nextbusinessdate
 else igt_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid, t.locationid, t.cartid, t.tranheaderid,  
 -----lottery section  
 coalesce(concat(t.uuid , ' - ' ,right(concat('00' , cast (ld.boardseqnumber as varchar)),2)), t.uuid) as boardseqnumber,  
 ld.entrymethod,   ld.numboards, ld.numdraws, ld.drawid,ld.ebetslipinfo_mobnbr, ld.numsimplebets,ld.qpflag,
 ld.nummarks,   ld.bulkid,  ld.itoto_numparts,ld.itoto_totalparts, ld.grptoto_numparts,    

 -----sports section  
 null, null, null, null, null, null, null,

 -----value amount section  
 coalesce(amt.wager, 0) as wager,   
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then   amt.returnamount when transactiontype = 61 then amt.refundamount else 0  end as returnamount,-- LA add refund
 case when transactiontype = 3 then   amt.winningamount else 0 end as winningamount,  
  null,
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_Temp_LotteryDetail ld on t.ticketserialnumber = ld.ticketserialnumber and bt.tranlineitemnumberid = ld.tranlineitemid   
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber and ld.tranlineitemid = s.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber and ld.tranlineitemid = amt.tranlineitemid  
 where t.prodid in (2,3,4) and bettypeid is not null and t.isbetrejectedbytrader = false
 and (t.transactiondate between startdate and enddate) 
  
 order by t.uuid  
 ; 
 insert into ubt_temp_transactiondata  
-- union all 
 
 --HORSE RACING (Per UUID)  

 select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid, --(19) bt.bettypeid as bettypeid,  
 s.selection as selection,  
  case when t.transactiondate < bmcs_startdate then bmcs_previousbusinessdate
	  when t.transactiondate > bmcs_enddate then bmcs_nextbusinessdate
	  else bmcs_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,  t.userid,t.locationid,t.cartid, t.tranheaderid,
   
 -----lottery section  
 t.uuid as boardseqnumber,  
 case t.entrymethodid  
  WHEN 'MANUAL' THEN 0  
  WHEN 'BETSLIP' THEN 2  
  WHEN 'EDIT' THEN 10  
  WHEN 'EBETSLIP' THEN 16  
 end as entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
 
 -----sports section   
 null,null,null,null,null,null,null,
 
 -----value amount section   
 coalesce(amt.wager, 0) as wager,  
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount else 0 end as returnamount,  -- LA add refund
 case when transactiontype = 3 then amt.winningamount else 0 end as winningamount,
 case when t.transactiontype = 3 then amt.rebatereclaim else coalesce(hd.betlinerebateamount,0)   end as betlinerebateamount, 
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_temp_HorseDetail hd on t.ticketserialnumber = hd.ticketserialnumber
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber 
 where t.prodid = 1 and t.isbetrejectedbytrader = false and (t.transactiondate::timestamp between startdate and enddate)
 order by t.uuid  

 ; insert into ubt_temp_transactiondata 
-- union all 
  --SPORTS (Per UUID)  For Bet Placement
 
 select  
 t.uuid,   t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 sd.bettype as bettypeid,  
 sd.selection as selection,  
  case when t.transactiondate < ob_startdate then ob_previousbusinessdate 
 when t.transactiondate > ob_enddate then ob_nextbusinessdate
 else ob_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid,   t.locationid,   t.cartid,   t.tranheaderid,  
 -----lottery section  
 t.uuid as boardseqnumber,   sd.entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
  -----sports section   
 sd.eventid,   sd.leaguecode,   sd.liveindicator,   sd.eventname,   sd.bettypename,  
 sd.selectionodds,   sd.starttime,  
 -----value amount section   
 amt.wager as wager,  
 amt.secondwager as secondwager,  
 pbtli.salesfactoramount as sales,
 amt.secondsales as secondsales,  
 coalesce(amt.salescomm, 0) as salescomm, 
 coalesce(amt.secondsalescomm,0) as secondsalescomm, 
 coalesce(amt.gst,0) as gst, 
 amt.secondgst as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount  else 0 end as returnamount, 
 case when transactiontype = 3 then amt.winningamount   else 0 end as winningamount,
  null as betlinerebateamount,  
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 inner join   public.ztubt_sports_placedbettransactionlineitem  pbtli on t.tranheaderid = pbtli.tranheaderid  
 inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid 
 left join ubt_temp_sportsdetail sd on t.ticketserialnumber = sd.ticketserialnumber and pbtli.tranlineitemid = sd.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber  
 where 
pbvbcbtdis.transactiontypetotal in (1,4,6) 
 and t.prodid in (5, 6) and t.isbetrejectedbytrader = false and ( t.transactiondate between startdate and enddate)
 order by t.uuid  
 ;
  insert into ubt_temp_transactiondata 
-- union all 
 
select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 sd.bettype as bettypeid,   sd.selection as selection,  
 case when t.transactiondate < ob_startdate then ob_previousbusinessdate 
 when t.transactiondate > ob_enddate then ob_nextbusinessdate
 else ob_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid,   t.locationid,   t.cartid,   t.tranheaderid,  
 -----lottery section  
 t.uuid as boardseqnumber,   sd.entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
  -----sports section   
 sd.eventid,   sd.leaguecode,   sd.liveindicator,   sd.eventname,   sd.bettypename,   
 sd.selectionodds,   sd.starttime,  
 -----value amount section   
 amt.wager as wager,  
 amt.secondwager as secondwager,  
 pbtli.salesfactoramount as sales,
 amt.secondsales as secondsales,  
 coalesce(amt.salescomm, 0) as salescomm, 
 coalesce(amt.secondsalescomm,0) as secondsalescomm, 
 coalesce(amt.gst,0) as gst, 
 amt.secondgst as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount else 0  end as returnamount,
 case when transactiontype = 3 then amt.winningamount else 0  end as  winningamount,
 null as betlinerebateamount,  
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on t.tranheaderid = pbtli.tranheaderid  
 inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid 
 left join ubt_temp_sportsdetail sd on t.ticketserialnumber = sd.ticketserialnumber and pbtli.tranlineitemid = sd.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber  
 where pbvbcbtdis.transactiontypetotal in (3,5) 
 and t.prodid in (5, 6) and t.isbetrejectedbytrader = false and (t.transactiondate between startdate and enddate)
 order by t.uuid  

 ;
create index idx_ubt_transdata_uuid on  ubt_temp_transactiondata(uuid );
create index idx_ubt_transdata_productid  on  ubt_temp_transactiondata(productid );
create index idx_ubt_transdata_selection  on  ubt_temp_transactiondata(selection );
create index idx_ubt_transdata_businessdate  on  ubt_temp_transactiondata(businessdate );
create index idx_ubt_transdata_tranheaderid  on  ubt_temp_transactiondata(tranheaderid  );

--Interface table output-------
return query
	SELECT UUID ,
	TRANHEADERID,
	TRANSACTIONTYPE,
	PRODUCTID,
	BETTYPEID,
	SELECTION,
	BUSINESSDATE, 
	--TRANSACTIONTIMESTAMP,
	to_char(TRANSACTIONTIMESTAMP,'yyyy-MM-dd HH24:mi:ss') ::timestamp as TRANSACTIONTIMESTAMP, -- For FR include second 04 Apr 2022
	TERMINALID,
	USERID,
	LOCATIONID,
	BOARDSEQNUMBER,
	coalesce(ENTRYMETHOD,0),
	coalesce(NUMBOARDS,0),
	coalesce(NUMDRAWS,0),
	coalesce(DRAWID,''),
	coalesce(EBETSLIPINFO_MOBNBR,''),
	coalesce(NUMSIMPLEBETS,0),
	coalesce(QPFLAG,0),
	coalesce(NUMMARKS,0),
	coalesce(BULKID,'') ,
	coalesce(ITOTO_NUMPARTS,''),
	ITOTO_TOTALPARTS,
	GRPTOTO_NUMPARTS,
	EVENTID,
	LEAGUECODE, 
	LIVEINDICATOR,
	EVENTNAME,
	MARKET,
	ODDS,
	MATCHKICKOFF,
	WAGER1,
	WAGER2,
	SALES1,
	SALES2,
	SALESCOMM1,
	SALESCOMM2,
	GST1,
	coalesce(GST2,0),
	RETURNAMOUNT,
	WINNINGAMOUNT, 
	PAYMENTMODE, 
	CARTID ,
	coalesce(BETLINEREBATEAMOUNT,0)
			from ubt_temp_transactiondata
			where TransactionTimestamp >= StartDate
			and TransactionTimestamp <= EndDate
	 ;

drop table 	ubt_temp_placebettransaction_type;
drop table	ubt_temp_LotteryDraw;
drop table	ubt_temp_numdraws;
drop table	ubt_Temp_LotteryDetail;
drop table	ubt_temp_NumBoards;
drop table	ubt_temp_HorseDetail;
drop table	ubt_temp_TotoSeq;
drop table	ubt_Temp_TotoGroup;
drop table	ubt_temp_Liveindidcator;
drop table	ubt_temp_sportsdetail;
drop table	ubt_temp_placebettransaction;
drop table	ubt_temp_bettype;
drop table	ubt_temp_trans;
drop table	ubt_temp_transactionamount;
drop table	ubt_temp_resultwager;
drop table	ubt_temp_resultsalescomwithdate;
drop table	ubt_temp_resultsalesandcomm ;
drop table	ubt_temp_resultGST;
drop table	ubt_temp_resultvalidation;
drop table	ubt_temp_resultvalidationexchange;
drop table	ubt_temp_transactiondata;
drop table	ubt_temp_final_lotteryselect;

END;
$$;


ALTER FUNCTION public.sp_ubt_gettransactiondataforinterval_test2025(startdatetime timestamp without time zone, enddatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1093 (class 1255 OID 2278228)
-- Name: sp_ubt_gettransactiondataforinterval_test61(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransactiondataforinterval_test61(startdatetime timestamp without time zone, enddatetime timestamp without time zone) RETURNS TABLE(uuid character varying, tranheaderid character varying, transactiontype integer, productid integer, bettypeid character varying, selection text, businessdate date, transactiontimestamp timestamp without time zone, terminalid character varying, userid character varying, locationid character varying, boardseqnumber character varying, entrymethod integer, numboards integer, numdraws integer, drawid character varying, ebetslipinfo_mobnbr character varying, numsimplebets integer, qpflag integer, nummarks integer, bulkid character varying, itoto_numparts text, itoto_totalparts text, grptoto_numparts text, eventid character varying, leaguecode character varying, liveindicator character, eventname text, market text, odds character varying, matchkickoff character varying, wager1 numeric, wager2 numeric, sales1 numeric, sales2 numeric, salescomm1 numeric, salescomm2 numeric, gst1 numeric, gst2 numeric, returnamount numeric, winningamount numeric, paymentmode character varying, cartid character varying, betlinerebateamount numeric)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
declare
startdate TIMESTAMP;
enddate timestamp;
bmcs_startdate timestamp;
igt_startdate timestamp;
ob_startdate timestamp;
bmcs_enddate timestamp;
igt_enddate timestamp;
ob_enddate timestamp;
bmcs_currentbusinessdate date;
igt_currentbusinessdate date;
ob_currentbusinessdate date;
bmcs_nextbusinessdate date;
igt_nextbusinessdate date;
ob_nextbusinessdate date;
bmcs_previousbusinessdate date;
igt_previousbusinessdate date;
ob_previousbusinessdate date;
startdateUTC timestamp;
enddateUTC timestamp;
v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

BEGIN
	
	
select 
startdatetime ,
enddatetime ,

fromdatetimebmcs ,
fromdatetimeigt ,
fromdatetimeob ,

todatetimebmcs ,
todatetimeigt ,
todatetimeob ,

(fromdatetimebmcs  ::DATE) ,
(fromdatetimeigt  :: DATE) ,
(fromdatetimeob  :: DATE) ,

(fromdatetimebmcs  ::DATE) + interval '1 Day' ,
(fromdatetimeigt  :: DATE) + interval '1 Day' ,
(fromdatetimeob  :: DATE) + interval '1 Day' ,

(fromdatetimebmcs  ::DATE)- interval '1 Day'  ,
(fromdatetimeigt  :: DATE)- interval '1 Day' ,
(fromdatetimeob  :: DATE) - interval '1 Day' ,

(startdatetime - interval '8 hour')  ,
(enddatetime - interval '8 hour')  

into 

startdate ,
enddate ,

bmcs_startdate ,
igt_startdate ,
ob_startdate ,

bmcs_enddate ,
igt_enddate ,
ob_enddate ,

bmcs_currentbusinessdate ,
igt_currentbusinessdate ,
ob_currentbusinessdate ,

bmcs_nextbusinessdate ,
igt_nextbusinessdate ,
ob_nextbusinessdate ,

bmcs_previousbusinessdate ,
igt_previousbusinessdate ,
ob_previousbusinessdate ,

startdateUTC ,
enddateUTC 
from public.sp_ubt_getcommonubtdates(StartDatetime ,StartDatetime );





--ubt_temp_placebettransaction #PBVBCBT

 create temporary table if not exists ubt_temp_placebettransaction(  
  TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(10),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  CreatedDate timestamp,
  RequestID varchar(40),
  UserDisplayID varchar(40),
  CartID varchar(50),
  TransactionType int4
 );

 


insert INTO ubt_temp_placebettransaction(TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket,TerDisplayID,CreatedDate,RequestID,UserDisplayID,CartID,TransactionType)

 
 SELECT TicketSerialNumber, PB.TranHeaderID, EntryMethodID, DeviceID, ProdID, IsBetRejectedByTrader,IsExchangeTicket
 ,TerDisplayID,PB.CreatedDate,RequestID,UserDisplayID,CartID, 1  TransactionType
  FROM public.ztubt_placedbettransactionheader PB  
  INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate  PBLC ON PB.TranHeaderID = PBLC.TranHeaderID AND PBLC.BetStateTypeID = 'PB06'  
  WHERE
	(PB.CreatedDate >= startdateUTC And PB.CreatedDate <= enddateUTC)
	  
  Union 
  SELECT VB.TicketSerialNumber, VB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader
  ,PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,VB.UserDisplayID,VB.CartID, 3 TransactionType
  FROM public.ztubt_validatedbetticket  VB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON VB.TicketSerialNumber = PB.TicketSerialNumber  
  INNER JOIN public.ztubt_validatedbetticketlifecyclestate VBLC ON VB.TranHeaderID = VBLC.TranHeaderID AND VBLC.BetStateTypeID = 'VB06'  
  WHERE 1=1
  and VB.ValidationTypeID IN ('VALD', 'RFND') 
  AND   (VB.CreatedValidationDate >= startdateUTC And VB.CreatedValidationDate <= enddateUTC)
  Union
  SELECT CB.TicketSerialNumber, CB.TranHeaderID, PB.EntryMethodID, PB.DeviceID, PB.ProdID, PB.IsBetRejectedByTrader,
 
   PB.IsExchangeTicket,PB.TerDisplayID,PB.CreatedDate,PB.RequestID,CB.UserDisplayID,CB.CartID,5 TransactionType
  
  FROM public.ztubt_CancelledBetTicket CB  
  INNER JOIN public.ztubt_placedbettransactionheader PB ON CB.TicketSerialNumber = PB.TicketSerialNumber
  INNER JOIN public.ztubt_cancelledbetticketlifecyclestate  CBLC ON CBLC.TranHeaderID = PB.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'  
  WHERE (PB.IsBetRejectedByTrader ) = FALSE AND (CB.CancelledDate >= startdate And CB.CancelledDate <= enddate)
  ;

 create index idx_ubt_ticketserialnumber on ubt_temp_placebettransaction(TicketSerialNumber);
 create index idx_ubt_tranheaderid on ubt_temp_placebettransaction(TranHeaderID);
create index idx_ubt_prodid on ubt_temp_placebettransaction(prodid);
create index idx_ubt_CreatedDate on ubt_temp_placebettransaction(CreatedDate);
create index idx_ubt_TransactionType on ubt_temp_placebettransaction(TransactionType);
 
 create temporary table if not exists ubt_temp_placebettransaction_type
 (TicketSerialNumber VARCHAR(200),  
  TranHeaderID varchar(50),  
  EntryMethodID VARCHAR(50),  
  DeviceID VARCHAR(100),  
  ProdID INT4,  
  IsBetRejectedByTrader bool,  
  IsExchangeTicket bool,
  TerDisplayID  varchar(100),
  TransactionTypeTotal int4)
  ;
 
 insert into ubt_temp_placebettransaction_type
 
  Select TicketSerialNumber, TranHeaderID, EntryMethodID, DeviceID, ProdID,
   IsBetRejectedByTrader,IsExchangeTicket, TerDisplayID
  ,SUM(TransactionType) TransactionTypeTotal 
  from ubt_temp_placebettransaction
  Group By TicketSerialNumber, TranHeaderID, DeviceID, EntryMethodID, ProdID, 
  IsExchangeTicket, TerDisplayID, IsBetRejectedByTrader
  ;
 
 create index idx_ubt_transaction_type_ticketserialnumber on ubt_temp_placebettransaction_type(TicketSerialNumber);
create index idx_ubt_transaction_type_tranheaderid on ubt_temp_placebettransaction_type(TranHeaderID);
create index idx_ubt_transaction_type_prodid on ubt_temp_placebettransaction_type(ProdID);
create index idx_ubt_transaction_type_isbetrejectedbytrader on ubt_temp_placebettransaction_type(IsBetRejectedByTrader);
create index idx_ubt_transaction_type_isexchangeticket on ubt_temp_placebettransaction_type(IsExchangeTicket);
create index idx_ubt_transaction_type_terdisplayid on ubt_temp_placebettransaction_type(TerDisplayID);
create index idx_ubt_transaction_type_transactiontypetotal on ubt_temp_placebettransaction_type(TransactionTypeTotal);
  
  --ubt_temp_placebettransaction_type #PBDVBCBT
  
   -----------------------------------------------------------------  
 --BET TYPE 
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_bettype  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemnumberid varchar(50),  
  bettypeid varchar(2)
 )  
 ; 
  

  
 --4D  
 INSERT INTO ubt_temp_bettype  
 SELECT
 PBVBCBT.TicketSerialNumber,  
 PBTLI.TranLineItemID,  
 CASE  
  WHEN PBTLI.BetTypeID = 'ORD' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN '0'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '5'  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN '10'  
   END  
  WHEN PBTLI.BetTypeID = 'SYS' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN   
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '1'  
WHEN PBTLI.Permutation = 12 THEN '2'  
  WHEN PBTLI.Permutation = 4 THEN '3'  
  WHEN PBTLI.Permutation = 6 THEN '4'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '6'  
  WHEN PBTLI.Permutation = 12 THEN '7'  
  WHEN PBTLI.Permutation = 4 THEN '8'  
  WHEN PBTLI.Permutation = 6 THEN '9'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
   CASE  
  WHEN PBTLI.Permutation = 24 THEN '11'  
  WHEN PBTLI.Permutation = 12 THEN '12'  
  WHEN PBTLI.Permutation = 4 THEN '13'  
  WHEN PBTLI.Permutation = 6 THEN '14'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'IBET' THEN  
   CASE   
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '27'  
  WHEN PBTLI.Permutation = 12 THEN '28'  
  WHEN PBTLI.Permutation = 4 THEN '29'  
  WHEN PBTLI.Permutation = 6 THEN '30'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '31'  
  WHEN PBTLI.Permutation = 12 THEN '32'  
  WHEN PBTLI.Permutation = 4 THEN '33'  
  WHEN PBTLI.Permutation = 6 THEN '34'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN PBTLI.Permutation = 24 THEN '35'  
  WHEN PBTLI.Permutation = 12 THEN '36'  
  WHEN PBTLI.Permutation = 4 THEN '37'  
  WHEN PBTLI.Permutation = 6 THEN '38'  
 END  
   END  
  WHEN PBTLI.BetTypeID = 'ROLL' THEN  
   CASE  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) = 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '15'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber)= 2 THEN '16'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '17'  
  ELSE '18'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) = 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN 
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '19'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '20'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '21'  
  ELSE '22'  
 END  
WHEN COALESCE(PBTLIN.BigBetAcceptedWager, 0) > 0  AND COALESCE(PBTLIN.SmallBetAcceptedWager, 0) > 0 THEN  
 CASE  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 1 THEN '23'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 2 THEN '24'  
  WHEN position ('R' in PBTLIN.SelectedBetNumber) = 3 THEN '25'  
  ELSE '26'  
 END  
   END  
 END AS BetTypeID  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitem   PBTLI ON PBVBCBT.TranHeaderID = PBTLI.TranHeaderID  
 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON PBTLI.TranLineItemID = PBTLIN.TranLineItemID  
 WHERE PBVBCBT.ProdId = 2
 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0
and 
 ((PBTLIN.CreatedDate >= startdateUTC And PBTLIN.CreatedDate <= enddateUTC 
 and  PBVBCBT.TransactionTypeTotal In (1, 4, 6))	or  PBVBCBT.TransactionTypeTotal In (3,5))


 union all 
----TOTO

 
 select
 pbt.ticketserialnumber,   
 pbtli.tranlineitemid,  
 case pbtli.bettypeid   
  WHEN 'ORD'   THEN '0'  
  WHEN 'SYSR'  THEN '1'  
  WHEN 'SYS7'  THEN '2'  
  WHEN 'SYS8'  THEN '3'  
  WHEN 'SYS9'  THEN '4'  
  WHEN 'SYS10' THEN '5'  
  WHEN 'SYS11' THEN '6'  
  WHEN 'SYS12' THEN '7'  
  --totomatch
  WHEN 'M 4'  THEN '16'  
  WHEN 'M 3' THEN '17'  
  WHEN 'M 2' THEN '18'  
  WHEN 'M AN' THEN '19'  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_toto_placedbettransactionlineitem pbtli  on pbt.tranheaderid = pbtli.tranheaderid  
 where pbt.prodid = 3 and  
  ((pbtli.createddate >= startdateutc and pbtli.createddate <= enddateutc and  
  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))
 
 union all
 
 ---SWEEP

 select
 pbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 '0' as bettypeid   
 from ubt_temp_placebettransaction_type pbt  
 inner join public.ztubt_sweep_placedbettransactionlineitemnumber pbtlin on pbt.tranheaderid = pbtlin.tranheaderid  
 where   pbt.prodid = 4
 and issoldout  <> true and 
 ((pbtlin.createddate >= startdateutc and pbtlin.createddate <= enddateutc
 and  pbt.transactiontypetotal in (1, 4, 6))
 	or  pbt.transactiontypetotal in (3,5))

 --SPORT
 union all
 select
 pbvbcbt.ticketserialnumber,   
 pbtlin.tranlineitemid,  
 case scat.categoryid when 1 
 then 
 case pbtli.accumulatorid   
  WHEN 'ACC4' THEN '4F'  
  WHEN 'DBL' THEN 'D'  
  WHEN 'SGL' THEN 'S'  
  WHEN 'TBL' THEN 'T'  
  END 
 WHEN 2 THEN 'S'
  
 end as bettypeid  
 from ubt_temp_placebettransaction_type pbvbcbt 
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on pbvbcbt.tranheaderid = pbtli.tranheaderid  
 inner  join public.ztubt_sports_placedbettransactionlineitemnumber  pbtlin on pbtli.tranlineitemid = pbtlin.tranlineitemid 
 inner join public.ztubt_sportevent se on pbtlin.eventid = se.eventid  
 inner join public.ztubt_sporttype st on se.typeid = st.typeid  
 inner join public.ztubt_sportclass sc on st.classid = sc.classid  
 inner join public.ztubt_sportcategory scat on sc.categoryid = scat.categoryid 
 where (scat.categoryid= 1)  or (scat.categoryid=2 and pbvbcbt.prodid in (5,6) )
 
 group by pbvbcbt.ticketserialnumber,pbtlin.tranlineitemid, scat.categoryid,pbtli.accumulatorid 
 ;
 
create index  ind_ticketsrno on ubt_temp_bettype(ticketserialnumber);
 -----------------------------------------------------------------  
 --DETAIL OF HORSE  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_horsedetail  
 (  
  ticketserialnumber varchar(500),  
  entrymethod int4,  
  betlinerebateamount numeric(22,2) 
 )  
 ;

 insert into ubt_temp_horsedetail
 
 
 SELECT ADP.TicketSerialNumber,
  CASE ADP.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 SUM(ADP.Amount) AS BetLineRebateAmount  
 FROM  
 (  
  SELECT   PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, EntryMethodID,  
  CASE WHEN BetTypeID = 'W-P'  
THEN (coalesce(PBTL.BoardRebateAmount,0))  
   ELSE SUM(coalesce(PBTL.BoardRebateAmount,0))   
  END AS Amount
  
  FROM ubt_temp_placebettransaction_type PBVBCBT 
  INNER JOIN   public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCBT.TranHeaderID = PBTL.TranHeaderID  
	WHERE  PBVBCBT.ProdID = 1 and 
	((PBTL.CreatedDate >= startdateUTC And PBTL.CreatedDate <= enddateUTC 	
AND PBVBCBT.TransactionTypeTotal In (1, 4, 6) ) or PBVBCBT.TransactionTypeTotal in (3,5))
  GROUP BY  PBVBCBT.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BoardRebateAmount, EntryMethodID
 )ADP  
 GROUP BY ADP.TicketSerialNumber, ADP.EntryMethodID
 ;
 
create index idx_ubt_horse_ticketsrno on ubt_temp_horsedetail(TicketSerialNumber);
 -----------------------------------------------------------------  
 --DETAIL OF LOTTERY  
 -----------------------------------------------------------------  
  
 create temporary table if not exists ubt_temp_numboards  
 (  
  ticketserialnumber varchar(500),  
  numboards int4,  
  bulkid varchar(50)
 ) ; 
  
 INSERT INTO ubt_temp_NumBoards  
 --4D
 SELECT DISTINCT PBT.TicketSerialNumber,   
 COUNT(z4dln.TranLineItemID) AS NumBoards,  
 NULL AS BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN   public.ztubt_4d_placedbettransactionlineitemnumber  z4dln ON PBT.TranHeaderID = z4dln.TranHeaderID  
 WHERE PBT.ProdID = 2 and  coalesce(z4dln.BigBetAcceptedWager, 0) + coalesce(z4dln.SmallBetAcceptedWager, 0) > 0 AND
 ((z4dln.CreatedDate >= StartDateUTC And z4dln.CreatedDate <= EndDateUTC  
  AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 
 GROUP BY PBT.TicketSerialNumber 
 
 
 union all 
 --TOTO
 
 select pbvbcbt.ticketserialnumber,   
 count(pbtl.tranlineitemid) as numboards,  
 null as bulkid  
 from ubt_temp_placebettransaction_type pbvbcbt   
 inner join  public.ztubt_toto_placedbettransactionlineitem  pbtl on pbvbcbt.tranheaderid = pbtl.tranheaderid  
 where   pbvbcbt.prodid = 3 and  
 ((pbtl.createddate >= startdateUTC and pbtl.createddate <= enddateUTC and
  pbvbcbt.transactiontypetotal in (1, 4, 6)) or pbvbcbt.transactiontypetotal in (3,5))
 group by pbvbcbt.ticketserialnumber  

 
 union  all 
 
 --SWEEP
 SELECT PBT.TicketSerialNumber,   
 COUNT(PLN.TranLineItemID) AS NumBoards,  
 BulkID 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitem  PL ON PBT.TranHeaderID = PL.TranHeaderID  
 INNER JOIN  public.ztubt_sweep_placedbettransactionlineitemnumber  PLN ON PL.TranLineItemID = PLN.TranLineItemID  
 WHERE  PBT.ProdID = 4 AND IsSoldOut <> true and
 ((PLN.CreatedDate >= StartDateUTC And PLN.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  
 GROUP BY PBT.TicketSerialNumber, BulkID 
 
 ;
create index idx_ubt_numboard_ticketsrno on ubt_temp_numboards (TicketSerialNumber);

create temporary table ubt_temp_LotteryDraw
( TicketSerialNumber varchar (200),
HostDrawDatesId varchar(20)
)
 ;
	insert into ubt_temp_LotteryDraw
Select PBTT.TicketSerialNumber, CAST(zdm.HostDrawDatesId AS VARCHAR) HostDrawDatesId

	FROM ubt_temp_placebettransaction_type PBTT  
	INNER JOIN public.ztubt_drawdates zdm  ON PBTT.TranHeaderID = zdm.TranHeaderID   
	Where  PBTT.ProdID In (2,3,4) 

;	
create index idx_ubt_lotterydraws_ticketsrno on ubt_temp_LotteryDraw (TicketSerialNumber,HostDrawDatesId);

create temporary table ubt_temp_numdraws
( TicketSerialNumber varchar (200),
NumDraws int4,
Drawid varchar(50)
)
 ;
	insert into ubt_temp_numdraws
	SELECT
	LD.TicketSerialNumber,
	Count(1) NumDraws,
	string_agg(CAST(LD.HostDrawDatesId AS varchar),',' ) as Drawid

	From ubt_temp_LotteryDraw LD 
	Group By LD.TicketSerialNumber

;
	
create index idx_ubt_numdraws_ticketsrno on ubt_temp_numdraws (TicketSerialNumber);

 create temporary table if not exists ubt_temp_lotterydetail  
 (  
  ticketserialnumber varchar(500),  
  tranlineitemid varchar(50),  
  boardseqnumber int,  
  entrymethod int,  
  numboards int,  
  numdraws int,  
  drawid varchar(500),  
  ebetslipinfo_mobnbr varchar(100),  
  numsimplebets int4,  
  qpflag int4,  
  nummarks int4,  
  bulkid varchar(50), --(5)  
  itoto_numparts text, -- varchar(max)  
  itoto_totalparts text,   --varchar(max)
  grptoto_numparts text   --varchar(max)
 )  
  
 ;
 create temporary table if not exists ubt_temp_TotoSeq (  
  TranLineItemID varchar(50),  
  Seq INT4  
 )  
  ;
 create temporary table if not exists ubt_Temp_TotoGroup ( 
  GroupHostID varchar(50),  
  GroupToto INT4 
 ) ; 
  
 INSERT INTO ubt_temp_TotoSeq  
 SELECT LIN.TranLineItemID, MAX(LIN.Sequence) AS Seq  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join  public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitemnumber  LIN on LI.TranLineItemID = LIN.TranLineItemID
 WHERE PBT.ProdID = 3 and 
 ((LI.CreatedDate >= StartDateUTC And LI.CreatedDate <= EndDateUTC  
 AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY LIN.TranLineItemID  
 ;
 
 INSERT INTO ubt_Temp_TotoGroup 
 SELECT LI2.GroupHostID, MAX(LI2.GroupUnitSequence) AS GroupToto  
 FROM ubt_temp_placebettransaction_type PBT 
 inner join public.ztubt_toto_placedbettransactionlineitem  LI on PBT.TranHeaderID = LI.TranHeaderID
 inner join public.ztubt_toto_placedbettransactionlineitem LI2 on LI.GroupHostID = LI2.GroupHostID
 WHERE PBT.ProdID = 3
 AND LI.GroupHostID <> '00000000-0000-0000-0000-000000000000' AND LI.GroupUnitSequence IS NOT NULL 
 GROUP BY LI2.GroupHostID
 
 ;
 --4D
 
 INSERT INTO ubt_Temp_LotteryDetail  
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
   PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
   PBVBCBT.TransactionTypeTotal In (1, 4, 6)  

union all 

 
 SELECT PBVBCBT.TicketSerialNumber,  
 FOURD.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY FOURD.TranLineItemID
-- 					ORDER BY split_part(FOURD.tranlineitemid,'-',5)
--							,split_part(FOURD.tranlineitemid,'-',4)
--							,split_part(FOURD.tranlineitemid,'-',3)
--							,split_part(FOURD.tranlineitemid,'-',2)
--							,split_part(FOURD.tranlineitemid,'-',1)

 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE FOURD.Permutation  
  WHEN NULL THEN 1  
  WHEN 0   THEN 1  
  ELSE FOURD.Permutation  
 END AS NumSimpleBets,  
 FOURD.QuickPickIndicator :: int AS QPFlag,  
 4 AS NumMarks,
 NB.BulkID, --(5)  
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitem  FOURD ON PBVBCBT.TranHeaderID = FOURD.TranHeaderID  
	 INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber  PBTLIN ON FOURD.TranLineItemID = PBTLIN.TranLineItemID 
	 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
	 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 2 AND coalesce (PBTLIN.BigBetAcceptedWager, 0) + coalesce (PBTLIN.SmallBetAcceptedWager, 0) > 0 and 
 PBVBCBT.TransactionTypeTotal in (3,5)
  
union all
 
 --TOTO  
  
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE 
  WHEN TOTO.BetTypeID = ANY(v_totomatchBettypes) THEN 1
  WHEN TOTO.BetTypeID = 'ORD' THEN 1  
  WHEN TOTO.BetTypeID = 'SYSR' THEN 44  
  WHEN TOTO.BetTypeID = 'SYS7' THEN 7  
  WHEN TOTO.BetTypeID = 'SYS8' THEN 28  
  WHEN TOTO.BetTypeID = 'SYS9' THEN 84  
  WHEN TOTO.BetTypeID = 'SYS10' THEN 210  
  WHEN TOTO.BetTypeID = 'SYS11' THEN 462  
  WHEN TOTO.BetTypeID = 'SYS12' THEN 924 
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and 
 TOTO.CreatedDate >= StartDateUTC And TOTO.CreatedDate <= EndDateUTC   
 AND PBVBCBT.TransactionTypeTotal In (1, 4, 6)
 
 union all 
 
 SELECT PBVBCBT.TicketSerialNumber,  
 TOTO.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY TOTO.TranLineItemID
--  					ORDER BY split_part(TOTO.tranlineitemid,'-',5)
--							,split_part(TOTO.tranlineitemid,'-',4)
--							,split_part(TOTO.tranlineitemid,'-',3)
--							,split_part(TOTO.tranlineitemid,'-',2)
--							,split_part(TOTO.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 CASE 
  WHEN TOTO.BetTypeID = ANY(v_totomatchBettypes) THEN 1
  WHEN TOTO.BetTypeID = 'ORD' THEN 1
  WHEN TOTO.BetTypeID = 'SYSR' THEN 44
  WHEN TOTO.BetTypeID = 'SYS7' THEN 7
  WHEN TOTO.BetTypeID = 'SYS8' THEN 28
  WHEN TOTO.BetTypeID = 'SYS9' THEN 84
  WHEN TOTO.BetTypeID = 'SYS10' THEN 210
  WHEN TOTO.BetTypeID = 'SYS11' THEN 462 
  WHEN TOTO.BetTypeID = 'SYS12' THEN 924
 END AS NumSimpleBets, 
 TOTO.QuickPickIndicator :: int AS QPFlag,  
 TOTOSEQ.Seq AS NumMarks,  
 NB.BulkID, 
 cast(TOTO.Units as varchar) AS itoto_numparts ,  
 cast(TOTO.SyndicatePartsAllowed as varchar) AS itoto_totalparts,  
 cast(TOTOGROUP.GroupToto as varchar) AS grptoto_numparts 
  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_toto_placedbettransactionlineitem   TOTO ON PBVBCBT.TranHeaderID = TOTO.TranHeaderID  
 INNER JOIN ubt_temp_TotoSeq TOTOSEQ ON TOTO.TranLineItemID = TOTOSEQ.TranLineItemID  
 LEFT JOIN ubt_Temp_TotoGroup TOTOGROUP ON TOTO.GroupHostID = TOTOGROUP.GroupHostID --(3)  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
 INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 3 and PBVBCBT.TransactionTypeTotal in (3,5)
 
 union all 
 
 --SWEEP
 
 SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and 
PBTLIN.CreatedDate >= StartDateUTC And PBTLIN.CreatedDate <= EndDateUTC AND
  PBVBCBT.TransactionTypeTotal In (1, 4, 6)
  
  union all 
  
  SELECT PBVBCBT.TicketSerialNumber,  
 SWEEP.TranLineItemID,  
 ROW_NUMBER() OVER (PARTITION BY PBVBCBT.TicketSerialNumber 
 					ORDER BY SWEEP.TranLineItemID
--  					ORDER BY split_part(SWEEP.tranlineitemid,'-',5)
--							,split_part(SWEEP.tranlineitemid,'-',4)
--							,split_part(SWEEP.tranlineitemid,'-',3)
--							,split_part(SWEEP.tranlineitemid,'-',2)
--							,split_part(SWEEP.tranlineitemid,'-',1)
 					) AS RowNum,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 NB.NumBoards,  
 ND.NumDraws,  
 ND.DrawID,  
 PBVBCBT.DeviceID AS ebetslipinfo_mobnbr,  
 1 AS NumSimpleBets,
 SWEEP.QuickpickIndicator :: int AS QPFlag,  
 LENgth(CAST(UserSelectedNumber AS VARCHAR)) As NumMarks, 
 NB.BulkID, 
 NULL AS itoto_numparts,  
 NULL AS itoto_totalparts,  
 NULL AS grptoto_numparts  
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitem   SWEEP ON PBVBCBT.TranHeaderID = SWEEP.TranHeaderID  
 INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber  PBTLIN ON SWEEP.TranLineItemID = PBTLIN.TranLineItemID  
 INNER JOIN ubt_temp_NumBoards NB ON PBVBCBT.TicketSerialNumber = NB.TicketSerialNumber  
INNER JOIN ubt_temp_numdraws ND ON PBVBCBT.TicketSerialNumber = ND.TicketSerialNumber  
 WHERE PBVBCBT.ProdID = 4  AND IsSoldOut <> true and PBVBCBT.TransactionTypeTotal In (3,5)

;
 
create index idx_ubt_lotterydetail_ticketsrno  on ubt_Temp_LotteryDetail(TicketSerialNumber);
create index idx_ubt_lotterydetail_tranlineitemid  on ubt_Temp_LotteryDetail(TranLineItemID);
 -----------------------------------------------------------------  
 --DETAIL OF SPORTS  
 -----------------------------------------------------------------  
 create temporary table if not exists ubt_temp_Liveindidcator  
 (  
  TicketSerialNumber VARCHAR(500),  
  LiveIndicator CHAR(1)  
 )  
  ;
 INSERT INTO ubt_temp_Liveindidcator  
 SELECT din.TicketSerialNumber,   
 CASE  
  WHEN (din.HasBetInRun = TRUE) AND (din.CreatedDate BETWEEN din.StartTime AND din.SuspendTime) THEN 'Y'  
  ELSE 'N'  
 END AS LiveIndicator  
 FROM  
 (  
  SELECT ROW_NUMBER() OVER (PARTITION BY SPBN.TranHeaderID 
  							ORDER BY SPBN.TranLineItemID
--		  					ORDER BY split_part(SPBN.tranlineitemid,'-',5)
--									,split_part(SPBN.tranlineitemid,'-',4)
--									,split_part(SPBN.tranlineitemid,'-',3)
--									,split_part(SPBN.tranlineitemid,'-',2)
--									,split_part(SPBN.tranlineitemid,'-',1)
  							) AS ROWNUM,
  PBVBCBT.TicketSerialNumber, SE.HasBetInRun, SE.StartTime, SE.SuspendTime, SPBN.CreatedDate  
  FROM ubt_temp_placebettransaction_type PBVBCBT
  INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  SPBN ON PBVBCBT.TranHeaderID = SPBN.TranHeaderID  
  INNER join public.ztubt_sportevent SE ON SPBN.EventID = SE.EventId  
  WHERE PBVBCBT.ProdID IN(5,6)
 )din  
 WHERE din.ROWNUM = 1  
;
create index idx_ubt_liveindicator_ticketsrno  on ubt_temp_Liveindidcator(TicketSerialNumber); 

 create temporary table if not exists ubt_temp_sportsdetail
 (  
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID Varchar(50),--(1)  
  EntryMethod INT4,  
  EventID VARCHAR(500),  
  LeagueCode VARCHAR(500),  
  LiveIndicator CHAR(1),  
  EventName text,  
  BetTypeName text,  
  Selection VARCHAR(500),  
  SelectionOdds VARCHAR(500),  
  StartTime VARCHAR(500),  
  BetType VARCHAR(500)
 )  
  ;
 INSERT INTO ubt_temp_sportsdetail  
 SELECT PBVBCBT.TicketSerialNumber,   
 PLN.TranLineItemID,  
 CASE PBVBCBT.EntryMethodID  
  WHEN 'Manual' THEN 0  
  WHEN 'BetSlip' THEN 2  
  WHEN 'Edit' THEN 10  
  WHEN 'EBetSlip' THEN 16  
 END AS EntryMethod,  
 PLN.EventID AS EventID,  
 SL.LeagueCode AS LeagueCode,  
 LI.LiveIndicator :: char AS LiveIndicator,  
 PLN.EventName AS EventName,  
 PLN.BetTypeName AS BetTypeName,  
 PLN.SelectionName AS Selection,  
 PLN.SelectionOdds AS SelectionOdds,  
 --to_char(SE.StartTime, 'yyyyMMdd HHmmss') AS StartTime, b.BetTypeID 
to_char(SE.StartTime, 'yyyyMMdd HH24miss') AS StartTime, b.BetTypeID 
 FROM ubt_temp_placebettransaction_type PBVBCBT  
 INNER JOIN public.ztubt_sports_placedbettransactionlineitemnumber  PLN ON PBVBCBT.TranHeaderID = PLN.TranHeaderID
 INNER JOIN public.ztubt_sportevent  SE ON PLN.EventID = SE.EventId  
 INNER JOIN public.ztubt_sporttype  ST ON SE.TypeId = ST.TypeId  
 INNER JOIN public.ztubt_sportleagueinfo  SL ON REPLACE(ST.Name, '|', '') = REPLACE(SL.Name, '|', '')  
 INNER JOIN ubt_temp_Liveindidcator LI ON PBVBCBT.TicketSerialNumber = LI.TicketSerialNumber  
 inner join ubt_temp_bettype b on b.TranLineItemNumberID = PLN.TranLineItemID  
 LEFT JOIN public.ztubt_entrymethod  EM ON PBVBCBT.EntryMethodID = EM.EntryMethodID  
 WHERE PBVBCBT.ProdID IN (5,6)  
 GROUP BY PBVBCBT.TicketSerialNumber, PLN.TranLineItemID, PBVBCBT.EntryMethodID, PLN.EventID, SL.LeagueCode, 
 LI.LiveIndicator, PLN.EventName, PLN.BetTypeName, PLN.SelectionOdds, SE.StartTime,  b.BetTypeID, PLN.SelectionName  
 ;

create index idx_ubt_sportdetail_ on ubt_temp_sportsdetail(TicketSerialNumber,TranLineItemID);
 
  
 -------------------------------------------------------------------------  
 --GET TRANSACTION (COLLECTION, VALIDATION, CANCELLATION) PER AD HOC TIME  
 -------------------------------------------------------------------------  
 create temporary table if not exists ubt_temp_trans  
 (  
  EntryMethodID VARCHAR(10),  --(S5)
  ProdID int4,  --(S5)
  IsBetRejectedByTrader bool, --(S5)
  TicketSerialNumber VARCHAR(200),  
  UUID VARCHAR(33),  
  TransactionType INT4,  
  TransactionDate timestamp,  
  TerminalID VARCHAR(100),  
  UserID VARCHAR(100),  
  LocationID VARCHAR(200),  
  CartID varchar(50),  
  TranHeaderID varchar(50)
 )  
   ;
-------COLLECTION--------------
   
 --HORSE RACING  
  INSERT INTO ubt_temp_trans  
  SELECT  
  PB.EntryMethodID, 
  PB.ProdID,  --(S5)
  PB.IsBetRejectedByTrader , --(S5)
  PB.TicketSerialNumber AS TSN,  
  PB.RequestID AS UUID,  
  1 AS TransactionType, --Wager  
  ( PB.CreatedDate + interval '8 hour'),  
 PB.TerDisplayID AS TerminalID,  PB.UserDisplayID AS UserID,  L.LocDisplayID AS LocationID,  
  PB.CartID,  
  PB.TranHeaderID  
  FROM ubt_temp_placebettransaction PB  
  INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.terdisplayid  
  LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
  WHERE PB.ProdID  in (1, 2, 3, 4, 5, 6) and  
   PB.TransactionType = 1 
 AND  (PB.CreatedDate >= StartDateUTC And PB.CreatedDate <= EndDateUTC) 
 
  --ProdID = 1 --HORSE RACING
  --ProdId=2,3,4 Lottery
  --prodid=5,6 sports
  
  ------------VALIDATION -----------
  
  
  
union all 
--Horse Racing

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID = 1 
 AND (coalesce (zv.WinningAmount,0) > 0 OR coalesce (zv.RebateReclaim,0) > 0) 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 --Lottery(prod id (2,3,4)  & Sports prodid (5,6)
 union all 
 

 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 zv.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (2,3,4)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 union all 
 
 SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 3 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)
 AND coalesce (zv.WinningAmount,0) > 0 AND zv.ValidationTypeID = 'VALD' -- Issue:Fixed on 20220221 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
 
 
union all 
--refund

SELECT  
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 zv.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 61 AS TransactionType, --Validation  
 zv.ValidationDate,  
 zv.TerDisplayID AS TerminalID,  
 zv.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 zv.CartID,  
 zv.TranHeaderID  
 FROM  public.ztubt_validatedbetticket zv  
 INNER JOIN ubt_temp_placebettransaction PB ON zv.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID IN (1,2,3,4, 5, 6) 
 AND  zv.ValidationTypeID = 'RFND' 
 AND  (zv.CreatedValidationDate >= StartDateUTC And zv.CreatedValidationDate <= EndDateUTC)   
 AND PB.TransactionType = 3 
 
---- ----CANCELLATION-------------------
 union all
 --Horse racing prodid (1) & Lottery prodid (2,3,4)
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID =1 --HORSE RACING  
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 

 union all 
 SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 cbt.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (2,3,4)  -- Lottery
 AND PB.TransactionType = 5 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
union all
 --Sports
 
  SELECT   
 PB.EntryMethodID, --(S5)
 PB.ProdID,  --(S5)
 PB.IsBetRejectedByTrader, --(S5)
 cbt.TicketSerialNumber AS TSN,  
 PB.RequestID AS UUID, --(5)  
 2 AS TransactionType, --Cancellation  
 cbt.CancelledDate,  
 cbt.TerDisplayID AS TerminalID,  
 cbt.UserDisplayID AS UserID,  
 L.LocDisplayID AS LocationID,  
 cbt.CartID,  
 cbt.TranHeaderID  
 FROM  public.ztubt_cancelledbetticket  cbt  
 INNER JOIN ubt_temp_placebettransaction PB ON cbt.TicketSerialNumber = PB.TicketSerialNumber  
 INNER JOIN (select terdisplayid,locid from public.ztubt_terminal) T ON PB.TerDisplayID = T.TerDisplayID  
 LEFT JOIN (select LocID, LocDisplayID from public.ztubt_location ) L ON T.LocID = L.LocID  
 WHERE PB.ProdID in (5,6)   --SPORTS
 AND PB.TransactionType = 5 
 AND PB.IsBetRejectedByTrader = false 
 AND (cbt.CancelledDate >= StartDate And cbt.CancelledDate <= EndDate) 
 
 ;

create index idx_ubt_trans_ticketserialnumber on ubt_temp_trans(TicketSerialNumber);
create index idx_ubt_trans_tranheaderid on ubt_temp_trans(TranHeaderID);
  --FINAL RESULT OF TRANSACTIONAL VIEW  
 -----------------------------------------------------------------  
  
  
 create temporary table if not exists ubt_temp_transactionamount(
  TicketSerialNumber VARCHAR(500),  
  TranLineItemID varchar(50),  
  Wager numeric(22,2), 
  SecondWager numeric(22,2), 
  Sales numeric(22, 11),  
  SecondSales numeric(22, 11),  
  SalesComm numeric(22, 11),  
  SecondSalesComm numeric(22, 11),  
  GST numeric(22, 11),  
  SecondGST numeric(22, 11),  
  ReturnAmount  numeric(22,2),  
  WinningAmount  numeric(22,2),  
  RefundAmount  numeric(22,2),  
  RebateReclaim  numeric(22,2)
 )  
  
 ;
 --COLLECTION 
 
 
 create temporary table if not exists ubt_temp_resultwager  
(  
ProdID int4,
 TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
 Wager numeric(22,2), 
 SecondWager numeric(22,2)
)  
;
 insert into ubt_temp_resultwager
 select 1::int4 ProdID, amtw.TicketSerialNumber, null , SUM(amtw.Amount) AS Wager, 0 AS SecondWager  
 FROM  
(  
SELECT   PBVBCB.TicketSerialNumber, PBTL.TranHeaderID,  
CASE WHEN BetTypeID = 'W-P' 
THEN (coalesce (PBTL.BetPriceAmount,0))  
ELSE SUM(coalesce (PBTL.BetPriceAmount,0))   
END AS Amount,  
COUNT(DISTINCT PBVBCB.TicketSerialNumber) Ct, 'COL' AS Flag,'CH' AS TransType  
FROM  
ubt_temp_placebettransaction_type PBVBCB 
INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  PBTL ON PBVBCB.TranHeaderID = PBTL.TranHeaderID 
WHERE PBVBCB.ProdID = 1
and ((PBTL.CreatedDate >= StartDateUTC And PBTL.CreatedDate <= EndDateUTC
AND PBVBCB.TransactionTypeTotal In (1, 4, 6) ) or PBVBCB.TransactionTypeTotal in (3,5))

GROUP BY  PBVBCB.TicketSerialNumber, PBTL.TranHeaderID, BetTypeID, BetPriceAmount 	
)amtw  
GROUP BY amtw.TicketSerialNumber

union all 

--4D

SELECT  2::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BigBetAcceptedWager,0)) AS Wager, SUM(coalesce (zdp.SmallBetAcceptedWager,0)) AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_4d_placedbettransactionlineitemnumber zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  
INNER JOIN public.ztubt_drawdates zd   ON zd.TranHeaderID = zdp.TranHeaderID   
WHERE  PBT.ProdID = 2 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >=StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID  


union all 
--toto

SELECT  3::int4 ProdID, PBT.TicketSerialNumber, zdp.TranLineItemID, 
  SUM(coalesce (zdp.BetPriceAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zdp  ON zdp.TranHeaderID = PBT.TranHeaderID  

WHERE  PBT.ProdID = 3 
	AND PBT.IsExchangeTicket = FALSE   
	AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	 
GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 

--sweep

SELECT   4::int4 ProdID, PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.BetPriceAmount,0)) AS Wager, 0 AS SecondWager 
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = False  
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zplc   ON zplc.TranHeaderID = PBT.TranHeaderID  
INNER JOIN (select terdisplayid,Locid from public.ztubt_terminal ) Ter  ON PBT.TerDisplayID = Ter.TerDisplayID
INNER JOIN (Select * from  public.ztubt_location) Loc  ON Ter.LocID = Loc.LocID
WHERE ( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zplc.BetStateTypeID = 'PB06' ) 	
		OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zplc.BetStateTypeID = 'PB03' ) )
AND PBT.ProdID=4
AND ((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC
	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 

--sports

SELECT   FIN.ProdID ProdID, FIN.TicketSerialNumber, NULL, SUM(coalesce (FIN.BetAmount,0)) AS Wager, 0 AS SecondWager  
FROM  
(  
select PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, BetAmount, TicketSerialNumber  
FROM  
ubt_temp_placebettransaction_type PBT   
INNER JOIN public.ztubt_sports_placedbettransactionlineitem zsp  ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE   
PBT.ProdID IN (5, 6) AND PBT.IsBetRejectedByTrader != TRUE 
GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet, AccumulatorID, BetAmount, TicketSerialNumber  
)FIN  
GROUP BY FIN.TicketSerialNumber, FIN.ProdID 
;

create index idx_ubt_resultwager_TicketSerialNumber  on ubt_temp_resultwager(TicketSerialNumber);
create index idx_ubt_resultwager_tranlineitemid  on ubt_temp_resultwager(TranLineItemID);

--For Sales Comm, Sales Factor and Output GST  
create temporary table if not exists ubt_temp_resultsalescomwithdate  
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 SalesCommAmount numeric(32, 12),  
 SalesFactorAmount numeric(32, 12),  
 SecondSalesCommAmount numeric(32, 12),  
 SecondSalesFactorAmount numeric(32, 12),  
 GSTRate numeric(10, 2)
)  ;
  
--Toto

insert into ubt_temp_resultsalescomwithdate
select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmount,0)) SalesCommAmount,
SUM(coalesce (zdp.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
	ubt_temp_placebettransaction_type PBT  
	Inner jOin public.ztubt_toto_placedbettransactionlineitem  zdp   ON PBT.TranHeaderID = zdp.TranHeaderID
WHERE  PBT.ProdID = 3 
AND PBT.IsExchangeTicket = FALSE  
AND ((zdp.CreatedDate >= StartDateUTC And zdp.CreatedDate <=EndDateUTC
AND  PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))

GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID 

union all 
--horse

SELECT amt.TicketSerialNumber, NULL  , SUM(amt.SalesCommAmount) , SUM(amt.SalesFactorAmount)  , 0 , 0  
FROM  
(  
 SELECT   PBT.TicketSerialNumber, zhp.TranHeaderID,  
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesCommAmount,0))  
  ELSE SUM(coalesce (zhp.SalesCommAmount,0))   
 END AS SalesCommAmount,   
 CASE WHEN BetTypeID = 'W-P'  
  THEN (coalesce (zhp.SalesFactorAmount,0))  
  ELSE SUM(coalesce (zhp.SalesFactorAmount,0))   
 END AS SalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT  
	 INNER JOIN  public.ztubt_horse_placedbettransactionlineitem  zhp ON PBT.TranHeaderID = zhp.TranHeaderID  
	 INNER JOIN (select Terdisplayid,LocID from public.ztubt_terminal zt) Ter ON PBT.TerDisplayID = Ter.TerDisplayID --AND TER.IsDeleted = 0   
	 where PBT.ProdID = 1 and 
	 (
	 	(zhp.CreatedDate >= StartDateUTC 
	 	 And zhp.CreatedDate <= EndDateUTC
	  	 AND PBT.TransactionTypeTotal In (1, 4, 6)) 
	  or 
	  	(PBT.TransactionTypeTotal In (3, 5))
	 )  
 GROUP BY PBT.TicketSerialNumber, zhp.TranHeaderID, zhp.CreatedDate::Date
 , BetTypeID, SalesCommAmount, SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber


union all 

--4D

select PBT.TicketSerialNumber, zdp.TranLineItemID, SUM(coalesce (zdp.SalesCommAmountBig,0)) SalesCommAmount, 
 SUM(coalesce (zdp.SalesFactorAmountBig,0)) SalesFactorAmount, SUM(coalesce (zdp.SalesCommAmountSmall,0)) SecondSalesCommAmount
, SUM(coalesce (zdp.SalesFactorAmountSmall,0)) SecondSalesFactorAmount  
 FROM  
	 ubt_temp_placebettransaction_type PBT   
	 INNER JOIN  public.ztubt_4d_placedbettransactionlineitemnumber zdp   ON zdp.TranHeaderID = PBT.TranHeaderID  
	 INNER JOIN  public.ztubt_drawdates zd ON zd.TranHeaderID = PBT.TranHeaderID --(7)  
 where PBT.ProdID = 2 and 
  ((zdp.CreatedDate >= StartDateUTC  And zdp.CreatedDate <=EndDateUTC
   AND PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5)) 
  AND PBT.IsExchangeTicket = false 
 GROUP BY PBT.TicketSerialNumber, zdp.TranLineItemID

union all 

--sweeep

SELECT  PBT.TicketSerialNumber, zspn.TranLineItemID, SUM(coalesce (zspn.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (zspn.SalesFactorAmount,0)) SalesFactorAmount, 0, 0  
FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
INNER JOIN public.ztubt_sweep_placedbettransactionlineitemnumber zspn   ON zsp.TranLineItemID = zspn.TranLineItemID AND zspn.IsSoldOut = FALSE 
INNER JOIN public.ztubt_placedbettransactionheaderlifecyclestate zpls   ON zpls.TranHeaderID = PBT.TranHeaderID 
 INNER JOIN (Select terdisplayid, Locid from public.ztubt_terminal ) Ter ON PBT.TerDisplayID = Ter.TerDisplayID 
 INNER JOIN (Select locid,locdisplayid,sweepindicator from public.ztubt_location ) Loc ON Ter.LocID = Loc.LocID 
WHERE PBT.ProdID=4  and 
( ((zsp.IsPrinted IS NOT NULL OR Loc.SweepIndicator IS NULL) AND zpls.BetStateTypeID = 'PB06' ) 	
	OR	( Loc.SweepIndicator IS NOT NULL  And zsp.IsPrinted IS NULL AND zpls.BetStateTypeID = 'PB03' ) )
and
((zspn.CreatedDate >= StartDateUTC And zspn.CreatedDate <= EndDateUTC

	AND PBT.TransactionTypeTotal In (1, 4, 6) ) or PBT.TransactionTypeTotal In (3,5))
	
GROUP BY PBT.TicketSerialNumber, zspn.TranLineItemID 

union all 
--Sports

select amt.TicketSerialNumber, NULL , SUM(coalesce (amt.SalesCommAmount,0)) SalesCommAmount, 
SUM(coalesce (amt.SalesFactorAmount,0)) SalesFactorAmount, 0 , 0  
FROM  
(  
 SELECT PBT.ProdID ProductName, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,   
	AccumulatorID, SalesCommAmount, TicketSerialNumber, SalesFactorAmount  
 FROM  
ubt_temp_placebettransaction_type PBT  
INNER JOIN  public.ztubt_sports_placedbettransactionlineitem zsp   ON PBT.TranHeaderID = zsp.TranHeaderID 
WHERE PBT.ProdID IN (5,6)
 AND
 PBT.IsBetRejectedByTrader=false 
 GROUP BY PBT.ProdID, PBT.TranHeaderID, SourceSystemTransactionID, IsSingleBet,
 AccumulatorID, SalesCommAmount, TicketSerialNumber, (zsp.CreatedDate :: date), SalesFactorAmount  
)amt  
GROUP BY amt.TicketSerialNumber
;

create index idx_ubt_resulsalescomwithdate_ticket on ubt_temp_resultsalescomwithdate(TicketSerialNumber);
create index idx_ubt_resulsalescomwithdate_tranlineitemid on ubt_temp_resultsalescomwithdate(TranLineItemID);


 create temporary table if not exists ubt_temp_resultsalesandcomm   
(  
 TicketSerialNumber VARCHAR(200),  
 TranLineItemID varchar(50),  
 Sales numeric(32, 12),  
 SecondSales numeric(32, 12),
 SalesComm numeric(22, 11),  
 SecondSalesComm numeric(22, 11)
)  
  ;
INSERT INTO ubt_temp_resultsalesandcomm  
SELECT FIN.TicketSerialNumber, FIN.TranLineItemID, SUM(FIN.SalesFactorAmount), 
SUM(FIN.SecondSalesFactorAmount), SUM(FIN.SalesCommAmount), SUM(FIN.SecondSalesCommAmount)  
FROM ubt_temp_resultsalescomwithdate FIN  
GROUP BY FIN.TicketSerialNumber, FIN.TranLineItemID  

;

create index idx_ubt_resulsalescom_ticket on ubt_temp_resultsalesandcomm(TicketSerialNumber);
create index idx_ubt_resulsalescom_tranlineitemid on ubt_temp_resultsalesandcomm(TranLineItemID);

---------------------------------------------------------  
--GST (OUTPUT GST = WAGER - SALES)  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultGST   
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
GST numeric(22, 11),  
SecondGST numeric(22, 11)
) ; 
   
--LOTTERY(2,3,4) and Horse(1) and Sports(5,6)

INSERT INTO ubt_temp_resultGST   
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber AND w.TranLineItemID = S.TranLineItemID  
WHERE w.ProdID IN (2, 3, 4) 
union all 
SELECT W.TicketSerialNumber, W.TranLineItemID, ROUND(coalesce (W.Wager,0) - coalesce (S.Sales,0) ,2), 
ROUND(coalesce (W.SecondWager,0) - coalesce (S.SecondSales,0), 2)  
FROM ubt_temp_resultwager W  
INNER JOIN ubt_temp_placebettransaction_type PBT ON W.TicketSerialNumber = PBT.TicketSerialNumber  
INNER JOIN ubt_temp_resultsalesandcomm S ON W.TicketSerialNumber = S.TicketSerialNumber 
WHERE w.ProdID IN (1,5,6) 

;

create index idx_ubt_resultGST_ticket on ubt_temp_resultGST(TicketSerialNumber);
create index idx_ubt_resultGST_tranlineitemid on ubt_temp_resultGST(TranLineItemID);

---------------------------------------------------------  
--VALIDATION  
---------------------------------------------------------  
create temporary table if not exists ubt_temp_resultvalidation 
(   
TicketSerialNumber VARCHAR(200),  
ReturnAmount numeric(22,2), 
WinningAmount numeric(22,2),
RefundAmount numeric(22,2), 
RebateReclaim numeric(22,2) 
)  
  
;
INSERT INTO ubt_temp_resultvalidation  
SELECT zv.TicketSerialNumber,   
zv.WinningAmount AS ReturnAmount,  
CASE WHEN coalesce(zv.WinningAmount, 0) > 0 THEN  
zv.WinningAmount - (SUM(RW.Wager)/coalesce (COUNT(RW.TicketSerialNumber),1)) - (SUM(RW.SecondWager)/coalesce(COUNT(RW.TicketSerialNumber),1)) --(6) 
ELSE  0
  
END AS WinningAmount, --(4)  
zv.RefundAmount, zv.RebateReclaim --(1)  
FROM ubt_temp_resultwager RW  
 INNER join public.ztubt_validatedbetticket zv   ON RW.TicketSerialNumber = zv.TicketSerialNumber  
 INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvlc   ON zv.TranHeaderID = zvlc.TranHeaderID AND zvlc.BetStateTypeID = 'VB06'  
 WHERE zv.ValidationTypeID IN ('VALD', 'RFND') --(1)  
 GROUP BY zv.TicketSerialNumber, zv.WinningAmount, zv.RefundAmount, zv.RebateReclaim
 
 ;

create index idx_ubt_resultvalidation_ticket on ubt_temp_resultvalidation(TicketSerialNumber);
 ---------------------------------------------------------  
--VALIDATION EXCHANGE TICKET  
---------------------------------------------------------  
  
create temporary table if not exists ubt_temp_resultvalidationexchange
(  
TicketSerialNumber VARCHAR(200),  
TranLineItemID varchar(50),  
WinningAmount numeric(22,2), 
RefundAmount numeric(22,2),  
RebateReclaim numeric(22,2) 
)  
;
 
INSERT INTO ubt_temp_resultvalidationexchange  
select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_4d_placedbettransactionlineitem zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=2 And PBT.IsExchangeTicket= true

union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_toto_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=3 And PBT.IsExchangeTicket= TRUE
   
union all 

select vb.TicketSerialNumber, zubt4d.TranLineItemID, vb.WinningAmount, vb.RefundAmount, vb.RebateReclaim  
FROM  public.ztubt_validatedbetticket vb
INNER JOIN public.ztubt_sweep_placedbettransactionlineitem  zubt4d   ON vb.TranHeaderID = zubt4d.TranHeaderID  
INNER JOIN public.ztubt_validatedbetticketlifecyclestate zvls   ON vb.TranHeaderID = zvls.TranHeaderID AND zvls.BetStateTypeID = 'VB06'  
INNER JOIN ubt_temp_placebettransaction_type PBT ON vb.TranHeaderID = PBT.TranHeaderID  
Where vb.ProdID=4 And PBT.IsExchangeTicket= TRUE

;

create index idx_ubt_resultvalidationexc_ticket on ubt_temp_resultvalidationexchange(TicketSerialNumber);
create index idx_ubt_resultvalidationexc_tranlinetiemid on ubt_temp_resultvalidationexchange(TranLineItemID);
---------------------------------------------------------  
--FINAL RESULT  
---------------------------------------------------------  

--HORSE RACING(1), lOTEERY(2,3,4), SPORTS(5,6)
 INSERT INTO ubt_temp_transactionamount  
SELECT W.TicketSerialNumber, W.TranLineItemID, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (2, 3, 4)
GROUP BY W.TicketSerialNumber, W.TranLineItemID  

union all
SELECT W.TicketSerialNumber, null, SUM(W.Wager), SUM(W.SecondWager), SUM(SC.Sales), SUM(SC.SecondSales), SUM(SC.SalesComm), SUM(SC.SecondSalesComm), SUM(G.GST), SUM(G.SecondGST), MAX(V.ReturnAmount), MAX(V.WinningAmount), MAX(V.RefundAmount), MAX(V.RebateReclaim) --(1)   --(S4)
FROM ubt_temp_resultwager W  
LEFT JOIN ubt_temp_resultsalesandcomm  SC ON W.TicketSerialNumber = SC.TicketSerialNumber --AND w.TranLineItemID = SC.TranLineItemID  --(S4)
LEFT JOIN ubt_temp_resultGST G ON W.TicketSerialNumber = G.TicketSerialNumber --AND W.TranLineItemID = G.TranLineItemID  
LEFT JOIN ubt_temp_resultvalidation V ON W.TicketSerialNumber = V.TicketSerialNumber  
WHERE ProdID IN (1, 5,6)
GROUP BY W.TicketSerialNumber  


union all 

select TicketSerialNumber, TranLineItemID, 0 AS Wager, 0 AS SecondWager, 0 AS Sales, 0 AS SecondSales, 
0 AS SalesCom, 0 AS SecondSalesCom, 0 AS GST, 0 AS SecondGST, WinningAmount, WinningAmount, RefundAmount, RebateReclaim  
FROM ubt_temp_resultvalidationexchange 

;

create index idx_ubt_transactionamt_ticket on ubt_temp_transactionamount(TicketSerialNumber);
create index idx_ubt_transactionamt_tranlineitemid on ubt_temp_transactionamount(TranLineItemID);

create temporary table if not exists ubt_temp_transactiondata
(
		--transid bigint  ,--primary key clustered,
		uuid varchar(33) ,
		transactiontype int4 ,
		productid int4 ,
		bettypeid varchar(2) ,
		selection text ,
		businessdate date ,
		transactiontimestamp timestamp ,
		terminalid varchar(100) ,
		userid varchar(100) ,
		locationid varchar(200) ,
		cartid varchar(50) ,
		tranheaderid varchar(50) ,
		boardseqnumber varchar(50) ,
		entrymethod int4 ,
		numboards int4 ,
		numdraws int ,
		drawid varchar(500) ,
		ebetslipinfo_mobnbr varchar(100) ,
		numsimplebets int4 ,
		qpflag int4 ,
		nummarks int4 ,
		bulkid varchar(50) ,
		itoto_numparts text ,
		itoto_totalparts text ,
		grptoto_numparts text ,
		eventid varchar(500) ,
		leaguecode varchar(500) ,
		liveindicator char(1) ,
		eventname text ,
		market text ,
		odds varchar(500) ,
		matchkickoff varchar(500) ,
		wager1 numeric(22, 2) ,
		wager2 numeric(22, 2) ,
		sales1 numeric(22, 11) ,
		sales2 numeric(22, 11) ,
		salescomm1 numeric(22, 11) ,
		salescomm2 numeric(22, 11) ,
		gst1 numeric(22, 11) ,
		gst2 numeric(22, 11) ,
		returnamount numeric(22, 2) ,
		winningamount numeric(22, 2) ,
		betlinerebateamount numeric(22, 2) ,
		paymentmode varchar(2) 
	)
;
create temporary table if not exists ubt_temp_final_lotteryselect
(  
	ticketserialnumber varchar(500),  
	tranlineitemid varchar(50),  
	selection text
)   
;
 --HORSE RACING  

INSERT INTO ubt_temp_final_lotteryselect  
SELECT PBT.TicketSerialNumber, NULL AS TranLineItemID,   
 string_agg(CAST(PL.BetLineAnnotation AS VARCHAR)  ,',') AS BetLineAnnotation 
 FROM ubt_temp_placebettransaction_type PBT  
 INNER JOIN public.ztubt_horse_placedbettransactionlineitem PL ON PBT.TranHeaderID = PL.TranHeaderID  
 WHERE  PBT.ProdID=1 and 
 ((PL.CreatedDate >= StartDateUTC And PL.CreatedDate <=EndDateUTC
 And PBT.TransactionTypeTotal In (1, 4, 6)) or PBT.TransactionTypeTotal In (3,5))
 GROUP BY PBT.TicketSerialNumber, PBT.TranHeaderID

--4D
 union all 
 
 select TicketSerialNumber, TranLineItemID, (pbtln.SelectedBetNumber :: varchar(10))   
from ubt_temp_placebettransaction_type PBT   
inner join public.ztubt_4d_placedbettransactionlineitemnumber  pbtln on PBT.TranHeaderID = pbtln.TranHeaderID
WHERE PBT.ProdID = 2 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))


union all 
--toto
select TicketSerialNumber, pbtln.TranLineItemID, string_agg((ztp.singleBetNumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT  
inner join public.ztubt_toto_placedbettransactionlineitem   pbtln on PBT.TranHeaderID = pbtln.TranHeaderID  
inner join public.ztubt_toto_placedbettransactionlineitemnumber ztp on pbtln.tranlineitemid =ztp.tranlineitemid 
WHERE PBT.ProdID = 3 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID

--sweep
union all 

select TicketSerialNumber, pbtln.TranLineItemID, string_agg((pbtln.selectednumber :: varchar(10)),' ') 
from ubt_temp_placebettransaction_type PBT
inner join public.ztubt_sweep_placedbettransactionlineitemnumber  pbtln on pbtln.tranheaderid =PBT.tranheaderid 
WHERE PBT.ProdID = 4 and 
((pbtln.CreatedDate >= StartDateUTC And pbtln.CreatedDate <=EndDateUTC
And PBT.TransactionTypeTotal In (1, 4, 6)) or  PBT.TransactionTypeTotal In (3,5))
group by TicketSerialNumber, pbtln.TranLineItemID


--sports

union all 

select pb.ticketserialnumber,   
 pln.tranlineitemid as tranlineitemid,  
 pln.selectionname as selection  
 from ubt_temp_placebettransaction_type ph   
 inner join public.ztubt_sports_placedbettransactionlineitemnumber  pln  on ph.tranheaderid = pln.tranheaderid
 inner join ubt_temp_placebettransaction_type pb on ph.ticketserialnumber = pb.ticketserialnumber --(2)  
 where pb.prodid in (5, 6)
 group by pb.ticketserialnumber, pln.tranlineitemid, pln.selectionname

;
 
create index idx_ubt_lotteryselect_ticket on ubt_temp_final_lotteryselect(ticketserialnumber);
create index idx_ubt_lotteryselect_tranlineitemid on ubt_temp_final_lotteryselect(tranlineitemid);
 --=====================================================================================  
---Transaction Data Interface table-----------------------------------------------------
 --=====================================================================================
 
 --LOTTERY (Per UUID and boards under one TSN)  
 insert into ubt_temp_transactiondata  
 select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid,  s.selection as selection,  
 case when t.transactiondate < igt_startdate then igt_previousbusinessdate 
 when t.transactiondate > igt_enddate then igt_nextbusinessdate
 else igt_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid, t.locationid, t.cartid, t.tranheaderid,  
 -----lottery section  
 coalesce(concat(t.uuid , ' - ' ,right(concat('00' , cast (ld.boardseqnumber as varchar)),2)), t.uuid) as boardseqnumber,  
 ld.entrymethod,   ld.numboards, ld.numdraws, ld.drawid,ld.ebetslipinfo_mobnbr, ld.numsimplebets,ld.qpflag,
 ld.nummarks,   ld.bulkid,  ld.itoto_numparts,ld.itoto_totalparts, ld.grptoto_numparts,    

 -----sports section  
 null, null, null, null, null, null, null,

 -----value amount section  
 coalesce(amt.wager, 0) as wager,   
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then   amt.returnamount  when transactiontype = 61 then amt.refundamount  else 0 end as returnamount,
 case when transactiontype = 3 then   amt.winningamount else 0 end as winningamount,  
  null,
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t
 --inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid   
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_Temp_LotteryDetail ld on t.ticketserialnumber = ld.ticketserialnumber and bt.tranlineitemnumberid = ld.tranlineitemid   
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber and ld.tranlineitemid = s.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber and ld.tranlineitemid = amt.tranlineitemid  
 where t.prodid in (2,3,4) and bettypeid is not null and t.isbetrejectedbytrader = false
 and (t.transactiondate between startdate and enddate) 
 --and pbvbcbtdis.transactiontypetotal in (3,5) 
  
 order by t.uuid  
 ; 
 insert into ubt_temp_transactiondata  
-- union all 
 
 --HORSE RACING (Per UUID)  

 select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 bt.bettypeid as bettypeid, --(19) bt.bettypeid as bettypeid,  
 s.selection as selection,  
  case when t.transactiondate < bmcs_startdate then bmcs_previousbusinessdate
	  when t.transactiondate > bmcs_enddate then bmcs_nextbusinessdate
	  else bmcs_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,  t.userid,t.locationid,t.cartid, t.tranheaderid,
   
 -----lottery section  
 t.uuid as boardseqnumber,  
 case t.entrymethodid  
  WHEN 'MANUAL' THEN 0  
  WHEN 'BETSLIP' THEN 2  
  WHEN 'EDIT' THEN 10  
  WHEN 'EBETSLIP' THEN 16  
 end as entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
 
 -----sports section   
 null,null,null,null,null,null,null,
 
 -----value amount section   
 coalesce(amt.wager, 0) as wager,  
 coalesce(amt.secondwager,0) as secondwager,  
 coalesce(amt.sales, 0) as sales,  
 coalesce(amt.secondsales,0) as secondsales,  
 coalesce(amt.salescomm,0) as salescomm,  
 coalesce(amt.secondsalescomm,0) as secondsalescomm,  
 coalesce(amt.gst,0) as gst,  
 coalesce(amt.secondgst,0) as secondgst,  
 case when transactiontype = 3 then   amt.returnamount  when transactiontype = 61 then amt.refundamount  else 0 end as returnamount,
 case when transactiontype = 3 then amt.winningamount else 0 end as winningamount,
 case when t.transactiontype = 3 then amt.rebatereclaim else coalesce(hd.betlinerebateamount,0)   end as betlinerebateamount, 
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 left join ubt_temp_bettype bt on t.ticketserialnumber = bt.ticketserialnumber  
 left join ubt_temp_HorseDetail hd on t.ticketserialnumber = hd.ticketserialnumber
 left join ubt_temp_final_lotteryselect s on t.ticketserialnumber = s.ticketserialnumber
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber 
 where t.prodid = 1 and t.isbetrejectedbytrader = false and (t.transactiondate::timestamp between startdate and enddate)
 order by t.uuid  

 ; insert into ubt_temp_transactiondata 
-- union all 
  --SPORTS (Per UUID)  For Bet Placement
 
 select  
 t.uuid,   t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 sd.bettype as bettypeid,  
 sd.selection as selection,  
  case when t.transactiondate < ob_startdate then ob_previousbusinessdate 
 when t.transactiondate > ob_enddate then ob_nextbusinessdate
 else ob_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid,   t.locationid,   t.cartid,   t.tranheaderid,  
 -----lottery section  
 t.uuid as boardseqnumber,   sd.entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
  -----sports section   
 sd.eventid,   sd.leaguecode,   sd.liveindicator,   sd.eventname,   sd.bettypename,  
 sd.selectionodds,   sd.starttime,  
 -----value amount section   
 amt.wager as wager,  
 amt.secondwager as secondwager,  
 pbtli.salesfactoramount as sales,
 amt.secondsales as secondsales,  
 coalesce(amt.salescomm, 0) as salescomm, 
 coalesce(amt.secondsalescomm,0) as secondsalescomm, 
 coalesce(amt.gst,0) as gst, 
 amt.secondgst as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount  else 0 end as returnamount, 
 case when transactiontype = 3 then amt.winningamount   else 0 end as winningamount,
  null as betlinerebateamount,  
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 inner join   public.ztubt_sports_placedbettransactionlineitem  pbtli on t.tranheaderid = pbtli.tranheaderid  
 inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid 
 left join ubt_temp_sportsdetail sd on t.ticketserialnumber = sd.ticketserialnumber and pbtli.tranlineitemid = sd.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber  
 where 
pbvbcbtdis.transactiontypetotal in (1,4,6) 
 and t.prodid in (5, 6) and t.isbetrejectedbytrader = false and ( t.transactiondate between startdate and enddate)
 order by t.uuid  
 ;
  insert into ubt_temp_transactiondata 
-- union all 
 
select  
 t.uuid,  t.transactiontype,  
 case t.prodid  
  when 1 then 7--horse racing  
  when 2 then 9--4d  
  when 4 then 11--sweep  
  when 3 then 23--toto 6/49  
  when 5 then 20--football/motor racing  
  when 6 then 20--football/motor racing  
 end as productid,  
 sd.bettype as bettypeid,   sd.selection as selection,  
 case when t.transactiondate < ob_startdate then ob_previousbusinessdate 
 when t.transactiondate > ob_enddate then ob_nextbusinessdate
 else ob_currentbusinessdate end as businessdate,
 t.transactiondate as transactiontimestamp,  
 t.terminalid,   t.userid,   t.locationid,   t.cartid,   t.tranheaderid,  
 -----lottery section  
 t.uuid as boardseqnumber,   sd.entrymethod,
 null,null,null,null,null,null,null,null,null,null,null,
  -----sports section   
 sd.eventid,   sd.leaguecode,   sd.liveindicator,   sd.eventname,   sd.bettypename,   
 sd.selectionodds,   sd.starttime,  
 -----value amount section   
 amt.wager as wager,  
 amt.secondwager as secondwager,  
 pbtli.salesfactoramount as sales,
 amt.secondsales as secondsales,  
 coalesce(amt.salescomm, 0) as salescomm, 
 coalesce(amt.secondsalescomm,0) as secondsalescomm, 
 coalesce(amt.gst,0) as gst, 
 amt.secondgst as secondgst,  
 case when transactiontype = 3 then amt.returnamount when transactiontype = 61 then amt.refundamount else 0  end as returnamount,
 case when transactiontype = 3 then amt.winningamount else 0  end as  winningamount,
 null as betlinerebateamount,  
 case when t.transactiontype = 3 and coalesce(amt.returnamount, 0) > 0 then 'CA' else '' end as paymentmode
 from ubt_temp_trans t  
 inner join public.ztubt_sports_placedbettransactionlineitem  pbtli on t.tranheaderid = pbtli.tranheaderid  
 inner join ubt_temp_placebettransaction_type pbvbcbtdis on t.tranheaderid = pbvbcbtdis.tranheaderid 
 left join ubt_temp_sportsdetail sd on t.ticketserialnumber = sd.ticketserialnumber and pbtli.tranlineitemid = sd.tranlineitemid  
 left join ubt_temp_transactionamount amt on t.ticketserialnumber = amt.ticketserialnumber  
 where pbvbcbtdis.transactiontypetotal in (3,5) 
 and t.prodid in (5, 6) and t.isbetrejectedbytrader = false and (t.transactiondate between startdate and enddate)
 order by t.uuid  

 ;
create index idx_ubt_transdata_uuid on  ubt_temp_transactiondata(uuid );
create index idx_ubt_transdata_productid  on  ubt_temp_transactiondata(productid );
create index idx_ubt_transdata_selection  on  ubt_temp_transactiondata(selection );
create index idx_ubt_transdata_businessdate  on  ubt_temp_transactiondata(businessdate );
create index idx_ubt_transdata_tranheaderid  on  ubt_temp_transactiondata(tranheaderid  );

--Interface table output-------
return query
	SELECT UUID ,
	TRANHEADERID,
	TRANSACTIONTYPE,
	PRODUCTID,
	BETTYPEID,
	SELECTION,
	BUSINESSDATE, 
	--TRANSACTIONTIMESTAMP,
	to_char(TRANSACTIONTIMESTAMP,'yyyy-MM-dd HH24:mi:ss') ::timestamp as TRANSACTIONTIMESTAMP, -- For FR include second 04 Apr 2022
	TERMINALID,
	USERID,
	LOCATIONID,
	BOARDSEQNUMBER,
	coalesce(ENTRYMETHOD,0),
	coalesce(NUMBOARDS,0),
	coalesce(NUMDRAWS,0),
	coalesce(DRAWID,''),
	coalesce(EBETSLIPINFO_MOBNBR,''),
	coalesce(NUMSIMPLEBETS,0),
	coalesce(QPFLAG,0),
	coalesce(NUMMARKS,0),
	coalesce(BULKID,'') ,
	coalesce(ITOTO_NUMPARTS,''),
	ITOTO_TOTALPARTS,
	GRPTOTO_NUMPARTS,
	EVENTID,
	LEAGUECODE, 
	LIVEINDICATOR,
	EVENTNAME,
	MARKET,
	ODDS,
	MATCHKICKOFF,
	WAGER1,
	WAGER2,
	SALES1,
	SALES2,
	SALESCOMM1,
	SALESCOMM2,
	GST1,
	coalesce(GST2,0),
	RETURNAMOUNT,
	WINNINGAMOUNT, 
	PAYMENTMODE, 
	CARTID ,
	coalesce(BETLINEREBATEAMOUNT,0)
			from ubt_temp_transactiondata
			where TransactionTimestamp >= StartDate
			and TransactionTimestamp <= EndDate
	 ;

drop table 	ubt_temp_placebettransaction_type;
drop table	ubt_temp_LotteryDraw;
drop table	ubt_temp_numdraws;
--drop table	ubt_Temp_LotteryDetail;
drop table	ubt_temp_NumBoards;
drop table	ubt_temp_HorseDetail;
drop table	ubt_temp_TotoSeq;
drop table	ubt_Temp_TotoGroup;
drop table	ubt_temp_Liveindidcator;
drop table	ubt_temp_sportsdetail;
--drop table	ubt_temp_placebettransaction;
drop table	ubt_temp_bettype;
--drop table	ubt_temp_trans;
drop table	ubt_temp_transactionamount;
drop table	ubt_temp_resultwager;
drop table	ubt_temp_resultsalescomwithdate;
drop table	ubt_temp_resultsalesandcomm ;
drop table	ubt_temp_resultGST;
drop table	ubt_temp_resultvalidation;
drop table	ubt_temp_resultvalidationexchange;
drop table	ubt_temp_transactiondata;
drop table	ubt_temp_final_lotteryselect;

END;
$$;


ALTER FUNCTION public.sp_ubt_gettransactiondataforinterval_test61(startdatetime timestamp without time zone, enddatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1218 (class 1255 OID 2384811)
-- Name: sp_ubt_gettransamountdetails(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) 
RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

	status_pnqr text[];
	status_pnric text[];
	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));
begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || zp.prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid IN (1,2,3,4,5)
    	union all
    	select 'TOTO MATCH' AS prodname
	) zp
	cross join ztubt_validationtype zv;

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid, zp.prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid IN (1,2,3,4,5)
    	union all
    	select 'TOTO MATCH' AS prodname
	) zp;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbtlin.bettypeid != ALL(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)

		union all
		-- TOTO MATCH ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO MATCH' ProdName
		, 'SAL' Flag
		,(trunc(coalesce(salescomtotal,0)/100,2) - trunc(coalesce(salescomamt,0)/100,2))*100 as salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(case when pbtlin.bettypeid != ALL(v_totomatchBettypes) then pbtlin.salescommamount else 0 end) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		, sum(pbtlin.salescommamount) as salescomtotal
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		-- and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 --wf 20230705 check lifecycle state of PB06 begin: 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 		--wf 20230705 end
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
	     --wf 20230705 check lifecycle state of PB06 begin:
		and pbthlcs.betstatetypeid = 'PB06'
		--wf 20230705 end
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and pbtlin.bettypeid != ALL(v_totomatchBettypes)
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all 
		-- TOTO MATCH ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO MATCH' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where zv.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH' 
			else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (2,3,4)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (5,6)
				)
			--wf: 230517 update to segragate time range condition by product
			--and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end as prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end 
		)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO', 'TOTO MATCH')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		 
		union all 
		
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		------ Paynow, PaynowQR ------
		union all
		
		select zt.terdisplayid
		, 'Paynow [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(-zp.netamount + zp.transactionfee) as CASAmount -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		
		select zt.terdisplayid
		, 'PaynowQR [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.netamount + zp.transactionfee) as CASAmount  -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNow
		select zt.terdisplayid
		, 'Paynow'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNowQR
		select zt.terdisplayid
		, 'PaynowQR'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all

	-- COL Gate Admission
		 select 
		 zt.terdisplayid
		, 'Gate Admission' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid
		)sq
		on (zt.terdisplayid = sq.terdisplayid)

		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then a.amount else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, round(sum(amount)*zg.gstrate*0.01,2) amount
					, sum(TicketCount) TicketCount
					from ubt_temp_trans_amt tt
					inner join public.ztubt_gstconfig zg
					on ((tt.actualDate between zg.effectivefrom and zg.enddate)
					or (tt.actualDate >= zg.effectivefrom and zg.enddate is null))
					where flag='SAL' and prodname <> 'TOTO MATCH'
					group by terdisplayid, prodname,actualDate,flag,zg.gstrate

					union all
					
					select terdisplayid, 'TOTO MATCH' as prodname,actualDate, flag
					, round((sum(amount)*zg.gstrate*0.01),2)- round((sum(case when prodname = 'TOTO' then amount*zg.gstrate*0.01 else 0 end)),2)  amount
					, sum(case when prodname='TOTO MATCH' then TicketCount else 0 end) TicketCount
					from ubt_temp_trans_amt tt
					inner join public.ztubt_gstconfig zg
					on ((tt.actualDate between zg.effectivefrom and zg.enddate)
					or (tt.actualDate >= zg.effectivefrom and zg.enddate is null))
					where flag='SAL' and prodname in ('TOTO MATCH','TOTO')
					group by terdisplayid,actualDate,flag,zg.gstrate
					) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_totofo_can_tktcount as
		select terdisplayid, sum(totofo_ticketCount) totofo_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) totofo_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
			
	update ubt_temp_trans_amt a set ticketcount = tc.totofo_ticketCount
	from ubt_temp_totofo_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid
	and a.prodname = 'TOTO MATCH'
	and a.flag = 'CAN' ;

	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temp table ubt_temp_totofo_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) totofo_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO MATCH'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.totofo_sal_count
	from ubt_temp_totofo_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;

	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname in ('Offline Orders', 'Gate Admission') then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_totofo_sal_count;
drop table ubt_temp_totofo_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1125 (class 1255 OID 24811)
-- Name: sp_ubt_gettransamountdetails_bk20240314(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_bk20240314(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (2,3,4)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (5,6)
				)
			--wf: 230517 update to segragate time range condition by product
			--and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid , zp.prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, zp.prodname )sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		union all 
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDateany()
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then round(a.amount*zg.gstrate*0.01,2) else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, sum(amount) amount , sum(TicketCount) TicketCount 
					from ubt_temp_trans_amt where flag='SAL'
					group by terdisplayid, prodname,actualDate,flag) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_bk20240314(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1134 (class 1255 OID 2005631)
-- Name: sp_ubt_gettransamountdetails_bk20241010(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_bk20241010(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

	status_pnqr text[];
	status_pnric text[];
begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 --wf 20230705 check lifecycle state of PB06 begin: 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 		--wf 20230705 end
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
	     --wf 20230705 check lifecycle state of PB06 begin:
		and pbthlcs.betstatetypeid = 'PB06'
		--wf 20230705 end
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (2,3,4)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (5,6)
				)
			--wf: 230517 update to segragate time range condition by product
			--and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid , zp.prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, zp.prodname )sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		 
		union all 
		
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		------ Paynow, PaynowQR ------
		union all
		
		select zt.terdisplayid
		, 'Paynow [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(-zp.netamount + zp.transactionfee) as CASAmount -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		
		select zt.terdisplayid
		, 'PaynowQR [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.netamount + zp.transactionfee) as CASAmount  -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNow
		select zt.terdisplayid
		, 'Paynow'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNowQR
		select zt.terdisplayid
		, 'PaynowQR'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then round(a.amount*zg.gstrate*0.01,2) else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, sum(amount) amount , sum(TicketCount) TicketCount 
					from ubt_temp_trans_amt where flag='SAL'
					group by terdisplayid, prodname,actualDate,flag) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_bk20241010(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1198 (class 1255 OID 2378923)
-- Name: sp_ubt_gettransamountdetails_bk20250310(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_bk20250310(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

	status_pnqr text[];
	status_pnric text[];
	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));
begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || zp.prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid IN (1,2,3,4,5)
    	union all
    	select 'TOTO MATCH' AS prodname
	) zp
	cross join ztubt_validationtype zv;

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid, zp.prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid IN (1,2,3,4,5)
    	union all
    	select 'TOTO MATCH' AS prodname
	) zp;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbtlin.bettypeid != ALL(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)

		union all
		-- TOTO MATCH ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO MATCH' ProdName
		, 'SAL' Flag
		,(trunc(coalesce(salescomtotal,0)/100,2) - trunc(coalesce(salescomamt,0)/100,2))*100 as salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(case when pbtlin.bettypeid != ALL(v_totomatchBettypes) then pbtlin.salescommamount else 0 end) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		, sum(pbtlin.salescommamount) as salescomtotal
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		-- and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 --wf 20230705 check lifecycle state of PB06 begin: 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 		--wf 20230705 end
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
	     --wf 20230705 check lifecycle state of PB06 begin:
		and pbthlcs.betstatetypeid = 'PB06'
		--wf 20230705 end
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and pbtlin.bettypeid != ALL(v_totomatchBettypes)
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all 
		-- TOTO MATCH ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO MATCH' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where zv.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH' 
			else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (2,3,4)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (5,6)
				)
			--wf: 230517 update to segragate time range condition by product
			--and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end as prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end 
		)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO', 'TOTO MATCH')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		 
		union all 
		
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		------ Paynow, PaynowQR ------
		union all
		
		select zt.terdisplayid
		, 'Paynow [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(-zp.netamount + zp.transactionfee) as CASAmount -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		
		select zt.terdisplayid
		, 'PaynowQR [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.netamount + zp.transactionfee) as CASAmount  -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNow
		select zt.terdisplayid
		, 'Paynow'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNowQR
		select zt.terdisplayid
		, 'PaynowQR'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then a.amount else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, round(sum(amount)*zg.gstrate*0.01,2) amount
					, sum(TicketCount) TicketCount
					from ubt_temp_trans_amt tt
					inner join public.ztubt_gstconfig zg
					on ((tt.actualDate between zg.effectivefrom and zg.enddate)
					or (tt.actualDate >= zg.effectivefrom and zg.enddate is null))
					where flag='SAL' and prodname <> 'TOTO MATCH'
					group by terdisplayid, prodname,actualDate,flag,zg.gstrate

					union all
					
					select terdisplayid, 'TOTO MATCH' as prodname,actualDate, flag
					, round((sum(amount)*zg.gstrate*0.01),2)- round((sum(case when prodname = 'TOTO' then amount*zg.gstrate*0.01 else 0 end)),2)  amount
					, sum(case when prodname='TOTO MATCH' then TicketCount else 0 end) TicketCount
					from ubt_temp_trans_amt tt
					inner join public.ztubt_gstconfig zg
					on ((tt.actualDate between zg.effectivefrom and zg.enddate)
					or (tt.actualDate >= zg.effectivefrom and zg.enddate is null))
					where flag='SAL' and prodname in ('TOTO MATCH','TOTO')
					group by terdisplayid,actualDate,flag,zg.gstrate
					) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_totofo_can_tktcount as
		select terdisplayid, sum(totofo_ticketCount) totofo_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) totofo_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
			
	update ubt_temp_trans_amt a set ticketcount = tc.totofo_ticketCount
	from ubt_temp_totofo_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid
	and a.prodname = 'TOTO MATCH'
	and a.flag = 'CAN' ;

	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temp table ubt_temp_totofo_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) totofo_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO MATCH'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.totofo_sal_count
	from ubt_temp_totofo_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;

	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_totofo_sal_count;
drop table ubt_temp_totofo_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_bk20250310(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1192 (class 1255 OID 2377182)
-- Name: sp_ubt_gettransamountdetails_bk20250326(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_bk20250326(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

	status_pnqr text[];
	status_pnric text[];
	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));
begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || zp.prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid IN (1,2,3,4,5)
    	union all
    	select 'TOTO MATCH' AS prodname
	) zp
	cross join ztubt_validationtype zv;

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid, zp.prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid IN (1,2,3,4,5)
    	union all
    	select 'TOTO MATCH' AS prodname
	) zp;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbtlin.bettypeid != ALL(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)

		union all
		-- TOTO MATCH ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO MATCH' ProdName
		, 'SAL' Flag
		,(trunc(coalesce(salescomtotal,0)/100,2) - trunc(coalesce(salescomamt,0)/100,2))*100 as salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(case when pbtlin.bettypeid != ALL(v_totomatchBettypes) then pbtlin.salescommamount else 0 end) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		, sum(pbtlin.salescommamount) as salescomtotal
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		-- and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 --wf 20230705 check lifecycle state of PB06 begin: 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 		--wf 20230705 end
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
	     --wf 20230705 check lifecycle state of PB06 begin:
		and pbthlcs.betstatetypeid = 'PB06'
		--wf 20230705 end
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and pbtlin.bettypeid != ALL(v_totomatchBettypes)
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all 
		-- TOTO MATCH ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO MATCH' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where zv.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH' 
			else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (2,3,4)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (5,6)
				)
			--wf: 230517 update to segragate time range condition by product
			--and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end as prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end 
		)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO', 'TOTO MATCH')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		 
		union all 
		
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		------ Paynow, PaynowQR ------
		union all
		
		select zt.terdisplayid
		, 'Paynow [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(-zp.netamount + zp.transactionfee) as CASAmount -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		
		select zt.terdisplayid
		, 'PaynowQR [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.netamount + zp.transactionfee) as CASAmount  -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNow
		select zt.terdisplayid
		, 'Paynow'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNowQR
		select zt.terdisplayid
		, 'PaynowQR'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then a.amount else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, round(sum(amount)*zg.gstrate*0.01,2) amount
					, sum(TicketCount) TicketCount
					from ubt_temp_trans_amt tt
					inner join public.ztubt_gstconfig zg
					on ((tt.actualDate between zg.effectivefrom and zg.enddate)
					or (tt.actualDate >= zg.effectivefrom and zg.enddate is null))
					where flag='SAL' and prodname <> 'TOTO MATCH'
					group by terdisplayid, prodname,actualDate,flag,zg.gstrate

					union all
					
					select terdisplayid, 'TOTO MATCH' as prodname,actualDate, flag
					, round((sum(amount)*zg.gstrate*0.01),2)- round((sum(case when prodname = 'TOTO' then amount*zg.gstrate*0.01 else 0 end)),2)  amount
					, sum(case when prodname='TOTO MATCH' then TicketCount else 0 end) TicketCount
					from ubt_temp_trans_amt tt
					inner join public.ztubt_gstconfig zg
					on ((tt.actualDate between zg.effectivefrom and zg.enddate)
					or (tt.actualDate >= zg.effectivefrom and zg.enddate is null))
					where flag='SAL' and prodname in ('TOTO MATCH','TOTO')
					group by terdisplayid,actualDate,flag,zg.gstrate
					) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_totofo_can_tktcount as
		select terdisplayid, sum(totofo_ticketCount) totofo_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) totofo_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
			
	update ubt_temp_trans_amt a set ticketcount = tc.totofo_ticketCount
	from ubt_temp_totofo_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid
	and a.prodname = 'TOTO MATCH'
	and a.flag = 'CAN' ;

	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temp table ubt_temp_totofo_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) totofo_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO MATCH'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.totofo_sal_count
	from ubt_temp_totofo_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;

	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_totofo_sal_count;
drop table ubt_temp_totofo_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_bk20250326(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1114 (class 1255 OID 24814)
-- Name: sp_ubt_gettransamountdetails_bkp080422(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_bkp080422(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join public.ztubt_getbusinessdate_perhost zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join public.ztubt_getbusinessdate_perhost zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join public.ztubt_getbusinessdate_perhost zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join public.ztubt_getbusinessdate_perhost zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN public.ztubt_getbusinessdate_perhost GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join public.ztubt_getbusinessdate_perhost zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			and zgp.host = 3)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				)
			and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid , zp.prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, zp.prodname )sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		union all 
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
	, sum(amount) amount, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
			, a.TicketCount, a.actualDate
			from ubt_temp_trans_amt a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_gst_sal;
end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_bkp080422(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO consultant01;

--
-- TOC entry 1115 (class 1255 OID 24817)
-- Name: sp_ubt_gettransamountdetails_bkp_060422(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_bkp_060422(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join public.ztubt_getbusinessdate_perhost zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join public.ztubt_getbusinessdate_perhost zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join public.ztubt_getbusinessdate_perhost zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		-- inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		-- 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join public.ztubt_getbusinessdate_perhost zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		--and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join public.ztubt_getbusinessdate_perhost zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			and zgp.host = 3)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				)
			and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3,4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid , zp.prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3,4)
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, zp.prodname )sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO','SINGAPORE SWEEP')
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		union all 
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
	, sum(amount) amount, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
			, a.TicketCount, a.actualDate
			from ubt_temp_trans_amt a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_gst_sal;
end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_bkp_060422(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO consultant01;

--
-- TOC entry 1138 (class 1255 OID 550947)
-- Name: sp_ubt_gettransamountdetails_bkup_230517(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_bkup_230517(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				)
			and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid , zp.prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, zp.prodname )sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		union all 
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then round(a.amount*zg.gstrate*0.01,2) else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, sum(amount) amount , sum(TicketCount) TicketCount 
					from ubt_temp_trans_amt where flag='SAL'
					group by terdisplayid, prodname,actualDate,flag) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;

	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_bkup_230517(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO postgres;

--
-- TOC entry 1274 (class 1255 OID 1333799)
-- Name: sp_ubt_gettransamountdetails_bkup_240506(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_bkup_240506(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

	status_pnqr text[];
	status_pnric text[];
begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (2,3,4)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (5,6)
				)
			--wf: 230517 update to segragate time range condition by product
			--and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid , zp.prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, zp.prodname )sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		 
		union all 
		
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		------ Paynow, PaynowQR ------
		union all
		
		select zt.terdisplayid
		, 'Paynow [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(-zp.netamount + zp.transactionfee) as CASAmount -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		
		select zt.terdisplayid
		, 'PaynowQR [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.netamount + zp.transactionfee) as CASAmount  -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNow
		select zt.terdisplayid
		, 'Paynow'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNowQR
		select zt.terdisplayid
		, 'PaynowQR'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then round(a.amount*zg.gstrate*0.01,2) else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, sum(amount) amount , sum(TicketCount) TicketCount 
					from ubt_temp_trans_amt where flag='SAL'
					group by terdisplayid, prodname,actualDate,flag) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_bkup_240506(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO postgres;

--
-- TOC entry 1163 (class 1255 OID 2228335)
-- Name: sp_ubt_gettransamountdetails_testgst(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gettransamountdetails_testgst(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

	status_pnqr text[];
	status_pnric text[];
	v_tfogBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettfogbettypes()));
begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || zp.prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid IN (1,2,3,4,5)
    	union all
    	select 'TFOG' AS prodname
	) zp
	cross join ztubt_validationtype zv;

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid, zp.prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid IN (1,2,3,4,5)
    	union all
    	select 'TFOG' AS prodname
	) zp;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;
	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbtlin.bettypeid != ALL(v_tfogBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)

		union all
		-- TFOG ProdID=3 SAL
		select tl.terdisplayid
		, 'TFOG' ProdName
		, 'SAL' Flag
		,(trunc(coalesce(salescomtotal,0)/100,2) - trunc(coalesce(salescomamt,0)/100,2))*100 as salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(case when pbtlin.bettypeid != ALL(v_tfogBettypes) then pbtlin.salescommamount else 0 end) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		, sum(pbtlin.salescommamount) as salescomtotal
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		-- and pbtlin.bettypeid = ANY(v_tfogBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 --wf 20230705 check lifecycle state of PB06 begin: 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 		--wf 20230705 end
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
	     --wf 20230705 check lifecycle state of PB06 begin:
		and pbthlcs.betstatetypeid = 'PB06'
		--wf 20230705 end
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
--------------------------------------------------------------------------------------------------
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and pbtlin.bettypeid != ALL(v_tfogBettypes)
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all 
		-- TFOG ProdID=3 COL
		select tl.terdisplayid
		, 'TFOG' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and pbtlin.bettypeid = ANY(v_tfogBettypes)
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
-- 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
--		, actualdate
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
	--		 left outer join public.ztubt_getbusinessdate_perhost zgp 
	-- 			on (pbtlin.createdDate between zgp.previousperioddatetime and zgp.perioddatetime
	-- 			and zgp.host = 3)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
--		, zgp.actualdate
		) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
------------------------------------------------------------------------------------------------		
	-- PAY
		select 
		 tpv.terDisplayID
		,tpv.prodname
		,'PAY' Flag
		, (total_amount) PAYAmount
		, ticketCount
		, null actualDate
		from ubt_temp_ter_prod_val tpv left outer join (
			select terdisplayid
			,"types" || '-' || prodname as prodname
			, sum(total_amount) total_amount
			, count(total_amount) ticketCount
			from (
			select zv.terdisplayid 
			, case when zp.prodid in (5,6) then 'SPORTS' 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where zv.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_tfogBettypes)
               ) then 'TFOG' 
			else trim(zp.prodname) end as prodname
			, zp.prodid
			, zv.winningamount , zv.rebateamount , zv.refundamount 
			from ztubt_validatedbetticket zv 
			inner join ztubt_product zp on (zv.prodid=zp.prodid)
			inner join ztubt_validatedbetticketlifecyclestate zvlc 
				on (zv.tranheaderid = zvlc.tranheaderid and zvlc.betstatetypeid = 'VB06')
			where 1=1
			and (--bmcs
				(zv.createdvalidationdate >=vUTCFromDateTimeBMCS 
				and zv.createdvalidationdate < vUTCToDateTimeBMCS
				and zvlc.captureddate between vUTCFromDateTimeBMCS::date -1 and vUTCToDateTimeBMCS::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (1)
			  or -- igt
			  	(zv.createdvalidationdate >=vUTCFromDateTimeIGT
				and zv.createdvalidationdate < vUTCToDateTimeIGT 
				and zvlc.captureddate between vUTCFromDateTimeIGT::date -1 and vUTCToDateTimeIGT::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (2,3,4)
			  or -- ob
			  	(zv.createdvalidationdate >=vUTCFromDateTimeOB
				and zv.createdvalidationdate < vUTCToDateTimeOB
				and zvlc.captureddate between vUTCFromDateTimeOB::date -1 and vUTCToDateTimeOB::date +1)
				--wf: 230517 update to segragate time range condition by product
				and zv.prodid in (5,6)
				)
			--wf: 230517 update to segragate time range condition by product
			--and zv.prodid in (1,2,3,4,5,6)
			)sub1 
			cross join lateral ( -- Unpivoting
			values ('VALIDATED',sub1.WinningAmount),
			('LOSING BET REBATE',sub1.RebateAmount),
			('REFUNDED',sub1.RefundAmount) ) unpvot (types,	total_amount)
			where 1=1
			and total_amount<>0
			group by terdisplayid ,"types" || '-' || prodname 
		) sq on (tpv.terdisplayid = sq.terdisplayid and tpv.prodname = sq.prodname)
--		where total_amount <>0
--		group by  tpv.terDisplayID,tpv.prodname

		union all
		
		-- HorseRacing ProdID=1 PAY 'LOSING BET REBATE-HORSE RACING'
		select 
		  tl.terdisplayid as TerDisplayID
		, 'LOSING BET REBATE-HORSE RACING' ProdName
		, 'PAY' Flag
		, Round(sum(COLAmount),2) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbtlin.terdisplayid
--			, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.boardrebateamount ,0)/2
					else coalesce(pbtlin.boardrebateamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
--			 left outer join public.ztubt_getbusinessdate_perhost zgp 
--	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS  --bmcsutc
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS 
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid
--			, zgp.actualdate
			) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
--		, actualdate
		
	-- PAY
	
		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_tfogBettypes)
               ) then 'TFOG'
			else zp.prodname
		end as prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_tfogBettypes)
               ) then 'TFOG'
			else zp.prodname
		end 
		)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO', 'TFOG')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'
		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		union all
------------------------------------------------------------------------------------------------
	-- CAS
		select zt.terdisplayid
		, 'NETS' as prodname
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NC','NN')
		and zp.createddate >= vUTCFromDateTimeNH  --nhutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid ) sq
		 on (zt.terdisplayid=sq.terdisplayid)
		 
		union all 
		
		select zt.terdisplayid
		, 'CASHCARD/Flashpay'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select terdisplayid 
		, sum(paidamount) as CASAmount 
		, count(distinct paymentdetailid) as TicketCount 
		from public.ztubt_paymentdetail zp where 1=1
		and paymenttypeid in ('NCC','NFP')
		and zp.createddate >= vUTCFromDateTimeNH  --nonhostsutc
		and zp.createddate < vUTCToDateTimeNH
		group by terdisplayid  )sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		------ Paynow, PaynowQR ------
		union all
		
		select zt.terdisplayid
		, 'Paynow [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(-zp.netamount + zp.transactionfee) as CASAmount -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		
		select zt.terdisplayid
		, 'PaynowQR [+trans fee]'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.netamount + zp.transactionfee) as CASAmount  -- netamount + transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNow
		select zt.terdisplayid
		, 'Paynow'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNRIC'
		and zp.transactionstatus = any(status_pnric)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		union all
		-- transfee PayNowQR
		select zt.terdisplayid
		, 'PaynowQR'
		, 'CAS' Flag
		, CASAmount
		, TicketCount
		, null AcutalDate
		from ztubt_terminal zt left outer join (
		select 
		zt.terdisplayid 
		, sum(zp.transactionfee) as CASAmount  -- transfee
		, count(distinct paymentdetailid) as TicketCount 
		from ztubt_terminal zt 
		left outer join ztubt_cart zc on zt.terdisplayid = zc.terdisplayid 
		left outer join ztubt_paynowtransaction zp on zc.cartid = zp.cartid 
		where zp.paymenttypeid = 'PNQR'
		and zp.transactionstatus = any(status_pnqr)
		and zp.updateddatetime >= vFromDateTimeIGT --use updateddatetime instead of transactiondate 
		and zp.updateddatetime < vToDateTimeIGT
		group by zt.terdisplayid  ) sq
		on (zt.terdisplayid=sq.terdisplayid)
		
		
	-- CAS
		union all
------------------------------------------------------------------------------------------------		
	-- COL Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'COL' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_charitytickettransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=1
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_totohongbaotransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)
	
	-- COL Offline Orders
		union all
------------------------------------------------------------------------------------------------		
	
	-- RFD Offline Orders
		 select 
		 zt.terdisplayid
		, 'Offline Orders' as prodname
		, 'RFD' Flag
		, oo_col_amount
		, TicketCount
		, null AcutalDate
		 from ztubt_terminal zt left outer join (
		 select pb.terdisplayid 
		 , sum(pbt.amount) oo_col_amount
		 , count(1) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_admissionvouchertransaction pbt
		 	on (pb.transactionheaderid = pbt.headerid)
		where 1=1
		and pbt.isactive=true 
		and pbt.transactiontype in (2,3)
		and pb.transactiontime >= vFromDateTimeNH --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_spatransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		union all 
		 select pb.terdisplayid 
		 , sum(pbt.totalAmount * pbt.repeatedTicket) oo_col_amount
		 , sum(pbt.repeatedTicket) TicketCount
		 from ztubt_offlineproductheader pb 
		 inner join ztubt_topupcardtransaction pbt 
			on (pb.transactionheaderid = pbt.headerid )
		where 1=1
		and pbt.transactiontype=2
		and pb.transactiontime >= vFromDateTimeNH  --nonhostsutc
		and pb.transactiontime < vToDateTimeNH
		group by pb.terdisplayid 
		)sq
		on (zt.terdisplayid = sq.terdisplayid)	
		
		union all
------------------------------------------------------------------------------------------------
		
		-- FUN & REC
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'FUN' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zf.fundperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zf.fundperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Funding and Recovery' prodname,
			'REC' flag,
			sum(fundingamount) fundingamount,
			0 ticketCount,
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid, sum(coalesce(zf.fundingamount,0)) fundingamount from 
		ztubt_location zl inner join ztubt_funding zf on (zf.locid = zl.locid)
		inner join ztubt_recovery zr on (zr.fundingid=zf.fundingid)
		where 1=1
		and zl.loctypeid in (2,4)
		and cast(zr.recperiodstart as date) = vFromDateFUND -- fundingdt
		and cast(zr.recperiodend as date) = vToDateFUND
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'FUN' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='C')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid
		union all
		select 
			zt.terdisplayid,
			'Online Adjustment' prodname,
			'REC' flag,
			sum(adjustmentAmount) adjustmentAmount,
			sum(ticketCount),
			null actualDate
		from ztubt_terminal zt left outer join (
		select zl.locid
		, sum(coalesce(za.adjustmentAmount,0)) adjustmentAmount 
		, count(za.adjustinvoiceid) ticketCount
		from 
		ztubt_location zl inner join ztubt_adjustinvoice za on (za.locid = zl.locid)
		inner join ztubt_lookupvalueconfig lkp on (za.adjustmentcode::varchar=lkp.fld1value 
			and lkp.configname='RTMS_AdjustmentCode' and left(lkp.fld2value,1)='D')
		where 1=1
		and za.createddatetime >= vFromDateTimeNH  --nonhost
		and za.createddatetime < vToDateTimeNH 
		and za.approvalstatus =1
		group by zl.locid) sq
		on (zt.locid=sq.locid)
		group by zt.terdisplayid

		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
--			, case when zlh.isgst = true then round(a.amount*zg.gstrate*0.01,2) 
			  , case when zlh.isgst = true then a.amount*zg.gstrate*0.01
			  else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, sum(amount) amount , sum(TicketCount) TicketCount 
					from ubt_temp_trans_amt where flag='SAL'
					group by terdisplayid, prodname,actualDate,flag) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
				and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;


	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_tfogBettypes)
			and ztp.groupunitsequence is null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_tfogBettypes)
			and ztp.groupunitsequence is not null
	--		and fin.terdisplayid = '211802001'
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_totofo_can_tktcount as
		select terdisplayid, sum(totofo_ticketCount) totofo_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) totofo_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_tfogBettypes)
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_tfogBettypes)
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
			
	update ubt_temp_trans_amt a set ticketcount = tc.totofo_ticketCount
	from ubt_temp_totofo_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid
	and a.prodname = 'TFOG'
	and a.flag = 'CAN' ;

	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.toto_sal_count
	from ubt_temp_toto_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;
	
	create temp table ubt_temp_totofo_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) totofo_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TFOG'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	update ubt_temp_trans_amt a set ticketcount = tsc.totofo_sal_count
	from ubt_temp_totofo_sal_count tsc
	where a.terdisplayid = tsc.terdisplayid 
	and a.prodname = tsc.prodname
	and a.flag = 'SAL' ;

	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay', 'Paynow [+trans fee]', 'PaynowQR [+trans fee]') then 'CL'
			when prodname in ('Paynow','PaynowQR') then 'TF'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
--	union all
--	select tp.terdisplayid, tp.prodname, 'GST' flag
--		, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
--		, sq.actualDate
--		, 'CH' TransType
--	from ubt_temp_ter_prod tp left outer join (
--		select 
--		  a.terdisplayid, a.prodname, 'GST' flag
--		, case when zlh.isgst = true then round(a.amount*zg.gstrate *0.01,2) else 0 end amount
--		, a.TicketCount, a.actualDate
--		from ubt_temp_trans_final a 
--		inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
--		inner join public.ztubt_gstconfig zg 
--			on ((a.actualDate between zg.effectivefrom and zg.enddate)
--			 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
--		left outer join public.ztubt_locationgsthistory zlh 
--			on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate)
--		where 1=1
--		and a.flag='SAL'
--		and zlh.isdeleted = false 
--		)sq 
--	on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_totofo_sal_count;
drop table ubt_temp_totofo_can_tktcount;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gettransamountdetails_testgst(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1116 (class 1255 OID 24820)
-- Name: sp_ubt_gtad_dr_summarybychain(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gtad_dr_summarybychain(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;
	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid, prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid in (1,2,3,4,5)
    	union all
    	select 'TOTO MATCH' AS prodname
	) zp;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);

	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate::date 
	from(
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbtlin.bettypeid != ALL(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		--totomatch ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO MATCH' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
		) sq
		on (tl.terdisplayid = sq.terdisplayid)

		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid,
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end as prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end  
		)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO', 'TOTO MATCH')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'

		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;

	create temp table ubt_temp_totofo_can_tktcount as
		select terdisplayid, sum(totofo_ticketCount) totofo_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) totofo_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
			
	update ubt_temp_trans_amt a set ticketcount = tc.totofo_ticketCount
	from ubt_temp_totofo_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO MATCH'
	and a.flag = 'CAN' ;

	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_totofo_can_tktcount;

end;
$$;


ALTER FUNCTION public.sp_ubt_gtad_dr_summarybychain(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1145 (class 1255 OID 2005642)
-- Name: sp_ubt_gtad_dr_summarybychain_bk20241010(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gtad_dr_summarybychain_bk20241010(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);

	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate::date 
	from(
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
		) sq
		on (tl.terdisplayid = sq.terdisplayid)

		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
				-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid , zp.prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, zp.prodname )sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'

		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;

end;
$$;


ALTER FUNCTION public.sp_ubt_gtad_dr_summarybychain_bk20241010(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1211 (class 1255 OID 2380711)
-- Name: sp_ubt_gtad_dr_summarybychain_bk20250310(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gtad_dr_summarybychain_bk20250310(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;
	v_totomatchBettypes text[] := (SELECT array(SELECT bettypeid FROM public.sp_ubt_gettotomatchbettypes()));

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid, prodname
	from ztubt_terminal zt 
	cross join (
	    select case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	    from ztubt_product zp
	    where zp.prodid in (1,2,3,4,5)
    	union all
    	select 'TOTO MATCH' AS prodname
	) zp;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);

	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate::date 
	from(
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbtlin.bettypeid != ALL(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		--totomatch ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO MATCH' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbtlin.bettypeid = ANY(v_totomatchBettypes)
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
		) sq
		on (tl.terdisplayid = sq.terdisplayid)

		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
		-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid,
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end as prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, 
		case 
			when zp.prodid = 3 and EXISTS (
                   select 1 
                   from ztubt_toto_placedbettransactionlineitem pbtlin
                   where pbth.TranHeaderID = pbtlin.TranHeaderID
                     and pbtlin.bettypeid = ANY(v_totomatchBettypes)
               ) then 'TOTO MATCH'
			else zp.prodname
		end  
		)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO', 'TOTO MATCH')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'

		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid != ALL(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;

	create temp table ubt_temp_totofo_can_tktcount as
		select terdisplayid, sum(totofo_ticketCount) totofo_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) totofo_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.bettypeid = ANY(v_totomatchBettypes)
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
			
	update ubt_temp_trans_amt a set ticketcount = tc.totofo_ticketCount
	from ubt_temp_totofo_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO MATCH'
	and a.flag = 'CAN' ;

	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;
drop table ubt_temp_totofo_can_tktcount;

end;
$$;


ALTER FUNCTION public.sp_ubt_gtad_dr_summarybychain_bk20250310(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1271 (class 1255 OID 2030169)
-- Name: sp_ubt_gtad_dr_summarybychain_testorg(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gtad_dr_summarybychain_testorg(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);

	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate::date 
	from(
	-- HorseRacing ProdID=1 COL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'COL' Flag
		, sum(COLAmount) Amount
		, SUM(TicketCount) TicketCount
		, null actualdate
		from ztubt_terminal tl left outer join (
			select pbtlin.terdisplayid
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.betpriceamount ,0)/2
					else coalesce(pbtlin.betpriceamount ,0) end) COLAmount
			, count(distinct pbtlin.tranheaderid) TicketCount
			from 
			 ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbthlcs.TranHeaderID = pbtlin.TranHeaderID)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS 
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbthlcs.betstatetypeid = 'PB06'
			group by pbtlin.terdisplayid,pbtlin.bettypeid) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- 4D ProdID=2 COL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.bigbetAcceptedWager,0)+COALESCE(pbtlin.smallBetAcceptedWager,0)) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT  
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in  (1,2)
		group by pbth.terdisplayid)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- TOTO ProdID=3 COL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'COL' Flag
		, sum(COLAmount) COLAmount
		, sum(ticketcount) ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round((case when pbtlin.GroupHostID = '00000000-0000-0000-0000-000000000000'
					then coalesce(pbtlin.betPriceAmount,0) * count(pbtlin.TranHeaderID)
					else sum(pbtlin.betPriceAmount) end 
					),2) COLAmount
		, count(distinct pbth.ticketserialnumber) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by pbth.terdisplayid, pbtlin.GroupHostID,pbtlin.betPriceAmount) sq
		on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid
		
		union all
		
	-- SWEEP ProdID=4 COL PB06 PB03
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  pbth.terdisplayid 
		, Round(sum(COALESCE(pbtlin.betpriceamount,0)),2) COLAmount
		, count(distinct pbth.tickettransactionid) ticketcount
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
	 		on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
	 	 inner join ztubt_sweep_placedbettransactionlineitem pbtl
	 	 	on (pbth.TranHeaderID = pbtl.TranHeaderID)
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbtl.tranlineitemid = pbtlin.tranlineitemid and pbtlin.issoldout = false)
		 inner join ztubt_terminal zt on (pbth.terdisplayid=zt.terdisplayid)
		 inner join ztubt_location zl on (zt.locid=zl.locid)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
		and ((pbthlcs.betstatetypeid = 'PB06' and 
			(pbtl.isprinted is not null or zl.sweepindicator is null)) 
			or
			(pbthlcs.betstatetypeid = 'PB03' and 
			(pbtl.isprinted is null and zl.sweepindicator is not null)))
		group by pbth.terdisplayid) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		
		union all
	
		-- SPORTS ProdID=5,6 COL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'COL' Flag
		, COLAmount
		, ticketcount
		, null actualdate
		from 
		ztubt_terminal tl left outer join (
		select 
		  terdisplayid 
		, Round(sum(betamount),2) COLAmount
		, count(distinct tranheaderid) ticketcount
		from 
			(select distinct pbtlin.terdisplayid, pbtlin.betamount,accumulatorid,pbtlin.tranheaderid
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeOB
			and pbtlin.CreatedDate < vUTCToDateTimeOB
			and pbth.prodid in (5,6)
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end in (1,2)
			)a
		group by terdisplayid
		) sq
		on (tl.terdisplayid = sq.terdisplayid)

		union all
------------------------------------------------------------------------------------------------		
	-- CAN
		-- CAN Prodid=1
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid =1
		and cbt.cancelleddate >= vFromDateTimeBMCS  --bmcs
		and cbt.cancelleddate < vToDateTimeBMCS
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'HORSE RACING'
		
		union all 
		
				-- CAN Prodid=2,3
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid , zp.prodname
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_product zp 
			on (pbth.prodid = zp.prodid)
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		where pbth.prodid in (2,3) -- 06-04-2022: Removed prodid 4 to add seperate union foe SWEEP Cancellation
		and cbt.cancelleddate >= vFromDateTimeIGT  --igtutc
		and cbt.cancelleddate < vToDateTimeIGT
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (2)
		group by cbt.terdisplayid, zp.prodname )sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname in (' 4D Lottery', '4D Lottery','TOTO')
		
		union all
		
		-- 06-04-2022: Hira: Added for Sweep Crossday Cancellation
		-- CAN Prodid=4
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		SELECT CBT.TerDisplayID, PD.ProdName
		, SUM(coalesce(CBT.CancelledAmout,0)) CANAmount, COUNT(CBT.TranHeaderID) TicketCount
		FROM (SELECT    CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
			, CBT.TerDisplayID, CBT.CancelledAmout
		FROM public.ztubt_cancelledbetticket CBT 
		INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
			ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
		WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT) CBT
		INNER JOIN  public.ztubt_product PD ON CBT.ProdID = PD.ProdID 
		GROUP BY CBT.TerDisplayID, PD.ProdName)sq
		on (tp.terdisplayid = sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		where tp.prodname = 'SINGAPORE SWEEP'

		
		union all
		
		-- CAN prodid=5,6
		select tp.terdisplayid
		, tp.prodname
		, 'CAN' Flag
		, CANAmount
		, TicketCount
		, null AcutalDate
		from ubt_temp_ter_prod tp left outer join (
		select cbt.terdisplayid 
		, round(sum(cbt.cancelledamout),2) CANAmount
		, count(cbt.tranheaderid) TicketCount
		from ztubt_placedbettransactionheader pbth 
		inner join ztubt_cancelledbetticket cbt 
			on (pbth.tranheaderid = cbt.tranheaderid)
		inner join ztubt_cancelledbetticketlifecyclestate cblc 
			on (pbth.tranheaderid=cblc.tranheaderid and cblc.betstatetypeid='CB06')
		where pbth.prodid in(5,6)
		and cbt.cancelleddate >= vFromDateTimeOB  --obsutc
		and cbt.cancelleddate < vToDateTimeOB
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end in (1,2)
		group by cbt.terdisplayid )sq
		on (tp.terdisplayid = sq.terdisplayid)
		where tp.prodname = 'SPORTS'
		
	-- CAN
		
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_toto_can_tktcount as
		select terdisplayid, sum(toto_ticketCount) toto_ticketCount from ( 
			select fin.terdisplayid, count(distinct zp.ticketserialnumber) toto_ticketCount
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is null
			group by fin.terdisplayid
			union all	
			select fin.terdisplayid, count(distinct ztp.grouphostid)
			from ztubt_placedbettransactionheader zp 
			inner join ztubt_toto_placedbettransactionlineitem ztp 
				on (zp.tranheaderid=ztp.tranheaderid)
			inner join 
				(select zc.tranheaderid ,zc.terdisplayid from ztubt_cancelledbetticket zc 
				inner join ztubt_cancelledbetticketlifecyclestate zc2 
				on (zc.tranheaderid=zc2.tranheaderid and zc2.betstatetypeid='CB06')
				where 1=1
				and zc.cancelleddate >= vFromDateTimeIGT  --igtutc
				and zc.cancelleddate < vToDateTimeIGT) fin
					on  (zp.tranheaderid=fin.tranheaderid)
			where 1=1
			and ztp.groupunitsequence is not null
			group by fin.terdisplayid
			) sq
			group by terdisplayid;
	
	update ubt_temp_trans_amt a set ticketcount = tc.toto_ticketCount
	from ubt_temp_toto_can_tktcount tc
	where a.terdisplayid = tc.terdisplayid 
	and a.prodname = 'TOTO'
	and a.flag = 'CAN' ;
		
	create temp table ubt_temp_toto_sal_count as
		select terdisplayid ,prodname
			, sum(case when flag = 'COL' then ticketcount else 0 end)
			 -sum(case when flag = 'CAN' then ticketcount else 0 end) toto_sal_count
		from ubt_temp_trans_amt where 1=1
		and prodname = 'TOTO'
		and flag in ('COL','CAN')
		group by terdisplayid,prodname;
	
	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_toto_sal_count;
drop table ubt_temp_toto_can_tktcount;

end;
$$;


ALTER FUNCTION public.sp_ubt_gtad_dr_summarybychain_testorg(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1121 (class 1255 OID 24823)
-- Name: sp_ubt_gtad_salescomm(timestamp without time zone, timestamp without time zone); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_gtad_salescomm(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) RETURNS TABLE(terdisplayid character varying, prodname character varying, flag character, amount numeric, ticketcount integer, actualdate date, transtype character varying)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column
declare

	vFromDateTimeBMCS		timestamp;
	vToDateTimeBMCS			timestamp;
	vFromDateTimeIGT		timestamp;
	vToDateTimeIGT			timestamp;
	vFromDateTimeOB			timestamp;
	vToDateTimeOB 			timestamp;
	vFromDateTimeNH			timestamp;
	vToDateTimeNH 			timestamp;
	vFromDateFUND			date;
	vToDateFUND				date;

	vUTCFromDateTimeBMCS 	timestamp;
	vUTCToDateTimeBMCS		timestamp;
	vUTCFromDateTimeIGT 	timestamp;
	vUTCToDateTimeIGT		timestamp;
	vUTCFromDateTimeOB		timestamp;
	vUTCToDateTimeOB		timestamp;
	vUTCFromDateTimeNH		timestamp;
	vUTCToDateTimeNH		timestamp;

begin
	
	-- exceute proc sp_ubt_get_businessdate_per_host() 
--	perform sp_ubt_get_businessdate_per_host();
	
	select 
		fromdatetimebmcs,
		todatetimebmcs,
		fromdatetimeigt,
		todatetimeigt,
		fromdatetimeob,
		todatetimeob,
		fromdatetimenonhost,
		todatetimenonhost,
		fromDateFund,
		ToDateFund,
		utcfromdatetimebmcs,
		utctodatetimebmcs,
		utcfromdatetimeigt,
		utctodatetimeigt,
		utcfromdatetimeob,
		utctodatetimeob,
		utcfromdatetimenonhost,
		utctodatetimenonhost
	into
		vFromDateTimeBMCS,
		vToDateTimeBMCS,
		vFromDateTimeIGT,
		vToDateTimeIGT,
		vFromDateTimeOB,
		vToDateTimeOB,
		vFromDateTimeNH,
		vToDateTimeNH,
		vFromDateFUND,
		vToDateFUND,
		vUTCFromDateTimeBMCS,
		vUTCToDateTimeBMCS,
		vUTCFromDateTimeIGT,
		vUTCToDateTimeIGT,
		vUTCFromDateTimeOB,
		vUTCToDateTimeOB,
		vUTCFromDateTimeNH,
		vUTCToDateTimeNH
	from
	public.sp_ubt_getcommonubtdates
	(in_fromDateTime,in_toDateTime)
	;
	
--	drop table public.ubt_temp_trans_amt; 
	
	create temporary table if not exists ubt_temp_trans_amt 
		(
		 terdisplayid varchar(50)
	 	,prodname varchar(50)
	 	,flag char(3)
	 	,amount numeric
	 	,ticketcount int4 
	 	,actualDate Date
		);
	
	create temporary table if not exists ubt_temp_terminal_loc
		(
		 terDisplayID varchar(50)
		,locid int4 
		);

	insert into ubt_temp_terminal_loc
	select zt.terdisplayid , zl.locid from public.ztubt_location zl 
	inner join public.ztubt_terminal zt on (zl.locid=zt.locid);
	
	
	create temporary table if not exists ubt_temp_ter_prod_val
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod_val
	select terdisplayid
	, zv.validationname || '-' || case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	cross join ztubt_validationtype zv 
	where 1=1
	and zp.prodid in (1,2,3,4,5);

	create temporary table if not exists ubt_temp_ter_prod
		(
		 terDisplayID varchar(50)
		,prodname  varchar(100)
		);

	insert into ubt_temp_ter_prod
	select terdisplayid
	,case when zp.prodid =5 then 'SPORTS' else trim(zp.prodname) end as prodname
	from ztubt_terminal zt 
	cross join ztubt_product zp 
	where 1=1
	and zp.prodid in (1,2,3,4,5)
	;

	create temp table ubt_temp_busdatehost1 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =1;
	
	create temp table ubt_temp_busdatehost2 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =2;

	create temp table ubt_temp_busdatehost3 as
	select distinct * from public.ztubt_getbusinessdate_perhost where 1=1
	and previousperioddatetime is not null
	and host =3;

	
	insert into ubt_temp_trans_amt
	select 
	  terdisplayid
	 ,cast(prodname as varchar(50)) as prodname
	 ,cast(flag as char(3)) as flag
	 ,case
	 	when flag in ('CAN','RBT','PAY','GST','FUN','RFD')
	 		then round(coalesce(amount,0)/100,2) * -1 
	 	when flag='SAL' then round(trunc(coalesce(amount,0)/100,2),2) * -1 
	 		else round(coalesce(amount,0)/100,2) end as amount
	 ,coalesce(cast(ticketcount as int4),0) as ticketcount
	 ,actualDate 
	from(
		-- HorseRacing ProdID=1 SAL
		select 
		  tl.terdisplayid as TerDisplayID
		, 'HORSE RACING' ProdName
		, 'SAL' Flag
		, sum(salescommamount) Amount
		, SUM(TicketCount) TicketCount
		, actualdate
		from ubt_temp_terminal_loc tl left outer join (
			select pbth.terdisplayid, zgp.actualdate
			,  SUM(case when pbtlin.bettypeid = 'W-P' then coalesce(pbtlin.salescommamount,0)/2
					else coalesce(pbtlin.salescommamount,0) end) salescommamount
			, count(distinct pbth.ticketserialnumber) TicketCount
			from 
			 public.ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
			 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
			 inner join ztubt_horse_placedbettransactionlineitem  pbtlin 
			 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
			 left outer join ubt_temp_busdatehost1 zgp 
	 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
--	 			and zgp.host = 1
	 			)
	 		where 1=1
			and pbtlin.CreatedDate >= vUTCFromDateTimeBMCS
			and pbtlin.CreatedDate < vUTCToDateTimeBMCS
			and pbth.prodid = 1
			and pbthlcs.betstatetypeid = 'PB06'
			and Case
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
				When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
				When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
				else 5 end = 1
			group by pbth.terdisplayid,pbtlin.bettypeid, zgp.actualdate) sq
			on (tl.terdisplayid = sq.terdisplayid)
		group by tl.terdisplayid, actualdate
		
		union all
		
		-- 4D ProdID=2 SAL
		select tl.terdisplayid
		, '4D Lottery' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(SalesCommAmountBig,0)+COALESCE(SalesCommAmountSmall,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_4d_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 inner join ztubt_drawdates dd
		 	on (dd.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
	 	where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 2
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate)sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- TOTO ProdID=3 SAL
		select tl.terdisplayid
		, 'TOTO' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(pbtlin.salescommamount) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_toto_placedbettransactionlineitem  pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT 
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 3
		and pbthlcs.betstatetypeid = 'PB06'
		and coalesce(pbtlin.groupunitsequence,1) = 1 
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SWEEP ProdID=4 SAL
		select tl.terdisplayid
		, 'SINGAPORE SWEEP' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  pbth.terdisplayid 
		, sum(COALESCE(pbtlin.salescommamount,0)) salescomamt
		, count(distinct pbth.ticketserialnumber) ticketcount
		, zgp.actualdate
		from 
		 ztubt_placedbettransactionheader pbth 
		 inner join ztubt_sweep_placedbettransactionlineitemnumber pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID and pbtlin.issoldout = false)
		 left outer join ubt_temp_busdatehost2 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 2
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeIGT
		and pbtlin.CreatedDate < vUTCToDateTimeIGT
		and pbth.prodid= 4
--		and Case
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
--			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
--			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
--			else 5 end = 1
		group by pbth.terdisplayid, zgp.actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all 
		
		-- 07-Apr-2022: Hira - union added for Sweep Consignee and Retailer Cancellation
		select tl.terdisplayid
			, 'SINGAPORE SWEEP' ProdName
			, 'SAL' Flag
			, salescomamt
			, ticketcount
			, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		SELECT        PBTH.TerDisplayID, GB.ActualDate,
		0-SUM(coalesce(PBTLN.SalesCommAmount,0)) salescomamt, 
		0-COUNT(DISTINCT PBTH.TicketSerialNumber) ticketcount
		FROM       
			(SELECT CBT.TranHeaderID, CBT.TicketSerialNumber, CBT.ProdID
				, CBT.TerDisplayID, CBT.CancelledAmout
			FROM public.ztubt_cancelledbetticket CBT 
			INNER JOIN public.ztubt_cancelledbetticketlifecyclestate CBLC 
				ON CBLC.TranHeaderID = CBT.TranHeaderID AND CBLC.BetStateTypeID = 'CB06'
			WHERE	CBT.ProdID = 4 AND CBT.CancelledDate BETWEEN vFromDateTimeIGT AND vToDateTimeIGT
			) PBTH
			INNER JOIN ztubt_sweep_placedbettransactionlineitemnumber PBTLN 
			ON PBTH.TranHeaderID = PBTLN.TranHeaderID AND PBTLN.IsSoldOut = false AND PBTH.TerDisplayID=PBTLN.TerDisplayID
			LEFT JOIN ubt_temp_busdatehost2 GB 
			ON PBTLN.CreatedDate BETWEEN GB.previousperioddatetimeUTC AND GB.perioddatetimeUTC 
--			and gb.host = 2
		WHERE PBTH.ProdID = 4
		And PBTLN.CreatedDate >= vUTCFromDateTimeIGT - interval '45 Days' 
		AND PBTLN.CreatedDate < vUTCToDateTimeIGT 
		GROUP BY PBTH.TerDisplayID, GB.ActualDate) sq
		on (tl.terdisplayid = sq.terdisplayid)
		
		union all
		
		-- SPORTS ProdID=5,6 SAL
		select tl.terdisplayid
		, 'SPORTS' ProdName
		, 'SAL' Flag
		, salescomamt
		, ticketcount
		, actualdate
		from 
		ubt_temp_terminal_loc tl left outer join (
		select 
		  terdisplayid 
		, sum(coalesce(salescommAmount,0))  salescomamt
		, sum(ticketcount) ticketcount
		, actualdate
		from 
			(select  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate, count(distinct pbth.ticketserialnumber) ticketcount
			 from ztubt_placedbettransactionheader pbth 
			 inner join ztubt_placedbettransactionheaderlifecyclestate pbthlcs 
		 	on (pbth.TranHeaderID = pbthlcs.TranHeaderID)
		 inner join ztubt_sports_placedbettransactionlineitem pbtlin 
		 	on (pbth.TranHeaderID = pbtlin.TranHeaderID)
		 left outer join ubt_temp_busdatehost3 zgp 
 			on (pbtlin.createdDate between zgp.previousperioddatetimeUTC and zgp.perioddatetimeUTC
-- 			and zgp.host = 3
 			)
		where 1=1
		and pbtlin.CreatedDate >= vUTCFromDateTimeOB 
		and pbtlin.CreatedDate < vUTCToDateTimeOB
		and pbth.prodid in (5,6)
		and pbthlcs.betstatetypeid = 'PB06'
		and Case
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 1 
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 2
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = false And pbth.IsExchangeTicket = false Then 3
			When coalesce(pbth.IsBetRejectedByTrader,false) = true And pbth.IsCancelled = true And pbth.IsExchangeTicket = false Then 4
			When coalesce(pbth.IsBetRejectedByTrader,false) = false And pbth.IsCancelled = false And pbth.IsExchangeTicket = true Then 6 
			else 5 end = 1
		group by  pbtlin.terdisplayid, pbtlin.salescommAmount,pbtlin.betamount 
			,accumulatorid,pbtlin.tranheaderid,zgp.actualdate)a
		group by terdisplayid, actualdate) sq
		on (tl.terdisplayid = sq.terdisplayid)
------------------------------------------------------------------------------------------------
	)main;

	create temp table ubt_temp_gst_sal as
	select terdisplayid, prodname, flag
--	, case when flag= 'GST' then round(sum(amount)*0.01,2) else sum(amount) end amount
	, sum(amount) amount
	, sum(TicketCount) TicketCount
	from (
		select tp.terdisplayid, tp.prodname, 'GST' flag
			, coalesce(sq.amount,0) amount, coalesce(sq.TicketCount,0) TicketCount
			, sq.actualDate
--			, 'CH' TransType
		from ubt_temp_ter_prod tp left outer join (
			select distinct
			  a.terdisplayid, a.prodname, 'GST' flag
			, case when zlh.isgst = true then round(a.amount*zg.gstrate*0.01,2) else 0 end amount
			, a.TicketCount, a.actualDate
			from (select terdisplayid, prodname,actualDate, flag
					, sum(amount) amount , sum(TicketCount) TicketCount 
					from ubt_temp_trans_amt where flag='SAL'
					group by terdisplayid, prodname,actualDate,flag) a 
			inner join public.ztubt_terminal zt on (a.terdisplayid = zt.terdisplayid)
			inner join public.ztubt_gstconfig zg 
				on ((a.actualDate between zg.effectivefrom and zg.enddate)
				 or (a.actualDate >= zg.effectivefrom and zg.enddate is null))
			left outer join public.ztubt_locationgsthistory zlh 
				on (zt.locid = zlh.locid and a.actualDate between zlh.startdate and zlh.enddate
					and zlh.isdeleted=false)
			where 1=1
			and a.flag='SAL'
			and zlh.isdeleted = false 
			)sq 
		on (tp.terdisplayid=sq.terdisplayid and trim(tp.prodname) = trim(sq.prodname))
		union all 
		select * from ubt_temp_trans_amt where flag ='SAL'
	)sq
	group by terdisplayid, prodname, flag
		;

	delete from ubt_temp_trans_amt where flag = 'SAL';

	insert into ubt_temp_trans_amt
		select terdisplayid, prodname, flag, amount, TicketCount, null actualdate 
		from ubt_temp_gst_sal;

	
	create temporary table ubt_temp_trans_final as
	select 
		 a.terdisplayid
		,case 
			when prodname like 'REFUNDED-%' then Replace(prodname,'REFUNDED-','')
			when prodname like 'LOSING BET REBATE-%' then Replace(prodname,'LOSING BET REBATE-','')
			when prodname like 'VALIDATED-%' then Replace(prodname,'VALIDATED-','')
			else prodname end as prodname
		,case 
			when prodname like 'REFUNDED-%' then 'RFD'
			when prodname like 'LOSING BET REBATE-%' then 'RBT'
			else flag end as flag
		,amount
		,case when a.flag= 'SAL' and tl.loctypeid = 1 then 0
			else a.ticketcount end ticketcount
		,actualdate
		,cast(case 
			when prodname = 'Offline Orders' then 'OO' 
			when prodname in ('NETS','CASHCARD/Flashpay') then 'CL'
			else 'CH' end as varchar) TransType
	from ubt_temp_trans_amt a left outer join 
		(select zt.terdisplayid, zl.loctypeid from public.ztubt_terminal zt 
		inner join public.ztubt_location zl 
		on zt.locid =zl.locid) tl
	on a.terdisplayid = tl.terdisplayid
	where prodname not like 'EXPIRED-%';

	

	return query
	select * from ubt_temp_trans_final
	;

drop table ubt_temp_trans_amt;
drop table ubt_temp_terminal_loc;
drop table ubt_temp_ter_prod_val;
drop table ubt_temp_ter_prod;
drop table ubt_temp_trans_final;
drop table ubt_temp_gst_sal;
drop table ubt_temp_busdatehost1;
drop table ubt_temp_busdatehost2;
drop table ubt_temp_busdatehost3;

end;
$$;


ALTER FUNCTION public.sp_ubt_gtad_salescomm(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) OWNER TO sp_postgres;

--
-- TOC entry 1136 (class 1255 OID 24826)
-- Name: sp_ubt_insertpaysports(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_insertpaysports(tdate date) RETURNS TABLE(businessdate date, producttype character varying, prizeamount numeric, refundamount numeric, txndate date)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column

	   declare
		ParamDate timestamp;
		PreviousDateTime timestamp;
		PeriodDateTime timestamp;
		ActualDate date;
	    HQLocation VARCHAR(200) = '008888';
	    
	   begin
		   
	     create temp table if not exists ubt_temp_table(
		    PrizeAmount numeric(18, 2), 
		    RefundAmount numeric(18, 2), 
		    TxnDate timestamp
	     );

	    ParamDate := tdate;
        SELECT 
		 PreviousPeriodDateTime, PeriodDateTime, ActualDate 
		into PreviousDateTime, PeriodDateTime, ActualDate 
	    FROM ztubt_getbusinessdate_perhost zgp 
	    WHERE ActualDate = ParamDate AND Host = 3 ;
	   
	   INSERT into ubt_temp_table
	    SELECT 
		 SUM(coalesce (VBT.WinningAmount, 0)) AS PrizeAmount, --(1)
		 SUM(coalesce (VBT.RefundAmount, 0)) AS RefundAmount, --(1)
		 (C.CartCreatedDate + interval'8 hour'):: date As TxnDate  
	     FROM ztubt_cart C
		 INNER JOIN ztubt_validatedbetticket VBT ON VBT.CartID = C.CartID
		 INNER JOIN ztubt_placedbettransactionheader PBTH ON PBTH.TicketSerialNumber = VBT.TicketSerialNumber
		 INNER JOIN ztubt_product P ON PBTH.ProdID = P.ProdID
		 INNER JOIN ztubt_validationtype VT ON VBT.ValidationTypeID = VT.ValidationTypeID
		 INNER JOIN ztubt_validatedbetticketlifecyclestate VBLC ON VBLC.TranHeaderID = PBTH.TranHeaderID AND VBLC.BetStateTypeID = 'VB06'
		 INNER JOIN ztubt_terminal TER ON C.TerDisplayID = TER.TerDisplayID
		 INNER JOIN ztubt_location L ON TER.LocID = L.LocID
	     WHERE 
		  L.LocDisplayID = HQLocation 
		   AND (C.CartCreatedDate + interval'8 hour')::timestamp BETWEEN (PreviousDateTime::timestamp) AND (PeriodDateTime::timestamp) 
		   AND P.ProdID IN (5, 6)
	     GROUP BY  
         (C.CartCreatedDate + interval'8 hour'):: date ;
        
	   return QUERY
	    SELECT 
		 ActualDate AS BusinessDate,
		 '2'::varchar AS ProductType,
		 SUM(coalesce (PrizeAmount, 0))AS PrizeAmount,
		 SUM(coalesce (RefundAmount, 0)) AS RefundAmount,
		 (TxnDate::date) As TxnDate
	     FROM ubt_temp_table
	     GROUP BY (TxnDate::date);
	    
	    drop table ubt_temp_table;

	END;
$$;


ALTER FUNCTION public.sp_ubt_insertpaysports(tdate date) OWNER TO consultant01;

--
-- TOC entry 1195 (class 1255 OID 866552)
-- Name: sp_ubt_insertsalescommreport(date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_insertsalescommreport(in_generateddate date) RETURNS TABLE(chainhead character varying, locationid character varying, locationname character varying, productname character varying, invoicedate text, salescomamount numeric, gstcomamount numeric, adjsalescom numeric, adjgstcom numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$ 
#variable_conflict use_column
declare

begin
	create table if not exists public.ubt_salescomm_report_data (
		chainhead character varying, 
		locationid character varying, 
		locationname character varying, 
		productname character varying, 
		invoicedate text, 
		salescomamount numeric, 
		gstcomamount numeric, 
		adjsalescom numeric, 
		adjgstcom numeric
	);
	-- Grant SELECT and INSERT on the table
GRANT SELECT, INSERT ON TABLE ubt_salescomm_report_data TO consultant01;

	truncate public.ubt_salescomm_report_data;

	insert into public.ubt_salescomm_report_data(
		chainhead, 
		locationid, 
		locationname, 
		productname, 
		invoicedate, 
		salescomamount, 
		gstcomamount, 
		adjsalescom, 
		adjgstcom)
	select chainhead, 
		locationid, 
		locationname, 
		productname, 
		invoicedate, 
		salescomamount, 
		gstcomamount, 
		adjsalescom, 
		adjgstcom
	from public.sp_ubt_getsalescommreport(in_generateddate);

	-- Grant EXECUTE on the stored procedure
 	--EXECUTE 'GRANT EXECUTE ON FUNCTION public.sp_ubt_insertsalescommreport TO qlikuser';
end;

$$;


ALTER FUNCTION public.sp_ubt_insertsalescommreport(in_generateddate date) OWNER TO sp_postgres;

--
-- TOC entry 1289 (class 1255 OID 931783)
-- Name: sp_ubt_paynowtransbychainreport(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_paynowtransbychainreport(in_fromdatetime date, in_todatetime date) RETURNS TABLE(flag character varying, id character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare
	status_pnqr text[];
	status_pnric text[];
	vFromDateTimeIGT	timestamp;
	vToDateTimeIGT		timestamp;

begin
	-- Get Success/Complete status
	select public.sp_ubt_getpaynowsuccessstatus('PNQR') into status_pnqr;
	select public.sp_ubt_getpaynowsuccessstatus('PNRIC') into status_pnric;

	-- Get From-To Date
	select 
		fromdatetimeigt,
		todatetimeigt
	into
		vFromDateTimeIGT,
		vToDateTimeIGT
	from
	public.sp_ubt_getcommonubtdates
	(in_fromdatetime,in_todatetime)
	;

	create temporary table if not exists  tmp_paynow
	(
	flag varchar(50),
	ID varchar(100),
	Amount numeric);

	create temporary table if not exists paynow_report
	(
	flag varchar(50),
	ID varchar(100));
	
	insert into paynow_report values 
	('Paynow (Win Paid)', 'Branches'),
	('Paynow (Win Paid)', 'Sweep Consignees'),
	('Paynow (Win Paid)', 'Sweep Retailers'),
	('Paynow (Win Paid)', 'All Retailers (Exclude SC + SR)'),
	('Paynow QR (Collection)', 'Branches'),
	('Paynow QR (Collection)', 'Sweep Consignees'),
	('Paynow QR (Collection)', 'Sweep Retailers'),
	('Paynow QR (Collection)', 'All Retailers (Exclude SC + SR)');

	INSERT INTO tmp_paynow
	
	SELECT pr.flag as flag, pr.ID as ID, COALESCE(s.Amount, 0)/100 as Amount
	FROM paynow_report pr
	LEFT JOIN (
		-- Branches
		SELECT 
			CASE 
				WHEN zp.paymenttypeid = 'PNRIC' THEN 'Paynow (Win Paid)'  
				WHEN zp.paymenttypeid = 'PNQR' THEN 'Paynow QR (Collection)'
			END as flag
			, 'Branches' as ID
			,  SUM(coalesce(
				CASE 
				WHEN zp.paymenttypeid = 'PNRIC' THEN -zp.netamount  
				WHEN zp.paymenttypeid = 'PNQR' THEN zp.netamount
				END 
			,0)) as Amount 
		FROM ztubt_paynowtransaction zp
		LEFT JOIN ztubt_cart zc ON zp.cartid = zc.cartid  
		LEFT JOIN ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
		LEFT JOIN ztubt_location zl ON zt.LocID = zl.LocID 
		--LEFT JOIN ztubt_chain zch ON zl.chid = zch.chid
		WHERE 1=1
    	AND ((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
			or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
		)
		AND	zl.loctypeid in (1)
		--AND zch.chname in ('Branches')
		AND zp.updateddatetime >= vFromDateTimeIGT  
		AND zp.updateddatetime < vToDateTimeIGT
		GROUP BY zp.paymenttypeid
		
		UNION ALL
	
		-- 'Sweep Consignees', 'Sweep Retailers'
		SELECT 
			CASE 
				WHEN zp.paymenttypeid = 'PNRIC' THEN 'Paynow (Win Paid)'  
				WHEN zp.paymenttypeid = 'PNQR' THEN 'Paynow QR (Collection)'
			END as flag
			, zch.chname as ID
			,  SUM(coalesce(
				CASE 
				WHEN zp.paymenttypeid = 'PNRIC' THEN -zp.netamount  
				WHEN zp.paymenttypeid = 'PNQR' THEN zp.netamount
				END 
			,0)) as Amount 
		FROM ztubt_paynowtransaction zp
		LEFT JOIN ztubt_cart zc ON zp.cartid = zc.cartid  
		LEFT JOIN ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
		LEFT JOIN ztubt_location zl ON zt.LocID = zl.LocID 
		LEFT JOIN ztubt_chain zch ON zl.chid = zch.chid
		WHERE 1=1
    	AND ((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
			or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
		)
		AND	zl.loctypeid in (2,4)
		AND zch.chname in ('Sweep Consignees', 'Sweep Retailers')
		AND zp.updateddatetime >= vFromDateTimeIGT  
		AND zp.updateddatetime < vToDateTimeIGT
		GROUP BY zp.paymenttypeid, zch.chname
		
		UNION ALL
		
		-- All Retailers (Exclude SC + SR)
		SELECT 
			CASE 
				WHEN zp.paymenttypeid = 'PNRIC' THEN 'Paynow (Win Paid)'
				WHEN zp.paymenttypeid = 'PNQR' THEN 'Paynow QR (Collection)'
			END as flag
			, 'All Retailers (Exclude SC + SR)' as ID
			,  SUM(coalesce(
				CASE 
				WHEN zp.paymenttypeid = 'PNRIC' THEN -zp.netamount  
				WHEN zp.paymenttypeid = 'PNQR' THEN zp.netamount
				END 
			,0)) as Amount   
		FROM ztubt_paynowtransaction zp
		LEFT JOIN ztubt_cart zc ON zp.cartid = zc.cartid  
		LEFT JOIN ztubt_terminal zt ON zc.TerDisplayID = zt.TerDisplayID  
		LEFT JOIN ztubt_location zl ON zt.LocID = zl.LocID 
		--LEFT JOIN ztubt_chain zch ON zl.chid = zch.chid
		WHERE 1=1
    	AND ((zp.paymenttypeid = 'PNQR' and zp.transactionstatus = any(status_pnqr))
			or (zp.paymenttypeid = 'PNRIC' and zp.transactionstatus = any(status_pnric))
		)
		AND	zl.loctypeid in (2,4)
		AND zl.sweepindicator is null
		AND zp.updateddatetime >= vFromDateTimeIGT  
		AND zp.updateddatetime < vToDateTimeIGT
		GROUP BY zp.paymenttypeid 
	)s
	ON (pr.flag = s.flag AND pr.ID = s.ID)
;

return query
SELECT flag, ID, Amount FROM tmp_paynow;

drop table tmp_paynow;
drop table paynow_report;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_paynowtransbychainreport(in_fromdatetime date, in_todatetime date) OWNER TO sp_postgres;

--
-- TOC entry 1148 (class 1255 OID 24827)
-- Name: sp_ubt_rtmslocation(); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_rtmslocation() RETURNS TABLE(locdisplayid character varying, locname character varying, loctypeid integer, loctype character varying, locbusinesscode character varying, locchainname character varying, accountnumber character varying, locroutingnumber character varying, locbranchcode character varying, locaddress character varying, locpostalcode character varying, createdby character varying, createddate timestamp without time zone, outlet_date_activation timestamp without time zone, outlet_date_deactivation timestamp without time zone, retailerstatus integer, outlet_sun_open_tm time without time zone, outlet_sun_close_tm time without time zone, outlet_mon_open_tm time without time zone, outlet_mon_close_tm time without time zone, outlet_tue_open_tm time without time zone, outlet_tue_close_tm time without time zone, outlet_wed_open_tm time without time zone, outlet_wed_close_tm time without time zone, outlet_thu_open_tm time without time zone, outlet_thu_close_tm time without time zone, outlet_fri_open_tm time without time zone, outlet_fri_close_tm time without time zone, outlet_sat_open_tm time without time zone, outlet_sat_close_tm time without time zone, outlet_date_modification date, gstflag boolean, gstregnumber character varying, updatedtime character varying, ibgflag boolean)
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
	BEGIN
	
	return query 
	SELECT
	Loc.LocDisplayID, LocName, 
	coalesce(LT.SAPLocTypeID, 0) AS LocTypeID, --(2)
	coalesce(LT.SAPLocType, '') AS LocType, --(2)
	coalesce(LBC.LocBusinessCode::varchar, '') AS LocBusinessCode, --(2)
	CH.CHName AS LocChainName,
	case when upper(loc.AccountNumber) = 'NULL' then null else loc.AccountNumber end AccountNumber,
	case when upper(loc.BankID) = 'NULL' then null else loc.BankID end LocRoutingNumber,
	case when upper(loc.BranchID) = 'NULL' then null else loc.BranchID end LocBranchCode,
	LocAddress,
	LocPostalCode,
	Loc.CreatedBy,
	Loc.CreatedDate,
	(
		SELECT MAX(CreatedDateTime) AS CreatedDateTime
		FROM public.ztubt_locationstatuschange LSC 
		WHERE Loc.LocID = LSC.LocID
		AND Status = 0 --Active
	) AS outlet_date_activation,
	(
		SELECT MAX(CreatedDateTime) AS CreatedDateTime
		FROM public.ztubt_locationstatuschange LSC 
		WHERE Loc.LocID = LSC.LocID
		AND Status = 1 --InActive
	) AS outlet_date_deactivation,
	CASE loc.IsDeleted 
		WHEN false THEN 2
		ELSE 1
	END
	AS RetailerStatus,
	(
		SELECT OpenTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 7 --Sunday
	) AS outlet_sun_open_tm,
	(
		SELECT CloseTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 7
	) AS outlet_sun_close_tm,
	(
		SELECT OpenTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 1 --Monday
	) AS outlet_mon_open_tm,
	(
		SELECT CloseTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 1
	) AS outlet_mon_close_tm,
	(
		SELECT OpenTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 2 --Tuesday
	) AS outlet_tue_open_tm,
	(
		SELECT CloseTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 2
	) AS outlet_tue_close_tm,
	(
		SELECT OpenTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 3 --Wednesday
	) AS outlet_wed_open_tm,
	(
		SELECT CloseTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 3
	) AS outlet_wed_close_tm,
	(
		SELECT OpenTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 4 --Thursday
	) AS outlet_thu_open_tm,
	(
		SELECT CloseTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 4
	) AS outlet_thu_close_tm,
	(
		SELECT OpenTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 5 --Friday
	) AS outlet_fri_open_tm,
	(
		SELECT CloseTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 5
	) AS outlet_fri_close_tm,
	(
		SELECT OpenTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 6 --Saturday
	) AS outlet_sat_open_tm,
	(
		SELECT CloseTime
		FROM public.ztubt_operatinghours OH 
		WHERE Loc.LocID = OH.LocID
		AND DayNo = 6
	) AS outlet_sat_close_tm,
	CAST(Loc.UpdatedDate AS DATE) AS outlet_date_modification,
	Loc.IsGST AS GSTFlag,
	Loc.GSTRegNumber,
	Cast(Loc.UpdatedDate as varchar) AS UpdatedTime,--CONVERT(VARCHAR(8),Loc.UpdatedDate,108) AS UpdatedTime,
	Loc.IsIBG AS IBGFlag
	FROM  public.ztubt_location Loc
	LEFT JOIN public.ztubt_chain CH ON Loc.CHID = CH.CHID
	LEFT JOIN public.ztubt_locbusinesscode LBC ON CH.CHDisplayID = LBC.CHDisplayID --(2)
	LEFT JOIN public.ztubt_loctype LT ON Loc.LocTypeID = LT.LocTypeID AND Loc.SweepIndicator = LT.SweepIndicator; --(2)
	end;
$$;


ALTER FUNCTION public.sp_ubt_rtmslocation() OWNER TO consultant01;

--
-- TOC entry 1149 (class 1255 OID 24828)
-- Name: sp_ubt_rtmsterminal(); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_rtmsterminal() RETURNS TABLE(terdisplayid character varying, locdisplayid character varying, chdisplayid character varying, superchaindisplayid character varying)
    LANGUAGE plpgsql
    AS $$

begin 
	
	return query
	
	SELECT Ter.TerDisplayID, Loc.LocDisplayID, Ch.CHDisplayID AS ChainDisplayID, SC.SCDisplayID AS 	SuperChainDisplayID
	FROM public.ztubt_terminal Ter
	LEFT JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID AND Loc.IsDeleted = false
	LEFT JOIN public.ztubt_chain Ch ON Loc.CHID = Ch.CHID and Ch.IsDeleted = false
	LEFT JOIN public.ztubt_superchain SC ON Ch.SCID = SC.SCID AND SC.IsDeleted = false
	WHERE Ter.IsDeleted = false;
end;
$$;


ALTER FUNCTION public.sp_ubt_rtmsterminal() OWNER TO consultant01;

--
-- TOC entry 1154 (class 1255 OID 24829)
-- Name: sp_ubt_rtmsuser(date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_rtmsuser(inbusinessdate date) RETURNS TABLE(userid integer, userdisplayid character varying, locdisplayid character varying)
    LANGUAGE plpgsql
    AS $$
declare

v_businessdate timestamp;

begin 
	
	-- Added by Hira on 03-Jun-2022
	-- get  business end date timestamp
	select  max(perioddatetime) into v_businessdate
	from ztubt_getbusinessdate_perhost zgp where actualdate =inbusinessdate;

	
	return query
	
	SELECT  US.UserID, US.UserDisplayID, Loc.LocDisplayID
	FROM    public.ztubt_user AS US LEFT OUTER JOIN
			public.ztubt_location AS Loc ON US.LocID = Loc.LocID AND Loc.IsDeleted = false
	WHERE   (US.Application = 'UBT') AND (US.StartDate <= v_businessdate) AND (US.EndDate IS NULL) OR
        (US.Application = 'UBT') AND (US.StartDate <= v_businessdate) AND (v_businessdate < US.EndDate);
	
end;
$$;


ALTER FUNCTION public.sp_ubt_rtmsuser(inbusinessdate date) OWNER TO consultant01;

--
-- TOC entry 1228 (class 1255 OID 2415570)
-- Name: sp_ubt_ssrsinvoice(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_ssrsinvoice(infromdate date, intodate date) RETURNS TABLE(flag character varying, productname character varying, transtype character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare

begin
	
create temporary table if not exists  TempDataSSRS
(
	TerDisplayID varchar(100),
	ProductName varchar(100),
	Amount Numeric(32, 11),
	
	FLAG char(50),
	TransType char(50));

Insert Into TempDataSSRS
	select  
	terdisplayid , prodname , amount,flag,transtype from
	public.sp_ubt_gettransamountdetails(inFromDate,inToDate);

CREATE INDEX idx_tempdatassrs_locid_prodname ON TempDataSSRS (TerDisplayID, FLAG, ProductName);

/* Update offline orders */
UPDATE TempDataSSRS a
SET Amount = a.Amount - COALESCE(b.Amount, 0)
FROM (
	select TerDisplayID, FLAG, Amount
	from TempDataSSRS
	where ProductName = 'Gate Admission' and Amount <> 0
) b
WHERE a.TerDisplayID = b.TerDisplayID AND a.FLAG = b.FLAG
AND a.ProductName = 'Offline Orders' AND a.Amount <> 0;


create temporary table if not exists  LocTempSSRS
( 
	LocID int4,
	ProductName varchar(100),
	Amount Numeric(32, 11),
	FLAG char(3),
	TransType char(4)
);


INSERT INTO  LocTempSSRS
SELECT Loc.LocID, TD.ProductName, MAX(TD.Amount), TD.FLAG, TD.TransType
FROM TempDataSSRS TD
INNER JOIN Public.ztubt_terminal  Ter ON TD.TerDisplayID = Ter.TerDisplayID
INNER JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID
WHERE
TD.FLAG IN ('FUN','REC')
GROUP BY
Loc.LocID, TD.ProductName, TD.FLAG, TD.TransType;


--Level Terminal doesn't have Funding, Recovery and Adjustments
UPDATE TempDataSSRS SET Amount = 0 WHERE FLAG IN ('FUN','REC');

--insert all terminal transaction amount detail to result table


create temporary table if not exists ResultDataSSRS
( 
	LocTerDisplayID varchar(100),
	ProductName varchar(100),
	Amount Numeric(32, 11),
	FLAG varchar(40),
	TransType varchar(30),
	IDType varchar(50)
);



INSERT INTO ResultDataSSRS
	SELECT T.TerDisplayID,T.ProductName,T.Amount,T.FLAG,T.TransType, 'T' FROM TempDataSSRS T;

--group to location and insert to result table
INSERT INTO ResultDataSSRS
SELECT Loc.LocDisplayID, TD.ProductName, SUM(TD.Amount) AS Amount, TD.FLAG, TD.TransType, 'L' AS IDType
FROM  TempDataSSRS TD
INNER JOIN public.ztubt_terminal Ter ON TD.TerDisplayID = Ter.TerDisplayID
INNER JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID
WHERE
TD.FLAG NOT IN ('FUN','REC')
GROUP BY
Loc.LocDisplayID, TD.ProductName, TD.FLAG, TD.TransType;



INSERT INTO  ResultDataSSRS
SELECT l.LocDisplayID , ProductName, Amount, FLAG, TransType, 'L' AS IDType
FROM  LocTempSSRS lt
INNER JOIN public.ztubt_location l ON lt.LocID = l.LocID;



--Update Flag to be ordered as FD----
UPDATE ResultDataSSRS SET FLAG			= '0Wagers'					WHERE FLAG = 'COL';
UPDATE ResultDataSSRS SET FLAG			= '1Cancel'					WHERE FLAG = 'CAN';
UPDATE  ResultDataSSRS SET FLAG			= '2Actual Refund'			WHERE FLAG = 'RFD';
UPDATE  ResultDataSSRS SET FLAG			= '3Rebates'				WHERE FLAG = 'RBT';
UPDATE  ResultDataSSRS SET FLAG			= '4Win Paid'				WHERE FLAG = 'PAY';
UPDATE ResultDataSSRS SET FLAG			= '5Sales Comm'				WHERE FLAG = 'SAL';
UPDATE  ResultDataSSRS SET FLAG			= '6GST'					WHERE FLAG = 'GST';
UPDATE  ResultDataSSRS SET FLAG			= '7Funding / Crd Adj'		WHERE FLAG = 'FUN';
UPDATE  ResultDataSSRS SET FLAG			= '8Recovery / Dbt Adj'		WHERE FLAG = 'REC';
UPDATE  ResultDataSSRS SET FLAG			= '9Cashless'				WHERE FLAG = 'CAS';

UPDATE  ResultDataSSRS SET TransType	= '1Product'				WHERE TransType = 'CH';
UPDATE  ResultDataSSRS SET TransType	= '2Offline Orders'			WHERE TransType = 'OO';
UPDATE  ResultDataSSRS SET TransType	= '3Cashless Transactions'	WHERE TransType = 'CL';
UPDATE  ResultDataSSRS SET TransType	= '4Transaction Fee'	    WHERE TransType = 'TF';

UPDATE  ResultDataSSRS SET ProductName	= '0TOTO'					WHERE ProductName = 'TOTO';
UPDATE  ResultDataSSRS SET ProductName	= '0TOTO MATCH'				WHERE ProductName = 'TOTO MATCH';
UPDATE  ResultDataSSRS SET ProductName	= '14D'						WHERE ProductName = '4D Lottery';
UPDATE  ResultDataSSRS SET ProductName	= '2SINGAPORE SWEEP'		WHERE ProductName = 'SINGAPORE SWEEP';
UPDATE  ResultDataSSRS SET ProductName	= '3SPORTS'					WHERE ProductName = 'SPORTS';
UPDATE  ResultDataSSRS SET ProductName	= '4HORSE RACING'			WHERE ProductName = 'HORSE RACING';
UPDATE  ResultDataSSRS SET ProductName	= '5Funding and Recovery'	WHERE ProductName = 'Funding and Recovery';
UPDATE  ResultDataSSRS SET ProductName	= '6Online Adjustment'		WHERE ProductName = 'Online Adjustment';
UPDATE ResultDataSSRS SET ProductName	= '7Offline Orders'			WHERE ProductName = 'Offline Orders';
UPDATE ResultDataSSRS SET ProductName	= '8Gate Admission'			WHERE ProductName = 'Gate Admission';
UPDATE  ResultDataSSRS SET ProductName	= '8NETS'					WHERE ProductName = 'NETS';
UPDATE  ResultDataSSRS SET ProductName	= '9CASHCARD/Flashpay'		WHERE ProductName = 'CASHCARD/Flashpay';
UPDATE  ResultDataSSRS SET ProductName	= '9PaynowQR [+trans fee]'  WHERE ProductName = 'PaynowQR [+trans fee]';
UPDATE  ResultDataSSRS SET ProductName	= '9Paynow [+trans fee]'    WHERE ProductName = 'Paynow [+trans fee]';
UPDATE  ResultDataSSRS SET ProductName	= '9PaynowQR'               WHERE ProductName = 'PaynowQR';
UPDATE  ResultDataSSRS SET ProductName	= '9Paynow'                 WHERE ProductName = 'Paynow';


return query
SELECT FLAG, ProductName, TransType, SUM(Amount)  Amount FROM ResultDataSSRS
WHERE IDType='L'
GROUP BY FLAG, ProductName, TransType;
	
	
	
	
	


drop table TempDataSSRS;
drop table LocTempSSRS;
drop table ResultDataSSRS;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_ssrsinvoice(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1282 (class 1255 OID 24830)
-- Name: sp_ubt_ssrsinvoice_bk20240314(date, date); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_ssrsinvoice_bk20240314(infromdate date, intodate date) RETURNS TABLE(flag character varying, productname character varying, transtype character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare


begin
	

create temporary table if not exists  TempDataSSRS
(
	TerDisplayID varchar(100),
	ProductName varchar(100),
	Amount Numeric(32, 11),
	
	FLAG char(50),
	TransType char(50));






	Insert Into TempDataSSRS
		select  
terdisplayid , prodname , amount,flag,transtype from
public.sp_ubt_gettransamountdetails(inFromDate,inToDate);





create temporary table if not exists  LocTempSSRS
( 
	LocID int4,
	ProductName varchar(100),
	Amount Numeric(32, 11),
	FLAG char(3),
	TransType char(4)
);



INSERT INTO  LocTempSSRS
SELECT Loc.LocID, TD.ProductName, MAX(TD.Amount), TD.FLAG, TD.TransType
FROM TempDataSSRS TD
INNER JOIN Public.ztubt_terminal  Ter ON TD.TerDisplayID = Ter.TerDisplayID
INNER JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID
WHERE
TD.FLAG IN ('FUN','REC')
GROUP BY
Loc.LocID, TD.ProductName, TD.FLAG, TD.TransType;


--Level Terminal doesn't have Funding, Recovery and Adjustments
UPDATE TempDataSSRS SET Amount = 0 WHERE FLAG IN ('FUN','REC');

--insert all terminal transaction amount detail to result table


create temporary table if not exists ResultDataSSRS
( 
	LocTerDisplayID varchar(100),
	ProductName varchar(100),
	Amount Numeric(32, 11),
	FLAG varchar(40),
	TransType varchar(30),
	IDType varchar(50)
);



INSERT INTO ResultDataSSRS
	SELECT T.TerDisplayID,T.ProductName,T.Amount,T.FLAG,T.TransType, 'T' FROM TempDataSSRS T;

--group to location and insert to result table
INSERT INTO ResultDataSSRS
SELECT Loc.LocDisplayID, TD.ProductName, SUM(TD.Amount) AS Amount, TD.FLAG, TD.TransType, 'L' AS IDType
FROM  TempDataSSRS TD
INNER JOIN public.ztubt_terminal Ter ON TD.TerDisplayID = Ter.TerDisplayID
INNER JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID
WHERE
TD.FLAG NOT IN ('FUN','REC')
GROUP BY
Loc.LocDisplayID, TD.ProductName, TD.FLAG, TD.TransType;



INSERT INTO  ResultDataSSRS
SELECT l.LocDisplayID , ProductName, Amount, FLAG, TransType, 'L' AS IDType
FROM  LocTempSSRS lt
INNER JOIN public.ztubt_location l ON lt.LocID = l.LocID;



--Update Flag to be ordered as FD----
UPDATE ResultDataSSRS SET FLAG			= '0Wagers'					WHERE FLAG = 'COL';
UPDATE ResultDataSSRS SET FLAG			= '1Cancel'					WHERE FLAG = 'CAN';
UPDATE  ResultDataSSRS SET FLAG			= '2Actual Refund'			WHERE FLAG = 'RFD';
UPDATE  ResultDataSSRS SET FLAG			= '3Rebates'				WHERE FLAG = 'RBT';
UPDATE  ResultDataSSRS SET FLAG			= '4Win Paid'				WHERE FLAG = 'PAY';
UPDATE ResultDataSSRS SET FLAG			= '5Sales Comm'				WHERE FLAG = 'SAL';
UPDATE  ResultDataSSRS SET FLAG			= '6GST'					WHERE FLAG = 'GST';
UPDATE  ResultDataSSRS SET FLAG			= '7Funding / Crd Adj'		WHERE FLAG = 'FUN';
UPDATE  ResultDataSSRS SET FLAG			= '8Recovery / Dbt Adj'		WHERE FLAG = 'REC';
UPDATE  ResultDataSSRS SET FLAG			= '9Cashless'				WHERE FLAG = 'CAS';

UPDATE  ResultDataSSRS SET TransType	= '1Product'				WHERE TransType = 'CH';
UPDATE  ResultDataSSRS SET TransType	= '2Offline Orders'			WHERE TransType = 'OO';
UPDATE  ResultDataSSRS SET TransType	= '3Cashless Transactions'	WHERE TransType = 'CL';

UPDATE  ResultDataSSRS SET ProductName	= '0TOTO'					WHERE ProductName = 'TOTO';
UPDATE  ResultDataSSRS SET ProductName	= '14D'						WHERE ProductName = '4D Lottery';
UPDATE  ResultDataSSRS SET ProductName	= '2SINGAPORE SWEEP'		WHERE ProductName = 'SINGAPORE SWEEP';
UPDATE  ResultDataSSRS SET ProductName	= '3SPORTS'					WHERE ProductName = 'SPORTS';
UPDATE  ResultDataSSRS SET ProductName	= '4HORSE RACING'			WHERE ProductName = 'HORSE RACING';
UPDATE  ResultDataSSRS SET ProductName	= '5Funding and Recovery'	WHERE ProductName = 'Funding and Recovery';
UPDATE  ResultDataSSRS SET ProductName	= '6Online Adjustment'		WHERE ProductName = 'Online Adjustment';
UPDATE ResultDataSSRS SET ProductName	= '7Offline Orders'			WHERE ProductName = 'Offline Orders';
UPDATE  ResultDataSSRS SET ProductName	= '8NETS'					WHERE ProductName = 'NETS';
UPDATE  ResultDataSSRS SET ProductName	= '9CASHCARD/Flashpay'		WHERE ProductName = 'CASHCARD/Flashpay';


return query
SELECT FLAG, ProductName, TransType, SUM(Amount)  Amount FROM ResultDataSSRS
WHERE IDType='L'
GROUP BY FLAG, ProductName, TransType;
	
	
	
	
	


drop table TempDataSSRS;
drop table LocTempSSRS;
drop table ResultDataSSRS;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_ssrsinvoice_bk20240314(infromdate date, intodate date) OWNER TO consultant01;

--
-- TOC entry 1303 (class 1255 OID 2005645)
-- Name: sp_ubt_ssrsinvoice_bk20241010(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_ssrsinvoice_bk20241010(infromdate date, intodate date) RETURNS TABLE(flag character varying, productname character varying, transtype character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare


begin
	

create temporary table if not exists  TempDataSSRS
(
	TerDisplayID varchar(100),
	ProductName varchar(100),
	Amount Numeric(32, 11),
	
	FLAG char(50),
	TransType char(50));






	Insert Into TempDataSSRS
		select  
terdisplayid , prodname , amount,flag,transtype from
public.sp_ubt_gettransamountdetails(inFromDate,inToDate);





create temporary table if not exists  LocTempSSRS
( 
	LocID int4,
	ProductName varchar(100),
	Amount Numeric(32, 11),
	FLAG char(3),
	TransType char(4)
);



INSERT INTO  LocTempSSRS
SELECT Loc.LocID, TD.ProductName, MAX(TD.Amount), TD.FLAG, TD.TransType
FROM TempDataSSRS TD
INNER JOIN Public.ztubt_terminal  Ter ON TD.TerDisplayID = Ter.TerDisplayID
INNER JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID
WHERE
TD.FLAG IN ('FUN','REC')
GROUP BY
Loc.LocID, TD.ProductName, TD.FLAG, TD.TransType;


--Level Terminal doesn't have Funding, Recovery and Adjustments
UPDATE TempDataSSRS SET Amount = 0 WHERE FLAG IN ('FUN','REC');

--insert all terminal transaction amount detail to result table


create temporary table if not exists ResultDataSSRS
( 
	LocTerDisplayID varchar(100),
	ProductName varchar(100),
	Amount Numeric(32, 11),
	FLAG varchar(40),
	TransType varchar(30),
	IDType varchar(50)
);



INSERT INTO ResultDataSSRS
	SELECT T.TerDisplayID,T.ProductName,T.Amount,T.FLAG,T.TransType, 'T' FROM TempDataSSRS T;

--group to location and insert to result table
INSERT INTO ResultDataSSRS
SELECT Loc.LocDisplayID, TD.ProductName, SUM(TD.Amount) AS Amount, TD.FLAG, TD.TransType, 'L' AS IDType
FROM  TempDataSSRS TD
INNER JOIN public.ztubt_terminal Ter ON TD.TerDisplayID = Ter.TerDisplayID
INNER JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID
WHERE
TD.FLAG NOT IN ('FUN','REC')
GROUP BY
Loc.LocDisplayID, TD.ProductName, TD.FLAG, TD.TransType;



INSERT INTO  ResultDataSSRS
SELECT l.LocDisplayID , ProductName, Amount, FLAG, TransType, 'L' AS IDType
FROM  LocTempSSRS lt
INNER JOIN public.ztubt_location l ON lt.LocID = l.LocID;



--Update Flag to be ordered as FD----
UPDATE ResultDataSSRS SET FLAG			= '0Wagers'					WHERE FLAG = 'COL';
UPDATE ResultDataSSRS SET FLAG			= '1Cancel'					WHERE FLAG = 'CAN';
UPDATE  ResultDataSSRS SET FLAG			= '2Actual Refund'			WHERE FLAG = 'RFD';
UPDATE  ResultDataSSRS SET FLAG			= '3Rebates'				WHERE FLAG = 'RBT';
UPDATE  ResultDataSSRS SET FLAG			= '4Win Paid'				WHERE FLAG = 'PAY';
UPDATE ResultDataSSRS SET FLAG			= '5Sales Comm'				WHERE FLAG = 'SAL';
UPDATE  ResultDataSSRS SET FLAG			= '6GST'					WHERE FLAG = 'GST';
UPDATE  ResultDataSSRS SET FLAG			= '7Funding / Crd Adj'		WHERE FLAG = 'FUN';
UPDATE  ResultDataSSRS SET FLAG			= '8Recovery / Dbt Adj'		WHERE FLAG = 'REC';
UPDATE  ResultDataSSRS SET FLAG			= '9Cashless'				WHERE FLAG = 'CAS';

UPDATE  ResultDataSSRS SET TransType	= '1Product'				WHERE TransType = 'CH';
UPDATE  ResultDataSSRS SET TransType	= '2Offline Orders'			WHERE TransType = 'OO';
UPDATE  ResultDataSSRS SET TransType	= '3Cashless Transactions'	WHERE TransType = 'CL';
UPDATE  ResultDataSSRS SET TransType	= '4Transaction Fee'	    WHERE TransType = 'TF';

UPDATE  ResultDataSSRS SET ProductName	= '0TOTO'					WHERE ProductName = 'TOTO';
UPDATE  ResultDataSSRS SET ProductName	= '14D'						WHERE ProductName = '4D Lottery';
UPDATE  ResultDataSSRS SET ProductName	= '2SINGAPORE SWEEP'		WHERE ProductName = 'SINGAPORE SWEEP';
UPDATE  ResultDataSSRS SET ProductName	= '3SPORTS'					WHERE ProductName = 'SPORTS';
UPDATE  ResultDataSSRS SET ProductName	= '4HORSE RACING'			WHERE ProductName = 'HORSE RACING';
UPDATE  ResultDataSSRS SET ProductName	= '5Funding and Recovery'	WHERE ProductName = 'Funding and Recovery';
UPDATE  ResultDataSSRS SET ProductName	= '6Online Adjustment'		WHERE ProductName = 'Online Adjustment';
UPDATE ResultDataSSRS SET ProductName	= '7Offline Orders'			WHERE ProductName = 'Offline Orders';
UPDATE  ResultDataSSRS SET ProductName	= '8NETS'					WHERE ProductName = 'NETS';
UPDATE  ResultDataSSRS SET ProductName	= '9CASHCARD/Flashpay'		WHERE ProductName = 'CASHCARD/Flashpay';
UPDATE  ResultDataSSRS SET ProductName	= '9PaynowQR [+trans fee]'  WHERE ProductName = 'PaynowQR [+trans fee]';
UPDATE  ResultDataSSRS SET ProductName	= '9Paynow [+trans fee]'    WHERE ProductName = 'Paynow [+trans fee]';
UPDATE  ResultDataSSRS SET ProductName	= '9PaynowQR'               WHERE ProductName = 'PaynowQR';
UPDATE  ResultDataSSRS SET ProductName	= '9Paynow'                 WHERE ProductName = 'Paynow';


return query
SELECT FLAG, ProductName, TransType, SUM(Amount)  Amount FROM ResultDataSSRS
WHERE IDType='L'
GROUP BY FLAG, ProductName, TransType;
	
	
	
	
	


drop table TempDataSSRS;
drop table LocTempSSRS;
drop table ResultDataSSRS;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_ssrsinvoice_bk20241010(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1283 (class 1255 OID 931784)
-- Name: sp_ubt_ssrsinvoice_bk20250326(date, date); Type: FUNCTION; Schema: public; Owner: sp_postgres
--

CREATE FUNCTION public.sp_ubt_ssrsinvoice_bk20250326(infromdate date, intodate date) RETURNS TABLE(flag character varying, productname character varying, transtype character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare


begin
	

create temporary table if not exists  TempDataSSRS
(
	TerDisplayID varchar(100),
	ProductName varchar(100),
	Amount Numeric(32, 11),
	
	FLAG char(50),
	TransType char(50));






	Insert Into TempDataSSRS
		select  
terdisplayid , prodname , amount,flag,transtype from
public.sp_ubt_gettransamountdetails(inFromDate,inToDate);





create temporary table if not exists  LocTempSSRS
( 
	LocID int4,
	ProductName varchar(100),
	Amount Numeric(32, 11),
	FLAG char(3),
	TransType char(4)
);



INSERT INTO  LocTempSSRS
SELECT Loc.LocID, TD.ProductName, MAX(TD.Amount), TD.FLAG, TD.TransType
FROM TempDataSSRS TD
INNER JOIN Public.ztubt_terminal  Ter ON TD.TerDisplayID = Ter.TerDisplayID
INNER JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID
WHERE
TD.FLAG IN ('FUN','REC')
GROUP BY
Loc.LocID, TD.ProductName, TD.FLAG, TD.TransType;


--Level Terminal doesn't have Funding, Recovery and Adjustments
UPDATE TempDataSSRS SET Amount = 0 WHERE FLAG IN ('FUN','REC');

--insert all terminal transaction amount detail to result table


create temporary table if not exists ResultDataSSRS
( 
	LocTerDisplayID varchar(100),
	ProductName varchar(100),
	Amount Numeric(32, 11),
	FLAG varchar(40),
	TransType varchar(30),
	IDType varchar(50)
);



INSERT INTO ResultDataSSRS
	SELECT T.TerDisplayID,T.ProductName,T.Amount,T.FLAG,T.TransType, 'T' FROM TempDataSSRS T;

--group to location and insert to result table
INSERT INTO ResultDataSSRS
SELECT Loc.LocDisplayID, TD.ProductName, SUM(TD.Amount) AS Amount, TD.FLAG, TD.TransType, 'L' AS IDType
FROM  TempDataSSRS TD
INNER JOIN public.ztubt_terminal Ter ON TD.TerDisplayID = Ter.TerDisplayID
INNER JOIN public.ztubt_location Loc ON Ter.LocID = Loc.LocID
WHERE
TD.FLAG NOT IN ('FUN','REC')
GROUP BY
Loc.LocDisplayID, TD.ProductName, TD.FLAG, TD.TransType;



INSERT INTO  ResultDataSSRS
SELECT l.LocDisplayID , ProductName, Amount, FLAG, TransType, 'L' AS IDType
FROM  LocTempSSRS lt
INNER JOIN public.ztubt_location l ON lt.LocID = l.LocID;



--Update Flag to be ordered as FD----
UPDATE ResultDataSSRS SET FLAG			= '0Wagers'					WHERE FLAG = 'COL';
UPDATE ResultDataSSRS SET FLAG			= '1Cancel'					WHERE FLAG = 'CAN';
UPDATE  ResultDataSSRS SET FLAG			= '2Actual Refund'			WHERE FLAG = 'RFD';
UPDATE  ResultDataSSRS SET FLAG			= '3Rebates'				WHERE FLAG = 'RBT';
UPDATE  ResultDataSSRS SET FLAG			= '4Win Paid'				WHERE FLAG = 'PAY';
UPDATE ResultDataSSRS SET FLAG			= '5Sales Comm'				WHERE FLAG = 'SAL';
UPDATE  ResultDataSSRS SET FLAG			= '6GST'					WHERE FLAG = 'GST';
UPDATE  ResultDataSSRS SET FLAG			= '7Funding / Crd Adj'		WHERE FLAG = 'FUN';
UPDATE  ResultDataSSRS SET FLAG			= '8Recovery / Dbt Adj'		WHERE FLAG = 'REC';
UPDATE  ResultDataSSRS SET FLAG			= '9Cashless'				WHERE FLAG = 'CAS';

UPDATE  ResultDataSSRS SET TransType	= '1Product'				WHERE TransType = 'CH';
UPDATE  ResultDataSSRS SET TransType	= '2Offline Orders'			WHERE TransType = 'OO';
UPDATE  ResultDataSSRS SET TransType	= '3Cashless Transactions'	WHERE TransType = 'CL';
UPDATE  ResultDataSSRS SET TransType	= '4Transaction Fee'	    WHERE TransType = 'TF';

UPDATE  ResultDataSSRS SET ProductName	= '0TOTO'					WHERE ProductName = 'TOTO';
UPDATE  ResultDataSSRS SET ProductName	= '0TOTO MATCH'				WHERE ProductName = 'TOTO MATCH';
UPDATE  ResultDataSSRS SET ProductName	= '14D'						WHERE ProductName = '4D Lottery';
UPDATE  ResultDataSSRS SET ProductName	= '2SINGAPORE SWEEP'		WHERE ProductName = 'SINGAPORE SWEEP';
UPDATE  ResultDataSSRS SET ProductName	= '3SPORTS'					WHERE ProductName = 'SPORTS';
UPDATE  ResultDataSSRS SET ProductName	= '4HORSE RACING'			WHERE ProductName = 'HORSE RACING';
UPDATE  ResultDataSSRS SET ProductName	= '5Funding and Recovery'	WHERE ProductName = 'Funding and Recovery';
UPDATE  ResultDataSSRS SET ProductName	= '6Online Adjustment'		WHERE ProductName = 'Online Adjustment';
UPDATE ResultDataSSRS SET ProductName	= '7Offline Orders'			WHERE ProductName = 'Offline Orders';
UPDATE  ResultDataSSRS SET ProductName	= '8NETS'					WHERE ProductName = 'NETS';
UPDATE  ResultDataSSRS SET ProductName	= '9CASHCARD/Flashpay'		WHERE ProductName = 'CASHCARD/Flashpay';
UPDATE  ResultDataSSRS SET ProductName	= '9PaynowQR [+trans fee]'  WHERE ProductName = 'PaynowQR [+trans fee]';
UPDATE  ResultDataSSRS SET ProductName	= '9Paynow [+trans fee]'    WHERE ProductName = 'Paynow [+trans fee]';
UPDATE  ResultDataSSRS SET ProductName	= '9PaynowQR'               WHERE ProductName = 'PaynowQR';
UPDATE  ResultDataSSRS SET ProductName	= '9Paynow'                 WHERE ProductName = 'Paynow';


return query
SELECT FLAG, ProductName, TransType, SUM(Amount)  Amount FROM ResultDataSSRS
WHERE IDType='L'
GROUP BY FLAG, ProductName, TransType;
	
	
	
	
	


drop table TempDataSSRS;
drop table LocTempSSRS;
drop table ResultDataSSRS;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_ssrsinvoice_bk20250326(infromdate date, intodate date) OWNER TO sp_postgres;

--
-- TOC entry 1155 (class 1255 OID 24831)
-- Name: sp_ubt_test(timestamp without time zone, timestamp without time zone, character varying); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.sp_ubt_test(infromdate timestamp without time zone, intodate timestamp without time zone, intype character varying) RETURNS TABLE(chainname character varying, locdisplayid character varying, locname character varying, amount numeric)
    LANGUAGE plpgsql
    AS $$ 
#variable_conflict use_column

declare


begin
	
	create temporary table if not exists ubt_temp_invdbcrTerProdSumCtAmtInRange(
	 	TerDisplayID VARCHAR(100),			
	 	ProductName VARCHAR(100),
 		FLAG CHAR(3),
		Amount Numeric(32, 11), 
		TicketCount INT4,
		ActualDate Date,
		TransType CHAR(2));
	
	
	insert into ubt_temp_invdbcrTerProdSumCtAmtInRange
	select * from sp_ubt_gettransamountdetails (inFromDate,inToDate);

	create temporary table if not exists ubt_temp_invdbcrLocWithProdAmt(
        LocID int4,
		ProductName varchar(100),
		Amount numeric(32, 11), 
		FLAG char(3),
		TransType char(2));
		
	INSERT INTO ubt_temp_invdbcrLocWithProdAmt
		Select LOC.LocID, TPA.ProductName, MAX(TPA.Amount), TPA.FLAG, TPA.TransType
		From ubt_temp_invdbcrTerProdSumCtAmtInRange TPA
		INNER JOIN ztubt_terminal Ter ON TPA.TerDisplayID = TER.TerDisplayID --AND TER.IsDeleted = 0 --(4)
		INNER JOIN ztubt_location Loc ON TER.LocID = LOC.LocID --AND LOC.IsDeleted = 0 --(4)
			Where FLAG IN ('FUN','REC')
		GROUP BY LOC.LocID, TPA.ProductName, TPA.FLAG, TPA.TransType;

	create temporary table if not exists ubt_temp_invdbcrTmpChainLocAmt(
		ChainName varchar(100),
		LocID int4,
		LocName varchar(100),
		Amount numeric(32, 11));
	
	insert into ubt_temp_invdbcrTmpChainLocAmt	
			select A.chname,A.locid,A.locname,(A.Amount+coalesce (B.amount,0))	 Amount from (
	select zc.chname , zl.locid,zl.locname , sum(coalesce(tabA.amount,0))  Amount from ztubt_location zl  
		left outer join ztubt_terminal zt on (zl.locid=zt.locid)
		inner join ztubt_chain zc on (zl.chid = zc.chid)
		left join (
			select terdisplayid, sum(amount) amount from ubt_temp_invdbcrTerProdSumCtAmtInRange
			where 1=1
			and (
				(flag in ('COL') and transtype <> 'OO')
			  or(flag in ('CAN','PAY','RFD','RBT') and transtype <> 'OO')
			  or(flag in ('SAL','GST'))
				) 
			group by terdisplayid
			union all 
			select terdisplayid, sum(amount)*-1  from ubt_temp_invdbcrTerProdSumCtAmtInRange
			where 1=1
			and transtype = 'CL'
			group by terdisplayid
			) tabA
			on (zt.terdisplayid = tabA.terdisplayid)
	--	left outer join
	--	(select locid, sum(amount) amount from ubt_temp_invdbcrLocWithProdAmt group by locid) aa on (aa.locid = zl.locid)
	group by zc.chname , zl.locid,zl.locname  -- order by zc.chname , zl.locid,zl.locname
) A 
left outer join
		(select locid, sum(amount) amount from ubt_temp_invdbcrLocWithProdAmt group by locid) B on (A.locid = B.locid);
/*
insert into ubt_temp_invdbcrTmpChainLocAmt

	select zc.chname , pa.locid,zl.locname , sum(coalesce(pa.amount,0)) Amount 
		from ubt_temp_invdbcrLocWithProdAmt pa 
		left join ztubt_location zl  on pa.locid=zl.locid
		inner join ztubt_chain zc on (zl.chid = zc.chid)
	where flag in ('FUN','REC')
	group by zc.chname , pa.locid,zl.locname  */


	
	if inType = 'C-IBG' then
	return query
		select
		T.ChainName,L.LocDisplayID,T.LocName,sum(T.Amount) Amount
		from
		ubt_temp_invdbcrTmpChainLocAmt T
		inner join ztubt_Location L on
		T.LocID = L.LocID
		where
		T.Amount < 0
		and (L.IsIBG = true)
		and L.LocTypeID != 1
	group by T.ChainName,L.LocDisplayID,T.LocName;
	end if;


   if inType = 'C-NON' then 
   return query
       select
	   T.ChainName,
	   L.LocDisplayID,
	   T.LocName,
	   sum(T.Amount) Amount
       from
	   ubt_temp_invdbcrTmpChainLocAmt T
       inner join ztubt_Location L on
	   T.LocID = L.LocID
       where
	   T.Amount < 0
	   and (L.IsIBG = false
	   or L.IsIBG is null)
	  group by T.ChainName,L.LocDisplayID,T.LocName;
end if;




  if inType = 'D-IBG' then 
  return query
     select
	 T.ChainName,
	 L.LocDisplayID,
	 T.LocName,
	 T.Amount Amount 
     from
	 ubt_temp_invdbcrTmpChainLocAmt T
     inner join ztubt_location L on
	 T.LocID = L.LocID
     where
	 T.Amount >= 0
	 and (L.IsIBG = true)
	 and L.LocTypeID != 1;
end if;	


if inType = 'D-NON' then 
  return query
    select
	T.ChainName,
	L.LocDisplayID,
	T.LocName,
	sum(T.Amount) Amount
    from
	ubt_temp_invdbcrTmpChainLocAmt T
    inner join ztubt_location L on
	T.LocID = L.LocID
    where
	T.Amount >= 0
	and (L.IsIBG = false
		or L.IsIBG is null)
	group by T.ChainName,L.LocDisplayID,T.LocName;
end if;	


drop table ubt_temp_invdbcrTerProdSumCtAmtInRange;
drop table ubt_temp_invdbcrLocWithProdAmt;
drop table ubt_temp_invdbcrTmpChainLocAmt;
	
end;
$$;


ALTER FUNCTION public.sp_ubt_test(infromdate timestamp without time zone, intodate timestamp without time zone, intype character varying) OWNER TO consultant01;

--
-- TOC entry 1294 (class 1255 OID 687500)
-- Name: sp_zves_findata_draw_sweep(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_zves_findata_draw_sweep() RETURNS TABLE(cdc integer, wagcdc integer, prod integer, tratrmidn bigint, traagt bigint, tratyp integer, draws_draw integer, transamt double precision, saleamt double precision, commamt double precision, gst numeric, gstcommamt double precision)
    LANGUAGE plpgsql
    AS $$

#variable_conflict use_column
declare
vGSTBeginingDate date:='20231031'::date;

begin

	create temp table if not exists ztrtms_trans_lottery_sweep_90days as select 
transheaderid , boardid ,busdate , productid , terminalid , retailerid , transtype , drawid , wager1 , wager2 , sales1 , sales2 , salescomm1 , salescomm2 
from ztrtms_trans_lottery ztl where  
productid =11 
and transtype in (1,2)
and busdate between vGSTBeginingDate - interval '45' day and  vGSTBeginingDate + interval '45' day;	
	
return query
WITH collsweep AS (
         SELECT ztrtms_trans_lottery.busdate - '1986-05-11'::date AS cdc,
            ztrtms_trans_lottery.busdate - '1986-05-11'::date AS wagcdc,
            ztrtms_trans_lottery.productid AS prod,
            ztrtms_trans_lottery.terminalid AS tratrmidn,
            ztrtms_trans_lottery.retailerid AS traagt,
            ztrtms_trans_lottery.transtype AS tratyp,
            ztrtms_trans_lottery.drawid AS draws_draw,
            sum(ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2) AS transamt,
            sum(ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2) AS saleamt,
            sum(ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2) AS commamt
           FROM ztrtms_trans_lottery_sweep_90days ztrtms_trans_lottery
          WHERE ztrtms_trans_lottery.transtype = 1 AND ztrtms_trans_lottery.productid = 11 
          --AND ztrtms_trans_lottery.busdate >= ('2022-11-01'::date - '45 days'::interval day) AND ztrtms_trans_lottery.busdate <= ('2022-11-01'::date + '45 days'::interval day)
          GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid
        ), cansweep_raw AS (
         SELECT can.busdate,
            wag.busdate AS wagbusdate,
            can.productid AS prod,
            can.terminalid AS tratrmidn,
            can.retailerid AS traagt,
            can.transtype AS tratyp,
            can.drawid AS draws_draw,
            can.wager1 + can.wager2 AS transamt,
            can.sales1 + can.sales2 AS saleamt,
            can.salescomm1 + can.salescomm2 AS commamt
           FROM ztrtms_trans_lottery_sweep_90days can
             JOIN ztrtms_trans_lottery_sweep_90days wag ON wag.transheaderid::text = can.transheaderid::text AND "right"(wag.boardid::text, 2) = "right"(can.boardid::text, 2) AND wag.drawid = can.drawid
          WHERE can.transtype = 2 AND can.productid = 11 
         -- AND can.busdate >= ('2022-11-01'::date - '45 days'::interval day) AND can.busdate <= ('2022-11-01'::date + '45 days'::interval day) 
          AND wag.transtype = 1 
          --AND wag.busdate >= ('2022-11-01'::date - '45 days'::interval day) AND wag.busdate <= ('2022-11-01'::date + '45 days'::interval day)
        ), cansweep AS (
         SELECT cansweep_raw.busdate - '1986-05-11'::date AS cdc,
            cansweep_raw.wagbusdate - '1986-05-11'::date AS wagcdc,
            cansweep_raw.prod,
            cansweep_raw.tratrmidn,
            cansweep_raw.traagt,
            cansweep_raw.tratyp,
            cansweep_raw.draws_draw,
            sum(cansweep_raw.transamt) AS transamt,
            sum(cansweep_raw.saleamt) AS saleamt,
            sum(cansweep_raw.commamt) AS commamt
           FROM cansweep_raw
          GROUP BY cansweep_raw.busdate, cansweep_raw.wagbusdate, cansweep_raw.prod, cansweep_raw.tratrmidn, cansweep_raw.traagt, cansweep_raw.tratyp, cansweep_raw.draws_draw
        )
 SELECT collsweep.cdc,
    collsweep.wagcdc,
    collsweep.prod,
    collsweep.tratrmidn,
    collsweep.traagt,
    collsweep.tratyp,
    collsweep.draws_draw,
    collsweep.transamt,
    collsweep.saleamt,
    collsweep.commamt,
        CASE
            WHEN collsweep.wagcdc < 13687 THEN 0.08
            WHEN collsweep.wagcdc >= 13687 THEN 0.09
            ELSE NULL::numeric
        END AS gst,
        CASE
            WHEN collsweep.wagcdc < 13687 THEN 0.08 * collsweep.commamt
            WHEN collsweep.wagcdc >= 13687 THEN 0.09 * collsweep.commamt
            ELSE NULL::double precision
        END AS gstcommamt
   FROM collsweep
UNION ALL
 SELECT cansweep.cdc,
    cansweep.wagcdc,
    cansweep.prod,
    cansweep.tratrmidn,
    cansweep.traagt,
    cansweep.tratyp,
    cansweep.draws_draw,
    cansweep.transamt,
    cansweep.saleamt,
    cansweep.commamt,
        CASE
            WHEN cansweep.wagcdc < 13687 THEN 0.08
            WHEN cansweep.wagcdc >= 13687 THEN 0.09
            ELSE NULL::numeric
        END AS gst,
        CASE
            WHEN cansweep.wagcdc < 13687 THEN 0.08 * cansweep.commamt
            WHEN cansweep.wagcdc >= 13687 THEN 0.09 * cansweep.commamt
            ELSE NULL::double precision
        END AS gstcommamt
   FROM cansweep;
  
  drop table ztrtms_trans_lottery_sweep_90days;
	
	end;
$$;


ALTER FUNCTION public.sp_zves_findata_draw_sweep() OWNER TO postgres;

--
-- TOC entry 1128 (class 1255 OID 366068)
-- Name: sp_zves_findata_draw_sweep_bkup_231023(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.sp_zves_findata_draw_sweep_bkup_231023() RETURNS TABLE(cdc integer, wagcdc integer, prod integer, tratrmidn bigint, traagt bigint, tratyp integer, draws_draw integer, transamt double precision, saleamt double precision, commamt double precision, gst numeric, gstcommamt double precision)
    LANGUAGE plpgsql
    AS $$

#variable_conflict use_column

begin

	create temp table if not exists ztrtms_trans_lottery_sweep_90days as select 
transheaderid , boardid ,busdate , productid , terminalid , retailerid , transtype , drawid , wager1 , wager2 , sales1 , sales2 , salescomm1 , salescomm2 
from ztrtms_trans_lottery ztl where  
productid =11 
and transtype in (1,2)
and busdate between '20221101'::date - interval '45' day and  '20221101'::date + interval '45' day;	
	
return query
WITH collsweep AS (
         SELECT ztrtms_trans_lottery.busdate - '1986-05-11'::date AS cdc,
            ztrtms_trans_lottery.busdate - '1986-05-11'::date AS wagcdc,
            ztrtms_trans_lottery.productid AS prod,
            ztrtms_trans_lottery.terminalid AS tratrmidn,
            ztrtms_trans_lottery.retailerid AS traagt,
            ztrtms_trans_lottery.transtype AS tratyp,
            ztrtms_trans_lottery.drawid AS draws_draw,
            sum(ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2) AS transamt,
            sum(ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2) AS saleamt,
            sum(ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2) AS commamt
           FROM ztrtms_trans_lottery_sweep_90days ztrtms_trans_lottery
          WHERE ztrtms_trans_lottery.transtype = 1 AND ztrtms_trans_lottery.productid = 11 
          --AND ztrtms_trans_lottery.busdate >= ('2022-11-01'::date - '45 days'::interval day) AND ztrtms_trans_lottery.busdate <= ('2022-11-01'::date + '45 days'::interval day)
          GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid
        ), cansweep_raw AS (
         SELECT can.busdate,
            wag.busdate AS wagbusdate,
            can.productid AS prod,
            can.terminalid AS tratrmidn,
            can.retailerid AS traagt,
            can.transtype AS tratyp,
            can.drawid AS draws_draw,
            can.wager1 + can.wager2 AS transamt,
            can.sales1 + can.sales2 AS saleamt,
            can.salescomm1 + can.salescomm2 AS commamt
           FROM ztrtms_trans_lottery_sweep_90days can
             JOIN ztrtms_trans_lottery_sweep_90days wag ON wag.transheaderid::text = can.transheaderid::text AND "right"(wag.boardid::text, 2) = "right"(can.boardid::text, 2) AND wag.drawid = can.drawid
          WHERE can.transtype = 2 AND can.productid = 11 
         -- AND can.busdate >= ('2022-11-01'::date - '45 days'::interval day) AND can.busdate <= ('2022-11-01'::date + '45 days'::interval day) 
          AND wag.transtype = 1 
          --AND wag.busdate >= ('2022-11-01'::date - '45 days'::interval day) AND wag.busdate <= ('2022-11-01'::date + '45 days'::interval day)
        ), cansweep AS (
         SELECT cansweep_raw.busdate - '1986-05-11'::date AS cdc,
            cansweep_raw.wagbusdate - '1986-05-11'::date AS wagcdc,
            cansweep_raw.prod,
            cansweep_raw.tratrmidn,
            cansweep_raw.traagt,
            cansweep_raw.tratyp,
            cansweep_raw.draws_draw,
            sum(cansweep_raw.transamt) AS transamt,
            sum(cansweep_raw.saleamt) AS saleamt,
            sum(cansweep_raw.commamt) AS commamt
           FROM cansweep_raw
          GROUP BY cansweep_raw.busdate, cansweep_raw.wagbusdate, cansweep_raw.prod, cansweep_raw.tratrmidn, cansweep_raw.traagt, cansweep_raw.tratyp, cansweep_raw.draws_draw
        )
 SELECT collsweep.cdc,
    collsweep.wagcdc,
    collsweep.prod,
    collsweep.tratrmidn,
    collsweep.traagt,
    collsweep.tratyp,
    collsweep.draws_draw,
    collsweep.transamt,
    collsweep.saleamt,
    collsweep.commamt,
        CASE
            WHEN collsweep.wagcdc < 13323 THEN 0.07
            WHEN collsweep.wagcdc >= 13323 THEN 0.08
            ELSE NULL::numeric
        END AS gst,
        CASE
            WHEN collsweep.wagcdc < 13323 THEN 0.07 * collsweep.commamt
            WHEN collsweep.wagcdc >= 13323 THEN 0.08 * collsweep.commamt
            ELSE NULL::double precision
        END AS gstcommamt
   FROM collsweep
UNION ALL
 SELECT cansweep.cdc,
    cansweep.wagcdc,
    cansweep.prod,
    cansweep.tratrmidn,
    cansweep.traagt,
    cansweep.tratyp,
    cansweep.draws_draw,
    cansweep.transamt,
    cansweep.saleamt,
    cansweep.commamt,
        CASE
            WHEN cansweep.wagcdc < 13323 THEN 0.07
            WHEN cansweep.wagcdc >= 13323 THEN 0.08
            ELSE NULL::numeric
        END AS gst,
        CASE
            WHEN cansweep.wagcdc < 13323 THEN 0.07 * cansweep.commamt
            WHEN cansweep.wagcdc >= 13323 THEN 0.08 * cansweep.commamt
            ELSE NULL::double precision
        END AS gstcommamt
   FROM cansweep;
  
  drop table ztrtms_trans_lottery_sweep_90days;
	
	end;
$$;


ALTER FUNCTION public.sp_zves_findata_draw_sweep_bkup_231023() OWNER TO postgres;

--
-- TOC entry 1180 (class 1255 OID 867612)
-- Name: test_insert(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION public.test_insert() RETURNS void
    LANGUAGE plpgsql
    AS $$
#variable_conflict use_column
begin 
	insert into test_outlet select * from ztes_esrm_outlet;
	
END;
$$;


ALTER FUNCTION public.test_insert() OWNER TO postgres;

--
-- TOC entry 1150 (class 1255 OID 24832)
-- Name: test_j1(integer); Type: FUNCTION; Schema: public; Owner: consultant01
--

CREATE FUNCTION public.test_j1(in_amount integer) RETURNS TABLE(out_amount integer, out2_amt integer, seq integer, out3_amt integer)
    LANGUAGE plpgsql
    AS $$

declare
v_amount int4;
v1_amount int4;
v_baseamt int4:=30;
seq int4:=0;

begin
	select in_amount+1 into v_amount;
--return v_amount;

select v_amount into v1_amount;

if v1_amount<>0 then

select v1_amount+5 into v_amount ;
select 1 into seq;
--return v_amount;
end if;

select 10 into v1_amount;
select 1 into seq;


if v1_amount+v_baseamt>30 then
select seq+1 into seq;
end if;

return query
select v1_amount+v_baseamt,v_amount,seq,v1_amount ;
end;
$$;


ALTER FUNCTION public.test_j1(in_amount integer) OWNER TO consultant01;

--
-- TOC entry 1201 (class 1255 OID 24833)
-- Name: sp_adhoc(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_adhoc(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN
     -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

     /*create temporary fact table*/
	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	
    /*Revenue MTD*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	0 as product_id,
	0 as cust_id,
	coalesce(c.acct_id,0),
	1 value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	from ztsapfi_gl a
	left join qlik.dim_account c on cast(right(a.gl_account,7) as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = a.cost_center	
	where a.company_code = '2000'
	and c.acct_fr = '6700300'
	and d.period_id = vPeriod_Id
	group by 
	d.period_id,
	coalesce(f.entity_id,0),
	coalesce(c.acct_id,0)
	;

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type = 2
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2  and a.attrib1_id <> 999
	and c.acct_fr in ('6700300')
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)  and a.attrib1_id <> 999
	and c.acct_fr in ('6700300')
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 ;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;

END;
$$;


ALTER FUNCTION qlik.sp_adhoc(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1161 (class 1255 OID 24834)
-- Name: sp_adhoc_data_fix_5002100(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_adhoc_data_fix_5002100(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11
	--set autocommit = on;

     /*create temporary fact table*/
	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	
    /*Revenue MTD*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	0 as product_id,
	0 as cust_id,
	coalesce(c.acct_id,0),
	1 value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	from public.ztsapfi_gl a
	left join qlik.dim_account c on cast(right(a.gl_account,7) as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = case when coalesce(a.cost_center,'') = ''then a.profit_center else a.cost_center end	
	where a.company_code = '2000'
	and c.acct_fr = '5002100'
	and d.period_id = vPeriod_Id
	group by 
	d.period_id,
	coalesce(f.entity_id,0),
	coalesce(c.acct_id,0)
	;

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type = 2
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2  and a.attrib1_id <> 999
	and c.acct_fr in ('5002100')
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)  and a.attrib1_id <> 999
	and c.acct_fr in ('5002100')
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 ;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;

END;
$$;


ALTER FUNCTION qlik.sp_adhoc_data_fix_5002100(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1162 (class 1255 OID 24835)
-- Name: sp_adhoc_data_fix_5002700(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_adhoc_data_fix_5002700(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

     /*create temporary fact table*/
	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	
    /*Revenue MTD*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	coalesce(e.product_id,0),
	coalesce(g.cust_id,0),
	coalesce(c.acct_id,0),
	coalesce(b.attrib_id,0),
	sum(a.total_value_controlling) as amount,
	coalesce(h.attrib_id,0) as attrib1_id
	 from ztsapfi_copa a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join qlik.dim_account c on right(a.cost_element,7) between c.acct_fr and c.acct_to
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_product e on e.product_cd = a.material
	left join qlik.dim_entity f on f.entity_cd = case when left(right(a.cost_element,7),1)='4' or trim(a.cost_center) = '' or a.cost_center is null 
	then a.profit_center else a.cost_center end 
	left join qlik.dim_customer g on g.cust_cd = a.customer
	left join (select attrib_id,upper(attrib_cd) as attrib_cd from qlik.dim_attribute where attrib_cd = 'SBK') h on h.attrib_cd = upper(a.bet_mode)
	where a.company_code = '2000'
	and c.attribute1 = 'COPA'
	and d.Period_Id = vPeriod_Id
	and c.acct_fr = '5002700'
	group by 
	d.period_id,
	f.entity_id,
	e.product_id,
	g.cust_id,
	c.acct_id,
	b.attrib_id,h.attrib_id;

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type = 2
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2  and a.attrib1_id <> 999
	and c.acct_fr in ('5002700')
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)  and a.attrib1_id <> 999
	and c.acct_fr in ('5002700')
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 ;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;

END;
$$;


ALTER FUNCTION qlik.sp_adhoc_data_fix_5002700(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1168 (class 1255 OID 24836)
-- Name: sp_adhoc_data_fix_5003101(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_adhoc_data_fix_5003101(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN
     -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;
	
    -- run only for Dec-2020
    if vperiod_id = 201912
    then
    
     /*create temporary fact table*/
	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	
    /*Revenue MTD*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	0 as product_id,
	0 as cust_id,
	coalesce(c.acct_id,0),
	1 value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	from public.ztsapfi_gl a
	left join qlik.dim_account c on cast(right(a.gl_account,7) as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = case when coalesce(a.cost_center,'') = ''then a.profit_center else a.cost_center end	
	where a.company_code = '2000'
	and c.acct_fr = '5003101'
	and d.period_id = vperiod_id
	group by 
	d.period_id,
	coalesce(f.entity_id,0),
	coalesce(c.acct_id,0)
	;

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Staging Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
	from (
	
--	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
--		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
--		   a.attrib1_id
--	from qlik.tmp_fact_gl_balance a
--	inner join qlik.dim_account c on c.acct_id = a.acct_id
--	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
--	and b.period_id = vprevperid_id
--	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
--	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
--	and a.value_type = 2 
--	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
--
--	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
--	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
--		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
--		   a.attrib1_id
--	from qlik.tmp_fact_gl_balance a
--	inner join qlik.dim_account c on c.acct_id = a.acct_id
--	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
--	and b.period_id = vprevperid_id
--	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
--	and a.value_type = 2
--	group by 
--	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
--	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	union all

--	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
--		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
--		   a.attrib1_id
--	from qlik.fact_gl_balance a
--	inner join qlik.dim_account c on c.acct_id = a.acct_id
--	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
--	and b.period_id = vPeriod_Id
--	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
--	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
--	and a.value_type = 2  and a.attrib1_id <> 999
--	and c.acct_fr in ('5003101')
--	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
--
--	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)  and a.attrib1_id <> 999
	and c.acct_fr in ('5003101')
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 ;
	
	delete from qlik.fact_gl_balance fgb where 1=1
		and period_id = vperiod_id
		and acct_id in (select acct_id from qlik.dim_account da where acct_fr = '5003101')
		and value_type = 1;

	
	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;
	
	end if;	

END;
$$;


ALTER FUNCTION qlik.sp_adhoc_data_fix_5003101(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1166 (class 1255 OID 24837)
-- Name: sp_count_toto_draw_mix(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_count_toto_draw_mix(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
	vacct_id integer:=989;
BEGIN


     /*create temporary fact table*/
     DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE IF NOT EXISTS qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
     

/*Toto Draw Mix*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	
	select vPeriod_Id,0 as entity_id,2 as product_id, 0 as cust_id, vacct_id as acct_id,b.attrib_id,count(*) as valuecount,0 as attrib1_id from (
	select 
	a.drawnumber,business_date,
	case when trim(to_char(business_date,'day')) = 'friday' then 'Draw Special' else case when coalesce(b.totalamount,0) <> 0 or b.totalamount is null then 'Draw 1'
	when coalesce(b.totalamount,0) = 0 and (coalesce(c.totalamount,0) <> 0 or c.totalamount is null) then 'Draw 2'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and (coalesce(d.totalamount,0) <> 0 or d.totalamount is null) then 'Draw 3'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and (coalesce(e.totalamount,0) <> 0 or e.totalamount is null) then 'Draw 4'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and (coalesce(f.totalamount,0) <> 0 or f.totalamount is null) then 'Draw 1'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and (coalesce(g.totalamount,0) <> 0 or g.totalamount is null) then 'Draw 2'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and coalesce(g.totalamount,0) = 0 and (coalesce(h.totalamount,0) <> 0 or h.totalamount is null) then 'Draw 3'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and coalesce(g.totalamount,0) = 0 and coalesce(h.totalamount,0) = 0 and (coalesce(i.totalamount,0) <> 0 or i.totalamount is null) then 'Draw 4'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and coalesce(g.totalamount,0) = 0 and coalesce(h.totalamount,0) = 0 
	and coalesce(i.totalamount,0) = 0 and (coalesce(j.totalamount,0) <> 0 or j.totalamount is null) then 'Draw 1'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and coalesce(g.totalamount,0) = 0 and coalesce(h.totalamount,0) = 0 
	and coalesce(i.totalamount,0) = 0 and coalesce(j.totalamount,0) = 0 and (coalesce(k.totalamount,0) <> 0 or k.totalamount is null) then 'Draw 2'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and coalesce(g.totalamount,0) = 0 and coalesce(h.totalamount,0) = 0 
	and coalesce(i.totalamount,0) = 0 and coalesce(j.totalamount,0) = 0 and coalesce(k.totalamount,0) = 0 and (coalesce(l.totalamount,0) <> 0 or l.totalamount is null) then 'Draw 3'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and coalesce(g.totalamount,0) = 0 and coalesce(h.totalamount,0) = 0 
	and coalesce(i.totalamount,0) = 0 and coalesce(j.totalamount,0) = 0 and coalesce(k.totalamount,0) = 0 and coalesce(l.totalamount,0) = 0 and (coalesce(m.totalamount,0) <> 0 or m.totalamount is null) then 'Draw 4'
	else 'Draw 1'
	end end as draw_mix

	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber,drawcdc from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber,drawcdc
	order by drawnumber
	)a
	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) b on a.drawnumber = b.drawnumber + 1

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) c on a.drawnumber = c.drawnumber + 2

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) d on a.drawnumber = d.drawnumber + 3

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) e on a.drawnumber = e.drawnumber + 4


	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) f on a.drawnumber = f.drawnumber + 5

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) g on a.drawnumber = g.drawnumber + 6

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) h on a.drawnumber = h.drawnumber + 7

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) i on a.drawnumber = i.drawnumber + 8

		left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) j on a.drawnumber = j.drawnumber + 9

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) k on a.drawnumber = k.drawnumber + 10

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) l on a.drawnumber = l.drawnumber + 11

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) m on a.drawnumber = i.drawnumber + 12
	
	inner join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
	order by a.drawnumber
	) a
	inner join qlik.dim_attribute b on b.attrib_cd = a.draw_mix and b.attrib_cd like 'Draw%'
	where cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id
	group by b.attrib_id;


	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= vPeriod_Id and acct_id = vacct_id;
	analyze qlik.fact_gl_balance;

	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id in (select cast(to_char(cast('1-'||period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period
		where period_id = vPeriod_Id)
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_id=vacct_id
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id in (select cast(to_char(cast('1-'||period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period
		where period_id = vPeriod_Id)
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_id=vacct_id
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vPeriod_Id
	where a.period_id in (select cast(to_char(cast('1-'||period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period
		where period_id = vPeriod_Id) and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_id=vacct_id
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_id=vacct_id
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type
	having sum(opening_amt) + sum(activity_amt) + sum(closing_amt) <> 0;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;
		
END;
$$;


ALTER FUNCTION qlik.sp_count_toto_draw_mix(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1167 (class 1255 OID 24840)
-- Name: sp_count_toto_draw_mix_20200107(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_count_toto_draw_mix_20200107(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
	vacct_id integer:=989;
BEGIN


     /*create temporary fact table*/
     DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE IF NOT EXISTS qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
     

/*Toto Draw Mix*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	
	select vPeriod_Id,0 as entity_id,2 as product_id, 0 as cust_id, vacct_id as acct_id,b.attrib_id,count(*) as valuecount,0 as attrib1_id from (
	select 
	a.drawnumber,business_date,
	case when coalesce(b.totalamount,0) <> 0 or b.totalamount is null then 'Draw 1'
	when coalesce(b.totalamount,0) = 0 and (coalesce(c.totalamount,0) <> 0 or c.totalamount is null) then 'Draw 2'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and (coalesce(d.totalamount,0) <> 0 or d.totalamount is null) then 'Draw 3'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and (coalesce(e.totalamount,0) <> 0 or e.totalamount is null) then 'Draw 4'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and (coalesce(f.totalamount,0) <> 0 or f.totalamount is null) then 'Draw 1'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and (coalesce(g.totalamount,0) <> 0 or g.totalamount is null) then 'Draw 2'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and coalesce(g.totalamount,0) = 0 and (coalesce(h.totalamount,0) <> 0 or h.totalamount is null) then 'Draw 3'
	when coalesce(b.totalamount,0) = 0 and coalesce(c.totalamount,0) = 0 and coalesce(d.totalamount,0) = 0 and coalesce(e.totalamount,0) = 0 and coalesce(f.totalamount,0) = 0 and coalesce(g.totalamount,0) = 0 and coalesce(h.totalamount,0) = 0 and (coalesce(i.totalamount,0) <> 0 or i.totalamount is null) then 'Draw 4'
	else 'Draw 1'
	end as draw_mix

	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber,drawcdc from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber,drawcdc
	order by drawnumber
	)a
	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) b on a.drawnumber = b.drawnumber + 1

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) c on a.drawnumber = c.drawnumber + 2

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) d on a.drawnumber = d.drawnumber + 3

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) e on a.drawnumber = e.drawnumber + 4


	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) f on a.drawnumber = f.drawnumber + 5

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) g on a.drawnumber = g.drawnumber + 6

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) h on a.drawnumber = h.drawnumber + 7

	left join 
	(select *
	from (
	select sum(pollforallocation) as pollforallocation,sum(totalamount) as totalamount,drawnumber from ztes_pdf_winshares  a
	where productname = 't649' and windiv_id = 1
	group by drawnumber
	order by drawnumber
	)a) i on a.drawnumber = i.drawnumber + 8
	inner join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
	order by a.drawnumber
	) a
	inner join qlik.dim_attribute b on b.attrib_cd = a.draw_mix and b.attrib_cd like 'Draw%'
	where cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id
	group by b.attrib_id;


	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= vPeriod_Id and acct_id = vacct_id;
	analyze qlik.fact_gl_balance;

	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id in (select cast(to_char(cast('1-'||period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period
		where period_id = vPeriod_Id)
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_id=vacct_id
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id in (select cast(to_char(cast('1-'||period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period
		where period_id = vPeriod_Id)
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_id=vacct_id
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vPeriod_Id
	where a.period_id in (select cast(to_char(cast('1-'||period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period
		where period_id = vPeriod_Id) and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_id=vacct_id
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_id=vacct_id
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type
	having sum(opening_amt) + sum(activity_amt) + sum(closing_amt) <> 0;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;
		
END;
$$;


ALTER FUNCTION qlik.sp_count_toto_draw_mix_20200107(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1203 (class 1255 OID 24843)
-- Name: sp_dim_employee(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_dim_employee(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	
	vperiod_id integer:= 
		(select 
			case 
				when cast(coalesce(vparperiod) as integer) = 0
				then (select period_id from qlik.dim_period where period_id = cast(to_char(current_date - interval '1' month,'YYYYMM') as integer) )
			else cast(coalesce(vparperiod) as integer) end )
	;


begin
	
analyze qlik.dim_employee;

-- clean up before inserting
delete from qlik.dim_employee de 
where employeeid in ( select distinct employeeid from qlik.stg_employee where period_id = vperiod_id)
;


-- Insert employee records for current period 
INSERT INTO qlik.dim_employee (
	period_id
	, entity_id
	, employeeid
	, employeename
	, employeegroup
	, costcentercode
	, costcentername
	, noofworkinghours
	, joiningdate
	, lastdayofservice
	, employmentstatus
	, repmonthyear
	, payroll_area
)
SELECT period_id
	, case when b.entity_id is null then 0 else b.entity_id end as entity_id
	, employeeid
	, employeename
	, employeegroup
	, costcentercode
	, costcentername 
	, noofworkinghours
	, joiningdate
	, lastdayofservice
	, employmentstatus
	, repmonthyear
	, payroll_area
FROM qlik.stg_employee a
left join qlik.dim_entity b on a.costcentercode=b.entity_cd 
where a.period_id = vperiod_id
;

analyze qlik.dim_employee;

end;

$$;


ALTER FUNCTION qlik.sp_dim_employee(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1159 (class 1255 OID 24844)
-- Name: sp_dim_manual_entries(); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_dim_manual_entries() RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
--	vperiod_id integer:= (select cast(vparperiod as integer));
BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11
	--set autocommit = on;

    -- Create a record in DIM ENTITY if its not already exists
		 INSERT INTO qlik.dim_entity
		(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
		select -1, 'Dummy-LottSplit', 'Interactive Voice Response', '200700', 'IVR', '200700', 'IVR', 'SPPL', '', '', '', 'Remote', '', 'Online', '' 
				where not exists (select 1 from qlik.dim_entity where entity_id = -1);

		INSERT INTO qlik.dim_entity
		(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
		select -2, 'Dummy-LottSplit', 'Remote Betting - Mobile', '201000', 'Remote Ch', '201000', 'Remote Channel', 'SPPL', '', '', '', 'Remote', '', 'Mobile', '' 
				where not exists (select 1 from qlik.dim_entity where entity_id = -2);
			
		INSERT INTO qlik.dim_entity
		(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
		select -3, 'Dummy-LottSplit', 'Interactive Voice Response', '200700', 'IVR', '200700', 'IVR', 'SPPL', '', '', '', 'Remote', '', 'Phone', '' 
				where not exists (select 1 from qlik.dim_entity where entity_id = -3);

			
    -- Create a record in DIM ATTRIBUTES if its not already exists
		
		-- Added for Finance Lottery split - to identify the data populated in fact gl balance due to lottery split function
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -1, 'LS_Online', 'Online', 'Lottery Channel Split' where not exists (select 1 from qlik.dim_attribute where attrib_id =-1);

		--- Added below 3 attributes for "Sports - Live vs Pre-Match vs Special" report
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -2, 'SPORTS', 'Sport Type', 'Live Betting' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-2 or (attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Live Betting') );

		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -3, 'SPORTS', 'Sport Type', 'Pre-Match' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-3 or (attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Pre-Match') );

-- not required				
--		insert into dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
--		select -4, 'SPORTS', 'Sport Type', 'Special' where not exists 
--					(select 1 from qlik.dim_attribute where attrib_id =-4 or (attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Special') );
	
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -5, 'SPORTS', 'League Type', 'World Cup' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-5 or (attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'World Cup') );
					
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -6, 'SPORTS', 'League Type', 'European' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-6 or (attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'European') );
				
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -7, 'SPORTS', 'League Type', 'Leagues' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-7 or (attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'Leagues') );

		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm)
		select -16, 'Target', 'Target' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-16 or (attrib_cd = 'Target' and attrib_nm = 'Target' ) );

		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -17, 'ROYALTY_PAYABLE', 'HR Outbound Races', 'FACT_GL_BALANCES' where not exists (select 1 from qlik.dim_attribute where attrib_id =-17);

					
    -- Create a record in DIM ACCOUNT if its not already exists 
		-- For Channel
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -1, '', '', '', 'Channel', 'Branch', '', '','', '', 'Number of Outlets', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -1 or (acct_lvl1='Channel' 
		and acct_lvl2='Branch' and acct_desc = 'Number of Outlets')) ;
		
			
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -2, '', '', '', 'Channel', 'Livewire', '', '','', '', 'Number of Outlets', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -2 or (acct_lvl1='Channel' 
		and acct_lvl2='Livewire' and acct_desc = 'Number of Outlets')) ;

		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -3, '', '', '', 'Channel', 'OCB & Racecourse', '', '','', '', 'Number of Outlets', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -3 or (acct_lvl1='Channel' 
		and acct_lvl2='OCB & Racecourse' and acct_desc = 'Number of Outlets')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -4, '', '', '', 'Channel', 'Retailer', '', '','', '', 'Number of Outlets', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -4 or (acct_lvl1='Channel' 
		and acct_lvl2='Retailer' and acct_desc = 'Number of Outlets')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -71, '', '', '', 'Channel', 'Retailer', '', '','', '', 'Closure', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -71 or (acct_lvl1='Channel' 
		and acct_lvl2='Retailer' and acct_desc = 'Closure')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -72, '', '', '', 'Channel', 'Branch', '', '','', '', 'Closure', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -72 or (acct_lvl1='Channel' 
		and acct_lvl2='Branch' and acct_desc = 'Closure')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -73, '', '', '', 'Channel', 'Livewire', '', '','', '', 'Closure', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -73 or (acct_lvl1='Channel' 
		and acct_lvl2='Livewire' and acct_desc = 'Closure')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -74, '', '', '', 'Channel', 'OCB & Racecourse', '', '','', '', 'Closure', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -74 or (acct_lvl1='Channel' 
		and acct_lvl2='OCB & Racecourse' and acct_desc = 'Closure')) ;

		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -75, '', '', '', 'Channel', 'Retailer', '', '','', '', 'New Outlet', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -75 or (acct_lvl1='Channel' 
		and acct_lvl2='Retailer' and acct_desc = 'New Outlet')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -76, '', '', '', 'Channel', 'Branch', '', '','', '', 'New Outlet', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -76 or (acct_lvl1='Channel' 
		and acct_lvl2='Branch' and acct_desc = 'New Outlet')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -77, '', '', '', 'Channel', 'Livewire', '', '','', '', 'New Outlet', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -77 or (acct_lvl1='Channel' 
		and acct_lvl2='Livewire' and acct_desc = 'New Outlet')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -78, '', '', '', 'Channel', 'OCB & Racecourse', '', '','', '', 'New Outlet', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -78 or (acct_lvl1='Channel' 
		and acct_lvl2='OCB & Racecourse' and acct_desc = 'New Outlet')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -79, '', '', '', 'Channel', 'Retail', '', '','', '', 'Sales & Payout Availability', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -79 or (acct_lvl1='Channel' 
		and acct_lvl2='Retail' and acct_desc = 'Sales & Payout Availability')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -80, '', '', '', 'Channel', 'Remote', '', '','', '', 'Channel Availability', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -80 or (acct_lvl1='Channel' 
		and acct_lvl2='Remote' and acct_desc = 'Channel Availability')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -81, '', '', '', 'Channel', 'SBK', '', '','', '', 'Channel Availability', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -81 or (acct_lvl1='Channel' 
		and acct_lvl2='SBK' and acct_desc = 'Channel Availability')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -82, '', '', '', 'Channel', 'Remote', '', '','', '', 'Sales Transaction Integrity', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -82 or (acct_lvl1='Channel' 
		and acct_lvl2='Remote' and acct_desc = 'Sales Transaction Integrity')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -83, '', '', '', 'Channel', 'SBK', '', '','', '', 'Sales Transaction Integrity', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -83 or (acct_lvl1='Channel' 
		and acct_lvl2='SBK' and acct_desc = 'Sales Transaction Integrity')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -84, '', '', '', 'Channel', 'Remote', '', '','', '', 'Payout Transaction Integrity', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -84 or (acct_lvl1='Channel' 
		and acct_lvl2='Remote' and acct_desc = 'Payout Transaction Integrity')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -85, '', '', '', 'Channel', 'SBK', '', '','', '', 'Payout Transaction Integrity', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -85 or (acct_lvl1='Channel' 
		and acct_lvl2='SBK' and acct_desc = 'Payout Transaction Integrity')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -86, '', '', '', 'Channel', 'SMS OTP', '', '','', '', 'Pacific Synergy', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -86 or (acct_lvl1='Channel' 
		and acct_lvl2='SMS OTP' and acct_desc = 'Pacific Synergy')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -87, '', '', '', 'Channel', 'DEPOSITS', '', '','', '', 'EFT', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -87 or (acct_lvl1='Channel' 
		and acct_lvl2='DEPOSITS' and acct_desc = 'EFT')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -88, '', '', '', 'Channel', 'DEPOSITS', '', '','', '', 'eNETS', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -88 or (acct_lvl1='Channel' 
		and acct_lvl2='DEPOSITS' and acct_desc = 'eNETS')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -89, '', '', '', 'Channel', 'DEPOSITS', '', '','', '', 'IDD-DBS', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -89 or (acct_lvl1='Channel' 
		and acct_lvl2='DEPOSITS' and acct_desc = 'IDD-DBS')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -90, '', '', '', 'Channel', 'DEPOSITS', '', '','', '', 'IDD-OCBC', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -90 or (acct_lvl1='Channel' 
		and acct_lvl2='DEPOSITS' and acct_desc = 'IDD-OCBC')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -91, '', '', '', 'Channel', 'DEPOSITS', '', '','', '', 'IDD-UOB', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -91 or (acct_lvl1='Channel' 
		and acct_lvl2='DEPOSITS' and acct_desc = 'IDD-UOB')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -92, '', '', '', 'Channel', 'SVC PROVIDER', '', '','', '', 'HR LIVE STREAM', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -92 or (acct_lvl1='Channel' 
		and acct_lvl2='SVC PROVIDER' and acct_desc = 'HR LIVE STREAM')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -143, '', '', '', 'Channel', 'Remote', '', '','', '', 'cost to serve', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -143 or (acct_lvl1='Channel' 
		and acct_lvl2='Remote' and acct_desc = 'cost to serve')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -144, '', '', '', 'Channel', 'Retailer', '', '','', '', 'cost to serve', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -144 or (acct_lvl1='Channel' 
		and acct_lvl2='Retailer' and acct_desc = 'cost to serve')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -145, '', '', '', 'Channel', 'Branch', '', '','', '', 'cost to serve', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -145 or (acct_lvl1='Channel' 
		and acct_lvl2='Branch' and acct_desc = 'cost to serve')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -146, '', '', '', 'Channel', 'Livewire', '', '','', '', 'cost to serve', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -146 or (acct_lvl1='Channel' 
		and acct_lvl2='Livewire' and acct_desc = 'cost to serve')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -147, '', '', '', 'Channel', 'OCB & Racecourse', '', '','', '', 'cost to serve', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -147 or (acct_lvl1='Channel' 
		and acct_lvl2='OCB & Racecourse' and acct_desc = 'cost to serve')) ;
		
		-- For R&C
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -5, '', '', '', 'RNC', 'Remarks-Audit Finding Rectification', '', '','', '',  'Remarks-Audit Finding Rectification', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -5 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Audit Finding Rectification' and acct_desc ='Remarks-Audit Finding Rectification' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -6, '', '', '', 'RNC', 'Remarks-Audit Finding Trend', '', '','', '',  'Remarks-Audit Finding Trend', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -6 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Audit Finding Trend' and acct_desc ='Remarks-Audit Finding Trend' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -7, '', '', '', 'RNC', 'Remarks-Critical Incidents  Overview', '', '','', '',  'Remarks-Critical Incidents  Overview', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -7 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Critical Incidents  Overview' and acct_desc ='Remarks-Critical Incidents  Overview' ));
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -8, '', '', '', 'RNC', 'Pending Rectification', '', '','', '',  'Pending Rectification', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -8 or (acct_lvl1='RNC' and acct_lvl2 ='Pending Rectification' and acct_desc ='Pending Rectification' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -9, '', '', '', 'RNC', 'Incident', '', '','', '',  'Incident', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -9 or (acct_lvl1='RNC' and acct_lvl2 ='Incident' and acct_desc ='Incident' ));
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -10, '', '', '', 'RNC', 'Audit Ratings', '', '','', '',  'Audit Ratings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -10 or (acct_lvl1='RNC' and acct_lvl2 ='Audit Ratings' and acct_desc ='Audit Ratings' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -11, '', '', '', 'RNC', 'Audit Findings', '', '','', '',  'Audit Findings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -11 or (acct_lvl1='RNC' and acct_lvl2 ='Audit Findings' and acct_desc ='Audit Findings' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -12, '', '', '', 'RNC', 'No Of Issue', '', '','', '',  'No Of Issue', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -12 or (acct_lvl1='RNC' and acct_lvl2 ='No Of Issue' and acct_desc ='No Of Issue') );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -13, '', '', '', 'RNC', 'Avg. Audit Findings By Criticality Per Audit', '', '','', '',  'Avg. Audit Findings By Criticality Per Audit', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -13 or (acct_lvl1='RNC' and acct_lvl2 ='Avg. Audit Findings By Criticality Per Audit' and acct_desc ='Avg. Audit Findings By Criticality Per Audit')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -14, '', '', '', 'RNC', 'Rectification Of Audit Findings', '', '','', '',  'Rectification Of Audit Findings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -14 or (acct_lvl1='RNC' and acct_lvl2 ='Rectification Of Audit Findings' and acct_desc ='Rectification Of Audit Findings')  ); 
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -15, '', '', '', 'RNC', 'Audit Findings By Criticality Per Audit', '', '','', '',  'Audit Findings By Criticality Per Audit', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -15 or (acct_lvl1='RNC' and acct_lvl2 ='Audit Findings By Criticality Per Audit' and acct_desc ='Audit Findings By Criticality Per Audit')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -16, '', '', '', 'RNC', 'No Of Audit Issues Per Audit', '', '','', '',  'No Of Audit Issues Per Audit', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -16 or (acct_lvl1='RNC' and acct_lvl2 ='No Of Audit Issues Per Audit' and acct_desc ='No Of Audit Issues Per Audit')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -45, '', '', '', 'RNC', 'Remarks-Audit Ratings', '', '','', '',  'Remarks-Audit Ratings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -45 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Audit Ratings' and acct_desc ='Remarks-Audit Ratings')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -46, '', '', '', 'RNC', 'Remarks-Audit Findings', '', '','', '',  'Remarks-Audit Findings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -46 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Audit Findings' and acct_desc ='Remarks-Audit Findings')  );


		--For Active SPA
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -17, '', '', '', 'Customer', 'SPA Application Update', '', '','', '',  'Activated SPA', '', 'Customer'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -17 or (acct_lvl1='Customer' 
		and acct_lvl2='SPA Application Update' and acct_desc = 'Activated SPA')) ;

	
		/* Start of manual dim account entries for Fact Product Dimensions */	

		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -18, '', '', '', 'FACT_PRODUCT', '4D', '', '','', '',  '4D Average Revenue per Draw', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -18 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Average Revenue per Draw'));

	   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -19, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Total Collection', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -19 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Total Collection'));

		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -20, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Sales', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -20 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Sales'));

		
	   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -21, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Event', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -21 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Event'));

			
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -22, '', '', '', 'FACT_PRODUCT', '4D', '', '','', '',  '4D Payout Distribution', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -22
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Payout Distribution'));			
		
			
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -23, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Sales by Draw Type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -23 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Draw Type'));

			
  		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -24, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Count by Draw Type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -24 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Count by Draw Type'));
			
	   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -25, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Draw Results', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -25 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Draw Results'));
	
			
		/* End of manual dim account entries for Fact Product Dimensions */
			
		/* stard of manual dim account entries for Fact PnC Training  */
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -29, '', '', '', 'PNC', 'Headcount', '', '','', '',  'Headcount', '', 'PNC Employee'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -29 or (acct_lvl1='PNC' and acct_lvl2 ='Headcount' and acct_desc ='Headcount')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -30, '', '', '', 'PNC', 'IDP Submission - Pending CO', '', '','', '',  'IDP Submission - Pending CO', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -30 or (acct_lvl1='PNC' and acct_lvl2 ='IDP Submission - Pending CO' and acct_desc ='IDP Submission - Pending CO')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -31, '', '', '', 'PNC', 'IDP Submission - Pending Employee', '', '','', '',  'IDP Submission - Pending Employee', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -31 or (acct_lvl1='PNC' and acct_lvl2 ='IDP Submission - Pending Employee' and acct_desc ='IDP Submission - Pending Employee')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -32, '', '', '', 'PNC', 'IDP Submission - Pending RO', '', '','', '',  'IDP Submission - Pending RO', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -32 or (acct_lvl1='PNC' and acct_lvl2 ='IDP Submission - Pending RO' and acct_desc ='IDP Submission - Pending RO')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -33, '', '', '', 'PNC', 'National Avg - Training Day by FTE', '', '','', '',  'National Avg - Training Day by FTE', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -33 or (acct_lvl1='PNC' and acct_lvl2 ='National Avg - Training Day by FTE' and acct_desc ='National Avg - Training Day by FTE')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -34, '', '', '', 'PNC', 'National Avg - Training Receive by FTE%', '', '','', '',  'National Avg - Training Receive by FTE%', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -34 or (acct_lvl1='PNC' and acct_lvl2 ='National Avg - Training Receive by FTE%' and acct_desc ='National Avg - Training Receive by FTE%')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -35, '', '', '', 'PNC', 'New Hire', '', '','', '',  'New Hire', '', 'PNC Employee'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -35 or (acct_lvl1='PNC' and acct_lvl2 ='New Hire' and acct_desc ='New Hire')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -36, '', '', '', 'PNC', 'Remarks - Headcount By Division', '', '','', '',  'Remarks - Headcount By Division', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -36 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Headcount By Division' and acct_desc ='Remarks - Headcount By Division')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -37, '', '', '', 'PNC', 'Remarks - Submission Of IDP', '', '','', '',  'Remarks - Submission Of IDP', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -37 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Submission Of IDP)' and acct_desc ='Remarks - Submission Of IDP')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -38, '', '', '', 'PNC', 'Remarks - Training Actual vs Budget (Finance)', '', '','', '',  'Remarks - Training Actual vs Budget (Finance)', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -38 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Training Actual vs Budget (Finance)' and acct_desc ='Remarks - Training Actual vs Budget (Finance)')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -39, '', '', '', 'PNC', 'Remarks - Training Day Per FTE', '', '','', '',  'Remarks - Training Day Per FTE', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -39 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Training Day Per FTE' and acct_desc ='Remarks - Training Day Per FTE')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -40, '', '', '', 'PNC', 'Remarks - Training Stats (FTE received Training)', '', '','', '',  'Remarks - Training Stats (FTE received Training)', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -40 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Training Stats (FTE received Training)' and acct_desc ='Remarks - Training Stats (FTE received Training)')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -50, '', '', '', 'PNC', 'Remarks - Turnovers of New Hires (Perm)', '', '','', '',  'Remarks - Turnovers of New Hires (Perm) in the last 12 Months', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -50 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Turnovers of New Hires (Perm)' and acct_desc ='Remarks - Turnovers of New Hires (Perm) in the last 12 Months')  );
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -51, '', '', '', 'PNC', 'Remarks - Leavers', '', '','', '',  'Remarks - Leavers', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -51 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Leavers' and acct_desc ='Remarks - Leavers')  );
			INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -52, '', '', '', 'PNC', 'Training Day by FTE', '', '','', '',  'Training Day by FTE', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -52 or (acct_lvl1='PNC' and acct_lvl2 ='Training Day by FTE' and acct_desc ='Training Day by FTE')  );
			INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -53, '', '', '', 'PNC', 'Training Receive by FTE%', '', '','', '',  'Training Receive by FTE%', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -53 or (acct_lvl1='PNC' and acct_lvl2 ='Training Receive by FTE%' and acct_desc ='Training Receive by FTE%')  );
		INSERT INTO qlik.dim_account(
		    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -54, '', '', '', 'PNC', 'Leavers', '', '','', '',  'Leavers', '', 'PNC Employee'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -54 or (acct_lvl1='PNC' and acct_lvl2 ='Leavers' and acct_desc ='Leavers')  );

		/* End of manual dim account entries for Fact PnC */

	/* account entries for customer */
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -93, '', '', '', 'Customer', 'Customer Service KPI', '', '','', '',  'Number of days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -93 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI' and acct_desc ='Number of days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -94, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'Call Handeled', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -94 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='Call Handeled')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -95, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'Call Handled', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -95 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='Call Handled')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -96, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'Call service level', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -96 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='Call service level')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -97, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'Customer service hotline offered calls', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -97 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='Customer service hotline offered calls')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -98, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'KPI Benchmark service call answered within 20 Seconds', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -98 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='KPI Benchmark service call answered within 20 Seconds')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -99, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'Remarks', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -99 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='Remarks')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -100, '', '', '', 'Customer', 'Customer Service KPI-Cases', '', '','', '',  'KPI Benchmark cases resolved within 3 working days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -100 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Cases' and acct_desc ='KPI Benchmark cases resolved within 3 working days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -101, '', '', '', 'Customer', 'Customer Service KPI-Cases', '', '','', '',  'Remarks', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -101 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Cases' and acct_desc ='Remarks')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -102, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'KPI Benchmark eKYC calls handled', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -102 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='KPI Benchmark eKYC calls handled')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -103, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'Remarks', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -103 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='Remarks')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -104, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'KPI Benchmark KYC processed by checker within 2 days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -104 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='KPI Benchmark KYC processed by checker within 2 days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -105, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'Remarks', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -105 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='Remarks')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -106, '', '', '', 'Customer', 'Customer Support KPI-SVCS Cases', '', '','', '',  'KPI Benchmark SVCS cases resolved within 3 days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -106 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-SVCS Cases' and acct_desc ='KPI Benchmark SVCS cases resolved within 3 days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -107, '', '', '', 'Customer', 'Customer Support KPI-SVCS Cases', '', '','', '',  'Remarks', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -107 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-SVCS Cases' and acct_desc ='Remarks')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -108, '', '', '', 'Customer', 'SPA Application', '', '','', '',  'Reactivation(closed SPA)', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -108 
		or (acct_lvl1='Customer' and acct_lvl2 ='SPA Application' and acct_desc ='Reactivation(closed SPA)')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -109, '', '', '', 'Customer', 'SPA Application', '', '','', '',  'Remarks', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -109 
		or (acct_lvl1='Customer' and acct_lvl2 ='SPA Application' and acct_desc ='Remarks')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -110, '', '', '', 'Customer', 'SPA Application', '', '','', '',  'Re-registration(incomplete KYC)', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -110 
		or (acct_lvl1='Customer' and acct_lvl2 ='SPA Application' and acct_desc ='Re-registration(incomplete KYC)')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -111, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'KPI Benchmark service call answered within 20 Seconds', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -111 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='KPI Benchmark service call answered within 20 Seconds')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -112, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'Call service level', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -112 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='Call service level')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -113, '', '', '', 'Customer', 'Customer Service KPI-Calls', '', '','', '',  'Customer service hotline offered calls', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -113 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Calls' and acct_desc ='Customer service hotline offered calls')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -114, '', '', '', 'Customer', 'Customer Service KPI-Cases', '', '','', '',  'KPI Benchmark cases resolved within 3 working days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -114 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Cases' and acct_desc ='KPI Benchmark cases resolved within 3 working days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -115, '', '', '', 'Customer', 'Customer Service KPI-Cases', '', '','', '',  'Cases SLA', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -115 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Cases' and acct_desc ='Cases SLA')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -116, '', '', '', 'Customer', 'Customer Service KPI-Cases', '', '','', '',  'Top 10 Category of cases', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -116 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Cases' and acct_desc ='Top 10 Category of cases')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -117, '', '', '', 'Customer', 'Customer Service KPI-Cases', '', '','', '',  'No. of cases handeled', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -117 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Service KPI-Cases' and acct_desc ='No. of cases handeled')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -118, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'Total eKYC Calls', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -118 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='Total eKYC Calls')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -119, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'eKYC Calls handeled', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -119 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='eKYC Calls handeled')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -120, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'eKYC callattempt per Applicant', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -120 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='eKYC callattempt per Applicant')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -121, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'Passed by Maker', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -121 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='Passed by Maker')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -122, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'KPI Benchmark eKYC calls handled', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -122 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='KPI Benchmark eKYC calls handled')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -123, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'KPI eKYC Call handled', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -123 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='KPI eKYC Call handled')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -124, '', '', '', 'Customer', 'Customer Support KPI-eKYC Calls', '', '','', '',  'Incomplete eKYC -Key reasons', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -124 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-eKYC Calls' and acct_desc ='Incomplete eKYC -Key reasons')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -125, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'KPI Benchmark KYC processed by checker within 2 days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -125 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='KPI Benchmark KYC processed by checker within 2 days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -126, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'KYC processed by checker within 2 days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -126 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='KYC processed by checker within 2 days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -127, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'Total KYC passed', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -127 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='Total KYC passed')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -128, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'eKYC passed', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -128 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='eKYC passed')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -129, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'Branch KYC passed', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -129 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='Branch KYC passed')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -130, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'Total cases Processed', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -130 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='Total cases Processed')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -131, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'Cases -Marked as Incomplete', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -131 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='Cases -Marked as Incomplete')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -132, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'Cases -Approved', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -132 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='Cases -Approved')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -133, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'Cases -Send for Amendments', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -133 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='Cases -Send for Amendments')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -134, '', '', '', 'Customer', 'Customer Support KPI-KYC Cases', '', '','', '',  'Cases -Rejected', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -134 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-KYC Cases' and acct_desc ='Cases -Rejected')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -135, '', '', '', 'Customer', 'Customer Support KPI-SVCS Cases', '', '','', '',  'KPI Benchmark SVCS cases resolved within 3 days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -135 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-SVCS Cases' and acct_desc ='KPI Benchmark SVCS cases resolved within 3 days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -136, '', '', '', 'Customer', 'Customer Support KPI-SVCS Cases', '', '','', '',  'SVCS cases resolved within 3 days', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -136 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-SVCS Cases' and acct_desc ='SVCS cases resolved within 3 days')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -137, '', '', '', 'Customer', 'Customer Support KPI-SVCS Cases', '', '','', '',  'Top 10 Category of SVCS cases', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -137 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-SVCS Cases' and acct_desc ='Top 10 Category of SVCS cases')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -138, '', '', '', 'Customer', 'Customer Support KPI-SVCS Cases', '', '','', '',  'No. of SVCS cases handeled', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -138 
		or (acct_lvl1='Customer' and acct_lvl2 ='Customer Support KPI-SVCS Cases' and acct_desc ='No. of SVCS cases handeled')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -139, '', '', '', 'Customer', 'SPA Application', '', '','', '',  'Total SPA application', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -139 
		or (acct_lvl1='Customer' and acct_lvl2 ='SPA Application' and acct_desc ='Total SPA application')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -140, '', '', '', 'Customer', 'SPA Application', '', '','', '',  'Activated SPA', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -140 
		or (acct_lvl1='Customer' and acct_lvl2 ='SPA Application' and acct_desc ='Activated SPA')  );
		INSERT INTO qlik.dim_account( acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
				    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2) 
		SELECT -141, '', '', '', 'Customer', 'SPA Application', '', '','', '',  'New Application', '', 'Customer' 
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -141 
		or (acct_lvl1='Customer' and acct_lvl2 ='SPA Application' and acct_desc ='New Application')  );

	/* Start of manual dim product entries */	
				
	INSERT INTO qlik.dim_product
		(product_id, product_cd, product_nm, product_lvl1, product_lvl2, attribute1, attribute2)
		select -1, 'SPORTS', 'SPORTS', 'SPORTS', '', '', ''
	WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_product where product_id = -1 
				or (product_cd = 'SPORTS' and product_nm= 'SPORTS' and product_lvl1 = 'SPORTS'));


END;
$$;


ALTER FUNCTION qlik.sp_dim_manual_entries() OWNER TO sp_postgres;

--
-- TOC entry 1156 (class 1255 OID 24847)
-- Name: sp_dim_manual_entries_bk_20210628(); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_dim_manual_entries_bk_20210628() RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
--	vperiod_id integer:= (select cast(vparperiod as integer));
BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11
	--set autocommit = on;

    -- Create a record in DIM ENTITY if its not already exists
		 INSERT INTO qlik.dim_entity
		(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
		select -1, 'Dummy-LottSplit', 'Interactive Voice Response', '200700', 'IVR', '200700', 'IVR', 'SPPL', '', '', '', 'Remote', '', 'Online', '' 
				where not exists (select 1 from qlik.dim_entity where entity_id = -1);

		INSERT INTO qlik.dim_entity
		(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
		select -2, 'Dummy-LottSplit', 'Remote Betting - Mobile', '201000', 'Remote Ch', '201000', 'Remote Channel', 'SPPL', '', '', '', 'Remote', '', 'Mobile', '' 
				where not exists (select 1 from qlik.dim_entity where entity_id = -2);
			
		INSERT INTO qlik.dim_entity
		(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
		select -3, 'Dummy-LottSplit', 'Interactive Voice Response', '200700', 'IVR', '200700', 'IVR', 'SPPL', '', '', '', 'Remote', '', 'Phone', '' 
				where not exists (select 1 from qlik.dim_entity where entity_id = -3);

			
    -- Create a record in DIM ATTRIBUTES if its not already exists
		
		-- Added for Finance Lottery split - to identify the data populated in fact gl balance due to lottery split function
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -1, 'LS_Online', 'Online', 'Lottery Channel Split' where not exists (select 1 from qlik.dim_attribute where attrib_id =-1);

		--- Added below 3 attributes for "Sports - Live vs Pre-Match vs Special" report
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -2, 'SPORTS', 'Sport Type', 'Live Betting' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-2 or (attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Live Betting') );

		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -3, 'SPORTS', 'Sport Type', 'Pre-Match' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-3 or (attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Pre-Match') );

-- not required				
--		insert into dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
--		select -4, 'SPORTS', 'Sport Type', 'Special' where not exists 
--					(select 1 from qlik.dim_attribute where attrib_id =-4 or (attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Special') );
	
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -5, 'SPORTS', 'League Type', 'World Cup' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-5 or (attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'World Cup') );
					
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -6, 'SPORTS', 'League Type', 'European' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-6 or (attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'European') );
				
		insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -7, 'SPORTS', 'League Type', 'Leagues' where not exists 
					(select 1 from qlik.dim_attribute where attrib_id =-7 or (attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'Leagues') );
	
    -- Create a record in DIM ACCOUNT if its not already exists 
		-- For Channel
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -1, '', '', '', 'Channel', 'Branch', '', '','', '', 'Number of Outlets', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -1 or (acct_lvl1='Channel' 
		and acct_lvl2='Branch' and acct_desc = 'Number of Outlets')) ;
		
			
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -2, '', '', '', 'Channel', 'Livewire', '', '','', '', 'Number of Outlets', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -2 or (acct_lvl1='Channel' 
		and acct_lvl2='Livewire' and acct_desc = 'Number of Outlets')) ;

		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -3, '', '', '', 'Channel', 'OCB & Racecourse', '', '','', '', 'Number of Outlets', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -3 or (acct_lvl1='Channel' 
		and acct_lvl2='OCB & Racecourse' and acct_desc = 'Number of Outlets')) ;
		
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -4, '', '', '', 'Channel', 'Retailer', '', '','', '', 'Number of Outlets', '', 'Channel'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -4 or (acct_lvl1='Channel' 
		and acct_lvl2='Retailer' and acct_desc = 'Number of Outlets')) ;
		

		-- For R&C
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -5, '', '', '', 'RNC', 'Remarks-Audit Finding Rectification', '', '','', '',  'Remarks-Audit Finding Rectification', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -5 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Audit Finding Rectification' and acct_desc ='Remarks-Audit Finding Rectification' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -6, '', '', '', 'RNC', 'Remarks-Audit Finding Trend', '', '','', '',  'Remarks-Audit Finding Trend', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -6 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Audit Finding Trend' and acct_desc ='Remarks-Audit Finding Trend' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -7, '', '', '', 'RNC', 'Remarks-Critical Incidents  Overview', '', '','', '',  'Remarks-Critical Incidents  Overview', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -7 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Critical Incidents  Overview' and acct_desc ='Remarks-Critical Incidents  Overview' ));
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -8, '', '', '', 'RNC', 'Pending Rectification', '', '','', '',  'Pending Rectification', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -8 or (acct_lvl1='RNC' and acct_lvl2 ='Pending Rectification' and acct_desc ='Pending Rectification' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -9, '', '', '', 'RNC', 'Incident', '', '','', '',  'Incident', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -9 or (acct_lvl1='RNC' and acct_lvl2 ='Incident' and acct_desc ='Incident' ));
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -10, '', '', '', 'RNC', 'Audit Ratings', '', '','', '',  'Audit Ratings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -10 or (acct_lvl1='RNC' and acct_lvl2 ='Audit Ratings' and acct_desc ='Audit Ratings' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -11, '', '', '', 'RNC', 'Audit Findings', '', '','', '',  'Audit Findings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -11 or (acct_lvl1='RNC' and acct_lvl2 ='Audit Findings' and acct_desc ='Audit Findings' ) );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -12, '', '', '', 'RNC', 'No Of Issue', '', '','', '',  'No Of Issue', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -12 or (acct_lvl1='RNC' and acct_lvl2 ='No Of Issue' and acct_desc ='No Of Issue') );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -13, '', '', '', 'RNC', 'Avg. Audit Findings By Criticality Per Audit', '', '','', '',  'Avg. Audit Findings By Criticality Per Audit', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -13 or (acct_lvl1='RNC' and acct_lvl2 ='Avg. Audit Findings By Criticality Per Audit' and acct_desc ='Avg. Audit Findings By Criticality Per Audit')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -14, '', '', '', 'RNC', 'Rectification Of Audit Findings', '', '','', '',  'Rectification Of Audit Findings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -14 or (acct_lvl1='RNC' and acct_lvl2 ='Rectification Of Audit Findings' and acct_desc ='Rectification Of Audit Findings')  ); 
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -15, '', '', '', 'RNC', 'Audit Findings By Criticality Per Audit', '', '','', '',  'Audit Findings By Criticality Per Audit', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -15 or (acct_lvl1='RNC' and acct_lvl2 ='Audit Findings By Criticality Per Audit' and acct_desc ='Audit Findings By Criticality Per Audit')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -16, '', '', '', 'RNC', 'No Of Audit Issues Per Audit', '', '','', '',  'No Of Audit Issues Per Audit', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -16 or (acct_lvl1='RNC' and acct_lvl2 ='No Of Audit Issues Per Audit' and acct_desc ='No Of Audit Issues Per Audit')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -45, '', '', '', 'RNC', 'Remarks-Audit Ratings', '', '','', '',  'Remarks-Audit Ratings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -15 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Audit Ratings' and acct_desc ='Remarks-Audit Ratings')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -46, '', '', '', 'RNC', 'Remarks-Audit Findings', '', '','', '',  'Remarks-Audit Findings', '', 'RNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -16 or (acct_lvl1='RNC' and acct_lvl2 ='Remarks-Audit Findings' and acct_desc ='Remarks-Audit Findings')  );


		--For Active SPA
		INSERT INTO qlik.dim_account(
		acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
		acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -17, '', '', '', 'Customer', 'SPA Application Update', '', '','', '',  'Actived SPA', '', 'Customer'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -17 or (acct_lvl1='Customer' 
		and acct_lvl2='SPA Application Update' and acct_desc = 'Actived SPA')) ;

	
		/* Start of manual dim account entries for Fact Product Dimensions */	

		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -18, '', '', '', 'FACT_PRODUCT', '4D', '', '','', '',  '4D Average Revenue per Draw', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -18 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Average Revenue per Draw'));

	   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -19, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Total Collection', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -19 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Total Collection'));

		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -20, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Sales', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -20 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Sales'));

		
	   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -21, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Average Revenue', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -21 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Average Revenue'));

			
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -22, '', '', '', 'FACT_PRODUCT', '4D', '', '','', '',  '4D Payout Distribution', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -22
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Payout Distribution'));			
		
			
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -23, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Sales by Draw Type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -23 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Draw Type'));

			
  		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -24, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Count by Draw Type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -24 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Count by Draw Type'));
			
	   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -25, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Draw Results', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -25 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Draw Results'));
	
			
		/* End of manual dim account entries for Fact Product Dimensions */
			
		/* stard of manual dim account entries for Fact PnC Training  */
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -29, '', '', '', 'PNC', 'Headcount', '', '','', '',  'Headcount', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -29 or (acct_lvl1='PNC' and acct_lvl2 ='Headcount' and acct_desc ='Headcount')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -30, '', '', '', 'PNC', 'IDP Submission - Pending CO', '', '','', '',  'IDP Submission - Pending CO', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -30 or (acct_lvl1='PNC' and acct_lvl2 ='IDP Submission - Pending CO' and acct_desc ='IDP Submission - Pending CO')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -31, '', '', '', 'PNC', 'IDP Submission - Pending Employee', '', '','', '',  'IDP Submission - Pending Employee', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -31 or (acct_lvl1='PNC' and acct_lvl2 ='IDP Submission - Pending Employee' and acct_desc ='IDP Submission - Pending Employee')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -32, '', '', '', 'PNC', 'IDP Submission - Pending RO', '', '','', '',  'IDP Submission - Pending RO', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -32 or (acct_lvl1='PNC' and acct_lvl2 ='IDP Submission - Pending RO' and acct_desc ='IDP Submission - Pending RO')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -33, '', '', '', 'PNC', 'National Avg - Training Day by FTE', '', '','', '',  'National Avg - Training Day by FTE', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -33 or (acct_lvl1='PNC' and acct_lvl2 ='National Avg - Training Day by FTE' and acct_desc ='National Avg - Training Day by FTE')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -34, '', '', '', 'PNC', 'National Avg - Training Receive by FTE%', '', '','', '',  'National Avg - Training Receive by FTE%', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -34 or (acct_lvl1='PNC' and acct_lvl2 ='National Avg - Training Receive by FTE%' and acct_desc ='National Avg - Training Receive by FTE%')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -35, '', '', '', 'PNC', 'New Hire', '', '','', '',  'New Hire', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -35 or (acct_lvl1='PNC' and acct_lvl2 ='New Hire' and acct_desc ='New Hire')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -36, '', '', '', 'PNC', 'Remarks - Headcount By Division', '', '','', '',  'Remarks - Headcount By Division', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -36 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Headcount By Division' and acct_desc ='Remarks - Headcount By Division')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -37, '', '', '', 'PNC', 'Remarks - Submission Of IDP', '', '','', '',  'Remarks - Submission Of IDP', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -37 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Submission Of IDP)' and acct_desc ='Remarks - Submission Of IDP')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -38, '', '', '', 'PNC', 'Remarks - Training Actual vs Budget (Finance)', '', '','', '',  'Remarks - Training Actual vs Budget (Finance)', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -38 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Training Actual vs Budget (Finance)' and acct_desc ='Remarks - Training Actual vs Budget (Finance)')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -39, '', '', '', 'PNC', 'Remarks - Training Day Per FTE', '', '','', '',  'Remarks - Training Day Per FTE', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -39 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Training Day Per FTE' and acct_desc ='Remarks - Training Day Per FTE')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -40, '', '', '', 'PNC', 'Remarks - Training Stats (FTE received Training)', '', '','', '',  'Remarks - Training Stats (FTE received Training)', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -40 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Training Stats (FTE received Training)' and acct_desc ='Remarks - Training Stats (FTE received Training)')  );
		
		INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -50, '', '', '', 'PNC', 'Remarks - Turnovers of New Hires (Perm)', '', '','', '',  'Remarks - Turnovers of New Hires (Perm) in the last 12 Months', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -50 or (acct_lvl1='PNC' and acct_lvl2 ='Remarks - Turnovers of New Hires (Perm)' and acct_desc ='Remarks - Turnovers of New Hires (Perm) in the last 12 Months')  );
			INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -51, '', '', '', 'PNC', 'Resignation', '', '','', '',  'Resignation', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -51 or (acct_lvl1='PNC' and acct_lvl2 ='Resignation' and acct_desc ='Resignation')  );
			INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -52, '', '', '', 'PNC', 'Training Day by FTE', '', '','', '',  'Training Day by FTE', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -52 or (acct_lvl1='PNC' and acct_lvl2 ='Training Day by FTE' and acct_desc ='Training Day by FTE')  );
			INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -53, '', '', '', 'PNC', 'Training Receive by FTE%', '', '','', '',  'Training Receive by FTE%', '', 'PNC'
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -53 or (acct_lvl1='PNC' and acct_lvl2 ='Training Receive by FTE%' and acct_desc ='Training Receive by FTE%')  );


		/* End of manual dim account entries for Fact PnC */


	/* Start of manual dim product entries */	
				
	INSERT INTO qlik.dim_product
		(product_id, product_cd, product_nm, product_lvl1, product_lvl2, attribute1, attribute2)
		select -1, 'SPORTS', 'SPORTS', 'SPORTS', '', '', ''
	WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_product where product_id = -1 
				or (product_cd = 'SPORTS' and product_nm= 'SPORTS' and product_lvl1 = 'SPORTS'));


END;

$$;


ALTER FUNCTION qlik.sp_dim_manual_entries_bk_20210628() OWNER TO sp_postgres;

--
-- TOC entry 1206 (class 1255 OID 24850)
-- Name: sp_dim_toto_draw_type(); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_dim_toto_draw_type() RETURNS void
    LANGUAGE plpgsql
    AS $$
declare

BEGIN
   -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

	delete from qlik.dim_toto_draw_type where 1=1; 
  
   insert into qlik.dim_toto_draw_type
   select drawnumber, draw_type from (
	select business_date,drawnumber,winner_flag,payout,prize_amt,prev_winner_flag,seq_grp,draw_group
	, sum(seq_draw) over (partition by draw_group order by business_date) as draw_type
	from (
		select business_date,drawnumber,winner_flag,payout,prize_amt,prev_winner_flag ,seq_grp
		, sum(seq_grp) over ( order by business_date ) draw_group, 1 seq_draw
		from (
			select business_date,drawnumber
			, winner_flag
			, payout, prize_amt
			, coalesce(lag(winner_flag,1) over (partition by null order by business_date),'S') as prev_winner_flag
			, case when coalesce(lag(winner_flag,1) over (partition by null order by business_date),'S') in ('N','S') 
				and prize_amt > 1.65 then 0 else 1 end as seq_grp
			from  (
				select b.business_date, a.drawnumber
				, round(a.pollforallocation::decimal/100000000,2) as prize_amt
				, a.totalamount payout
				, case when a.totalamount <> 0 then 'Y' else 'N' end as winner_flag
				from public.ztes_pdf_winshares a
				inner join ztall_businessday b on (b.system='ES' and a.drawcdc = b.business_id)
				where a.productnum in (select cast(product as integer) from ztall_product where productname  = 'TOTO')
				and b.business_date >= to_date('20160114','YYYYMMDD') -- pass date for starting point of draw 1
				and windiv_id =1
				)sub1
			order by business_date
			)sub2
		)sub3
	)sub4
	order by 1
	;

END;
$$;


ALTER FUNCTION qlik.sp_dim_toto_draw_type() OWNER TO sp_postgres;

--
-- TOC entry 1170 (class 1255 OID 24851)
-- Name: sp_employee_fte(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_employee_fte(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN

	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
     

	insert into qlik.tmp_fact_gl_balance (
		 period_id,
		  entity_id,
		  product_id,
		  cust_id,
		  acct_id,
		  value_type,
		  activity_amt,
		  attrib1_id
		)
	select a.period_id,coalesce(c.entity_id,0) as entity_id,0 as product_id,0 as cust_id,b.acct_id as acct_id,1 as value_type,sum(case when a.employeegroup = 'Casual' then noofworkinghours else 1 end)/max(case when a.employeegroup = 'Casual' then 178.75 else 1 end) as activity_amt,coalesce(d.attrib_id,0) as attrib1_id 
	from qlik.stg_employee_fte a 
	left join qlik.dim_account b on b.acct_desc = 'FTE'
	left join qlik.dim_entity c on c.entity_cd = a.costcentercode
	left join qlik.dim_attribute d on upper(d.attrib_cd) = upper(a.employeegroup)
	where a.period_id = vperiod_id
	group by a.period_id,coalesce(c.entity_id,0),b.acct_id,d.attrib_id
	union all
	select a.period_id,coalesce(c.entity_id,0) as entity_id,0 as product_id,0 as cust_id,b.acct_id as acct_id,1 as value_type,count(*) as activity_amt,d.attrib_id as attrib1_id 
	from qlik.stg_employee_fte a 
	left join qlik.dim_account b on b.acct_desc = 'Headcount'
	left join qlik.dim_entity c on c.entity_cd = a.costcentercode
	left join qlik.dim_attribute d on upper(d.attrib_cd) = upper(a.employeegroup)
	where a.period_id = vperiod_id
	group by a.period_id,coalesce(c.entity_id,0),b.acct_id,d.attrib_id
	;

	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= coalesce(vperiod_id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_type = 'M') and 0 < (select count(*) from qlik.stg_employee_fte);

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
		   ,a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_type = 'M'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null 
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
		   ,a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_type = 'M'
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
		   ,a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vPeriod_Id and a.attrib1_id = b.attrib1_id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_type = 'M'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and  c.acct_type = 'M'
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) + sum(activity_amt) + sum(closing_amt) <> 0;

	
	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;
END;
$$;


ALTER FUNCTION qlik.sp_employee_fte(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1208 (class 1255 OID 24852)
-- Name: sp_fact_customer(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_customer(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$ 

declare 
	vperiod_id integer := ( select cast(vparperiod as integer));


begin

	/* Active SPA */
	
	/*
	 * Historical Active SPA count is loaded from the file. Historical data should contain records and not just delta.
	 * New Active SPA count will be coming from PG table ztob_customer
	 * 
	 */

	
--	drop table if exists qlik.stg_active_spa;

-- Create staging table to load data from PG table
		CREATE TABLE if not exists qlik.stg_active_spa 
					(
					processing_date date NOT NULL,
					customers_activated int4 null
					);
		
		-- Delete data from staging active SPA for the current data before loading
		delete from qlik.stg_active_spa where processing_date = current_date-2;
		
		-- Load snapshot data in staging active SPA table for current date
		-- This staging table will not delete any historical data as it is a snapshot table
		insert into qlik.stg_active_spa
			select current_date -2 as "Processing_date"
					, count(distinct account_no ) as "Customers_Activated"
				from public.ztob_customer where 1=1
				and cast(activation_date as date) = current_date -2
				and status = 'A' and kyc_status like '%Pass%' and bkgd_status like '%Pass%';

		-- Load data from staging table to temp table for periods
		drop table if exists qlik.tmp_active_spa;
	
		create table qlik.tmp_active_spa as
			select period_id, acct_id , attrib1_id, attrib2_id, opening_amt
			, activity_amt
			, activity_amt as closing_amt
			from (
			select cast(to_char(processing_date, 'YYYYMM') as integer) as period_id
			, -17 as acct_id
			, 0 as attrib1_id
			, 0 as attrib2_id
			, 0 as opening_amt
			, sum(customers_activated) as activity_amt
			from qlik.stg_active_spa
			group by cast(to_char(processing_date, 'YYYYMM') as integer)
			)sq
			order by 1;
	
		
	  	/*
	  	 * Historical data from file will be loaded to STG_ACTIVE_SPA_CUSTOMER
	  	 * Below code loads data from STG_ACTIVE_SPA_CUSTOMER to a temp table
		*/
		drop table if exists qlik.tmp_active_spa_otl;
	
		create table qlik.tmp_active_spa_otl  as
			select period_id, acct_id , attrib1_id, attrib2_id, opening_amt
			, activity_amt
			, activity_amt as closing_amt
			from (
			select cast(to_char(date, 'YYYYMM') as integer) as period_id
			, -17 as acct_id
			, 0 as attrib1_id
			, 0 as attrib2_id
			, 0 as opening_amt
			, sum("Customers Activated") as activity_amt
			from qlik.STG_ACTIVE_SPA_CUSTOMER
			group by to_char(date, 'YYYYMM')
			)sq
			order by 1	;

		
		-- delete data from Fact_customer before reloading
		delete from qlik.fact_customer where acct_id =-17 and period_id 
			in (select distinct period_id from qlik.tmp_active_spa 
					where period_id not in (select distinct period_id from qlik.tmp_active_spa_otl)
				);

		delete from qlik.fact_customer where acct_id = -17 and period_id 
			in (select distinct period_id from qlik.tmp_active_spa_otl);
	
		-- Load data into fact_customer from both staging and historical file data			
		insert into qlik.fact_customer 
			select period_id,acct_id,attrib1_id,attrib2_id,sum(opening_amt)
			, sum(sub.activity_amt) as activity_amt
			, sum(sub.activity_amt) over (order by period_id asc rows between unbounded preceding and current row) as closing_amt
			from (
				select * from qlik.tmp_active_spa_otl
				union all
				select * from qlik.tmp_active_spa 
					where period_id not in (select period_id from qlik.tmp_active_spa_otl)
				) sub
			group by 
				sub.period_id,sub.acct_id,sub.attrib1_id,sub.attrib2_id,activity_amt
		;

	/* End of Active SPA data load*/


	/* New Application */
	delete from qlik.fact_customer
	where acct_id = (	select acct_id from qlik.dim_account da 
						where da.acct_lvl1 = 'Customer' 
							and da.acct_lvl2 = 	'SPA Application' 
							and acct_desc = 'New Application'  );

	insert into qlik.fact_customer 
		(period_id,acct_id,attrib1_id,attrib2_id,opening_amt,activity_amt,closing_amt)
	select 
		sub.period_id
		, (select acct_id from qlik.dim_account da 
			where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'SPA Application' and acct_desc = 'New Application') as acct_id 	
		, 0 as  attrib1_id
		, 0 as attrib2_id
		, 0.00 as opening_amt
		, sum(sub.count_value) as activity_amt
		, sum(sub.count_value::decimal) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
	--	, sum(sub.count_value) over (order by period_id asc rows between unbounded preceding and current row) as closing_amt
	from (
		select 
			cast(to_char(creation_date,'YYYYMM') as integer) as period_id 
			, count(account_no) as count_value
		from public.ztob_customer zc
		group by to_char(creation_date,'YYYYMM') 
		) sub
	inner join qlik.dim_period dp on sub.period_id = dp.period_id 
	group by sub.period_id, dp.fiscal_year, sub.count_value
	;

		
end;

$$;


ALTER FUNCTION qlik.sp_fact_customer(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1209 (class 1255 OID 24853)
-- Name: sp_fact_customer_bkp_20210730(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_customer_bkp_20210730(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
    vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN

-- Dropping tmp_fact_customer table

	DROP TABLE IF EXISTS qlik.tmp_fact_customer;
	
-- Create=ing tmp_fact_customer table

	CREATE TABLE qlik.tmp_fact_customer
	(
	  period_id integer NOT NULL,
	  acct_id integer NOT NULL,
	  attrib1_id integer NOT NULL,
	  attrib2_id integer NOT NULL,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2)
	);
	
-- Inserting into  tmp_fact_customer table

	insert into qlik.tmp_fact_customer (
		 period_id 		,
		  acct_id 		,
		  attrib1_id 	,
		  attrib2_id 	,
		  opening_amt 	,
		  activity_amt 	,
		  closing_amt 	
		)
	
	select c.period_id,
		a.acct_id ,
		0 as attrib1_id ,
		0 as attrib2_id,
		0.00 as opening_amt,
		sum(coalesce(c.mtd_actual,0)) as activity_amt,
		sum(coalesce(c.mtd_actual,0)) as closing_amount
	from qlik.stg_channel c
	inner join qlik.dim_account a
	on a.acct_lvl2 =c.entityname
	and a.acct_desc = c.measure
	and a.acct_desc='Number of Outlets'
	and a.acct_lvl1 = 'Channel'
	where c.period_id =vPeriod_Id
	group by   c.period_id,a.acct_id  	;

-- Dropping stg_fact_customer table

	DROP TABLE IF EXISTS qlik.stg_fact_customer;

-- creating stg_fact_customer table

	CREATE TABLE qlik.stg_fact_customer
	(
	  period_id integer NOT NULL,
	  acct_id integer NOT NULL,
	  attrib1_id integer NOT NULL,
	  attrib2_id integer NOT NULL,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2)
	);
	
-- Inserting into stg_fact_customer table
insert into qlik.stg_fact_customer (
		 period_id 		,
		  acct_id 		,
		  attrib1_id 	,
		  attrib2_id 	,
		  opening_amt 	,
		  activity_amt 	,
		  closing_amt 	
		)
	
	select c.period_id,
		c.acct_id ,
		c.attrib1_id ,
		c.attrib2_id,
		0.00 as opening_amt,
		sum(coalesce(c.activity_amt,0.00)) as activity_amt,
		sum(coalesce(c.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_customer c
	where c.period_id = vPeriod_Id 
	group by c.acct_id, c.period_id,c.attrib1_id ,c.attrib2_id
	
;
	
	/*Remove Data For Reload*/
	delete from qlik.fact_customer where period_id = coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where  acct_desc='Number of Outlets'
	and acct_lvl1 = 'Channel');

	analyze qlik.fact_customer;
	
	insert into qlik.fact_customer (
	  period_id 		,
		  acct_id 		,
		  attrib1_id 	,
		  attrib2_id 	,
		  opening_amt 	,
		  activity_amt 	,
		  closing_amt 	
	)
	select period_id 		,
		  acct_id 		,
		  attrib1_id 	,
		  attrib2_id 	,
		  opening_amt 	,
		  activity_amt 	,
		  closing_amt 	
	 from qlik.stg_fact_customer;


	/* Active SPA */
	BEGIN
		
--	  	/*one time historical data load for Active SPA
--		*/
--		delete from qlik.fact_customer where acct_id = -17 and period_id between 201904 and 202103
--		
		drop table if exists qlik.tmp_active_spa_otl;
		
		create table qlik.tmp_active_spa_otl  as
			select period_id, acct_id , attrib1_id, attrib2_id, opening_amt
			, activity_amt
			, activity_amt as closing_amt
--			, sum(activity_amt) over(order by period_id) as activity_amt
--			, sum(activity_amt) over(order by period_id) as closing_amt
			from (
			select cast(to_char(date, 'YYYYMM') as integer) as period_id
			, -17 as acct_id
			, 0 as attrib1_id
			, 0 as attrib2_id
			, 0 as opening_amt
			, sum("Customers Activated") as activity_amt
			from STG_ACTIVE_SPA_CUSTOMER
			group by to_char(date, 'YYYYMM')
			)sq
			order by 1	;
			

		/*
		 * Load data from DB tables for period after Apr-21
		 */
		drop table if exists qlik.tmp_active_spa;
	
		create table qlik.tmp_active_spa as
		select cast(sq2.period_id as integer) period_id
		, -17 acct_id
		, 0 attrib1_id 	
		, 0 attrib2_id 	
		, 0 opening_amt 	
		, sq2.ACTIVE_SPA_MTD activity_amt
		, sum(sq2.ACTIVE_SPA_MTD) over (order by sq2.period_id asc rows between unbounded preceding and current row) as closing_amt
		from (
		select to_char(cast(activation_date as date), 'YYYYMM') period_id 
		, sum(ACTIVE_SPA_MTD) ACTIVE_SPA_MTD
		from (
		select 
		cast(activation_date as date) as activation_date 
		, count(status) as ACTIVE_SPA_MTD
		from public.ztob_customer where 1=1
		and status = 'A'
		and activation_date is not null
		and kyc_status like '%Pass%' 
		and bkgd_status like '%Pass%' 
		and kyc_status like '%Pass%'  
		and cast(to_char(cast(activation_date as date), 'YYYYMM') as numeric) >= 202104 -- load data from DB tables only after Apr-2020. Earlier data will come from one time file load
		group by cast(activation_date as date)
		) sq1
		where 1=1
		group by to_char(cast(activation_date as date), 'YYYYMM')
		) sq2
		order by 1
		;

		/*
		 * Delete data from Fact_customer before reloading
		 */
		delete from qlik.fact_customer where acct_id in (select acct_id from qlik.dim_account 
		where  acct_desc= 'Activated SPA' and acct_lvl1 = 'Customer' and acct_lvl2='SPA Application Update');
--		and period_id >= 202104; -- load data from DB tables only after Apr-2020. Earlier data will come from one time file load

	
		/*
		 * Insert full data into fact_customer for active spa
		 * Include both one time data load from file (before Mar-21) and data from DB table (after Apr-21)
		 * Stores cummalitve sum of Active SPA
		 */
		insert into qlik.fact_customer 
		select distinct period_id, acct_id , attrib1_id, attrib2_id, opening_amt
--			, activity_amt aa
--			, activity_amt as closing_amt
			, sum(activity_amt) over(order by period_id) as activity_amt
			, sum(activity_amt) over(order by period_id) as closing_amt
		from (
			select * from tmp_active_spa_otl fc 
			union 
			select * from tmp_active_spa
			order by 1
			) sq
			order by 1;
			
	END;	

	analyze qlik.fact_customer;
END;
$$;


ALTER FUNCTION qlik.sp_fact_customer_bkp_20210730(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1139 (class 1255 OID 662682)
-- Name: sp_fact_customer_channel(character); Type: FUNCTION; Schema: qlik; Owner: postgres
--

CREATE FUNCTION qlik.sp_fact_customer_channel(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$ 

declare 

vperiod_id integer := (select	cast(vparperiod as integer));

vprevperid_id integer := (select 
							cast(to_char(cast('1-' || period_short_nm as date) - interval '1 month' , 'YYYYMM') as integer)
						from qlik.dim_period
						where period_id = vperiod_id);
	
vlastmonthperid_id integer := (select	
						case when right(cast(vPeriod_Id as char(7)), 2) >= '04' 
						then cast(cast (cast(left(cast(vPeriod_Id as char(7)), 4) as integer) + 1  as char(4)) ||'03' as integer) 
						else cast (left(cast(vPeriod_Id as char(7)), 4)  ||'03' as integer) 
						end
						from qlik.dim_period
					where period_id = vperiod_id);	

begin
-------------------------------------------------------
-- Dropping tmp_fact_customer table
-------------------------------------------------------
 drop table if exists qlik.tmp_fact_customer;
 
------------------------------------------------------- 
-- Creating tmp_fact_customer table
-------------------------------------------------------
 create table qlik.tmp_fact_customer ( period_id integer not null,
acct_id integer not null,
attrib1_id integer not null,
attrib2_id integer not null,
opening_amt numeric(13,4),
activity_amt numeric(13,4),
closing_amt numeric(13,4) );

-------------------------------------------------------
-- Inserting into  tmp_fact_customer table
-------------------------------------------------------
 insert
	into
	qlik.tmp_fact_customer ( period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt )
	
-------------------------------------------------------
-- Dim_account is left join with stg_channel to make sure we do have entry for the KPI in table  for vPeriod_Id and if it is missed to provided data in file for that month	we should populate with 0
-------------------------------------------------------
 select
	c.period_id,
	a.acct_id ,
	1 as attrib1_id ,
	0 as attrib2_id,
	0.00 as opening_amt,
	sum(coalesce(c.mtd_actual, 0)) as activity_amt,
	sum(coalesce(c.mtd_actual, 0)) as closing_amount
from
	qlik.dim_account a
left outer join qlik.stg_channel c on
	a.acct_lvl2 = c.entityname
	and a.acct_desc = c.measure
	and a.acct_lvl1 = 'Channel'
	--wf: 231012: added new kpis: DBS - PayNow, MyInfo Retrieval, Identity Verification (Identiface), Sports Radar,SPIN, IPA
	and a.acct_desc in ('Number of Outlets', 'New Outlet', 'IDD-UOB', 'Sales & Payout Availability', 'EFT', 'IDD-OCBC', 'HR LIVE STREAM', 'Pacific Synergy', 'eNETS', 'IDD-DBS', 'Payout Transaction Integrity', 'Closure', 'Sales Transaction Integrity', 'Channel Availability' , 'DBS - PayNow', 'MyInfo Retrieval', 'Identity Verification (Identiface)', 'Sports Radar','SPIN', 'IPA')
where
	c.period_id = coalesce(vPeriod_Id, 9999999)
group by
	c.period_id,
	a.acct_id
	
UNION ALL
-------------------------------------------------------
---target data	(attrib1_id =-16 for target)
-- Dim_account is left join with stg_channel to make sure we do have entry for the KPI in table  for vPeriod_Id and if it is missed to provided data in file for that month	we should populate with 0
-------------------------------------------------------
 select
	c.period_id,
	a.acct_id ,
	-16 as attrib1_id ,
	0 as attrib2_id,
	0.00 as opening_amt,
	sum(coalesce(c.mtd_target, 0)) as activity_amt,
	sum(coalesce(c.mtd_target, 0)) as closing_amount
from
	qlik.dim_account a
left outer join qlik.stg_channel c on
	a.acct_lvl2 = c.entityname
	and a.acct_desc = c.measure
	and a.acct_lvl1 = 'Channel'
	--wf: 231012: added new kpis: DBS - PayNow, MyInfo Retrieval, Identity Verification (Identiface), Sports Radar,SPIN
	and a.acct_desc in ('IDD-UOB', 'Sales & Payout Availability', 'EFT', 'IDD-OCBC', 'HR LIVE STREAM', 'Pacific Synergy', 'eNETS', 'IDD-DBS', 'Payout Transaction Integrity', 'Sales Transaction Integrity', 'Channel Availability' , 'DBS - PayNow', 'MyInfo Retrieval', 'Identity Verification (Identiface)', 'Sports Radar','SPIN','IPA')
where
	c.period_id = coalesce(vPeriod_Id, 9999999)
group by
	c.period_id,
	a.acct_id 

	
	UNION ALL
	
-------------------------------------------------------
---History data for cost to serve always YTD values from source
-------------------------------------------------------	
	 select
	c.period_id,
	a.acct_id ,
	1 as attrib1_id ,
	0 as attrib2_id,
	0.00 as opening_amt,
	sum(coalesce(c.ytd_actual, 0)) as activity_amt,
	sum(coalesce(c.ytd_actual, 0)) as closing_amount
from
	qlik.dim_account a
Inner join qlik.stg_channel c on
	a.acct_lvl2 = c.entityname
	and a.acct_desc = c.measure
	and a.acct_lvl1 = 'Channel'
	and a.acct_desc in ('cost to serve')
where
	c.period_id = coalesce(vPeriod_Id, 9999999)
	and c.period_id<='202003' -- As we will get history data only via file from april 2020 data should be coming from FACT_GL_BALANCE
group by
	c.period_id,
	a.acct_id
union all

-------------------------------------------------------
---cost to serve always YTD values from source only march month
---target data	(attrib1_id =-16 for target)
-------------------------------------------------------	
 select
	vlastmonthperid_id,
	a.acct_id ,
	-16 as attrib1_id ,
	0 as attrib2_id,
	0.00 as opening_amt,
	sum(c.ytd_target) as activity_amt,
	sum(c.ytd_target) as closing_amount
from
	qlik.dim_account a
Inner join qlik.stg_channel c on
	a.acct_lvl2 = c.entityname
	and a.acct_desc = c.measure
	and a.acct_lvl1 = 'Channel'
	and a.acct_desc in ('cost to serve')
where
	c.period_id = coalesce(vlastmonthperid_id,9999999)
group by
	a.acct_id 
	;
	
-------------------------------------------------------	
-- Dropping stg_fact_customer table
-------------------------------------------------------
 drop table if exists qlik.stg_fact_customer;
 
------------------------------------------------------- 
-- creating stg_fact_customer table
-------------------------------------------------------
 create table qlik.stg_fact_customer ( period_id integer not null,
acct_id integer not null,
attrib1_id integer not null,
attrib2_id integer not null,
opening_amt numeric(13,4),
activity_amt numeric(13,4),
closing_amt numeric(13,4) );

-------------------------------------------------------
-- Inserting into stg_fact_customer table
-------------------------------------------------------
 insert
	into
	qlik.stg_fact_customer ( period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt )

-------------------------------------------------------	
-- For KPIs which doesnt require YTD calculation separately (MTD YTD same value	)
-------------------------------------------------------
 select
	c.period_id,
	c.acct_id ,
	c.attrib1_id ,
	c.attrib2_id,
	0.00 as opening_amt,
	sum(c.activity_amt) as activity_amt,
	sum(c.activity_amt) as closing_amt
from
	qlik.tmp_fact_customer c
where
	c.period_id = coalesce(vPeriod_Id, 9999999)
	and c.acct_id in (select distinct acct_id from 
		--wf: 231012: added new kpis: DBS - PayNow, MyInfo Retrieval, Identity Verification (Identiface), Sports Radar,SPIN
	qlik.dim_account a where acct_desc in  ('Number of Outlets',
'IDD-UOB',
'Sales & Payout Availability',
'EFT',
'IDD-OCBC',
'HR LIVE STREAM',
'Pacific Synergy',
'eNETS',
'IDD-DBS',
'Payout Transaction Integrity',
'Sales Transaction Integrity',
'Channel Availability','DBS - PayNow', 'MyInfo Retrieval', 'Identity Verification (Identiface)', 'Sports Radar','SPIN', 'IPA'
)
and acct_lvl1 ='Channel')
group by
	c.acct_id,
	c.period_id,
	c.attrib1_id ,
	c.attrib2_id
	
UNION ALL	

-------------------------------------------------------	
-- For cost to serve mtd / YTD will be same as have YTD values only. Target(-16) is available for last month of year only
-------------------------------------------------------
select
	c.period_id,
	c.acct_id ,
	c.attrib1_id ,
	c.attrib2_id,
	0.00 as opening_amt,
	sum(c.activity_amt) as activity_amt,
	sum(c.activity_amt) as closing_amt
from
	qlik.tmp_fact_customer c
where
	((attrib1_id=1 and c.period_id = coalesce(vPeriod_Id, 9999999))
	or (attrib1_id=-16 and c.period_id = coalesce(vlastmonthperid_id,9999999)))
	and c.acct_id in (select distinct acct_id from 
	qlik.dim_account a where acct_desc in ('cost to serve')
and acct_lvl1 ='Channel')
group by
	c.acct_id,
	c.period_id,
	c.attrib1_id ,
	c.attrib2_id

-------------------------------------------------------		
-- For new otlet and closure needs YTD and MTD to be calculated
-------------------------------------------------------	
union all
select
	c.period_id,
	c.acct_id ,
	c.attrib1_id ,
	c.attrib2_id,
	case when right(cast(vPeriod_Id as char(7)), 2) = '04' then 0.00
	else sum(coalesce(c1.closing_amt, 0.00)) end as opening_amt,
	sum(coalesce(c.activity_amt, 0.00)) as activity_amt,
	case when right(cast(vPeriod_Id as char(7)), 2) = '04' then sum(coalesce(c.activity_amt, 0.00))
	else sum(coalesce(c1.closing_amt, 0.00)) + sum(coalesce(c.activity_amt, 0.00)) end as closing_amt
from
	qlik.tmp_fact_customer c
inner join qlik.dim_account a on
	a.acct_id = c.acct_id
left outer join qlik.fact_customer c1 on
	c.acct_id = c1.acct_id
	and c.attrib1_id=c1.attrib1_id
	and c1.period_id = vprevperid_id

where
	c.period_id = coalesce(vPeriod_Id, 9999999)
	and c.acct_id in (select distinct acct_id from 
	qlik.dim_account a where acct_desc in ('New Outlet','Closure') and acct_lvl1 ='Channel')
	and coalesce(vPeriod_Id, 9999999) < cast(to_char(current_date, 'YYYYMM')as integer)
	and coalesce(vPeriod_Id, 9999999) < cast(to_char(current_date, 'YYYYMM')as integer)
group by
	c.acct_id,
	c.period_id,
	c.attrib1_id ,
	c.attrib2_id,
	a.acct_desc ;

-------------------------------------------------------	
--Remove Data For Reload
-------------------------------------------------------	

delete
from
	qlik.fact_customer
where
	period_id = coalesce(vPeriod_Id, 9999999)
	and acct_id in (
	select
		a.acct_id
	from
		qlik.dim_account a, qlik.stg_fact_customer b
	where
		a.acct_lvl1 = 'Channel'
		and a.acct_id = b.acct_id
		and b.period_id =  coalesce(vPeriod_Id, 9999999)
			--wf: 231012: added new kpis: DBS - PayNow, MyInfo Retrieval, Identity Verification (Identiface), Sports Radar,SPIN
		and a.acct_desc in ('Number of Outlets', 'New Outlet', 'IDD-UOB', 'Sales & Payout Availability', 'EFT', 'IDD-OCBC', 'HR LIVE STREAM', 'Pacific Synergy', 'eNETS', 'IDD-DBS', 'Payout Transaction Integrity', 'Closure', 'Sales Transaction Integrity', 'Channel Availability' ,'DBS - PayNow', 'MyInfo Retrieval', 'Identity Verification (Identiface)', 'Sports Radar','SPIN', 'IPA'));

-------------------------------------------------------	
--Remove Data For cost to serve for march as target is for march for all years whereas actuals is only till march 2020
-------------------------------------------------------	

delete
from
	qlik.fact_customer
where
	period_id = coalesce(vPeriod_Id, 9999999)
	and period_id<='202003' 
	and attrib1_id =1
	and acct_id in (
	select
		a.acct_id
	from
		qlik.dim_account a, qlik.stg_fact_customer b
	where
		a.acct_lvl1 = 'Channel'
		and a.acct_id = b.acct_id
		and period_id = coalesce(vPeriod_Id, 9999999)
	and period_id<='202003' 
	and attrib1_id =1
		and a.acct_desc in ('cost to serve'));

delete
from
	qlik.fact_customer
where
	period_id = coalesce(vlastmonthperid_id,9999999) 
	and attrib1_id =-16
	and acct_id in (
	select
		a.acct_id
	from
		qlik.dim_account a, qlik.stg_fact_customer b
	where
		a.acct_lvl1 = 'Channel'
		and a.acct_id = b.acct_id
		and period_id = coalesce(vlastmonthperid_id,9999999) 
	and attrib1_id =-16
		and a.acct_desc in ('cost to serve'));		
	

analyze qlik.fact_customer;

insert
	into
	qlik.fact_customer ( period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt )
select
	period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt
from
	qlik.stg_fact_customer
	where (period_id =  coalesce(vPeriod_Id, 9999999)
		or (period_id = coalesce(vlastmonthperid_id,9999999)
			and attrib1_id =-16 
			and acct_id in (select distinct a.acct_id 
							from qlik.dim_account a
							where a.acct_lvl1 = 'Channel'
							and a.acct_desc in ('cost to serve')
							) 
			));


analyze qlik.fact_customer;
end;

$$;


ALTER FUNCTION qlik.sp_fact_customer_channel(vparperiod character) OWNER TO postgres;

--
-- TOC entry 1210 (class 1255 OID 24856)
-- Name: sp_fact_customer_channel_bkup_231005(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_customer_channel_bkup_231005(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$ 

declare 

vperiod_id integer := (select	cast(vparperiod as integer));

vprevperid_id integer := (select 
							cast(to_char(cast('1-' || period_short_nm as date) - interval '1 month' , 'YYYYMM') as integer)
						from qlik.dim_period
						where period_id = vperiod_id);
	
vlastmonthperid_id integer := (select	
						case when right(cast(vPeriod_Id as char(7)), 2) >= '04' 
						then cast(cast (cast(left(cast(vPeriod_Id as char(7)), 4) as integer) + 1  as char(4)) ||'03' as integer) 
						else cast (left(cast(vPeriod_Id as char(7)), 4)  ||'03' as integer) 
						end
						from qlik.dim_period
					where period_id = vperiod_id);	

begin
-------------------------------------------------------
-- Dropping tmp_fact_customer table
-------------------------------------------------------
 drop table if exists qlik.tmp_fact_customer;
 
------------------------------------------------------- 
-- Creating tmp_fact_customer table
-------------------------------------------------------
 create table qlik.tmp_fact_customer ( period_id integer not null,
acct_id integer not null,
attrib1_id integer not null,
attrib2_id integer not null,
opening_amt numeric(13,4),
activity_amt numeric(13,4),
closing_amt numeric(13,4) );

-------------------------------------------------------
-- Inserting into  tmp_fact_customer table
-------------------------------------------------------
 insert
	into
	qlik.tmp_fact_customer ( period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt )
	
-------------------------------------------------------
-- Dim_account is left join with stg_channel to make sure we do have entry for the KPI in table  for vPeriod_Id and if it is missed to provided data in file for that month	we should populate with 0
-------------------------------------------------------
 select
	c.period_id,
	a.acct_id ,
	1 as attrib1_id ,
	0 as attrib2_id,
	0.00 as opening_amt,
	sum(coalesce(c.mtd_actual, 0)) as activity_amt,
	sum(coalesce(c.mtd_actual, 0)) as closing_amount
from
	qlik.dim_account a
left outer join qlik.stg_channel c on
	a.acct_lvl2 = c.entityname
	and a.acct_desc = c.measure
	and a.acct_lvl1 = 'Channel'
	and a.acct_desc in ('Number of Outlets', 'New Outlet', 'IDD-UOB', 'Sales & Payout Availability', 'EFT', 'IDD-OCBC', 'HR LIVE STREAM', 'Pacific Synergy', 'eNETS', 'IDD-DBS', 'Payout Transaction Integrity', 'Closure', 'Sales Transaction Integrity', 'Channel Availability' )
where
	c.period_id = coalesce(vPeriod_Id, 9999999)
group by
	c.period_id,
	a.acct_id
	
UNION ALL
-------------------------------------------------------
---target data	(attrib1_id =-16 for target)
-- Dim_account is left join with stg_channel to make sure we do have entry for the KPI in table  for vPeriod_Id and if it is missed to provided data in file for that month	we should populate with 0
-------------------------------------------------------
 select
	c.period_id,
	a.acct_id ,
	-16 as attrib1_id ,
	0 as attrib2_id,
	0.00 as opening_amt,
	sum(coalesce(c.mtd_target, 0)) as activity_amt,
	sum(coalesce(c.mtd_target, 0)) as closing_amount
from
	qlik.dim_account a
left outer join qlik.stg_channel c on
	a.acct_lvl2 = c.entityname
	and a.acct_desc = c.measure
	and a.acct_lvl1 = 'Channel'
	and a.acct_desc in ('IDD-UOB', 'Sales & Payout Availability', 'EFT', 'IDD-OCBC', 'HR LIVE STREAM', 'Pacific Synergy', 'eNETS', 'IDD-DBS', 'Payout Transaction Integrity', 'Sales Transaction Integrity', 'Channel Availability' )
where
	c.period_id = coalesce(vPeriod_Id, 9999999)
group by
	c.period_id,
	a.acct_id 

	
	UNION ALL
	
-------------------------------------------------------
---History data for cost to serve always YTD values from source
-------------------------------------------------------	
	 select
	c.period_id,
	a.acct_id ,
	1 as attrib1_id ,
	0 as attrib2_id,
	0.00 as opening_amt,
	sum(coalesce(c.ytd_actual, 0)) as activity_amt,
	sum(coalesce(c.ytd_actual, 0)) as closing_amount
from
	qlik.dim_account a
Inner join qlik.stg_channel c on
	a.acct_lvl2 = c.entityname
	and a.acct_desc = c.measure
	and a.acct_lvl1 = 'Channel'
	and a.acct_desc in ('cost to serve')
where
	c.period_id = coalesce(vPeriod_Id, 9999999)
	and c.period_id<='202003' -- As we will get history data only via file from april 2020 data should be coming from FACT_GL_BALANCE
group by
	c.period_id,
	a.acct_id
union all

-------------------------------------------------------
---cost to serve always YTD values from source only march month
---target data	(attrib1_id =-16 for target)
-------------------------------------------------------	
 select
	vlastmonthperid_id,
	a.acct_id ,
	-16 as attrib1_id ,
	0 as attrib2_id,
	0.00 as opening_amt,
	sum(c.ytd_target) as activity_amt,
	sum(c.ytd_target) as closing_amount
from
	qlik.dim_account a
Inner join qlik.stg_channel c on
	a.acct_lvl2 = c.entityname
	and a.acct_desc = c.measure
	and a.acct_lvl1 = 'Channel'
	and a.acct_desc in ('cost to serve')
where
	c.period_id = coalesce(vlastmonthperid_id,9999999)
group by
	a.acct_id 
	;
	
-------------------------------------------------------	
-- Dropping stg_fact_customer table
-------------------------------------------------------
 drop table if exists qlik.stg_fact_customer;
 
------------------------------------------------------- 
-- creating stg_fact_customer table
-------------------------------------------------------
 create table qlik.stg_fact_customer ( period_id integer not null,
acct_id integer not null,
attrib1_id integer not null,
attrib2_id integer not null,
opening_amt numeric(13,4),
activity_amt numeric(13,4),
closing_amt numeric(13,4) );

-------------------------------------------------------
-- Inserting into stg_fact_customer table
-------------------------------------------------------
 insert
	into
	qlik.stg_fact_customer ( period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt )

-------------------------------------------------------	
-- For KPIs which doesnt require YTD calculation separately (MTD YTD same value	)
-------------------------------------------------------
 select
	c.period_id,
	c.acct_id ,
	c.attrib1_id ,
	c.attrib2_id,
	0.00 as opening_amt,
	sum(c.activity_amt) as activity_amt,
	sum(c.activity_amt) as closing_amt
from
	qlik.tmp_fact_customer c
where
	c.period_id = coalesce(vPeriod_Id, 9999999)
	and c.acct_id in (select distinct acct_id from 
	qlik.dim_account a where acct_desc in  ('Number of Outlets',
'IDD-UOB',
'Sales & Payout Availability',
'EFT',
'IDD-OCBC',
'HR LIVE STREAM',
'Pacific Synergy',
'eNETS',
'IDD-DBS',
'Payout Transaction Integrity',
'Sales Transaction Integrity',
'Channel Availability'
)
and acct_lvl1 ='Channel')
group by
	c.acct_id,
	c.period_id,
	c.attrib1_id ,
	c.attrib2_id
	
UNION ALL	

-------------------------------------------------------	
-- For cost to serve mtd / YTD will be same as have YTD values only. Target(-16) is available for last month of year only
-------------------------------------------------------
select
	c.period_id,
	c.acct_id ,
	c.attrib1_id ,
	c.attrib2_id,
	0.00 as opening_amt,
	sum(c.activity_amt) as activity_amt,
	sum(c.activity_amt) as closing_amt
from
	qlik.tmp_fact_customer c
where
	((attrib1_id=1 and c.period_id = coalesce(vPeriod_Id, 9999999))
	or (attrib1_id=-16 and c.period_id = coalesce(vlastmonthperid_id,9999999)))
	and c.acct_id in (select distinct acct_id from 
	qlik.dim_account a where acct_desc in ('cost to serve')
and acct_lvl1 ='Channel')
group by
	c.acct_id,
	c.period_id,
	c.attrib1_id ,
	c.attrib2_id

-------------------------------------------------------		
-- For new otlet and closure needs YTD and MTD to be calculated
-------------------------------------------------------	
union all
select
	c.period_id,
	c.acct_id ,
	c.attrib1_id ,
	c.attrib2_id,
	case when right(cast(vPeriod_Id as char(7)), 2) = '04' then 0.00
	else sum(coalesce(c1.closing_amt, 0.00)) end as opening_amt,
	sum(coalesce(c.activity_amt, 0.00)) as activity_amt,
	case when right(cast(vPeriod_Id as char(7)), 2) = '04' then sum(coalesce(c.activity_amt, 0.00))
	else sum(coalesce(c1.closing_amt, 0.00)) + sum(coalesce(c.activity_amt, 0.00)) end as closing_amt
from
	qlik.tmp_fact_customer c
inner join qlik.dim_account a on
	a.acct_id = c.acct_id
left outer join qlik.fact_customer c1 on
	c.acct_id = c1.acct_id
	and c.attrib1_id=c1.attrib1_id
	and c1.period_id = vprevperid_id

where
	c.period_id = coalesce(vPeriod_Id, 9999999)
	and c.acct_id in (select distinct acct_id from 
	qlik.dim_account a where acct_desc in ('New Outlet','Closure') and acct_lvl1 ='Channel')
	and coalesce(vPeriod_Id, 9999999) < cast(to_char(current_date, 'YYYYMM')as integer)
	and coalesce(vPeriod_Id, 9999999) < cast(to_char(current_date, 'YYYYMM')as integer)
group by
	c.acct_id,
	c.period_id,
	c.attrib1_id ,
	c.attrib2_id,
	a.acct_desc ;

-------------------------------------------------------	
--Remove Data For Reload
-------------------------------------------------------	

delete
from
	qlik.fact_customer
where
	period_id = coalesce(vPeriod_Id, 9999999)
	and acct_id in (
	select
		a.acct_id
	from
		qlik.dim_account a, qlik.stg_fact_customer b
	where
		a.acct_lvl1 = 'Channel'
		and a.acct_id = b.acct_id
		and b.period_id =  coalesce(vPeriod_Id, 9999999)
		and a.acct_desc in ('Number of Outlets', 'New Outlet', 'IDD-UOB', 'Sales & Payout Availability', 'EFT', 'IDD-OCBC', 'HR LIVE STREAM', 'Pacific Synergy', 'eNETS', 'IDD-DBS', 'Payout Transaction Integrity', 'Closure', 'Sales Transaction Integrity', 'Channel Availability' ));

-------------------------------------------------------	
--Remove Data For cost to serve for march as target is for march for all years whereas actuals is only till march 2020
-------------------------------------------------------	

delete
from
	qlik.fact_customer
where
	((period_id = coalesce(vPeriod_Id, 9999999)
	and period_id<='202003' and attrib1_id =1)
	or (period_id = coalesce(vlastmonthperid_id,9999999) and attrib1_id =-16))
	and acct_id in (
	select
		a.acct_id
	from
		qlik.dim_account a, qlik.stg_fact_customer b
	where
		a.acct_lvl1 = 'Channel'
		and a.acct_id = b.acct_id
		and b.period_id =  coalesce(vPeriod_Id, 9999999)
		and a.acct_desc in ('cost to serve'));

analyze qlik.fact_customer;

insert
	into
	qlik.fact_customer ( period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt )
select
	period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt
from
	qlik.stg_fact_customer
	where period_id =  coalesce(vPeriod_Id, 9999999);


analyze qlik.fact_customer;
end;

$$;


ALTER FUNCTION qlik.sp_fact_customer_channel_bkup_231005(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1204 (class 1255 OID 24859)
-- Name: sp_fact_customer_kpi(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_customer_kpi(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(coalesce(vparperiod) as integer));


vprevperid_id integer := (
select
	cast(to_char(cast('1-' || period_short_nm as date) - interval '1 month' , 'YYYYMM') as integer)
from
	qlik.dim_period
where
	period_id = vperiod_id);

BEGIN

with acct_id_list as (
	select acct_id from qlik.dim_account 
	where acct_lvl1 ='Customer' 
	and acct_lvl2 in (select distinct measure from qlik.stg_customer_kpi a1 where a1."period" = vperiod_id)
	and acct_desc in (select distinct kpinm from qlik.stg_customer_kpi  a2 where a2."period" = vperiod_id)
)
delete from qlik.fact_customer fc 
where acct_id in (select acct_id from acct_id_list)
and fc.period_id = vperiod_id
;

INSERT INTO qlik.fact_customer
(period_id, acct_id, attrib1_id, attrib2_id, opening_amt, activity_amt, closing_amt, value, remarks)
/*select 
	a.period, 
	case when b.acct_id is null then 0 else b.acct_id end as acct_id,
	0 as attrib1_id,
	0 as attrib2_id,
	0 as opening_amt,
	0 as activity_amt,
	0 as closing_amt,
	sum(a.value) as value, 
	a.remarks as remarks
from qlik.stg_customer_kpi a
left join (select acct_id, acct_lvl2, acct_desc from qlik.dim_account where acct_lvl1 = 'Customer') b on a.measure = b.acct_lvl2 and a.kpinm = b.acct_desc
where a.period = vperiod_id 
group by a.period, acct_id, a.remarks
;*/




select
	c.period,
	b.acct_id ,
	0 as attrib1_id,
	0 as attrib2_id,
	case when right(cast(vPeriod_Id as char(7)), 2) = '04' then 0.00
	else sum(coalesce(c1.closing_amt, 0.00)) end as opening_amt,
	sum(coalesce(c.value, 0.00)) as activity_amt,
	case when right(cast(vPeriod_Id as char(7)), 2) = '04' then sum(coalesce(c.value, 0.00))
	else sum(coalesce(c1.closing_amt, 0.00)) + sum(coalesce(c.value, 0.00)) end as closing_amt,
	sum(c.value),
	c.remarks
from
	qlik.stg_customer_kpi c
inner join (select acct_id, acct_lvl2, acct_desc from qlik.dim_account where acct_lvl1 = 'Customer') b on c.measure = b.acct_lvl2 and c.kpinm = b.acct_desc
left outer join qlik.fact_customer c1 on
	b.acct_id = c1.acct_id
	and c1.period_id = vprevperid_id
where
	c.period = coalesce(vPeriod_Id, 9999999)
	group by
	c.period,
	b.acct_id ,
	c.Remarks ;


END;
$$;


ALTER FUNCTION qlik.sp_fact_customer_kpi(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1213 (class 1255 OID 24860)
-- Name: sp_fact_customer_kyc(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_customer_kyc(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:=  ( select 
		case 
			when cast(coalesce(vparperiod) as integer) = 0
			then (select period_id from qlik.dim_period 
				where period_id = cast(to_char(current_date - interval '1' month,'YYYYMM') as integer) )
			else cast(coalesce(vparperiod) as integer) end );
		
	vprevperid_id integer := (
		select
			cast(to_char(cast('1-' || period_short_nm as date) - interval '1 month' , 'YYYYMM') as integer)
		from qlik.dim_period
		where period_id = vperiod_id);

begin


-------------------------------------------------------
-- Dropping stg_fact_customer_svcs
-------------------------------------------------------
 drop table if exists qlik.stg_fact_customer_kyc;
-- 
--------------------------------------------------------- 
---- Creating stg_fact_customer_svcs table
---------------------------------------------------------
 create table qlik.stg_fact_customer_kyc
 ( period_id integer not null,
acct_id integer not null,
attrib1_id integer not null,
attrib2_id integer not null,
opening_amt numeric(13,4),
activity_amt numeric(13,4),
closing_amt numeric(13,4) ,
attribute1 varchar,
remarks varchar);

-------------------------------------------------------
-- Inserting into  stg_fact_customer_svcs table
-------------------------------------------------------
 insert into
	qlik.stg_fact_customer_kyc ( period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt ,
	attribute1,
	remarks)

-- -131 | Customer Support KPI-KYC Cases  || Cases -Marked as Incomplete ||	based on the kyc views	
-- -132  | Customer Support KPI-KYC Cases	|| Cases -Approved	|| based on the kyc views	
-- -133  | Customer Support KPI-KYC Cases	|| Cases -Send for Amendments	|| based on the kyc views	
-- -134  | Customer Support KPI-KYC Cases	|| Cases -Rejected	|| based on the kyc views	

select
	a.period_id
	, a.acct_id 
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt
	, sum(cast(a.status_count as decimal)/b.total_count) as activity_amt
	, 0.00 as closing_amt
	, 'NULL' as attribute1
	, 'NULL' as remarks
from 
	(	select
				cast(coalesce( to_char(checkerdatetime , 'YYYYMM') ) as integer) as period_id
				, count(appid) as status_count
				, checkeraction
				, case 
					when checkeraction='Marked as Incomplete' then (select acct_id from qlik.dim_account da 
								where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases' and acct_desc = 'Cases -Marked as Incomplete')
					when checkeraction='Approved' then (select acct_id from qlik.dim_account da 
								where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases' and acct_desc = 'Cases -Approved')
					when checkeraction='Sent for Amendments' then (select acct_id from qlik.dim_account da 
								where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases' and acct_desc = 'Cases -Send for Amendments')
					when checkeraction='Rejected' then (select acct_id from qlik.dim_account da 
								where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases' and acct_desc = 'Cases -Rejected')
					end as acct_id 
			from public.zvkyc_checker
			--from qlik.stg_checker
			where checkeraction in ('Marked as Incomplete', 'Approved' , 'Sent for Amendments', 'Rejected')
			and checker_rank = 1
			and cast(coalesce( to_char(checkerdatetime , 'YYYYMM') ) as integer) = vperiod_id
			group by to_char(checkerdatetime , 'YYYYMM'), checkeraction	
		) a
inner join 
		(	select 	
				count(appid) as total_count
				, cast(coalesce( to_char(checkerdatetime , 'YYYYMM') ) as integer) as period_id
			from public.zvkyc_checker
			--from qlik.stg_checker
			where checkeraction in ('Marked as Incomplete', 'Approved' , 'Sent for Amendments', 'Rejected')
			and checker_rank = 1
			and cast(coalesce( to_char(checkerdatetime , 'YYYYMM') ) as integer) = vperiod_id
			group by to_char(checkerdatetime , 'YYYYMM')	
		) b on 	a.period_id = b.period_id 
--left outer join qlik.fact_customer c1 
--	on a.acct_id = c1.acct_id and c1.period_id = vprevperid_id
--	where a.acct_id in ( select acct_id from qlik.dim_account da 
--							where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases'  
--							and acct_desc in ('Cases -Marked as Incomplete', 'Cases -Approved' , 'Cases -Send for Amendments', 'Cases -Rejected' )	)
group by a.period_id, a.acct_id, a.checkeraction

union all

--- -130 || Customer Support KPI-KYC Cases	|| Total cases Processed	based on the kyc views 
select 
	cast(coalesce(to_char(zc.checkerdatetime , 'YYYYMM')) as integer) as period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' 
		and da.acct_lvl2 = 'Customer Support KPI-KYC Cases' and acct_desc = 'Total cases Processed') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt 
	, count(appid )  as activity_amt  
	, 0.00  as closing_amt 
	, 'NULL' as attribute1
	, 'NULL' as remarks
from public.zvkyc_checker zc
--from qlik.stg_checker zc
where 
	checkerdatetime is not null
	and checker_rank = 1
	and cast(coalesce( to_char(checkerdatetime , 'YYYYMM') ) as integer) = vperiod_id
group by to_char(checkerdatetime,'YYYYMM')

union all

-- -129 || Customer Support KPI-KYC Cases	|| Branch KYC passed ||	based on the kyc views	
select 
	cast(coalesce(to_char(zc.checkerdatetime , 'YYYYMM')) as integer) as period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases'
		and acct_desc = 'Branch KYC passed') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt	
	, count(custaccno )  as activity_amt  -- *100
	, 0.00  as closing_amt  -- *100
	, 'NULL' as attribute1
	, 'NULL' as remarks
from public.zvkyc_checker zc
--from qlik.stg_checker zc
where checkerdatetime is not null
and checkeraction  ='Approved'
and checker_rank = 1
and branchmakerrole= 'eKYC_CSOBRANCH'
and cast(coalesce( to_char(checkerdatetime , 'YYYYMM') ) as integer) = vperiod_id
group by to_char(checkerdatetime,'YYYYMM')

union all

-- -128 || Customer Support KPI-KYC Cases	|| eKYC passed ||	based on the kyc views	
select 
	cast(coalesce(to_char(zc.checkerdatetime , 'YYYYMM')) as integer) as period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases'
		and acct_desc = 'eKYC passed') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt	
	, count(custaccno )  as activity_amt  
	, 0.00  as closing_amt  
	, 'NULL' as attribute1
	, 'NULL' as remarks
from public.zvkyc_checker zc
--from qlik.stg_checker zc
where checkerdatetime is not null
and checker_rank = 1
and checkeraction  ='Approved'
and branchmakerrole= 'eKYC_CSOMAKER'
and cast(coalesce( to_char(checkerdatetime , 'YYYYMM') ) as integer) = vperiod_id
group by to_char(checkerdatetime,'YYYYMM')

union all

--   -127|         |Customer |Customer Support KPI-KYC Cases |          |Total KYC passed 
select 
	cast(coalesce(to_char(zc.checkerdatetime , 'YYYYMM')) as integer) as period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases'
		and acct_desc = 'Total KYC passed') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt	
	, count(custaccno )  as activity_amt  -- *100
	, 0.00  as closing_amt
	, 'NULL' as attribute1
	, 'NULL' as remarks
from public.zvkyc_checker zc
--from qlik.stg_checker zc
where checkerdatetime is not null
and checker_rank = 1
and checkeraction  ='Approved'
and cast(coalesce( to_char(checkerdatetime , 'YYYYMM') ) as integer) = vperiod_id
group by to_char(checkerdatetime,'YYYYMM')

union all

-- -126 || Customer Support KPI-KYC Cases  ||	KYC processed by checker within 2 days	||  based on the kyc views	
select 
	period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-KYC Cases'
		and acct_desc = 'KYC processed by checker within 2 days') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt 
	, mtd_value as activity_amt
	, ytd_value as closing_amt
	, 'NULL' as attribute1
	, 'NULL' as remarks
from (
	select 
		sub.period_id as period_id , dp.fiscal_year as year_id
		, sum(sub.count_value::decimal) / sum(sub.total_value) as mtd_value
		, sum(sub.count_value::decimal) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
			/ sum(sub.total_value) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
		as ytd_value
	from (
		select 
			cast(coalesce( to_char(checkerdatetime,'YYYYMM') ) as integer) as period_id
			, count(case when (checkerdatetime::date - branchmakerdatetime::date) <= 2 then  custaccno end)  as count_value
			, count(custaccno) as total_value
		from public.zvkyc_checker zc
		--	from qlik.stg_checker zc
		where  checker_rank = 1
		group by to_char(checkerdatetime,'YYYYMM') 
	) sub
	inner join qlik.dim_period dp on sub.period_id=dp.period_id 
	group by sub.period_id , dp.fiscal_year , sub.count_value, sub.total_value
) main

union all 

-- -124 | Customer Support KPI-eKYC Calls ||	Incomplete eKYC -Key reasons ||	based on the kyc views
select  
	cast(coalesce( aa.period ) as integer) as period_id
	, (select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-eKYC Calls' and acct_desc = 'Incomplete eKYC -Key reasons') as acct_id 
	, rank as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt	
	, cast(value as decimal)/total_value as activity_amt  
	, 0.00  as closing_amt  
	, 'NULL' as attribute1
	, aa.makerremarks as remarks
from (
	select 
		to_char(makerdatetime , 'YYYYMM') as period
	 	, case when UPPER(makerremarks) like '%INCOMPLETE OR DISCONNECTED VIDEO CALL%' then 'Incomplete or disconnected video call'
		when UPPER(makerremarks) like '%INSUFFICIENT DOCUMENTS%' then 'Insufficient documents'
		end as makerremarks
	 	, count(custaccno) as value
	 	, row_number() over (partition by to_char(makerdatetime , 'YYYYMM') order by count(custaccno) DESC) as rank
 	from public.zvkyc_maker 
 	where makeraction = 'Marked as Incomplete' and makerremarks <> ''
 		and cast(coalesce( to_char(makerdatetime , 'YYYYMM') ) as integer) = vperiod_id
  	group by to_char(makerdatetime , 'YYYYMM'),  case when UPPER(makerremarks) like '%INCOMPLETE OR DISCONNECTED VIDEO CALL%' then 'Incomplete or disconnected video call'
		when UPPER(makerremarks) like '%INSUFFICIENT DOCUMENTS%' then 'Insufficient documents'
		end  
 	order by to_char(makerdatetime , 'YYYYMM') desc
 	) aa
inner join (
 		select 
			to_char(makerdatetime , 'YYYYMM') as period
		 	, count(custaccno) as total_value
	 	from public.zvkyc_maker 
	 	where makeraction = 'Marked as Incomplete' and makerremarks <> ''
	 		and cast(coalesce( to_char(makerdatetime , 'YYYYMM') ) as integer) = vperiod_id
	  	group by to_char(makerdatetime , 'YYYYMM')
 	) tt on aa.period = tt.period
 where rank < 5
 
union all
	
-- -123 | Customer Support KPI-eKYC Calls ||	KPI eKYC Call handled	|| based on the kyc views
select  
	cast(coalesce( a.period ) as integer) as period_id
	, (select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-eKYC Calls' and acct_desc = 'KPI eKYC Call handled') as acct_id 
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt
	, case 
		when b.total_count is null then 0
		else cast(a.maker_count as decimal)/b.total_count end as activity_amt 
	, 0.00 as closing_amt
	, 'NULL' as attribute1
	, 'NULL' as remarks
from 
	(select 
		count(custaccno) as maker_count
		, to_char(makerdatetime , 'YYYYMM') as period 
	from public.zvkyc_maker 
	where makeraction='Conducted video interview' 
		and cast(coalesce( to_char(makerdatetime , 'YYYYMM') ) as integer) = vperiod_id
	group by to_char(makerdatetime , 'YYYYMM')) as a
left join 
	(select 
		count(custaccno) as total_count
		, to_char(createdtime , 'YYYYMM') as period 
	--from public.zvkyc_calldurationhistory
		from qlik.stg_calldurationhistory
	where  to_char(createdtime , 'HH24')>='08' and
		 cast(coalesce( to_char(createdtime , 'YYYYMM') ) as integer) = vperiod_id
	group by to_char(createdtime , 'YYYYMM')) b 
on  a.period=b.period 

union all 

---121 | Customer Support KPI-eKYC Calls ||	Passed by Maker || based on the kyc views	
select 
	sub.period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-eKYC Calls'
		and acct_desc = 'Passed by Maker') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt
	, sum(sub.count_value::decimal) / sum(sub.total_value) as activity_amt
	, sum(sub.count_value::decimal) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
		/ sum(sub.total_value) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
	as closing_amt
	, 'NULL' as attribute1
	, 'NULL' as remarks
from (
		select 
			cast(coalesce(to_char(zc.makerdatetime , 'YYYYMM')) as integer) as period_id
			, count(case when makeraction = 'Passed' then custaccno end) as count_value
			, count( custaccno ) as total_value 
		from public.zvkyc_maker zc
		where makeraction in ( 'Passed','Marked as Incomplete','Failed' , 'KYC @ Branch')
		group by to_char (makerdatetime,'YYYYMM')
	) sub
	inner join qlik.dim_period dp on sub.period_id = dp.period_id 
group by sub.period_id, dp.fiscal_year, sub.count_value, sub.total_value

union all 

--   -120|          |Customer |Customer Support KPI-eKYC Calls|     |eKYC callattempt per Applicant 

select 
	sub.period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-eKYC Calls'
		and acct_desc = 'eKYC callattempt per Applicant') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt
	, sum(sub.count_value::decimal) / sum(sub.total_value) as activity_amt
	, sum(sub.count_value::decimal) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
		/ sum(sub.total_value) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
	as closing_amt
	, 'NULL' as attribute1
	, 'NULL' as remarks
from (
		select 
			cast(coalesce(to_char(zc.createdtime, 'YYYYMM')) as integer) as period_id
			, count(custaccno) as count_value
			, Count (distinct custaccno )  as total_value 
		--from public.zvkyc_calldurationhistory zc
		from qlik.stg_calldurationhistory zc
		group by to_char (zc.createdtime,'YYYYMM')
	) sub
	inner join qlik.dim_period dp on sub.period_id = dp.period_id 
group by sub.period_id, dp.fiscal_year, sub.count_value, sub.total_value

union all 

--   -119|   Customer |Customer Support KPI-eKYC Calls|      |eKYC Calls handeled   
select 
	cast(coalesce(to_char(zc.makerdatetime , 'YYYYMM')) as integer) as period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-eKYC Calls'
		and acct_desc = 'eKYC Calls handeled') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt
	, count(custaccno) as activity_amt -- total_eKYC_calls
	, 0.00 as closing_amt
	, 'NULL' as attribute1
	, 'NULL' as remarks
from public.zvkyc_maker zc
where makeraction ='Conducted video interview'
and cast(coalesce( to_char(makerdatetime , 'YYYYMM') ) as integer) = vperiod_id
group by to_char(makerdatetime,'YYYYMM')

union all 

--   -118|     |Customer |Customer Support KPI-eKYC Calls|        |Total eKYC Calls 
select 
	cast(coalesce(to_char(zc.createdtime , 'YYYYMM')) as integer) as period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-eKYC Calls'
		and acct_desc = 'Total eKYC Calls') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt
	, count(custaccno) as activity_amt 
	, 0.00 as closing_amt
	, 'NULL' as attribute1
	, 'NULL' as remarks
--from public.zvkyc_calldurationhistory zc
from qlik.stg_calldurationhistory zc
where cast(coalesce( to_char(createdtime , 'YYYYMM') ) as integer) = vperiod_id
group by to_char(createdtime,'YYYYMM')
;

delete from qlik.fact_customer 
where acct_id in (select distinct da.acct_id from qlik.dim_account da , qlik.stg_fact_customer_kyc stg
		where da.acct_lvl1 ='Customer'
			and stg.acct_id = da.acct_id and stg.period_id =vperiod_id
		and da.acct_lvl2 in ( 'Customer Support KPI-KYC Cases', 'Customer Support KPI-eKYC Calls')  
		and acct_desc in ( 	'Cases -Marked as Incomplete', 'Cases -Approved'
							, 'Cases -Send for Amendments', 'Cases -Rejected' 
							, 'Total cases Processed', 'Branch KYC passed'
							, 'eKYC passed', 'Total KYC passed', 'KYC processed by checker within 2 days'
							, 'Incomplete eKYC -Key reasons' , 'KPI eKYC Call handled'
							, 'Passed by Maker', 'eKYC callattempt per Applicant'
							, 'eKYC Calls handeled' , 'Total eKYC Calls'
		))
		and period_id = vperiod_id;



INSERT INTO qlik.fact_customer
	(period_id, acct_id, attrib1_id, attrib2_id, opening_amt, activity_amt, closing_amt,  attribute1, remarks)

select 
	stg.period_id,
	stg.acct_id,
	stg.attrib1_id,
	stg.attrib2_id,
	case when right(cast(vperiod_id as char(7)), 2) = '04' then 0.00 else sum(coalesce(c1.closing_amt, 0.00)) end as opening_amt,
	sum(coalesce(stg.activity_amt, 0.00)) as activity_amt,
		case when right(cast(vperiod_id as char(7)), 2) = '04' then sum(coalesce(stg.activity_amt, 0.00))
		else sum(coalesce(c1.closing_amt, 0.00)) + sum(coalesce(stg.activity_amt, 0.00)) end as closing_amt,
		stg.attribute1,
		stg.remarks

from  qlik.stg_fact_customer_kyc stg
left outer join qlik.dim_account da  on  stg.acct_id = da.acct_id
left outer join qlik.fact_customer c1 on da.acct_id = c1.acct_id and c1.period_id = vprevperid_id
where
	stg.period_id = coalesce(vPeriod_Id, 9999999)
	and  da.acct_lvl1 ='Customer' and da.acct_lvl2 in ( 'Customer Support KPI-KYC Cases', 'Customer Support KPI-eKYC Calls')  
	and acct_desc in ( 
		 'Total cases Processed'
		, 'Branch KYC passed'
		, 'eKYC passed'
		, 'Total KYC passed'
		, 'eKYC Calls handeled' 
		, 'Total eKYC Calls'
		)
group by stg.period_id,
		stg.acct_id,
		stg.attrib1_id,
		stg.attrib2_id,
		stg.attribute1,
		stg.remarks
	
	UNION ALL
	
select stg.period_id,
		stg.acct_id,
		stg.attrib1_id,
		stg.attrib2_id,
		stg.opening_amt,
		stg.activity_amt,
		stg.closing_amt,
		stg.attribute1,
		stg.remarks

from qlik.stg_fact_customer_kyc stg
inner join qlik.dim_account da on 
	stg.acct_id = da.acct_id
	and da.acct_lvl1 ='Customer' and da.acct_lvl2 in ( 'Customer Support KPI-KYC Cases', 'Customer Support KPI-eKYC Calls' )  and acct_desc in ( 	'Cases -Marked as Incomplete'
					, 'Cases -Approved'
					, 'Cases -Send for Amendments'
					, 'Cases -Rejected' 
					, 'KYC processed by checker within 2 days'
					, 'Incomplete eKYC -Key reasons' 
					, 'KPI eKYC Call handled'
			  		, 'Passed by Maker'
			  		, 'eKYC callattempt per Applicant'
			)
where stg.period_id = coalesce(vPeriod_Id, 9999999);
		  
	

END;
$$;


ALTER FUNCTION qlik.sp_fact_customer_kyc(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1108 (class 1255 OID 24863)
-- Name: sp_fact_customer_svcs(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_customer_svcs(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$

declare
	vperiod_id integer:=  ( select 
		case 
			when cast(coalesce(vparperiod) as integer) = 0
			then (select period_id from qlik.dim_period 
				where period_id = cast(to_char(current_date - interval '1' month,'YYYYMM') as integer) )
		else cast(coalesce(vparperiod) as integer) end );
	
	vprevperid_id integer := (
		select
			cast(to_char(cast('1-' || period_short_nm as date) - interval '1 month' , 'YYYYMM') as integer)
		from qlik.dim_period
		where period_id = vperiod_id);
	
begin

-------------------------------------------------------
-- Dropping stg_fact_customer_svcs
-------------------------------------------------------
 drop table if exists qlik.stg_fact_customer_svcs;
 
------------------------------------------------------- 
-- Creating stg_fact_customer_svcs table
-------------------------------------------------------
 create table qlik.stg_fact_customer_svcs
 ( period_id integer not null,
acct_id integer not null,
attrib1_id integer not null,
attrib2_id integer not null,
opening_amt numeric(13,4),
activity_amt numeric(13,4),
closing_amt numeric(13,4) ,
attribute1 varchar);

-------------------------------------------------------
-- Inserting into  stg_fact_customer_svcs table
-------------------------------------------------------
 insert
	into
	qlik.stg_fact_customer_svcs ( period_id ,
	acct_id ,
	attrib1_id ,
	attrib2_id ,
	opening_amt ,
	activity_amt ,
	closing_amt ,
	attribute1)

select
	per.period_id as period_id
	, (select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-SVCS Cases' and acct_desc = 'No. of SVCS cases handeled') as acct_id 	
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt	
	, count(aa.casenumber) as activity_amt 
	, 0.00 as closing_amt
	, 'NULL' as attribute1	
from
(select  distinct period_id from qlik.dim_period dp where period_id =vperiod_id) per left outer join 
	public.ztsvcs_case aa
	on per.period_id=cast(coalesce( to_char(casecreatedon, 'YYYYMM') ) as integer)
and  ((upper(aa.casecategorylevel1) = 'MISCELLANEOUS' and upper(aa.casecategorylevel2) in ('OB','SBK'))
	or
	aa.customersupportcasechecker is not NULL)
	and upper(aa.statusreason) <> 'CANCELED'
	and UPPER(casecategorylevel3) not in ( 'SPAM MAILS')
	group by
	per.period_id
	
	UNION ALL
	
select  
	 period_id
	, (select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-SVCS Cases' and acct_desc = 'Top 10 Category of SVCS cases') as acct_id 
	, rank as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt	
	, aa.No_of_SVCS_Cases as activity_amt 
	, 0.00 as closing_amt	
	, aa.category as attribute1
from (
	select
		cast(coalesce( to_char(casecreatedon, 'YYYYMM') ) as integer) as period_id
		, count(casenumber) as No_of_SVCS_Cases
		, row_number() over (partition by to_char(casecreatedon , 'YYYYMM') order by count(casenumber) DESC) as rank
		, casecategorylevel3 as category
	from
		public.ztsvcs_case
where ((upper(casecategorylevel1) = 'MISCELLANEOUS' and upper(casecategorylevel2) in ('OB','SBK'))
	or customersupportcasechecker is not NULL)
	AND upper(statusreason) <> 'CANCELED'
	and UPPER(casecategorylevel3) not in ( 'SPAM MAILS')
	and casecategorylevel3 is not null
	and casecategorylevel3 <> ''
	--and period_id = vperiod_id
group by
		to_char(casecreatedon, 'YYYYMM'),
		casecategorylevel3
 	) aa
 where rank <= 10 
 and period_id=vperiod_id

 

 
 UNION ALL
select  
	sub.period_id as period_id
	, (select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Support KPI-SVCS Cases' and acct_desc = 'SVCS cases resolved within 3 days') as acct_id 
	, 0 as attrib1_id
	, 0 as attrib2_id --, dp.fiscal_year as year_id
	, 0.00 as opening_amt
	, sum(sub.count_value::decimal) / sum(sub.total_value) as activity_amt
	, sum(sub.count_value::decimal) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
			/ sum(sub.total_value) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
		as closing_amt
		, 'NULL' as attribute1	
from 
	(	select 
			cast(coalesce( to_char(casecreatedon,'YYYYMM') ) as integer) as period_id
			, count(case when (case when customersupportcasecheckerprocessedon is null then casemodifiedon::date-casecreatedon::date
				else customersupportcasecheckerprocessedon::date-casecreatedon::date end )<= 3 then casenumber end) as count_value
			, count(casenumber) as total_value			
		from public.ztsvcs_case 
		where 
			((upper(casecategorylevel1) = 'MISCELLANEOUS' and upper(casecategorylevel2) in ('OB','SBK'))
			or 	customersupportcasechecker is not NULL) 
			and upper(statusreason) <> 'CANCELED'
			and UPPER(casecategorylevel3) not in ( 'SPAM MAILS')
		group by to_char(casecreatedon , 'YYYYMM')
	) as sub
inner join qlik.dim_period dp on sub.period_id=dp.period_id 
group by sub.period_id , dp.fiscal_year , sub.count_value, sub.total_value
	

UNION ALL

select
	per.period_id as period_id
	, (select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Service KPI-Cases' and acct_desc = 'No. of cases handeled') as acct_id 	
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt	
	,count(casenumber) as activity_amt 
	, 0.00 as closing_amt
	, 'NULL' as attribute1	
from
(select  distinct period_id from qlik.dim_period dp where period_id =vperiod_id) per left outer join 
	public.ztsvcs_case aa
	on per.period_id=cast(coalesce( to_char(casecreatedon, 'YYYYMM') ) as integer)
 and upper(casecategorylevel1) IN ( 'SUGGESTION', 'REQUEST', 'FEEDBACK', 'ENQUIRIES', 'COMPLIMENT')
	and upper(statusreason) <> 'CANCELED'
	and UPPER(casecategorylevel3) not in ( 'SPAM MAILS')
group by
	per.period_id
	
	UNION ALL
	
select  
	 period_id
	, (select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Service KPI-Cases' and acct_desc = 'Top 10 Category of cases') as acct_id 
	, rank as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt
	, aa.No_of_SVCS_Cases as activity_amt 
	, 0.00 as closing_amt
	, aa.category as attribute1
from (
	select
		cast(coalesce( to_char(casecreatedon, 'YYYYMM') ) as integer) as period_id
		,count(casenumber) as No_of_SVCS_Cases
		,row_number() over (partition by to_char(casecreatedon , 'YYYYMM') order by count(casenumber) DESC) as rank
		,casecategorylevel3 as category
	from
		public.ztsvcs_case
where upper(casecategorylevel1) IN ( 'SUGGESTION', 'REQUEST', 'FEEDBACK', 'ENQUIRIES', 'COMPLIMENT')
	and upper(statusreason) <> 'CANCELED' 
	and UPPER(casecategorylevel3) not in ( 'OTHERS', 'SPAM MAILS')
	and casecategorylevel3 is not null
	and casecategorylevel3 <> ''
	
group by
	to_char(casecreatedon, 'YYYYMM'),
	casecategorylevel3
 	) aa
 where rank <= 10 
and period_id =vperiod_id
 	
 
 UNION ALL
select 
	sub.period_id
	,(select acct_id from qlik.dim_account da 
		where da.acct_lvl1 ='Customer' and da.acct_lvl2 = 'Customer Service KPI-Cases'
		and acct_desc = 'Cases SLA') as acct_id
	, 0 as attrib1_id
	, 0 as attrib2_id
	, 0.00 as opening_amt
	, sum(sub.count_value::decimal) / sum(sub.total_value) as activity_amt
	, sum(sub.count_value::decimal) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
		/ sum(sub.total_value) over (partition by dp.fiscal_year order by sub.period_id asc rows between unbounded preceding and current row) 
	as closing_amt
	, 'NULL' as attribute1
from (
		select
			cast(coalesce(to_char(zc.casecreatedon , 'YYYYMM')) as integer) as period_id
			, count(case when zc.resolvebykpistatus = 'Succeeded' then zc.casenumber end ) as count_value 
			, count(zc.casenumber) as total_value 
		from
			public.ztsvcs_case zc
		where upper(casecategorylevel1)IN ( 'SUGGESTION', 'REQUEST', 'FEEDBACK', 'ENQUIRIES', 'COMPLIMENT')	
			and upper(statusreason) <> 'CANCELED'
			and UPPER(casecategorylevel3) not in ( 'SPAM MAILS')
		group by
			to_char(zc.casecreatedon, 'YYYYMM')
	) sub
	inner join qlik.dim_period dp on sub.period_id = dp.period_id 
group by sub.period_id, dp.fiscal_year, sub.count_value, sub.total_value;




delete from 
qlik.fact_customer where acct_id in (select distinct da.acct_id from qlik.dim_account da , qlik.stg_fact_customer_svcs stg
		where da.acct_id= stg.acct_id and stg.period_id=vperiod_id and da.acct_lvl1 ='Customer' and da.acct_lvl2 in ( 'Customer Support KPI-SVCS Cases', 'Customer Service KPI-Cases')  and acct_desc in ( 'No. of SVCS cases handeled',
		'Top 10 Category of SVCS cases',
		'SVCS cases resolved within 3 days',
		 'No. of cases handeled',
		 'Top 10 Category of cases',
		 'Cases SLA'
		))
		and period_id = vperiod_id;



INSERT INTO qlik.fact_customer
(period_id, acct_id, attrib1_id, attrib2_id, opening_amt, activity_amt, closing_amt,  attribute1)

select 
stg.period_id,
stg.acct_id,
stg.attrib1_id,
stg.attrib2_id,
case when right(cast(vPeriod_Id as char(7)), 2) = '04' then 0.00 else sum(coalesce(c1.closing_amt, 0.00)) end as opening_amt,
sum(coalesce(stg.activity_amt, 0.00)) as activity_amt,
	case when right(cast(vPeriod_Id as char(7)), 2) = '04' then sum(coalesce(stg.activity_amt, 0.00))
	else sum(coalesce(c1.closing_amt, 0.00)) + sum(coalesce(stg.activity_amt, 0.00)) end as closing_amt,
	stg.attribute1


from  qlik.stg_fact_customer_svcs stg

left outer join qlik.dim_account DA 
 ON
stg.acct_id =da.acct_id

		 
		 left outer join qlik.fact_customer c1 on
	da.acct_id = c1.acct_id
	and c1.period_id = vprevperid_id
where
	stg.period_id = coalesce(vPeriod_Id, 9999999)
	and  da.acct_lvl1 ='Customer' and da.acct_lvl2 in ( 'Customer Support KPI-SVCS Cases', 'Customer Service KPI-Cases')  and acct_desc in (
		'No. of SVCS cases handeled',
		 'No. of cases handeled')
	group by stg.period_id,
stg.acct_id,
stg.attrib1_id,
stg.attrib2_id,
	stg.attribute1
	
	UNION ALL
	
	select stg.period_id,
stg.acct_id,
stg.attrib1_id,
stg.attrib2_id,
stg.opening_amt,
stg.activity_amt,
stg.closing_amt,
stg.attribute1	

from qlik.stg_fact_customer_svcs stg
inner join qlik.dim_account DA ON
stg.acct_id =da.acct_id
and da.acct_lvl1 ='Customer' and da.acct_lvl2 in ( 'Customer Support KPI-SVCS Cases', 'Customer Service KPI-Cases')  and acct_desc in (
		'Top 10 Category of SVCS cases',
		  'Top 10 Category of cases',
		  'SVCS cases resolved within 3 days',
		  'Cases SLA')
		  where stg.period_id = coalesce(vPeriod_Id, 9999999);
		  
	

END;
$$;


ALTER FUNCTION qlik.sp_fact_customer_svcs(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1107 (class 1255 OID 24866)
-- Name: sp_fact_gl_balance(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_gl_balance(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $_$
declare
                vperiod_id integer:= (select cast(vparperiod as integer));
                vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
                vwagering_id integer :=(select product_id from qlik.dim_product where product_cd = 'HR');
BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11 
	--set autocommit = on;

     /*Other Income Update for wagering*/
    /* 18May:  Removed 3 accounts from the update as the gl hierachy has change in S4H*/
--     update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
--                select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Non-Operating Income/Expenses') and acct_type = 'E'
--               and acct_fr not in ('61101023','61101024','63005005','63005004');

--    update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
--                select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Other Operating Income') and acct_type = 'E'
--               and acct_fr not in ('61101023','61101024','63005005','63005004');

                
     /*create temporary fact table*/
                DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

                CREATE TABLE qlik.tmp_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );
     

    /*Revenue MTD --> COPA*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
                coalesce(f.entity_id,0),
                case when coalesce(c.acct_fr,'xxx') = '50200005' then vwagering_id else coalesce(e.product_id,0) end,
                coalesce(g.cust_id,0),
                coalesce(c.acct_id,0),
                coalesce(b.attrib_id,0),
                sum(a.total_value_controlling) as amount,
                coalesce(h.attrib_id,0) as attrib1_id
                from ztsapfi_copa a
                left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
                inner join qlik.dim_account c on cast(a.cost_element as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_product e on e.product_cd = a.league_code
                left join qlik.dim_entity f on f.entity_cd = case when left(a.cost_element,1)='4' or trim(a.cost_center) = '' or a.cost_center is null 
                then a.profit_center else a.cost_center end 
                left join qlik.dim_customer g on g.cust_cd = a.customer
                left join (select attrib_id,upper(attrib_cd) as attrib_cd from qlik.dim_attribute where 1=1 ) h on h.attrib_cd = upper(a.bet_mode)
                where a.company_code = '2000'
                and c.attribute2 = 'COPA'
                and d.Period_Id = vPeriod_Id
                and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
                and c.acct_fr NOT in ('NPAT')
                group by 
                d.period_id,
                f.entity_id,
                case when coalesce(c.acct_fr,'xxx') = '50200005' then vwagering_id else coalesce(e.product_id,0) end,
                g.cust_id,
                c.acct_id,
                b.attrib_id,h.attrib_id;

     /*Expense MTD --> CCA (Only Budget Amount)*/
     
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
--                case when coalesce(c.acct_fr,'xxx') in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                coalesce(f.entity_id,h.entity_id ,0) entity_id,
                0 as product_id,
                0 as cust_id,
                case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                coalesce(b.attrib_id,0),
                sum(a.amount) as amount,
                0 as attrib1_id
                from ztsapfi_cca a
                left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
                inner join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on cast(a.cost_element as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on cast(a.cost_element as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_entity f on f.entity_cd = a.cost_center
                left join qlik.dim_entity h on h.entity_cd = a.profit_center
                where a.company_code = '2000'
                and a.currency_type = '20'
				and ( a.plan_category = '' or a.plan_category = 'PLN' ) 
                and c.attribute2 = 'CCA' --and a.version in ('000','P01')
                and d.period_id = vPeriod_Id
                and left(cost_element,1) not in ('A','S')
                and b.attrib_id = 2
                group by 
                d.period_id,
--                case when coalesce(c.acct_fr,'xxx') in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                coalesce(f.entity_id,h.entity_id ,0) ,
                case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                b.attrib_id;

                /*GL --> BS*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
                0 as entity_id,
                0 as product_id,
                0 as cust_id,
                coalesce(c.acct_id,0),
                1 as value_type,
                sum(a.debit_credit_amount) as amount,
                0 as attrib1_id
                from ztsapfi_gl a
                inner join qlik.dim_account c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                where a.company_code = '2000' and left(a.gl_account,1) in ('1','2','3')
                and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
                and c.acct_fr NOT in ('NPAT')
                and d.period_id = vPeriod_Id
                group by 
                d.period_id,
                c.acct_id
                union all 
                /* Net Earning */
                select vPeriod_Id as period_id,
                0 as entity_id,
                0 as product_id,
                0 as cust_id,
                800 as acct_id,
                1 as value_type,
                sum(a.debit_credit_amount) as amount,0 as attrib1_id
                from ztsapfi_gl a
                inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                where a.company_code = '2000' and left(a.gl_account,1) not in ('1','2','3')
                and d.period_id = vPeriod_Id
                --Expense from CCA
                UNION ALL
                select coalesce(d.period_id,0),
                case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                0 as product_id,
                0 as cust_id,
                case when g.acct_id is not null and coalesce(f.attribute7,'NA') = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                1 value_type,
                sum(a.debit_credit_amount) as amount,
                0 as attrib1_id
                from ztsapfi_gl a
                left join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on cast(a.gl_account as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_entity f on f.entity_cd = a.cost_center
                left join qlik.dim_entity h on h.entity_cd = a.profit_center                            
                where a.company_code = '2000'
                and c.attribute2 = 'CCA' 
                and d.period_id = vPeriod_Id
                --and left(gl_account,1) not in ('A','S')
                group by 
                d.period_id,
                case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                case when g.acct_id is not null and coalesce(f.attribute7,'NA') = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end
                
                ;

                /*Budget By League but no Profit Center*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                                period_id,
                                entity_id,
                                product_id,
                                cust_id,
                                acct_id,
                                value_type,
                                activity_amt,
                                attrib1_id
                from qlik.hist_fact_gl_balance a
                where acct_id in (2,1,10,3) and period_id = vPeriod_Id;

                /*Remove Data For Reload*/
                delete from qlik.fact_gl_balance where period_id >= coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 in ('PL','BS'))  and attrib1_id <> 999;

                analyze qlik.fact_gl_balance;
                
                DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
                
                CREATE TABLE qlik.stg_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );
                
                /*Insert into Fact table*/
                insert into qlik.stg_fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type = 2 
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and a.value_type = 2
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                
                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type = 2 and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
                having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 
                
                union all
                
                select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0 as attrib_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id  = vprevperid_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id  = vprevperid_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and c.acct_lvl1 = 'BS'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id, value_type;

                insert into qlik.fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select * from qlik.stg_fact_gl_balance;

                analyze qlik.fact_gl_balance;

--                perform qlik.sp_online_lottery_breakdown(vperiod_id);
               
               perform qlik.sp_fact_gl_lottery_split(vparperiod);
END;
$_$;


ALTER FUNCTION qlik.sp_fact_gl_balance(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1171 (class 1255 OID 24869)
-- Name: sp_fact_gl_balance_20200107(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_gl_balance_20200107(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $_$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN
     -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

     /*Other Income Update for wagering*/
     update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
	select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Non-Operating Income/Expenses') and acct_type = 'E';

    update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
	select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Other Operating Income') and acct_type = 'E';

	
     /*create temporary fact table*/
	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
     

    /*Revenue MTD --> COPA*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	coalesce(e.product_id,0),
	coalesce(g.cust_id,0),
	coalesce(c.acct_id,0),
	coalesce(b.attrib_id,0),
	sum(a.total_value_controlling) as amount,
	coalesce(h.attrib_id,0) as attrib1_id
	 from ztsapfi_copa a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join qlik.dim_account c on cast(a.cost_element as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_product e on e.product_cd = a.material
	left join qlik.dim_entity f on f.entity_cd = case when left(a.cost_element,1)='4' or trim(a.cost_center) = '' or a.cost_center is null 
	then a.profit_center else a.cost_center end 
	left join qlik.dim_customer g on g.cust_cd = a.customer
	left join (select attrib_id,upper(attrib_cd) as attrib_cd from qlik.dim_attribute where attrib_cd = 'SBK') h on h.attrib_cd = upper(a.bet_mode)
	where a.company_code = '2000'
	and c.attribute2 = 'COPA'
	and d.Period_Id = vPeriod_Id
	and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
	and c.acct_fr NOT in ('NPAT')
	group by 
	d.period_id,
	f.entity_id,
	e.product_id,
	g.cust_id,
	c.acct_id,
	b.attrib_id,h.attrib_id;

     /*Expense MTD --> CCA (Only Budget Amount)*/
     
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
	0 as product_id,
	0 as cust_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	coalesce(b.attrib_id,0),
	sum(a.amount) as amount,
	0 as attrib1_id
	 from ztsapfi_cca a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on cast(a.cost_element as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on cast(a.cost_element as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = a.cost_center
	left join qlik.dim_entity h on h.entity_cd = a.profit_center
	where a.company_code = '2000'
	and a.currency_type = '20'
	and c.attribute2 = 'CCA' --and a.version in ('000','P01')
	and d.period_id = vPeriod_Id
	and left(cost_element,1) not in ('A','S')
	and b.attrib_id = 2
	group by 
	d.period_id,
	case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	b.attrib_id;

	/*GL --> BS*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	0 as entity_id,
	0 as product_id,
	0 as cust_id,
	coalesce(c.acct_id,0),
	1 as value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	 from ztsapfi_gl a
	inner join qlik.dim_account c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	where a.company_code = '2000' and left(a.gl_account,1) in ('1','2','3')
	and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
	and c.acct_fr NOT in ('NPAT')
	and d.period_id = vPeriod_Id
	group by 
	d.period_id,
	c.acct_id
	union all 
	/* Net Earning */
	select vPeriod_Id as period_id,
	0 as entity_id,
	0 as product_id,
	0 as cust_id,
	800 as acct_id,
	1 as value_type,
	sum(a.debit_credit_amount) as amount,0 as attrib1_id
	 from ztsapfi_gl a
	 inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	where a.company_code = '2000' and left(a.gl_account,1) not in ('1','2','3')
	and d.period_id = vPeriod_Id
	--Expense from CCA
	UNION ALL
	select coalesce(d.period_id,0),
	case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
	0 as product_id,
	0 as cust_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	1 value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	from ztsapfi_gl a
	left join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on cast(a.gl_account as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = a.cost_center
	left join qlik.dim_entity h on h.entity_cd = a.profit_center		
	where a.company_code = '2000'
	--and c.attribute2 = 'CCA' 
	and d.period_id = vPeriod_Id
	--and left(gl_account,1) not in ('A','S')
	group by 
	d.period_id,
	case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end
	
	;

	/*Budget By League but no Profit Center*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select 
		period_id,
		entity_id,
		product_id,
		cust_id,
		acct_id,
		value_type,
		activity_amt,
		attrib1_id
	from qlik.hist_fact_gl_balance a
	where acct_id in (2,1,10,3) and period_id = vPeriod_Id;

	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 in ('PL','BS'))  and attrib1_id <> 999;

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type = 2
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 
	
	union all
	
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0 as attrib_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id  = vprevperid_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id  = vprevperid_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and c.acct_lvl1 = 'BS'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;

	perform qlik.sp_online_lottery_breakdown(vperiod_id);
END;
$_$;


ALTER FUNCTION qlik.sp_fact_gl_balance_20200107(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1172 (class 1255 OID 24872)
-- Name: sp_fact_gl_balance_BKP_20210609(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik."sp_fact_gl_balance_BKP_20210609"(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $_$
declare
                vperiod_id integer:= (select cast(vparperiod as integer));
                vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
                vwagering_id integer :=(select product_id from qlik.dim_product where product_cd = 'HR');
BEGIN
     -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

     /*Other Income Update for wagering*/
    /* 18May:  Removed 3 accounts from the update as the gl hierachy has change in S4H*/
     update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
                select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Non-Operating Income/Expenses') and acct_type = 'E'
               and acct_fr not in ('61101023','61101024','63005005');

    update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
                select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Other Operating Income') and acct_type = 'E'
               and acct_fr not in ('61101023','61101024','63005005');

                
     /*create temporary fact table*/
                DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

                CREATE TABLE qlik.tmp_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );
     

    /*Revenue MTD --> COPA*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
                coalesce(f.entity_id,0),
                case when coalesce(c.acct_fr,'xxx') = '50200005' then vwagering_id else coalesce(e.product_id,0) end,
                coalesce(g.cust_id,0),
                coalesce(c.acct_id,0),
                coalesce(b.attrib_id,0),
                sum(a.total_value_controlling) as amount,
                coalesce(h.attrib_id,0) as attrib1_id
                from ztsapfi_copa a
                left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
                inner join qlik.dim_account c on cast(a.cost_element as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_product e on e.product_cd = a.league_code
                left join qlik.dim_entity f on f.entity_cd = case when left(a.cost_element,1)='4' or trim(a.cost_center) = '' or a.cost_center is null 
                then a.profit_center else a.cost_center end 
                left join qlik.dim_customer g on g.cust_cd = a.customer
                left join (select attrib_id,upper(attrib_cd) as attrib_cd from qlik.dim_attribute where 1=1 ) h on h.attrib_cd = upper(a.bet_mode)
                where a.company_code = '2000'
                and c.attribute2 = 'COPA'
                and d.Period_Id = vPeriod_Id
                and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
                and c.acct_fr NOT in ('NPAT')
                group by 
                d.period_id,
                f.entity_id,
                case when coalesce(c.acct_fr,'xxx') = '50200005' then vwagering_id else coalesce(e.product_id,0) end,
                g.cust_id,
                c.acct_id,
                b.attrib_id,h.attrib_id;

     /*Expense MTD --> CCA (Only Budget Amount)*/
     
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
--                case when coalesce(c.acct_fr,'xxx') in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                coalesce(f.entity_id,h.entity_id ,0) entity_id,
                0 as product_id,
                0 as cust_id,
                case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                coalesce(b.attrib_id,0),
                sum(a.amount) as amount,
                0 as attrib1_id
                from ztsapfi_cca a
                left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
                inner join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on cast(a.cost_element as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on cast(a.cost_element as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_entity f on f.entity_cd = a.cost_center
                left join qlik.dim_entity h on h.entity_cd = a.profit_center
                where a.company_code = '2000'
                and a.currency_type = '20'
				and ( a.plan_category = '' or a.plan_category = 'PLN' ) 
                and c.attribute2 = 'CCA' --and a.version in ('000','P01')
                and d.period_id = vPeriod_Id
                and left(cost_element,1) not in ('A','S')
                and b.attrib_id = 2
                group by 
                d.period_id,
--                case when coalesce(c.acct_fr,'xxx') in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                coalesce(f.entity_id,h.entity_id ,0) ,
                case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                b.attrib_id;

                /*GL --> BS*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
                0 as entity_id,
                0 as product_id,
                0 as cust_id,
                coalesce(c.acct_id,0),
                1 as value_type,
                sum(a.debit_credit_amount) as amount,
                0 as attrib1_id
                from ztsapfi_gl a
                inner join qlik.dim_account c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                where a.company_code = '2000' and left(a.gl_account,1) in ('1','2','3')
                and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
                and c.acct_fr NOT in ('NPAT')
                and d.period_id = vPeriod_Id
                group by 
                d.period_id,
                c.acct_id
                union all 
                /* Net Earning */
                select vPeriod_Id as period_id,
                0 as entity_id,
                0 as product_id,
                0 as cust_id,
                800 as acct_id,
                1 as value_type,
                sum(a.debit_credit_amount) as amount,0 as attrib1_id
                from ztsapfi_gl a
                inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                where a.company_code = '2000' and left(a.gl_account,1) not in ('1','2','3')
                and d.period_id = vPeriod_Id
                --Expense from CCA
                UNION ALL
                select coalesce(d.period_id,0),
                case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                0 as product_id,
                0 as cust_id,
                case when g.acct_id is not null and coalesce(f.attribute7,'NA') = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                1 value_type,
                sum(a.debit_credit_amount) as amount,
                0 as attrib1_id
                from ztsapfi_gl a
                left join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on cast(a.gl_account as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_entity f on f.entity_cd = a.cost_center
                left join qlik.dim_entity h on h.entity_cd = a.profit_center                            
                where a.company_code = '2000'
                and c.attribute2 = 'CCA' 
                and d.period_id = vPeriod_Id
                --and left(gl_account,1) not in ('A','S')
                group by 
                d.period_id,
                case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                case when g.acct_id is not null and coalesce(f.attribute7,'NA') = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end
                
                ;

                /*Budget By League but no Profit Center*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                                period_id,
                                entity_id,
                                product_id,
                                cust_id,
                                acct_id,
                                value_type,
                                activity_amt,
                                attrib1_id
                from qlik.hist_fact_gl_balance a
                where acct_id in (2,1,10,3) and period_id = vPeriod_Id;

                /*Remove Data For Reload*/
                delete from qlik.fact_gl_balance where period_id >= coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 in ('PL','BS'))  and attrib1_id <> 999;

                analyze qlik.fact_gl_balance;
                
                DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
                
                CREATE TABLE qlik.stg_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );
                
                /*Insert into Fact table*/
                insert into qlik.stg_fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type = 2 
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and a.value_type = 2
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                
                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type = 2 and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
                having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 
                
                union all
                
                select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0 as attrib_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id  = vprevperid_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id  = vprevperid_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and c.acct_lvl1 = 'BS'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id, value_type;

                insert into qlik.fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select * from qlik.stg_fact_gl_balance;

                analyze qlik.fact_gl_balance;

--                perform qlik.sp_online_lottery_breakdown(vperiod_id);
               
               --perform qlik.sp_fact_gl_lottery_split(vparperiod);
END;
$_$;


ALTER FUNCTION qlik."sp_fact_gl_balance_BKP_20210609"(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1174 (class 1255 OID 24875)
-- Name: sp_fact_gl_balance_cloud(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_gl_balance_cloud(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $_$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN
     -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

     /*Other Income Update for wagering*/
     update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
	select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Non-Operating Income/Expenses') and acct_type = 'E';

    update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
	select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Other Operating Income') and acct_type = 'E';

	
     /*create temporary fact table*/
	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
     

    /*Revenue MTD --> COPA*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	coalesce(e.product_id,0),
	coalesce(g.cust_id,0),
	coalesce(c.acct_id,0),
	coalesce(b.attrib_id,0),
	sum(a.total_value_controlling) as amount,
	coalesce(h.attrib_id,0) as attrib1_id
	 from ztsapfi_copa a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join qlik.dim_account c on cast(a.cost_element as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_product e on e.product_cd = a.material
	left join qlik.dim_entity f on f.entity_cd = case when left(a.cost_element,1)='4' or trim(a.cost_center) = '' or a.cost_center is null 
	then a.profit_center else a.cost_center end 
	left join qlik.dim_customer g on g.cust_cd = a.customer
	left join (select attrib_id,upper(attrib_cd) as attrib_cd from qlik.dim_attribute where attrib_cd = 'SBK') h on h.attrib_cd = upper(a.bet_mode)
	where a.company_code = '2000'
	and c.attribute2 = 'COPA'
	and d.Period_Id = vPeriod_Id
	and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
	and c.acct_fr NOT in ('NPAT')
	group by 
	d.period_id,
	f.entity_id,
	e.product_id,
	g.cust_id,
	c.acct_id,
	b.attrib_id,h.attrib_id;

     /*Expense MTD --> CCA (Only Budget Amount)*/
     
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	0 as product_id,
	0 as cust_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	coalesce(b.attrib_id,0),
	sum(a.amount) as amount,
	0 as attrib1_id
	 from ztsapfi_cca a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join (select * from qlik.dim_account where acct_lvl5 <> 'Other Income' and attribute2 = 'CCA') c on cast(a.cost_element as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join  (select * from qlik.dim_account where acct_lvl5 = 'Other Income' and attribute2 = 'CCA') g on cast(a.cost_element as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = a.cost_center
	where a.company_code = '2000'
	and a.currency_type = '20'
	and c.attribute2 = 'CCA' --and a.version in ('000','P01')
	and d.period_id = vPeriod_Id
	and left(cost_element,1) not in ('A','S')
	and b.attrib_id = 2
	group by 
	d.period_id,
	f.entity_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	b.attrib_id;


	/*GL --> BS*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	0 as entity_id,
	0 as product_id,
	0 as cust_id,
	coalesce(c.acct_id,0),
	1 as value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	 from ztsapfi_gl a
	inner join qlik.dim_account c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	where a.company_code = '2000' and left(a.gl_account,1) in ('1','2','3')
	and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
	and c.acct_fr NOT in ('NPAT')
	and d.period_id = vPeriod_Id
	group by 
	d.period_id,
	c.acct_id
	union all 
	/* Net Earning */
	select vPeriod_Id as period_id,
	0 as entity_id,
	0 as product_id,
	0 as cust_id,
	800 as acct_id,
	1 as value_type,
	sum(a.debit_credit_amount) as amount,0 as attrib1_id
	 from ztsapfi_gl a
	 inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	where a.company_code = '2000' and left(a.gl_account,1) not in ('1','2','3')
	and d.period_id = vPeriod_Id
	--Expense from CCA
	UNION ALL
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	0 as product_id,
	0 as cust_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	1 value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	from ztsapfi_gl a
	left join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
	left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on cast(a.gl_account as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = a.cost_center
	where a.company_code = '2000'
	--and c.attribute2 = 'CCA' 
	and d.period_id = vPeriod_Id
	--and left(gl_account,1) not in ('A','S')
	group by 
	d.period_id,
	f.entity_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end
	
	;

	/*Budget By League but no Profit Center*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select 
		period_id,
		entity_id,
		product_id,
		cust_id,
		acct_id,
		value_type,
		activity_amt,
		attrib1_id
	from qlik.hist_fact_gl_balance a
	where acct_id in (2,1,10,3) and period_id = vPeriod_Id;

	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 in ('PL','BS'))  and attrib1_id <> 999;

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id


	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type = 2
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 
	
	union all
	
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0 as attrib_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id  = vprevperid_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id  = vprevperid_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and c.acct_lvl1 = 'BS'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;

	perform qlik.sp_online_lottery_breakdown(vperiod_id);
END;
$_$;


ALTER FUNCTION qlik.sp_fact_gl_balance_cloud(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1112 (class 1255 OID 24878)
-- Name: sp_fact_gl_balance_ecc_old(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_gl_balance_ecc_old(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);

BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11 
	--set autocommit = on;

     /*create temporary fact table*/
	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
     

    /*Revenue MTD*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	coalesce(e.product_id,0), 
	coalesce(g.cust_id,0),
	coalesce(c.acct_id,0),
	coalesce(b.attrib_id,0),
	sum(a.total_value_controlling) as amount,
	coalesce(h.attrib_id,0) as attrib1_id
	 from ztsapfi_copa a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join qlik.dim_account c on right(a.cost_element,7) between c.acct_fr and c.acct_to
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_product e on e.product_cd = a.material
	left join qlik.dim_entity f on f.entity_cd = case when left(right(a.cost_element,7),1)='4' or trim(a.cost_center) = '' or a.cost_center is null 
	then a.profit_center else a.cost_center end 
	left join qlik.dim_customer g on g.cust_cd = a.customer
	left join (select attrib_id,upper(attrib_cd) as attrib_cd from qlik.dim_attribute where 1=1) h on h.attrib_cd = upper(a.bet_mode)
	where a.company_code = '2000'
	and c.attribute1 = 'COPA'
	and d.Period_Id = vPeriod_Id
	group by 
	d.period_id,
	f.entity_id,
	e.product_id,
	g.cust_id,
	c.acct_id,
	b.attrib_id,h.attrib_id;

     /*Expense MTD*/
     
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	0 as product_id, 
	0 as cust_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	coalesce(b.attrib_id,0),
	sum(a.amount) as amount,
	0 as attrib1_id
	 from ztsapfi_cca a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join (select * from qlik.dim_account where acct_lvl5 <> 'Other Income' and attribute1 = 'CCA') c on right(a.cost_element,7) between c.acct_fr and c.acct_to 
	left join  (select * from qlik.dim_account where acct_lvl5 = 'Other Income' and attribute1 = 'CCA') g on right(a.cost_element,7) between g.acct_fr and g.acct_to
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = a.cost_center
	where a.company_code = '2000'
	and a.currency_type = '20'
	and c.attribute1 = 'CCA' and a.version in ('000','P01')
	and d.period_id = vPeriod_Id
	and left(cost_element,1) not in ('A','S')
	group by 
	d.period_id,
	f.entity_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	b.attrib_id;

	/*GL*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	0 as entity_id,
	0 as product_id,
	0 as cust_id,
	coalesce(c.acct_id,0),
	1 as value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	 from ztsapfi_gl a
	inner join qlik.dim_account c on right(a.gl_account,7) between c.acct_fr and c.acct_to
	inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	where a.company_code = '2000' and left(right(a.gl_account,7),1) in ('1','2','3')
	and d.period_id = vPeriod_Id
	group by 
	d.period_id,
	c.acct_id
	union all
	select vPeriod_Id as period_id,
	0 as entity_id,
	0 as product_id,
	0 as cust_id,
	800 as acct_id,
	1 as value_type,
	sum(a.debit_credit_amount) as amount,0 as attrib1_id
	 from ztsapfi_gl a
	 inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	where a.company_code = '2000' and left(right(a.gl_account,7),1) not in ('1','2','3')
	and d.period_id = vPeriod_Id;

	/*Budget By League but no Profit Center*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select 
		period_id,
		entity_id,
		product_id,
		cust_id,
		acct_id,
		value_type,
		activity_amt,
		attrib1_id
	from qlik.hist_fact_gl_balance a
	where acct_id in (2,1,10,3) and period_id = vPeriod_Id;

	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 in ('PL','BS')) and attrib1_id <> 999;

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type = 2
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2  and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)  and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 
	
	union all
	
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0 as attrib_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id  = vprevperid_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id  = vprevperid_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and c.acct_lvl1 = 'BS'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;

--	perform qlik.sp_online_lottery_breakdown(vperiod_id);
	perform qlik.sp_fact_gl_lottery_split(vparperiod);
END;
$$;


ALTER FUNCTION qlik.sp_fact_gl_balance_ecc_old(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1152 (class 1255 OID 24881)
-- Name: sp_fact_gl_balance_ecc_old_BKP_20210609(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik."sp_fact_gl_balance_ecc_old_BKP_20210609"(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11 
	--set autocommit = on;

     /*create temporary fact table*/
	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
     

    /*Revenue MTD*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	coalesce(e.product_id,0),
	coalesce(g.cust_id,0),
	coalesce(c.acct_id,0),
	coalesce(b.attrib_id,0),
	sum(a.total_value_controlling) as amount,
	coalesce(h.attrib_id,0) as attrib1_id
	 from ztsapfi_copa a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join qlik.dim_account c on right(a.cost_element,7) between c.acct_fr and c.acct_to
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_product e on e.product_cd = a.material
	left join qlik.dim_entity f on f.entity_cd = case when left(right(a.cost_element,7),1)='4' or trim(a.cost_center) = '' or a.cost_center is null 
	then a.profit_center else a.cost_center end 
	left join qlik.dim_customer g on g.cust_cd = a.customer
	left join (select attrib_id,upper(attrib_cd) as attrib_cd from qlik.dim_attribute) h on h.attrib_cd = upper(a.bet_mode)
	where a.company_code = '2000'
	and c.acct_id <= 1000								-- For ECC data back gen
	and c.attribute1 = 'COPA' and a.version in ('000','P01')
	and d.Period_Id = vPeriod_Id
	group by 
	d.period_id,
	f.entity_id,
	e.product_id,
	g.cust_id,
	c.acct_id,
	b.attrib_id,h.attrib_id;

     /*Expense MTD*/
     
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	coalesce(f.entity_id,0),
	0 as product_id,
	0 as cust_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	coalesce(b.attrib_id,0),
	sum(a.amount) as amount,
	0 as attrib1_id
	 from ztsapfi_cca a
	left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
	inner join (select * from qlik.dim_account where (acct_lvl5 <> 'Other Income' or acct_lvl5 is null) and attribute1 = 'CCA') c on right(a.cost_element,7) between c.acct_fr and c.acct_to 
	left join  (select * from qlik.dim_account where acct_lvl5 = 'Other Income' and attribute1 = 'CCA') g on right(a.cost_element,7) between g.acct_fr and g.acct_to
	left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	left join qlik.dim_entity f on f.entity_cd = a.cost_center
	where a.company_code = '2000'
	and a.currency_type = '20'
	and c.attribute1 = 'CCA' and a.version in ('000','P01')
	and c.acct_id <= 1000								-- For ECC data back gen
	and d.period_id = vPeriod_Id
	and left(cost_element,1) not in ('A','S')
	group by 
	d.period_id,
	f.entity_id,
	case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
	b.attrib_id;

	/*GL*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select coalesce(d.period_id,0),
	0 as entity_id,
	0 as product_id,
	0 as cust_id,
	coalesce(c.acct_id,0),
	1 as value_type,
	sum(a.debit_credit_amount) as amount,
	0 as attrib1_id
	 from ztsapfi_gl a
	inner join qlik.dim_account c on right(a.gl_account,7) between c.acct_fr and c.acct_to
	inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	where a.company_code = '2000' and left(right(a.gl_account,7),1) in ('1','2','3')
	and d.period_id = vPeriod_Id
	and c.acct_id <= 1000								-- For ECC data back gen
	group by 
	d.period_id,
	c.acct_id
	union all
	select vPeriod_Id as period_id,
	0 as entity_id,
	0 as product_id,
	0 as cust_id,
	800 as acct_id,
	1 as value_type,
	sum(a.debit_credit_amount) as amount,0 as attrib1_id
	 from ztsapfi_gl a
	 inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
	 inner join qlik.dim_account c on right(a.gl_account,7) between c.acct_fr and c.acct_to
	where a.company_code = '2000' and left(right(a.gl_account,7),1) not in ('1','2','3')
	and c.acct_id <= 1000								-- For ECC data back gen
	and d.period_id = vPeriod_Id;

	/*Budget By League but no Profit Center*/
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select 
		period_id,
		entity_id,
		product_id,
		cust_id,
		acct_id,
		value_type,
		activity_amt,
		attrib1_id
	from qlik.hist_fact_gl_balance a
	where acct_id in (2,1,10,3) and period_id = vPeriod_Id;

	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 in ('PL','BS')) and attrib1_id <> 999;

	analyze qlik.fact_gl_balance;
	
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type = 2 
	and c.acct_id <= 1000								-- For ECC data back gen
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and c.acct_id <= 1000								-- For ECC data back gen
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and c.acct_id <= 1000								-- For ECC data back gen
	and a.value_type = 2
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vprevperid_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and c.acct_id <= 1000								-- For ECC data back gen
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and c.acct_id <= 1000								-- For ECC data back gen
	and a.value_type = 2  and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
	and c.acct_id <= 1000								-- For ECC data back gen
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)  and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
		   a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
	and c.acct_id <= 1000								-- For ECC data back gen
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 
	
	union all
	
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0 as attrib_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id  = vprevperid_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and c.acct_id <= 1000								-- For ECC data back gen
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id  = vprevperid_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
	and c.acct_id <= 1000								-- For ECC data back gen
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vPeriod_Id
	where a.period_id = vprevperid_id and c.acct_lvl1 = 'BS'
	and c.acct_id <= 1000								-- For ECC data back gen
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type;

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;

	perform qlik.sp_online_lottery_breakdown(vperiod_id);
END;
$$;


ALTER FUNCTION qlik."sp_fact_gl_balance_ecc_old_BKP_20210609"(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1175 (class 1255 OID 24884)
-- Name: sp_fact_gl_balance_prev2019(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_gl_balance_prev2019(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $_$
declare
                vperiod_id integer:= (select cast(vparperiod as integer));
                vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
                vwagering_id integer :=(select product_id from qlik.dim_product where product_cd = 'HR');
BEGIN
     -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

     /*Other Income Update for wagering*/
     update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
                select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Non-Operating Income/Expenses') and acct_type = 'E';

    update qlik.dim_account set acct_lvl3 = 'Operating Profit',acct_lvl4='Operating Expenses',acct_lvl5='Other Income' where acct_id in (
                select acct_id from qlik.dim_account where acct_type = 'E' and acct_lvl4 = 'Other Operating Income') and acct_type = 'E';

                
     /*create temporary fact table*/
                DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

                CREATE TABLE qlik.tmp_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );
     

    /*Revenue MTD --> COPA*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
                coalesce(f.entity_id,0),
                case when coalesce(c.acct_fr,'xxx') = '50200005' then vwagering_id else coalesce(e.product_id,0) end,
                coalesce(g.cust_id,0),
                coalesce(c.acct_id,0),
                coalesce(b.attrib_id,0),
                sum(a.total_value_controlling) as amount,
                coalesce(h.attrib_id,0) as attrib1_id
                from ztsapfi_copa a
                left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
                inner join qlik.dim_account c on right(a.cost_element,7) between c.acct_fr and c.acct_to
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_product e on e.product_cd = a.league_code
                left join qlik.dim_entity f on f.entity_cd = case when left(a.cost_element,1)='4' or trim(a.cost_center) = '' or a.cost_center is null 
                then a.profit_center else a.cost_center end 
                left join qlik.dim_customer g on g.cust_cd = a.customer
                left join (select attrib_id,upper(attrib_cd) as attrib_cd from qlik.dim_attribute where attrib_cd = 'SBK') h on h.attrib_cd = upper(a.bet_mode)
                where a.company_code = '2000'
                and c.attribute2 = 'COPA'
                and d.Period_Id = vPeriod_Id
                and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
                and c.acct_fr NOT in ('NPAT')
                group by 
                d.period_id,
                f.entity_id,
                case when coalesce(c.acct_fr,'xxx') = '50200005' then vwagering_id else coalesce(e.product_id,0) end,
                g.cust_id,
                c.acct_id,
                b.attrib_id,h.attrib_id;

     /*Expense MTD --> CCA (Only Budget Amount)*/
     
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
                case when coalesce(c.acct_fr,'xxx') in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                0 as product_id,
                0 as cust_id,
                case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                coalesce(b.attrib_id,0),
                sum(a.amount) as amount,
                0 as attrib1_id
                from ztsapfi_cca a
                left join (select * from qlik.dim_attribute where attrib_id in (1,2)) b on cast(b.attrib_cd as integer) = a.value_type
                inner join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on right(a.cost_element,7) between c.acct_fr and c.acct_to
                left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on right(a.cost_element,7) between c.acct_fr and c.acct_to
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_entity f on f.entity_cd = a.cost_center
                left join qlik.dim_entity h on h.entity_cd = a.profit_center
                where a.company_code = '2000'
                and a.currency_type = '20'
				and ( a.plan_category = '' or a.plan_category = 'PLN' ) 
                and c.attribute2 = 'CCA' --and a.version in ('000','P01')
                and d.period_id = vPeriod_Id
                and left(cost_element,1) not in ('A','S')
                and b.attrib_id = 2
                group by 
                d.period_id,
                case when coalesce(c.acct_fr,'xxx') in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                case when g.acct_id is not null and f.attribute7 = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                b.attrib_id;

                /*GL --> BS*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select coalesce(d.period_id,0),
                0 as entity_id,
                0 as product_id,
                0 as cust_id,
                coalesce(c.acct_id,0),
                1 as value_type,
                sum(a.debit_credit_amount) as amount,
                0 as attrib1_id
                from ztsapfi_gl a
                inner join qlik.dim_account c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                where a.company_code = '2000' and left(a.gl_account,1) in ('1','2','3')
                and (c.acct_fr ~ '^\d+(.\d+)?$') = 't'
                and c.acct_fr NOT in ('NPAT')
                and d.period_id = vPeriod_Id
                group by 
                d.period_id,
                c.acct_id
                union all 
                /* Net Earning */
                select vPeriod_Id as period_id,
                0 as entity_id,
                0 as product_id,
                0 as cust_id,
                800 as acct_id,
                1 as value_type,
                sum(a.debit_credit_amount) as amount,0 as attrib1_id
                from ztsapfi_gl a
                inner join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                where a.company_code = '2000' and left(a.gl_account,1) not in ('1','2','3')
                and d.period_id = vPeriod_Id
                --Expense from CCA
                UNION ALL
                select coalesce(d.period_id,0),
                case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                0 as product_id,
                0 as cust_id,
                case when g.acct_id is not null and coalesce(f.attribute7,'NA') = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end,
                1 value_type,
                sum(a.debit_credit_amount) as amount,
                0 as attrib1_id
                from ztsapfi_gl a
                left join (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') <> 'Other Income' and attribute2 = 'CCA') c on cast(a.gl_account as integer) between cast(c.acct_fr as integer) and cast(c.acct_to as integer)
                left join  (select * from qlik.dim_account where coalesce(acct_lvl5,'NA') = 'Other Income' and attribute2 = 'CCA') g on cast(a.gl_account as integer) between cast(g.acct_fr as integer) and cast(g.acct_to as integer)
                left join qlik.dim_period d on a.fiscal_year_period = d.fiscal_year_period
                left join qlik.dim_entity f on f.entity_cd = a.cost_center
                left join qlik.dim_entity h on h.entity_cd = a.profit_center                            
                where a.company_code = '2000'
                and c.attribute2 = 'CCA' 
                and d.period_id = vPeriod_Id
                --and left(gl_account,1) not in ('A','S')
                group by 
                d.period_id,
                case when c.acct_fr in ('50200010','50200006','50200015') then coalesce(h.entity_id,0) else coalesce(f.entity_id,0) end,
                case when g.acct_id is not null and coalesce(f.attribute7,'NA') = 'Wagering' then coalesce(g.acct_id,0) else coalesce(c.acct_id,0) end
                
                ;

                /*Budget By League but no Profit Center*/
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                                period_id,
                                entity_id,
                                product_id,
                                cust_id,
                                acct_id,
                                value_type,
                                activity_amt,
                                attrib1_id
                from qlik.hist_fact_gl_balance a
                where acct_id in (2,1,10,3) and period_id = vPeriod_Id;

                /*Remove Data For Reload*/
                delete from qlik.fact_gl_balance where period_id >= coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 in ('PL','BS'))  and attrib1_id <> 999;

                analyze qlik.fact_gl_balance;
                
                DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
                
                CREATE TABLE qlik.stg_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );
                
                /*Insert into Fact table*/
                insert into qlik.stg_fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt), attrib1_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type = 2 
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and a.value_type = 2
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vprevperid_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                
                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type = 2 and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type and b.attrib1_id = a.attrib1_id
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and c.acct_lvl1 = 'PL'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null and b.attrib1_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and c.acct_lvl1 = 'PL'
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
                having sum(opening_amt) <> 0 or sum(activity_amt) <> 0 or sum(closing_amt) <> 0 
                
                union all
                
                select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),0 as attrib_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id  = vprevperid_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id  = vprevperid_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'BS'
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vPeriod_Id
                where a.period_id = vprevperid_id and c.acct_lvl1 = 'BS'
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and a.value_type=1 and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer) and a.attrib1_id <> 999
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id, value_type;

                insert into qlik.fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select * from qlik.stg_fact_gl_balance;

                analyze qlik.fact_gl_balance;

                perform qlik.sp_online_lottery_breakdown(vperiod_id);
END;
$_$;


ALTER FUNCTION qlik.sp_fact_gl_balance_prev2019(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1153 (class 1255 OID 24887)
-- Name: sp_fact_gl_lottery_split(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_gl_lottery_split(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	
	v_dc_amount decimal;
	v_gl_amount decimal;

BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11
	--set autocommit = on;
	
	if vperiod_id < 202104
   	then
		    /*
		     * Create a record in DIM ENTITY for three Remote Channels (Online, Mobile, Phone) if its not already exists
		     */
				   INSERT INTO qlik.dim_entity
				(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
				select -1, 'Dummy-LottSplit', 'Interactive Voice Response', '200700', 'IVR', '200700', 'IVR', 'SPPL', '', '', '', 'Remote', '', 'Online', '' 
						where not exists (select 1 from qlik.dim_entity where entity_id = -1);
		
					INSERT INTO qlik.dim_entity
				(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
				select -2, 'Dummy-LottSplit', 'Remote Betting - Mobile', '201000', 'Remote Ch', '201000', 'Remote Channel', 'SPPL', '', '', '', 'Remote', '', 'Mobile', '' 
						where not exists (select 1 from qlik.dim_entity where entity_id = -2);
					
					INSERT INTO qlik.dim_entity
				(entity_id, entity_cd, entity_nm, dept_cd, dept_nm, div_cd, div_nm, company, attribute1, attribute2, attribute3, attribute4, attribute5, attribute6, attribute7)
				select -3, 'Dummy-LottSplit', 'Interactive Voice Response', '200700', 'IVR', '200700', 'IVR', 'SPPL', '', '', '', 'Remote', '', 'Phone', '' 
						where not exists (select 1 from qlik.dim_entity where entity_id = -3);
				
					
		    /* 
		     * Create a record in DIM ATTRIBUTE if its not already exists - to identify the records in FACT_G_BALANCE loaded by this function
		     * ATTRIB_ID = -1 can be used to identify/delete all data loaded by this function for lottery split in FACT_G_BALANCE
		     */
					insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
						select -1, 'LS_Online', 'Online', 'Lottery Channel Split' 
							where not exists (select 1 from qlik.dim_attribute where attrib_id =-1);
		
		   
		    /* Create temporary table to store the difference between fact_gl_balance (SAP) and fact_daily_collections (OB)
		     * This difference will be parked to Online Channel
			*/
			drop table if exists qlik.tmp_lotteries_channel_split;
		
		    create table qlik.tmp_lotteries_channel_split as
					select  
					  sub2.period_id
					, sub2.product_cd
					, sub2.product_id
					, sub2.cust_id
					, sub2.acct_id
					, sub2.value_type
					, 0 as opening_amt
					, sub2.sap_sales_mtd - sub1.dc_sales as activity_amt
					, 0 as closing_amt
					from 
					(
						select period_id,  product_cd, sum(value) dc_sales from qlik.fact_daily_collection 
						where 1=1
						and period_id = vperiod_id
						and measure_nm = 'sales'
						and (product_cd = 'TOTO' or product_cd = '4D' or product_cd = 'SWEEP' )
						and attribute1 in ('Internet','IVR','Mobile')
						group by product_cd, period_id
					) SUB1,
					(	select fgb.period_id,  dp.product_cd , fgb.product_id , fgb.cust_id , fgb.acct_id , fgb.value_type 
						,  sum(activity_amt * -1) sap_sales_mtd, sum(closing_amt * -1) sap_sales_ytd
						from qlik.fact_gl_balance fgb , qlik.dim_product dp , qlik.dim_entity de , qlik.dim_account da 
						where 1=1
						and fgb.product_id = dp.product_id 
						and fgb.entity_id = de.entity_id 
						and fgb.acct_id = da.acct_id 
						and  dp.product_lvl1  = 'LOTTERIES'
						and dp.product_cd in ('4D','TOTO')
						and de.attribute4 = 'Remote'
						and de.attribute6 = 'Phone'
						and da.acct_lvl5 = 'Sales'
						and value_type = 1
						and fgb.attrib1_id <> -1 
						and fgb.period_id = vperiod_id
						group by dp.product_cd , fgb.period_id, fgb.product_id , fgb.cust_id , fgb.acct_id , fgb.value_type 
					) SUB2
					where 1=1
					and sub1.product_cd = sub2.product_cd
					and sub1.period_id = sub2.period_id
		--			and sub2.sap_sales_mtd - sub1.dc_sales > 0
					;
		
			drop table if exists qlik.tmp_lotteries_split2;
		
			/*
			 * Union 1: Brings Online data based on the difference between SAP (FACT_GL_BALANCE) and OB (FACT_DAILY_COLLECTION) data 
			 * Union 2: Brings data from OB as OB data has grouped by Channels which cannot be identified by SAP data.
			 * */
			create table qlik.tmp_lotteries_split2 as		
				select period_id, -1 entity_id, product_id, cust_id, acct_id, value_type
					,opening_amt,activity_amt * -1 as activity_amt,closing_amt, -1 attrib1_id 
				from qlik.tmp_lotteries_channel_split
			union all
				select  
					period_id
					, case 
						when attribute1 = 'Internet' then -1
						when attribute1 = 'Mobile' then -2
						when attribute1 = 'IVR' then -3
					  end as entity_id
					, case 
						when product_cd = 'TOTO' then (select max(product_id) from qlik.dim_product dp where product_cd in ('TOTO'))
						when product_cd = '4D' then (select max(product_id) from qlik.dim_product dp where product_cd in ('4D'))
					 end as product_id
					, 0 as cust_id 	, 1 as acct_id	, 1 as value_type 	, 0 as opening_amt
					, sum(value) * -1 as activity_amt
					, 0 as closing_amt 	, -1 attribute1 
				from qlik.fact_daily_collection 
					where 1=1
					and period_id = vperiod_id
					and measure_nm = 'sales'
					and (product_cd = 'TOTO' or product_cd = '4D' )
					and attribute1 in ('Internet','IVR','Mobile')
					group by product_cd, period_id, attribute1 ;
				
			
			drop table if exists qlik.tmp_lotteries_split3;
		
			/*
			 * Brings SAP data from FACT_GL_BALANCE and store the activity amount by reversed sign so that the total amount does not get affected by tmp_lotteries_split2 data
			 */ 
			create table qlik.tmp_lotteries_split3 as		
				select  
					period_id,fgb.entity_id,product_id,cust_id,acct_id,value_type
					, opening_amt *-1 opening_amt
					, activity_amt * -1 activity_amt
					, closing_amt * -1 closing_amt
					, -1 attrib1_id
				from qlik.fact_gl_balance fgb , qlik.dim_entity de where 1=1
					and fgb.entity_id = de.entity_id
					and period_id = vperiod_id
					and acct_id in (select acct_id from qlik.dim_account da where acct_lvl5 = 'Sales')
					and product_id in (select product_id from qlik.dim_product dp where product_lvl1 = 'LOTTERIES' and dp.product_cd in ('4D','TOTO'))
					and value_type = 1
					and attrib1_id <> -1
					and de.attribute4 = 'Remote';
				
			
			v_dc_amount := (select sum(activity_amt) from qlik.tmp_lotteries_split2);
		
			v_gl_amount := (select sum(activity_amt)*-1 from qlik.tmp_lotteries_split3);
			
			
		
			if v_dc_amount = v_gl_amount
				then
		--			raise notice 'Amount Equal::';
		--			raise notice 'v_dc_amount:%', v_dc_amount;
		--			raise notice 'v_gl_amount:%', v_gl_amount;
		--		else 
		--			raise notice 'Amount Not Equal::';
		--			raise notice 'v_dc_amount:%', v_dc_amount;
		--			raise notice 'v_gl_amount:%', v_gl_amount;
		--	end if;	
				
					drop table if exists qlik.tmp_lotteries_split4;
				
					create table qlik.tmp_lotteries_split4 as
						select * from qlik.tmp_lotteries_split2
						union all
						select * from qlik.tmp_lotteries_split3;
					
					delete from qlik.fact_gl_balance where period_id = vperiod_id and attrib1_id = -1;
					
					insert into qlik.fact_gl_balance (
						                  period_id,
						                  entity_id,
						                  product_id,
						                  cust_id,
						                  acct_id,
						                  value_type,
						                  opening_amt,
						                  activity_amt,
						                  closing_amt,
						                  attrib1_id
						                )
					select period_id,entity_id,product_id,cust_id,acct_id,value_type,sum(opening_amt),sum(activity_amt),sum(closing_amt),attrib1_id
					from (
						select 
							period_id,entity_id,product_id,cust_id,acct_id,value_type,opening_amt,activity_amt,closing_amt,attrib1_id
						from qlik.tmp_lotteries_split4
						union all
						select 
							a.period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type
							, coalesce(tmp.opening_amt,0) as opening_amt
							, coalesce(tmp.activity_amt,0) as activity_amt
							, coalesce(closing_amt,0) as closing_amt
							, a.attrib1_id
						from 
							(
								select distinct b.period_id, sq.entity_id , sq.product_id, sq.cust_id, sq.acct_id, sq.value_type, sq.attrib1_id from 
								(
								select  distinct 
								  f.period_id, f.entity_id , f.product_id, f.cust_id, f.acct_id, f.value_type, f.attrib1_id
								from qlik.fact_gl_balance f, qlik.dim_period p  where 1=1
									and f.period_id = p.period_id
									and p.period_id <= vperiod_id
									and p.fiscal_year = (select fiscal_year from qlik.dim_period where period_id = vperiod_id)
									and f.attrib1_id = -1
									and not exists 
										(select 1 from qlik.tmp_lotteries_split4 t where f.entity_id = t.entity_id 
											and f.product_id = t.product_id and f.cust_id = t.cust_id	
											and f.acct_id = t.acct_id and f.value_type = t.value_type and f.attrib1_id = t.attrib1_id)
								) sq 
								, (select period_id from qlik.dim_period where period_id = vperiod_id) b
								where 1=1
							) a 
							left outer join qlik.tmp_lotteries_split4 tmp
								on (
									a.entity_id 	= tmp.entity_id 
								and a.product_id 	= tmp.product_id
								and a.cust_id		= tmp.cust_id
								and a.acct_id 		= tmp.acct_id
								and a.value_type 	= tmp.value_type
								and a.attrib1_id 	= tmp.attrib1_id
								)
						) main
						group by period_id,entity_id,product_id,cust_id,acct_id,value_type,attrib1_id;
			    
					
					-- Create temporary table to store the closing balance
					drop table if exists qlik.tmp_lot_channel_closing_amt;
						
						create table qlik.tmp_lot_channel_closing_amt
						as
						select period_id,entity_id,product_id,cust_id,acct_id,value_type,attrib1_id,closing_amt
						, coalesce(lag(closing_amt, 1) over (partition by entity_id,product_id,cust_id,acct_id,value_type,attrib1_id order by period_id),0) opening_amt
						from (
							select fgb.period_id, fgb.entity_id, fgb.product_id, fgb.cust_id, fgb.acct_id, fgb.value_type, fgb.attrib1_id 
							, sum(fgb.activity_amt) over (partition by fgb.entity_id, fgb.product_id, fgb.cust_id, fgb.acct_id order by  fgb.period_id ) as "closing_amt"
							from qlik.fact_gl_balance fgb , qlik.dim_period dp where 1=1
							and fgb.attrib1_id = -1
							and fgb.period_id = dp.period_id
							and dp.fiscal_year = (select fiscal_year from qlik.dim_period where period_id = vperiod_id)
						) sq;
							
						
							update qlik.fact_gl_balance fgb set closing_amt = b.closing_amt , opening_amt = b.opening_amt
							from  qlik.tmp_lot_channel_closing_amt b
							where fgb.period_id = b.period_id 
							and fgb.entity_id = b.entity_id 
							and fgb.product_id = b.product_id 
							and fgb.cust_id = b.cust_id
							and fgb.acct_id = b.acct_id
							and fgb.value_type = b.value_type 
							and fgb.attrib1_id = b.attrib1_id
							;
						
					analyze qlik.fact_gl_balance;
			
			end if;

	end if;
		
END;
$$;


ALTER FUNCTION qlik.sp_fact_gl_lottery_split(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1215 (class 1255 OID 24890)
-- Name: sp_fact_pnc_employee(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_pnc_employee(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare

	vperiod_id integer:= 
		(select 
			case 
				when cast(coalesce(vparperiod) as integer) = 0
				then (select period_id from qlik.dim_period where period_id = cast(to_char(current_date - interval '1' month,'YYYYMM') as integer) )
			else cast(coalesce(vparperiod) as integer) end )
	;

begin

/* start headcount */

delete from qlik.fact_pnc --select * from qlik.fact_pnc 
where period_id = vperiod_id and
 acct_id in (select acct_id from qlik.dim_account da 
					where da.acct_lvl1 ='PNC' and da.acct_lvl2 in ('Headcount', 'New Hire', 'Leavers'));

analyze qlik.fact_pnc;

-- - inserting into fact_pnc table
insert into qlik.fact_pnc (
	period_id, entity_id, acct_id, attrib1_id, attrib2_id, opening_amt, activity_amt, closing_amt, value, attribute1
)
select vperiod_id as period_id, 
	case when de.entity_id is null then 0 else de.entity_id end,
	(select acct_id from qlik.dim_account da where da.acct_lvl1 ='PNC' and da.acct_lvl2 = 'Headcount') as acct_id,
	0 as attrib1_id, 0 as attrib2_id, 0.00 as opening_amt,  0.00 as activity_amt,  0.00 as closing_amt, 
	count(distinct se.employeeid ) as value,
	case when payroll_area  in ('PS', 'PE') then 'MGMT' 
	when payroll_area  in ('PO', 'PJ') then 'NON MGMT'
	when payroll_area  in ('PT', 'P7','99') then 'CASUALS' else null end as attribute1	
from qlik.dim_employee se 
left outer join qlik.dim_entity de on de.entity_cd = se.costcentercode 
where 
	(se.lastdayofservice is  null 
		or cast(coalesce(to_char(se.lastdayofservice , 'YYYYMM')) as integer) > vperiod_id  
		or se.lastdayofservice =(date_trunc('MONTH', (vperiod_id||'01')::date) + INTERVAL '1 MONTH - 1 day')::DATE) 
	and cast(coalesce(to_char(se.joiningdate , 'YYYYMM')) as integer) <= vperiod_id
group by period_id, case when de.entity_id is null then 0 else de.entity_id end, 
case when payroll_area  in ('PS', 'PE') then 'MGMT' 
when payroll_area  in ('PO', 'PJ') then 'NON MGMT'
when payroll_area  in ('PT', 'P7','99') then 'CASUALS' else null end 
;
analyze qlik.fact_pnc;

/* end headcount */

--- New hires ---
insert into qlik.fact_pnc (
	period_id, entity_id, acct_id, attrib1_id, attrib2_id, opening_amt, activity_amt, closing_amt, value, attribute1
)
select vperiod_id as period_id,
	case when de.entity_id is null then 0 else de.entity_id end,
	(select acct_id from qlik.dim_account da where da.acct_lvl1 ='PNC' and da.acct_lvl2 = 'New Hire') as acct_id, --	'New Hire' as Measure, 
	0 as attrib1_id, 0 as attrib2_id, 0.00 as opening_amt,  0.00 as activity_amt,  0.00 as closing_amt, 
	count(distinct emp.employeeid ) as value,	
	'' as attribute1
from qlik.dim_employee emp 
left outer join qlik.dim_entity de 
on de.entity_cd = emp.costcentercode 
where emp.employeegroup = 'A' -- for Perm resources
and cast(coalesce(to_char(emp.joiningdate , 'YYYYMM')) as integer) = vPeriod_Id 
and emp.joiningdate is not null
group by vperiod_id,
de.entity_id
;
analyze qlik.fact_pnc;
--- end new hires ---

--- Resignation / Leavers
insert into qlik.fact_pnc (
	period_id, entity_id, acct_id, attrib1_id, attrib2_id, opening_amt, activity_amt, closing_amt, value, attribute1
)
select vperiod_id as period_id,
	case when de.entity_id is null then 0 else de.entity_id end,
	(select acct_id from qlik.dim_account da where da.acct_lvl1 ='PNC' and da.acct_lvl2 = 'Leavers') as acct_id, --'Leavers' as Measure,
	0 as attrib1_id, 0 as attrib2_id, 0.00 as opening_amt,  0.00 as activity_amt,  0.00 as closing_amt, 
	count(distinct emp.employeeid ) as value,	
	'' as attribute1
from qlik.dim_employee emp 
left outer join qlik.dim_entity de 
on de.entity_cd = emp.costcentercode 
where 1=1 
and cast(coalesce(to_char(lastdayofservice,'YYYYMM')) as integer) = vperiod_id
group by vperiod_id,
de.entity_id;

analyze qlik.fact_pnc;

end;

$$;


ALTER FUNCTION qlik.sp_fact_pnc_employee(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1216 (class 1255 OID 24891)
-- Name: sp_fact_pnc_training(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_pnc_training(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(coalesce(vparperiod) as integer));


BEGIN

	delete from qlik.fact_pnc
	where period_id = vperiod_id
	and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 = 'PNC' and attribute2 = 'PNC');

insert into qlik.fact_pnc
	(period_id, entity_id, acct_id, attrib1_id, attrib2_id, value, remarks, attribute1, attribute2, dept_cd, div_cd, dept_nm, div_nm)
select 
	a.period, 
	0 as entity_id,
	case when b.acct_id is null then 0 else b.acct_id end as acct_id,
	0 as attrib1_id,
	0 as attrib2_id, 
	sum(a.value) as value, 
	a.remarks as remarks,
	a.attribute1,
	case when b.acct_id in (-30, -31, -32) then 'IDP Submission' else a.attribute2 end as attribute2 ,
	case when upper(a.departmentnm) = 'ALL' then 'ALL' else a.departmentcd end as dept_cd,
	case when upper(a.divisionnm) = 'ALL' then 'ALL' else a.divisioncd end as div_cd,
	a.departmentnm as dept_nm,
	a.divisionnm as div_nm
from qlik.stg_pnc a
left join (select acct_id, acct_lvl2 from qlik.dim_account where acct_lvl1 = 'PNC' and attribute2 = 'PNC') b on a.measure = b.acct_lvl2
where a.period = vPeriod_Id 
group by a.period, acct_id, a.attribute1, a.attribute2, a.remarks,  a.departmentcd, a.divisioncd, a.departmentnm, a.divisionnm
;


END;
$$;


ALTER FUNCTION qlik.sp_fact_pnc_training(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1178 (class 1255 OID 24892)
-- Name: sp_fact_product_load(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_product_load(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare

	vacct_id_arpd 			integer;
	vacct_id_tc				integer;
	vacct_id_sts			integer;
	vacct_id_ste			integer;
	vacct_id_pod			integer;	
	vacct_id_tsdt			integer;
	vacct_id_tcdt			integer;
	vacct_id_sdr			integer;
	vacct_id_tst			integer;
	vacct_id_tsb			integer;
	vacct_id_tbc			integer;
	vacct_id_sbc			integer;
	vacct_id_stp			integer;
	vacct_id_ssb			integer;
	vacct_id_spb			integer;
	vacct_id_seb			integer;
	vacct_id_hrc			integer;
	vacct_id_hre			integer;
	vacct_id_hrcc			integer;
	vacct_id_hrsa			integer;
	vacct_id_hrsb			integer;
	vacct_id_hrbt			integer;
	vacct_id_hrac			integer;
	vacct_id_hrea			integer;
	vacct_id_hreb			integer;
	vacct_id_sms			integer;
	vacct_id_smp			integer;
	vacct_id_ebs			integer;
	
BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

   
   /* Start data load for '4D Average Revenue per Draw in Fact Product'*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -18, '', '', '', 'FACT_PRODUCT', '4D', '', '','', '',  '4D Average Revenue per Draw', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -18 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Average Revenue per Draw'));
	

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -22, '', '', '', 'FACT_PRODUCT', '4D', '', '','', '',  '4D Payout Distribution', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -22
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Payout Distribution'));	
			
	vacct_id_arpd := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Average Revenue per Draw');
	vacct_id_pod := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Payout Distribution');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
select    fdc.period_id as period_id
				, 0 as Entity_id
				, dp.product_id as Product_id
				, case 
					when fdc.measure_nm = 'sales' then vacct_id_arpd
					when fdc.measure_nm = 'payout' then vacct_id_pod
				  end as acct_id
				, 0 as opening_amt
				, sum(fdc.value) * -1 activity_amt
				, 0 as Closing_amt
				, 0 as attrib1_id
				, 0 as attrib2_id
				, 0 as attrib3_id
				, fdc.attribute2 as notes
				, fdc.business_date as business_date
		from qlik.fact_daily_collection fdc , qlik.dim_product dp where 1=1
		and fdc.product_cd = dp.product_cd
		and fdc.product_cd  = '4D'
--		and fdc.period_id = 202101
		and fdc.measure_nm in ('sales','payout')
		group by fdc.period_id, dp.product_id, fdc.measure_nm, fdc.attribute2
				, fdc.business_date;	
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_arpd, vacct_id_pod);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		
	
	-- drop and create temp table for updating the opening and closing amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id, notes order by period_id),0) as opening_amt 
				, activity_amt
				, closing_amt
				, notes
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt , fp.notes
				, SUM(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year, fp.notes order by fp.period_id asc) as closing_amt
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_arpd,vacct_id_pod)
				order by 1
				) SQ;
		
		-- update oepning and closing amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.notes = b.notes
				and a.acct_id in (vacct_id_arpd, vacct_id_pod);

	/* End of data load for '4D Average Revenue per Draw' in Fact Product*/
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			
			
	 /* Start data load for 'Total Collection' in Fact Product for "Sweep % Ticket Sold" report*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -19, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Total Collection', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -19 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Total Collection'));
	
	vacct_id_tc := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Total Collection');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
		select    fdc.period_id as period_id
				, 0 as Entity_id
				, dp.product_id as Product_id
				, vacct_id_tc as acct_id
				, 0 as opening_amt
				, Round(sum(fdc.value),2) *-1 as activity_amt
				, 0 as Closing_amt
				, 0 as attrib1_id
				, 0 as attrib2_id
				, 0 as attrib3_id
				, cast(null as varchar) as notes
		from qlik.fact_daily_collection fdc , qlik.dim_product dp where 1=1
		and fdc.product_cd = dp.product_cd
		and fdc.product_cd = 'SWEEP'
		--and fdc.period_id = 202001
		and fdc.measure_nm = 'collection by draw'
		group by fdc.period_id, dp.product_id;
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id = vacct_id_tc;
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		
	
	-- drop and create temp table for updating the opening and closing amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id order by period_id),0) as opening_amt 
				,  activity_amt
				, closing_amt
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt 
				, sum(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year order by fp.period_id asc) as closing_amt
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  = vacct_id_tc
				order by 1
				) SQ;
		
		-- update oepning and closing amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.acct_id = vacct_id_tc;

	 /* End of data load for 'Total Collection' in Fact Product for "Sweep % Ticket Sold" report*/	
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

	 /* Start data load for 'SPORTS - Average Revenue' and 'SPORTS Total Sales' in Fact Product for "Sports - Average revenue per event" report*/
	
   -- Insert manual dim account entry specific for Sports Total Sales
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -20, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Sales', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -20 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Sales'));

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -21, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Event', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -21 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Event'));

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -60, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Payout', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -60 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Payout'));

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -151, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Multiple Sales', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -151 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Multiple Sales'));
	
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -152, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Multiple Payout', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -152 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Multiple Payout'));
	
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -153, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Event Budget', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -153 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Event Budget'));		
			
	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -18, 'Trading Ops Channels', 'Retail', 'FACT_PRODUCT' 
			where not exists (select 1 from qlik.dim_attribute where attrib_id =-18);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -19, 'Trading Ops Channels', 'Internet', 'FACT_PRODUCT' 
			where not exists (select 1 from qlik.dim_attribute where attrib_id =-19);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -20, 'Trading Ops Channels', 'Mobile', 'FACT_PRODUCT' 
			where not exists (select 1 from qlik.dim_attribute where attrib_id =-20);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -21, 'Trading Ops Channels', 'Phone', 'FACT_PRODUCT' 
			where not exists (select 1 from qlik.dim_attribute where attrib_id =-21);
		
			
	
	vacct_id_ste := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Event');
	vacct_id_sts := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Sales');
	vacct_id_stp := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Payout');
	vacct_id_sms := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Multiple Sales');
	vacct_id_smp := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Multiple Payout');
	vacct_id_ebs := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Event Budget');

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select    
 				fdc.period_id as period_id
				, 0 as Entity_id
				, coalesce(dp.product_id,0) as Product_id
				, case 
					when fdc.measure_nm = 'sales' then vacct_id_sts
					when fdc.measure_nm = 'no of event' then vacct_id_ste
					when fdc.measure_nm = 'payout' then vacct_id_stp
				    when fdc.measure_nm = 'sales by multiple bet' then vacct_id_sms
				    when fdc.measure_nm = 'payout by multiple bet' then vacct_id_smp
				    when fdc.measure_nm = 'no of event budget' then vacct_id_ebs
				  end as acct_id
				, 0 as opening_amt
				, Round(sum(fdc.value),2) * -1 as activity_amt
				, 0 as Closing_amt
				, coalesce( 
				  case 
					when right(dp.product_cd,1) = 'L' then  (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Live Betting')
					else (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Pre-Match')
				  end , 0 ) as attrib1_id
				, coalesce( 
				  case 
					when right(dp.product_cd,4) like 'W01%' then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'World Cup')
					when dp.product_cd in ('FBE03P', 'FBE03L', 'FBE03S') then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'European')
				  	else (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'Leagues') 
				  end, 0) as attrib2_id
				, case when fdc.measure_nm in ('sales','sales by multiple bet')
					then 				
						case 
						when fdc.attribute2 = 'Internet' then 
						(select attrib_id from qlik.dim_attribute where attrib_cd= 'Trading Ops Channels' and attribute1 = 'FACT_PRODUCT' and attrib_nm = 'Internet')
						when fdc.attribute2 = 'Mobile' then 
						(select attrib_id from qlik.dim_attribute where attrib_cd= 'Trading Ops Channels' and attribute1 = 'FACT_PRODUCT' and attrib_nm = 'Mobile')
						when fdc.attribute2 = 'Phone' then 
						(select attrib_id from qlik.dim_attribute where attrib_cd= 'Trading Ops Channels' and attribute1 = 'FACT_PRODUCT' and attrib_nm = 'Phone')
						else 
						(select attrib_id from qlik.dim_attribute where attrib_cd= 'Trading Ops Channels' and attribute1 = 'FACT_PRODUCT' and attrib_nm = 'Retail')
				  		end 
				  	else 0 end as attrib3_id
				, cast(zwm.yieldmargin as text) as notes
				, case 
					when fdc.measure_nm in ('sales','payout') then cast('Bet Type' as varchar ) 
					when fdc.measure_nm in ('sales by multiple bet','payout by multiple bet') then cast('Multiple Bet type' as varchar )
					else null
					end as x_attribute1_type
				, case 
					when fdc.measure_nm in ('sales','payout') then zwm.marketgroup 
					when fdc.measure_nm in ('sales by multiple bet','payout by multiple bet') then fdc.attribute1
					else null
					end as x_attribute1_value
		from (
				select fdc.period_id, fdc.business_date, coalesce(ztt.zt_product_cd, fdc.product_cd) as product_cd
				, fdc.measure_nm , fdc.attribute1, fdc.attribute2, fdc.attribute3,fdc.value
				, fdc.product_cd dc_prd_cd, zt_product_nm
				from qlik.fact_daily_collection fdc 
					left outer join  (select distinct sports_type || league_code zt_product_cd, league_name  as zt_product_nm
					from public.ztob_timetable ) ztt
					on (fdc.product_cd = ztt.zt_product_nm)	
				where 1=1
				and fdc.product_cd not in ('4D','TOTO','SWEEP','HORSE RACING')
			) fdc
			left outer join qlik.dim_product dp on (fdc.product_cd = dp.product_cd or fdc.product_cd = dp.product_nm)
			left outer join public.ztall_weight_margin zwm 
						on (upper(zwm.markets) = upper(case when fdc.attribute1 like 'HTH - Team%' then 'HTH - Team'
				  								 when fdc.attribute1 like 'HTH - Driver%' then 'HTH - Driver'
				   								 else fdc.attribute1 end))
		where 1=1
		and fdc.measure_nm in ('sales', 'no of event', 'payout','sales by multiple bet','payout by multiple bet','no of event budget')
		and fdc.product_cd not in ('4D','TOTO','SWEEP','HORSE RACING')
--		and fdc.period_id = 202103
		group by fdc.period_id, dp.product_cd, dp.product_id, fdc.measure_nm
		, cast(zwm.yieldmargin as text)
		, case 
			when fdc.measure_nm in ('sales','payout') then cast('Bet Type' as varchar ) 
			when fdc.measure_nm in ('sales by multiple bet','payout by multiple bet') then cast('Multiple Bet type' as varchar )
			end 
		, case 
			when fdc.measure_nm in ('sales','payout') then zwm.marketgroup 
			when fdc.measure_nm in ('sales by multiple bet','payout by multiple bet') then fdc.attribute1
			end
		, case when fdc.measure_nm in ('sales','sales by multiple bet')
			then 				
				case 
				when fdc.attribute2 = 'Internet' then 
				(select attrib_id from qlik.dim_attribute where attrib_cd= 'Trading Ops Channels' and attribute1 = 'FACT_PRODUCT' and attrib_nm = 'Internet')
				when fdc.attribute2 = 'Mobile' then 
				(select attrib_id from qlik.dim_attribute where attrib_cd= 'Trading Ops Channels' and attribute1 = 'FACT_PRODUCT' and attrib_nm = 'Mobile')
				when fdc.attribute2 = 'Phone' then 
				(select attrib_id from qlik.dim_attribute where attrib_cd= 'Trading Ops Channels' and attribute1 = 'FACT_PRODUCT' and attrib_nm = 'Phone')
				else 
				(select attrib_id from qlik.dim_attribute where attrib_cd= 'Trading Ops Channels' and attribute1 = 'FACT_PRODUCT' and attrib_nm = 'Retail')
		  		end 
		  	else 0 end ;
	
		drop table if exists qlik.tmp_load_zero_closing;
	
		create table qlik.tmp_load_zero_closing as
			select distinct b.period_id , a.entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id
						,notes,x_attribute1_type,x_attribute1_value from 
			  (select distinct f.period_id, entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id, p.fiscal_year 
					  ,notes,x_attribute1_type,x_attribute1_value
			  		from qlik.tmp_fact_product_dc f, qlik.dim_period p
			  				where f.period_id = p.period_id) a
			, (select period_id, fiscal_year from qlik.dim_period  where period_id 
						between (select min(period_id) from qlik.tmp_fact_product_dc)
							and (select max(period_id) from qlik.tmp_fact_product_dc)
				) b 
			where a.period_id <= b.period_id and a.fiscal_year = b.fiscal_year;
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_sts, vacct_id_ste, vacct_id_stp, vacct_id_sms, vacct_id_smp,vacct_id_ebs);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product 
--	select * from qlik.tmp_fact_product_dc;
		select a.period_id, a.entity_id, a.product_id, a.acct_id
			, coalesce(b.opening_amt,0) as opening_amt
			, coalesce(b.activity_amt,0) as activity_amt
			, coalesce(b.closing_amt,0) as closing_amt
			, a.attrib1_id, a.attrib2_id, a.attrib3_id
			, a.notes , cast(null as date) as business_date
			, a.x_attribute1_type, a.x_attribute1_value
			from qlik.tmp_load_zero_closing a
			left outer join qlik.tmp_fact_product_dc b
							on (	a.period_id 		= b.period_id
									and a.entity_id 	= b.entity_id
									and a.product_id	= b.product_id
									and a.acct_id 		= b.acct_id
									and a.attrib1_id 	= b.attrib1_id
									and a.attrib2_id 	= b.attrib2_id
									and a.attrib3_id 	= b.attrib3_id
									and coalesce(a.notes,'x') 	= coalesce(b.notes,'x')
									and coalesce(a.x_attribute1_type,'x') 	= coalesce(b.x_attribute1_type,'x')
									and coalesce(a.x_attribute1_value,'x') 	= coalesce(b.x_attribute1_value,'x')
									);
		
	-- delete from fact_product for number of events for month of may-2020
	delete from qlik.fact_product where acct_id =vacct_id_ste
	and period_id = 202005;
								
								
	-- drop and create temp table for updating the opening and CLOSING amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
		
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, product_id , acct_id,attrib1_id
							, attrib2_id, attrib3_id,notes,business_date,x_attribute1_type,x_attribute1_value 
							order by  period_id),0) as opening_amt 
				,  activity_amt
				, closing_amt
				, attrib1_id
				, attrib2_id
				, attrib3_id,notes,business_date,x_attribute1_type,x_attribute1_value
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt 
				, sum(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year,fp.attrib1_id
						, fp.attrib2_id, fp.attrib3_id,fp.notes,fp.business_date,fp.x_attribute1_type,fp.x_attribute1_value 
						order by fp.product_id, fp.period_id asc) as closing_amt
				, fp.attrib1_id, fp.attrib2_id, attrib3_id,notes,business_date,x_attribute1_type,x_attribute1_value
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_sts, vacct_id_ste, vacct_id_stp, vacct_id_sms, vacct_id_smp,vacct_id_ebs)
--				and fp.acct_id  in (-21)
--				and product_id = 21
--				and dp.fiscal_year = 'FY20'
				) SQ
				order by  1, 2
				;
		
		-- update oepning and CLOSING amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
--				and a.entity_id = b.entity_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.attrib1_id = b.attrib1_id
				and a.attrib2_id = b.attrib2_id
				and a.attrib3_id = b.attrib3_id
				and coalesce(a.notes,'x') = coalesce(b.notes,'x')
				and coalesce(a.business_date,current_date) =  coalesce(b.business_date, current_date)
				and coalesce(a.x_attribute1_type, 'x') = coalesce(b.x_attribute1_type,'x')
				and coalesce(a.x_attribute1_value, 'x') = coalesce(b.x_attribute1_value,'x')
				and a.acct_id  in (vacct_id_sts, vacct_id_ste, vacct_id_stp, vacct_id_sms, vacct_id_smp,vacct_id_ebs);


-----------------------------------------------------------------------------------------------------------------------
			
			
   /* Start data load for Toto Sales and Draw Count by Draw Type in Fact Product'*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -23, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Sales by Draw Type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -23 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Draw Type'));

			
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -24, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Count by Draw Type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -24 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Count by Draw Type'));

	vacct_id_tsdt := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Draw Type');
	vacct_id_tcdt := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Count by Draw Type');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select    fdc.period_id as period_id
						, 0 as Entity_id
						, dp.product_id as Product_id
						, vacct_id_tsdt as acct_id
						, 0 as opening_amt
						, sum(fdc.value) * -1 activity_amt
						, 0 as Closing_amt
						, 0 as attrib1_id
						, 0 as attrib2_id
						, 0 as attrib3_id
						, case when to_char(fdc.business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end as notes
--						, fdc.business_date as business_date
				from qlik.fact_daily_collection fdc 
					inner Join qlik.dim_product dp on (fdc.product_cd = dp.product_cd)
					left outer join qlik.dim_toto_draw_type tdt on (fdc.attribute2 = tdt.draw_no)
				where 1=1	
				and fdc.product_cd  = 'TOTO'
--				and fdc.period_id = 202103
				and fdc.measure_nm in ('sales')
				group by fdc.period_id, dp.product_id, fdc.measure_nm
				, case when to_char(business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end
--				, fdc.business_date 
				
		union all
		select    fdc.period_id as period_id
						, 0 as Entity_id
						, dp.product_id as Product_id
						, vacct_id_tcdt as acct_id
						, 0 as opening_amt
						, count(distinct fdc.attribute2)  activity_amt
						, 0 as Closing_amt
						, 0 as attrib1_id
						, 0 as attrib2_id
						, 0 as attrib3_id
						, case when to_char(business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end as notes
--						, fdc.business_date as business_date
				from qlik.fact_daily_collection fdc 
					inner Join qlik.dim_product dp on (fdc.product_cd = dp.product_cd)
					left outer join qlik.dim_toto_draw_type tdt on (fdc.attribute2 = tdt.draw_no)
				where 1=1	
				and fdc.product_cd  = 'TOTO'
		--		and fdc.period_id = 202101
				and fdc.measure_nm in ('sales')
				group by fdc.period_id, dp.product_id, fdc.measure_nm
				, case when to_char(business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end
--				, fdc.business_date 
		;		
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_tsdt, vacct_id_tcdt);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product 
		select t1.period_id, t1.entity_id, t1.product_id, t1.acct_id
		, coalesce(t2.opening_amt,0) as opening_amt
		, coalesce(t2.activity_amt,0) as activity_amt
		, coalesce(t2.closing_amt,0) as closing_amt
		, t1.attrib1_id, t1.attrib2_id, t1.attrib3_id, t1.notes
		from 
			(select distinct b.period_id,entity_id,product_id,acct_id,attrib1_id,attrib2_id,attrib3_id,notes from 
			(select distinct t.period_id,entity_id,product_id,acct_id,attrib1_id,attrib2_id,attrib3_id,notes, p.fiscal_year
			from qlik.tmp_fact_product_dc t, qlik.dim_period p where t.period_id = p.period_id) a ,
			(select period_id, fiscal_year from qlik.dim_period dp2 where fiscal_year in (select distinct fiscal_year from qlik.dim_period dp 
							where period_id in (select period_id from qlik.tmp_fact_product_dc))) b
			where a.period_id <= b.period_id
			and a.fiscal_year = b.fiscal_year) t1
		left outer join qlik.tmp_fact_product_dc t2
		on (t1.period_id =  t2.period_id
			and t1.entity_id = t2.entity_id 
			and t1.product_id = t2.product_id
			and t1.acct_id = t2.acct_id
			and t1.attrib1_id = t2.attrib1_id
			and t1.attrib2_id = t2.attrib2_id
			and t1.attrib3_id = t2.attrib3_id
			and t1.notes = t2.notes);
		
	
	-- drop and create temp table for updating the opening and closing amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id, notes order by period_id),0) as opening_amt 
				, activity_amt
				, closing_amt
				, notes
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt , fp.notes
				, SUM(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year, fp.notes order by fp.period_id asc) as closing_amt
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_tsdt,vacct_id_tcdt)
				order by 1
				) SQ;
		
		-- update oepning and closing amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.notes = b.notes
				and a.acct_id in (vacct_id_tsdt, vacct_id_tcdt);

/* End of data load for Toto Sales and Draw Count by Draw Type in Fact Product'*/
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			
			
----------------------------------------------------------------------------------------------------------------------------------------------------------------			
			
	 /* Start data load for 'SWEEP Draw Results' in Fact Product for "Sweep - Draw Results" report*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -25, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Draw Results', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -25 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Draw Results'));
	
	vacct_id_sdr := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Draw Results');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
with get_period as 
			(
			select period_id from qlik.dim_period a ,
					(select  distinct p.fiscal_year from qlik.fact_daily_collection fdc, qlik.dim_period p where 1=1
							and fdc.period_id  = p.period_id
							and fdc.product_cd = 'SWEEP'
							and fdc.measure_nm like 'sweep winner%'
					) b
				where a.fiscal_year = b.fiscal_year
				and not exists (select 1 from qlik.fact_daily_collection fdc2 where fdc2.period_id = a.period_id 
											and fdc2.product_cd = 'SWEEP' and fdc2.measure_nm like 'sweep winner%')
			),
			dc_sweep_winner as
			(select    fdc.period_id as period_id
							, 0 as Entity_id
							, dp.product_id as Product_id
							, 0 as opening_amt
							, fdc.value as activity_amt
							, 0 as Closing_amt
							, case 
								when fdc.measure_nm = 'sweep winner 1' then (select attrib_id from qlik.dim_attribute da where attrib_cd = '1st Winner')
								when fdc.measure_nm = 'sweep winner 2' then (select attrib_id from qlik.dim_attribute da where attrib_cd = '2nd Winner')
								when fdc.measure_nm = 'sweep winner 3' then (select attrib_id from qlik.dim_attribute da where attrib_cd = '3rd Winner')
							  end as attrib1_id
							, 0 as attrib2_id
							, 0 as attrib3_id
							, case 
								when fdc.value = 0 then '0'
								when fdc.value = 1 then '1'
								else -1
							  end as notes
					from qlik.fact_daily_collection fdc , qlik.dim_product dp where 1=1
					and fdc.product_cd = dp.product_cd
					and fdc.product_cd = 'SWEEP'
					and fdc.measure_nm like 'sweep winner%'
			)
			select 
							  period_id , Entity_id	, Product_id
							, vacct_id_sdr as acct_id
							, opening_amt , activity_amt ,Closing_amt 
							, attrib1_id , attrib2_id , attrib3_id , notes
			from dc_sweep_winner gp
			union all
			-- to load rows for no draw months
			select gp.period_id , 0 as Entity_id, (select max(product_id) from qlik.dim_product dp where product_cd = 'SWEEP') Product_id
							, vacct_id_sdr as acct_id
							, 0 as opening_amt , -1 as activity_amt , -1 as Closing_amt 
							, a.attrib_id attrib1_id , 0 as attrib2_id , 0 as attrib3_id , '-1' notes
			from get_period gp
			full outer join (select attrib_id, attrib_cd from qlik.dim_attribute da2 where attrib_cd in ('1st Winner','2nd Winner','3rd Winner')) a
			on (1=1)
			order by 1;
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id = vacct_id_sdr;
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		
	--- Closing amount not required for this KPI	

	 /* End of data load for 'SWEEP Draw Results' in Fact Product for "Sweep - Draw Results" report*/
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

			
   /* Start data load for Toto Sales Trend in Fact Product'*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -56, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Sales Trend', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -56 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales Trend'));

			
	vacct_id_tst := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales Trend');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select    fdc.period_id as period_id
						, 0 as Entity_id
						, dp.product_id as Product_id
						, vacct_id_tst as acct_id
						, 0 as opening_amt
						, sum(fdc.value) * -1 as activity_amt
						, sum(fdc.value) * -1 as Closing_amt
						, 0 as attrib1_id
						, 0 as attrib2_id
						, 0 as attrib3_id
						, case when to_char(fdc.business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end as notes
						, fdc.business_date as business_date
				from qlik.fact_daily_collection fdc 
					inner Join qlik.dim_product dp on (fdc.product_cd = dp.product_cd)
					left outer join qlik.dim_toto_draw_type tdt on (fdc.attribute2 = tdt.draw_no)
				where 1=1	
				and fdc.product_cd  = 'TOTO'
--				and fdc.period_id = 202103
				and fdc.measure_nm in ('sales')
				group by fdc.period_id, dp.product_id, fdc.measure_nm
				, case when to_char(business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end
				, fdc.business_date ;

	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_tst);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		

 /* End data load for Toto Sales Trend in Fact Product'*/
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			


   /* 
    * Start data load for Toto Average Bet Size in Fact Product'
    * MTD only.. YTD not required as its for trend report
    * */
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -57, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Sales by Betsize', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -57 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Betsize'));

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -58, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Betcount', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -58 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Betcount'));

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -8, 'TOTO_Channel_Type', 'Retail', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-8);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -9, 'TOTO_Channel_Type', 'Remote', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-9);

		
	vacct_id_tsb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Betsize');
	vacct_id_tbc := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Betcount');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
			select 
			  fdc.period_id
			, 0 as entity_id
			, dp.product_id
			, case 
				when measure_nm = 'sales' then vacct_id_tsb
				when measure_nm = 'ticket count' then vacct_id_tbc
			  end as acct_id
			, 0 as opening_amt
			, sum(value) as activity_amt
			, sum(value) as closing_amt
			, case when fdc.attribute1 in ('Retailer', 'KRC', 'Branch','Livewire', 'OCB') 
				then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'TOTO_Channel_Type'
							and attrib_nm  = 'Retail' and attribute1 = 'FACT_PRODUCT')
				else (select attrib_id from qlik.dim_attribute da where attrib_cd = 'TOTO_Channel_Type'
							and attrib_nm  = 'Remote' and attribute1 = 'FACT_PRODUCT') end as attrib1_id
			, 0 as attrib2_id
			, 0 as attrib3_id
			, fdc.attribute2 as notes
			, fdc.business_date as business_date 
			, cast('Channel' as varchar)  as x_attribute1_type
			, fdc.attribute1 as x_attribute1_value
			from qlik.fact_daily_collection fdc , qlik.dim_product dp 
			where 1=1
			and fdc.product_cd = dp.product_cd
			and fdc.product_cd = 'TOTO'
--			and period_id = 202006
			and measure_nm in ('sales', 'ticket count')
			group by fdc.period_id , dp.product_id, measure_nm
			, fdc.attribute1 , fdc.attribute2 , fdc.business_date;

	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_tsb, vacct_id_tbc);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		

   /* End data load for Toto Average Bet Size in Fact Product'*/
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

   /* 
    * Start data load for SWEEP Sales by Betcount in Fact Product
    * MTD only.. YTD not required as its for trend report
    * */
	
   -- Insert manual dim account entry specific for this KPI

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -59, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Betcount', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -59 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Betcount'));

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -10, 'SWEEP_Channel_Type', 'Branch', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-10);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -11, 'SWEEP_Channel_Type', 'Consignee', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-11);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -12, 'SWEEP_Channel_Type', 'Retailer', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-12);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -13, 'SWEEP_Channel_Type', 'SWEEP Retailer', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-13);
		
	vacct_id_sbc := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Betcount');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
			select 
			  fdc.period_id
			, 0 as entity_id
			, dp.product_id
			, vacct_id_sbc acct_id
			, 0 as opening_amt
			, sum(value/3) as activity_amt
			, sum(value/3) as closing_amt
			, case 
				when fdc.attribute3 = '17' then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SWEEP_Channel_Type'
							and attrib_nm  = 'Consignee' and attribute1 = 'FACT_PRODUCT')
				when fdc.attribute3 = '16' then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SWEEP_Channel_Type'
							and attrib_nm  = 'SWEEP Retailer' and attribute1 = 'FACT_PRODUCT')
				when fdc.attribute1 = 'Retailer' then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SWEEP_Channel_Type'
							and attrib_nm  = 'Retailer' and attribute1 = 'FACT_PRODUCT')
				else (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SWEEP_Channel_Type'
							and attrib_nm  = 'Branch' and attribute1 = 'FACT_PRODUCT') end as attrib1_id
			, 0 as attrib2_id
			, 0 as attrib3_id
			, fdc.attribute2 as notes
			, fdc.business_date as business_date 
			, cast('Channel' as varchar) as x_attribute1_type
			, fdc.attribute1 as x_attribute1_value
			from qlik.fact_daily_collection fdc , qlik.dim_product dp 
			where 1=1
			and fdc.product_cd = dp.product_cd
			and fdc.product_cd = 'SWEEP'
--			and period_id = 202004
			and measure_nm in ('collection by draw')
			group by fdc.period_id , dp.product_id, measure_nm
			, fdc.attribute1 , fdc.attribute2 , fdc.business_date , fdc.attribute3 ;


	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_sbc);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		

   /* End data load for SWEEP Sales by Betcount in Fact Product */
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

----------------------------------------------------------------------------------------------------------------------------------------------------------------			

	 /* Start data load for Sports Sales, Payout and Event by bet type*/
	
   -- Insert manual dim account entry specific for KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -61, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Sales by bet type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -61 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Sales by bet type'));

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -62, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Payout by bet type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -62 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Payout by bet type'));

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -63, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Event by bet type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -63 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Event by bet type'));

			
	vacct_id_ssb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Sales by bet type');
	vacct_id_spb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Payout by bet type');
	vacct_id_seb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Event by bet type');

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
			select    
 				fdc.period_id as period_id
				, 0 as Entity_id
				, dp.product_id as Product_id
				, case 
					when fdc.measure_nm = 'sales by bet type' then vacct_id_ssb
					when fdc.measure_nm = 'event by bet type' then vacct_id_seb
					when fdc.measure_nm = 'payout by bet type' then vacct_id_spb
				  end as acct_id
				, 0 as opening_amt
				, Round(sum(fdc.value),2) * -1 as activity_amt
				, 0 as Closing_amt
				, 0 as attrib1_id
				, 0 as attrib2_id
				, 0 as attrib3_id
				, zwm.marketgroup as notes
		from qlik.fact_daily_collection fdc	
		left outer join qlik.dim_product dp on (fdc.product_cd = dp.product_cd or fdc.product_cd = dp.product_nm)
		left outer join public.ztall_weight_margin zwm on (upper(zwm.markets) 
																= upper(case when fdc.attribute1 like 'HTH - Team%' then 'HTH - Team'
				  												 when fdc.attribute1 like 'HTH - Driver%' then 'HTH - Driver'
				   												else fdc.attribute1 end))
		where 1=1
		and fdc.measure_nm in ('sales by bet type', 'event by bet type', 'payout by bet type')
		and fdc.product_cd not in ('4D','TOTO','SWEEP','HORSE RACING')
--		and fdc.period_id = 202104
		group by fdc.period_id, dp.product_id, fdc.measure_nm , zwm.marketgroup ;
	
		drop table if exists qlik.tmp_load_zero_closing;
	
		create table qlik.tmp_load_zero_closing as
			select distinct b.period_id , a.entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id, notes from 
			  (select distinct f.period_id, entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id, p.fiscal_year ,notes
			  		from qlik.tmp_fact_product_dc f, qlik.dim_period p
			  				where f.period_id = p.period_id) a
			, (select period_id, fiscal_year from qlik.dim_period  where period_id 
						between (select min(period_id) from qlik.tmp_fact_product_dc)
							and (select max(period_id) from qlik.tmp_fact_product_dc)
				) b 
			where a.period_id <= b.period_id and a.fiscal_year = b.fiscal_year;
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_ssb, vacct_id_spb, vacct_id_seb);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product 
--	select * from qlik.tmp_fact_product_dc;
		select a.period_id, a.entity_id, a.product_id, a.acct_id
			, coalesce(b.opening_amt,0) as opening_amt
			, coalesce(b.activity_amt,0) as activity_amt
			, coalesce(b.closing_amt,0) as closing_amt
			, a.attrib1_id, a.attrib2_id, a.attrib3_id, a.notes
			from qlik.tmp_load_zero_closing a
			left outer join qlik.tmp_fact_product_dc b
							on (	a.period_id 		= b.period_id
									and a.entity_id 	= b.entity_id
									and a.product_id	= b.product_id
									and a.acct_id 		= b.acct_id
									and a.attrib1_id 	= b.attrib1_id
									and a.attrib2_id 	= b.attrib2_id
									and a.attrib3_id 	= b.attrib3_id
									and a.notes			= b.notes
									);
		
	
	-- drop and create temp table for updating the opening and CLOSING amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
		
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id, product_id, notes order by product_id, period_id),0) as opening_amt 
				,  activity_amt
				, closing_amt
				, attrib1_id
				, attrib2_id
				, notes
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt 
				, sum(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year,fp.attrib1_id, fp.attrib2_id, notes  order by fp.product_id, fp.period_id asc) as closing_amt
				, fp.attrib1_id, fp.attrib2_id, notes
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_ssb, vacct_id_spb, vacct_id_seb)
--				and fp.acct_id  in (-21)
--				and product_id = 21
--				and dp.fiscal_year = 'FY20'
				) SQ
				order by  1, 2
				;
		
		-- update oepning and CLOSING amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.notes = b.notes
				and a.acct_id  in (vacct_id_ssb, vacct_id_spb, vacct_id_seb);


-----------------------------------------------------------------------------------------------------------------------

			
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

			
	 /* Start data load for Product Horse Racing KPIs*/
	
   -- Insert manual dim account entry specific for KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -64, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Collection', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -64 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Collection'));

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -65, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Events', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -65 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Events'));

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -66, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Collection by Channels', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -66 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Collection by Channels'));
			
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -67, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Sales Average', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -67 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales Average'));
	
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -68, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Sales Avg Budget', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -68
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales Avg Budget'));
	
			
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -149, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Event Average', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -149 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Event Average'));
	
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -150, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Event Avg Budget', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -150
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Event Avg Budget'));		
			
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -69, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Sales by Bet type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -69
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales by Bet type'));
	

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -148, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'no of account', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -148
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'no of account'));

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -14, 'HR_Channel', 'Online', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-14);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -15, 'HR_Channel', 'Offline', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-15);
			
	vacct_id_hrc  := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Collection');
	vacct_id_hre  := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Events');
	vacct_id_hrcc := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Collection by Channels');
	vacct_id_hrsa := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales Average');
	vacct_id_hrsb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales Avg Budget');
	vacct_id_hrbt := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales by Bet type');
	vacct_id_hrac := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'no of account');

	vacct_id_hrea := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Event Average');
	vacct_id_hreb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Event Avg Budget');


	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select 
			  fdc.period_id 
			, 0 as entity_id
			, (select product_id from qlik.dim_product dp where product_cd = 'HR') as product_id
			, case 
				when fdc.measure_nm = 'collection' then vacct_id_hrc
				when fdc.measure_nm = 'no of event' then vacct_id_hre
				when fdc.measure_nm = 'collection by channel' then vacct_id_hrcc
				when fdc.measure_nm = 'sales by bet type' then vacct_id_hrbt
				when fdc.measure_nm = 'no of account' then vacct_id_hrac
			  end as acct_id
			, 0 as opening_amt
			, sum(value) as activity_amt
			, 0 as closing_amt
			, coalesce(case when fdc.measure_nm = 'collection by channel' then
				case when fdc.attribute1 in ('Internet', 'Phone') 
						then (select attrib_id from qlik.dim_attribute where attrib_cd = 'HR_Channel' and attrib_nm = 'Online' and attribute1 = 'FACT_PRODUCT') 
						else (select attrib_id from qlik.dim_attribute where attrib_cd = 'HR_Channel' and attrib_nm = 'Offline' and attribute1 = 'FACT_PRODUCT')
			  end end , 0) as attrib1_id
			, 0 as attrib2_id
			, 0 as attrib3_id
			, cast(null as varchar) as notes
			, null as business_date
			, case 
				when fdc.measure_nm in ('collection','no of event', 'collection by channel','no of account') 
					then cast('Meeting Place' as varchar) 
				when fdc.measure_nm in ('sales by bet type') then cast('Bet Type' as varchar)
			  end as x_attribute1_type
			, case 
				when fdc.measure_nm in ('collection','no of event', 'sales by bet type') then fdc.attribute1 
				when fdc.measure_nm in ('collection by channel','no of account') then fdc.attribute3 
			  end as x_attribute1_value
			from qlik.fact_daily_collection fdc
			where 1=1
			and fdc.product_cd = 'HORSE RACING'
			and measure_nm in ('collection', 'no of event', 'collection by channel', 'sales by bet type','no of account')
--			and period_id = 202007
		--	and fdc.attribute1 = 'SINGAPORE'
			group by fdc.period_id, fdc.measure_nm
--			, fdc.attribute1, fdc.attribute3 
			, case 
				when fdc.measure_nm in ('collection','no of event', 'sales by bet type') then fdc.attribute1 
				when fdc.measure_nm in ('collection by channel','no of account') then fdc.attribute3 
			  end
			, coalesce(case when fdc.measure_nm = 'collection by channel' then
				case when fdc.attribute1 in ('Internet', 'Phone') 
						then (select attrib_id from qlik.dim_attribute where attrib_cd = 'HR_Channel' and attrib_nm = 'Online' and attribute1 = 'FACT_PRODUCT') 
						else (select attrib_id from qlik.dim_attribute where attrib_cd = 'HR_Channel' and attrib_nm = 'Offline' and attribute1 = 'FACT_PRODUCT')
			  end end , 0) 
		union all 
		select 
			  fdc.period_id 
			, 0 as entity_id
			, (select product_id from qlik.dim_product dp where product_cd = 'HR') as product_id
			, case 
				when fdc.measure_nm = 'collection' then vacct_id_hrsa
				when fdc.measure_nm = 'sales avg budget' then vacct_id_hrsb
				when fdc.measure_nm = 'no of event' then vacct_id_hrea
				when fdc.measure_nm = 'no of event budget' then vacct_id_hreb
			  end as acct_id
			, 0 as opening_amt
			, sum(value) as activity_amt
			, 0 as closing_amt
			, 0 as attrib1_id
			, 0 as attrib2_id
			, 0 as attrib3_id
			, cast(null as varchar) as notes
			, fdc.business_date as business_date
			, cast('Meeting Place' as varchar) as x_attribute1_type
			, fdc.attribute1 as x_attribute1_value
			from qlik.fact_daily_collection fdc
			where 1=1
			and fdc.product_cd = 'HORSE RACING'
			and measure_nm in ('sales avg budget','no of event budget','collection','no of event')
--			and period_id = 202010
--			and fdc.attribute1 in ('SELANGOR','PENANG','IPOH')
			group by fdc.period_id, fdc.attribute1, fdc.attribute3,fdc.business_date, fdc.measure_nm
			;
	
		drop table if exists qlik.tmp_load_zero_closing;
	
		create table qlik.tmp_load_zero_closing as
			select distinct b.period_id , a.entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id
					, notes
					, business_date
					, x_attribute1_type, x_attribute1_value from 
			  (select distinct f.period_id, entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id, p.fiscal_year 
			  			,notes
			  			, business_date
			  			, x_attribute1_type, x_attribute1_value
			  		from qlik.tmp_fact_product_dc f, qlik.dim_period p
			  				where f.period_id = p.period_id
			  				and f.acct_id in (vacct_id_hrc, vacct_id_hre, vacct_id_hrcc, vacct_id_hrbt,vacct_id_hrac)
			  				) a
			, (select period_id, fiscal_year from qlik.dim_period  where period_id 
						between (select min(period_id) from qlik.tmp_fact_product_dc)
							and (select max(period_id) from qlik.tmp_fact_product_dc)
				) b 
			where a.period_id <= b.period_id and a.fiscal_year = b.fiscal_year;
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id 
		in (vacct_id_hrc, vacct_id_hre, vacct_id_hrcc, vacct_id_hrsa, vacct_id_hrsb, vacct_id_hrbt, vacct_id_hrac,vacct_id_hrea,vacct_id_hreb);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product 
--	select * from qlik.tmp_fact_product_dc;
		select a.period_id, a.entity_id, a.product_id, a.acct_id
			, coalesce(b.opening_amt,0) as opening_amt
			, coalesce(b.activity_amt,0) as activity_amt
			, coalesce(b.closing_amt,0) as closing_amt
			, a.attrib1_id, a.attrib2_id, a.attrib3_id, a.notes
			, a.business_date, a.x_attribute1_type, a.x_attribute1_value
			from qlik.tmp_load_zero_closing a
			left outer join qlik.tmp_fact_product_dc b
							on (	a.period_id 			= b.period_id
									and a.entity_id 		= b.entity_id
									and a.product_id		= b.product_id
									and a.acct_id 			= b.acct_id
									and a.attrib1_id 		= b.attrib1_id
									and a.attrib2_id 		= b.attrib2_id
									and a.attrib3_id 		= b.attrib3_id
									and coalesce(a.notes,'x') = coalesce(b.notes,'x')
									and coalesce(to_char(a.business_date,'YYYYMMDD'),'x') =  coalesce(to_char(b.business_date,'YYYYMMDD'),'x')
--									and a.notes				= b.notes
--									and a.business_date 	= b.business_date
									and a.x_attribute1_type = b.x_attribute1_type
									and a.x_attribute1_value= b.x_attribute1_value
									)
			union all 
			select * from qlik.tmp_fact_product_dc t where t.acct_id in (vacct_id_hrsa, vacct_id_hrsb,vacct_id_hrea,vacct_id_hreb)
			;
		
	
	-- drop and create temp table for updating the opening and CLOSING amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
		
			select period_id, entity_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, entity_id ,acct_id, product_id
										, attrib1_id, attrib2_id, attrib3_id
										, notes , business_date, x_attribute1_type, x_attribute1_value
										order by period_id),0) as opening_amt 
				, activity_amt
				, closing_amt
				, attrib1_id, attrib2_id, attrib3_id
				, notes	, business_date, x_attribute1_type, x_attribute1_value
				from (
				select fp.period_id,fp.entity_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt 
				, fp.attrib1_id, fp.attrib2_id, fp.attrib3_id, fp.notes
				, fp.business_date, fp.x_attribute1_type, fp.x_attribute1_value
				, sum(fp.activity_amt) over(partition by dp.fiscaL_year, fp.entity_id, fp.product_id, fp.acct_id 
											, fp.attrib1_id, fp.attrib2_id , fp.attrib3_id
											, fp.notes, fp.business_date, fp.x_attribute1_type, fp.x_attribute1_value
											order by fp.period_id asc) as closing_amt
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_hrc, vacct_id_hre, vacct_id_hrcc, vacct_id_hrsa, vacct_id_hrsb, vacct_id_hrbt,vacct_id_hrac, vacct_id_hrea, vacct_id_hreb)
				) SQ
--				order by  1, 2
				;
		
		-- update opening and CLOSING amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.entity_id = b.entity_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.attrib1_id = b.attrib1_id
				and a.attrib2_id = b.attrib2_id
				and a.attrib3_id = b.attrib3_id
				and coalesce(a.notes,'x') = coalesce(b.notes,'x')
				and coalesce(a.business_date,current_date) =  coalesce(b.business_date, current_date)
				and coalesce(a.x_attribute1_type, 'x') = coalesce(b.x_attribute1_type,'x')
				and coalesce(a.x_attribute1_value, 'x') = coalesce(b.x_attribute1_value,'x')
				and a.acct_id  in (vacct_id_hrc, vacct_id_hre, vacct_id_hrcc, vacct_id_hrsa, vacct_id_hrsb, vacct_id_hrbt, vacct_id_hrac, vacct_id_hrea, vacct_id_hreb);

	/* End data load for Product Horse Racing KPIs*/
-----------------------------------------------------------------------------------------------------------------------
			
			

	analyse qlik.fact_product;
	
END;
$$;


ALTER FUNCTION qlik.sp_fact_product_load(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1217 (class 1255 OID 24895)
-- Name: sp_fact_product_load_bkp_20210730(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_product_load_bkp_20210730(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare

	vacct_id_arpd 			integer;
	vacct_id_tc			integer;
	vacct_id_sts			integer;
	vacct_id_ste			integer;
	vacct_id_pod			integer;	
	vacct_id_tsdt			integer;
	vacct_id_tcdt			integer;
	vacct_id_sdr			integer;
	vacct_id_tst			integer;
	vacct_id_tsb			integer;
	vacct_id_tbc			integer;
	vacct_id_sbc			integer;
	vacct_id_stp			integer;
	vacct_id_ssb			integer;
	vacct_id_spb			integer;
	vacct_id_seb			integer;
	vacct_id_hrc			integer;
	vacct_id_hre			integer;
	vacct_id_hrcc			integer;
	vacct_id_hrsa			integer;
	vacct_id_hrsb			integer;
	vacct_id_hrbt			integer;

BEGIN
    -- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

   
   /* Start data load for '4D Average Revenue per Draw in Fact Product'*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -18, '', '', '', 'FACT_PRODUCT', '4D', '', '','', '',  '4D Average Revenue per Draw', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -18 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Average Revenue per Draw'));
	

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -22, '', '', '', 'FACT_PRODUCT', '4D', '', '','', '',  '4D Payout Distribution', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -22
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Payout Distribution'));	
			
	vacct_id_arpd := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Average Revenue per Draw');
	vacct_id_pod := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= '4D' and acct_desc = '4D Payout Distribution');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
select    fdc.period_id as period_id
				, 0 as Entity_id
				, dp.product_id as Product_id
				, case 
					when fdc.measure_nm = 'sales' then vacct_id_arpd
					when fdc.measure_nm = 'payout' then vacct_id_pod
				  end as acct_id
				, 0 as opening_amt
				, sum(fdc.value) * -1 activity_amt
				, 0 as Closing_amt
				, 0 as attrib1_id
				, 0 as attrib2_id
				, 0 as attrib3_id
				, fdc.attribute2 as notes
				, fdc.business_date as business_date
		from qlik.fact_daily_collection fdc , qlik.dim_product dp where 1=1
		and fdc.product_cd = dp.product_cd
		and fdc.product_cd  = '4D'
--		and fdc.period_id = 202101
		and fdc.measure_nm in ('sales','payout')
		group by fdc.period_id, dp.product_id, fdc.measure_nm, fdc.attribute2
				, fdc.business_date;	
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_arpd, vacct_id_pod);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		
	
	-- drop and create temp table for updating the opening and closing amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id, notes order by period_id),0) as opening_amt 
				, activity_amt
				, closing_amt
				, notes
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt , fp.notes
				, SUM(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year, fp.notes order by fp.period_id asc) as closing_amt
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_arpd,vacct_id_pod)
				order by 1
				) SQ;
		
		-- update oepning and closing amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.notes = b.notes
				and a.acct_id in (vacct_id_arpd, vacct_id_pod);

	/* End of data load for '4D Average Revenue per Draw' in Fact Product*/
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			
			
	 /* Start data load for 'Total Collection' in Fact Product for "Sweep % Ticket Sold" report*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -19, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Total Collection', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -19 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Total Collection'));
	
	vacct_id_tc := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Total Collection');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
		select    fdc.period_id as period_id
				, 0 as Entity_id
				, dp.product_id as Product_id
				, vacct_id_tc as acct_id
				, 0 as opening_amt
				, Round(sum(fdc.value),2) *-1 as activity_amt
				, 0 as Closing_amt
				, 0 as attrib1_id
				, 0 as attrib2_id
				, 0 as attrib3_id
				, cast(null as varchar) as notes
		from qlik.fact_daily_collection fdc , qlik.dim_product dp where 1=1
		and fdc.product_cd = dp.product_cd
		and fdc.product_cd = 'SWEEP'
		--and fdc.period_id = 202001
		and fdc.measure_nm = 'collection by draw'
		group by fdc.period_id, dp.product_id;
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id = vacct_id_tc;
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		
	
	-- drop and create temp table for updating the opening and closing amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id order by period_id),0) as opening_amt 
				,  activity_amt
				, closing_amt
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt 
				, sum(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year order by fp.period_id asc) as closing_amt
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  = vacct_id_tc
				order by 1
				) SQ;
		
		-- update oepning and closing amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.acct_id = vacct_id_tc;

	 /* End of data load for 'Total Collection' in Fact Product for "Sweep % Ticket Sold" report*/	
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

	 /* Start data load for 'SPORTS - Average Revenue' and 'SPORTS Total Sales' in Fact Product for "Sports - Average revenue per event" report*/
	
   -- Insert manual dim account entry specific for Sports Total Sales
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -20, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Sales', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -20 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Sales'));

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -21, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Event', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -21 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Event'));

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -60, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Total Payout', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -60 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Payout'));

			
	vacct_id_ste := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Event');
	vacct_id_sts := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Sales');
	vacct_id_stp := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Total Payout');
--	v_product_id_sports = (select product_id from qlik.dim_product where product_cd = 'SPORTS' and product_nm= 'SPORTS' and product_lvl1 = 'SPORTS');

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select    
 				fdc.period_id as period_id
				, 0 as Entity_id
--				, v_product_id_sports as Product_id
				, dp.product_id as Product_id
				, case 
					when fdc.measure_nm = 'sales' then vacct_id_sts
					when fdc.measure_nm = 'no of event' then vacct_id_ste
					when fdc.measure_nm = 'payout' then vacct_id_stp
				  end as acct_id
				, 0 as opening_amt
				, Round(sum(fdc.value),2) * -1 as activity_amt
				, 0 as Closing_amt
				, coalesce( 
				  case 
					when right(dp.product_cd,1) = 'L' then  (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Live Betting')
					else (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Pre-Match')
--					when right(dp.product_cd,1) = 'S' then  (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'Sport Type' and attribute1 = 'Special')
				  end , 0 ) as attrib1_id
				, coalesce( 
				  case 
					when right(dp.product_cd,4) like 'W01%' then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'World Cup')
					when dp.product_cd in ('FBE03P', 'FBE03L', 'FBE03S') then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'European')
				  	else (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SPORTS' and attrib_nm = 'League Type' and attribute1 = 'Leagues') 
				  end, 0) as attrib2_id
				, 0 as attrib3_id
				, cast(null as varchar) as notes
		from (
				select fdc.period_id, fdc.business_date, coalesce(ztt.zt_product_cd, fdc.product_cd) as product_cd
				, fdc.measure_nm , fdc.attribute1, fdc.attribute2, fdc.attribute3,fdc.value
				, fdc.product_cd dc_prd_cd, zt_product_nm
				from qlik.fact_daily_collection fdc 
					left outer join  (select distinct sports_type || league_code zt_product_cd, league_name  as zt_product_nm
					from public.ztob_timetable ) ztt
					on (fdc.product_cd = ztt.zt_product_nm)	
				where 1=1
				and fdc.product_cd not in ('4D','TOTO','SWEEP','HORSE RACING')
			) fdc
				, qlik.dim_product dp where 1=1
		and (fdc.product_cd = dp.product_cd or fdc.product_cd = dp.product_nm)
		and fdc.measure_nm in ('sales', 'no of event', 'payout')
		and fdc.product_cd not in ('4D','TOTO','SWEEP','HORSE RACING')
--		and fdc.period_id = 201912
		group by fdc.period_id, dp.product_cd, dp.product_id, fdc.measure_nm ;
	
		drop table if exists qlik.tmp_load_zero_closing;
	
		create table qlik.tmp_load_zero_closing as
			select distinct b.period_id , a.entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id from 
			  (select distinct f.period_id, entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id, p.fiscal_year 
			  		from qlik.tmp_fact_product_dc f, qlik.dim_period p
			  				where f.period_id = p.period_id) a
			, (select period_id, fiscal_year from qlik.dim_period  where period_id 
						between (select min(period_id) from qlik.tmp_fact_product_dc)
							and (select max(period_id) from qlik.tmp_fact_product_dc)
				) b 
			where a.period_id <= b.period_id and a.fiscal_year = b.fiscal_year;
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_sts, vacct_id_ste, vacct_id_stp);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product 
--	select * from qlik.tmp_fact_product_dc;
		select a.period_id, a.entity_id, a.product_id, a.acct_id
			, coalesce(b.opening_amt,0) as opening_amt
			, coalesce(b.activity_amt,0) as activity_amt
			, coalesce(b.closing_amt,0) as closing_amt
			, a.attrib1_id, a.attrib2_id, a.attrib3_id
			from qlik.tmp_load_zero_closing a
			left outer join qlik.tmp_fact_product_dc b
							on (	a.period_id 		= b.period_id
									and a.entity_id 	= b.entity_id
									and a.product_id	= b.product_id
									and a.acct_id 		= b.acct_id
									and a.attrib1_id 	= b.attrib1_id
									and a.attrib2_id 	= b.attrib2_id
									and a.attrib3_id 	= b.attrib3_id
									);
		
	
	-- drop and create temp table for updating the opening and CLOSING amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
		
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id, product_id order by product_id, period_id),0) as opening_amt 
				,  activity_amt
				, closing_amt
				, attrib1_id
				, attrib2_id
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt 
				, sum(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year,fp.attrib1_id, fp.attrib2_id  order by fp.product_id, fp.period_id asc) as closing_amt
				, fp.attrib1_id, fp.attrib2_id
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_sts, vacct_id_ste, vacct_id_stp)
--				and fp.acct_id  in (-21)
--				and product_id = 21
--				and dp.fiscal_year = 'FY20'
				) SQ
				order by  1, 2
				;
		
		-- update oepning and CLOSING amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.acct_id  in (vacct_id_sts, vacct_id_ste, vacct_id_stp);


-----------------------------------------------------------------------------------------------------------------------
			
			
   /* Start data load for Toto Sales and Draw Count by Draw Type in Fact Product'*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -23, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Sales by Draw Type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -23 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Draw Type'));

			
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -24, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Count by Draw Type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -24 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Count by Draw Type'));

	vacct_id_tsdt := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Draw Type');
	vacct_id_tcdt := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Count by Draw Type');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select    fdc.period_id as period_id
						, 0 as Entity_id
						, dp.product_id as Product_id
						, vacct_id_tsdt as acct_id
						, 0 as opening_amt
						, sum(fdc.value) * -1 activity_amt
						, 0 as Closing_amt
						, 0 as attrib1_id
						, 0 as attrib2_id
						, 0 as attrib3_id
						, case when to_char(fdc.business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end as notes
--						, fdc.business_date as business_date
				from qlik.fact_daily_collection fdc 
					inner Join qlik.dim_product dp on (fdc.product_cd = dp.product_cd)
					left outer join qlik.dim_toto_draw_type tdt on (fdc.attribute2 = tdt.draw_no)
				where 1=1	
				and fdc.product_cd  = 'TOTO'
--				and fdc.period_id = 202103
				and fdc.measure_nm in ('sales')
				group by fdc.period_id, dp.product_id, fdc.measure_nm
				, case when to_char(business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end
--				, fdc.business_date 
				
		union all
		select    fdc.period_id as period_id
						, 0 as Entity_id
						, dp.product_id as Product_id
						, vacct_id_tcdt as acct_id
						, 0 as opening_amt
						, count(distinct fdc.attribute2)  activity_amt
						, 0 as Closing_amt
						, 0 as attrib1_id
						, 0 as attrib2_id
						, 0 as attrib3_id
						, case when to_char(business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end as notes
--						, fdc.business_date as business_date
				from qlik.fact_daily_collection fdc 
					inner Join qlik.dim_product dp on (fdc.product_cd = dp.product_cd)
					left outer join qlik.dim_toto_draw_type tdt on (fdc.attribute2 = tdt.draw_no)
				where 1=1	
				and fdc.product_cd  = 'TOTO'
		--		and fdc.period_id = 202101
				and fdc.measure_nm in ('sales')
				group by fdc.period_id, dp.product_id, fdc.measure_nm
				, case when to_char(business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end
--				, fdc.business_date 
		;		
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_tsdt, vacct_id_tcdt);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product 
		select t1.period_id, t1.entity_id, t1.product_id, t1.acct_id
		, coalesce(t2.opening_amt,0) as opening_amt
		, coalesce(t2.activity_amt,0) as activity_amt
		, coalesce(t2.closing_amt,0) as closing_amt
		, t1.attrib1_id, t1.attrib2_id, t1.attrib3_id, t1.notes
		from 
			(select distinct b.period_id,entity_id,product_id,acct_id,attrib1_id,attrib2_id,attrib3_id,notes from 
			(select distinct t.period_id,entity_id,product_id,acct_id,attrib1_id,attrib2_id,attrib3_id,notes, p.fiscal_year
			from qlik.tmp_fact_product_dc t, qlik.dim_period p where t.period_id = p.period_id) a ,
			(select period_id, fiscal_year from qlik.dim_period dp2 where fiscal_year in (select distinct fiscal_year from qlik.dim_period dp 
							where period_id in (select period_id from qlik.tmp_fact_product_dc))) b
			where a.period_id <= b.period_id
			and a.fiscal_year = b.fiscal_year) t1
		left outer join qlik.tmp_fact_product_dc t2
		on (t1.period_id =  t2.period_id
			and t1.entity_id = t2.entity_id 
			and t1.product_id = t2.product_id
			and t1.acct_id = t2.acct_id
			and t1.attrib1_id = t2.attrib1_id
			and t1.attrib2_id = t2.attrib2_id
			and t1.attrib3_id = t2.attrib3_id
			and t1.notes = t2.notes);
		
	
	-- drop and create temp table for updating the opening and closing amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id, notes order by period_id),0) as opening_amt 
				, activity_amt
				, closing_amt
				, notes
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt , fp.notes
				, SUM(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year, fp.notes order by fp.period_id asc) as closing_amt
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_tsdt,vacct_id_tcdt)
				order by 1
				) SQ;
		
		-- update oepning and closing amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.notes = b.notes
				and a.acct_id in (vacct_id_tsdt, vacct_id_tcdt);

/* End of data load for Toto Sales and Draw Count by Draw Type in Fact Product'*/
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			
			
----------------------------------------------------------------------------------------------------------------------------------------------------------------			
			
	 /* Start data load for 'SWEEP Draw Results' in Fact Product for "Sweep - Draw Results" report*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -25, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Draw Results', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -25 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Draw Results'));
	
	vacct_id_sdr := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Draw Results');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
with get_period as 
			(
			select period_id from qlik.dim_period a ,
					(select  distinct p.fiscal_year from qlik.fact_daily_collection fdc, qlik.dim_period p where 1=1
							and fdc.period_id  = p.period_id
							and fdc.product_cd = 'SWEEP'
							and fdc.measure_nm like 'sweep winner%'
					) b
				where a.fiscal_year = b.fiscal_year
				and not exists (select 1 from qlik.fact_daily_collection fdc2 where fdc2.period_id = a.period_id 
											and fdc2.product_cd = 'SWEEP' and fdc2.measure_nm like 'sweep winner%')
			),
			dc_sweep_winner as
			(select    fdc.period_id as period_id
							, 0 as Entity_id
							, dp.product_id as Product_id
							, 0 as opening_amt
							, fdc.value as activity_amt
							, 0 as Closing_amt
							, case 
								when fdc.measure_nm = 'sweep winner 1' then (select attrib_id from qlik.dim_attribute da where attrib_cd = '1st Winner')
								when fdc.measure_nm = 'sweep winner 2' then (select attrib_id from qlik.dim_attribute da where attrib_cd = '2nd Winner')
								when fdc.measure_nm = 'sweep winner 3' then (select attrib_id from qlik.dim_attribute da where attrib_cd = '3rd Winner')
							  end as attrib1_id
							, 0 as attrib2_id
							, 0 as attrib3_id
							, case 
								when fdc.value = 0 then '0'
								when fdc.value = 1 then '1'
								else -1
							  end as notes
					from qlik.fact_daily_collection fdc , qlik.dim_product dp where 1=1
					and fdc.product_cd = dp.product_cd
					and fdc.product_cd = 'SWEEP'
					and fdc.measure_nm like 'sweep winner%'
			)
			select 
							  period_id , Entity_id	, Product_id
							, vacct_id_sdr as acct_id
							, opening_amt , activity_amt ,Closing_amt 
							, attrib1_id , attrib2_id , attrib3_id , notes
			from dc_sweep_winner gp
			union all
			-- to load rows for no draw months
			select gp.period_id , 0 as Entity_id, (select max(product_id) from qlik.dim_product dp where product_cd = 'SWEEP') Product_id
							, vacct_id_sdr as acct_id
							, 0 as opening_amt , -1 as activity_amt , -1 as Closing_amt 
							, a.attrib_id attrib1_id , 0 as attrib2_id , 0 as attrib3_id , '-1' notes
			from get_period gp
			full outer join (select attrib_id, attrib_cd from qlik.dim_attribute da2 where attrib_cd in ('1st Winner','2nd Winner','3rd Winner')) a
			on (1=1)
			order by 1;
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id = vacct_id_sdr;
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		
	--- Closing amount not required for this KPI	

	 /* End of data load for 'SWEEP Draw Results' in Fact Product for "Sweep - Draw Results" report*/
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

			
   /* Start data load for Toto Sales Trend in Fact Product'*/
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -56, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Sales Trend', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -56 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales Trend'));

			
	vacct_id_tst := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales Trend');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select    fdc.period_id as period_id
						, 0 as Entity_id
						, dp.product_id as Product_id
						, vacct_id_tst as acct_id
						, 0 as opening_amt
						, sum(fdc.value) * -1 as activity_amt
						, sum(fdc.value) * -1 as Closing_amt
						, 0 as attrib1_id
						, 0 as attrib2_id
						, 0 as attrib3_id
						, case when to_char(fdc.business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end as notes
						, fdc.business_date as business_date
				from qlik.fact_daily_collection fdc 
					inner Join qlik.dim_product dp on (fdc.product_cd = dp.product_cd)
					left outer join qlik.dim_toto_draw_type tdt on (fdc.attribute2 = tdt.draw_no)
				where 1=1	
				and fdc.product_cd  = 'TOTO'
--				and fdc.period_id = 202103
				and fdc.measure_nm in ('sales')
				group by fdc.period_id, dp.product_id, fdc.measure_nm
				, case when to_char(business_date,'DY') = 'FRI' then 'Special' else tdt.draw_type end
				, fdc.business_date ;

	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_tst);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		

 /* End data load for Toto Sales Trend in Fact Product'*/
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			


   /* 
    * Start data load for Toto Average Bet Size in Fact Product'
    * MTD only.. YTD not required as its for trend report
    * */
	
   -- Insert manual dim account entry specific for this KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -57, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Sales by Betsize', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -57 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Betsize'));

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -58, '', '', '', 'FACT_PRODUCT', 'TOTO', '', '','', '',  'TOTO Betcount', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -58 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Betcount'));

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -8, 'TOTO_Channel_Type', 'Retail', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-8);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -9, 'TOTO_Channel_Type', 'Remote', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-9);

		
	vacct_id_tsb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Sales by Betsize');
	vacct_id_tbc := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'TOTO' and acct_desc = 'TOTO Betcount');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
			select 
			  fdc.period_id
			, 0 as entity_id
			, dp.product_id
			, case 
				when measure_nm = 'sales' then vacct_id_tsb
				when measure_nm = 'bet count' then vacct_id_tbc
			  end as acct_id
			, 0 as opening_amt
			, sum(value) as activity_amt
			, sum(value) as closing_amt
			, case when fdc.attribute1 in ('Retailer', 'KRC', 'Branch','Livewire', 'OCB') 
				then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'TOTO_Channel_Type'
							and attrib_nm  = 'Retail' and attribute1 = 'FACT_PRODUCT')
				else (select attrib_id from qlik.dim_attribute da where attrib_cd = 'TOTO_Channel_Type'
							and attrib_nm  = 'Remote' and attribute1 = 'FACT_PRODUCT') end as attrib1_id
			, 0 as attrib2_id
			, 0 as attrib3_id
			, fdc.attribute2 as notes
			, fdc.business_date as business_date 
			, cast('Channel' as varchar)  as x_attribute1_type
			, fdc.attribute1 as x_attribute1_value
			from qlik.fact_daily_collection fdc , qlik.dim_product dp 
			where 1=1
			and fdc.product_cd = dp.product_cd
			and fdc.product_cd = 'TOTO'
--			and period_id = 202006
			and measure_nm in ('sales', 'bet count')
			group by fdc.period_id , dp.product_id, measure_nm
			, fdc.attribute1 , fdc.attribute2 , fdc.business_date;

	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_tsb, vacct_id_tbc);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		

   /* End data load for Toto Average Bet Size in Fact Product'*/
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

   /* 
    * Start data load for SWEEP Sales by Betcount in Fact Product
    * MTD only.. YTD not required as its for trend report
    * */
	
   -- Insert manual dim account entry specific for this KPI

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -59, '', '', '', 'FACT_PRODUCT', 'SWEEP', '', '','', '',  'SWEEP Betcount', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -59 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Betcount'));

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -10, 'SWEEP_Channel_Type', 'Branch', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-10);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -11, 'SWEEP_Channel_Type', 'Consignee', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-11);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -12, 'SWEEP_Channel_Type', 'Retailer', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-12);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -13, 'SWEEP_Channel_Type', 'SWEEP Retailer', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-13);
		
	vacct_id_sbc := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SWEEP' and acct_desc = 'SWEEP Betcount');
	

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
			select 
			  fdc.period_id
			, 0 as entity_id
			, dp.product_id
			, vacct_id_sbc acct_id
			, 0 as opening_amt
			, sum(value) as activity_amt
			, sum(value) as closing_amt
			, case 
				when fdc.attribute3 = '17' then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SWEEP_Channel_Type'
							and attrib_nm  = 'Consignee' and attribute1 = 'FACT_PRODUCT')
				when fdc.attribute3 = '16' then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SWEEP_Channel_Type'
							and attrib_nm  = 'SWEEP Retailer' and attribute1 = 'FACT_PRODUCT')
				when fdc.attribute1 = 'Retailer' then (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SWEEP_Channel_Type'
							and attrib_nm  = 'Retailer' and attribute1 = 'FACT_PRODUCT')
				else (select attrib_id from qlik.dim_attribute da where attrib_cd = 'SWEEP_Channel_Type'
							and attrib_nm  = 'Branch' and attribute1 = 'FACT_PRODUCT') end as attrib1_id
			, 0 as attrib2_id
			, 0 as attrib3_id
			, fdc.attribute2 as notes
			, fdc.business_date as business_date 
			, cast('Channel' as varchar) as x_attribute1_type
			, fdc.attribute1 as x_attribute1_value
			from qlik.fact_daily_collection fdc , qlik.dim_product dp 
			where 1=1
			and fdc.product_cd = dp.product_cd
			and fdc.product_cd = 'SWEEP'
--			and period_id = 202004
			and measure_nm in ('bet count')
			group by fdc.period_id , dp.product_id, measure_nm
			, fdc.attribute1 , fdc.attribute2 , fdc.business_date , fdc.attribute3 ;


	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_sbc);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product select * from qlik.tmp_fact_product_dc;
		

   /* End data load for SWEEP Sales by Betcount in Fact Product */
  
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

----------------------------------------------------------------------------------------------------------------------------------------------------------------			

	 /* Start data load for Sports Sales, Payout and Event by bet type*/
	
   -- Insert manual dim account entry specific for KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -61, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Sales by bet type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -61 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Sales by bet type'));

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -62, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Payout by bet type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -62 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Payout by bet type'));

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -63, '', '', '', 'FACT_PRODUCT', 'SPORTS', '', '','', '',  'SPORTS Event by bet type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -63 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Event by bet type'));

			
	vacct_id_ssb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Sales by bet type');
	vacct_id_spb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Payout by bet type');
	vacct_id_seb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'SPORTS' and acct_desc = 'SPORTS Event by bet type');

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select    
 				fdc.period_id as period_id
				, 0 as Entity_id
--				, v_product_id_sports as Product_id
				, dp.product_id as Product_id
				, case 
					when fdc.measure_nm = 'sales by bet type' then vacct_id_ssb
					when fdc.measure_nm = 'event by bet type' then vacct_id_seb
					when fdc.measure_nm = 'payout by bet type' then vacct_id_spb
				  end as acct_id
				, 0 as opening_amt
				, Round(sum(fdc.value),2) * -1 as activity_amt
				, 0 as Closing_amt
				, 0 as attrib1_id
				, 0 as attrib2_id
				, 0 as attrib3_id
				, fdc.attribute1 as notes
		from (
				select fdc.period_id, fdc.business_date, coalesce(ztt.zt_product_cd, fdc.product_cd) as product_cd
				, fdc.measure_nm , fdc.attribute1, fdc.attribute2, fdc.attribute3,fdc.value
				, fdc.product_cd dc_prd_cd, zt_product_nm
				from qlik.fact_daily_collection fdc 
					left outer join  (select distinct sports_type || league_code zt_product_cd, league_name  as zt_product_nm
					from public.ztob_timetable ) ztt
					on (fdc.product_cd = ztt.zt_product_nm)	
				where 1=1
				and fdc.product_cd not in ('4D','TOTO','SWEEP','HORSE RACING')
			) fdc
				, qlik.dim_product dp where 1=1
		and (fdc.product_cd = dp.product_cd or fdc.product_cd = dp.product_nm)
		and fdc.measure_nm in ('sales by bet type', 'event by bet type', 'payout by bet type')
		and fdc.product_cd not in ('4D','TOTO','SWEEP','HORSE RACING')
--		and fdc.period_id = 201912
		group by fdc.period_id, dp.product_cd, dp.product_id, fdc.measure_nm, fdc.attribute1 ;
	
		drop table if exists qlik.tmp_load_zero_closing;
	
		create table qlik.tmp_load_zero_closing as
			select distinct b.period_id , a.entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id, notes from 
			  (select distinct f.period_id, entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id, p.fiscal_year ,notes
			  		from qlik.tmp_fact_product_dc f, qlik.dim_period p
			  				where f.period_id = p.period_id) a
			, (select period_id, fiscal_year from qlik.dim_period  where period_id 
						between (select min(period_id) from qlik.tmp_fact_product_dc)
							and (select max(period_id) from qlik.tmp_fact_product_dc)
				) b 
			where a.period_id <= b.period_id and a.fiscal_year = b.fiscal_year;
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_ssb, vacct_id_spb, vacct_id_seb);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product 
--	select * from qlik.tmp_fact_product_dc;
		select a.period_id, a.entity_id, a.product_id, a.acct_id
			, coalesce(b.opening_amt,0) as opening_amt
			, coalesce(b.activity_amt,0) as activity_amt
			, coalesce(b.closing_amt,0) as closing_amt
			, a.attrib1_id, a.attrib2_id, a.attrib3_id, a.notes
			from qlik.tmp_load_zero_closing a
			left outer join qlik.tmp_fact_product_dc b
							on (	a.period_id 		= b.period_id
									and a.entity_id 	= b.entity_id
									and a.product_id	= b.product_id
									and a.acct_id 		= b.acct_id
									and a.attrib1_id 	= b.attrib1_id
									and a.attrib2_id 	= b.attrib2_id
									and a.attrib3_id 	= b.attrib3_id
									and a.notes			= b.notes
									);
		
	
	-- drop and create temp table for updating the opening and CLOSING amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
		
			select period_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, acct_id, product_id, notes order by product_id, period_id),0) as opening_amt 
				,  activity_amt
				, closing_amt
				, attrib1_id
				, attrib2_id
				, notes
				from (
				select fp.period_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt 
				, sum(fp.activity_amt) over(partition by fp.product_id , fp.acct_id , dp.fiscaL_year,fp.attrib1_id, fp.attrib2_id, notes  order by fp.product_id, fp.period_id asc) as closing_amt
				, fp.attrib1_id, fp.attrib2_id, notes
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_ssb, vacct_id_spb, vacct_id_seb)
--				and fp.acct_id  in (-21)
--				and product_id = 21
--				and dp.fiscal_year = 'FY20'
				) SQ
				order by  1, 2
				;
		
		-- update oepning and CLOSING amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.notes = b.notes
				and a.acct_id  in (vacct_id_ssb, vacct_id_spb, vacct_id_seb);


-----------------------------------------------------------------------------------------------------------------------

			
----------------------------------------------------------------------------------------------------------------------------------------------------------------			

			
	 /* Start data load for Product Horse Racing KPIs*/
	
   -- Insert manual dim account entry specific for KPI
   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -64, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Collection', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -64 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Collection'));

	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -65, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Events', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -65 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Events'));

   INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -66, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Collection by Channels', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -66 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Collection by Channels'));
			
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -67, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Sales Average', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -67 
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales Average'));
	
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -68, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Sales Avg Budget', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -68
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales Avg Budget'));
			
	INSERT INTO qlik.dim_account(
			    acct_id, acct_fr, acct_to, acct_type, acct_lvl1, acct_lvl2, acct_lvl3, 
			    acct_lvl4, acct_lvl5, acct_lvl6, acct_desc, attribute1, attribute2)
		SELECT -69, '', '', '', 'FACT_PRODUCT', 'HR', '', '','', '',  'HR Sales by Bet type', '', ''
		WHERE NOT EXISTS (SELECT 1 FROM qlik.dim_account where acct_id = -69
				or (acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales by Bet type'));
			
	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -14, 'HR_Channel', 'Online', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-14);

	insert into qlik.dim_attribute (attrib_id, attrib_cd, attrib_nm, attribute1)
		select -15, 'HR_Channel', 'Offline', 'FACT_PRODUCT' where not exists (select 1 from qlik.dim_attribute where attrib_id =-15);
			
	vacct_id_hrc  := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Collection');
	vacct_id_hre  := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Events');
	vacct_id_hrcc := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Collection by Channels');
	vacct_id_hrsa := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales Average');
	vacct_id_hrsb := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales Avg Budget');
	vacct_id_hrbt := (select acct_id from qlik.dim_account da where acct_lvl1 = 'FACT_PRODUCT' and acct_lvl2= 'HR' and acct_desc = 'HR Sales by Bet type');

	-- Drop and create temporary table to store data for this KPI from daily collection
	drop table if exists qlik.tmp_fact_product_dc;

	create table qlik.tmp_fact_product_dc as
	
		select 
			  fdc.period_id 
			, 0 as entity_id
			, (select product_id from qlik.dim_product dp where product_cd = 'HR') as product_id
			, case 
				when fdc.measure_nm = 'collection' then vacct_id_hrc
				when fdc.measure_nm = 'no of event' then vacct_id_hre
				when fdc.measure_nm = 'collection by channel' then vacct_id_hrcc
				when fdc.measure_nm = 'sales avg budget' then vacct_id_hrsb
				when fdc.measure_nm = 'curr yr sales avg' then vacct_id_hrsa
				when fdc.measure_nm = 'sales by bet type' then vacct_id_hrbt
			  end as acct_id
			, 0 as opening_amt
			, sum(value) as activity_amt
			, 0 as closing_amt
			, coalesce(case when fdc.measure_nm = 'collection by channel' then
				case when fdc.attribute1 in ('Internet', 'Phone') 
						then (select attrib_id from qlik.dim_attribute where attrib_cd = 'HR_Channel' and attrib_nm = 'Online' and attribute1 = 'FACT_PRODUCT') 
						else (select attrib_id from qlik.dim_attribute where attrib_cd = 'HR_Channel' and attrib_nm = 'Offline' and attribute1 = 'FACT_PRODUCT')
			  end end , 0) as attrib1_id
			, 0 as attrib2_id
			, 0 as attrib3_id
			, cast(null as varchar) as notes
			, fdc.business_date as business_date
			, case 
				when fdc.measure_nm in ('collection','no of event','sales avg budget', 'curr yr sales avg','collection by channel') 
					then cast('Meeting Place' as varchar) 
				when fdc.measure_nm in ('sales by bet type') then cast('Bet Type' as varchar)
			  end as x_attribute1_type
			, case 
				when fdc.measure_nm in ('collection','no of event','sales avg budget', 'curr yr sales avg','sales by bet type') then fdc.attribute1 
				when fdc.measure_nm in ('collection by channel') then fdc.attribute3 
			  end as x_attribute1_value
			from qlik.fact_daily_collection fdc
			where 1=1
			and fdc.product_cd = 'HORSE RACING'
			and measure_nm in ('collection', 'no of event', 'collection by channel','sales avg budget', 'curr yr sales avg','sales by bet type')
--			and period_id = 202007
		--	and fdc.attribute1 = 'SINGAPORE'
			group by fdc.period_id, fdc.business_date, fdc.attribute1, fdc.measure_nm, fdc.attribute3 ;
	
		drop table if exists qlik.tmp_load_zero_closing;
	
		create table qlik.tmp_load_zero_closing as
			select distinct b.period_id , a.entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id
					, notes, business_date, x_attribute1_type, x_attribute1_value from 
			  (select distinct f.period_id, entity_id,product_id,acct_id, attrib1_id,attrib2_id,attrib3_id, p.fiscal_year 
			  			,notes, business_date, x_attribute1_type, x_attribute1_value
			  		from qlik.tmp_fact_product_dc f, qlik.dim_period p
			  				where f.period_id = p.period_id) a
			, (select period_id, fiscal_year from qlik.dim_period  where period_id 
						between (select min(period_id) from qlik.tmp_fact_product_dc)
							and (select max(period_id) from qlik.tmp_fact_product_dc)
				) b 
			where a.period_id <= b.period_id and a.fiscal_year = b.fiscal_year;
	
	
	-- Delete data from fact product before loading		
	delete from qlik.fact_product where acct_id in (vacct_id_hrc, vacct_id_hre, vacct_id_hrcc, vacct_id_hrsa, vacct_id_hrsb, vacct_id_hrbt);
	
	-- Insert data into fact product from temp table
	insert into qlik.fact_product 
--	select * from qlik.tmp_fact_product_dc;
		select a.period_id, a.entity_id, a.product_id, a.acct_id
			, coalesce(b.opening_amt,0) as opening_amt
			, coalesce(b.activity_amt,0) as activity_amt
			, coalesce(b.closing_amt,0) as closing_amt
			, a.attrib1_id, a.attrib2_id, a.attrib3_id, a.notes
			, a.business_date, a.x_attribute1_type, a.x_attribute1_value
			from qlik.tmp_load_zero_closing a
			left outer join qlik.tmp_fact_product_dc b
							on (	a.period_id 			= b.period_id
									and a.entity_id 		= b.entity_id
									and a.product_id		= b.product_id
									and a.acct_id 			= b.acct_id
									and a.attrib1_id 		= b.attrib1_id
									and a.attrib2_id 		= b.attrib2_id
									and a.attrib3_id 		= b.attrib3_id
									and coalesce(a.notes,'x') = coalesce(b.notes,'x')
									and coalesce(to_char(a.business_date,'YYYYMMDD'),'x') =  coalesce(to_char(b.business_date,'YYYYMMDD'),'x')
--									and a.notes				= b.notes
--									and a.business_date 	= b.business_date
									and a.x_attribute1_type = b.x_attribute1_type
									and a.x_attribute1_value= b.x_attribute1_value
									);
		
	
	-- drop and create temp table for updating the opening and CLOSING amount for this KPI
	drop table if exists qlik.tmp_fact_product_closing;

		create table qlik.tmp_fact_product_closing as
		
			select period_id, entity_id, product_id , acct_id 
				, coalesce(lag(closing_amt,1) over(partition by fiscal_year, entity_id ,acct_id, product_id
										, attrib1_id, attrib2_id, attrib3_id
										, notes , business_date, x_attribute1_type, x_attribute1_value
										order by period_id),0) as opening_amt 
				,  activity_amt
				, closing_amt
				, attrib1_id, attrib2_id, attrib3_id
				, notes	, business_date, x_attribute1_type, x_attribute1_value
				from (
				select fp.period_id,fp.entity_id, fp.product_id , fp.acct_id , dp.fiscaL_year, fp.activity_amt 
				, fp.attrib1_id, fp.attrib2_id, fp.attrib3_id, fp.notes
				, fp.business_date, fp.x_attribute1_type, fp.x_attribute1_value
				, sum(fp.activity_amt) over(partition by dp.fiscaL_year, fp.entity_id, fp.product_id, fp.acct_id 
											, fp.attrib1_id, fp.attrib2_id , fp.attrib3_id
											, fp.notes, fp.business_date, fp.x_attribute1_type, fp.x_attribute1_value
											order by fp.period_id asc) as closing_amt
				from qlik.fact_product fp , qlik.dim_period dp where 1=1
				and fp.period_id = dp.period_id
				and fp.acct_id  in (vacct_id_hrc, vacct_id_hre, vacct_id_hrcc, vacct_id_hrsa, vacct_id_hrsb, vacct_id_hrbt)
				) SQ
--				order by  1, 2
				;
		
		-- update oepning and CLOSING amount in fact product for this KPI
		update qlik.fact_product a set opening_amt = b.opening_amt , closing_amt = b.closing_amt
				from qlik.tmp_fact_product_closing b 
				where a.period_id = b.period_id
				and a.entity_id = b.entity_id
				and a.product_id = b.product_id
				and a.acct_id = b.acct_id
				and a.attrib1_id = b.attrib1_id
				and a.attrib2_id = b.attrib2_id
				and a.attrib3_id = b.attrib3_id
				and coalesce(a.notes,'x') = coalesce(b.notes,'x')
				and a.business_date =  b.business_date
				and coalesce(a.x_attribute1_type, 'x') = coalesce(b.x_attribute1_type,'x')
				and coalesce(a.x_attribute1_value, 'x') = coalesce(b.x_attribute1_value,'x')
				and a.acct_id  in (vacct_id_hrc, vacct_id_hre, vacct_id_hrcc, vacct_id_hrsa, vacct_id_hrsb, vacct_id_hrbt);

	/* End data load for Product Horse Racing KPIs*/
-----------------------------------------------------------------------------------------------------------------------
			
			

	analyse qlik.fact_product;
	
END;
$$;


ALTER FUNCTION qlik.sp_fact_product_load_bkp_20210730(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1219 (class 1255 OID 24898)
-- Name: sp_fact_rnc(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_fact_rnc(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vPeriod_Id integer:= (select cast(coalesce(vparperiod) as integer));

begin
	
	-- commented on 27-May-2022 since autocommit is deprecated in PG11
    --set autocommit = on;

-- Clean up before inserting
delete from qlik.fact_rnc --select * from qlik.fact_rnc 
where period_id = vPeriod_Id
and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 ='RNC');

analyze qlik.fact_rnc;

-- Inserting into fact_rnc table
insert into
	qlik.fact_rnc ( period_id , entity_id , acct_id , attrib1_id , attrib1_nm , value , remarks ,div_cd, div_nm)
select 
	a.period, 
	case when c.entity_id is null then 0 else c.entity_id end as entity_id,
	case when b.acct_id is null then 0 else b.acct_id end as acct_id,
	0 as attrib1_id,
	a.attribute1 as attrib1_nm, 
	sum(a.value) as value, 
	a.remarks as remarks,
	a.costcentercd as div_cd,
	a.costcenternm as div_nm 
from qlik.stg_rnc a
left join (select acct_id, acct_lvl2 from qlik.dim_account where acct_lvl1 = 'RNC') b on a.measure = b.acct_lvl2
left join (select entity_id, entity_cd from qlik.dim_entity) c on a.costcentercd = c.entity_cd
where a.period = vPeriod_Id 
group by a.period, entity_id, acct_id, a.attribute1, a.remarks,  a.costcentercd, a.costcenternm
;

analyze qlik.fact_rnc;


--clean up -- 

end;

$$;


ALTER FUNCTION qlik.sp_fact_rnc(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1181 (class 1255 OID 24899)
-- Name: sp_insert_missing_product(); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_insert_missing_product() RETURNS void
    LANGUAGE plpgsql
    AS $$
declare

 

c_get_data cursor for
     select distinct
--        (select max(product_id)+1 from qlik.dim_product) as product_id,
         0 as product_id,
         sports_type || league_code as product_cd
        , league_name as product_nm
        , 'SPORTS' as product_lvl1
        , null as product_lvl2
        , null as attribute1
        , 'Manual Insert' as attribute2
        from public.ztob_timetable zt 
        where 1=1
        and sports_type = 'ST'
        and sports_type || league_code not in (select product_cd from qlik.dim_product);

 

vseq_id integer;
rec qlik.dim_product%rowtype;    
    
Begin    

 

vseq_id := (select max(product_id)+1 from qlik.dim_product) ;
    
open c_get_data ;
        loop
            fetch c_get_data into rec;
                exit when not found;
            
                insert into qlik.dim_product 
                    (product_id,product_cd,product_nm,product_lvl1,product_lvl2,attribute1,attribute2)
                values    (vseq_id, rec.product_cd, rec.product_nm, rec.product_lvl1, rec.product_lvl2,rec.attribute1,rec.attribute2);
                
                vseq_id := vseq_id+1;
            
        end loop;
    close c_get_data;    
    

 

END;
$$;


ALTER FUNCTION qlik.sp_insert_missing_product() OWNER TO sp_postgres;

--
-- TOC entry 1182 (class 1255 OID 24900)
-- Name: sp_load_betting_new(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_load_betting_new(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
                vperiod_id integer:= (select cast(vparperiod as integer));
                vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
                vperiodplus1_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) + interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN

     /*create temporary fact table*/
     DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

                CREATE TABLE IF NOT EXISTS qlik.tmp_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf;

/*Extract ES Lottery data for 1 month*/
                CREATE TABLE qlik.tmp_ztes_mjf as
                select a.tratyp,a.serial,a.cdc,a.journaladdress,lpad(cast(a.traagt as varchar),6,'0') as traagt,e.business_date,a.prod,z.draws_draw,y.bettyp,y.salesamt0,y.salesamt1,c.productname
                from ztes_mjf_journals a
                inner join ztes_mjf_draws z on a.cdc = z.cdc AND a.journaladdress = z.journaladdress
                inner join ztes_mjf_brdinf y on a.cdc = y.cdc AND a.journaladdress = y.journaladdress
                inner join ztes_esrm_outlet b on a.traagt = b.outlet_id
                inner join ztall_product c on a.prod = cast(c.product as int)
                inner join (
                select distinct cast(to_char(business_date,'YYYYMM') as integer) as period_id,business_date,productnum,drawnumber from ztes_pdf_winnbr a
                inner join ztall_businessday b on b.system='ES' and a.drawcdc = b.business_id
                where cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id
                ) e on e.productnum = a.prod and e.drawnumber = z.draws_draw
                where a.tratyp in (1,2) and e.period_id = vPeriod_Id and b.outlet_name <> 'POOLZCONNECT' and b.outlet_business_desc <> 'Telebetting'
                and c.productname in ('4D','SWEEP','TOTO') 
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf_toto_4d;

                CREATE TABLE qlik.tmp_ztes_mjf_toto_4d as
                select *
                from qlik.tmp_ztes_mjf
                where productname in ('4D','TOTO') 
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf_sweep;

                CREATE TABLE qlik.tmp_ztes_mjf_sweep as
                select *
                from qlik.tmp_ztes_mjf
                where productname in ('SWEEP') and (salesamt0 + salesamt1) <> 0
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztob_lottery;

/*Extract OB Lottery data for 1 month*/
                CREATE TABLE qlik.tmp_ztob_lottery as
                select draw_date_d,betslip_id,product_id,channel,upper(bet_name) as bet_name,sales_amount as sales
                from ztob_lottery a
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id and a.ob_status = 'A'
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability;

/*Extract Sport Retail data*/
                CREATE TABLE qlik.tmp_ztmm2_liability as
                select betslipid,leaguecode,upper(bettype) as bettype,settledate,legstatus,retailerid,upper(marketname) as marketname,salesamt,winamt
                from ztmm2_liability a
                where cast(to_char(a.settledate,'YYYYMM') as integer) in (vprevperid_id,vperiod_id,vperiodplus1_id) and a.legstatus in ('L','W')
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztob_sportbetssettled;

/*Extract Sport Online data*/
                CREATE TABLE qlik.tmp_ztob_sportbetssettled as
                select bet_id,account_no,leg_status,last_settled_date_d,upper(bet_type) as bet_type,match_id,upper(market_name) as market_name,settled_sales,settled_returns,channel,place_terminal_code
                from ztob_sportbetssettled a
                where channel <> 'R' and leg_status in ('L','W') and cast(to_char(a.last_settled_date_d,'YYYYMM') as integer) in (vprevperid_id,vperiod_id,vperiodplus1_id)
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability2;

/*Further Transformation from SPORT RETAILER Data*/
                CREATE TABLE qlik.tmp_ztmm2_liability2 as
                select a.betslipid,a.leaguecode,a.bettype,a.settledate,a.legstatus,a.retailerid,a.marketname,a.salesamt,a.winamt,case when b.betslipid is not null then vPeriod_Id else case when a.bettype = 'S' then cast(to_char(a.settledate,'YYYYMM') as integer) else 190001 end end as settlement_period,coalesce(h.entity_id,0) as entity_id
                from qlik.tmp_ztmm2_liability a
                left join (
                select betslipid from qlik.tmp_ztmm2_liability
                where bettype <> 'S' and cast(to_char(settledate,'YYYYMM') as integer) >= vPeriod_Id
                group by betslipid
                having max(cast(to_char(settledate,'YYYYMM') as integer)) = vPeriod_Id
                ) b on a.betslipid = b.betslipid
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012')  h on a.retailerid = h.entity_cd and a.settledate between h.effective_from and h.effective_to
                ;
                analyze qlik.tmp_ztmm2_liability2;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_wager;

/*Get The correct settlement date for SPORT RETAILER Data*/
                CREATE TABLE qlik.tmp_ztmm2_wager as
                select 
                                a.betslipid,
                                cast(to_char(c.settledate,'YYYYMM') as integer) as settlement_period
                from ztmm2_wager a
                inner join (
                select betslipid from qlik.tmp_ztmm2_liability2
                where bettype <> 'S'
                group by betslipid
                having max(case bettype when 'D' then 2 when 'T' then 3 when '4F' then 4 end) <> count(*)
                ) b on a.betslipid = b.betslipid
                inner join ztmm2_timetable c on c.matchcode = a.matchcode
                ;
/*Get The max settlement date by betid for SPORT RETAILER Data*/
                DROP TABLE IF EXISTS qlik.tmp_ztmm2_wager1;

                CREATE TABLE qlik.tmp_ztmm2_wager1 as
                select 
                                a.betslipid,
                                max(settlement_period) as settlement_period
                from qlik.tmp_ztmm2_wager a
                group by a.betslipid
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability1;

/*populate the final tranformation to temporary table*/
                CREATE TABLE qlik.tmp_ztmm2_liability1 as
                select a.betslipid,a.leaguecode,a.bettype,a.settledate,a.legstatus,a.retailerid,a.marketname,a.salesamt,a.winamt,case when b.betslipid is not null then b.settlement_period else a.settlement_period end as settlement_period, a.entity_id 
                from qlik.tmp_ztmm2_liability2 a 
                left join qlik.tmp_ztmm2_wager1 b on a.betslipid = b.betslipid
                ;

                analyze qlik.tmp_ztmm2_liability1;

                delete from qlik.tmp_ztmm2_liability1 where settlement_period <> vPeriod_Id;
                
                analyze qlik.tmp_ztmm2_liability1;

                DROP TABLE IF EXISTS qlik.tmp_ztob_sportbetssettled1;

/*tranformation to temporary table for SPORT ONLINE*/
                CREATE TABLE qlik.tmp_ztob_sportbetssettled1 as
                select cast(a.bet_id as varchar) as bet_id,a.account_no,a.leg_status,a.last_settled_date_d,a.bet_type,a.match_id,a.market_name,a.settled_sales,a.settled_returns,a.channel,case when x.bet_id is not null then vPeriod_Id else case when a.bet_type = 'SGL' then cast(to_char(last_settled_date_d,'YYYYMM') as integer) else 190001 end end as settlement_period,trim(b.sports_type) || trim(b.league_code) as leaguecode,coalesce(coalesce(c.entity_id,h.entity_id),0) as entity_id
                from qlik.tmp_ztob_sportbetssettled a
                left join (
                                select bet_id,max(last_settled_date_d) as max_last_settled_date_d from qlik.tmp_ztob_sportbetssettled
                                where bet_type <> 'SGL' and cast(to_char(last_settled_date_d,'YYYYMM') as integer) >= vPeriod_Id
                                group by bet_id
                                having max(cast(to_char(last_settled_date_d,'YYYYMM') as integer)) = vPeriod_Id
                ) x on a.bet_id = x.bet_id
                inner join ztob_timetable b on a.match_id = b.match_id
                left join (
                                select entity_id,channel from qlik.dim_entity d
                                inner join (select channel,case when (description='Phone') then 'Telebetting' else description end as description 
                                from ztob_channels where channeltype = 'Online') c on d.entity_nm like '%'|| c.description ||'%'
                ) c on c.channel = a.channel
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012')  h on left(a.place_terminal_code,6) = h.entity_cd and (case when x.bet_id is not null then x.max_last_settled_date_d else (case when a.bet_type = 'SGL' then last_settled_date_d else to_date('1900-01-01','YYYY-MM-DD') end) end) between h.effective_from and h.effective_to
                ;
                
                delete from qlik.tmp_ztob_sportbetssettled1 where settlement_period <> vPeriod_Id;
                
                analyze qlik.tmp_ztob_sportbetssettled1;
                

    /*Betting System Data MTD*/

                /*load Lottery Number Of Transaction/Bet Slip from retail/ES data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,1 as attrib_id,sum(case when a.tratyp = 1 then 1 else -1 end) as no_of_transaction,0 as attrib1_id
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial,sum(0) as tempfield
                from qlik.tmp_ztes_mjf_toto_4d a
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                group by h.entity_id,g.product_id, a.tratyp,a.serial
                ) a
                group by period_id,coalesce(entity_id,0),product_id;

                
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,1 as attrib_id,sum(case when a.tratyp = 1 then 1 else -1 end) as no_of_transaction,0 as attrib1_id
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial
                from qlik.tmp_ztes_mjf_sweep a
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                               left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                ) a
                group by period_id,coalesce(entity_id,0),product_id
                ;

                /*load Lottery Number Of Transaction/Bet Slip from OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                /*Lottery No Of Transactionon by betslip from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,998 as acct_id,1 as attrib_id,count(*),0 from (
                select  b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id, sum(0) as tempfield
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                left join qlik.dim_entity d on d.entity_nm like '%'|| case when (c.description='Phone') then 'Telebetting' else c.description end ||'%'
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer),d.entity_id,g.product_id,c.description,betslip_id
                ) a
                group by period_id,coalesce(entity_id,0),product_id;

                /*load SPORTS Number Of Transaction/Bet Slip from retail/MM2 & OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,h.attrib_id as attrib_id,count(*) as no_of_transaction ,0
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,a.leaguecode as product_cd,a.bettype,sum(0) as tempfield
                from qlik.tmp_ztmm2_liability1 a
                where a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,a.leaguecode,a.bettype
                union all
               select a.bet_id,a.entity_id,vPeriod_Id,a.leaguecode,a.bet_type,sum(0) as tempfield
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,h.attrib_id ;

/*load LOTTERY Number Of Transaction/Bet Slip by BET TYPE from ES data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,986 as acct_id,attrib_id,sum(nbrbrds) as no_of_transaction ,0
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, case when a.tratyp = 1 then 1 else -1 end as nbrbrds,a.serial,f.attrib_id
                from qlik.tmp_ztes_mjf a
                inner join (select attrib_id,attrib_cd,attrib_nm,case when attrib_nm like '4D%' then '4D' else 'TOTO' end as attribute5 from qlik.dim_attribute where attrib_nm like '4D%' or attrib_nm like 'TOTO%') f on f.attrib_cd = cast(a.bettyp as varchar) and f.attribute5 = a.productname 
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load LOTTERY Number Of Transaction/Bet Slip By BET TYPE from OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                /*Lottery No Of Transactionon by bettype from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,986 as acct_id,attrib_id,count(*),0 from (
                select  b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id,f.attrib_id,bet_name,sum(0) as tempfield
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.bet_name 
                left join qlik.dim_entity d on d.entity_nm like '%'|| case when c.description = 'Phone' then 'Telebetting' else c.description end ||'%'
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) ,d.entity_id,g.product_id,c.description,betslip_id,f.attrib_id,bet_name
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;
                

                /*load SPORTS Number Of Transaction/Bet Slip by BET TYPE from retail/MM2 & OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,986 as acct_id,f.attrib_id as attrib_id,count(*) as no_of_transaction ,h.attrib_id
                from 
                (
                select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,
                marketname,sum(salesamt) as sales,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_sales)as sales,a.bet_type
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,
                market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                /*load Lottery sales amount by BET TYPE from ES data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,985 as acct_id,attrib_id,sum(case when a.tratyp = 1 then salesamt else -1 * salesamt end) as sales_by_bettype ,0
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial,f.attrib_id,sum(a.salesamt0 + a.salesamt1)/100 as salesamt
                from qlik.tmp_ztes_mjf a
                inner join (select attrib_id,attrib_cd,attrib_nm,case when attrib_nm like '4D%' then '4D' else 'TOTO' end as attribute5 from qlik.dim_attribute where attrib_nm like '4D%' or attrib_nm like 'TOTO%') f on f.attrib_cd = cast(a.bettyp as varchar) and f.attribute5 = a.productname 
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                group by h.entity_id,g.product_id, a.tratyp,a.serial,f.attrib_id
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load Lottery sales amount by BET TYPE from OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                /*lottery sales by bettype from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,985 as acct_id,attrib_id,sum(sales) as sales_by_bettype,0 from (
                select b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id,f.attrib_id,bet_name,sum(a.sales) as sales 
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.bet_name 
                left join qlik.dim_entity d on d.entity_nm like '%'|| c.description ||'%'
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer),d.entity_id,g.product_id,c.description,betslip_id,f.attrib_id,bet_name
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load SPORTS sales amount by BET TYPE from MM2& OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,985 as acct_id,f.attrib_id as attrib_id,sum(sales) as salesamt ,h.attrib_id
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,marketname,sum(salesamt) as sales,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_sales)as sales,a.bet_type 
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                /*load SPORTS winning amount by BET TYPE from MM2& OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,984 as acct_id,f.attrib_id as attrib_id,sum(winamt) as winamt ,h.attrib_id
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,marketname,sum(winamt) as winamt,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id and a.legstatus = 'W'
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_returns)as sales,a.bet_type 
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id and leg_status = 'W'
                group by a.bet_id,a.entity_id,a.leaguecode,market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                /*LOTTERY No Of Draw*/
                select 
                                a.period_id,0 as entity_id,b.product_id,0 as cust_id,995 as acct_id,1 as attrib_id,no_of_draw as no_of_draw ,0 as attribute_1
                from
                (select cast(period_id as integer) as period_id,productname,count(*) as no_of_draw from (
                select distinct c.productname,drawnumber,to_char(business_date,'YYYYMM') as period_id from ztes_pdf_winnbr a
                inner join (select business_date,business_id from ztall_businessday where system = 'ES' and cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id) b on a.drawcdc = b.business_id
                inner join (select cast(product as integer) as product,productname from ztall_product where producttype = 'Lottery' and productname <> 'SWEEP') c on a.productnum = c.product
                ) a
                group by cast(period_id as integer),productname) a
                inner join qlik.dim_product b on a.productname = b.product_cd

                union all
/*Customer Registration & Activations*/
                select vPeriod_Id,0 as entity_id,0 as product_id,0 as cust_id,982 as acct_id,1 as attrib_id,sum(current_count) as no_of_draw ,0 as attribute_1 from ( 
                SELECT
                case when cast(to_char(activation_date,'YYYYMM') as integer) = vPeriod_Id then 1 else 0 end as current_count,
                case when cast(to_char(activation_date,'YYYYMM') as integer) <= vPeriod_Id then 1 else 0 end as total_count
                FROM ztob_customer
                where status = 'A' and activation_date is not null and cast(to_char(activation_date,'YYYYMM') as integer) = vPeriod_Id) a
                having coalesce(sum(current_count),0) <> 0
                union all
                select vPeriod_Id,0 as entity_id,0 as product_id,0 as cust_id,983 as acct_id,1 as attrib_id,count(*) as no_of_draw ,0 as attribute_1 
                from ztob_customer
                where status = 'A' and cast(to_char(creation_date,'YYYYMM') as integer) = vPeriod_Id
                having coalesce(count(*),0) <> 0

                union all
/*Sweep 1st 2nd 3rd Winner*/
                select cast(to_char(x.business_date,'YYYYMM') as integer) as period_id,0 as entity_id,b.product_id,0 as cust_id,988 as acct_id,c.attrib_id,a.shrcount,0 as attribute_1
                from ztes_pdf_winshares a
                inner join qlik.dim_product b on b.product_cd = 'SWEEP'
                left join (select * from ztall_businessday where system = 'ES') x on x.business_id = a.drawcdc
                inner join qlik.dim_attribute c on c.attrib_id in (297,298,299) and cast(c.attribute1 as integer) = a.windiv_id
                where a.productname = 'swep' and a.windiv_id in (1,2,3) and cast(to_char(x.business_date,'YYYYMM') as integer) = vPeriod_Id

                union all

                select a.period_id,a.entity_id,a.product_id,a.cust_id,a.acct_id,a.value_type,a.activity_amt,a.attrib1_id
                from qlik.hist_fact_gl_balance a
                where a.acct_id = 988 and a.period_id = vPeriod_Id
                
                union all
/*TOTO Jackpot Amount*/
                SELECT d.period_id, 0 as entity_id, c.product_id,0 as cust_id, 987 as acct_id,rank() over (partition by d.period_id order by d.period_id,c.product_id,a.drawnumber) + 70 as attrib_id,a.pollforallocation/100,0 as attribute_1
                FROM ztes_pdf_winshares a
                inner join (select cast(product as integer) as productnum,productname from ztall_product
                where productname = 'TOTO') b on a.productnum = b.productnum
                left join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
                inner join qlik.dim_product c on c.product_cd = b.productname
                inner join qlik.dim_period d on d.period_id = cast(to_char(x.business_date,'YYYYMM') as integer)
                where windiv_id = 1 and d.period_id = vPeriod_Id

                union all
/*4D Payout Distribution*/
                SELECT a.period_id, 0 as entity_id, a.product_id,0 as cust_id, 996 as acct_id,a.attrib_id as attrib_id,(payout_amt/sales_amt) as payout_dist,0 as attribute_1
                from
                (select c.period_id,d.product_id,cast(coalesce(trim(a.draw_number),'0') as integer) as drawnumber,sum(a.total_value_controlling) * -1 as sales_amt,
                rank() over (partition by c.period_id order by c.period_id,d.product_id,cast(coalesce(trim(a.draw_number),'0') as integer)) + 70 as attrib_id
                from ztsapfi_copa a
                inner join qlik.dim_account b on b.acct_fr = right(a.cost_element,7) 
                inner join qlik.dim_period c on c.fiscal_year_period = a.fiscal_year_period
                inner join qlik.dim_product d on d.product_cd = a.material
                where company_code = '2000' and acct_lvl5 = 'Sales' and material = '4D' and value_type = 10 and a.total_value_controlling < 0
                and coalesce(trim(a.draw_number),'0') not in ('0','') and c.period_id = vPeriod_Id
                group by c.period_id,cast(coalesce(trim(a.draw_number),'0') as integer),d.product_id) a
                inner join 
                (SELECT d.period_id,a.drawnumber,c.product_id,sum(a.totalamount/100) as payout_amt  FROM ztes_pdf_winshares a
                inner join (select cast(product as integer) as productnum,productname from ztall_product
                                where productname = '4D') b on a.productnum = b.productnum
                left join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
                inner join qlik.dim_product c on c.product_cd = b.productname
                inner join qlik.dim_period d on d.period_id = cast(to_char(x.business_date,'YYYYMM') as integer)
                where d.period_id = vPeriod_Id
                group by d.period_id,a.drawnumber,c.product_id) b on a.period_id = b.period_id and a.product_id = b.product_id and a.drawnumber = b.drawnumber
                ;

                /*Remove Data For Reload*/
                delete from qlik.fact_gl_balance where period_id >= vPeriod_Id and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 = 'OT' and acct_desc not in ('FTE','Headcount') and acct_id <> 989);

                analyze qlik.fact_gl_balance;
                
                /*Insert into Fact table*/
                DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
                
                CREATE TABLE qlik.stg_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );
                
                /*Insert into Fact table*/
                insert into qlik.stg_fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),attrib1_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
                                   ,a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id not in (988,987,996,989)
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null 
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
                                   ,a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and b.acct_id not in (988,987,996,989) and c.acct_desc not in ('FTE','Headcount')
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
                                   ,a.attrib1_id
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vPeriod_Id and a.attrib1_id = b.attrib1_id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and a.acct_id not in (988,987,996,989) and c.acct_desc not in ('FTE','Headcount')
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and  c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id not in (988,987,996,989)
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id in (988,987,996)
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
                having sum(opening_amt) + sum(activity_amt) + sum(closing_amt) <> 0;

                
                insert into qlik.fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select * from qlik.stg_fact_gl_balance;

                analyze qlik.fact_gl_balance;
                                
END;
$$;


ALTER FUNCTION qlik.sp_load_betting_new(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1183 (class 1255 OID 24903)
-- Name: sp_load_betting_system(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_load_betting_system(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
                vperiod_id integer:= (select cast(vparperiod as integer));
                vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
                vperiodplus1_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) + interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN

     /*create temporary fact table*/
     DROP TABLE IF EXISTS qlik.tmp_fact_product;

                CREATE TABLE IF NOT EXISTS qlik.tmp_fact_product
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,                 
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer,
                  attrib2_id integer,
                  attrib3_id integer
                );

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf;

/*Extract ES Lottery data for 1 month*/
                CREATE TABLE qlik.tmp_ztes_mjf as
                select a.tratyp,a.serial,a.cdc,a.journaladdress,lpad(cast(a.traagt as varchar),6,'0') as traagt,e.business_date,a.prod,z.draws_draw,y.bettyp,y.salesamt0,y.salesamt1,c.productname
                from ztes_mjf_journals a
                inner join ztes_mjf_draws z on a.cdc = z.cdc AND a.journaladdress = z.journaladdress
                inner join ztes_mjf_brdinf y on a.cdc = y.cdc AND a.journaladdress = y.journaladdress
                inner join ztes_esrm_outlet b on a.traagt = b.outlet_id
                inner join ztall_product c on a.prod = cast(c.product as int)
                inner join (
                select distinct cast(to_char(business_date,'YYYYMM') as integer) as period_id,business_date,productnum,drawnumber from ztes_pdf_winnbr a
                inner join ztall_businessday b on b.system='ES' and a.drawcdc = b.business_id
                where cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id
                ) e on e.productnum = a.prod and e.drawnumber = z.draws_draw
                where a.tratyp in (1,2) and e.period_id = vPeriod_Id and b.outlet_name <> 'POOLZCONNECT' and b.outlet_business_desc <> 'Telebetting'
                and c.productname in ('4D','SWEEP','TOTO') 
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf_toto_4d;

                CREATE TABLE qlik.tmp_ztes_mjf_toto_4d as
                select *
                from qlik.tmp_ztes_mjf
                where productname in ('4D','TOTO') 
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf_sweep;

                CREATE TABLE qlik.tmp_ztes_mjf_sweep as
                select *
                from qlik.tmp_ztes_mjf
                where productname in ('SWEEP') and (salesamt0 + salesamt1) <> 0
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztob_lottery;

/*Extract OB Lottery data for 1 month*/
                CREATE TABLE qlik.tmp_ztob_lottery as
                select draw_date_d,betslip_id,product_id,channel,upper(bet_name) as bet_name,sales_amount as sales
                from ztob_lottery a
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id and a.ob_status = 'A'
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability;

/*Extract Sport Retail data*/
                CREATE TABLE qlik.tmp_ztmm2_liability as
                select betslipid,leaguecode,upper(bettype) as bettype,settledate,legstatus,retailerid,upper(marketname) as marketname,salesamt,winamt
                from ztmm2_liability a
                where cast(to_char(a.settledate,'YYYYMM') as integer) in (vprevperid_id,vperiod_id,vperiodplus1_id) and a.legstatus in ('L','W')
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztob_sportbetssettled;

/*Extract Sport Online data*/
                CREATE TABLE qlik.tmp_ztob_sportbetssettled as
                select bet_id,account_no,leg_status,last_settled_date_d,upper(bet_type) as bet_type,match_id,upper(market_name) as market_name,settled_sales,settled_returns,channel,place_terminal_code
                from ztob_sportbetssettled a
                where channel <> 'R' and leg_status in ('L','W') and cast(to_char(a.last_settled_date_d,'YYYYMM') as integer) in (vprevperid_id,vperiod_id,vperiodplus1_id)
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability2;

/*Further Transformation from SPORT RETAILER Data*/
                CREATE TABLE qlik.tmp_ztmm2_liability2 as
                select a.betslipid,a.leaguecode,a.bettype,a.settledate,a.legstatus,a.retailerid,a.marketname,a.salesamt,a.winamt,case when b.betslipid is not null then vPeriod_Id else case when a.bettype = 'S' then cast(to_char(a.settledate,'YYYYMM') as integer) else 190001 end end as settlement_period,coalesce(h.entity_id,0) as entity_id
                from qlik.tmp_ztmm2_liability a
                left join (
                select betslipid from qlik.tmp_ztmm2_liability
                where bettype <> 'S' and cast(to_char(settledate,'YYYYMM') as integer) >= vPeriod_Id
                group by betslipid
                having max(cast(to_char(settledate,'YYYYMM') as integer)) = vPeriod_Id
                ) b on a.betslipid = b.betslipid
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-
				' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012')  h on a.retailerid = h.entity_cd and a.settledate between h.effective_from and h.effective_to
                ;
                analyze qlik.tmp_ztmm2_liability2;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_wager;

/*Get The correct settlement date for SPORT RETAILER Data*/
                CREATE TABLE qlik.tmp_ztmm2_wager as
                select 
                                a.betslipid,
                                cast(to_char(c.settledate,'YYYYMM') as integer) as settlement_period
                from ztmm2_wager a
                inner join (
                select betslipid from qlik.tmp_ztmm2_liability2
                where bettype <> 'S'
                group by betslipid
                having max(case bettype when 'D' then 2 when 'T' then 3 when '4F' then 4 end) <> count(*)
                ) b on a.betslipid = b.betslipid
                inner join ztmm2_timetable c on c.matchcode = a.matchcode
                ;
/*Get The max settlement date by betid for SPORT RETAILER Data*/
                DROP TABLE IF EXISTS qlik.tmp_ztmm2_wager1;

                CREATE TABLE qlik.tmp_ztmm2_wager1 as
                select 
                                a.betslipid,
                                max(settlement_period) as settlement_period
                from qlik.tmp_ztmm2_wager a
                group by a.betslipid
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability1;

/*populate the final tranformation to temporary table*/
                CREATE TABLE qlik.tmp_ztmm2_liability1 as
                select a.betslipid,a.leaguecode,a.bettype,a.settledate,a.legstatus,a.retailerid,a.marketname,a.salesamt,a.winamt,case when b.betslipid is not null then b.settlement_period else a.settlement_period end as settlement_period, a.entity_id 
                from qlik.tmp_ztmm2_liability2 a 
                left join qlik.tmp_ztmm2_wager1 b on a.betslipid = b.betslipid
                ;

                analyze qlik.tmp_ztmm2_liability1;

                delete from qlik.tmp_ztmm2_liability1 where settlement_period <> vPeriod_Id;
                
                analyze qlik.tmp_ztmm2_liability1;

                DROP TABLE IF EXISTS qlik.tmp_ztob_sportbetssettled1;

/*tranformation to temporary table for SPORT ONLINE*/
                CREATE TABLE qlik.tmp_ztob_sportbetssettled1 as
                select cast(a.bet_id as varchar) as bet_id,a.account_no,a.leg_status,a.last_settled_date_d,a.bet_type,a.match_id,a.market_name,a.settled_sales,a.settled_returns,a.channel,case when x.bet_id is not null then vPeriod_Id else case when a.bet_type = 'SGL' then cast(to_char(last_settled_date_d,'YYYYMM') as integer) else 190001 end end as settlement_period,trim(b.sports_type) || trim(b.league_code) as leaguecode,coalesce(coalesce(c.entity_id,h.entity_id),0) as entity_id
                from qlik.tmp_ztob_sportbetssettled a
                left join (
                                select bet_id,max(last_settled_date_d) as max_last_settled_date_d from qlik.tmp_ztob_sportbetssettled
                                where bet_type <> 'SGL' and cast(to_char(last_settled_date_d,'YYYYMM') as integer) >= vPeriod_Id
                                group by bet_id
                                having max(cast(to_char(last_settled_date_d,'YYYYMM') as integer)) = vPeriod_Id
                ) x on a.bet_id = x.bet_id
                inner join ztob_timetable b on a.match_id = b.match_id
                left join (
                                select entity_id,channel from qlik.dim_entity d
                                inner join (select channel,case when (description='Phone') then 'Telebetting' else description end as description 
                                from ztob_channels where channeltype = 'Online') c on d.entity_nm like '%'|| c.description ||'%'
                ) c on c.channel = a.channel
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012')  h on left(a.place_terminal_code,6) = h.entity_cd and (case when x.bet_id is not null then x.max_last_settled_date_d else (case when a.bet_type = 'SGL' then last_settled_date_d else to_date('1900-01-01','YYYY-MM-DD') end) end) between h.effective_from and h.effective_to
                ;
                
                delete from qlik.tmp_ztob_sportbetssettled1 where settlement_period <> vPeriod_Id;
                
                analyze qlik.tmp_ztob_sportbetssettled1;
                

    /*Betting System Data MTD*/

                /*load Lottery Number Of Transaction/Bet Slip from retail/ES data */
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,sum(case when a.tratyp = 1 then 1 else -1 end) as no_of_transaction,0 as attrib1_id, 1 as attrib2_id, 0 as attrib3_id
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial,sum(0) as tempfield
                from qlik.tmp_ztes_mjf_toto_4d a
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                group by h.entity_id,g.product_id, a.tratyp,a.serial
                ) a
                group by period_id,coalesce(entity_id,0),product_id;

                
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,sum(case when a.tratyp = 1 then 1 else -1 end) as no_of_transaction,0 as attrib1_id,1 as attrib2_id, 0 as attrib3_id
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial
                from qlik.tmp_ztes_mjf_sweep a
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                               left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                ) a
                group by period_id,coalesce(entity_id,0),product_id
                ;

                /*load Lottery Number Of Transaction/Bet Slip from OB data */
                 insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                /*Lottery No Of Transactionon by betslip from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,998 as acct_id,count(*),0,1,0 from (
                select  b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id, sum(0) as tempfield
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                left join qlik.dim_entity d on d.entity_nm like '%'|| case when (c.description='Phone') then 'Telebetting' else c.description end ||'%'
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer),d.entity_id,g.product_id,c.description,betslip_id
                ) a
                group by period_id,coalesce(entity_id,0),product_id;

                /*load SPORTS Number Of Transaction/Bet Slip from retail/MM2 & OB data */
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,count(*) as no_of_transaction ,0,h.attrib_id as attrib2_id,0
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,a.leaguecode as product_cd,a.bettype,sum(0) as tempfield
                from qlik.tmp_ztmm2_liability1 a
                where a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,a.leaguecode,a.bettype
                union all
               select a.bet_id,a.entity_id,vPeriod_Id,a.leaguecode,a.bet_type,sum(0) as tempfield
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,h.attrib_id ;

/*load LOTTERY Number Of Transaction/Bet Slip by BET TYPE from ES data */
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,986 as acct_id,sum(nbrbrds) as no_of_transaction ,0,attrib_id as attrib2_id, 0
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, case when a.tratyp = 1 then 1 else -1 end as nbrbrds,a.serial,f.attrib_id
                from qlik.tmp_ztes_mjf a
                inner join (select attrib_id,attrib_cd,attrib_nm,case when attrib_nm like '4D%' then '4D' else 'TOTO' end as attribute5 from qlik.dim_attribute where attrib_nm like '4D%' or attrib_nm like 'TOTO%') f on f.attrib_cd = cast(a.bettyp as varchar) and f.attribute5 = a.productname 
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load LOTTERY Number Of Transaction/Bet Slip By BET TYPE from OB data */
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                /*Lottery No Of Transactionon by bettype from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,986 as acct_id,count(*),0,attrib_id as attrib2_id, 0 from (
                select  b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id,f.attrib_id,bet_name,sum(0) as tempfield
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.bet_name 
                left join qlik.dim_entity d on d.entity_nm like '%'|| case when c.description = 'Phone' then 'Telebetting' else c.description end ||'%'
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) ,d.entity_id,g.product_id,c.description,betslip_id,f.attrib_id,bet_name
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;
                

                /*load SPORTS Number Of Transaction/Bet Slip by BET TYPE from retail/MM2 & OB data */
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,986 as acct_id,count(*) as no_of_transaction ,h.attrib_id as attrib1_id,f.attrib_id as attrib2_id, 0
                from 
                (
                select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,
                marketname,sum(salesamt) as sales,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_sales)as sales,a.bet_type
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,
                market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                /*load Lottery sales amount by BET TYPE from ES data */
               insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,985 as acct_id,sum(case when a.tratyp = 1 then salesamt else -1 * salesamt end) as sales_by_bettype ,0 ,attrib_id as attrib2_id, 0
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial,f.attrib_id,sum(a.salesamt0 + a.salesamt1)/100 as salesamt
                from qlik.tmp_ztes_mjf a
                inner join (select attrib_id,attrib_cd,attrib_nm,case when attrib_nm like '4D%' then '4D' else 'TOTO' end as attribute5 from qlik.dim_attribute where attrib_nm like '4D%' or attrib_nm like 'TOTO%') f on f.attrib_cd = cast(a.bettyp as varchar) and f.attribute5 = a.productname 
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                group by h.entity_id,g.product_id, a.tratyp,a.serial,f.attrib_id
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load Lottery sales amount by BET TYPE from OB data */
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                /*lottery sales by bettype from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,985 as acct_id,sum(sales) as sales_by_bettype,0,attrib_id as attrib2_id, 0 from (
                select b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id,f.attrib_id,bet_name,sum(a.sales) as sales 
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.bet_name 
                left join qlik.dim_entity d on d.entity_nm like '%'|| c.description ||'%'
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer),d.entity_id,g.product_id,c.description,betslip_id,f.attrib_id,bet_name
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load SPORTS sales amount by BET TYPE from MM2& OB data */
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,985 as acct_id,sum(sales) as salesamt ,h.attrib_id as attrib1_id,f.attrib_id as attrib2_id, 0
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,marketname,sum(salesamt) as sales,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_sales)as sales,a.bet_type 
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                /*load SPORTS winning amount by BET TYPE from MM2& OB data */
                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,984 as acct_id,sum(winamt) as winamt ,h.attrib_id as attrib1_id,f.attrib_id as attrib2_id, 0
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,marketname,sum(winamt) as winamt,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id and a.legstatus = 'W'
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_returns)as sales,a.bet_type 
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id and leg_status = 'W'
                group by a.bet_id,a.entity_id,a.leaguecode,market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                insert into qlik.tmp_fact_product (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,                  
                  activity_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                /*LOTTERY No Of Draw*/
                select 
                                a.period_id,0 as entity_id,b.product_id,0 as cust_id,995 as acct_id,no_of_draw as no_of_draw ,0 as attrib1_id,1 as attrib2_id, 0
                from
                (select cast(period_id as integer) as period_id,productname,count(*) as no_of_draw from (
                select distinct c.productname,drawnumber,to_char(business_date,'YYYYMM') as period_id from ztes_pdf_winnbr a
                inner join (select business_date,business_id from ztall_businessday where system = 'ES' and cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id) b on a.drawcdc = b.business_id
                inner join (select cast(product as integer) as product,productname from ztall_product where producttype = 'Lottery' and productname <> 'SWEEP') c on a.productnum = c.product
                ) a
                group by cast(period_id as integer),productname) a
                inner join qlik.dim_product b on a.productname = b.product_cd

                union all
/*Customer Registration & Activations*/
                select vPeriod_Id,0 as entity_id,0 as product_id,0 as cust_id,982 as acct_id,sum(current_count) as no_of_draw ,0 as attrib1_id,1 as attrib2_id, 0 from ( 
                SELECT
                case when cast(to_char(activation_date,'YYYYMM') as integer) = vPeriod_Id then 1 else 0 end as current_count,
                case when cast(to_char(activation_date,'YYYYMM') as integer) <= vPeriod_Id then 1 else 0 end as total_count
                FROM ztob_customer
                where status = 'A' and activation_date is not null and cast(to_char(activation_date,'YYYYMM') as integer) = vPeriod_Id) a
                having coalesce(sum(current_count),0) <> 0
                union all
                select vPeriod_Id,0 as entity_id,0 as product_id,0 as cust_id,983 as acct_id,count(*) as no_of_draw ,0 as attrib2_id, 1 as attrib2_id, 0 as attrib3_id
                from ztob_customer
                where status = 'A' and cast(to_char(creation_date,'YYYYMM') as integer) = vPeriod_Id
                having coalesce(count(*),0) <> 0

                union all
/*Sweep 1st 2nd 3rd Winner*/
                select cast(to_char(x.business_date,'YYYYMM') as integer) as period_id,0 as entity_id,b.product_id,0 as cust_id,988 as acct_id,a.shrcount ,0 as attrib1_id,c.attrib_id as attrib2_id, 0
                from ztes_pdf_winshares a
                inner join qlik.dim_product b on b.product_cd = 'SWEEP'
                left join (select * from ztall_businessday where system = 'ES') x on x.business_id = a.drawcdc
                inner join qlik.dim_attribute c on c.attrib_id in (297,298,299) and cast(c.attribute1 as integer) = a.windiv_id
                where a.productname = 'swep' and a.windiv_id in (1,2,3) and cast(to_char(x.business_date,'YYYYMM') as integer) = vPeriod_Id

                union all

                select a.period_id,a.entity_id,a.product_id,a.cust_id,a.acct_id, a.activity_amt,a.attrib1_id,a.value_type as attrib2_id, 0
                from qlik.hist_fact_gl_balance a
                where a.acct_id = 988 and a.period_id = vPeriod_Id
                
                union all
/*TOTO Jackpot Amount*/
                SELECT d.period_id, 0 as entity_id, c.product_id,0 as cust_id, 987 as acct_id,a.pollforallocation/100,0 as attrib1_id, rank() over (partition by d.period_id order by d.period_id,c.product_id,a.drawnumber) + 70 as attrib2_id, 0
                FROM ztes_pdf_winshares a
                inner join (select cast(product as integer) as productnum,productname from ztall_product
                where productname = 'TOTO') b on a.productnum = b.productnum
                left join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
                inner join qlik.dim_product c on c.product_cd = b.productname
                inner join qlik.dim_period d on d.period_id = cast(to_char(x.business_date,'YYYYMM') as integer)
                where windiv_id = 1 and d.period_id = vPeriod_Id

                union all
/*4D Payout Distribution*/
                SELECT a.period_id, 0 as entity_id, a.product_id,0 as cust_id, 996 as acct_id,(payout_amt/sales_amt) as payout_dist,0 as attrib1_id, a.attrib_id as attrib2_id, 0
                from
                (select c.period_id,d.product_id,cast(coalesce(trim(a.draw_number),'0') as integer) as drawnumber,sum(a.debit_credit_amount) * -1 as sales_amt,
                rank() over (partition by c.period_id order by c.period_id,d.product_id,cast(coalesce(trim(a.draw_number),'0') as integer)) + 70 as attrib_id
                from ztsapfi_gl a
                inner join qlik.dim_account b on b.acct_fr = a.gl_account   
                inner join qlik.dim_period c on c.fiscal_year_period = a.fiscal_year_period
                inner join qlik.dim_product d on d.product_cd = a.sold_product
                where company_code = '2000' and acct_lvl5 = 'Sales' and sold_product = '4D' and a.debit_credit_amount < 0
                and coalesce(trim(a.draw_number),'0') not in ('0','') and c.period_id = vPeriod_Id
                group by c.period_id,cast(coalesce(trim(a.draw_number),'0') as integer),d.product_id) a
                inner join 
                (SELECT d.period_id,a.drawnumber,c.product_id,sum(a.totalamount/100) as payout_amt  FROM ztes_pdf_winshares a
                inner join (select cast(product as integer) as productnum,productname from ztall_product
                                where productname = '4D') b on a.productnum = b.productnum
                left join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
                inner join qlik.dim_product c on c.product_cd = b.productname
                inner join qlik.dim_period d on d.period_id = cast(to_char(x.business_date,'YYYYMM') as integer)
                where d.period_id = vPeriod_Id
                group by d.period_id,a.drawnumber,c.product_id) b on a.period_id = b.period_id and a.product_id = b.product_id and a.drawnumber = b.drawnumber
                ;

                /*Remove Data For Reload*/
                delete from qlik.fact_product where period_id >= vPeriod_Id and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 = 'OT' and acct_desc not in ('FTE','Headcount') and acct_id <> 989);

                analyze qlik.fact_product;
                
                /*Insert into Fact table*/
                DROP TABLE IF EXISTS qlik.stg_fact_product;
                
                CREATE TABLE qlik.stg_fact_product
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,                  
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer,
                  attrib2_id integer,
                  attrib3_id integer
                );
                
                /*Insert into Fact table*/
                insert into qlik.stg_fact_product (
                period_id,
                    entity_id,
                    product_id,
                    cust_id,
                    acct_id,                   
                    opening_amt,
                    activity_amt,
                    closing_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select period_id, entity_id, product_id, cust_id, acct_id, sum(opening_amt), sum(activity_amt),sum(closing_amt),attrib1_id, attrib2_id, attrib3_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
                                   ,a.attrib1_id, a.attrib2_id, a.attrib3_id
                from qlik.tmp_fact_product a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_product b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.attrib2_id = a.attrib2_id
                and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id not in (988,987,996,989)
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null 
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id,a.attrib1_id, a.attrib2_id, a.attrib3_id

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
                                   ,a.attrib1_id, a.attrib2_id, a.attrib3_id
                from qlik.tmp_fact_product a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_product b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.attrib2_id = a.attrib2_id
                and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and b.acct_id not in (988,987,996,989) and c.acct_desc not in ('FTE','Headcount')
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.attrib1_id, a.attrib2_id, a.attrib3_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
                                   ,a.attrib1_id, a.attrib2_id, a.attrib3_id
                from qlik.fact_product a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_product b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.attrib2_id = a.attrib2_id
                and b.period_id = vPeriod_Id and a.attrib1_id = b.attrib1_id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and a.acct_id not in (988,987,996,989) and c.acct_desc not in ('FTE','Headcount')
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.attrib1_id, a.attrib2_id, a.attrib3_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id,
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id, a.attrib2_id, a.attrib3_id 
                from qlik.tmp_fact_product a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and  c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id not in (988,987,996,989)
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.attrib1_id, a.attrib2_id, a.attrib3_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, 
                                   sum(coalesce(a.activity_amt,0.00)) as closing_amt,
                                   a.attrib1_id, a.attrib2_id, a.attrib3_id
                from qlik.tmp_fact_product a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id in (988,987,996)
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.attrib1_id, a.attrib2_id, a.attrib3_id
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id,attrib1_id, attrib2_id, attrib3_id
                having sum(opening_amt) + sum(activity_amt) + sum(closing_amt) <> 0;

                
                insert into qlik.fact_product (
                   period_id,
                    entity_id,
                    product_id,
                    cust_id,
                    acct_id,                   
                    opening_amt,
                    activity_amt,
                    closing_amt,
                  attrib1_id,
                  attrib2_id,
                  attrib3_id
                )
                select * from qlik.stg_fact_product;

                analyze qlik.fact_product;
                                
END;
$$;


ALTER FUNCTION qlik.sp_load_betting_system(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1184 (class 1255 OID 24906)
-- Name: sp_load_betting_system_20200107(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_load_betting_system_20200107(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
	vperiodplus1_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) + interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN


     /*create temporary fact table*/
     DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE IF NOT EXISTS qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);

	DROP TABLE IF EXISTS qlik.tmp_ztes_mjf;

/*Extract ES Lottery data for 1 month*/

	/*
	CREATE TABLE qlik.tmp_ztes_mjf as
	select a.tratyp,a.serial,a.cdc,a.journaladdress,lpad(cast(a.traagt as varchar),6,'0') as traagt,e.business_date,a.prod,z.draws_draw,y.bettyp,y.salesamt0,y.salesamt1,c.productname
	from ztes_mjf_journals a
	inner join ztes_mjf_draws z on a.cdc = z.cdc AND a.journaladdress = z.journaladdress
	inner join ztes_mjf_brdinf y on a.cdc = y.cdc AND a.journaladdress = y.journaladdress
	inner join ztes_esrm_outlet b on a.traagt = b.outlet_id
	inner join ztall_product c on a.prod = cast(c.product as int)
	inner join (
	select distinct cast(to_char(business_date,'YYYYMM') as integer) as period_id,business_date,productnum,drawnumber from ztes_pdf_winnbr a
	inner join ztall_businessday b on b.system='ES' and a.drawcdc = b.business_id
	where cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id
	) e on e.productnum = a.prod and e.drawnumber = z.draws_draw
	where a.tratyp in (1,2) and e.period_id = vPeriod_Id and b.outlet_name <> 'POOLZCONNECT' and b.outlet_business_desc <> 'Telebetting'
	and c.productname in ('4D','SWEEP','TOTO') 
	;
	*/

	CREATE TABLE qlik.tmp_ztes_mjf as
	select a.tratyp,a.serial,a.cdc,a.journaladdress, lpad(cast(a.traagt as varchar),6,'0') as traagt,
	e.business_date, a.prod,	a.draws_draw,a.bettyp,a.salesamt0,a.salesamt1,c.productname
	from public.zves_mjf_wagcan a
	inner join ztes_esrm_outlet b on a.traagt = b.outlet_id
	inner join ztall_product c on a.prod = cast(c.product as int)
	inner join (
	select distinct cast(to_char(business_date,'YYYYMM') as integer) as period_id,business_date,productnum,drawnumber from ztes_pdf_winnbr a
	inner join ztall_businessday b on b.system='ES' and a.drawcdc = b.business_id
	where cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id
	) e on e.productnum = a.prod and e.drawnumber = a.draws_draw
	where a.tratyp in (1,2) and e.period_id = vPeriod_Id and b.outlet_name <> 'POOLZCONNECT' and b.outlet_business_desc <> 'Telebetting'
	and c.productname in ('4D','SWEEP','TOTO')
	;
	
	DROP TABLE IF EXISTS qlik.tmp_ztes_mjf_toto_4d;

	CREATE TABLE qlik.tmp_ztes_mjf_toto_4d as
	select *
	from qlik.tmp_ztes_mjf
	where productname in ('4D','TOTO') 
	;

	DROP TABLE IF EXISTS qlik.tmp_ztes_mjf_sweep;

	CREATE TABLE qlik.tmp_ztes_mjf_sweep as
	select *
	from qlik.tmp_ztes_mjf
	where productname in ('SWEEP') and (salesamt0 + salesamt1) <> 0
	;

	DROP TABLE IF EXISTS qlik.tmp_ztob_lottery;

/*Extract OB Lottery data for 1 month*/
	CREATE TABLE qlik.tmp_ztob_lottery as
	select draw_date_d,betslip_id,product_id,channel,upper(bet_name) as bet_name,sales_amount as sales
	from ztob_lottery a
	where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id and a.ob_status = 'A'
	;

	DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability;

/*Extract Sport Retail data*/
	CREATE TABLE qlik.tmp_ztmm2_liability as
	select betslipid,leaguecode,upper(bettype) as bettype,settledate,legstatus,retailerid,upper(marketname) as marketname,salesamt,winamt
	from ztmm2_liability a
	where cast(to_char(a.settledate,'YYYYMM') as integer) in (vprevperid_id,vperiod_id,vperiodplus1_id) and a.legstatus in ('L','W')
	;

	DROP TABLE IF EXISTS qlik.tmp_ztob_sportbetssettled;

/*Extract Sport Online data*/
	CREATE TABLE qlik.tmp_ztob_sportbetssettled as
	select bet_id,account_no,leg_status,last_settled_date_d,upper(bet_type) as bet_type,match_id,upper(market_name) as market_name,settled_sales,settled_returns,channel,place_terminal_code
	from ztob_sportbetssettled a
	where channel <> 'R' and leg_status in ('L','W') and cast(to_char(a.last_settled_date_d,'YYYYMM') as integer) in (vprevperid_id,vperiod_id,vperiodplus1_id)
	;

	DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability2;

/*Further Transformation from SPORT RETAILER Data*/
	CREATE TABLE qlik.tmp_ztmm2_liability2 as
	select a.betslipid,a.leaguecode,a.bettype,a.settledate,a.legstatus,a.retailerid,a.marketname,a.salesamt,a.winamt,case when b.betslipid is not null then vPeriod_Id else case when a.bettype = 'S' then cast(to_char(a.settledate,'YYYYMM') as integer) else 190001 end end as settlement_period,coalesce(h.entity_id,0) as entity_id
	from qlik.tmp_ztmm2_liability a
	left join (
	select betslipid from qlik.tmp_ztmm2_liability
	where bettype <> 'S' and cast(to_char(settledate,'YYYYMM') as integer) >= vPeriod_Id
	group by betslipid
	having max(cast(to_char(settledate,'YYYYMM') as integer)) = vPeriod_Id
	) b on a.betslipid = b.betslipid
	left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
		where company = 'SPPL' and div_cd <> '20012')  h on a.retailerid = h.entity_cd and a.settledate between h.effective_from and h.effective_to
	;
	analyze qlik.tmp_ztmm2_liability2;

	DROP TABLE IF EXISTS qlik.tmp_ztmm2_wager;

/*Get The correct settlement date for SPORT RETAILER Data*/
	CREATE TABLE qlik.tmp_ztmm2_wager as
	select 
		a.betslipid,
		cast(to_char(c.settledate,'YYYYMM') as integer) as settlement_period
	from ztmm2_wager a
	inner join (
	select betslipid from qlik.tmp_ztmm2_liability2
	where bettype <> 'S'
	group by betslipid
	having max(case bettype when 'D' then 2 when 'T' then 3 when '4F' then 4 end) <> count(*)
	) b on a.betslipid = b.betslipid
	inner join ztmm2_timetable c on c.matchcode = a.matchcode
	;
/*Get The max settlement date by betid for SPORT RETAILER Data*/
	DROP TABLE IF EXISTS qlik.tmp_ztmm2_wager1;


	CREATE TABLE qlik.tmp_ztmm2_wager1 as
	select 
		a.betslipid,
		max(settlement_period) as settlement_period
	from qlik.tmp_ztmm2_wager a
	group by a.betslipid
	;

	DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability1;

/*populate the final tranformation to temporary table*/
	CREATE TABLE qlik.tmp_ztmm2_liability1 as
	select a.betslipid,a.leaguecode,a.bettype,a.settledate,a.legstatus,a.retailerid,a.marketname,a.salesamt,a.winamt,case when b.betslipid is not null then b.settlement_period else a.settlement_period end as settlement_period, a.entity_id 
	from qlik.tmp_ztmm2_liability2 a 
	left join qlik.tmp_ztmm2_wager1 b on a.betslipid = b.betslipid
	;

	analyze qlik.tmp_ztmm2_liability1;

	delete from qlik.tmp_ztmm2_liability1 where settlement_period <> vPeriod_Id;
	
	analyze qlik.tmp_ztmm2_liability1;

	DROP TABLE IF EXISTS qlik.tmp_ztob_sportbetssettled1;

/*tranformation to temporary table for SPORT ONLINE*/
	CREATE TABLE qlik.tmp_ztob_sportbetssettled1 as
	select cast(a.bet_id as varchar) as bet_id,a.account_no,a.leg_status,a.last_settled_date_d,a.bet_type,a.match_id,a.market_name,a.settled_sales,a.settled_returns,a.channel,case when x.bet_id is not null then vPeriod_Id else case when a.bet_type = 'SGL' then cast(to_char(last_settled_date_d,'YYYYMM') as integer) else 190001 end end as settlement_period,trim(b.sports_type) || trim(b.league_code) as leaguecode,coalesce(coalesce(c.entity_id,h.entity_id),0) as entity_id
	from qlik.tmp_ztob_sportbetssettled a
	left join (
		select bet_id,max(last_settled_date_d) as max_last_settled_date_d from qlik.tmp_ztob_sportbetssettled
		where bet_type <> 'SGL' and cast(to_char(last_settled_date_d,'YYYYMM') as integer) >= vPeriod_Id
		group by bet_id
		having max(cast(to_char(last_settled_date_d,'YYYYMM') as integer)) = vPeriod_Id
	) x on a.bet_id = x.bet_id
	inner join ztob_timetable b on a.match_id = b.match_id
	left join (
		select entity_id,channel from qlik.dim_entity d
		inner join (select channel,case when (description='Phone') then 'Telebetting' else description end as description 
		from ztob_channels where channeltype = 'Online') c on d.entity_nm like '%'|| c.description ||'%'
	) c on c.channel = a.channel
	left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
		where company = 'SPPL' and div_cd <> '20012')  h on left(a.place_terminal_code,6) = h.entity_cd and (case when x.bet_id is not null then x.max_last_settled_date_d else (case when a.bet_type = 'SGL' then last_settled_date_d else to_date('1900-01-01','YYYY-MM-DD') end) end) between h.effective_from and h.effective_to
	;
	
	delete from qlik.tmp_ztob_sportbetssettled1 where settlement_period <> vPeriod_Id;
	
	analyze qlik.tmp_ztob_sportbetssettled1;
	

    /*Betting System Data MTD*/

	/*load Lottery Number Of Transaction/Bet Slip from retail/ES data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,1 as attrib_id,sum(case when a.tratyp = 1 then 1 else -1 end) as no_of_transaction,0 as attrib1_id
	from (
	select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial,sum(0) as tempfield
	from qlik.tmp_ztes_mjf_toto_4d a
	inner join qlik.dim_product g on a.productname = g.product_cd
	left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
		where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
	group by h.entity_id,g.product_id, a.tratyp,a.serial
	) a
	group by period_id,coalesce(entity_id,0),product_id;

	
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,1 as attrib_id,sum(case when a.tratyp = 1 then 1 else -1 end) as no_of_transaction,0 as attrib1_id
	from (
	select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial
	from qlik.tmp_ztes_mjf_sweep a
	inner join qlik.dim_product g on a.productname = g.product_cd
	left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
		where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
	) a
	group by period_id,coalesce(entity_id,0),product_id
	;


	/*load Lottery Number Of Transaction/Bet Slip from OB data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	/*Lottery No Of Transactionon by betslip from OB*/
	select period_id,entity_id,product_id,0 as cust_id,998 as acct_id,1 as attrib_id,count(*),0 from (
	select  b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id, sum(0) as tempfield
	from qlik.tmp_ztob_lottery a
	inner join ztall_product b on a.product_id = b.product
	inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
	inner join qlik.dim_product g on b.productname = g.product_cd
	left join qlik.dim_entity d on d.entity_nm like '%'|| case when (c.description='Phone') then 'Telebetting' else c.description end ||'%'
	group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer),d.entity_id,g.product_id,c.description,betslip_id
	) a
	group by period_id,entity_id,product_id;


	/*load SPORTS Number Of Transaction/Bet Slip from retail/MM2 & OB data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select 
	period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,h.attrib_id as attrib_id,count(*) as no_of_transaction ,0
	from 
	(select a.betslipid,a.entity_id,vPeriod_Id as period_id,a.leaguecode as product_cd,a.bettype,sum(0) as tempfield
	from qlik.tmp_ztmm2_liability1 a
	where a.settlement_period = vPeriod_Id
	group by a.betslipid,a.entity_id,a.leaguecode,a.bettype
	union all
	select a.bet_id,a.entity_id,vPeriod_Id,a.leaguecode,a.bet_type,sum(0) as tempfield
	from qlik.tmp_ztob_sportbetssettled1 a
	where a.settlement_period = vPeriod_Id
	group by a.bet_id,a.entity_id,a.leaguecode,a.bet_type
	) a
	inner join qlik.dim_product g on a.product_cd = g.product_cd
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
	where period_id = vPeriod_Id
	group by period_id,coalesce(entity_id,0),product_id,h.attrib_id ;


/*load LOTTERY Number Of Transaction/Bet Slip by BET TYPE from ES data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	
	select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,986 as acct_id,attrib_id,sum(nbrbrds) as no_of_transaction ,0
	from (
	select vperiod_id as period_id,h.entity_id,g.product_id, case when a.tratyp = 1 then 1 else -1 end as nbrbrds,a.serial,f.attrib_id
	from qlik.tmp_ztes_mjf a
	inner join (select attrib_id,attrib_cd,attrib_nm,case when attrib_nm like '4D%' then '4D' else 'TOTO' end as attribute5 from qlik.dim_attribute where attrib_nm like '4D%' or attrib_nm like 'TOTO%') f on f.attrib_cd = cast(a.bettyp as varchar) and f.attribute5 = a.productname 
	inner join qlik.dim_product g on a.productname = g.product_cd
	left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
		where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
	) a
	group by period_id,coalesce(entity_id,0),product_id,attrib_id;


	/*load LOTTERY Number Of Transaction/Bet Slip By BET TYPE from OB data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	/*Lottery No Of Transactionon by bettype from OB*/
	select period_id,entity_id,product_id,0 as cust_id,986 as acct_id,attrib_id,count(*),0 from (
	select  b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id,f.attrib_id,bet_name,sum(0) as tempfield
	from qlik.tmp_ztob_lottery a
	inner join ztall_product b on a.product_id = b.product
	inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
	inner join qlik.dim_product g on b.productname = g.product_cd
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.bet_name 
	left join qlik.dim_entity d on d.entity_nm like '%'|| case when c.description = 'Phone' then 'Telebetting' else c.description end ||'%'
	where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id
	group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) ,d.entity_id,g.product_id,c.description,betslip_id,f.attrib_id,bet_name
	) a
	group by period_id,entity_id,product_id,attrib_id;
	

	/*load SPORTS Number Of Transaction/Bet Slip by BET TYPE from retail/MM2 & OB data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select 
	period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,986 as acct_id,f.attrib_id as attrib_id,count(*) as no_of_transaction ,h.attrib_id
	from 
	(
	select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,
	marketname,sum(salesamt) as sales,a.bettype 
	from qlik.tmp_ztmm2_liability1 a
	where 
		a.settlement_period = vPeriod_Id
	group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
	union all
	select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
	market_name,sum(settled_sales)as sales,a.bet_type
	from qlik.tmp_ztob_sportbetssettled1 a
	where a.settlement_period = vPeriod_Id
	group by a.bet_id,a.entity_id,a.leaguecode,
	market_name,a.bet_type
	) a
	inner join qlik.dim_product g on a.product_cd = g.product_cd
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
	where period_id = vPeriod_Id
	group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;


	/*load Lottery sales amount by BET TYPE from ES data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,985 as acct_id,attrib_id,sum(case when a.tratyp = 1 then salesamt else -1 * salesamt end) as sales_by_bettype ,0
	from (
	select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial,f.attrib_id,sum(a.salesamt0 + a.salesamt1)/100 as salesamt
	from qlik.tmp_ztes_mjf a
	inner join (select attrib_id,attrib_cd,attrib_nm,case when attrib_nm like '4D%' then '4D' else 'TOTO' end as attribute5 from qlik.dim_attribute where attrib_nm like '4D%' or attrib_nm like 'TOTO%') f on f.attrib_cd = cast(a.bettyp as varchar) and f.attribute5 = a.productname 
	inner join qlik.dim_product g on a.productname = g.product_cd
	left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
		left join (select 
		entity_id from qlik.dim_entity where right(entity_cd,6) in (
		select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
		and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
		where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
	group by h.entity_id,g.product_id, a.tratyp,a.serial,f.attrib_id
	) a
	group by period_id,coalesce(entity_id,0),product_id,attrib_id;


	/*load Lottery sales amount by BET TYPE from OB data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	/*lottery sales by bettype from OB*/
	select period_id,entity_id,product_id,0 as cust_id,985 as acct_id,attrib_id,sum(sales) as sales_by_bettype,0 from (
	select b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id,f.attrib_id,bet_name,sum(a.sales) as sales 
	from qlik.tmp_ztob_lottery a
	inner join ztall_product b on a.product_id = b.product
	inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
	inner join qlik.dim_product g on b.productname = g.product_cd
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.bet_name 
	left join qlik.dim_entity d on d.entity_nm like '%'|| c.description ||'%'
	where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id
	group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer),d.entity_id,g.product_id,c.description,betslip_id,f.attrib_id,bet_name
	) a
	group by period_id,entity_id,product_id,attrib_id;

	/*load SPORTS sales amount by BET TYPE from MM2& OB data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select 
	period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,985 as acct_id,f.attrib_id as attrib_id,sum(sales) as salesamt ,h.attrib_id
	from 
	(select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,marketname,sum(salesamt) as sales,a.bettype 
	from qlik.tmp_ztmm2_liability1 a
	where 
		a.settlement_period = vPeriod_Id
	group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
	union all
	select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
	market_name,sum(settled_sales)as sales,a.bet_type 
	from qlik.tmp_ztob_sportbetssettled1 a
	where a.settlement_period = vPeriod_Id
	group by a.bet_id,a.entity_id,a.leaguecode,market_name,a.bet_type
	) a
	inner join qlik.dim_product g on a.product_cd = g.product_cd
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
	where period_id = vPeriod_Id
	group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;


	/*load SPORTS winning amount by BET TYPE from MM2& OB data */
	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	select 
	period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,984 as acct_id,f.attrib_id as attrib_id,sum(winamt) as winamt ,h.attrib_id
	from 
	(select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,marketname,sum(winamt) as winamt,a.bettype 
	from qlik.tmp_ztmm2_liability1 a
	where 
		a.settlement_period = vPeriod_Id and a.legstatus = 'W'
	group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
	union all
	select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
	market_name,sum(settled_returns)as sales,a.bet_type 
	from qlik.tmp_ztob_sportbetssettled1 a
	where a.settlement_period = vPeriod_Id and leg_status = 'W'
	group by a.bet_id,a.entity_id,a.leaguecode,market_name,a.bet_type
	) a
	inner join qlik.dim_product g on a.product_cd = g.product_cd
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
	inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
	where period_id = vPeriod_Id
	group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;


	insert into qlik.tmp_fact_gl_balance (
	 period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  activity_amt,
	  attrib1_id
	)
	/*LOTTERY No Of Draw*/
	select 
		a.period_id,0 as entity_id,b.product_id,0 as cust_id,995 as acct_id,1 as attrib_id,no_of_draw as no_of_draw ,0 as attribute_1
	from
	(select cast(period_id as integer) as period_id,productname,count(*) as no_of_draw from (
	select distinct c.productname,drawnumber,to_char(business_date,'YYYYMM') as period_id from ztes_pdf_winnbr a
	inner join (select business_date,business_id from ztall_businessday where system = 'ES' and cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id) b on a.drawcdc = b.business_id
	inner join (select cast(product as integer) as product,productname from ztall_product where producttype = 'Lottery' and productname <> 'SWEEP') c on a.productnum = c.product
	) a
	group by cast(period_id as integer),productname) a
	inner join qlik.dim_product b on a.productname = b.product_cd

	union all
/*Customer Registration & Activations*/
	select vPeriod_Id,0 as entity_id,0 as product_id,0 as cust_id,982 as acct_id,1 as attrib_id,sum(current_count) as no_of_draw ,0 as attribute_1 from ( 
	SELECT
	case when cast(to_char(activation_date,'YYYYMM') as integer) = vPeriod_Id then 1 else 0 end as current_count,
	case when cast(to_char(activation_date,'YYYYMM') as integer) <= vPeriod_Id then 1 else 0 end as total_count
	FROM ztob_customer
	where status = 'A' and activation_date is not null and cast(to_char(activation_date,'YYYYMM') as integer) = vPeriod_Id) a
	having coalesce(sum(current_count),0) <> 0
	union all
	select vPeriod_Id,0 as entity_id,0 as product_id,0 as cust_id,983 as acct_id,1 as attrib_id,count(*) as no_of_draw ,0 as attribute_1 
	from ztob_customer
	where status = 'A' and cast(to_char(creation_date,'YYYYMM') as integer) = vPeriod_Id
	having coalesce(count(*),0) <> 0

	union all
/*Sweep 1st 2nd 3rd Winner*/
	select cast(to_char(x.business_date,'YYYYMM') as integer) as period_id,0 as entity_id,b.product_id,0 as cust_id,988 as acct_id,c.attrib_id,a.shrcount,0 as attribute_1
	from ztes_pdf_winshares a
	inner join qlik.dim_product b on b.product_cd = 'SWEEP'
	left join (select * from ztall_businessday where system = 'ES') x on x.business_id = a.drawcdc
	inner join qlik.dim_attribute c on c.attrib_id in (297,298,299) and cast(c.attribute1 as integer) = a.windiv_id
	where a.productname = 'swep' and a.windiv_id in (1,2,3) and cast(to_char(x.business_date,'YYYYMM') as integer) = vPeriod_Id

	union all

	select a.period_id,a.entity_id,a.product_id,a.cust_id,a.acct_id,a.value_type,a.activity_amt,a.attrib1_id
	from qlik.hist_fact_gl_balance a
	where a.acct_id = 988 and a.period_id = vPeriod_Id
	
	union all
/*TOTO Jackpot Amount*/
	SELECT d.period_id, 0 as entity_id, c.product_id,0 as cust_id, 987 as acct_id,rank() over (partition by d.period_id order by d.period_id,c.product_id,a.drawnumber) + 70 as attrib_id,a.pollforallocation/100,0 as attribute_1
	FROM ztes_pdf_winshares a
	inner join (select cast(product as integer) as productnum,productname from ztall_product
	where productname = 'TOTO') b on a.productnum = b.productnum
	left join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
	inner join qlik.dim_product c on c.product_cd = b.productname
	inner join qlik.dim_period d on d.period_id = cast(to_char(x.business_date,'YYYYMM') as integer)
	where windiv_id = 1 and d.period_id = vPeriod_Id

	union all
/*4D Payout Distribution*/
	SELECT a.period_id, 0 as entity_id, a.product_id,0 as cust_id, 996 as acct_id,a.attrib_id as attrib_id,(payout_amt/sales_amt) as payout_dist,0 as attribute_1
	from
	(select c.period_id,d.product_id,cast(coalesce(trim(a.draw_number),'0') as integer) as drawnumber,sum(a.total_value_controlling) * -1 as sales_amt,
	rank() over (partition by c.period_id order by c.period_id,d.product_id,cast(coalesce(trim(a.draw_number),'0') as integer)) + 70 as attrib_id
	from ztsapfi_copa a
	inner join qlik.dim_account b on b.acct_fr = right(a.cost_element,7) 
	inner join qlik.dim_period c on c.fiscal_year_period = a.fiscal_year_period
	inner join qlik.dim_product d on d.product_cd = a.material
	where company_code = '2000' and acct_lvl3 = 'Sales' and material = '4D' and value_type = 10 and a.total_value_controlling < 0
	and coalesce(trim(a.draw_number),'0') not in ('0','') and c.period_id = vPeriod_Id
	group by c.period_id,cast(coalesce(trim(a.draw_number),'0') as integer),d.product_id) a
	inner join 
	(SELECT d.period_id,a.drawnumber,c.product_id,sum(a.totalamount/100) as payout_amt  FROM ztes_pdf_winshares a
	inner join (select cast(product as integer) as productnum,productname from ztall_product
		where productname = '4D') b on a.productnum = b.productnum
	left join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
	inner join qlik.dim_product c on c.product_cd = b.productname
	inner join qlik.dim_period d on d.period_id = cast(to_char(x.business_date,'YYYYMM') as integer)
	where d.period_id = vPeriod_Id
	group by d.period_id,a.drawnumber,c.product_id) b on a.period_id = b.period_id and a.product_id = b.product_id and a.drawnumber = b.drawnumber
	;

	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= vPeriod_Id and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 = 'OT' and acct_desc not in ('FTE','Headcount') and acct_id <> 989);

	analyze qlik.fact_gl_balance;
	
	 /*Insert into Fact table*/
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
	
	 /*Insert into Fact table*/
	insert into qlik.stg_fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),attrib1_id
	from (
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
		   ,a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id not in (988,987,996,989)
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null 
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all
	
	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
		   ,a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and b.acct_id not in (988,987,996,989) and c.acct_desc not in ('FTE','Headcount')
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by 
	a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
		   ,a.attrib1_id
	from qlik.fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
	and b.period_id = vPeriod_Id and a.attrib1_id = b.attrib1_id
	where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and a.acct_id not in (988,987,996,989) and c.acct_desc not in ('FTE','Headcount')
	and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and  c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id not in (988,987,996,989)
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

	union all

	select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
		   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,a.attrib1_id
	from qlik.tmp_fact_gl_balance a
	inner join qlik.dim_account c on c.acct_id = a.acct_id
	where a.period_id = vPeriod_Id and c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id in (988,987,996)
	and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
	group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
	
	) a
	group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
	having sum(opening_amt) + sum(activity_amt) + sum(closing_amt) <> 0;

	
	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;
		
END;
$$;


ALTER FUNCTION qlik.sp_load_betting_system_20200107(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1185 (class 1255 OID 24909)
-- Name: sp_load_betting_system_bk_20200118(character); Type: FUNCTION; Schema: qlik; Owner: postgres
--

CREATE FUNCTION qlik.sp_load_betting_system_bk_20200118(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
                vperiod_id integer:= (select cast(vparperiod as integer));
                vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
                vperiodplus1_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) + interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN

     /*create temporary fact table*/
     DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

                CREATE TABLE IF NOT EXISTS qlik.tmp_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf;

/*Extract ES Lottery data for 1 month*/
                CREATE TABLE qlik.tmp_ztes_mjf as
                select a.tratyp,a.serial,a.cdc,a.journaladdress,lpad(cast(a.traagt as varchar),6,'0') as traagt,e.business_date,a.prod,z.draws_draw,y.bettyp,y.salesamt0,y.salesamt1,c.productname
                from ztes_mjf_journals a
                inner join ztes_mjf_draws z on a.cdc = z.cdc AND a.journaladdress = z.journaladdress
                inner join ztes_mjf_brdinf y on a.cdc = y.cdc AND a.journaladdress = y.journaladdress
                inner join ztes_esrm_outlet b on a.traagt = b.outlet_id
                inner join ztall_product c on a.prod = cast(c.product as int)
                inner join (
                select distinct cast(to_char(business_date,'YYYYMM') as integer) as period_id,business_date,productnum,drawnumber from ztes_pdf_winnbr a
                inner join ztall_businessday b on b.system='ES' and a.drawcdc = b.business_id
                where cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id
                ) e on e.productnum = a.prod and e.drawnumber = z.draws_draw
                where a.tratyp in (1,2) and e.period_id = vPeriod_Id and b.outlet_name <> 'POOLZCONNECT' and b.outlet_business_desc <> 'Telebetting'
                and c.productname in ('4D','SWEEP','TOTO') 
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf_toto_4d;

                CREATE TABLE qlik.tmp_ztes_mjf_toto_4d as
                select *
                from qlik.tmp_ztes_mjf
                where productname in ('4D','TOTO') 
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztes_mjf_sweep;

                CREATE TABLE qlik.tmp_ztes_mjf_sweep as
                select *
                from qlik.tmp_ztes_mjf
                where productname in ('SWEEP') and (salesamt0 + salesamt1) <> 0
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztob_lottery;

/*Extract OB Lottery data for 1 month*/
                CREATE TABLE qlik.tmp_ztob_lottery as
                select draw_date_d,betslip_id,product_id,channel,upper(bet_name) as bet_name,sales_amount as sales
                from ztob_lottery a
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id and a.ob_status = 'A'
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability;

/*Extract Sport Retail data*/
                CREATE TABLE qlik.tmp_ztmm2_liability as
                select betslipid,leaguecode,upper(bettype) as bettype,settledate,legstatus,retailerid,upper(marketname) as marketname,salesamt,winamt
                from ztmm2_liability a
                where cast(to_char(a.settledate,'YYYYMM') as integer) in (vprevperid_id,vperiod_id,vperiodplus1_id) and a.legstatus in ('L','W')
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztob_sportbetssettled;

/*Extract Sport Online data*/
                CREATE TABLE qlik.tmp_ztob_sportbetssettled as
                select bet_id,account_no,leg_status,last_settled_date_d,upper(bet_type) as bet_type,match_id,upper(market_name) as market_name,settled_sales,settled_returns,channel,place_terminal_code
                from ztob_sportbetssettled a
                where channel <> 'R' and leg_status in ('L','W') and cast(to_char(a.last_settled_date_d,'YYYYMM') as integer) in (vprevperid_id,vperiod_id,vperiodplus1_id)
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability2;

/*Further Transformation from SPORT RETAILER Data*/
                CREATE TABLE qlik.tmp_ztmm2_liability2 as
                select a.betslipid,a.leaguecode,a.bettype,a.settledate,a.legstatus,a.retailerid,a.marketname,a.salesamt,a.winamt,case when b.betslipid is not null then vPeriod_Id else case when a.bettype = 'S' then cast(to_char(a.settledate,'YYYYMM') as integer) else 190001 end end as settlement_period,coalesce(h.entity_id,0) as entity_id
                from qlik.tmp_ztmm2_liability a
                left join (
                select betslipid from qlik.tmp_ztmm2_liability
                where bettype <> 'S' and cast(to_char(settledate,'YYYYMM') as integer) >= vPeriod_Id
                group by betslipid
                having max(cast(to_char(settledate,'YYYYMM') as integer)) = vPeriod_Id
                ) b on a.betslipid = b.betslipid
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-
				' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012')  h on a.retailerid = h.entity_cd and a.settledate between h.effective_from and h.effective_to
                ;
                analyze qlik.tmp_ztmm2_liability2;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_wager;

/*Get The correct settlement date for SPORT RETAILER Data*/
                CREATE TABLE qlik.tmp_ztmm2_wager as
                select 
                                a.betslipid,
                                cast(to_char(c.settledate,'YYYYMM') as integer) as settlement_period
                from ztmm2_wager a
                inner join (
                select betslipid from qlik.tmp_ztmm2_liability2
                where bettype <> 'S'
                group by betslipid
                having max(case bettype when 'D' then 2 when 'T' then 3 when '4F' then 4 end) <> count(*)
                ) b on a.betslipid = b.betslipid
                inner join ztmm2_timetable c on c.matchcode = a.matchcode
                ;
/*Get The max settlement date by betid for SPORT RETAILER Data*/
                DROP TABLE IF EXISTS qlik.tmp_ztmm2_wager1;

                CREATE TABLE qlik.tmp_ztmm2_wager1 as
                select 
                                a.betslipid,
                                max(settlement_period) as settlement_period
                from qlik.tmp_ztmm2_wager a
                group by a.betslipid
                ;

                DROP TABLE IF EXISTS qlik.tmp_ztmm2_liability1;

/*populate the final tranformation to temporary table*/
                CREATE TABLE qlik.tmp_ztmm2_liability1 as
                select a.betslipid,a.leaguecode,a.bettype,a.settledate,a.legstatus,a.retailerid,a.marketname,a.salesamt,a.winamt,case when b.betslipid is not null then b.settlement_period else a.settlement_period end as settlement_period, a.entity_id 
                from qlik.tmp_ztmm2_liability2 a 
                left join qlik.tmp_ztmm2_wager1 b on a.betslipid = b.betslipid
                ;

                analyze qlik.tmp_ztmm2_liability1;

                delete from qlik.tmp_ztmm2_liability1 where settlement_period <> vPeriod_Id;
                
                analyze qlik.tmp_ztmm2_liability1;

                DROP TABLE IF EXISTS qlik.tmp_ztob_sportbetssettled1;

/*tranformation to temporary table for SPORT ONLINE*/
                CREATE TABLE qlik.tmp_ztob_sportbetssettled1 as
                select cast(a.bet_id as varchar) as bet_id,a.account_no,a.leg_status,a.last_settled_date_d,a.bet_type,a.match_id,a.market_name,a.settled_sales,a.settled_returns,a.channel,case when x.bet_id is not null then vPeriod_Id else case when a.bet_type = 'SGL' then cast(to_char(last_settled_date_d,'YYYYMM') as integer) else 190001 end end as settlement_period,trim(b.sports_type) || trim(b.league_code) as leaguecode,coalesce(coalesce(c.entity_id,h.entity_id),0) as entity_id
                from qlik.tmp_ztob_sportbetssettled a
                left join (
                                select bet_id,max(last_settled_date_d) as max_last_settled_date_d from qlik.tmp_ztob_sportbetssettled
                                where bet_type <> 'SGL' and cast(to_char(last_settled_date_d,'YYYYMM') as integer) >= vPeriod_Id
                                group by bet_id
                                having max(cast(to_char(last_settled_date_d,'YYYYMM') as integer)) = vPeriod_Id
                ) x on a.bet_id = x.bet_id
                inner join ztob_timetable b on a.match_id = b.match_id
                left join (
                                select entity_id,channel from qlik.dim_entity d
                                inner join (select channel,case when (description='Phone') then 'Telebetting' else description end as description 
                                from ztob_channels where channeltype = 'Online') c on d.entity_nm like '%'|| c.description ||'%'
                ) c on c.channel = a.channel
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012')  h on left(a.place_terminal_code,6) = h.entity_cd and (case when x.bet_id is not null then x.max_last_settled_date_d else (case when a.bet_type = 'SGL' then last_settled_date_d else to_date('1900-01-01','YYYY-MM-DD') end) end) between h.effective_from and h.effective_to
                ;
                
                delete from qlik.tmp_ztob_sportbetssettled1 where settlement_period <> vPeriod_Id;
                
                analyze qlik.tmp_ztob_sportbetssettled1;
                

    /*Betting System Data MTD*/

                /*load Lottery Number Of Transaction/Bet Slip from retail/ES data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,1 as attrib_id,sum(case when a.tratyp = 1 then 1 else -1 end) as no_of_transaction,0 as attrib1_id
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial,sum(0) as tempfield
                from qlik.tmp_ztes_mjf_toto_4d a
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                group by h.entity_id,g.product_id, a.tratyp,a.serial
                ) a
                group by period_id,coalesce(entity_id,0),product_id;

                
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,1 as attrib_id,sum(case when a.tratyp = 1 then 1 else -1 end) as no_of_transaction,0 as attrib1_id
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial
                from qlik.tmp_ztes_mjf_sweep a
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                               left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                ) a
                group by period_id,coalesce(entity_id,0),product_id
                ;

                /*load Lottery Number Of Transaction/Bet Slip from OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                /*Lottery No Of Transactionon by betslip from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,998 as acct_id,1 as attrib_id,count(*),0 from (
                select  b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id, sum(0) as tempfield
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                left join qlik.dim_entity d on d.entity_nm like '%'|| case when (c.description='Phone') then 'Telebetting' else c.description end ||'%'
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer),d.entity_id,g.product_id,c.description,betslip_id
                ) a
                group by period_id,coalesce(entity_id,0),product_id;

                /*load SPORTS Number Of Transaction/Bet Slip from retail/MM2 & OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,998 as acct_id,h.attrib_id as attrib_id,count(*) as no_of_transaction ,0
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,a.leaguecode as product_cd,a.bettype,sum(0) as tempfield
                from qlik.tmp_ztmm2_liability1 a
                where a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,a.leaguecode,a.bettype
                union all
               select a.bet_id,a.entity_id,vPeriod_Id,a.leaguecode,a.bet_type,sum(0) as tempfield
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,h.attrib_id ;

/*load LOTTERY Number Of Transaction/Bet Slip by BET TYPE from ES data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,986 as acct_id,attrib_id,sum(nbrbrds) as no_of_transaction ,0
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, case when a.tratyp = 1 then 1 else -1 end as nbrbrds,a.serial,f.attrib_id
                from qlik.tmp_ztes_mjf a
                inner join (select attrib_id,attrib_cd,attrib_nm,case when attrib_nm like '4D%' then '4D' else 'TOTO' end as attribute5 from qlik.dim_attribute where attrib_nm like '4D%' or attrib_nm like 'TOTO%') f on f.attrib_cd = cast(a.bettyp as varchar) and f.attribute5 = a.productname 
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load LOTTERY Number Of Transaction/Bet Slip By BET TYPE from OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                /*Lottery No Of Transactionon by bettype from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,986 as acct_id,attrib_id,count(*),0 from (
                select  b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id,f.attrib_id,bet_name,sum(0) as tempfield
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.bet_name 
                left join qlik.dim_entity d on d.entity_nm like '%'|| case when c.description = 'Phone' then 'Telebetting' else c.description end ||'%'
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) ,d.entity_id,g.product_id,c.description,betslip_id,f.attrib_id,bet_name
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;
                

                /*load SPORTS Number Of Transaction/Bet Slip by BET TYPE from retail/MM2 & OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,986 as acct_id,f.attrib_id as attrib_id,count(*) as no_of_transaction ,h.attrib_id
                from 
                (
                select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,
                marketname,sum(salesamt) as sales,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_sales)as sales,a.bet_type
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,
                market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                /*load Lottery sales amount by BET TYPE from ES data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,985 as acct_id,attrib_id,sum(case when a.tratyp = 1 then salesamt else -1 * salesamt end) as sales_by_bettype ,0
                from (
                select vperiod_id as period_id,h.entity_id,g.product_id, a.tratyp,a.serial,f.attrib_id,sum(a.salesamt0 + a.salesamt1)/100 as salesamt
                from qlik.tmp_ztes_mjf a
                inner join (select attrib_id,attrib_cd,attrib_nm,case when attrib_nm like '4D%' then '4D' else 'TOTO' end as attribute5 from qlik.dim_attribute where attrib_nm like '4D%' or attrib_nm like 'TOTO%') f on f.attrib_cd = cast(a.bettyp as varchar) and f.attribute5 = a.productname 
                inner join qlik.dim_product g on a.productname = g.product_cd
                left join (select a.entity_id,right(a.entity_cd,6) as entity_cd, to_date(case when c.entity_id is null then '1900-01-01' else '2019-01-07' end,'YYYY-MM-DD') as effective_from,to_date(case when b.entity_id is null then '9999-12-31' else '2019-01-06' end,'YYYY-MM-DD') as effective_to from qlik.dim_entity a
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2005') b on a.entity_id = b.entity_id
                                left join (select 
                                entity_id from qlik.dim_entity where right(entity_cd,6) in (
                                select right(entity_cd,6) from qlik.dim_entity  where attribute4 in ('OCB','KRC') and attribute5 = 'Branch')
                                and left(entity_cd,4) = '2009') c on a.entity_id = c.entity_id
                                where company = 'SPPL' and div_cd <> '20012') h on a.traagt = h.entity_cd and a.business_date between h.effective_from and h.effective_to
                group by h.entity_id,g.product_id, a.tratyp,a.serial,f.attrib_id
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load Lottery sales amount by BET TYPE from OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                /*lottery sales by bettype from OB*/
                select period_id,coalesce(entity_id,0),product_id,0 as cust_id,985 as acct_id,attrib_id,sum(sales) as sales_by_bettype,0 from (
                select b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer) as period_id,d.entity_id,g.product_id,c.description as channel,betslip_id,f.attrib_id,bet_name,sum(a.sales) as sales 
                from qlik.tmp_ztob_lottery a
                inner join ztall_product b on a.product_id = b.product
                inner join ztob_channels c on c.channel = a.channel and c.channeltype = 'Online'
                inner join qlik.dim_product g on b.productname = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.bet_name 
                left join qlik.dim_entity d on d.entity_nm like '%'|| c.description ||'%'
                where cast(to_char(draw_date_d,'YYYYMM') as integer) = vPeriod_Id
                group by b.productname,cast(to_char(draw_date_d,'YYYYMM') as integer),d.entity_id,g.product_id,c.description,betslip_id,f.attrib_id,bet_name
                ) a
                group by period_id,coalesce(entity_id,0),product_id,attrib_id;

                /*load SPORTS sales amount by BET TYPE from MM2& OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,985 as acct_id,f.attrib_id as attrib_id,sum(sales) as salesamt ,h.attrib_id
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,marketname,sum(salesamt) as sales,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_sales)as sales,a.bet_type 
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id
                group by a.bet_id,a.entity_id,a.leaguecode,market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                /*load SPORTS winning amount by BET TYPE from MM2& OB data */
                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                select 
                period_id,coalesce(entity_id,0) as entity_id,product_id,0 as cust_id,984 as acct_id,f.attrib_id as attrib_id,sum(winamt) as winamt ,h.attrib_id
                from 
                (select a.betslipid,a.entity_id,vPeriod_Id as period_id,leaguecode as product_cd,marketname,sum(winamt) as winamt,a.bettype 
                from qlik.tmp_ztmm2_liability1 a
                where 
                                a.settlement_period = vPeriod_Id and a.legstatus = 'W'
                group by a.betslipid,a.entity_id,leaguecode,marketname,a.bettype
                union all
                select a.bet_id,a.entity_id,vPeriod_Id as period_id,a.leaguecode,
                market_name,sum(settled_returns)as sales,a.bet_type 
                from qlik.tmp_ztob_sportbetssettled1 a
                where a.settlement_period = vPeriod_Id and leg_status = 'W'
                group by a.bet_id,a.entity_id,a.leaguecode,market_name,a.bet_type
                ) a
                inner join qlik.dim_product g on a.product_cd = g.product_cd
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) f on f.attrib_nm = a.marketname 
                inner join (select attrib_id,upper(attrib_cd) as attrib_cd,upper(attrib_nm) as attrib_nm from qlik.dim_attribute) h on h.attrib_cd = a.bettype
                where period_id = vPeriod_Id
                group by period_id,coalesce(entity_id,0),product_id,f.attrib_id,h.attrib_id;

                insert into qlik.tmp_fact_gl_balance (
                period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  activity_amt,
                  attrib1_id
                )
                /*LOTTERY No Of Draw*/
                select 
                                a.period_id,0 as entity_id,b.product_id,0 as cust_id,995 as acct_id,1 as attrib_id,no_of_draw as no_of_draw ,0 as attribute_1
                from
                (select cast(period_id as integer) as period_id,productname,count(*) as no_of_draw from (
                select distinct c.productname,drawnumber,to_char(business_date,'YYYYMM') as period_id from ztes_pdf_winnbr a
                inner join (select business_date,business_id from ztall_businessday where system = 'ES' and cast(to_char(business_date,'YYYYMM') as integer) = vPeriod_Id) b on a.drawcdc = b.business_id
                inner join (select cast(product as integer) as product,productname from ztall_product where producttype = 'Lottery' and productname <> 'SWEEP') c on a.productnum = c.product
                ) a
                group by cast(period_id as integer),productname) a
                inner join qlik.dim_product b on a.productname = b.product_cd

                union all
/*Customer Registration & Activations*/
                select vPeriod_Id,0 as entity_id,0 as product_id,0 as cust_id,982 as acct_id,1 as attrib_id,sum(current_count) as no_of_draw ,0 as attribute_1 from ( 
                SELECT
                case when cast(to_char(activation_date,'YYYYMM') as integer) = vPeriod_Id then 1 else 0 end as current_count,
                case when cast(to_char(activation_date,'YYYYMM') as integer) <= vPeriod_Id then 1 else 0 end as total_count
                FROM ztob_customer
                where status = 'A' and activation_date is not null and cast(to_char(activation_date,'YYYYMM') as integer) = vPeriod_Id) a
                having coalesce(sum(current_count),0) <> 0
                union all
                select vPeriod_Id,0 as entity_id,0 as product_id,0 as cust_id,983 as acct_id,1 as attrib_id,count(*) as no_of_draw ,0 as attribute_1 
                from ztob_customer
                where status = 'A' and cast(to_char(creation_date,'YYYYMM') as integer) = vPeriod_Id
                having coalesce(count(*),0) <> 0

                union all
/*Sweep 1st 2nd 3rd Winner*/
                select cast(to_char(x.business_date,'YYYYMM') as integer) as period_id,0 as entity_id,b.product_id,0 as cust_id,988 as acct_id,c.attrib_id,a.shrcount,0 as attribute_1
                from ztes_pdf_winshares a
                inner join qlik.dim_product b on b.product_cd = 'SWEEP'
                left join (select * from ztall_businessday where system = 'ES') x on x.business_id = a.drawcdc
                inner join qlik.dim_attribute c on c.attrib_id in (297,298,299) and cast(c.attribute1 as integer) = a.windiv_id
                where a.productname = 'swep' and a.windiv_id in (1,2,3) and cast(to_char(x.business_date,'YYYYMM') as integer) = vPeriod_Id

                union all

                select a.period_id,a.entity_id,a.product_id,a.cust_id,a.acct_id,a.value_type,a.activity_amt,a.attrib1_id
                from qlik.hist_fact_gl_balance a
                where a.acct_id = 988 and a.period_id = vPeriod_Id
                
                union all
/*TOTO Jackpot Amount*/
                SELECT d.period_id, 0 as entity_id, c.product_id,0 as cust_id, 987 as acct_id,rank() over (partition by d.period_id order by d.period_id,c.product_id,a.drawnumber) + 70 as attrib_id,a.pollforallocation/100,0 as attribute_1
                FROM ztes_pdf_winshares a
                inner join (select cast(product as integer) as productnum,productname from ztall_product
                where productname = 'TOTO') b on a.productnum = b.productnum
                left join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
                inner join qlik.dim_product c on c.product_cd = b.productname
                inner join qlik.dim_period d on d.period_id = cast(to_char(x.business_date,'YYYYMM') as integer)
                where windiv_id = 1 and d.period_id = vPeriod_Id

                union all
/*4D Payout Distribution*/
                SELECT a.period_id, 0 as entity_id, a.product_id,0 as cust_id, 996 as acct_id,a.attrib_id as attrib_id,(payout_amt/sales_amt) as payout_dist,0 as attribute_1
                from
                (select c.period_id,d.product_id,cast(coalesce(trim(a.draw_number),'0') as integer) as drawnumber,sum(a.debit_credit_amount) * -1 as sales_amt,
                rank() over (partition by c.period_id order by c.period_id,d.product_id,cast(coalesce(trim(a.draw_number),'0') as integer)) + 70 as attrib_id
                from ztsapfi_gl a
                inner join qlik.dim_account b on b.acct_fr = a.gl_account   
                inner join qlik.dim_period c on c.fiscal_year_period = a.fiscal_year_period
                inner join qlik.dim_product d on d.product_cd = a.sold_product
                where company_code = '2000' and acct_lvl5 = 'Sales' and sold_product = '4D' and a.debit_credit_amount < 0
                and coalesce(trim(a.draw_number),'0') not in ('0','') and c.period_id = vPeriod_Id
                group by c.period_id,cast(coalesce(trim(a.draw_number),'0') as integer),d.product_id) a
                inner join 
                (SELECT d.period_id,a.drawnumber,c.product_id,sum(a.totalamount/100) as payout_amt  FROM ztes_pdf_winshares a
                inner join (select cast(product as integer) as productnum,productname from ztall_product
                                where productname = '4D') b on a.productnum = b.productnum
                left join ztall_businessday x on x.business_id = a.drawcdc and x.system = 'ES'
                inner join qlik.dim_product c on c.product_cd = b.productname
                inner join qlik.dim_period d on d.period_id = cast(to_char(x.business_date,'YYYYMM') as integer)
                where d.period_id = vPeriod_Id
                group by d.period_id,a.drawnumber,c.product_id) b on a.period_id = b.period_id and a.product_id = b.product_id and a.drawnumber = b.drawnumber
                ;

                /*Remove Data For Reload*/
                delete from qlik.fact_gl_balance where period_id >= vPeriod_Id and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 = 'OT' and acct_desc not in ('FTE','Headcount') and acct_id <> 989);

                analyze qlik.fact_gl_balance;
                
                /*Insert into Fact table*/
                DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
                
                CREATE TABLE qlik.stg_fact_gl_balance
                (
                  period_id integer,
                  entity_id integer,
                  product_id integer,
                  cust_id integer,
                  acct_id integer,
                  value_type integer,
                  opening_amt numeric(13,2),
                  activity_amt numeric(13,2),
                  closing_amt numeric(13,2),
                  attrib1_id integer
                );
                
                /*Insert into Fact table*/
                insert into qlik.stg_fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select period_id, entity_id, product_id, cust_id, acct_id, value_type, sum(opening_amt), sum(activity_amt),sum(closing_amt),attrib1_id
                from (
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt
                                   ,a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id not in (988,987,996,989)
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null 
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all
                
                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(b.closing_amt,0.00)) as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(b.closing_amt,0.00)) + sum(coalesce(a.activity_amt,0.00)) as closing_amt
                                   ,a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                inner join qlik.fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vprevperid_id and a.attrib1_id = b.attrib1_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and b.acct_id not in (988,987,996,989) and c.acct_desc not in ('FTE','Headcount')
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by 
                a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   sum(coalesce(a.closing_amt,0.00)) as opening_amt, 0.00 as activity_amt, sum(coalesce(a.closing_amt,0.00)) as closing_amt
                                   ,a.attrib1_id
                from qlik.fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                left join qlik.tmp_fact_gl_balance b on b.entity_id = a.entity_id and b.product_id = a.product_id and b.cust_id = a.cust_id and b.acct_id = a.acct_id and b.value_type = a.value_type
                and b.period_id = vPeriod_Id and a.attrib1_id = b.attrib1_id
                where a.period_id = vprevperid_id and right(cast(vPeriod_Id as char(7)),2) <> '04' and  c.acct_lvl1 = 'OT' and a.acct_id not in (988,987,996,989) and c.acct_desc not in ('FTE','Headcount')
                and b.entity_id is null and b.product_id is null and b.cust_id is null and b.acct_id is null
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and right(cast(vPeriod_Id as char(7)),2) = '04' and  c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id not in (988,987,996,989)
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id

                union all

                select vPeriod_Id as period_id, a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type, 
                                   0.00 as opening_amt, sum(coalesce(a.activity_amt,0.00)) as activity_amt, sum(coalesce(a.activity_amt,0.00)) as closing_amt,a.attrib1_id
                from qlik.tmp_fact_gl_balance a
                inner join qlik.dim_account c on c.acct_id = a.acct_id
                where a.period_id = vPeriod_Id and c.acct_lvl1 = 'OT' and c.acct_desc not in ('FTE','Headcount') and a.acct_id in (988,987,996)
                and vPeriod_Id < cast(to_char(current_date,'YYYYMM')as integer)
                group by a.entity_id, a.product_id, a.cust_id, a.acct_id, a.value_type,a.attrib1_id
                
                ) a
                group by period_id, entity_id, product_id, cust_id, acct_id, value_type,attrib1_id
                having sum(opening_amt) + sum(activity_amt) + sum(closing_amt) <> 0;

                
                insert into qlik.fact_gl_balance (
                  period_id,
                  entity_id,
                  product_id,
                  cust_id,
                  acct_id,
                  value_type,
                  opening_amt,
                  activity_amt,
                  closing_amt,
                  attrib1_id
                )
                select * from qlik.stg_fact_gl_balance;

                analyze qlik.fact_gl_balance;
                                
END;
$$;


ALTER FUNCTION qlik.sp_load_betting_system_bk_20200118(vparperiod character) OWNER TO postgres;

--
-- TOC entry 1186 (class 1255 OID 24911)
-- Name: sp_one_time_job(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_one_time_job(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
	vprevperid_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) - interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
	vperiodplus1_id integer:= (select cast(to_char(cast('1-'|| period_short_nm as date) + interval '1 month' ,'YYYYMM') as integer) from qlik.dim_period where period_id = vperiod_id);
BEGIN


update qlik.dim_entity set dept_cd = '200910',dept_nm = 'OCB',attribute4 = 'OCB' where 
entity_nm like '%OCB%' and left(entity_cd,4) = '2009';

update qlik.dim_entity set attribute4 = 'KRC',attribute5 = 'Retailer',attribute6 = 'Terrestrial' where entity_cd like '2030%';


update qlik.dim_entity set attribute4 = 'KRC',attribute5 = 'Retailer',attribute6 = 'Terrestrial' where entity_nm like '%RACE%' and left(entity_cd,4) = '2009' and
entity_cd not in ('2009201000',
'2009201100');

update qlik.dim_entity set attribute4 = 'KRC' where entity_cd in ('2009201000',
'2009201100');


END;
$$;


ALTER FUNCTION qlik.sp_one_time_job(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1187 (class 1255 OID 24912)
-- Name: sp_online_lottery_breakdown(integer); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_online_lottery_breakdown(vperiod_id integer) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
	DROP TABLE IF EXISTS qlik.stg_fact_gl_balance;
	
	CREATE TABLE qlik.stg_fact_gl_balance
	(
		period_id integer,
		entity_id integer,
		product_id integer,
		cust_id integer,
		acct_id integer,
		value_type integer,
		opening_amt numeric(13,2),
		activity_amt numeric(13,2),
		closing_amt numeric(13,2),
		attrib1_id integer
	);


	insert into qlik.stg_fact_gl_balance (
		period_id,
		entity_id,
		product_id,
		cust_id,
		acct_id,
		value_type,
		opening_amt,
		activity_amt,
		closing_amt,
		attrib1_id
	)
	select period_id,entity_id,product_id,cust_id,acct_id,value_type,sum(opening_amt),sum(activity_amt),sum(closing_amt),attrib1_id 
	from (
		select a.period_id,b.entity_id,a.product_id,0 as cust_id,1 as acct_id,1 as value_type,sum(opening_amt)*-1 as opening_amt,
			sum(activity_amt)*-1 as activity_amt,sum(closing_amt)*-1 as closing_amt,999 as attrib1_id 
		from 
			qlik.fact_gl_balance a
			inner join (
				select entity_id,channel 
				from 
					qlik.dim_entity d
					inner join (select channel,case when (description='Phone') then 'Telebetting' else description end as description 
					from ztob_channels where channeltype = 'Online') c on d.entity_nm like '%'|| c.description ||'%'
			) b on b.entity_id = a.entity_id
			inner join (
				select product_id from qlik.dim_product where product_cd in ('4D','TOTO')
			) c on a.product_id = c.product_id
		where 
			period_id = vperiod_id and acct_id in (1,985) and a.value_type <> 2
		group by 
			a.period_id,b.entity_id,a.product_id
		union all
		select a.period_id,1022 as entity_id,a.product_id,0 as cust_id,1 as acct_id,1 as value_type,sum(opening_amt) as opening_amt,
			sum(activity_amt),sum(closing_amt),999 as attrib1_id 
		from 
			qlik.fact_gl_balance a
			inner join (
				select entity_id,channel 
				from 
					qlik.dim_entity d
					inner join (select channel,case when (description='Phone') then 'Telebetting' else description end as description 
						from ztob_channels where channeltype = 'Online') c on d.entity_nm like '%'|| c.description ||'%'
			) b on b.entity_id = a.entity_id
			inner join (
				select product_id from qlik.dim_product where product_cd in ('4D','TOTO')
			) c on a.product_id = c.product_id
		where 
			period_id = vperiod_id and acct_id in (1,985) and a.value_type <> 2
		group by 
			a.period_id,a.product_id
	) a
	group by 
		period_id,entity_id,product_id,cust_id,acct_id,value_type,attrib1_id;

	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id >= coalesce(vPeriod_Id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 in ('PL','BS')) and attrib1_id = 999 and value_type = 1;

	analyze qlik.fact_gl_balance;
	

	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select * from qlik.stg_fact_gl_balance;

	analyze qlik.fact_gl_balance;
END;
$$;


ALTER FUNCTION qlik.sp_online_lottery_breakdown(vperiod_id integer) OWNER TO sp_postgres;

--
-- TOC entry 1188 (class 1255 OID 24913)
-- Name: sp_other_income_accts(); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_other_income_accts() RETURNS void
    LANGUAGE plpgsql
    AS $$
declare

c_get_data cursor for
 	with tmp_other_income_accounts
		as (
			select zg.* , zm.gl_text  from public.ztsapfi_glhierarchy zg , public.ztsapfi_glmaster zm 
			where 1=1
			and zm.gl_account between zg.gl_range1 and zg.gl_range2 
			and gl_account_hierarchy = '20RP'
			and gl_level4 in ('Other Operating Income', 'Non-Operating Income/Expenses')
			and coalesce(gl_level5,'XXX')<> 'Others'
			and coalesce(gl_level6,'XXX') <> 'Non-Operating Expenses'
			and not exists (select 1 from qlik.dim_account a 
				where cast(zm.gl_account as integer) between cast(a.acct_fr as integer) and cast(a.acct_to as integer) 
				and acct_lvl5 = 'Other Income')
			order by gl_range1 )
		select 								
		0 as acct_id	,
		 tmp.gl_range1 acct_fr								
		, tmp.gl_range2 acct_to								
		, case when substring(cast(tmp.gl_range1 as varchar),1,1) IN ('1','2','3') then 'B'								
		     when substring(cast(tmp.gl_range1 as varchar),1,1) IN ('4','5') then 'R'								
		     when substring(cast(tmp.gl_range1 as varchar),1,1) IN ('6','7','8') then 'E'								
		  ELSE '' END acct_type								
		, case when substring(cast(tmp.gl_range1 as varchar),1,1) IN ('1','2','3') then 'BS'								
		     when substring(cast(tmp.gl_range1 as varchar),1,1) IN ('4','5','6','7','8') then 'PL'								
			ELSE '' END acct_lvl1							
		, case upper(tmp.gl_level2) when 'CURRENT ASSETS' THEN 'Assets'								
			when  'NON CURRENT ASSETS' THEN 'Assets'							
			when  'LIABILITIES' THEN 'Equity and Liabilities'							
			when  'EQUITY' THEN 'Equity and Liabilities'							
			else tmp.gl_level2 end acct_lvl2							
		, 'Operating Profit' acct_lvl3							
		, 'Operating Expenses' acct_lvl4							
		, 'Other Income' acct_lvl5							
		, case upper(tmp.gl_level2) when 'CURRENT ASSETS' THEN tmp.gl_level4								
			when 'NON CURRENT ASSETS' THEN tmp.gl_level4							
			when  'LIABILITIES' THEN tmp.gl_level5							
			when  'EQUITY' THEN tmp.gl_level5							
			else tmp.gl_level6 end acct_lvl6							
		, tmp.gl_text as acct_desc								
		, cast('CCA' as varchar) attribute1								
		, cast('CCA' as varchar) attribute2								
		from tmp_other_income_accounts tmp;

vseq_id integer;
rec qlik.dim_account%rowtype;	
	
Begin	

vseq_id := (select max(acct_id)+2 from qlik.dim_account) ;
	
open c_get_data ;
		loop
			fetch c_get_data into rec;
				exit when not found;
			
				insert into qlik.dim_account 
					(acct_id,acct_fr,acct_to,acct_type,acct_lvl1,acct_lvl2,acct_lvl3,acct_lvl4,acct_lvl5,acct_lvl6,acct_desc,attribute1,attribute2)
				values	(vseq_id, rec.acct_fr, rec.acct_to, rec.acct_type, rec.acct_lvl1, rec.acct_lvl2, rec.acct_lvl3
							, rec.acct_lvl4, rec.acct_lvl5, rec.acct_lvl6, rec.acct_desc, rec.attribute1, rec.attribute2);
				
				vseq_id := vseq_id+1;
			
		end loop;
	close c_get_data;	
	

END;
$$;


ALTER FUNCTION qlik.sp_other_income_accts() OWNER TO sp_postgres;

--
-- TOC entry 1189 (class 1255 OID 24914)
-- Name: sp_process_all(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_process_all(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
	perform qlik.sp_load_betting_system(vparperiod);
	perform qlik.sp_count_toto_draw_mix(vparperiod);
END;
$$;


ALTER FUNCTION qlik.sp_process_all(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1190 (class 1255 OID 24915)
-- Name: sp_project_expense(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_project_expense(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
	vperiod_id integer:= (select cast(vparperiod as integer));
BEGIN
	insert into qlik.dim_attribute (attrib_id,attrib_cd,attrib_nm,attribute1,attribute2,attribute3)
	select rank() over (order by project_nm) + b.attrib_id, trim('C' || lpad(cast(rank() over (order by project_nm) + c.attrib_cd as char(5)),5,'0')) ,a.* from (
	select a.project_nm, a.commitment_item,a.transformation,a.commence from qlik.stg_project_expense a
	left join (
	select * from qlik.dim_attribute
	where left(attrib_cd,1) = 'C'
	) b on upper(trim(left(b.attribute1,10))) = upper(trim(left(a.commitment_item,10)))
	where a.commitment_item is not null and b.attribute1 is null and period_id = vperiod_id
	union all
	select a.project_nm,a.commitment_item,a.transformation,a.commence from qlik.stg_project_expense a
	left join (
	select * from qlik.dim_attribute
	where left(attrib_cd,1) = 'C' 
	) b on upper(trim(b.attrib_nm)) = upper(trim(a.project_nm))
	where a.commitment_item is null and b.attrib_nm is null and period_id = vperiod_id) a
	inner join (select max(attrib_id) as attrib_id from qlik.dim_attribute where attrib_id <> 999) b on 1=1
	inner join (select cast(replace(max(attrib_cd),'C','') as integer) as attrib_cd from qlik.dim_attribute where left(attrib_cd,2) = 'C0') c on 1=1;

	update qlik.dim_attribute
	set
		attribute2 = a.transformation,
		attribute3 = a.commence
	from
		qlik.stg_project_expense a
	where
		upper(trim(left(dim_attribute.attribute1,10))) = upper(trim(left(a.commitment_item,10)))
		and a.commitment_item is not null and a.period_id = vperiod_id;

	update qlik.dim_attribute
	set
		attribute2 = a.transformation,
		attribute3 = a.commence
	from
		qlik.stg_project_expense a
	where
		upper(trim(dim_attribute.attrib_nm)) = upper(trim(a.project_nm))
		and a.commitment_item is null and a.period_id = vperiod_id;

	DROP TABLE IF EXISTS qlik.tmp_fact_gl_balance;

	CREATE TABLE qlik.tmp_fact_gl_balance
	(
	  period_id integer,
	  entity_id integer,
	  product_id integer,
	  cust_id integer,
	  acct_id integer,
	  value_type integer,
	  opening_amt numeric(13,2),
	  activity_amt numeric(13,2),
	  closing_amt numeric(13,2),
	  attrib1_id integer
	);
     

	insert into qlik.tmp_fact_gl_balance (
		 period_id,
		  entity_id,
		  product_id,
		  cust_id,
		  acct_id,
		  value_type,
		  activity_amt,
		  attrib1_id
		)
	select period_id,0 as entity_id,0 as product_id,0 as cust_id,801 as acct_id,coalesce(c.attrib_id,b.attrib_id),cf_amt as activity_amt,0 as attrib1_id from qlik.stg_project_expense a 
	left join qlik.dim_attribute b on upper(trim(b.attrib_nm)) = upper(trim(a.project_nm))
	left join qlik.dim_attribute c on upper(trim(left(c.attribute1,10))) = upper(trim(left(a.commitment_item,10)))
	where period_id = vperiod_id
	union all
	select period_id,0 as entity_id,0 as product_id,0 as cust_id,802 as acct_id,coalesce(c.attrib_id,b.attrib_id),new_amt,0 as attrib1_id from qlik.stg_project_expense a 
	left join qlik.dim_attribute b on upper(trim(b.attrib_nm)) = upper(trim(a.project_nm))
	left join qlik.dim_attribute c on upper(trim(left(c.attribute1,10))) = upper(trim(left(a.commitment_item,10)))
	where period_id = vperiod_id
	union all
	select period_id,0 as entity_id,0 as product_id,0 as cust_id,803 as acct_id,coalesce(c.attrib_id,b.attrib_id),residual_amt,0 as attrib1_id from qlik.stg_project_expense a 
	left join qlik.dim_attribute b on upper(trim(b.attrib_nm)) = upper(trim(a.project_nm))
	left join qlik.dim_attribute c on upper(trim(left(c.attribute1,10))) = upper(trim(left(a.commitment_item,10)))
	where period_id = vperiod_id
	union all
	select period_id,0 as entity_id,0 as product_id,0 as cust_id,804 as acct_id,coalesce(c.attrib_id,b.attrib_id),pr_amt,0 as attrib1_id from qlik.stg_project_expense a 
	left join qlik.dim_attribute b on upper(trim(b.attrib_nm)) = upper(trim(a.project_nm))
	left join qlik.dim_attribute c on upper(trim(left(c.attribute1,10))) = upper(trim(left(a.commitment_item,10)))
	where period_id = vperiod_id
	union all
	select period_id,0 as entity_id,0 as product_id,0 as cust_id,805 as acct_id,coalesce(c.attrib_id,b.attrib_id),po_amt,0 as attrib1_id from qlik.stg_project_expense a 
	left join qlik.dim_attribute b on upper(trim(b.attrib_nm)) = upper(trim(a.project_nm))
	left join qlik.dim_attribute c on upper(trim(left(c.attribute1,10))) = upper(trim(left(a.commitment_item,10)))
	where period_id = vperiod_id
	union all
	select period_id,0 as entity_id,0 as product_id,0 as cust_id,806 as acct_id,coalesce(c.attrib_id,b.attrib_id),invoice_amt,0 as attrib1_id from qlik.stg_project_expense a 
	left join qlik.dim_attribute b on upper(trim(b.attrib_nm)) = upper(trim(a.project_nm))
	left join qlik.dim_attribute c on upper(trim(left(c.attribute1,10))) = upper(trim(left(a.commitment_item,10)))
	where period_id = vperiod_id
	;
	
	/*Remove Data For Reload*/
	delete from qlik.fact_gl_balance where period_id = coalesce(vperiod_id,9999999) and acct_id in (select acct_id from qlik.dim_account where acct_lvl1 = 'CP') and 0 < (select count(*) from qlik.stg_project_expense);

	analyze qlik.fact_gl_balance;
	
	insert into qlik.fact_gl_balance (
	  period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  opening_amt,
	  activity_amt,
	  closing_amt,
	  attrib1_id
	)
	select period_id,
	  entity_id,
	  product_id,
	  cust_id,
	  acct_id,
	  value_type,
	  0 as opening_amt,
	  activity_amt,
	  activity_amt as closing_amt,
	  attrib1_id 
	 from qlik.tmp_fact_gl_balance;

	analyze qlik.fact_gl_balance;
END;
$$;


ALTER FUNCTION qlik.sp_project_expense(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 1220 (class 1255 OID 24916)
-- Name: sp_stg_employee(character); Type: FUNCTION; Schema: qlik; Owner: sp_postgres
--

CREATE FUNCTION qlik.sp_stg_employee(vparperiod character) RETURNS void
    LANGUAGE plpgsql
    AS $$

declare

	vperiod_id integer:= 
		(select 
			case 
				when cast(coalesce(vparperiod) as integer) = 0
				then (select period_id from qlik.dim_period where period_id = cast(to_char(current_date - interval '1' month,'YYYYMM') as integer) )
			else cast(coalesce(vparperiod) as integer) end )
	;

begin

delete from qlik.stg_employee where period_id = vperiod_id;

analyze qlik.stg_employee;

INSERT INTO qlik.stg_employee
	(period_id, employeeid, employeename, employeegroup, costcentercode, costcentername, noofworkinghours, 
	joiningdate, lastdayofservice, employmentstatus, repmonthyear, payroll_area, username)
select cast(coalesce(to_char(a."period" , 'YYYYMM')) as integer) as period_id
	, employee_id, employee_name, employee_group, cost_center_code, cost_center_name, number_of_working_hours, 
	joining_date, last_day_of_service, employment_status, '',  payroll_area, username
FROM public.ztsf_empdata a
where 1=1
and	cast(coalesce(to_char(a."period" , 'YYYYMM')) as integer) = vperiod_id
--a.employee_id  not in (select employee_id from public.ztsf_empdata b join qlik.stg_employee c on b.employee_id = c.employeeid )
;

end;

$$;


ALTER FUNCTION qlik.sp_stg_employee(vparperiod character) OWNER TO sp_postgres;

--
-- TOC entry 4965 (class 1417 OID 746894)
-- Name: pglog; Type: SERVER; Schema: -; Owner: postgres
--

CREATE SERVER pglog FOREIGN DATA WRAPPER file_fdw;


ALTER SERVER pglog OWNER TO postgres;

SET default_tablespace = '';

SET default_with_oids = false;

--
-- TOC entry 380 (class 1259 OID 24917)
-- Name: Invoicereport_test_29nov_02Dec; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public."Invoicereport_test_29nov_02Dec" (
    id character varying(100),
    productname character varying(100),
    amount numeric(32,11),
    flag character varying(20),
    "Type" character varying(25),
    idtype character(5)
);


ALTER TABLE public."Invoicereport_test_29nov_02Dec" OWNER TO consultant01;

--
-- TOC entry 912 (class 1259 OID 1569951)
-- Name: audit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.audit (
    audit_id integer NOT NULL,
    user_id character varying(7) NOT NULL,
    audit_timestamp timestamp without time zone NOT NULL,
    accessed_report_id integer NOT NULL
);


ALTER TABLE public.audit OWNER TO sp_postgres;

--
-- TOC entry 911 (class 1259 OID 1569949)
-- Name: audit_audit_id_seq; Type: SEQUENCE; Schema: public; Owner: sp_postgres
--

CREATE SEQUENCE public.audit_audit_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE public.audit_audit_id_seq OWNER TO sp_postgres;

--
-- TOC entry 7808 (class 0 OID 0)
-- Dependencies: 911
-- Name: audit_audit_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sp_postgres
--

ALTER SEQUENCE public.audit_audit_id_seq OWNED BY public.audit.audit_id;


--
-- TOC entry 905 (class 1259 OID 1569913)
-- Name: category; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.category (
    category_id integer NOT NULL,
    category_name character varying(256) NOT NULL
);


ALTER TABLE public.category OWNER TO sp_postgres;

--
-- TOC entry 904 (class 1259 OID 1569911)
-- Name: category_category_id_seq; Type: SEQUENCE; Schema: public; Owner: sp_postgres
--

CREATE SEQUENCE public.category_category_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE public.category_category_id_seq OWNER TO sp_postgres;

--
-- TOC entry 7809 (class 0 OID 0)
-- Dependencies: 904
-- Name: category_category_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sp_postgres
--

ALTER SEQUENCE public.category_category_id_seq OWNED BY public.category.category_id;


--
-- TOC entry 899 (class 1259 OID 1567561)
-- Name: city; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.city (
    city_id integer NOT NULL,
    city_name character varying(256) NOT NULL,
    state character varying(32) NOT NULL,
    population integer NOT NULL
);


ALTER TABLE public.city OWNER TO sp_postgres;

--
-- TOC entry 898 (class 1259 OID 1567559)
-- Name: city_city_id_seq; Type: SEQUENCE; Schema: public; Owner: sp_postgres
--

CREATE SEQUENCE public.city_city_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE public.city_city_id_seq OWNER TO sp_postgres;

--
-- TOC entry 7810 (class 0 OID 0)
-- Dependencies: 898
-- Name: city_city_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sp_postgres
--

ALTER SEQUENCE public.city_city_id_seq OWNED BY public.city.city_id;


--
-- TOC entry 381 (class 1259 OID 24920)
-- Name: converttosgt; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.converttosgt (
    "?column?" double precision
);


ALTER TABLE public.converttosgt OWNER TO consultant01;

--
-- TOC entry 382 (class 1259 OID 24923)
-- Name: daily_etl_job_status; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.daily_etl_job_status (
    id integer NOT NULL,
    system character varying,
    jobname character varying,
    status character varying,
    "timestamp" character varying
);


ALTER TABLE public.daily_etl_job_status OWNER TO sp_postgres;

--
-- TOC entry 383 (class 1259 OID 24929)
-- Name: daily_etl_job_status_id_seq; Type: SEQUENCE; Schema: public; Owner: sp_postgres
--

CREATE SEQUENCE public.daily_etl_job_status_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE public.daily_etl_job_status_id_seq OWNER TO sp_postgres;

--
-- TOC entry 7812 (class 0 OID 0)
-- Dependencies: 383
-- Name: daily_etl_job_status_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sp_postgres
--

ALTER SEQUENCE public.daily_etl_job_status_id_seq OWNED BY public.daily_etl_job_status.id;


--
-- TOC entry 908 (class 1259 OID 1569928)
-- Name: district; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.district (
    district_number integer NOT NULL
);


ALTER TABLE public.district OWNER TO sp_postgres;

--
-- TOC entry 907 (class 1259 OID 1569926)
-- Name: district_district_number_seq; Type: SEQUENCE; Schema: public; Owner: sp_postgres
--

CREATE SEQUENCE public.district_district_number_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE public.district_district_number_seq OWNER TO sp_postgres;

--
-- TOC entry 7813 (class 0 OID 0)
-- Dependencies: 907
-- Name: district_district_number_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sp_postgres
--

ALTER SEQUENCE public.district_district_number_seq OWNED BY public.district.district_number;


--
-- TOC entry 909 (class 1259 OID 1569934)
-- Name: emp_user; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.emp_user (
    user_id character varying(7) NOT NULL,
    ssn character varying(64) NOT NULL,
    first_name character varying(256) NOT NULL,
    last_name character varying(256) NOT NULL,
    audit_view_enabled boolean NOT NULL
);


ALTER TABLE public.emp_user OWNER TO sp_postgres;

--
-- TOC entry 384 (class 1259 OID 24931)
-- Name: fromdate; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.fromdate (
    "?column?" timestamp without time zone
);


ALTER TABLE public.fromdate OWNER TO consultant01;

--
-- TOC entry 902 (class 1259 OID 1569901)
-- Name: holiday; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.holiday (
    holiday_date date NOT NULL,
    holiday_name character varying(256) NOT NULL,
    creator_user_id character varying(7) NOT NULL
);


ALTER TABLE public.holiday OWNER TO sp_postgres;

--
-- TOC entry 980 (class 1259 OID 1916685)
-- Name: iris_load_config; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.iris_load_config (
    business_date date NOT NULL,
    from_date_time timestamp without time zone NOT NULL,
    to_date_time timestamp without time zone NOT NULL,
    raw_zone_status character varying(20),
    raw_file_name character varying(100) NOT NULL,
    etl_run_time timestamp without time zone,
    created_date timestamp without time zone,
    last_updated_date timestamp without time zone,
    remarks character varying
);


ALTER TABLE public.iris_load_config OWNER TO sp_postgres;

--
-- TOC entry 385 (class 1259 OID 24934)
-- Name: locInvoice_22nov; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public."locInvoice_22nov" (
    interfacedata character varying(766)
);


ALTER TABLE public."locInvoice_22nov" OWNER TO consultant01;

--
-- TOC entry 386 (class 1259 OID 24940)
-- Name: main_query; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.main_query (
    ticketserialnumber character varying(200),
    tranheaderid character varying(50),
    entrymethodid character varying(10),
    deviceid character varying(100),
    prodid integer,
    isbetrejectedbytrader boolean,
    isexchangeticket boolean,
    terdisplayid character varying(100),
    transactiontypetotal bigint
);


ALTER TABLE public.main_query OWNER TO consultant01;

--
-- TOC entry 825 (class 1259 OID 214425)
-- Name: mt940_file_status; Type: TABLE; Schema: public; Owner: sp_sapfin
--

CREATE TABLE public.mt940_file_status (
    status_id bigint NOT NULL,
    mt940_file_name character varying(100),
    matching_status character varying(10),
    sapfin_status character varying(10)
);


ALTER TABLE public.mt940_file_status OWNER TO sp_sapfin;

--
-- TOC entry 824 (class 1259 OID 214423)
-- Name: mt940_file_status_status_id_seq; Type: SEQUENCE; Schema: public; Owner: sp_sapfin
--

CREATE SEQUENCE public.mt940_file_status_status_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE public.mt940_file_status_status_id_seq OWNER TO sp_sapfin;

--
-- TOC entry 7814 (class 0 OID 0)
-- Dependencies: 824
-- Name: mt940_file_status_status_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sp_sapfin
--

ALTER SEQUENCE public.mt940_file_status_status_id_seq OWNED BY public.mt940_file_status.status_id;


--
-- TOC entry 831 (class 1259 OID 403987)
-- Name: nyx_01_lotteryactive_dm; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_01_lotteryactive_dm (
    monthyearbizdate text,
    business_date timestamp without time zone,
    bet_nm character varying(64),
    product_id character varying(5),
    collection double precision,
    draw_date timestamp without time zone,
    channel_id character varying(1),
    channel_name character varying(30),
    channel_type character varying(30),
    product_name character varying(30),
    product_type character varying(30),
    draw_num integer,
    bet_count bigint,
    customer_count bigint
);


ALTER TABLE public.nyx_01_lotteryactive_dm OWNER TO sp_postgres;

--
-- TOC entry 838 (class 1259 OID 405258)
-- Name: nyx_01_lotteryccl_dm; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_01_lotteryccl_dm (
    monthyearbizdate text,
    business_date timestamp without time zone,
    bet_name character varying(64),
    channel_id character varying(1),
    channel_name character varying(30),
    channel_type character varying(30),
    product_id character varying(5),
    product_name character varying(30),
    product_type character varying(30),
    draw_num integer,
    draw_date timestamp without time zone,
    collection double precision,
    bet_count bigint,
    customer_count bigint
);


ALTER TABLE public.nyx_01_lotteryccl_dm OWNER TO sp_postgres;

--
-- TOC entry 836 (class 1259 OID 405163)
-- Name: nyx_auto_job_entry_log; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_auto_job_entry_log (
    id_batch integer,
    channel_id character varying(255),
    log_date timestamp without time zone,
    transname character varying(255),
    stepname character varying(255),
    lines_read bigint,
    lines_written bigint,
    lines_updated bigint,
    lines_input bigint,
    lines_output bigint,
    lines_rejected bigint,
    errors bigint,
    "RESULT" boolean,
    nr_result_rows bigint,
    nr_result_files bigint
);


ALTER TABLE public.nyx_auto_job_entry_log OWNER TO sp_postgres;

--
-- TOC entry 837 (class 1259 OID 405170)
-- Name: nyx_auto_job_log; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_auto_job_log (
    id_job integer,
    channel_id character varying(255),
    jobname character varying(255),
    status character varying(15),
    lines_read bigint,
    lines_written bigint,
    lines_updated bigint,
    lines_input bigint,
    lines_output bigint,
    lines_rejected bigint,
    errors bigint,
    startdate timestamp without time zone,
    enddate timestamp without time zone,
    logdate timestamp without time zone,
    depdate timestamp without time zone,
    replaydate timestamp without time zone,
    log_field text
);


ALTER TABLE public.nyx_auto_job_log OWNER TO sp_postgres;

--
-- TOC entry 833 (class 1259 OID 404144)
-- Name: nyx_auto_step_log; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_auto_step_log (
    id_batch integer,
    channel_id character varying(255),
    log_date timestamp without time zone,
    transname character varying(255),
    stepname character varying(255),
    step_copy smallint,
    lines_read bigint,
    lines_written bigint,
    lines_updated bigint,
    lines_input bigint,
    lines_output bigint,
    lines_rejected bigint,
    errors bigint
);


ALTER TABLE public.nyx_auto_step_log OWNER TO sp_postgres;

--
-- TOC entry 832 (class 1259 OID 404136)
-- Name: nyx_auto_trans_log; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_auto_trans_log (
    id_batch integer,
    channel_id character varying(255),
    transname character varying(255),
    status character varying(15),
    lines_read bigint,
    lines_written bigint,
    lines_updated bigint,
    lines_input bigint,
    lines_output bigint,
    lines_rejected bigint,
    errors bigint,
    startdate timestamp without time zone,
    enddate timestamp without time zone,
    logdate timestamp without time zone,
    depdate timestamp without time zone,
    replaydate timestamp without time zone,
    log_field text
);


ALTER TABLE public.nyx_auto_trans_log OWNER TO sp_postgres;

--
-- TOC entry 834 (class 1259 OID 405111)
-- Name: nyx_laststepmetrics; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_laststepmetrics (
    log_datetime text,
    trans_name text,
    step_name text,
    step_id text,
    lines_input bigint,
    lines_output bigint,
    duration double precision
);


ALTER TABLE public.nyx_laststepmetrics OWNER TO sp_postgres;

--
-- TOC entry 839 (class 1259 OID 405372)
-- Name: nyx_laststepmetrics2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_laststepmetrics2 (
    systemdate timestamp without time zone,
    startdate timestamp without time zone,
    enddate timestamp without time zone,
    transbatchid bigint,
    log_datetime text,
    trans_name text,
    step_name text,
    step_id character varying(200),
    lines_input bigint,
    lines_output bigint,
    duration double precision
);


ALTER TABLE public.nyx_laststepmetrics2 OWNER TO sp_postgres;

--
-- TOC entry 835 (class 1259 OID 405124)
-- Name: nyx_trans_status; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_trans_status (
    trans_name text,
    log_datetime text,
    in_stepname text,
    out_stepname text,
    in_count bigint,
    out_count bigint,
    trans_status integer
);


ALTER TABLE public.nyx_trans_status OWNER TO sp_postgres;

--
-- TOC entry 840 (class 1259 OID 405421)
-- Name: nyx_trans_status2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_trans_status2 (
    trans_name text,
    startdate timestamp without time zone,
    enddate timestamp without time zone,
    in_stepname text,
    out_stepname text,
    in_count bigint,
    out_count bigint,
    trans_status integer
);


ALTER TABLE public.nyx_trans_status2 OWNER TO sp_postgres;

--
-- TOC entry 844 (class 1259 OID 487644)
-- Name: nyx_ztob_exclusionhistory; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.nyx_ztob_exclusionhistory (
    account_no character varying(32),
    exclude_record_id integer,
    exclusion_type character varying(40),
    exclusion_status character varying(19),
    note character varying(255),
    last_updated_date timestamp without time zone,
    remark character varying(20),
    exclusion_from_date timestamp without time zone,
    exclusion_to_date timestamp without time zone
);


ALTER TABLE public.nyx_ztob_exclusionhistory OWNER TO sp_postgres;

--
-- TOC entry 387 (class 1259 OID 24943)
-- Name: orphanbets; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.orphanbets (
    requestid integer,
    operatorid text,
    terminalid integer,
    locationid integer,
    transtime timestamp without time zone,
    product text,
    transtype text,
    board_id integer,
    board_desc text,
    draws_draw integer,
    transamt0 double precision,
    transamt1 double precision,
    bettyp integer,
    fracwagerinfo_numfrac integer,
    partialwagerinfo_syndid integer
);


ALTER TABLE public.orphanbets OWNER TO sp_postgres;

--
-- TOC entry 388 (class 1259 OID 24949)
-- Name: pg_prd_test_gtamt_detail_20220122; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.pg_prd_test_gtamt_detail_20220122 (
    terdisplayid bigint,
    prodname character varying(100),
    flag character varying(3),
    amount numeric(28,2),
    ticketcount bigint,
    actualdate text,
    transtype character varying(2)
);


ALTER TABLE public.pg_prd_test_gtamt_detail_20220122 OWNER TO sp_postgres;

--
-- TOC entry 389 (class 1259 OID 24955)
-- Name: pg_prd_test_gtamt_detail_20220126; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.pg_prd_test_gtamt_detail_20220126 (
    terdisplayid bigint,
    prodname character varying(50),
    flag character varying(3),
    ticketcount bigint,
    actualdate text,
    transtype character varying(2),
    amount numeric(30,2)
);


ALTER TABLE public.pg_prd_test_gtamt_detail_20220126 OWNER TO sp_postgres;

--
-- TOC entry 390 (class 1259 OID 24961)
-- Name: pg_prd_test_gtamtr_20220122; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.pg_prd_test_gtamtr_20220122 (
    ticketserialnumber character varying(100),
    wager numeric(26,12),
    secondwager numeric(26,12),
    sales numeric(30,12),
    secondsales numeric(28,12),
    salescomm numeric(28,12),
    secondsalescomm numeric(26,12),
    gst numeric(28,12),
    secondgst numeric(27,12),
    returnamount numeric(26,12),
    winningamount numeric(26,12)
);


ALTER TABLE public.pg_prd_test_gtamtr_20220122 OWNER TO sp_postgres;

--
-- TOC entry 391 (class 1259 OID 24964)
-- Name: pg_prd_test_gtamtr_20220126; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.pg_prd_test_gtamtr_20220126 (
    ticketserialnumber character varying(100),
    wager numeric(28,12),
    secondwager numeric(28,12),
    sales numeric(30,12),
    secondsales numeric(28,12),
    salescomm numeric(28,12),
    secondsalescomm numeric(26,12),
    gst numeric(28,12),
    secondgst numeric(27,12),
    returnamount numeric(28,12),
    winningamount numeric(28,12)
);


ALTER TABLE public.pg_prd_test_gtamtr_20220126 OWNER TO sp_postgres;

--
-- TOC entry 392 (class 1259 OID 24967)
-- Name: pg_prd_test_gtamtr_csv; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.pg_prd_test_gtamtr_csv (
    ticketserialnumber character varying(44),
    wager double precision,
    secondwager double precision,
    sales double precision,
    secondsales double precision,
    salescomm double precision,
    secondsalescomm double precision,
    gst double precision,
    secondgst double precision,
    returnamount double precision,
    winningamount integer
);


ALTER TABLE public.pg_prd_test_gtamtr_csv OWNER TO consultant01;

--
-- TOC entry 860 (class 1259 OID 746895)
-- Name: postgres_log; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.postgres_log (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
);


ALTER TABLE public.postgres_log OWNER TO postgres;

--
-- TOC entry 865 (class 1259 OID 746917)
-- Name: postgres_log_fri; Type: FOREIGN TABLE; Schema: public; Owner: postgres
--

CREATE FOREIGN TABLE public.postgres_log_fri (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-Fri.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.postgres_log_fri OWNER TO postgres;

--
-- TOC entry 861 (class 1259 OID 746901)
-- Name: postgres_log_mon; Type: FOREIGN TABLE; Schema: public; Owner: postgres
--

CREATE FOREIGN TABLE public.postgres_log_mon (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-Mon.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.postgres_log_mon OWNER TO postgres;

--
-- TOC entry 866 (class 1259 OID 746920)
-- Name: postgres_log_sat; Type: FOREIGN TABLE; Schema: public; Owner: postgres
--

CREATE FOREIGN TABLE public.postgres_log_sat (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-Sat.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.postgres_log_sat OWNER TO postgres;

--
-- TOC entry 867 (class 1259 OID 746923)
-- Name: postgres_log_sun; Type: FOREIGN TABLE; Schema: public; Owner: postgres
--

CREATE FOREIGN TABLE public.postgres_log_sun (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-Sun.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.postgres_log_sun OWNER TO postgres;

--
-- TOC entry 864 (class 1259 OID 746914)
-- Name: postgres_log_thu; Type: FOREIGN TABLE; Schema: public; Owner: postgres
--

CREATE FOREIGN TABLE public.postgres_log_thu (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-Thu.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.postgres_log_thu OWNER TO postgres;

--
-- TOC entry 862 (class 1259 OID 746908)
-- Name: postgres_log_tue; Type: FOREIGN TABLE; Schema: public; Owner: postgres
--

CREATE FOREIGN TABLE public.postgres_log_tue (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-Tue.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.postgres_log_tue OWNER TO postgres;

--
-- TOC entry 863 (class 1259 OID 746911)
-- Name: postgres_log_wed; Type: FOREIGN TABLE; Schema: public; Owner: postgres
--

CREATE FOREIGN TABLE public.postgres_log_wed (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-Wed.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.postgres_log_wed OWNER TO postgres;

--
-- TOC entry 900 (class 1259 OID 1569888)
-- Name: product; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.product (
    product_id character varying(64) NOT NULL,
    product_name character varying(256) NOT NULL,
    manufacturer_name character varying(256) NOT NULL,
    retail_price double precision NOT NULL
);


ALTER TABLE public.product OWNER TO sp_postgres;

--
-- TOC entry 901 (class 1259 OID 1569896)
-- Name: product_category_mapping; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.product_category_mapping (
    product_id character varying(64) NOT NULL,
    category_id integer NOT NULL
);


ALTER TABLE public.product_category_mapping OWNER TO sp_postgres;

--
-- TOC entry 903 (class 1259 OID 1569906)
-- Name: product_discount_mapping; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.product_discount_mapping (
    product_id character varying(64) NOT NULL,
    discount_date date NOT NULL,
    discount_price double precision NOT NULL
);


ALTER TABLE public.product_discount_mapping OWNER TO sp_postgres;

--
-- TOC entry 914 (class 1259 OID 1569959)
-- Name: report; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.report (
    report_id integer NOT NULL,
    report_name character varying(256) NOT NULL
);


ALTER TABLE public.report OWNER TO sp_postgres;

--
-- TOC entry 913 (class 1259 OID 1569957)
-- Name: report_report_id_seq; Type: SEQUENCE; Schema: public; Owner: sp_postgres
--

CREATE SEQUENCE public.report_report_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE public.report_report_id_seq OWNER TO sp_postgres;

--
-- TOC entry 7818 (class 0 OID 0)
-- Dependencies: 913
-- Name: report_report_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sp_postgres
--

ALTER SEQUENCE public.report_report_id_seq OWNED BY public.report.report_id;


--
-- TOC entry 823 (class 1259 OID 197241)
-- Name: reptest; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.reptest (
    id integer,
    name character varying
);


ALTER TABLE public.reptest OWNER TO postgres;

--
-- TOC entry 393 (class 1259 OID 24970)
-- Name: rtpos_ubt_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.rtpos_ubt_test (
    businessdate timestamp without time zone,
    producttype text,
    payoutamt numeric(17,2),
    buffer1 text,
    refundamt numeric(17,2),
    buffer2 text,
    txndate timestamp without time zone
);


ALTER TABLE public.rtpos_ubt_test OWNER TO sp_postgres;

--
-- TOC entry 394 (class 1259 OID 24976)
-- Name: rtshop_ubt_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.rtshop_ubt_test (
    idmmbusinessday text,
    businessdate timestamp without time zone,
    itemid text,
    transactionid text,
    documentdate timestamp without time zone,
    linecode text,
    sapdoctype text,
    sappostingkey text,
    sapcontrolacctcode text,
    description text,
    glnumber text,
    saptaxcode text,
    saptaxbaseamount double precision,
    cccode text,
    sapassignment text,
    currencycode text,
    amount double precision,
    product text,
    drawnumber text,
    customer text
);


ALTER TABLE public.rtshop_ubt_test OWNER TO sp_postgres;

--
-- TOC entry 906 (class 1259 OID 1569921)
-- Name: sale; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.sale (
    product_id character varying(64) NOT NULL,
    sale_date date NOT NULL,
    store_number integer NOT NULL,
    quantity integer NOT NULL
);


ALTER TABLE public.sale OWNER TO sp_postgres;

--
-- TOC entry 395 (class 1259 OID 24982)
-- Name: sp_gettransamountdetail_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.sp_gettransamountdetail_test (
    terdisplayid character varying(50),
    prodname character varying(50),
    amount numeric,
    ct integer,
    flag character varying(3),
    transtype character varying(3),
    fromdate timestamp without time zone,
    todate timestamp without time zone
);


ALTER TABLE public.sp_gettransamountdetail_test OWNER TO sp_postgres;

--
-- TOC entry 931 (class 1259 OID 1837172)
-- Name: status_pnric; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.status_pnric (
    sp_ubt_getpaynowsuccessstatus text[]
);


ALTER TABLE public.status_pnric OWNER TO sp_postgres;

--
-- TOC entry 396 (class 1259 OID 24988)
-- Name: stg_mt940_dbs_um; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.stg_mt940_dbs_um (
    bank_name text,
    bank_account_no double precision,
    value_separator text,
    statement_no double precision,
    sequence_no double precision,
    separator1 text,
    value_date timestamp without time zone,
    entry_date timestamp without time zone,
    dc_mark text,
    amount double precision,
    transaction_code text,
    batch_id text,
    fund_code text,
    ref_account_owner text,
    ref_account_service_institution text,
    hardcode_carriage_return text,
    supplementary_details text,
    narrative text,
    file_name text,
    processed_done text,
    uploaded_done text
);


ALTER TABLE public.stg_mt940_dbs_um OWNER TO sp_postgres;

--
-- TOC entry 897 (class 1259 OID 1567545)
-- Name: store; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.store (
    store_number integer NOT NULL,
    phone_number character varying(32) NOT NULL,
    district_number integer NOT NULL,
    city_id integer NOT NULL
);


ALTER TABLE public.store OWNER TO sp_postgres;

--
-- TOC entry 397 (class 1259 OID 24994)
-- Name: temp_loc_02nov; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_loc_02nov (
    interfacedata character varying(766)
);


ALTER TABLE public.temp_loc_02nov OWNER TO consultant01;

--
-- TOC entry 398 (class 1259 OID 25000)
-- Name: temp_locationinvoice; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_locationinvoice (
    interfacedata character varying(766)
);


ALTER TABLE public.temp_locationinvoice OWNER TO consultant01;

--
-- TOC entry 399 (class 1259 OID 25006)
-- Name: temp_pbt; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_pbt (
    ticketserialnumber character varying(200),
    tranheaderid character varying(50),
    entrymethodid character varying(10),
    deviceid character varying(100),
    prodid integer,
    isbetrejectedbytrader boolean,
    isexchangeticket boolean,
    terdisplayid character varying(100),
    transactiontypetotal bigint
);


ALTER TABLE public.temp_pbt OWNER TO consultant01;

--
-- TOC entry 400 (class 1259 OID 25009)
-- Name: temp_place_bet_transaction; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_place_bet_transaction (
    ticketserialnumber character varying(200),
    tranheaderid character varying(50),
    entrymethodid character varying(10),
    deviceid character varying(100),
    prodid integer,
    isbetrejectedbytrader boolean,
    isexchangeticket boolean,
    terdisplayid character varying(100),
    createddate timestamp without time zone,
    requestid character varying(40),
    userdisplayid character varying(40),
    cartid character varying(50),
    transactiontype integer
);


ALTER TABLE public.temp_place_bet_transaction OWNER TO consultant01;

--
-- TOC entry 401 (class 1259 OID 25015)
-- Name: temp_table_trf; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_table_trf (
    to_date timestamp without time zone,
    from_date timestamp without time zone,
    update_date timestamp without time zone,
    year1 character varying,
    month1 character varying,
    day1 character varying,
    partition_date1 character varying(30),
    table_name character varying
);


ALTER TABLE public.temp_table_trf OWNER TO consultant01;

--
-- TOC entry 402 (class 1259 OID 25021)
-- Name: temp_terminal_invoice_22nov; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_terminal_invoice_22nov (
    interfacedata character varying(696)
);


ALTER TABLE public.temp_terminal_invoice_22nov OWNER TO consultant01;

--
-- TOC entry 403 (class 1259 OID 25027)
-- Name: temp_terminal_invoice_23nov; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_terminal_invoice_23nov (
    interfacedata character varying(696)
);


ALTER TABLE public.temp_terminal_invoice_23nov OWNER TO consultant01;

--
-- TOC entry 404 (class 1259 OID 25033)
-- Name: temp_terminal_invoice_24nov; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_terminal_invoice_24nov (
    interfacedata character varying(696)
);


ALTER TABLE public.temp_terminal_invoice_24nov OWNER TO consultant01;

--
-- TOC entry 405 (class 1259 OID 25039)
-- Name: temp_tt; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_tt (
    hostdrawdatesid bigint
);


ALTER TABLE public.temp_tt OWNER TO consultant01;

--
-- TOC entry 406 (class 1259 OID 25042)
-- Name: temp_ztubt_interval; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.temp_ztubt_interval (
    table_name character varying(60),
    raw_run_no integer,
    ubtsourcetable character varying(100),
    ubtextractionfield character varying(100),
    ztubt_extract_field character varying(50)
);


ALTER TABLE public.temp_ztubt_interval OWNER TO consultant01;

--
-- TOC entry 1027 (class 1259 OID 2478041)
-- Name: test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test (
    account_no character varying(32),
    channel character varying(1),
    last_updated_date timestamp without time zone,
    sum_stakes numeric(12,2),
    sum_cust_income numeric(12,2),
    sum_pools_return numeric(12,2),
    sum_cust_refunds numeric(12,2),
    bet_count numeric(32,0),
    sum_unsettlement_stakes numeric(12,2),
    sum_unsettlement_cust_income numeric(12,2),
    sum_unsettlement_pools_return numeric(12,2),
    sum_unsettlement_cust_refunds numeric(12,2),
    sum_unsettlement_bet_count numeric(32,0)
);


ALTER TABLE public.test OWNER TO sp_postgres;

--
-- TOC entry 981 (class 1259 OID 1953906)
-- Name: test11; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test11 (
    a integer,
    b character varying(1)
);


ALTER TABLE public.test11 OWNER TO sp_postgres;

--
-- TOC entry 985 (class 1259 OID 1998340)
-- Name: test2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test2 (
    validationdate timestamp without time zone,
    createdvalidationdate timestamp without time zone
);


ALTER TABLE public.test2 OWNER TO sp_postgres;

--
-- TOC entry 821 (class 1259 OID 164234)
-- Name: test_ha; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ha (
    c1 integer,
    c2 character(1)
);


ALTER TABLE public.test_ha OWNER TO sp_postgres;

--
-- TOC entry 869 (class 1259 OID 886226)
-- Name: test_load; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.test_load (
    chainhead character varying,
    locationid character varying,
    locationname character varying,
    productname character varying,
    invoicedate text,
    salescomamount numeric,
    gstcomamount numeric,
    adjsalescom numeric,
    adjgstcom numeric
);


ALTER TABLE public.test_load OWNER TO postgres;

--
-- TOC entry 982 (class 1259 OID 1975366)
-- Name: test_lsr_issue_table; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_lsr_issue_table (
    cdc integer,
    prod integer,
    tratrmidn bigint,
    traagt bigint,
    tratyp integer,
    draws_draw integer,
    channeltype text,
    channelsubtype text,
    transamt double precision,
    saleamt double precision,
    commamt double precision
);


ALTER TABLE public.test_lsr_issue_table OWNER TO sp_postgres;

--
-- TOC entry 822 (class 1259 OID 181615)
-- Name: test_prod_connection; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.test_prod_connection (
    recoreded_ts timestamp with time zone,
    datname name,
    usename name,
    application_name text,
    conn_count bigint
);


ALTER TABLE public.test_prod_connection OWNER TO postgres;

--
-- TOC entry 407 (class 1259 OID 25048)
-- Name: test_salescommrpt_ubt04FEB; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public."test_salescommrpt_ubt04FEB" (
    chainhead character varying(200),
    locationid character varying(200),
    locationname character varying(200),
    productname character varying(100),
    invoicedate character varying(100),
    salescomamount double precision,
    gstcomamount double precision,
    adjsalescom double precision,
    adjgstcom double precision
);


ALTER TABLE public."test_salescommrpt_ubt04FEB" OWNER TO sp_postgres;

--
-- TOC entry 408 (class 1259 OID 25054)
-- Name: test_salescommrpt_ubt04oct; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_salescommrpt_ubt04oct (
    chainhead character varying(200),
    locationid character varying(200),
    locationname character varying(200),
    productname character varying(100),
    invoicedate character varying(100),
    salescomamount double precision,
    gstcomamount double precision,
    adjsalescom double precision,
    adjgstcom double precision
);


ALTER TABLE public.test_salescommrpt_ubt04oct OWNER TO sp_postgres;

--
-- TOC entry 826 (class 1259 OID 216791)
-- Name: test_sun; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_sun (
    climit numeric(5,2)
);


ALTER TABLE public.test_sun OWNER TO sp_postgres;

--
-- TOC entry 848 (class 1259 OID 591732)
-- Name: test_toto_ztubt; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.test_toto_ztubt (
    lineitemnumberid bigint,
    tranlineitemid character varying(50),
    sequence integer,
    singlebetnumber integer,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.test_toto_ztubt OWNER TO postgres;

--
-- TOC entry 409 (class 1259 OID 25060)
-- Name: test_trans_data; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.test_trans_data (
    interfacedata character varying(10485760)
);


ALTER TABLE public.test_trans_data OWNER TO consultant01;

--
-- TOC entry 410 (class 1259 OID 25066)
-- Name: test_trans_data_interface; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.test_trans_data_interface (
    interfacedata character varying(10485760)
);


ALTER TABLE public.test_trans_data_interface OWNER TO consultant01;

--
-- TOC entry 411 (class 1259 OID 25072)
-- Name: test_transdata; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.test_transdata (
    terdisplayid character varying(200),
    prodname character varying(100),
    amount numeric(32,11),
    ct integer,
    flag character(3),
    transtype character(2),
    fromdate timestamp(3) without time zone,
    todate timestamp(3) without time zone
);


ALTER TABLE public.test_transdata OWNER TO consultant01;

--
-- TOC entry 412 (class 1259 OID 25075)
-- Name: test_ubt_dailysummarychain_03nov; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ubt_dailysummarychain_03nov (
    typeid character(4),
    id character varying(100),
    productname character varying(100),
    amount numeric(32,11),
    flag character varying(50)
);


ALTER TABLE public.test_ubt_dailysummarychain_03nov OWNER TO sp_postgres;

--
-- TOC entry 413 (class 1259 OID 25078)
-- Name: test_ubt_get_amt_trx_03nov; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ubt_get_amt_trx_03nov (
    ticketserialnumber character varying(500),
    wager numeric(22,2),
    secondwager numeric(22,2),
    sales numeric(22,11),
    secondsales numeric(22,11),
    salescomm numeric(22,11),
    secondsalescomm numeric(22,11),
    gst numeric(22,11),
    secondgst numeric(22,11),
    returnamount numeric(22,2),
    winningamount numeric(22,2)
);


ALTER TABLE public.test_ubt_get_amt_trx_03nov OWNER TO sp_postgres;

--
-- TOC entry 414 (class 1259 OID 25084)
-- Name: test_ubt_interfacedata; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ubt_interfacedata (
    interfacedata character varying(10485760)
);


ALTER TABLE public.test_ubt_interfacedata OWNER TO sp_postgres;

--
-- TOC entry 415 (class 1259 OID 25090)
-- Name: test_ubt_interfacedata_21nov; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.test_ubt_interfacedata_21nov (
    interfacedata character varying(10485760)
);


ALTER TABLE public.test_ubt_interfacedata_21nov OWNER TO consultant01;

--
-- TOC entry 416 (class 1259 OID 25096)
-- Name: test_ubt_invdbjan; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.test_ubt_invdbjan (
    chainname character varying(100),
    locdisplayid character varying(100),
    locname character varying(100),
    amount numeric(32,11) NOT NULL
);


ALTER TABLE public.test_ubt_invdbjan OWNER TO consultant01;

--
-- TOC entry 417 (class 1259 OID 25099)
-- Name: test_ubt_invoicerpt_03nov; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ubt_invoicerpt_03nov (
    id character varying(100),
    productname character varying(100),
    amount numeric(32,11),
    flag character varying(20),
    trxtype character varying(25),
    idtype character(5),
    "Type" character varying(25)
);


ALTER TABLE public.test_ubt_invoicerpt_03nov OWNER TO sp_postgres;

--
-- TOC entry 418 (class 1259 OID 25102)
-- Name: test_ubt_locationinv_02nov; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ubt_locationinv_02nov (
    interfacedata character varying(766)
);


ALTER TABLE public.test_ubt_locationinv_02nov OWNER TO sp_postgres;

--
-- TOC entry 419 (class 1259 OID 25108)
-- Name: test_ubt_salescomm_14nov; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ubt_salescomm_14nov (
    chainhead character varying(200),
    locationid character varying(200),
    locationname character varying(200),
    productname character varying(100),
    invoicedate character varying(100),
    salescomamount double precision,
    gstcomamount double precision,
    adjsalescom double precision,
    adjgstcom double precision
);


ALTER TABLE public.test_ubt_salescomm_14nov OWNER TO sp_postgres;

--
-- TOC entry 420 (class 1259 OID 25114)
-- Name: test_ubt_salescommrpt_04nov; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ubt_salescommrpt_04nov (
    chainhead character varying(200),
    locationid character varying(200),
    locationname character varying(200),
    productname character varying(100),
    invoicedate character varying(100),
    salescomamount double precision,
    gstcomamount double precision,
    adjsalescom double precision,
    adjgstcom double precision
);


ALTER TABLE public.test_ubt_salescommrpt_04nov OWNER TO sp_postgres;

--
-- TOC entry 421 (class 1259 OID 25120)
-- Name: test_ubt_sapinterval_20oct; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.test_ubt_sapinterval_20oct (
    interfacedata character varying(10485760)
);


ALTER TABLE public.test_ubt_sapinterval_20oct OWNER TO sp_postgres;

--
-- TOC entry 422 (class 1259 OID 25126)
-- Name: test_ubt_toto_uuid; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.test_ubt_toto_uuid (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10),
    betlineannotation character varying(500),
    units integer,
    betpriceamount numeric(16,2),
    grouphostid character varying(50),
    groupunitsequence integer,
    quickpickindicator boolean,
    itotoindicator boolean,
    boardsequence integer,
    syndicatepartsallowed integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate information_schema.time_stamp,
    tranlineitemid_uudi uuid
);


ALTER TABLE public.test_ubt_toto_uuid OWNER TO consultant01;

--
-- TOC entry 423 (class 1259 OID 25132)
-- Name: totalamount; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.totalamount (
    amount numeric
);


ALTER TABLE public.totalamount OWNER TO consultant01;

--
-- TOC entry 424 (class 1259 OID 25138)
-- Name: tt; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.tt (
    hostdrawdatesid bigint
);


ALTER TABLE public.tt OWNER TO consultant01;

--
-- TOC entry 868 (class 1259 OID 866565)
-- Name: ubt_salescomm_report_data; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ubt_salescomm_report_data (
    chainhead character varying,
    locationid character varying,
    locationname character varying,
    productname character varying,
    invoicedate text,
    salescomamount numeric,
    gstcomamount numeric,
    adjsalescom numeric,
    adjgstcom numeric
);


ALTER TABLE public.ubt_salescomm_report_data OWNER TO sp_postgres;

--
-- TOC entry 425 (class 1259 OID 25141)
-- Name: ubt_temp_locinv_02nov; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ubt_temp_locinv_02nov (
    locdisplayid text,
    agentinvoice_invid text,
    agentinvoice_finidn text,
    agentinvoice_productid text,
    sales_type text,
    totalcount text,
    amount text
);


ALTER TABLE public.ubt_temp_locinv_02nov OWNER TO sp_postgres;

--
-- TOC entry 426 (class 1259 OID 25153)
-- Name: ubt_test_gat_file; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_gat_file (
    ticketserialnumber character varying(50),
    salescommamount numeric,
    salesfactoramount numeric,
    createddate character varying(23)
);


ALTER TABLE public.ubt_test_gat_file OWNER TO consultant01;

--
-- TOC entry 427 (class 1259 OID 25159)
-- Name: ubt_test_gat_file1; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_gat_file1 (
    ticketserialnumber character varying(50),
    salescommamount numeric,
    salesfactoramount numeric,
    createddate character varying(23)
);


ALTER TABLE public.ubt_test_gat_file1 OWNER TO consultant01;

--
-- TOC entry 428 (class 1259 OID 25165)
-- Name: ubt_test_gat_prd; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_gat_prd (
    ticketserialnumber character varying(50),
    salescommamount numeric,
    salesfactoramount numeric
);


ALTER TABLE public.ubt_test_gat_prd OWNER TO consultant01;

--
-- TOC entry 429 (class 1259 OID 25171)
-- Name: ubt_test_gat_prd1; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_gat_prd1 (
    ticketserialnumber character varying(50),
    salescommamount numeric,
    salesfactoramount numeric
);


ALTER TABLE public.ubt_test_gat_prd1 OWNER TO consultant01;

--
-- TOC entry 430 (class 1259 OID 25177)
-- Name: ubt_test_gta_tra_csv_prd; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ubt_test_gta_tra_csv_prd (
    ticketserialnumber character varying(100),
    wager numeric(27,11),
    secondwager numeric(27,11),
    sales numeric(27,11),
    secondsales numeric(27,11),
    salescomm numeric(25,11),
    secondsalescomm numeric(25,11),
    gst numeric(26,11),
    secondgst numeric(25,11),
    returnamount character varying(80),
    winningamount character varying(80)
);


ALTER TABLE public.ubt_test_gta_tra_csv_prd OWNER TO sp_postgres;

--
-- TOC entry 431 (class 1259 OID 25180)
-- Name: ubt_test_gtad_csv_prd; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_gtad_csv_prd (
    terdisplayid integer,
    prodname character varying(100),
    amount double precision,
    ct integer,
    flag character varying(3),
    transtype character varying(2),
    fromdate character varying(26),
    todate character varying(26)
);


ALTER TABLE public.ubt_test_gtad_csv_prd OWNER TO consultant01;

--
-- TOC entry 432 (class 1259 OID 25183)
-- Name: ubt_test_inv_rpt_data_22_25_nov; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_inv_rpt_data_22_25_nov (
    id character varying(100),
    productname character varying(100),
    amount numeric(32,11),
    flag character varying(20),
    "Type" character varying(25),
    idtype character(5)
);


ALTER TABLE public.ubt_test_inv_rpt_data_22_25_nov OWNER TO consultant01;

--
-- TOC entry 433 (class 1259 OID 25186)
-- Name: ubt_test_invreport_03dec_5dec; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_invreport_03dec_5dec (
    id character varying(100),
    productname character varying(100),
    amount numeric(32,11),
    flag character varying(20),
    "Type" character varying(25),
    idtype character(5)
);


ALTER TABLE public.ubt_test_invreport_03dec_5dec OWNER TO consultant01;

--
-- TOC entry 434 (class 1259 OID 25189)
-- Name: ubt_test_invreport_6dec_9dec; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_invreport_6dec_9dec (
    id character varying(100),
    productname character varying(100),
    amount numeric(32,11),
    flag character varying(20),
    "Type" character varying(25),
    idtype character(5)
);


ALTER TABLE public.ubt_test_invreport_6dec_9dec OWNER TO consultant01;

--
-- TOC entry 435 (class 1259 OID 25192)
-- Name: ubt_test_newlocophrs; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_newlocophrs (
    locationname character varying(100),
    locationid character varying(100),
    terminalid character varying(100),
    opentime character varying(4000),
    signondate character varying(4000),
    signontime character varying(4000),
    firstsaletime character varying(4000),
    firsthourcount integer NOT NULL,
    closetime character varying(4000),
    signoffdate character varying(4000),
    signofftime character varying(4000),
    lastsaletime character varying(4000),
    lasthourcount integer NOT NULL
);


ALTER TABLE public.ubt_test_newlocophrs OWNER TO consultant01;

--
-- TOC entry 436 (class 1259 OID 25198)
-- Name: ubt_test_pg_gatd_26nov; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_pg_gatd_26nov (
    terdisplayid character varying,
    prodname character varying,
    flag bpchar,
    amount numeric(22,11),
    ticketcount integer,
    actualdate date,
    transtype character varying
);


ALTER TABLE public.ubt_test_pg_gatd_26nov OWNER TO consultant01;

--
-- TOC entry 437 (class 1259 OID 25204)
-- Name: ubt_test_summary_29nov_2dec; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_summary_29nov_2dec (
    description character varying(100),
    value numeric(32,11) NOT NULL,
    "Type" character varying(40)
);


ALTER TABLE public.ubt_test_summary_29nov_2dec OWNER TO consultant01;

--
-- TOC entry 438 (class 1259 OID 25207)
-- Name: ubt_test_summary_3dec_5ec; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_summary_3dec_5ec (
    description character varying(100),
    value numeric(32,11) NOT NULL,
    "Type" character varying(40)
);


ALTER TABLE public.ubt_test_summary_3dec_5ec OWNER TO consultant01;

--
-- TOC entry 439 (class 1259 OID 25210)
-- Name: ubt_test_summary_6dec_9dec; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_summary_6dec_9dec (
    description character varying(100),
    value numeric(32,11) NOT NULL,
    "Type" character varying(40)
);


ALTER TABLE public.ubt_test_summary_6dec_9dec OWNER TO consultant01;

--
-- TOC entry 440 (class 1259 OID 25213)
-- Name: ubt_test_test_dibg; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ubt_test_test_dibg (
    chainname character varying(100),
    locdisplayid character varying(100),
    locname character varying(100),
    amount numeric(32,11)
);


ALTER TABLE public.ubt_test_test_dibg OWNER TO consultant01;

--
-- TOC entry 910 (class 1259 OID 1569944)
-- Name: user_district_mapping; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.user_district_mapping (
    user_id character varying(7) NOT NULL,
    district_number integer NOT NULL
);


ALTER TABLE public.user_district_mapping OWNER TO sp_postgres;

--
-- TOC entry 441 (class 1259 OID 25216)
-- Name: vbaseamount; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.vbaseamount (
    amt numeric
);


ALTER TABLE public.vbaseamount OWNER TO consultant01;

--
-- TOC entry 841 (class 1259 OID 436342)
-- Name: vgst_branch; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.vgst_branch (
    "case" text
);


ALTER TABLE public.vgst_branch OWNER TO postgres;

--
-- TOC entry 442 (class 1259 OID 25222)
-- Name: vinputdate; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.vinputdate (
    "?column?" timestamp without time zone
);


ALTER TABLE public.vinputdate OWNER TO postgres;

--
-- TOC entry 842 (class 1259 OID 436348)
-- Name: vinputtax; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.vinputtax (
    "case" text
);


ALTER TABLE public.vinputtax OWNER TO postgres;

--
-- TOC entry 443 (class 1259 OID 25225)
-- Name: vinvoiceperiodid; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.vinvoiceperiodid (
    invoiceperiodid character varying
);


ALTER TABLE public.vinvoiceperiodid OWNER TO consultant01;

--
-- TOC entry 444 (class 1259 OID 25231)
-- Name: vtotalamount; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.vtotalamount (
    amount numeric
);


ALTER TABLE public.vtotalamount OWNER TO consultant01;

--
-- TOC entry 882 (class 1259 OID 1322713)
-- Name: yy1_fin_es_trans_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.yy1_fin_es_trans_test (
    filetype character varying(8),
    ccode integer,
    retailtype integer,
    gamecode integer,
    transmode integer,
    transcode character varying(1),
    sign character varying(1),
    debitcredit character varying(6),
    glacct integer,
    pcenter character varying(1),
    "desc" character varying(42),
    taxcode character varying(2),
    arcode integer,
    apcode integer,
    netsar integer,
    effective_date character varying(10),
    lastchgdate character varying(1),
    lastchgby character varying(1)
);


ALTER TABLE public.yy1_fin_es_trans_test OWNER TO sp_postgres;

--
-- TOC entry 939 (class 1259 OID 1854120)
-- Name: ztalation_postgres_log; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztalation_postgres_log (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
);


ALTER TABLE public.ztalation_postgres_log OWNER TO sp_postgres;

--
-- TOC entry 945 (class 1259 OID 1855356)
-- Name: ztalation_postgres_log_00; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_00 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-00_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_00 OWNER TO sp_postgres;

--
-- TOC entry 946 (class 1259 OID 1855359)
-- Name: ztalation_postgres_log_01; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_01 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-01_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_01 OWNER TO sp_postgres;

--
-- TOC entry 947 (class 1259 OID 1855362)
-- Name: ztalation_postgres_log_02; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_02 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-02_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_02 OWNER TO sp_postgres;

--
-- TOC entry 948 (class 1259 OID 1855365)
-- Name: ztalation_postgres_log_03; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_03 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-03_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_03 OWNER TO sp_postgres;

--
-- TOC entry 949 (class 1259 OID 1855368)
-- Name: ztalation_postgres_log_04; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_04 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-04_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_04 OWNER TO sp_postgres;

--
-- TOC entry 950 (class 1259 OID 1855371)
-- Name: ztalation_postgres_log_05; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_05 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-05_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_05 OWNER TO sp_postgres;

--
-- TOC entry 951 (class 1259 OID 1855374)
-- Name: ztalation_postgres_log_06; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_06 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-06_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_06 OWNER TO sp_postgres;

--
-- TOC entry 952 (class 1259 OID 1855377)
-- Name: ztalation_postgres_log_07; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_07 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-07_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_07 OWNER TO sp_postgres;

--
-- TOC entry 953 (class 1259 OID 1855380)
-- Name: ztalation_postgres_log_08; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_08 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-08_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_08 OWNER TO sp_postgres;

--
-- TOC entry 954 (class 1259 OID 1855383)
-- Name: ztalation_postgres_log_09; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_09 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-09_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_09 OWNER TO sp_postgres;

--
-- TOC entry 955 (class 1259 OID 1855386)
-- Name: ztalation_postgres_log_10; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_10 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-10_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_10 OWNER TO sp_postgres;

--
-- TOC entry 956 (class 1259 OID 1855389)
-- Name: ztalation_postgres_log_11; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_11 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-11_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_11 OWNER TO sp_postgres;

--
-- TOC entry 957 (class 1259 OID 1855392)
-- Name: ztalation_postgres_log_12; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_12 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-12_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_12 OWNER TO sp_postgres;

--
-- TOC entry 941 (class 1259 OID 1854129)
-- Name: ztalation_postgres_log_13; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_13 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-13_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_13 OWNER TO sp_postgres;

--
-- TOC entry 940 (class 1259 OID 1854126)
-- Name: ztalation_postgres_log_14; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_14 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-14_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_14 OWNER TO sp_postgres;

--
-- TOC entry 942 (class 1259 OID 1854132)
-- Name: ztalation_postgres_log_15; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_15 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-15_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_15 OWNER TO sp_postgres;

--
-- TOC entry 943 (class 1259 OID 1854135)
-- Name: ztalation_postgres_log_16; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_16 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-16_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_16 OWNER TO sp_postgres;

--
-- TOC entry 958 (class 1259 OID 1855685)
-- Name: ztalation_postgres_log_17; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_17 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-17_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_17 OWNER TO sp_postgres;

--
-- TOC entry 959 (class 1259 OID 1855696)
-- Name: ztalation_postgres_log_18; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_18 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-18_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_18 OWNER TO sp_postgres;

--
-- TOC entry 960 (class 1259 OID 1855838)
-- Name: ztalation_postgres_log_19; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_19 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-19_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_19 OWNER TO sp_postgres;

--
-- TOC entry 961 (class 1259 OID 1855986)
-- Name: ztalation_postgres_log_20; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_20 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-20_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_20 OWNER TO sp_postgres;

--
-- TOC entry 962 (class 1259 OID 1856136)
-- Name: ztalation_postgres_log_21; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_21 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-21_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_21 OWNER TO sp_postgres;

--
-- TOC entry 963 (class 1259 OID 1856139)
-- Name: ztalation_postgres_log_22; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_22 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-22_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_22 OWNER TO sp_postgres;

--
-- TOC entry 964 (class 1259 OID 1856142)
-- Name: ztalation_postgres_log_23; Type: FOREIGN TABLE; Schema: public; Owner: sp_postgres
--

CREATE FOREIGN TABLE public.ztalation_postgres_log_23 (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
)
INHERITS (public.ztalation_postgres_log)
SERVER pglog
OPTIONS (
    filename 'pg_log/postgresql-23_filtered.csv',
    format 'csv'
);


ALTER FOREIGN TABLE public.ztalation_postgres_log_23 OWNER TO sp_postgres;

--
-- TOC entry 965 (class 1259 OID 1857222)
-- Name: ztalation_postgres_log_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztalation_postgres_log_test (
    log_time timestamp(3) with time zone,
    user_name text,
    database_name text,
    process_id integer,
    connection_from text,
    session_id text,
    session_line_num bigint,
    command_tag text,
    session_start_time timestamp with time zone,
    virtual_transaction_id text,
    transaction_id bigint,
    error_severity text,
    sql_state_code text,
    message text,
    detail text,
    hint text,
    internal_query text,
    internal_query_pos integer,
    context text,
    query text,
    query_pos integer,
    location text,
    application_name text
);


ALTER TABLE public.ztalation_postgres_log_test OWNER TO sp_postgres;

--
-- TOC entry 445 (class 1259 OID 25237)
-- Name: ztall_businessday; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztall_businessday (
    system character varying(30) NOT NULL,
    business_date date NOT NULL,
    business_id integer,
    start_timestamp timestamp without time zone,
    end_timestamp timestamp without time zone
);


ALTER TABLE public.ztall_businessday OWNER TO sp_postgres;

--
-- TOC entry 446 (class 1259 OID 25243)
-- Name: ztall_product; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztall_product (
    product character varying(10) NOT NULL,
    productname character varying(30) NOT NULL,
    producttype character varying(30) NOT NULL,
    productsortorder integer,
    productgroup character varying(30) NOT NULL,
    gru integer,
    productflag integer
);


ALTER TABLE public.ztall_product OWNER TO sp_postgres;

--
-- TOC entry 447 (class 1259 OID 25246)
-- Name: ztall_weight_margin; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztall_weight_margin (
    marketgroup character varying(50),
    markets character varying(50),
    yieldmargin numeric(21,11),
    start_effective_date date,
    end_effective_date date
);


ALTER TABLE public.ztall_weight_margin OWNER TO sp_postgres;

--
-- TOC entry 887 (class 1259 OID 1439045)
-- Name: ztbg_daily; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbg_daily (
    dataorigin character varying(30) NOT NULL,
    calday date NOT NULL,
    retailer_id integer NOT NULL,
    funding double precision,
    daily_sales double precision,
    total double precision,
    ezlink double precision,
    cashnet_inv double precision,
    cashnet_on_inv double precision,
    cashnet_off_inv double precision,
    cashnet_daily double precision,
    cashnet_on_daily double precision,
    cashnet_off_daily double precision,
    change_log_date timestamp without time zone,
    paynow_amount double precision,
    paynow_qr_amount double precision,
    refund_inv double precision
);


ALTER TABLE public.ztbg_daily OWNER TO sp_postgres;

--
-- TOC entry 448 (class 1259 OID 25249)
-- Name: ztbg_daily_bk20240314; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbg_daily_bk20240314 (
    dataorigin character varying(30) NOT NULL,
    calday date NOT NULL,
    retailer_id integer NOT NULL,
    funding double precision,
    daily_sales double precision,
    total double precision,
    ezlink double precision,
    cashnet_inv double precision,
    cashnet_on_inv double precision,
    cashnet_off_inv double precision,
    cashnet_daily double precision,
    cashnet_on_daily double precision,
    cashnet_off_daily double precision,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztbg_daily_bk20240314 OWNER TO sp_postgres;

--
-- TOC entry 894 (class 1259 OID 1442398)
-- Name: ztbg_daily_bk20240604; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbg_daily_bk20240604 (
    dataorigin character varying(30),
    calday date,
    retailer_id integer,
    funding double precision,
    daily_sales double precision,
    total double precision,
    ezlink double precision,
    cashnet_inv double precision,
    cashnet_on_inv double precision,
    cashnet_off_inv double precision,
    cashnet_daily double precision,
    cashnet_on_daily double precision,
    cashnet_off_daily double precision,
    change_log_date timestamp without time zone,
    paynow_amount double precision,
    paynow_qr_amount double precision
);


ALTER TABLE public.ztbg_daily_bk20240604 OWNER TO sp_postgres;

--
-- TOC entry 886 (class 1259 OID 1436306)
-- Name: ztbg_daily_lsr_hds2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbg_daily_lsr_hds2 (
    dataorigin character varying(30) NOT NULL,
    calday date NOT NULL,
    retailer_id integer NOT NULL,
    funding double precision,
    daily_sales double precision,
    total double precision,
    ezlink double precision,
    cashnet_inv double precision,
    cashnet_on_inv double precision,
    cashnet_off_inv double precision,
    cashnet_daily double precision,
    cashnet_on_daily double precision,
    cashnet_off_daily double precision,
    change_log_date timestamp without time zone,
    paynow_amount double precision,
    paynow_qr_amount double precision,
    refund_amount double precision
);


ALTER TABLE public.ztbg_daily_lsr_hds2 OWNER TO sp_postgres;

--
-- TOC entry 449 (class 1259 OID 25252)
-- Name: ztbmcs_betinfobyaccountview; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbmcs_betinfobyaccountview (
    locationid double precision,
    positionid double precision,
    meetingid double precision,
    clubmeeting character varying(3),
    meetingdate timestamp without time zone,
    financialyear character varying(7),
    meetingname character varying(60),
    meetingnumber double precision,
    raceid double precision,
    racenumber double precision,
    tracktype character varying(30),
    raceclass character varying(6),
    course character varying(3),
    distance double precision,
    racename character varying(60),
    stakes numeric(12,2),
    trackcondition character varying(30),
    advertisedstarttime timestamp without time zone,
    jumptime timestamp without time zone,
    releasetime timestamp without time zone,
    meetingmix character varying(50),
    actualmeeting character varying(60),
    numberofstarters double precision,
    poolid double precision,
    bettype character varying(2),
    terminaltypeid character varying(1),
    bettingaccountnumber text,
    turnover numeric(12,2),
    betlinerebate numeric(12,2),
    refund numeric(12,2),
    noofbetlines double precision,
    noofunits numeric(28,8),
    totalcancelamount numeric(12,2),
    totalpayable numeric(12,2),
    rollbetleg double precision,
    betsource text
);


ALTER TABLE public.ztbmcs_betinfobyaccountview OWNER TO sp_postgres;

--
-- TOC entry 450 (class 1259 OID 25264)
-- Name: ztbmcs_betinfobycashacctview; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbmcs_betinfobycashacctview (
    positionid integer,
    meetingid integer,
    clubmeeting character varying(3),
    meetingdate date,
    financialyear character varying(7),
    meetingname character varying(60),
    meetingnumber integer,
    raceid integer,
    racenumber integer,
    tracktype character varying(30),
    raceclass character varying(6),
    course character varying(3),
    distance integer,
    racename character varying(60),
    stakes numeric(10,2),
    trackcondition character varying(30),
    advertisedstarttime timestamp without time zone,
    jumptime timestamp without time zone,
    releasetime timestamp without time zone,
    meetingmix character varying(50),
    actualmeeting character varying(60),
    numberofstarters integer,
    poolid integer,
    bettype character varying(2),
    terminaltypeid character varying(1),
    turnover numeric(10,2),
    betlinerebate numeric(10,2),
    refund numeric(10,2),
    noofbetlines integer,
    noofunits numeric(20,8),
    totalcancelamount numeric(10,2),
    totalpayable numeric(10,2),
    rollbetleg integer,
    betsource character varying(30),
    locationid double precision,
    positionid_ktl double precision
);


ALTER TABLE public.ztbmcs_betinfobycashacctview OWNER TO sp_postgres;

--
-- TOC entry 451 (class 1259 OID 25270)
-- Name: ztbmcs_bettype_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbmcs_bettype_master (
    bettype character varying(3),
    bettypeabbr character varying(60),
    bettypedescription character varying(60),
    bettypeindex character varying(3)
);


ALTER TABLE public.ztbmcs_bettype_master OWNER TO sp_postgres;

--
-- TOC entry 452 (class 1259 OID 25273)
-- Name: ztbmcs_clubmeeting_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbmcs_clubmeeting_master (
    clubmeeting character varying(3) NOT NULL,
    description character varying(60),
    racecourseabbrv character varying(3),
    racecoursedescription character varying(60)
);


ALTER TABLE public.ztbmcs_clubmeeting_master OWNER TO sp_postgres;

--
-- TOC entry 453 (class 1259 OID 25276)
-- Name: ztbmcs_location_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbmcs_location_master (
    locationid integer,
    location_name character varying(60),
    locationtypeid character varying(10),
    locationgroupid integer
);


ALTER TABLE public.ztbmcs_location_master OWNER TO sp_postgres;

--
-- TOC entry 454 (class 1259 OID 25279)
-- Name: ztbmcs_locationgroup_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbmcs_locationgroup_master (
    locationgroupid integer,
    location_group character varying(60)
);


ALTER TABLE public.ztbmcs_locationgroup_master OWNER TO sp_postgres;

--
-- TOC entry 455 (class 1259 OID 25282)
-- Name: ztbmcs_locationtype_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbmcs_locationtype_master (
    locationtypeid character varying(10),
    location_type character varying(60)
);


ALTER TABLE public.ztbmcs_locationtype_master OWNER TO sp_postgres;

--
-- TOC entry 456 (class 1259 OID 25285)
-- Name: ztbmcs_terminaltype_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztbmcs_terminaltype_master (
    terminaltypeid character varying(10),
    terminaltype character varying(60)
);


ALTER TABLE public.ztbmcs_terminaltype_master OWNER TO sp_postgres;

--
-- TOC entry 457 (class 1259 OID 25288)
-- Name: ztes_esrm_device; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_esrm_device (
    device_id integer NOT NULL,
    outlet_id integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_esrm_device OWNER TO sp_postgres;

--
-- TOC entry 458 (class 1259 OID 25291)
-- Name: ztes_esrm_device_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztes_esrm_device_uat_test (
    device_id integer,
    outlet_id integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_esrm_device_uat_test OWNER TO consultant01;

--
-- TOC entry 459 (class 1259 OID 25294)
-- Name: ztes_esrm_outlet; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_esrm_outlet (
    outlet_id integer NOT NULL,
    outlet_name character varying(255),
    outlet_type_code integer,
    outlet_type_desc character varying(255),
    outlet_rpt_to integer,
    outlet_bill_to integer,
    outlet_business_code integer,
    outlet_business_desc character varying(255),
    outlet_ownership_code integer,
    outlet_ownership_desc character varying(255),
    outlet_bank_name character varying(255),
    outlet_account_name character varying(255),
    outlet_account_number bigint,
    outlet_routing_number bigint,
    outlet_branch_code bigint,
    outlet_address1 character varying(255),
    outlet_address2 character varying(255),
    outlet_address3 character varying(255),
    outlet_address_city character varying(255),
    outlet_address_country integer,
    outlet_address_postal_code character varying(30),
    outlet_address_postal_code_ext character varying(10),
    outlet_creator_id character varying(30),
    outlet_date_creation date,
    outlet_date_activation date,
    outlet_date_deactivation date,
    outlet_status_code integer,
    outlet_status_desc character varying(255),
    outlet_sun_open_tm time without time zone,
    outlet_sun_close_tm time without time zone,
    outlet_mon_open_tm time without time zone,
    outlet_mon_close_tm time without time zone,
    outlet_tue_open_tm time without time zone,
    outlet_tue_close_tm time without time zone,
    outlet_wed_open_tm time without time zone,
    outlet_wed_close_tm time without time zone,
    outlet_thu_open_tm time without time zone,
    outlet_thu_close_tm time without time zone,
    outlet_fri_open_tm time without time zone,
    outlet_fri_close_tm time without time zone,
    outlet_sat_open_tm time without time zone,
    outlet_sat_close_tm time without time zone,
    outlet_date_modification date,
    outlet_gst_registred_flag integer,
    outlet_gst_registred_no character varying(30),
    outlet_time_modification time without time zone,
    outlet_ibg_flag integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_esrm_outlet OWNER TO sp_postgres;

--
-- TOC entry 460 (class 1259 OID 25300)
-- Name: ztes_esrm_outlet_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztes_esrm_outlet_uat_test (
    outlet_id integer,
    outlet_name character varying(255),
    outlet_type_code integer,
    outlet_type_desc character varying(255),
    outlet_rpt_to integer,
    outlet_bill_to integer,
    outlet_business_code integer,
    outlet_business_desc character varying(255),
    outlet_ownership_code integer,
    outlet_ownership_desc character varying(255),
    outlet_bank_name character varying(255),
    outlet_account_name character varying(255),
    outlet_account_number bigint,
    outlet_routing_number bigint,
    outlet_branch_code bigint,
    outlet_address1 character varying(255),
    outlet_address2 character varying(255),
    outlet_address3 character varying(255),
    outlet_address_city character varying(255),
    outlet_address_country integer,
    outlet_address_postal_code character varying(30),
    outlet_address_postal_code_ext character varying(10),
    outlet_creator_id character varying(30),
    outlet_date_creation date,
    outlet_date_activation date,
    outlet_date_deactivation date,
    outlet_status_code integer,
    outlet_status_desc character varying(255),
    outlet_sun_open_tm time without time zone,
    outlet_sun_close_tm time without time zone,
    outlet_mon_open_tm time without time zone,
    outlet_mon_close_tm time without time zone,
    outlet_tue_open_tm time without time zone,
    outlet_tue_close_tm time without time zone,
    outlet_wed_open_tm time without time zone,
    outlet_wed_close_tm time without time zone,
    outlet_thu_open_tm time without time zone,
    outlet_thu_close_tm time without time zone,
    outlet_fri_open_tm time without time zone,
    outlet_fri_close_tm time without time zone,
    outlet_sat_open_tm time without time zone,
    outlet_sat_close_tm time without time zone,
    outlet_date_modification date,
    outlet_gst_registred_flag integer,
    outlet_gst_registred_no character varying(30),
    outlet_time_modification time without time zone,
    outlet_ibg_flag integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_esrm_outlet_uat_test OWNER TO consultant01;

--
-- TOC entry 461 (class 1259 OID 25306)
-- Name: ztes_esrm_teller; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_esrm_teller (
    teller_id integer NOT NULL,
    outlet_id integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_esrm_teller OWNER TO sp_postgres;

--
-- TOC entry 462 (class 1259 OID 25309)
-- Name: ztes_este_bigwinner; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_este_bigwinner (
    cdc integer NOT NULL,
    tralnkmjf integer NOT NULL,
    tixnum integer NOT NULL,
    windtl_division integer,
    windtl_winset integer,
    trahdr_tratlr integer,
    intser bigint,
    trasub integer,
    trahdr_tratrmidn integer,
    trahdr_traagt integer,
    tratim bigint,
    traprod integer,
    tratyp integer,
    windtl_draw integer,
    windtl_game integer,
    extser character varying(50),
    wininf_numdetail integer,
    size integer,
    rectyp integer,
    traerr integer,
    recver integer,
    trachk integer,
    traupd integer,
    tratrmidx integer,
    traparrev integer,
    traupdinf integer,
    trares integer,
    lnkdrw integer,
    lnkdev integer,
    lnkser integer,
    traseq integer,
    lnkcdc integer,
    trahdr_traamt double precision,
    trahdr_traupdcdc integer,
    tracount integer,
    windtl_bettyp integer,
    windtl_cashcdc integer,
    windtl_clmflg integer,
    windtl_casflg integer,
    windtl_eftflg integer,
    windtl_expflg integer,
    windtl_grbflg integer,
    windtl_jpwonflg integer,
    windtl_liabupd integer,
    windtl_markup integer,
    windtl_multiflg integer,
    windtl_oddchgflg integer,
    windtl_ppflg integer,
    windtl_prgflg integer,
    windtl_qpflg integer,
    windtl_refflg integer,
    windtl_updflg integer,
    windtl_xtrawin integer,
    wininf_zeroed integer,
    windtl_grdid integer,
    windtl_jackpot_gridid integer,
    windtl_przdesc integer,
    windtl_przdiv integer,
    windtl_przpool integer,
    windtl_prztyp integer,
    windtl_winsettype integer,
    windtl_expcdc integer,
    windtl_winloadcdc integer,
    windtl_drawcdc integer,
    windtl_valid_comm double precision,
    windtl_amount double precision,
    windtl_shares integer,
    add_wininf_expdrw integer,
    add_wininf_lstdrw integer,
    wininf_expdrw integer,
    wininf_finclass integer,
    wininf_cashprz integer,
    wininf_cashopt integer,
    wininf_freeprz integer,
    wininf_fraction integer,
    wininf_merchprz integer,
    wininf_refund integer,
    synd_flg integer,
    wininf_xtraprize integer,
    windtl_zeroed integer,
    wininf_lstdrw integer,
    synd_id integer,
    synd_recid integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_este_bigwinner OWNER TO sp_postgres;

--
-- TOC entry 463 (class 1259 OID 25312)
-- Name: ztes_este_cashpurge; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_este_cashpurge (
    cdc integer NOT NULL,
    tralnkmjf integer NOT NULL,
    tixnum integer NOT NULL,
    windtl_division integer,
    windtl_winset integer,
    trahdr_tratlr integer,
    intser bigint,
    trasub integer,
    trahdr_tratrmidn integer,
    trahdr_traagt integer,
    tratim bigint,
    traprod integer,
    tratyp integer,
    windtl_draw integer,
    windtl_game integer,
    extser character varying(50),
    wininf_numdetail integer,
    size integer,
    rectyp integer,
    traerr integer,
    recver integer,
    trachk integer,
    traupd integer,
    tratrmidx integer,
    traparrev integer,
    traupdinf integer,
    trares integer,
    lnkdrw integer,
    lnkdev integer,
    lnkser integer,
    traseq integer,
    lnkcdc integer,
    trahdr_traamt double precision,
    trahdr_traupdcdc integer,
    tracount integer,
    windtl_bettyp integer,
    windtl_cashcdc integer,
    windtl_clmflg integer,
    windtl_casflg integer,
    windtl_eftflg integer,
    windtl_expflg integer,
    windtl_grbflg integer,
    windtl_jpwonflg integer,
    windtl_liabupd integer,
    windtl_markup integer,
    windtl_multiflg integer,
    windtl_oddchgflg integer,
    windtl_ppflg integer,
    windtl_prgflg integer,
    windtl_qpflg integer,
    windtl_refflg integer,
    windtl_updflg integer,
    windtl_xtrawin integer,
    wininf_zeroed integer,
    windtl_grdid integer,
    windtl_jackpot_gridid integer,
    windtl_przdesc integer,
    windtl_przdiv integer,
    windtl_przpool integer,
    windtl_prztyp integer,
    windtl_winsettype integer,
    windtl_expcdc integer,
    windtl_winloadcdc integer,
    windtl_drawcdc integer,
    windtl_valid_comm double precision,
    windtl_amount double precision,
    windtl_shares integer,
    add_wininf_expdrw integer,
    add_wininf_lstdrw integer,
    wininf_expdrw integer,
    wininf_finclass integer,
    wininf_cashprz integer,
    wininf_cashopt integer,
    wininf_freeprz integer,
    wininf_fraction integer,
    wininf_merchprz integer,
    wininf_refund integer,
    synd_flg integer,
    wininf_xtraprize integer,
    windtl_zeroed integer,
    wininf_lstdrw integer,
    synd_id integer,
    synd_recid integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_este_cashpurge OWNER TO sp_postgres;

--
-- TOC entry 464 (class 1259 OID 25315)
-- Name: ztes_este_uncashexpire; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_este_uncashexpire (
    cdc integer NOT NULL,
    tralnkmjf integer NOT NULL,
    tixnum integer NOT NULL,
    windtl_division integer,
    windtl_winset integer,
    trahdr_tratlr integer,
    intser bigint,
    trasub integer,
    trahdr_tratrmidn integer,
    trahdr_traagt integer,
    tratim bigint,
    traprod integer,
    tratyp integer,
    windtl_draw integer,
    windtl_game integer,
    extser character varying(50),
    wininf_numdetail integer,
    size integer,
    rectyp integer,
    traerr integer,
    recver integer,
    trachk integer,
    traupd integer,
    tratrmidx integer,
    traparrev integer,
    traupdinf integer,
    trares integer,
    lnkdrw integer,
    lnkdev integer,
    lnkser integer,
    traseq integer,
    lnkcdc integer,
    trahdr_traamt double precision,
    trahdr_traupdcdc integer,
    tracount integer,
    windtl_bettyp integer,
    windtl_cashcdc integer,
    windtl_clmflg integer,
    windtl_casflg integer,
    windtl_eftflg integer,
    windtl_expflg integer,
    windtl_grbflg integer,
    windtl_jpwonflg integer,
    windtl_liabupd integer,
    windtl_markup integer,
    windtl_multiflg integer,
    windtl_oddchgflg integer,
    windtl_ppflg integer,
    windtl_prgflg integer,
    windtl_qpflg integer,
    windtl_refflg integer,
    windtl_updflg integer,
    windtl_xtrawin integer,
    wininf_zeroed integer,
    windtl_grdid integer,
    windtl_jackpot_gridid integer,
    windtl_przdesc integer,
    windtl_przdiv integer,
    windtl_przpool integer,
    windtl_prztyp integer,
    windtl_winsettype integer,
    windtl_expcdc integer,
    windtl_winloadcdc integer,
    windtl_drawcdc integer,
    windtl_valid_comm double precision,
    windtl_amount double precision,
    windtl_shares integer,
    add_wininf_expdrw integer,
    add_wininf_lstdrw integer,
    wininf_expdrw integer,
    wininf_finclass integer,
    wininf_cashprz integer,
    wininf_cashopt integer,
    wininf_freeprz integer,
    wininf_fraction integer,
    wininf_merchprz integer,
    wininf_refund integer,
    synd_flg integer,
    wininf_xtraprize integer,
    windtl_zeroed integer,
    wininf_lstdrw integer,
    synd_id integer,
    synd_recid integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_este_uncashexpire OWNER TO sp_postgres;

--
-- TOC entry 465 (class 1259 OID 25318)
-- Name: ztes_este_uncashpurge; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_este_uncashpurge (
    cdc integer NOT NULL,
    tralnkmjf integer NOT NULL,
    tixnum integer NOT NULL,
    windtl_division integer,
    windtl_winset integer,
    trahdr_tratlr integer,
    intser bigint,
    trasub integer,
    trahdr_tratrmidn integer,
    trahdr_traagt integer,
    tratim bigint,
    traprod integer,
    tratyp integer,
    windtl_draw integer,
    windtl_game integer,
    extser character varying(50),
    wininf_numdetail integer,
    size integer,
    rectyp integer,
    traerr integer,
    recver integer,
    trachk integer,
    traupd integer,
    tratrmidx integer,
    traparrev integer,
    traupdinf integer,
    trares integer,
    lnkdrw integer,
    lnkdev integer,
    lnkser integer,
    traseq integer,
    lnkcdc integer,
    trahdr_traamt double precision,
    trahdr_traupdcdc integer,
    tracount integer,
    windtl_bettyp integer,
    windtl_cashcdc integer,
    windtl_clmflg integer,
    windtl_casflg integer,
    windtl_eftflg integer,
    windtl_expflg integer,
    windtl_grbflg integer,
    windtl_jpwonflg integer,
    windtl_liabupd integer,
    windtl_markup integer,
    windtl_multiflg integer,
    windtl_oddchgflg integer,
    windtl_ppflg integer,
    windtl_prgflg integer,
    windtl_qpflg integer,
    windtl_refflg integer,
    windtl_updflg integer,
    windtl_xtrawin integer,
    wininf_zeroed integer,
    windtl_grdid integer,
    windtl_jackpot_gridid integer,
    windtl_przdesc integer,
    windtl_przdiv integer,
    windtl_przpool integer,
    windtl_prztyp integer,
    windtl_winsettype integer,
    windtl_expcdc integer,
    windtl_winloadcdc integer,
    windtl_drawcdc integer,
    windtl_valid_comm double precision,
    windtl_amount double precision,
    windtl_shares integer,
    add_wininf_expdrw integer,
    add_wininf_lstdrw integer,
    wininf_expdrw integer,
    wininf_finclass integer,
    wininf_cashprz integer,
    wininf_cashopt integer,
    wininf_freeprz integer,
    wininf_fraction integer,
    wininf_merchprz integer,
    wininf_refund integer,
    synd_flg integer,
    wininf_xtraprize integer,
    windtl_zeroed integer,
    wininf_lstdrw integer,
    synd_id integer,
    synd_recid integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_este_uncashpurge OWNER TO sp_postgres;

--
-- TOC entry 466 (class 1259 OID 25321)
-- Name: ztes_inv_adj; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_inv_adj (
    adjrec_updatecdc integer NOT NULL,
    adjrec_updateserial integer NOT NULL,
    adjrec_invid integer,
    adjrec_agtidn integer,
    adjrec_trmidn integer,
    adjrec_trantype integer,
    adjrec_posttocode integer,
    adjrec_productnumber integer,
    adjrec_lineitemcode integer,
    adjrec_commadjustcode integer,
    adjrec_updatetim integer,
    adjrec_agentstatus integer,
    adjrec_adjtype character varying(255),
    adjrec_adjcode character varying(255),
    adjrec_producttype integer,
    adjrec_adjamount integer,
    adjrec_adjcomment character varying(255),
    adjrec_adjdesc character varying(255),
    adjrec_claimschedulenumber integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_adj OWNER TO sp_postgres;

--
-- TOC entry 978 (class 1259 OID 1909168)
-- Name: ztes_inv_adj_bkup_240909; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztes_inv_adj_bkup_240909 (
    adjrec_updatecdc integer,
    adjrec_updateserial integer,
    adjrec_invid integer,
    adjrec_agtidn integer,
    adjrec_trmidn integer,
    adjrec_trantype integer,
    adjrec_posttocode integer,
    adjrec_productnumber integer,
    adjrec_lineitemcode integer,
    adjrec_commadjustcode integer,
    adjrec_updatetim integer,
    adjrec_agentstatus integer,
    adjrec_adjtype character varying(255),
    adjrec_adjcode character varying(255),
    adjrec_producttype integer,
    adjrec_adjamount integer,
    adjrec_adjcomment character varying(255),
    adjrec_adjdesc character varying(255),
    adjrec_claimschedulenumber integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_adj_bkup_240909 OWNER TO postgres;

--
-- TOC entry 916 (class 1259 OID 1616720)
-- Name: ztes_inv_adj_uat_20240702; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_inv_adj_uat_20240702 (
    adjrec_updatecdc integer,
    adjrec_updateserial integer,
    adjrec_invid integer,
    adjrec_agtidn integer,
    adjrec_trmidn integer,
    adjrec_trantype integer,
    adjrec_posttocode integer,
    adjrec_productnumber integer,
    adjrec_lineitemcode integer,
    adjrec_commadjustcode integer,
    adjrec_updatetim integer,
    adjrec_agentstatus integer,
    adjrec_adjtype character varying(255),
    adjrec_adjcode character varying(255),
    adjrec_producttype integer,
    adjrec_adjamount integer,
    adjrec_adjcomment character varying(255),
    adjrec_adjdesc character varying(255),
    adjrec_claimschedulenumber integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_adj_uat_20240702 OWNER TO sp_postgres;

--
-- TOC entry 467 (class 1259 OID 25327)
-- Name: ztes_inv_adj_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztes_inv_adj_uat_test (
    adjrec_updatecdc integer,
    adjrec_updateserial integer,
    adjrec_invid integer,
    adjrec_agtidn integer,
    adjrec_trmidn integer,
    adjrec_trantype integer,
    adjrec_posttocode integer,
    adjrec_productnumber integer,
    adjrec_lineitemcode integer,
    adjrec_commadjustcode integer,
    adjrec_updatetim integer,
    adjrec_agentstatus integer,
    adjrec_adjtype character varying(255),
    adjrec_adjcode character varying(255),
    adjrec_producttype integer,
    adjrec_adjamount integer,
    adjrec_adjcomment character varying(255),
    adjrec_adjdesc character varying(255),
    adjrec_claimschedulenumber integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_adj_uat_test OWNER TO consultant01;

--
-- TOC entry 468 (class 1259 OID 25333)
-- Name: ztes_inv_agt; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_inv_agt (
    agentinvoice_invid integer NOT NULL,
    agentinvoice_agtidn integer NOT NULL,
    agentinvoice_finidn integer NOT NULL,
    agentinvoice_productid integer NOT NULL,
    sales_type integer NOT NULL,
    sales_count integer,
    sales_amount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_agt OWNER TO sp_postgres;

--
-- TOC entry 970 (class 1259 OID 1887692)
-- Name: ztes_inv_agt_bkup_20240902; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztes_inv_agt_bkup_20240902 (
    agentinvoice_invid integer,
    agentinvoice_agtidn integer,
    agentinvoice_finidn integer,
    agentinvoice_productid integer,
    sales_type integer,
    sales_count integer,
    sales_amount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_agt_bkup_20240902 OWNER TO postgres;

--
-- TOC entry 469 (class 1259 OID 25336)
-- Name: ztes_inv_agt_uat; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_inv_agt_uat (
    agentinvoice_invid integer,
    agentinvoice_agtidn integer,
    agentinvoice_finidn integer,
    agentinvoice_productid integer,
    sales_type integer,
    sales_count integer,
    sales_amount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_agt_uat OWNER TO sp_postgres;

--
-- TOC entry 470 (class 1259 OID 25339)
-- Name: ztes_inv_dev; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_inv_dev (
    deviceinvoice_salescdc integer NOT NULL,
    deviceinvoice_trmidn integer NOT NULL,
    deviceinvoice_productid integer NOT NULL,
    sales_type integer NOT NULL,
    deviceinvoice_agtidn integer,
    sales_count integer,
    sales_amount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_dev OWNER TO sp_postgres;

--
-- TOC entry 969 (class 1259 OID 1887689)
-- Name: ztes_inv_dev_bkup_20240902; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztes_inv_dev_bkup_20240902 (
    deviceinvoice_salescdc integer,
    deviceinvoice_trmidn integer,
    deviceinvoice_productid integer,
    sales_type integer,
    deviceinvoice_agtidn integer,
    sales_count integer,
    sales_amount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_dev_bkup_20240902 OWNER TO postgres;

--
-- TOC entry 937 (class 1259 OID 1846388)
-- Name: ztes_inv_dev_tfog2024; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_inv_dev_tfog2024 (
    deviceinvoice_salescdc integer NOT NULL,
    deviceinvoice_trmidn integer NOT NULL,
    deviceinvoice_productid integer NOT NULL,
    sales_type integer NOT NULL,
    deviceinvoice_agtidn integer,
    sales_count integer,
    sales_amount bigint,
    change_log_date timestamp without time zone,
    prod_sub_flag integer
);


ALTER TABLE public.ztes_inv_dev_tfog2024 OWNER TO sp_postgres;

--
-- TOC entry 471 (class 1259 OID 25342)
-- Name: ztes_inv_dev_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztes_inv_dev_uat_test (
    deviceinvoice_salescdc integer,
    deviceinvoice_trmidn integer,
    deviceinvoice_productid integer,
    sales_type integer,
    deviceinvoice_agtidn integer,
    sales_count integer,
    sales_amount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_dev_uat_test OWNER TO consultant01;

--
-- TOC entry 472 (class 1259 OID 25345)
-- Name: ztes_inv_invdef; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_inv_invdef (
    invoiceperiod integer NOT NULL,
    startdate date,
    enddate date,
    startcdc integer,
    endcdc integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_invdef OWNER TO sp_postgres;

--
-- TOC entry 473 (class 1259 OID 25348)
-- Name: ztes_inv_invdef2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_inv_invdef2 (
    retailtype integer NOT NULL,
    startdate date NOT NULL,
    enddate date,
    startcdc integer,
    endcdc integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_inv_invdef2 OWNER TO sp_postgres;

--
-- TOC entry 474 (class 1259 OID 25351)
-- Name: ztes_mjf_brdinf; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_brdinf (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    board_id integer NOT NULL,
    nbrsmp integer,
    basamt0 integer,
    basamt1 integer,
    basamt2 integer,
    actamt0 integer,
    actamt1 integer,
    actamt2 integer,
    qpmrks integer,
    bettyp integer,
    betcls integer,
    nbrmrks integer,
    reduced0 integer,
    reduced1 integer,
    reduced2 integer,
    transamt0 integer,
    transamt1 integer,
    salesamt0 double precision,
    salesamt1 double precision,
    commamt0 double precision,
    commamt1 double precision,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_mjf_brdinf OWNER TO sp_postgres;

--
-- TOC entry 475 (class 1259 OID 25354)
-- Name: ztes_mjf_brdnums; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_brdnums (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    board_id integer NOT NULL,
    board_desc character varying(255),
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_mjf_brdnums OWNER TO sp_postgres;

--
-- TOC entry 476 (class 1259 OID 25357)
-- Name: ztes_mjf_draws; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_draws (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    draws_draw integer NOT NULL,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_mjf_draws OWNER TO sp_postgres;

--
-- TOC entry 971 (class 1259 OID 1887695)
-- Name: ztes_mjf_draws_bkup_20240902; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztes_mjf_draws_bkup_20240902 (
    cdc integer,
    journaladdress bigint,
    draws_draw integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_mjf_draws_bkup_20240902 OWNER TO postgres;

--
-- TOC entry 918 (class 1259 OID 1666981)
-- Name: ztes_mjf_draws_dat184; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_draws_dat184 (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    draws_draw integer NOT NULL,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_mjf_draws_dat184 OWNER TO sp_postgres;

--
-- TOC entry 477 (class 1259 OID 25360)
-- Name: ztes_mjf_journals; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_journals (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    serial bigint,
    prod integer,
    trastats_source integer,
    entry integer,
    traerr integer,
    rejected character varying(1),
    traamt integer,
    tratrmidn integer,
    tratlr integer,
    traagt integer,
    tratim bigint,
    tratyp integer,
    trasub integer,
    trares integer,
    hdr_stats integer,
    nbrbrds integer,
    totamt integer,
    tktchg integer,
    duration integer,
    begdrw integer,
    enddrw integer,
    numdraws integer,
    cancel_cdc integer,
    cancel_ser bigint,
    fracwagerinfo_numfrac integer,
    fracwagerinfo_fracnum integer,
    partialwagerinfo_syndid integer,
    partialwagerinfo_syndrecid integer,
    partialwagerinfo_syndnumparts integer,
    partialwagerinfo_syndtotparts integer,
    saleamount0 double precision,
    saleamount1 double precision,
    commamount0 double precision,
    commamount1 double precision,
    validatinginfo_exchanged character varying(1),
    validatinginfo_cashed character varying(1),
    validatinginfo_refunded character varying(1),
    validatinginfo_inquiry character varying(1),
    validatinginfo_confirmed character varying(1),
    validatinginfo_claimreq character varying(1),
    validatinginfo_onbehalf character varying(1),
    validatinginfo_type integer,
    validatinginfo_oldsys integer,
    validatinginfo_cdc integer,
    validatinginfo_sellter integer,
    validatinginfo_lstwincdc integer,
    validatinginfo_serial bigint,
    validatinginfo_excser bigint,
    validatinginfo_sellagt integer,
    validatinginfo_lastdraw integer,
    validatinginfo_forteller integer,
    validatinginfo_reqtrmidn integer,
    partialwininf_syndid integer,
    partialwininf_syndrecid integer,
    partialwininf_syndnumparts integer,
    partialwininf_syndtotparts integer,
    change_log_date timestamp without time zone,
    bulkprintval integer,
    ebetslipinfo_mobnbr character varying(20),
    ebetslipinfo_reservedata1 character varying(20),
    ebetslipinfo_reservedata2 character varying(20),
    ebetslipinfo_reservedata3 character varying(20),
    ebetslipinfo_reservedata4 character varying(20),
    esaextchaninfo_chainid integer,
    esaextchaninfo_agentid integer,
    esaextchaninfo_terminalid integer,
    esaextchaninfo_tellerid integer,
    esaextchaninfo_foreignserial bigint,
    esaextchaninfo_sessionid character varying(50),
    uuid character varying(19),
    channeltype character varying(1),
    channelsubtype character varying(1),
    totomatch_tfogflag integer
);


ALTER TABLE public.ztes_mjf_journals OWNER TO sp_postgres;

--
-- TOC entry 889 (class 1259 OID 1442380)
-- Name: ztes_mjf_journals_bk20240604; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_journals_bk20240604 (
    cdc integer,
    journaladdress bigint,
    serial bigint,
    prod integer,
    trastats_source integer,
    entry integer,
    traerr integer,
    rejected character varying(1),
    traamt integer,
    tratrmidn integer,
    tratlr integer,
    traagt integer,
    tratim bigint,
    tratyp integer,
    trasub integer,
    trares integer,
    hdr_stats integer,
    nbrbrds integer,
    totamt integer,
    tktchg integer,
    duration integer,
    begdrw integer,
    enddrw integer,
    numdraws integer,
    cancel_cdc integer,
    cancel_ser bigint,
    fracwagerinfo_numfrac integer,
    fracwagerinfo_fracnum integer,
    partialwagerinfo_syndid integer,
    partialwagerinfo_syndrecid integer,
    partialwagerinfo_syndnumparts integer,
    partialwagerinfo_syndtotparts integer,
    saleamount0 double precision,
    saleamount1 double precision,
    commamount0 double precision,
    commamount1 double precision,
    validatinginfo_exchanged character varying(1),
    validatinginfo_cashed character varying(1),
    validatinginfo_refunded character varying(1),
    validatinginfo_inquiry character varying(1),
    validatinginfo_confirmed character varying(1),
    validatinginfo_claimreq character varying(1),
    validatinginfo_onbehalf character varying(1),
    validatinginfo_type integer,
    validatinginfo_oldsys integer,
    validatinginfo_cdc integer,
    validatinginfo_sellter integer,
    validatinginfo_lstwincdc integer,
    validatinginfo_serial bigint,
    validatinginfo_excser bigint,
    validatinginfo_sellagt integer,
    validatinginfo_lastdraw integer,
    validatinginfo_forteller integer,
    validatinginfo_reqtrmidn integer,
    partialwininf_syndid integer,
    partialwininf_syndrecid integer,
    partialwininf_syndnumparts integer,
    partialwininf_syndtotparts integer,
    change_log_date timestamp without time zone,
    bulkprintval integer,
    ebetslipinfo_mobnbr character varying(20),
    ebetslipinfo_reservedata1 character varying(20),
    ebetslipinfo_reservedata2 character varying(20),
    ebetslipinfo_reservedata3 character varying(20),
    ebetslipinfo_reservedata4 character varying(20),
    esaextchaninfo_chainid integer,
    esaextchaninfo_agentid integer,
    esaextchaninfo_terminalid integer,
    esaextchaninfo_tellerid integer,
    esaextchaninfo_foreignserial bigint,
    esaextchaninfo_sessionid character varying(50),
    uuid character varying(19)
);


ALTER TABLE public.ztes_mjf_journals_bk20240604 OWNER TO sp_postgres;

--
-- TOC entry 1017 (class 1259 OID 2255639)
-- Name: ztes_mjf_journals_bk20241212_rename; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_journals_bk20241212_rename (
    cdc integer,
    journaladdress bigint,
    serial bigint,
    prod integer,
    trastats_source integer,
    entry integer,
    traerr integer,
    rejected character varying(1),
    traamt integer,
    tratrmidn integer,
    tratlr integer,
    traagt integer,
    tratim bigint,
    tratyp integer,
    trasub integer,
    trares integer,
    hdr_stats integer,
    nbrbrds integer,
    totamt integer,
    tktchg integer,
    duration integer,
    begdrw integer,
    enddrw integer,
    numdraws integer,
    cancel_cdc integer,
    cancel_ser bigint,
    fracwagerinfo_numfrac integer,
    fracwagerinfo_fracnum integer,
    partialwagerinfo_syndid integer,
    partialwagerinfo_syndrecid integer,
    partialwagerinfo_syndnumparts integer,
    partialwagerinfo_syndtotparts integer,
    saleamount0 double precision,
    saleamount1 double precision,
    commamount0 double precision,
    commamount1 double precision,
    validatinginfo_exchanged character varying(1),
    validatinginfo_cashed character varying(1),
    validatinginfo_refunded character varying(1),
    validatinginfo_inquiry character varying(1),
    validatinginfo_confirmed character varying(1),
    validatinginfo_claimreq character varying(1),
    validatinginfo_onbehalf character varying(1),
    validatinginfo_type integer,
    validatinginfo_oldsys integer,
    validatinginfo_cdc integer,
    validatinginfo_sellter integer,
    validatinginfo_lstwincdc integer,
    validatinginfo_serial bigint,
    validatinginfo_excser bigint,
    validatinginfo_sellagt integer,
    validatinginfo_lastdraw integer,
    validatinginfo_forteller integer,
    validatinginfo_reqtrmidn integer,
    partialwininf_syndid integer,
    partialwininf_syndrecid integer,
    partialwininf_syndnumparts integer,
    partialwininf_syndtotparts integer,
    change_log_date timestamp without time zone,
    bulkprintval integer,
    ebetslipinfo_mobnbr character varying(20),
    ebetslipinfo_reservedata1 character varying(20),
    ebetslipinfo_reservedata2 character varying(20),
    ebetslipinfo_reservedata3 character varying(20),
    ebetslipinfo_reservedata4 character varying(20),
    esaextchaninfo_chainid integer,
    esaextchaninfo_agentid integer,
    esaextchaninfo_terminalid integer,
    esaextchaninfo_tellerid integer,
    esaextchaninfo_foreignserial bigint,
    esaextchaninfo_sessionid character varying(50),
    uuid character varying(19),
    channeltype character varying(1),
    channelsubtype character varying(1),
    hdr_tfogflag integer
);


ALTER TABLE public.ztes_mjf_journals_bk20241212_rename OWNER TO sp_postgres;

--
-- TOC entry 972 (class 1259 OID 1887698)
-- Name: ztes_mjf_journals_bkup_20240902; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztes_mjf_journals_bkup_20240902 (
    cdc integer,
    journaladdress bigint,
    serial bigint,
    prod integer,
    trastats_source integer,
    entry integer,
    traerr integer,
    rejected character varying(1),
    traamt integer,
    tratrmidn integer,
    tratlr integer,
    traagt integer,
    tratim bigint,
    tratyp integer,
    trasub integer,
    trares integer,
    hdr_stats integer,
    nbrbrds integer,
    totamt integer,
    tktchg integer,
    duration integer,
    begdrw integer,
    enddrw integer,
    numdraws integer,
    cancel_cdc integer,
    cancel_ser bigint,
    fracwagerinfo_numfrac integer,
    fracwagerinfo_fracnum integer,
    partialwagerinfo_syndid integer,
    partialwagerinfo_syndrecid integer,
    partialwagerinfo_syndnumparts integer,
    partialwagerinfo_syndtotparts integer,
    saleamount0 double precision,
    saleamount1 double precision,
    commamount0 double precision,
    commamount1 double precision,
    validatinginfo_exchanged character varying(1),
    validatinginfo_cashed character varying(1),
    validatinginfo_refunded character varying(1),
    validatinginfo_inquiry character varying(1),
    validatinginfo_confirmed character varying(1),
    validatinginfo_claimreq character varying(1),
    validatinginfo_onbehalf character varying(1),
    validatinginfo_type integer,
    validatinginfo_oldsys integer,
    validatinginfo_cdc integer,
    validatinginfo_sellter integer,
    validatinginfo_lstwincdc integer,
    validatinginfo_serial bigint,
    validatinginfo_excser bigint,
    validatinginfo_sellagt integer,
    validatinginfo_lastdraw integer,
    validatinginfo_forteller integer,
    validatinginfo_reqtrmidn integer,
    partialwininf_syndid integer,
    partialwininf_syndrecid integer,
    partialwininf_syndnumparts integer,
    partialwininf_syndtotparts integer,
    change_log_date timestamp without time zone,
    bulkprintval integer,
    ebetslipinfo_mobnbr character varying(20),
    ebetslipinfo_reservedata1 character varying(20),
    ebetslipinfo_reservedata2 character varying(20),
    ebetslipinfo_reservedata3 character varying(20),
    ebetslipinfo_reservedata4 character varying(20),
    esaextchaninfo_chainid integer,
    esaextchaninfo_agentid integer,
    esaextchaninfo_terminalid integer,
    esaextchaninfo_tellerid integer,
    esaextchaninfo_foreignserial bigint,
    esaextchaninfo_sessionid character varying(50),
    uuid character varying(19),
    channeltype integer,
    channelsubtype integer,
    hdr_tfogflag integer
);


ALTER TABLE public.ztes_mjf_journals_bkup_20240902 OWNER TO postgres;

--
-- TOC entry 879 (class 1259 OID 1320739)
-- Name: ztes_mjf_journals_lsr_hds2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_journals_lsr_hds2 (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    serial bigint,
    prod integer,
    trastats_source integer,
    entry integer,
    traerr integer,
    rejected character varying(1),
    traamt integer,
    tratrmidn integer,
    tratlr integer,
    traagt integer,
    tratim bigint,
    tratyp integer,
    trasub integer,
    trares integer,
    hdr_stats integer,
    nbrbrds integer,
    totamt integer,
    tktchg integer,
    duration integer,
    begdrw integer,
    enddrw integer,
    numdraws integer,
    cancel_cdc integer,
    cancel_ser bigint,
    fracwagerinfo_numfrac integer,
    fracwagerinfo_fracnum integer,
    partialwagerinfo_syndid integer,
    partialwagerinfo_syndrecid integer,
    partialwagerinfo_syndnumparts integer,
    partialwagerinfo_syndtotparts integer,
    saleamount0 double precision,
    saleamount1 double precision,
    commamount0 double precision,
    commamount1 double precision,
    validatinginfo_exchanged character varying(1),
    validatinginfo_cashed character varying(1),
    validatinginfo_refunded character varying(1),
    validatinginfo_inquiry character varying(1),
    validatinginfo_confirmed character varying(1),
    validatinginfo_claimreq character varying(1),
    validatinginfo_onbehalf character varying(1),
    validatinginfo_type integer,
    validatinginfo_oldsys integer,
    validatinginfo_cdc integer,
    validatinginfo_sellter integer,
    validatinginfo_lstwincdc integer,
    validatinginfo_serial bigint,
    validatinginfo_excser bigint,
    validatinginfo_sellagt integer,
    validatinginfo_lastdraw integer,
    validatinginfo_forteller integer,
    validatinginfo_reqtrmidn integer,
    partialwininf_syndid integer,
    partialwininf_syndrecid integer,
    partialwininf_syndnumparts integer,
    partialwininf_syndtotparts integer,
    change_log_date timestamp without time zone,
    bulkprintval integer,
    ebetslipinfo_mobnbr character varying(20),
    ebetslipinfo_reservedata1 character varying(20),
    ebetslipinfo_reservedata2 character varying(20),
    ebetslipinfo_reservedata3 character varying(20),
    ebetslipinfo_reservedata4 character varying(20),
    esaextchaninfo_chainid integer,
    esaextchaninfo_agentid integer,
    esaextchaninfo_terminalid integer,
    esaextchaninfo_tellerid integer,
    esaextchaninfo_foreignserial bigint,
    esaextchaninfo_sessionid character varying(50),
    uuid character varying(19),
    channeltype integer,
    channelsubtype integer
);


ALTER TABLE public.ztes_mjf_journals_lsr_hds2 OWNER TO sp_postgres;

--
-- TOC entry 938 (class 1259 OID 1846398)
-- Name: ztes_mjf_journals_tfog2024; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_journals_tfog2024 (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    serial bigint,
    prod integer,
    trastats_source integer,
    entry integer,
    traerr integer,
    rejected character varying(1),
    traamt integer,
    tratrmidn integer,
    tratlr integer,
    traagt integer,
    tratim bigint,
    tratyp integer,
    trasub integer,
    trares integer,
    hdr_stats integer,
    nbrbrds integer,
    totamt integer,
    tktchg integer,
    duration integer,
    begdrw integer,
    enddrw integer,
    numdraws integer,
    cancel_cdc integer,
    cancel_ser bigint,
    fracwagerinfo_numfrac integer,
    fracwagerinfo_fracnum integer,
    partialwagerinfo_syndid integer,
    partialwagerinfo_syndrecid integer,
    partialwagerinfo_syndnumparts integer,
    partialwagerinfo_syndtotparts integer,
    saleamount0 double precision,
    saleamount1 double precision,
    commamount0 double precision,
    commamount1 double precision,
    validatinginfo_exchanged character varying(1),
    validatinginfo_cashed character varying(1),
    validatinginfo_refunded character varying(1),
    validatinginfo_inquiry character varying(1),
    validatinginfo_confirmed character varying(1),
    validatinginfo_claimreq character varying(1),
    validatinginfo_onbehalf character varying(1),
    validatinginfo_type integer,
    validatinginfo_oldsys integer,
    validatinginfo_cdc integer,
    validatinginfo_sellter integer,
    validatinginfo_lstwincdc integer,
    validatinginfo_serial bigint,
    validatinginfo_excser bigint,
    validatinginfo_sellagt integer,
    validatinginfo_lastdraw integer,
    validatinginfo_forteller integer,
    validatinginfo_reqtrmidn integer,
    partialwininf_syndid integer,
    partialwininf_syndrecid integer,
    partialwininf_syndnumparts integer,
    partialwininf_syndtotparts integer,
    change_log_date timestamp without time zone,
    bulkprintval integer,
    ebetslipinfo_mobnbr character varying(20),
    ebetslipinfo_reservedata1 character varying(20),
    ebetslipinfo_reservedata2 character varying(20),
    ebetslipinfo_reservedata3 character varying(20),
    ebetslipinfo_reservedata4 character varying(20),
    esaextchaninfo_chainid integer,
    esaextchaninfo_agentid integer,
    esaextchaninfo_terminalid integer,
    esaextchaninfo_tellerid integer,
    esaextchaninfo_foreignserial bigint,
    esaextchaninfo_sessionid character varying(50),
    uuid character varying(19),
    channeltype integer,
    channelsubtype integer,
    hdr_tfogflag integer
);


ALTER TABLE public.ztes_mjf_journals_tfog2024 OWNER TO sp_postgres;

--
-- TOC entry 478 (class 1259 OID 25363)
-- Name: ztes_mjf_windtl; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_windtl (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    id integer NOT NULL,
    casflg character varying(1),
    expflg character varying(1),
    eftflg character varying(1),
    winset integer,
    division integer,
    draw integer,
    game integer,
    winloadcdc integer,
    expcdc integer,
    amount bigint,
    bettyp integer,
    cashcdc integer,
    validationcomm bigint,
    change_log_date timestamp without time zone,
    refflg character varying(1)
);


ALTER TABLE public.ztes_mjf_windtl OWNER TO sp_postgres;

--
-- TOC entry 888 (class 1259 OID 1442377)
-- Name: ztes_mjf_windtl_bk20240604; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_windtl_bk20240604 (
    cdc integer,
    journaladdress bigint,
    id integer,
    casflg character varying(1),
    expflg character varying(1),
    eftflg character varying(1),
    winset integer,
    division integer,
    draw integer,
    game integer,
    winloadcdc integer,
    expcdc integer,
    amount bigint,
    bettyp integer,
    cashcdc integer,
    validationcomm bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_mjf_windtl_bk20240604 OWNER TO sp_postgres;

--
-- TOC entry 880 (class 1259 OID 1320771)
-- Name: ztes_mjf_windtl_lsr_hds2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_windtl_lsr_hds2 (
    cdc integer NOT NULL,
    journaladdress bigint NOT NULL,
    id integer NOT NULL,
    casflg character varying(1),
    expflg character varying(1),
    eftflg character varying(1),
    refflg character varying(1),
    winset integer,
    division integer,
    draw integer,
    game integer,
    winloadcdc integer,
    expcdc integer,
    amount bigint,
    bettyp integer,
    cashcdc integer,
    validationcomm bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_mjf_windtl_lsr_hds2 OWNER TO sp_postgres;

--
-- TOC entry 881 (class 1259 OID 1321906)
-- Name: ztes_mjf_winnereftdetail_lsr_hds_bk; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_mjf_winnereftdetail_lsr_hds_bk (
    journaladdress bigint,
    cdc integer,
    id integer,
    casflg character varying(1),
    refflg character varying(1),
    eftflg character varying(1),
    expflg character varying(1),
    division integer,
    winset integer,
    draw integer,
    expcdc integer,
    amount bigint,
    cashcdc integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_mjf_winnereftdetail_lsr_hds_bk OWNER TO sp_postgres;

--
-- TOC entry 479 (class 1259 OID 25366)
-- Name: ztes_orphans; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_orphans (
    cdc integer NOT NULL,
    requestid bigint NOT NULL,
    operatorid character varying(8),
    terminalid bigint,
    transtime timestamp without time zone,
    hostsys character varying(3),
    product integer,
    details character varying(255),
    transamt numeric(17,2),
    status character varying(20)
);


ALTER TABLE public.ztes_orphans OWNER TO sp_postgres;

--
-- TOC entry 480 (class 1259 OID 25369)
-- Name: ztes_orphans_output; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_orphans_output (
    requestid bigint NOT NULL,
    operatorid character varying(8),
    terminalid bigint,
    locationid integer,
    transtime timestamp without time zone,
    product character varying(8),
    details character varying(255),
    status character varying(20),
    transtype character varying(8),
    wageramt numeric(17,2),
    salesamt numeric(17,2),
    drawnum integer,
    drawdate character varying(30),
    drawday character varying(30)
);


ALTER TABLE public.ztes_orphans_output OWNER TO sp_postgres;

--
-- TOC entry 481 (class 1259 OID 25372)
-- Name: ztes_orphans_output_board; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_orphans_output_board (
    requestid bigint NOT NULL,
    operatorid character varying(8),
    terminalid bigint,
    locationid integer,
    transtime timestamp without time zone,
    product character varying(8),
    transtype character varying(8),
    board_id integer,
    board_desc character varying(30),
    drawnum integer,
    transamt0 integer,
    transamt1 integer,
    bettyp integer,
    fracwagerinfo_fracnum integer,
    partialwagerinfo_syndid integer
);


ALTER TABLE public.ztes_orphans_output_board OWNER TO sp_postgres;

--
-- TOC entry 482 (class 1259 OID 25375)
-- Name: ztes_orphans_requestid; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_orphans_requestid (
    date date NOT NULL,
    requestid bigint NOT NULL
);


ALTER TABLE public.ztes_orphans_requestid OWNER TO sp_postgres;

--
-- TOC entry 483 (class 1259 OID 25378)
-- Name: ztes_pdf_drawparam; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_drawparam (
    productnum integer NOT NULL,
    drawnumber integer NOT NULL,
    winset_id integer NOT NULL,
    przdiv_id integer NOT NULL,
    drawcdc integer,
    drawdates_daydraw integer,
    drawparam_nbrwinset integer,
    drawparam_przpoolperc integer,
    jackpotestimate1 bigint,
    jackpotestimate2 bigint,
    productname character varying(20),
    subproductnum integer,
    winset_winsetactive integer,
    winset_setname character varying(40),
    przdiv_divname character varying(40),
    change_log_date timestamp without time zone,
    drawstatus_canceld character varying(1)
);


ALTER TABLE public.ztes_pdf_drawparam OWNER TO sp_postgres;

--
-- TOC entry 890 (class 1259 OID 1442383)
-- Name: ztes_pdf_drawparam_bk20240604; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_drawparam_bk20240604 (
    productnum integer,
    drawnumber integer,
    winset_id integer,
    przdiv_id integer,
    drawcdc integer,
    drawdates_daydraw integer,
    drawparam_nbrwinset integer,
    drawparam_przpoolperc integer,
    jackpotestimate1 bigint,
    jackpotestimate2 bigint,
    productname character varying(20),
    subproductnum integer,
    winset_winsetactive integer,
    winset_setname character varying(40),
    przdiv_divname character varying(40),
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_drawparam_bk20240604 OWNER TO sp_postgres;

--
-- TOC entry 1012 (class 1259 OID 2152046)
-- Name: ztes_pdf_drawparam_bk_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_drawparam_bk_sit (
    productnum integer,
    drawnumber integer,
    winset_id integer,
    przdiv_id integer,
    drawcdc integer,
    drawdates_daydraw integer,
    drawparam_nbrwinset integer,
    drawparam_przpoolperc integer,
    jackpotestimate1 bigint,
    jackpotestimate2 bigint,
    productname character varying(20),
    subproductnum integer,
    winset_winsetactive integer,
    winset_setname character varying(40),
    przdiv_divname character varying(40),
    change_log_date timestamp without time zone,
    drawstatus_canceld character varying(1)
);


ALTER TABLE public.ztes_pdf_drawparam_bk_sit OWNER TO sp_postgres;

--
-- TOC entry 973 (class 1259 OID 1887701)
-- Name: ztes_pdf_drawparam_bkup_20240902; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztes_pdf_drawparam_bkup_20240902 (
    productnum integer,
    drawnumber integer,
    winset_id integer,
    przdiv_id integer,
    drawcdc integer,
    drawdates_daydraw integer,
    drawparam_nbrwinset integer,
    drawparam_przpoolperc integer,
    jackpotestimate1 bigint,
    jackpotestimate2 bigint,
    productname character varying(20),
    subproductnum integer,
    winset_winsetactive integer,
    winset_setname character varying(40),
    przdiv_divname character varying(40),
    change_log_date timestamp without time zone,
    drawstatus_canceld character varying(1)
);


ALTER TABLE public.ztes_pdf_drawparam_bkup_20240902 OWNER TO postgres;

--
-- TOC entry 977 (class 1259 OID 1909153)
-- Name: ztes_pdf_drawparam_bkup_240909; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztes_pdf_drawparam_bkup_240909 (
    productnum integer,
    drawnumber integer,
    winset_id integer,
    przdiv_id integer,
    drawcdc integer,
    drawdates_daydraw integer,
    drawparam_nbrwinset integer,
    drawparam_przpoolperc integer,
    jackpotestimate1 bigint,
    jackpotestimate2 bigint,
    productname character varying(20),
    subproductnum integer,
    winset_winsetactive integer,
    winset_setname character varying(40),
    przdiv_divname character varying(40),
    change_log_date timestamp without time zone,
    drawstatus_canceld character varying(1)
);


ALTER TABLE public.ztes_pdf_drawparam_bkup_240909 OWNER TO postgres;

--
-- TOC entry 877 (class 1259 OID 1312828)
-- Name: ztes_pdf_drawparam_lsr_hds2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_drawparam_lsr_hds2 (
    productnum integer NOT NULL,
    drawcdc integer,
    winset_id integer NOT NULL,
    przdiv_id integer NOT NULL,
    drawnumber integer NOT NULL,
    drawdates_daydraw integer,
    drawparam_nbrwinset integer,
    drawparam_przpoolperc integer,
    drawstatus_canceld character varying(1),
    jackpotestimate1 bigint,
    jackpotestimate2 bigint,
    productname character varying(20),
    subproductnum integer,
    winset_winsetactive integer,
    winset_setname character varying(40),
    przdiv_divname character varying(40),
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_drawparam_lsr_hds2 OWNER TO sp_postgres;

--
-- TOC entry 484 (class 1259 OID 25381)
-- Name: ztes_pdf_liabcon; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_liabcon (
    productnum integer NOT NULL,
    drawnumber integer NOT NULL,
    bettyp_id integer NOT NULL,
    drawcdc integer,
    drawdates_daydraw integer,
    productname character varying(20),
    hot1liabamt bigint,
    hot2liabamt bigint,
    regliabamt bigint,
    change_log_date timestamp without time zone,
    drawstatus_canceld character varying(1)
);


ALTER TABLE public.ztes_pdf_liabcon OWNER TO sp_postgres;

--
-- TOC entry 891 (class 1259 OID 1442386)
-- Name: ztes_pdf_liabcon_bk20240604; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_liabcon_bk20240604 (
    productnum integer,
    drawnumber integer,
    bettyp_id integer,
    drawcdc integer,
    drawdates_daydraw integer,
    productname character varying(20),
    hot1liabamt bigint,
    hot2liabamt bigint,
    regliabamt bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_liabcon_bk20240604 OWNER TO sp_postgres;

--
-- TOC entry 878 (class 1259 OID 1312831)
-- Name: ztes_pdf_liabcon_lsr_hds2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_liabcon_lsr_hds2 (
    productnum double precision NOT NULL,
    drawcdc double precision,
    bettyp_id double precision NOT NULL,
    drawdates_daydraw double precision,
    drawnumber double precision NOT NULL,
    productname character varying(20),
    drawstatus_canceld character varying(1),
    hot1liabamt double precision,
    hot2liabamt double precision,
    regliabamt double precision,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_liabcon_lsr_hds2 OWNER TO sp_postgres;

--
-- TOC entry 485 (class 1259 OID 25384)
-- Name: ztes_pdf_syndbrddtl; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_syndbrddtl (
    hdr_recid integer NOT NULL,
    hdr_syndid integer NOT NULL,
    board_id integer NOT NULL,
    productnum integer,
    board_desc character varying(255),
    board_bettyp integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_syndbrddtl OWNER TO sp_postgres;

--
-- TOC entry 486 (class 1259 OID 25387)
-- Name: ztes_pdf_synddef; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_synddef (
    currentcdc integer NOT NULL,
    currentdraw integer NOT NULL,
    item_id integer NOT NULL,
    item_status integer,
    item_startdraw integer,
    item_enddraw integer,
    definition_syndid integer,
    definition_nonewsyndduration integer,
    definition_suppressnewflag integer,
    definition_stake integer,
    definition_autoextendable integer,
    definition_delinkeddraw integer,
    definition_numboards integer,
    definition_numparts integer,
    definition_tktchgamount integer,
    definition_maxwagers integer,
    definition_bettype character varying(20),
    definition_validparts character varying(20),
    definition_name character varying(40),
    syndicatelist_numitems integer,
    syndicatelist_lastsyndid integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_synddef OWNER TO sp_postgres;

--
-- TOC entry 487 (class 1259 OID 25390)
-- Name: ztes_pdf_synddrwdtl; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_synddrwdtl (
    hdr_recid integer NOT NULL,
    hdr_syndid integer NOT NULL,
    draw_id integer NOT NULL,
    productnum integer,
    draw_drawnumber integer,
    draw_partssold integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_synddrwdtl OWNER TO sp_postgres;

--
-- TOC entry 488 (class 1259 OID 25393)
-- Name: ztes_pdf_syndrecs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_syndrecs (
    hdr_recid integer NOT NULL,
    hdr_syndid integer NOT NULL,
    productnum integer,
    productname character varying(20),
    hdr_status integer,
    hdr_startdraw integer,
    hdr_enddraw integer,
    hdr_createcdc integer,
    hdr_updatecdc integer,
    hdr_closecdc integer,
    syndicaterec_numparts integer,
    syndicaterec_numdraws integer,
    syndicaterec_numboards integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_syndrecs OWNER TO sp_postgres;

--
-- TOC entry 489 (class 1259 OID 25396)
-- Name: ztes_pdf_winnbr; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_winnbr (
    productnum integer NOT NULL,
    drawcdc integer NOT NULL,
    winset_id integer NOT NULL,
    windiv_id integer NOT NULL,
    subproductnum integer,
    productname character varying(20),
    drawnumber integer,
    winnbrs character varying(255),
    winplus integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_winnbr OWNER TO sp_postgres;

--
-- TOC entry 490 (class 1259 OID 25399)
-- Name: ztes_pdf_winshares; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_pdf_winshares (
    productnum integer NOT NULL,
    drawcdc integer NOT NULL,
    winset_id integer NOT NULL,
    windiv_id integer NOT NULL,
    subproductnum integer,
    productname character varying(20),
    drawnumber integer,
    shrcount integer,
    shramount bigint,
    shrpayablecdc integer,
    othshrcount integer,
    offshrcount integer,
    shrclcamount bigint,
    shrpayable bigint,
    totalamount bigint,
    shrrounding integer,
    shrpaid bigint,
    shrpaideft integer,
    shrexpired bigint,
    pollforallocation bigint,
    seedingtype integer,
    cashcontribution bigint,
    syndtotalwonamt bigint,
    fractotalwonamt bigint,
    syndtotalbrkageamt bigint,
    fractotalbrkageamt bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_winshares OWNER TO sp_postgres;

--
-- TOC entry 974 (class 1259 OID 1887704)
-- Name: ztes_pdf_winshares_bkup_20240902; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztes_pdf_winshares_bkup_20240902 (
    productnum integer,
    drawcdc integer,
    winset_id integer,
    windiv_id integer,
    subproductnum integer,
    productname character varying(20),
    drawnumber integer,
    shrcount integer,
    shramount bigint,
    shrpayablecdc integer,
    othshrcount integer,
    offshrcount integer,
    shrclcamount bigint,
    shrpayable bigint,
    totalamount bigint,
    shrrounding integer,
    shrpaid bigint,
    shrpaideft integer,
    shrexpired bigint,
    pollforallocation bigint,
    seedingtype integer,
    cashcontribution bigint,
    syndtotalwonamt bigint,
    fractotalwonamt bigint,
    syndtotalbrkageamt bigint,
    fractotalbrkageamt bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_pdf_winshares_bkup_20240902 OWNER TO postgres;

--
-- TOC entry 491 (class 1259 OID 25402)
-- Name: ztes_totallog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztes_totallog (
    busdate date NOT NULL,
    log_id integer NOT NULL,
    tradate date,
    tratime time without time zone,
    agent integer,
    terminal integer,
    teller integer,
    tratype integer,
    trastatus integer,
    tracount integer,
    traamt double precision,
    tramethod integer,
    custcount integer,
    tracountgrp integer,
    traamtgrp character varying(255),
    tratimegrp character varying(255),
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztes_totallog OWNER TO sp_postgres;

--
-- TOC entry 492 (class 1259 OID 25408)
-- Name: ztetl_log; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztetl_log (
    system character varying(30) NOT NULL,
    log_timestamp timestamp(0) without time zone NOT NULL,
    etl_name character varying(255) NOT NULL,
    log_date date,
    log_time time(0) without time zone,
    status character varying(1)
);


ALTER TABLE public.ztetl_log OWNER TO sp_postgres;

--
-- TOC entry 493 (class 1259 OID 25411)
-- Name: ztfr_txn; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztfr_txn (
    frtxnid character varying(50) NOT NULL,
    branchid character varying(50),
    terminalid character varying(50),
    txndate date,
    starttime time(0) without time zone,
    endtime time(0) without time zone,
    faceid character varying(50),
    age double precision,
    gender character varying(1),
    noofdetections integer,
    facemaskflag character varying(1),
    fr_timestamp timestamp without time zone,
    to_timestamp timestamp without time zone
);


ALTER TABLE public.ztfr_txn OWNER TO sp_postgres;

--
-- TOC entry 494 (class 1259 OID 25414)
-- Name: ztkyc_agents; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztkyc_agents (
    id character varying(256) NOT NULL,
    availability integer,
    createdbyid character varying(256),
    createdtime timestamp without time zone,
    lastupdatedbyid character varying(256),
    lastupdatedtime timestamp without time zone,
    name character varying(256),
    logtime timestamp without time zone
);


ALTER TABLE public.ztkyc_agents OWNER TO sp_postgres;

--
-- TOC entry 495 (class 1259 OID 25420)
-- Name: ztkyc_applicationdurationhistory; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztkyc_applicationdurationhistory (
    id integer NOT NULL,
    applicationid integer,
    createdbyid character varying(256),
    createdtime timestamp without time zone,
    lastupdatedbyid character varying(256),
    lastupdatedtime timestamp without time zone,
    customerwaitingduration character varying(20),
    videocallduration character varying(20),
    csohandlingduration character varying(20),
    osinfo character varying(256),
    browserinfo character varying(256),
    action character varying(50),
    actionremarks text,
    logtime timestamp without time zone
);


ALTER TABLE public.ztkyc_applicationdurationhistory OWNER TO sp_postgres;

--
-- TOC entry 496 (class 1259 OID 25426)
-- Name: ztkyc_applications; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztkyc_applications (
    id integer NOT NULL,
    attempts integer,
    checkerid character varying(256),
    createdbyid character varying(256),
    createdtime timestamp without time zone,
    customeraccountnum character varying(32),
    disconnects integer,
    kycstatusid integer,
    lastupdatedbyid character varying(256),
    lastupdatedtime timestamp without time zone,
    makerid character varying(256),
    statusremarks text,
    submittedtime timestamp without time zone,
    surveyanswerid integer,
    logtime timestamp without time zone
);


ALTER TABLE public.ztkyc_applications OWNER TO sp_postgres;

--
-- TOC entry 497 (class 1259 OID 25432)
-- Name: ztkyc_applicationstatushistory; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztkyc_applicationstatushistory (
    id integer NOT NULL,
    action character varying(50),
    actionremarks text,
    agentid character varying(256),
    applicationid integer,
    createdbyid character varying(256),
    createdtime timestamp without time zone,
    lastupdatedbyid character varying(256),
    lastupdatedtime timestamp without time zone,
    roleid integer,
    statuschangefromid integer,
    statuschangetoid integer,
    logtime timestamp without time zone
);


ALTER TABLE public.ztkyc_applicationstatushistory OWNER TO sp_postgres;

--
-- TOC entry 498 (class 1259 OID 25438)
-- Name: ztkyc_dashboard; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztkyc_dashboard (
    id integer NOT NULL,
    callsoffered integer,
    callshandled integer,
    callsabandonded integer,
    callsinqueue integer,
    longestinqueue character varying(20),
    servicelevel character varying(20),
    callshandledwithinsl integer,
    callsabandondedwithinsl integer,
    createdbyid character varying(256),
    createdtime timestamp without time zone,
    lastupdatedbyid character varying(256),
    lastupdatedtime timestamp without time zone,
    logtime timestamp without time zone
);


ALTER TABLE public.ztkyc_dashboard OWNER TO sp_postgres;

--
-- TOC entry 499 (class 1259 OID 25444)
-- Name: ztkyc_kycstatus; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztkyc_kycstatus (
    id integer NOT NULL,
    createdbyid character varying(256),
    createdtime timestamp without time zone,
    description character varying(256),
    lastupdatedbyid character varying(256),
    lastupdatedtime timestamp without time zone,
    status character varying(50),
    logtime timestamp without time zone
);


ALTER TABLE public.ztkyc_kycstatus OWNER TO sp_postgres;

--
-- TOC entry 500 (class 1259 OID 25450)
-- Name: ztkyc_role; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztkyc_role (
    id integer NOT NULL,
    createdbyid character varying(256),
    createdtime timestamp without time zone,
    description character varying(256),
    lastupdatedbyid character varying(256),
    lastupdatedtime timestamp without time zone,
    role character varying(250),
    logtime timestamp without time zone
);


ALTER TABLE public.ztkyc_role OWNER TO sp_postgres;

--
-- TOC entry 501 (class 1259 OID 25456)
-- Name: ztmf_surveyresult; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmf_surveyresult (
    username character varying(32) NOT NULL,
    version character varying(100) NOT NULL,
    survey_start timestamp without time zone NOT NULL,
    q1_score integer,
    q1_time timestamp without time zone,
    q2_score integer,
    q2_time timestamp without time zone,
    q3_score integer,
    q3_time timestamp without time zone,
    q4_score integer,
    q4_time timestamp without time zone,
    q5_score integer,
    q5_time timestamp without time zone,
    q6_score integer,
    q6_time timestamp without time zone,
    q7_score integer,
    q7_time timestamp without time zone,
    q8_score integer,
    q8_time timestamp without time zone,
    q9_score integer,
    q9_time timestamp without time zone,
    final_score integer,
    completed_time timestamp without time zone,
    resume_time timestamp without time zone
);


ALTER TABLE public.ztmf_surveyresult OWNER TO sp_postgres;

--
-- TOC entry 502 (class 1259 OID 25459)
-- Name: ztmm2_cancel; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_cancel (
    canceldate date NOT NULL,
    canceltime time without time zone NOT NULL,
    betid character varying(12) NOT NULL,
    matchcode character varying(12) NOT NULL,
    busdate date,
    recordtype character varying(2),
    canceltimestamp timestamp without time zone,
    betdate date,
    bettime time without time zone,
    bettimestamp timestamp without time zone,
    bettype character varying(2),
    betslipid character varying(12),
    cancelretailer character varying(6),
    cancelterminal character varying(8),
    cancelteller character varying(8),
    wagerretailer character varying(6),
    wagerterminal character varying(8),
    bookid character varying(14),
    matchdate date,
    settledate date,
    selection character varying(40),
    odds character varying(5),
    positions character varying(10),
    cancelodds character varying(5),
    cancelpositions character varying(10),
    riskmanagerid character varying(15),
    cancelresult character varying(1),
    freebet character varying(1),
    matchname1 character varying(60),
    matchname2 character varying(60),
    matchname3 character varying(60),
    matchname4 character varying(60),
    matchname5 character varying(60),
    betamt double precision,
    salesamt double precision,
    payoutamt double precision,
    tracount integer,
    matchname character varying(300),
    cancel_busdate_id integer,
    system character varying(30)
);


ALTER TABLE public.ztmm2_cancel OWNER TO sp_postgres;

--
-- TOC entry 503 (class 1259 OID 25465)
-- Name: ztmm2_invoiceperterminal; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_invoiceperterminal (
    invoicedate date NOT NULL,
    partnercode character varying(32) NOT NULL,
    salespointnumber integer NOT NULL,
    terminalcode character varying(32) NOT NULL,
    salespointname character varying(255),
    collection numeric(12,2),
    cancels numeric(12,2),
    netreturnpaid numeric(12,2),
    netvoidpaid numeric(12,2),
    netcommission numeric(12,2),
    gstoncommission numeric(12,2),
    fundingbalance numeric(12,2),
    fundingamount numeric(12,2),
    netdue numeric(12,2)
);


ALTER TABLE public.ztmm2_invoiceperterminal OWNER TO sp_postgres;

--
-- TOC entry 504 (class 1259 OID 25468)
-- Name: ztmm2_liability; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_liability (
    betdate date NOT NULL,
    bettime time without time zone NOT NULL,
    betid character varying(12) NOT NULL,
    matchcode character varying(12) NOT NULL,
    invoiceitemno bigint NOT NULL,
    busdate date,
    bettimestamp timestamp without time zone,
    legstatus character varying(1),
    retailerid character varying(6),
    terminalid character varying(8),
    tellerid character varying(8),
    bookid character varying(14),
    leaguecode character varying(6),
    recordtype character varying(2),
    selection character varying(40),
    betslipid character varying(12),
    freebet character varying(1),
    matchdate date,
    settledate date,
    settletime time without time zone,
    matchname1 character varying(60),
    matchname2 character varying(60),
    matchname3 character varying(60),
    matchname4 character varying(60),
    matchname5 character varying(60),
    bettype character varying(2),
    odds character varying(5),
    account character varying(60),
    marketname character varying(160),
    liveind character varying(2),
    betamt double precision,
    salesamt double precision,
    winamt double precision,
    matchname character varying(300),
    bet_busdate_id integer,
    system character varying(30),
    settle_busdate_id integer
);


ALTER TABLE public.ztmm2_liability OWNER TO sp_postgres;

--
-- TOC entry 505 (class 1259 OID 25474)
-- Name: ztmm2_purge; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_purge (
    purgedate date NOT NULL,
    purgetime time without time zone NOT NULL,
    betid character varying(12) NOT NULL,
    matchcode character varying(12) NOT NULL,
    busdate date,
    recordtype character varying(2),
    purgetimestamp timestamp without time zone,
    bettype character varying(2),
    retailerid character varying(6),
    wagerterminalid character varying(8),
    bookid character varying(14),
    leaguecode character varying(6),
    legstatus character varying(1),
    betslipid character varying(12),
    freebet character varying(1),
    matchdate date,
    settledate date,
    matchname1 character varying(60),
    matchname2 character varying(60),
    matchname3 character varying(60),
    matchname4 character varying(60),
    matchname5 character varying(60),
    expamt double precision,
    matchname character varying(300),
    purge_busdate_id integer,
    system character varying(30)
);


ALTER TABLE public.ztmm2_purge OWNER TO sp_postgres;

--
-- TOC entry 506 (class 1259 OID 25480)
-- Name: ztmm2_purge_dev; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_purge_dev (
    purgedate date NOT NULL,
    purgetime time without time zone NOT NULL,
    matchcode character varying(12) NOT NULL,
    productclass character varying(32) NOT NULL,
    busdate date,
    purgetimestamp timestamp without time zone,
    matchdate date,
    settledate date,
    leaguecode character varying(6),
    matchname1 character varying(60),
    matchname2 character varying(60),
    matchname3 character varying(60),
    matchname4 character varying(60),
    matchname5 character varying(60),
    refunds double precision,
    winnings double precision
);


ALTER TABLE public.ztmm2_purge_dev OWNER TO sp_postgres;

--
-- TOC entry 507 (class 1259 OID 25483)
-- Name: ztmm2_retailsummary; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_retailsummary (
    transactiondate date NOT NULL,
    partnercode character varying(4) NOT NULL,
    salespointnumber character varying(32) NOT NULL,
    terminalcode character varying(32) NOT NULL,
    salespointname character varying(200),
    collection numeric(12,2),
    cancels numeric(12,2),
    sales numeric(12,2),
    pgst numeric(12,2),
    commission numeric(12,2),
    voidpaid numeric(12,2),
    returnpaid numeric(12,2),
    netdue numeric(12,2)
);


ALTER TABLE public.ztmm2_retailsummary OWNER TO sp_postgres;

--
-- TOC entry 508 (class 1259 OID 25486)
-- Name: ztmm2_ros; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_ros (
    refundmonth character varying(6) NOT NULL,
    "transactionID" character varying(22) NOT NULL,
    "betID" character varying(22) NOT NULL,
    matchcode character varying(22),
    bettype character varying(12),
    wagerdate date,
    wagertime time without time zone,
    "betslipID" character varying(22),
    "legID" character varying(22),
    leaguecode character varying(6),
    matchdate date,
    matchname1 character varying(60),
    totalstake double precision,
    prizes double precision
);


ALTER TABLE public.ztmm2_ros OWNER TO sp_postgres;

--
-- TOC entry 509 (class 1259 OID 25489)
-- Name: ztmm2_sprtliabtrans_v; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_sprtliabtrans_v (
    betid character varying(12) NOT NULL,
    matchcode character varying(12) NOT NULL,
    invoiceitemsnapshot character varying(15) NOT NULL,
    matchsettledate character varying(19) NOT NULL,
    recordtype character varying(2),
    wagerdate character varying(19),
    termindalid character varying(8),
    tellerid character varying(8),
    bookidentifier character varying(14),
    selection character varying(40),
    betamount character varying(8),
    legstatus character varying(1),
    winningamount character varying(8),
    betslipid character varying(12),
    freebetindicator character varying(1),
    matchdate character varying(10),
    matchname character varying(300),
    bettype character varying(2),
    sales character varying(8),
    odds character varying(5),
    idmmaccount character varying(6),
    marketname character varying(40),
    is4inrunning character varying(2)
);


ALTER TABLE public.ztmm2_sprtliabtrans_v OWNER TO sp_postgres;

--
-- TOC entry 510 (class 1259 OID 25495)
-- Name: ztmm2_timetable; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_timetable (
    matchcode character varying(12) NOT NULL,
    matchdate date,
    matchtime time without time zone,
    leaguecode character varying(30),
    replcode character varying(30),
    repmname character varying(60),
    leaguename character varying(40),
    hometeam character varying(60),
    awayteam character varying(60),
    salesstartdate date,
    salesenddate date,
    salesstarttime time without time zone,
    salesendtime time without time zone,
    settledate date,
    ftype character varying(20),
    mtype character varying(25),
    halfind character varying(8),
    rephind character varying(8),
    matchno character varying(6),
    abandflg character varying(1),
    settleflg character varying(1),
    matchname1 character varying(60),
    matchname2 character varying(60),
    matchname3 character varying(60),
    matchname4 character varying(60),
    matchname5 character varying(60),
    matchnamekey character varying(60),
    preliveind character varying(60),
    settletime time without time zone,
    matchname character varying(255)
);


ALTER TABLE public.ztmm2_timetable OWNER TO sp_postgres;

--
-- TOC entry 511 (class 1259 OID 25501)
-- Name: ztmm2_valid; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_valid (
    validdate date NOT NULL,
    validtime time without time zone NOT NULL,
    betid character varying(12) NOT NULL,
    matchcode character varying(12) NOT NULL,
    busdate date,
    recordtype character varying(2),
    validtimestamp timestamp without time zone,
    betdate date,
    validretailer character varying(6),
    validterminal character varying(8),
    validteller character varying(8),
    wagerretailer character varying(6),
    wagerterminal character varying(8),
    bookid character varying(14),
    leaguecode character varying(6),
    betslipid character varying(12),
    freebet character varying(1),
    legstatus character varying(1),
    matchdate date,
    settledate date,
    matchname1 character varying(60),
    matchname2 character varying(60),
    matchname3 character varying(60),
    matchname4 character varying(60),
    matchname5 character varying(60),
    bettype character varying(2),
    accountno character varying(60),
    marketname character varying(60),
    liveind character varying(2),
    validamt double precision,
    matchname character varying(300),
    valid_busdate_id integer,
    system character varying(30)
);


ALTER TABLE public.ztmm2_valid OWNER TO sp_postgres;

--
-- TOC entry 512 (class 1259 OID 25507)
-- Name: ztmm2_wager; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2_wager (
    betdate date NOT NULL,
    bettime time without time zone NOT NULL,
    betid character varying(12) NOT NULL,
    matchcode character varying(12) NOT NULL,
    busdate date,
    recordtype character varying(2),
    bettimestamp timestamp without time zone,
    betslipid character varying(12),
    retailerid character varying(6),
    terminalid character varying(8),
    tellerid character varying(8),
    bookid character varying(14),
    leaguecode character varying(6),
    bettype character varying(2),
    legno integer,
    liveind character varying(2),
    matchdate date,
    settledate date,
    selection character varying(40),
    odds character varying(5),
    positions character varying(10),
    freebet character varying(1),
    betamt double precision,
    salesamt double precision,
    gst double precision,
    account character varying(60),
    marketname character varying(60),
    matchname1 character varying(60),
    matchname2 character varying(60),
    matchname3 character varying(60),
    matchname4 character varying(60),
    matchname5 character varying(60),
    tracount integer,
    matchname character varying(300),
    bet_busdate_id integer,
    system character varying(30)
);


ALTER TABLE public.ztmm2_wager OWNER TO sp_postgres;

--
-- TOC entry 513 (class 1259 OID 25513)
-- Name: ztmm2file_liability; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2file_liability (
    recordtype character varying(2) NOT NULL,
    wagerdate timestamp without time zone NOT NULL,
    termindalid character varying(8) NOT NULL,
    tellerid character varying(8) NOT NULL,
    bookidentifier character varying(14) NOT NULL,
    selection character varying(40) NOT NULL,
    betamount integer NOT NULL,
    legstatus character varying(1) NOT NULL,
    winningamount integer NOT NULL,
    betslipid character varying(12) NOT NULL,
    betid character varying(12) NOT NULL,
    freebetindicator character varying(1) NOT NULL,
    matchdate date NOT NULL,
    matchsettledate timestamp without time zone NOT NULL,
    matchcode character varying(12) NOT NULL,
    matchname character varying(1200) NOT NULL,
    bettype character varying(2) NOT NULL,
    sales integer NOT NULL,
    invoiceitemsnapshot bigint NOT NULL,
    odds character varying(5) NOT NULL,
    idmmaccount character varying(60) NOT NULL,
    marketname character varying(160) NOT NULL,
    is4inrunning character varying(2) NOT NULL
);


ALTER TABLE public.ztmm2file_liability OWNER TO sp_postgres;

--
-- TOC entry 514 (class 1259 OID 25519)
-- Name: ztmm2file_valid; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2file_valid (
    recordtype character varying(2) NOT NULL,
    validationdate timestamp without time zone NOT NULL,
    wagerdate date NOT NULL,
    validationterminalid character varying(8) NOT NULL,
    tellerid character varying(8) NOT NULL,
    wagertermindalid character varying(8) NOT NULL,
    bookidentifier character varying(14) NOT NULL,
    validationamt bigint NOT NULL,
    betslipid character varying(12) NOT NULL,
    betid character varying(12) NOT NULL,
    freebetindicator character varying(1) NOT NULL,
    legstatus character varying(1) NOT NULL,
    matchdate date NOT NULL,
    matchsettledate date NOT NULL,
    matchcode character varying(12) NOT NULL,
    matchname character varying(1200) NOT NULL,
    bettype character varying(2) NOT NULL,
    idmmaccount character varying(60) NOT NULL,
    marketname character varying(60) NOT NULL,
    is4inrunning character varying(2) NOT NULL,
    winningfactor character varying(1) NOT NULL
);


ALTER TABLE public.ztmm2file_valid OWNER TO sp_postgres;

--
-- TOC entry 515 (class 1259 OID 25525)
-- Name: ztmm2file_wager; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztmm2file_wager (
    recordtype character varying(2) NOT NULL,
    wagerdate timestamp without time zone NOT NULL,
    termindalid character varying(8) NOT NULL,
    operid character varying(8) NOT NULL,
    bookidentifier character varying(14) NOT NULL,
    selection character varying(40) NOT NULL,
    betamount integer NOT NULL,
    odds character varying(5) NOT NULL,
    "POSITION" character varying(10) NOT NULL,
    betslipid character varying(12) NOT NULL,
    betid character varying(12) NOT NULL,
    freebetindicator character varying(1) NOT NULL,
    sale integer NOT NULL,
    outputgst integer NOT NULL,
    matchdate date NOT NULL,
    matchsettledate date NOT NULL,
    matchcode character varying(12) NOT NULL,
    matchname character varying(1200) NOT NULL,
    bettype character varying(2) NOT NULL,
    idmmaccount character varying(60) NOT NULL,
    marketname character varying(60) NOT NULL,
    is4inrunning character varying(2) NOT NULL
);


ALTER TABLE public.ztmm2file_wager OWNER TO sp_postgres;

--
-- TOC entry 516 (class 1259 OID 25531)
-- Name: ztob_businessday; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_businessday (
    start_time_d date NOT NULL,
    start_time_t time without time zone,
    end_time_d date,
    end_time_t time without time zone,
    start_time timestamp without time zone,
    end_time timestamp without time zone
);


ALTER TABLE public.ztob_businessday OWNER TO sp_postgres;

--
-- TOC entry 517 (class 1259 OID 25534)
-- Name: ztob_channels; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_channels (
    channel character varying(1) NOT NULL,
    description character varying(30),
    sort_order integer,
    channeltype character varying(30)
);


ALTER TABLE public.ztob_channels OWNER TO sp_postgres;

--
-- TOC entry 518 (class 1259 OID 25537)
-- Name: ztob_custcalls; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custcalls (
    ob_call_id integer NOT NULL,
    start_date_d date NOT NULL,
    start_date_t time without time zone NOT NULL,
    account_no character varying(32),
    admin_username character varying(32),
    channel character varying(1),
    last_updated_date timestamp without time zone,
    business_day date,
    end_date_d date,
    end_date_t time without time zone,
    start_date_business_id integer,
    end_date_business_id integer,
    last_updated_date_business_id integer,
    system character varying(30)
);


ALTER TABLE public.ztob_custcalls OWNER TO sp_postgres;

--
-- TOC entry 519 (class 1259 OID 25540)
-- Name: ztob_custfastapplications; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custfastapplications (
    account_no character varying(32) NOT NULL,
    cpm_id integer NOT NULL,
    status character varying(1) NOT NULL,
    last_updated_date timestamp without time zone
);


ALTER TABLE public.ztob_custfastapplications OWNER TO sp_postgres;

--
-- TOC entry 520 (class 1259 OID 25543)
-- Name: ztob_custflagstaff; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custflagstaff (
    account_no character varying(32) NOT NULL,
    aud_order integer,
    flag_name character varying(15),
    flag_value character varying(15),
    last_updated_date timestamp without time zone NOT NULL
);


ALTER TABLE public.ztob_custflagstaff OWNER TO sp_postgres;

--
-- TOC entry 521 (class 1259 OID 25546)
-- Name: ztob_custlimits; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custlimits (
    limit_id integer NOT NULL,
    account_no character varying(32),
    limit_type_ob smallint,
    limit_value numeric(12,2),
    updated_date timestamp without time zone,
    business_day date,
    termination_date_d date,
    termination_date_t time without time zone,
    from_date_d date,
    from_date_t time without time zone,
    to_date_d date,
    to_date_t time without time zone,
    updated_date_business_id integer,
    termination_date_business_id integer,
    from_date_business_id integer,
    to_date_business_id integer,
    system character varying(30),
    limit_type character varying(32)
);


ALTER TABLE public.ztob_custlimits OWNER TO sp_postgres;

--
-- TOC entry 522 (class 1259 OID 25549)
-- Name: ztob_custlogin; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custlogin (
    account_no character varying(32) NOT NULL,
    login_datetime timestamp without time zone NOT NULL,
    channel character varying(128),
    last_updated_date timestamp without time zone
);


ALTER TABLE public.ztob_custlogin OWNER TO sp_postgres;

--
-- TOC entry 523 (class 1259 OID 25552)
-- Name: ztob_customer; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer (
    account_no character varying(32) NOT NULL,
    username character varying(32),
    name character varying(338),
    title character varying(16),
    gender character varying(1),
    dob date,
    nationality character varying(60),
    language character varying(2),
    homephone character varying(20),
    mobilephone character varying(20),
    workphone character varying(20),
    email character varying(60),
    addr_street_1 character varying(160),
    addr_street_2 character varying(160),
    addr_street_3 character varying(160),
    addr_street_4 character varying(160),
    addr_city character varying(60),
    addr_postcode character varying(20),
    contact_how character varying(8),
    status character varying(1),
    reason character varying(250),
    document_type character varying(16),
    document_no character varying(255),
    bank_name character varying(80),
    bank_account_type character varying(50),
    earmarkamount character varying(35),
    dda_reference character varying(13),
    dda_limit numeric(12,2),
    settlement_cycle character varying(1),
    balance numeric(12,2),
    kyc_location character varying(40),
    kyc_status character varying(60),
    kyc_date timestamp without time zone,
    ncpg_status character varying(60),
    ncpg_date timestamp without time zone,
    bkgd_status character varying(60),
    bkgd_date timestamp without time zone,
    activation_date timestamp without time zone,
    creation_date timestamp without time zone,
    status_last_updated_date timestamp without time zone,
    last_updated_date timestamp without time zone,
    income_min integer,
    income_max integer,
    industry_name character varying(180),
    occupation_name character varying(180),
    account_no_hash character varying(64),
    username_hash character varying(64),
    document_no_hash character varying(64),
    system character varying(30),
    nationality_code character varying(2),
    origin_code character varying(2),
    origin character varying(60),
    addr_country_code character varying(2),
    addr_country character varying(160),
    document_exp_date date,
    document_country_code character varying(2),
    document_country character varying(60),
    rep_document_type character varying(16),
    rep_document_no character varying(255),
    rep_document_exp_date date,
    rep_country_code character varying(2),
    rep_country character varying(60),
    overseas_betting_indicator character varying(1),
    horse_mra_no character varying(255),
    horse_validity_start_date date,
    horse_validity_end_date date,
    sports_seln character varying(1),
    lottery_seln character varying(1),
    horse_racing_seln character varying(1),
    hr_tv_channel_sub character varying(250),
    account_no_hash512 character varying(128),
    document_no_hash512 character varying(128),
    source character varying(1),
    risk_category character varying(255),
    allow_to_bet character varying(1),
    settlement_threshold numeric(12,2),
    payment_method_status character varying(1),
    education_name character varying(160),
    cust_risk_score integer,
    cust_segment character varying(2),
    registration_mode character varying(1),
    face_compare_sppl_result character varying(1),
    face_compare_score numeric(6,5),
    face_compare_failed_attempts integer,
    face_compare_failed_reason character varying(100),
    face_verify_result character varying(1),
    face_verify_score numeric(6,5),
    face_verify_failed_attempts integer,
    face_verify_failed_reason character varying(100),
    face_verify_sppl_result character varying(1),
    kyc_type character varying(15),
    principal_name character varying(66),
    hanyu_pinyin_name character varying(66),
    alias_name character varying(66),
    hanyu_pinyin_alias_name character varying(66),
    married_name character varying(66),
    paynow_payment_method_status character varying(1),
    allow_to_bet_date timestamp without time zone
);


ALTER TABLE public.ztob_customer OWNER TO sp_postgres;

--
-- TOC entry 524 (class 1259 OID 25558)
-- Name: ztob_customer_act_date; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer_act_date (
    account_no character varying(32) NOT NULL,
    activation_date date
);


ALTER TABLE public.ztob_customer_act_date OWNER TO sp_postgres;

--
-- TOC entry 846 (class 1259 OID 490457)
-- Name: ztob_customer_anonymised; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer_anonymised (
    account_no character varying(32) NOT NULL,
    username character varying(32),
    name character varying(338),
    dob date,
    homephone character varying(20),
    mobilephone character varying(20),
    email character varying(60),
    addr_street_1 character varying(160),
    addr_street_2 character varying(160),
    addr_street_3 character varying(160),
    addr_postcode character varying(20),
    document_no character varying(255),
    principal_name character varying(66),
    hanyu_pinyin_name character varying(66),
    alias_name character varying(66),
    hanyu_pinyin_alias_name character varying(66),
    married_name character varying(66),
    last_updated_date timestamp without time zone,
    business_date date
);


ALTER TABLE public.ztob_customer_anonymised OWNER TO sp_postgres;

--
-- TOC entry 525 (class 1259 OID 25561)
-- Name: ztob_customer_backup; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer_backup (
    business_day date NOT NULL,
    account_no character varying(32) NOT NULL,
    acct_status character varying(1),
    pmoc character varying(4),
    staff_account character varying(10),
    kyc_status character varying(60),
    ncpg_status character varying(60),
    bkgd_status character varying(60),
    look_status character varying(60),
    tnc_flag_status character varying(60),
    spending_limits_status character varying(60),
    deposit_limits_status character varying(60),
    stop_status character varying(60),
    password_status character varying(60),
    pin_status character varying(60),
    wtd_status character varying(60),
    dep_status character varying(60),
    lock_status character varying(60),
    tnc_date_accepted date,
    spending_limit_value numeric(12,2),
    deposit_limit_value numeric(12,2),
    username character varying(32),
    name character varying(60),
    title character varying(16),
    gender character varying(1),
    dob date,
    nationality character varying(2),
    language character varying(2),
    homephone character varying(20),
    mobilephone character varying(20),
    workphone character varying(20),
    email character varying(60),
    addr_street_1 character varying(160),
    addr_street_2 character varying(160),
    addr_street_3 character varying(160),
    addr_street_4 character varying(160),
    addr_city character varying(60),
    addr_postcode character varying(20),
    contact_how character varying(8),
    document_type character varying(16),
    document_no character varying(255),
    bank_name character varying(80),
    bank_account_type character varying(50),
    earmarkamount character varying(35),
    dda_reference character varying(13),
    dda_limit numeric(12,2),
    settlement_cycle character varying(1),
    balance numeric(12,2),
    kyc_location character varying(40),
    activation_date date,
    acct_open_date date,
    acct_open_time time without time zone,
    status character varying(1),
    reason character varying(250),
    suspended_date date,
    closed_date date,
    reactivation_date date,
    reinstatement_date date,
    residential_status character varying(20),
    acct_no_mask character varying(60),
    doc_no_mask character varying(60),
    exclusion_type character varying(40),
    ok_to_bet character varying(1)
);


ALTER TABLE public.ztob_customer_backup OWNER TO sp_postgres;

--
-- TOC entry 526 (class 1259 OID 25567)
-- Name: ztob_customer_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer_master (
    account_no character varying(32) NOT NULL,
    username character varying(32),
    name character varying(60),
    title character varying(16),
    gender character varying(1),
    dob date,
    nationality character varying(2),
    language character varying(2),
    homephone character varying(20),
    mobilephone character varying(20),
    workphone character varying(20),
    email character varying(60),
    addr_street_1 character varying(160),
    addr_street_2 character varying(160),
    addr_street_3 character varying(160),
    addr_street_4 character varying(160),
    addr_city character varying(60),
    addr_postcode character varying(20),
    contact_how character varying(8),
    status character varying(1),
    status_desc character varying(250),
    document_type character varying(16),
    document_no character varying(255),
    bank_name character varying(80),
    bank_account_type character varying(50),
    earmarkamount character varying(35),
    dda_reference character varying(13),
    dda_limit numeric(12,2),
    settlement_cycle character varying(1),
    balance numeric(12,2),
    kyc_location character varying(40),
    kyc_status character varying(7),
    kyc_date timestamp without time zone,
    ncpg_status character varying(7),
    ncpg_date timestamp without time zone,
    bkgd_status character varying(7),
    bkgd_date timestamp without time zone,
    activation_date timestamp without time zone,
    creation_date timestamp without time zone,
    status_last_updated_date timestamp without time zone,
    last_updated_date timestamp without time zone,
    acct_no_hash character varying(60),
    doc_no_hash character varying(60)
);


ALTER TABLE public.ztob_customer_master OWNER TO sp_postgres;

--
-- TOC entry 527 (class 1259 OID 25573)
-- Name: ztob_customer_temp; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer_temp (
    business_day date NOT NULL,
    account_no character varying(32) NOT NULL,
    acct_status character varying(1),
    pmoc character varying(4),
    staff_account character varying(10),
    kyc_status character varying(60),
    ncpg_status character varying(60),
    bkgd_status character varying(60),
    look_status character varying(60),
    tnc_flag_status character varying(60),
    spending_limits_status character varying(60),
    deposit_limits_status character varying(60),
    stop_status character varying(60),
    password_status character varying(60),
    pin_status character varying(60),
    wtd_status character varying(60),
    dep_status character varying(60),
    lock_status character varying(60),
    tnc_date_accepted date,
    spending_limit_value numeric(12,2),
    deposit_limit_value numeric(12,2),
    username character varying(32),
    name character varying(60),
    title character varying(16),
    gender character varying(1),
    dob date,
    nationality character varying(2),
    language character varying(2),
    homephone character varying(20),
    mobilephone character varying(20),
    workphone character varying(20),
    email character varying(60),
    addr_street_1 character varying(160),
    addr_street_2 character varying(160),
    addr_street_3 character varying(160),
    addr_street_4 character varying(160),
    addr_city character varying(60),
    addr_postcode character varying(20),
    contact_how character varying(8),
    document_type character varying(16),
    document_no character varying(255),
    bank_name character varying(80),
    bank_account_type character varying(50),
    earmarkamount character varying(35),
    dda_reference character varying(13),
    dda_limit numeric(12,2),
    settlement_cycle character varying(1),
    balance numeric(12,2),
    kyc_location character varying(40),
    activation_date date,
    acct_open_date date,
    acct_open_time time without time zone,
    suspended_date timestamp without time zone,
    closed_date timestamp without time zone,
    reason_recent_suspended character varying(250),
    reason_recent_closed character varying(250),
    reason_current character varying(250),
    reactivation_date timestamp without time zone,
    reinstatement_date timestamp without time zone,
    residential_status character varying(20),
    acct_no_mask character varying(60),
    doc_no_mask character varying(60),
    exclusion_type character varying(40),
    ok_to_bet character varying(1)
);


ALTER TABLE public.ztob_customer_temp OWNER TO sp_postgres;

--
-- TOC entry 528 (class 1259 OID 25579)
-- Name: ztob_customer_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer_test (
    business_day date NOT NULL,
    account_no character varying(32) NOT NULL,
    acct_status character varying(1),
    pmoc character varying(4),
    staff_account character varying(10),
    kyc_status character varying(60),
    ncpg_status character varying(60),
    bkgd_status character varying(60),
    look_status character varying(60),
    tnc_flag_status character varying(60),
    spending_limits_status character varying(60),
    deposit_limits_status character varying(60),
    stop_status character varying(60),
    password_status character varying(60),
    pin_status character varying(60),
    wtd_status character varying(60),
    dep_status character varying(60),
    lock_status character varying(60),
    tnc_date_accepted date,
    spending_limit_value numeric(12,2),
    deposit_limit_value numeric(12,2),
    username character varying(32),
    name character varying(60),
    title character varying(16),
    gender character varying(1),
    dob date,
    nationality character varying(2),
    language character varying(2),
    homephone character varying(20),
    mobilephone character varying(20),
    workphone character varying(20),
    email character varying(60),
    addr_street_1 character varying(160),
    addr_street_2 character varying(160),
    addr_street_3 character varying(160),
    addr_street_4 character varying(160),
    addr_city character varying(60),
    addr_postcode character varying(20),
    contact_how character varying(8),
    document_type character varying(16),
    document_no character varying(255),
    bank_name character varying(80),
    bank_account_type character varying(50),
    earmarkamount character varying(35),
    dda_reference character varying(13),
    dda_limit numeric(12,2),
    settlement_cycle character varying(1),
    balance numeric(12,2),
    kyc_location character varying(40),
    activation_date date,
    acct_open_date date,
    acct_open_time time without time zone,
    suspended_date timestamp without time zone,
    closed_date timestamp without time zone,
    reason_recent_suspended character varying(250),
    reason_recent_closed character varying(250),
    reason_current character varying(250),
    reactivation_date timestamp without time zone,
    reinstatement_date timestamp without time zone,
    residential_status character varying(20),
    acct_no_mask character varying(60),
    doc_no_mask character varying(60),
    exclusion_type character varying(40),
    ok_to_bet character varying(1)
);


ALTER TABLE public.ztob_customer_test OWNER TO sp_postgres;

--
-- TOC entry 843 (class 1259 OID 485914)
-- Name: ztob_customer_update_trail; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer_update_trail (
    account_no character varying(32) NOT NULL,
    last_updated_date timestamp without time zone NOT NULL,
    business_date date,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztob_customer_update_trail OWNER TO sp_postgres;

--
-- TOC entry 847 (class 1259 OID 491632)
-- Name: ztob_customer_update_trail_bk20230315; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_customer_update_trail_bk20230315 (
    account_no character varying(32),
    last_updated_date timestamp without time zone,
    business_date date,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztob_customer_update_trail_bk20230315 OWNER TO sp_postgres;

--
-- TOC entry 529 (class 1259 OID 25585)
-- Name: ztob_custstatusflag; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custstatusflag (
    account_no character varying(32) NOT NULL,
    cust_flag_id integer NOT NULL,
    status_flag_tag character varying(10),
    status character varying(1),
    reason character varying(300),
    username_set_flag character varying(32),
    username_cleared_flag character varying(32),
    created_date timestamp without time zone,
    cleared_date timestamp without time zone,
    last_updated_date timestamp without time zone NOT NULL,
    created_date_business_id integer,
    cleared_date_business_id integer,
    system character varying(30)
);


ALTER TABLE public.ztob_custstatusflag OWNER TO sp_postgres;

--
-- TOC entry 530 (class 1259 OID 25588)
-- Name: ztob_custstatuslog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custstatuslog (
    account_no character varying(32) NOT NULL,
    last_updated_date timestamp without time zone NOT NULL,
    cust_status_id integer,
    status character varying(1),
    reason character varying(300)
);


ALTER TABLE public.ztob_custstatuslog OWNER TO sp_postgres;

--
-- TOC entry 531 (class 1259 OID 25591)
-- Name: ztob_custsweepback; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custsweepback (
    account_no character varying(32) NOT NULL,
    payment_method character varying(4) NOT NULL,
    last_updated_date timestamp without time zone NOT NULL,
    sweepback_period character varying(1),
    sweepback_threshold numeric(12,2)
);


ALTER TABLE public.ztob_custsweepback OWNER TO sp_postgres;

--
-- TOC entry 532 (class 1259 OID 25594)
-- Name: ztob_custtnc; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_custtnc (
    account_no character varying(32) NOT NULL,
    cust_tnc_id integer NOT NULL,
    version_accepted character varying(16),
    date_accepted timestamp without time zone,
    last_updated_date timestamp without time zone NOT NULL,
    system character varying(30)
);


ALTER TABLE public.ztob_custtnc OWNER TO sp_postgres;

--
-- TOC entry 533 (class 1259 OID 25597)
-- Name: ztob_exclusionhistory; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_exclusionhistory (
    account_no character varying(32),
    exclude_record_id integer NOT NULL,
    exclusion_type character varying(40),
    exclusion_status character varying(19),
    note character varying(255),
    last_updated_date timestamp without time zone NOT NULL,
    remark character varying(20),
    exclusion_from_date timestamp without time zone,
    exclusion_to_date timestamp without time zone
);


ALTER TABLE public.ztob_exclusionhistory OWNER TO sp_postgres;

--
-- TOC entry 534 (class 1259 OID 25600)
-- Name: ztob_journal; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_journal (
    journal_no bigint NOT NULL,
    transaction_no integer NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    account_no character varying(32),
    channel character varying(1),
    journal_type character varying(4),
    transaction_type character varying(4),
    transaction_subtype character varying(5),
    journal_status character varying(1),
    transaction_status character varying(1),
    amount numeric(12,2),
    creating_admin character varying(32),
    posting_admin character varying(32),
    authorising_admin character varying(32),
    transaction_ref_key character varying(4),
    transaction_ref_id integer,
    last_updated_date timestamp without time zone,
    business_day date,
    description character varying(140),
    operator_notes character varying(255),
    post_date_d date,
    post_date_t time without time zone,
    authorisation_date_d date,
    authorisation_date_t time without time zone,
    authorisation_date_business_id integer,
    creation_date_business_id integer,
    last_updated_date_business_id integer,
    post_date_business_id integer,
    system character varying(30),
    swift_bic character varying(35),
    fname character varying(338),
    payer_name character varying(140),
    name_match_rate integer,
    name_match_threshold character varying(1),
    name_match_status character varying(1),
    bank_error_code character varying(60),
    bank_error_desc character varying(255)
);


ALTER TABLE public.ztob_journal OWNER TO sp_postgres;

--
-- TOC entry 535 (class 1259 OID 25606)
-- Name: ztob_journal_temp; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_journal_temp (
    journal_no bigint NOT NULL,
    transaction_no integer NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    account_no character varying(32),
    channel character varying(1),
    journal_type character varying(4),
    transaction_type character varying(4),
    transaction_subtype character varying(5),
    journal_status character varying(1),
    transaction_status character varying(1),
    amount numeric(12,2),
    creating_admin character varying(32),
    posting_admin character varying(32),
    authorising_admin character varying(32),
    transaction_ref_key character varying(4),
    transaction_ref_id integer,
    last_updated_date timestamp without time zone,
    business_day date,
    description character varying(140),
    operator_notes character varying(255),
    post_date_d date,
    post_date_t time without time zone,
    authorisation_date_d date,
    authorisation_date_t time without time zone,
    authorisation_date_business_id integer,
    creation_date_business_id integer,
    last_updated_date_business_id integer,
    post_date_business_id integer,
    system character varying(30),
    swift_bic character varying(35),
    fname character varying(338),
    payer_name character varying(140),
    name_match_rate integer,
    name_match_threshold character varying(1),
    name_match_status character varying(1),
    bank_error_code character varying(60),
    bank_error_desc character varying(255)
);


ALTER TABLE public.ztob_journal_temp OWNER TO sp_postgres;

--
-- TOC entry 536 (class 1259 OID 25612)
-- Name: ztob_lottery; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_lottery (
    bet_id integer NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    account_no character varying(32),
    ccy_code character varying(3),
    betslip_id integer,
    bet_type character varying(5),
    bet_name character varying(64),
    channel character varying(1),
    status character varying(1),
    ob_status character varying(1),
    settled_how character varying(1),
    ob_draw_id integer,
    es_draw_no integer,
    auto_pick character varying(1),
    total_stake numeric(12,2),
    type_stake_1 character varying(5),
    type_stake_2 character varying(7),
    unit_stake_1 numeric(12,2),
    unit_stake_2 numeric(12,2),
    bet_stake_1 numeric(12,2),
    bet_stake_2 numeric(12,2),
    returns numeric(12,2),
    winnings numeric(16,2),
    sales numeric(16,9),
    es_syndicate_id integer,
    es_syndicate_name character varying(10),
    es_syndicate_parts smallint,
    syndicate_parts smallint,
    last_updated_date timestamp without time zone,
    business_day date,
    picks character varying(255),
    bet_status character varying(1),
    product_id character varying(5),
    sales_amount numeric(19,9),
    gst_amount numeric(19,9),
    settled_date_d date,
    settled_date_t time without time zone,
    draw_date_d date,
    draw_date_t time without time zone,
    valid_date_d date,
    valid_date_t time without time zone,
    creation_date_business_id integer,
    settled_date_business_id integer,
    draw_date_business_id integer,
    valid_date_business_id integer,
    last_updated_date_business_id integer,
    system character varying(30),
    uuid character varying(19)
);


ALTER TABLE public.ztob_lottery OWNER TO sp_postgres;

--
-- TOC entry 537 (class 1259 OID 25618)
-- Name: ztob_lottery_patch; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_lottery_patch (
    bet_id integer NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    account_no character varying(32),
    ccy_code character varying(3),
    betslip_id integer,
    bet_type character varying(5),
    bet_name character varying(64),
    channel character varying(1),
    status character varying(1),
    ob_status character varying(1),
    settled_how character varying(1),
    ob_draw_id integer,
    es_draw_no integer,
    auto_pick character varying(1),
    total_stake numeric(12,2),
    type_stake_1 character varying(5),
    type_stake_2 character varying(7),
    unit_stake_1 numeric(12,2),
    unit_stake_2 numeric(12,2),
    bet_stake_1 numeric(12,2),
    bet_stake_2 numeric(12,2),
    returns numeric(12,2),
    winnings numeric(16,2),
    sales numeric(16,9),
    es_syndicate_id integer,
    es_syndicate_name character varying(10),
    es_syndicate_parts smallint,
    syndicate_parts smallint,
    last_updated_date timestamp without time zone,
    business_day date,
    picks character varying(255),
    bet_status character varying(1),
    product_id character varying(5),
    sales_amount numeric(12,2),
    gst_amount numeric(12,2),
    settled_date_d date,
    settled_date_t time without time zone,
    draw_date_d date,
    draw_date_t time without time zone,
    valid_date_d date,
    valid_date_t time without time zone,
    creation_date_business_id integer,
    settled_date_business_id integer,
    draw_date_business_id integer,
    valid_date_business_id integer,
    last_updated_date_business_id integer,
    system character varying(30),
    sales_amount_cal numeric(19,9)
);


ALTER TABLE public.ztob_lottery_patch OWNER TO sp_postgres;

--
-- TOC entry 538 (class 1259 OID 25624)
-- Name: ztob_lottery_temp; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_lottery_temp (
    bet_id integer NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    account_no character varying(32),
    ccy_code character varying(3),
    betslip_id integer,
    bet_type character varying(5),
    bet_name character varying(64),
    channel character varying(1),
    status character varying(1),
    ob_status character varying(1),
    settled_how character varying(1),
    ob_draw_id integer,
    es_draw_no integer,
    auto_pick character varying(1),
    total_stake numeric(12,2),
    type_stake_1 character varying(5),
    type_stake_2 character varying(7),
    unit_stake_1 numeric(12,2),
    unit_stake_2 numeric(12,2),
    bet_stake_1 numeric(12,2),
    bet_stake_2 numeric(12,2),
    returns numeric(12,2),
    winnings numeric(16,2),
    sales numeric(16,9),
    es_syndicate_id integer,
    es_syndicate_name character varying(10),
    es_syndicate_parts smallint,
    syndicate_parts smallint,
    last_updated_date timestamp without time zone,
    business_day date,
    picks character varying(255),
    bet_status character varying(1),
    product_id character varying(5),
    sales_amount numeric(19,9),
    gst_amount numeric(19,9),
    settled_date_d date,
    settled_date_t time without time zone,
    draw_date_d date,
    draw_date_t time without time zone,
    valid_date_d date,
    valid_date_t time without time zone,
    creation_date_business_id integer,
    settled_date_business_id integer,
    draw_date_business_id integer,
    valid_date_business_id integer,
    last_updated_date_business_id integer,
    system character varying(30),
    uuid character varying(19)
);


ALTER TABLE public.ztob_lottery_temp OWNER TO sp_postgres;

--
-- TOC entry 539 (class 1259 OID 25630)
-- Name: ztob_lotterycustdailystats; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_lotterycustdailystats (
    account_no character varying(32) NOT NULL,
    channel character varying(1) NOT NULL,
    last_updated_date timestamp without time zone NOT NULL,
    sum_stakes numeric(32,2),
    sum_cust_income numeric(12,2),
    sum_pools_return numeric(12,2),
    sum_cust_refunds numeric(32,2),
    bet_count bigint
);


ALTER TABLE public.ztob_lotterycustdailystats OWNER TO sp_postgres;

--
-- TOC entry 540 (class 1259 OID 25633)
-- Name: ztob_lotterycuststats; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_lotterycuststats (
    account_no character varying(32) NOT NULL,
    channel character varying(1) NOT NULL,
    first_bet_id integer,
    last_bet_id integer,
    bet_count integer,
    last_updated_date timestamp without time zone,
    first_bet_date_d date,
    first_bet_date_t time without time zone,
    last_bet_date_d date,
    last_bet_date_t time without time zone
);


ALTER TABLE public.ztob_lotterycuststats OWNER TO sp_postgres;

--
-- TOC entry 541 (class 1259 OID 25636)
-- Name: ztob_lotterysubscriptions; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_lotterysubscriptions (
    account_no character varying(32) NOT NULL,
    slip_id integer NOT NULL,
    sub_id integer NOT NULL,
    attempt_draw_id integer NOT NULL,
    slip_request_receipt character varying(24),
    slip_cr_date timestamp without time zone,
    slip_status character varying(9),
    slip_total_cost numeric(12,2),
    sub_receipt character varying(24),
    sub_status character varying(9),
    void_reason character varying(80),
    channel character varying(1),
    bet_type character varying(5),
    is_auto_pick character varying(1),
    picks character varying(250),
    attempt_date date,
    es_draw_no integer,
    attempt_status character varying(7),
    bet_id integer,
    bet_placement_date timestamp without time zone,
    bet_status character varying(1),
    bet_picks character varying(250),
    bet_receipt character varying(24),
    last_updated_date timestamp without time zone
);


ALTER TABLE public.ztob_lotterysubscriptions OWNER TO sp_postgres;

--
-- TOC entry 845 (class 1259 OID 489734)
-- Name: ztob_namematch; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_namematch (
    pmt_mthd character varying(13),
    cr_date timestamp without time zone NOT NULL,
    acct_no character varying(32),
    acct_name character varying(338),
    pmt_or_refund_id integer NOT NULL,
    status character varying(7),
    amount numeric(14,2),
    commission numeric(14,2),
    bank_date timestamp without time zone,
    payer_name character varying(140),
    bank_txn_reference character varying(255),
    name_match_rate integer,
    threshold character varying(255),
    name_match_result character varying(6)
);


ALTER TABLE public.ztob_namematch OWNER TO sp_postgres;

--
-- TOC entry 1026 (class 1259 OID 2463130)
-- Name: ztob_pmttransaction_phu; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_pmttransaction_phu (
    bank_name character(4),
    acct_no character varying(255),
    pmt_mode character(1),
    ref_id character varying(46) NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    total_amt numeric(16,2),
    net_amt numeric(16,2),
    transaction_fee character varying(255),
    cart_id character varying(1),
    transaction_flag character(2),
    pmt_type character(1),
    batch_id character varying(1),
    status character varying(2),
    creation_date_business_id integer,
    business_date character varying(129),
    last_updated_date_business_id integer,
    transaction_date timestamp without time zone NOT NULL,
    value_date timestamp without time zone,
    term_id character varying(1),
    loc_id character varying(1),
    last_updated_date timestamp without time zone,
    bank_txn_ref_id character varying(255),
    original_ref_id character varying(255),
    system character varying(30)
);


ALTER TABLE public.ztob_pmttransaction_phu OWNER TO sp_postgres;

--
-- TOC entry 542 (class 1259 OID 25642)
-- Name: ztob_reactivate; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_reactivate (
    business_day date NOT NULL,
    account_no character varying(32) NOT NULL,
    reactive_date timestamp without time zone,
    suspended_date timestamp without time zone,
    closed_date timestamp without time zone
);


ALTER TABLE public.ztob_reactivate OWNER TO sp_postgres;

--
-- TOC entry 543 (class 1259 OID 25645)
-- Name: ztob_sportbets; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportbets (
    bet_id integer NOT NULL,
    match_id integer NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    account_no character varying(32),
    ccy_code character varying(3),
    channel character varying(1),
    leg_no smallint,
    bet_type character varying(5),
    market_no character varying(4),
    bir character varying(1),
    ipaddr character varying(15),
    ob_call_id integer,
    stake numeric(12,2),
    sales numeric(12,2),
    gst numeric(16,2),
    place_terminal_code character varying(16),
    opening_odds numeric(13,3),
    closing_odds numeric(13,3),
    selected_odds numeric(13,3),
    last_updated_date timestamp without time zone,
    business_day date,
    market_name character varying(100),
    selection_name character varying(120),
    multiple_bet character varying(1),
    bet_status character varying(1),
    settled_how character varying(1),
    creation_date_business_id integer,
    last_updated_date_business_id integer,
    system character varying(30),
    selection_id integer,
    collect_terminal_code character varying(16),
    ext_trans_id bigint,
    market_id integer,
    place_teller_id character varying(30),
    collect_teller_id character varying(30),
    expiry_date_d date,
    expiry_date_t time without time zone
);


ALTER TABLE public.ztob_sportbets OWNER TO sp_postgres;

--
-- TOC entry 544 (class 1259 OID 25648)
-- Name: ztob_sportbets_temp; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportbets_temp (
    bet_id integer NOT NULL,
    match_id integer NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    creation_date timestamp without time zone,
    bet_status character varying(1),
    settled_how character varying(1),
    creation_date_business_id integer,
    last_updated_date_business_id integer
);


ALTER TABLE public.ztob_sportbets_temp OWNER TO sp_postgres;

--
-- TOC entry 545 (class 1259 OID 25651)
-- Name: ztob_sportbets_wager; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportbets_wager (
    business_day date NOT NULL,
    account_no character varying(32) NOT NULL,
    bet_type character varying(5) NOT NULL,
    channel character varying(1) NOT NULL,
    multiple_bet character varying(1) NOT NULL,
    bir character varying(1) NOT NULL,
    market_no character varying(4) NOT NULL,
    match_id integer NOT NULL,
    sports_type character varying(2) NOT NULL,
    bet_amount numeric(12,2),
    input_output_gst_amount numeric(12,2),
    sales_amount numeric(12,2)
);


ALTER TABLE public.ztob_sportbets_wager OWNER TO sp_postgres;

--
-- TOC entry 546 (class 1259 OID 25654)
-- Name: ztob_sportbetssettled; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportbetssettled (
    bet_id integer NOT NULL,
    match_id integer NOT NULL,
    creation_date_d date NOT NULL,
    creation_date_t time without time zone NOT NULL,
    account_no character varying(32),
    ccy_code character varying(3),
    channel character varying(1),
    leg_no smallint,
    bet_type character varying(5),
    market_no character varying(4),
    bet_status character varying(1),
    leg_status character varying(1),
    settled_how character varying(1),
    bir character varying(1),
    ipaddr character varying(15),
    ob_call_id integer,
    settled_stake numeric(12,2),
    settled_sales numeric(12,2),
    settled_gst numeric(12,2),
    settled_returns numeric(12,2),
    opening_odds numeric(13,3),
    closing_odds numeric(13,3),
    selected_odds numeric(13,3),
    last_updated_date timestamp without time zone,
    business_day date,
    market_name character varying(100),
    selection_name character varying(120),
    last_settled_info character varying(200),
    multiple_bet character varying(1),
    settled_flag character varying(1),
    last_settled_date_d date,
    last_settled_date_t time without time zone,
    validation_date_d date,
    validation_date_t time without time zone,
    creation_date_business_id integer,
    last_settled_date_business_id integer,
    last_updated_date_business_id integer,
    validation_date_business_id integer,
    system character varying(30),
    selection_id integer,
    place_terminal_code character varying(16),
    collect_terminal_code character varying(16),
    ext_trans_id bigint,
    market_id integer,
    place_teller_id character varying(30),
    collect_teller_id character varying(30),
    expiry_date_d date,
    expiry_date_t time without time zone,
    settled_sales_comm numeric(21,11),
    settled_sales_comm_gst numeric(21,11),
    cashout_leg_price numeric(12,2),
    cashout_leg_implied_price numeric(12,5),
    cashout_fee numeric(12,2)
);


ALTER TABLE public.ztob_sportbetssettled OWNER TO sp_postgres;

--
-- TOC entry 547 (class 1259 OID 25660)
-- Name: ztob_sportbetssettled_cancel; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportbetssettled_cancel (
    business_day date NOT NULL,
    account_no character varying(32) NOT NULL,
    bet_type character varying(5) NOT NULL,
    leg_status character varying(1) NOT NULL,
    channel character varying(1) NOT NULL,
    multiple_bet character varying(1) NOT NULL,
    bir character varying(1) NOT NULL,
    market_no character varying(4) NOT NULL,
    match_id integer NOT NULL,
    sports_type character varying(2) NOT NULL,
    bet_amount numeric(12,2),
    input_output_gst_amount numeric(12,2),
    sales_amount numeric(12,2)
);


ALTER TABLE public.ztob_sportbetssettled_cancel OWNER TO sp_postgres;

--
-- TOC entry 548 (class 1259 OID 25663)
-- Name: ztob_sportbetssettled_liability; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportbetssettled_liability (
    business_day date NOT NULL,
    account_no character varying(32) NOT NULL,
    bet_type character varying(5) NOT NULL,
    leg_status character varying(1) NOT NULL,
    channel character varying(1) NOT NULL,
    multiple_bet character varying(1) NOT NULL,
    bir character varying(1) NOT NULL,
    market_no character varying(4) NOT NULL,
    match_id integer NOT NULL,
    sports_type character varying(2) NOT NULL,
    won_amount numeric(12,2),
    bet_amount numeric(12,2),
    input_output_gst_amount numeric(12,2),
    sales_amount numeric(12,2)
);


ALTER TABLE public.ztob_sportbetssettled_liability OWNER TO sp_postgres;

--
-- TOC entry 549 (class 1259 OID 25666)
-- Name: ztob_sportbetssettled_valid; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportbetssettled_valid (
    business_day date NOT NULL,
    account_no character varying(32) NOT NULL,
    bet_type character varying(5) NOT NULL,
    leg_status character varying(1) NOT NULL,
    channel character varying(1) NOT NULL,
    multiple_bet character varying(1) NOT NULL,
    bir character varying(1) NOT NULL,
    market_no character varying(4) NOT NULL,
    match_id integer NOT NULL,
    sports_type character varying(2) NOT NULL,
    validation_amount numeric(12,2)
);


ALTER TABLE public.ztob_sportbetssettled_valid OWNER TO sp_postgres;

--
-- TOC entry 550 (class 1259 OID 25669)
-- Name: ztob_sportreport40; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportreport40 (
    bet_id integer NOT NULL,
    match_id integer NOT NULL,
    market_id integer NOT NULL,
    selection_id integer NOT NULL,
    account_no character varying(32),
    placement_time_d date,
    placement_time_t time without time zone,
    placement_time_business_id integer,
    bet_status character varying(32),
    total_stake numeric(12,2),
    total_return numeric(12,2),
    match_name character varying(120),
    market_name character varying(120),
    selection_name character varying(120),
    market_settlement_date timestamp without time zone,
    market_settlement_date_d date,
    market_settlement_date_t time without time zone,
    market_settlement_date_business_id integer,
    system character varying(30)
);


ALTER TABLE public.ztob_sportreport40 OWNER TO sp_postgres;

--
-- TOC entry 551 (class 1259 OID 25672)
-- Name: ztob_sportscustdailystats; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportscustdailystats (
    account_no character varying(32) NOT NULL,
    channel character varying(1) NOT NULL,
    last_updated_date timestamp without time zone NOT NULL,
    sum_stakes numeric(12,2),
    sum_cust_income numeric(12,2),
    sum_pools_return numeric(12,2),
    sum_cust_refunds numeric(12,2),
    bet_count numeric(32,0),
    sum_unsettlement_stakes numeric(12,2),
    sum_unsettlement_cust_income numeric(12,2),
    sum_unsettlement_pools_return numeric(12,2),
    sum_unsettlement_cust_refunds numeric(12,2),
    sum_unsettlement_bet_count numeric(32,0)
);


ALTER TABLE public.ztob_sportscustdailystats OWNER TO sp_postgres;

--
-- TOC entry 552 (class 1259 OID 25675)
-- Name: ztob_sportscuststats; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_sportscuststats (
    account_no character varying(32) NOT NULL,
    channel character varying(1) NOT NULL,
    first_bet_id integer,
    last_bet_id integer,
    bet_count integer,
    last_updated_date timestamp without time zone,
    first_bet_date_d date,
    first_bet_date_t time without time zone,
    last_bet_date_d date,
    last_bet_date_t time without time zone
);


ALTER TABLE public.ztob_sportscuststats OWNER TO sp_postgres;

--
-- TOC entry 553 (class 1259 OID 25678)
-- Name: ztob_table_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_table_test (
    account_no character varying(32) NOT NULL,
    channel character varying(1) NOT NULL,
    last_updated_date timestamp without time zone NOT NULL,
    sum_stakes numeric(12,2),
    sum_cust_income numeric(12,2),
    sum_pools_return numeric(12,2),
    sum_cust_refunds numeric(12,2),
    bet_count numeric(32,0),
    sum_unsettlement_stakes numeric(12,2),
    sum_unsettlement_cust_income numeric(12,2),
    sum_unsettlement_pools_return numeric(12,2),
    sum_unsettlement_cust_refunds numeric(12,2),
    sum_unsettlement_bet_count numeric(32,0)
);


ALTER TABLE public.ztob_table_test OWNER TO sp_postgres;

--
-- TOC entry 554 (class 1259 OID 25681)
-- Name: ztob_timetable; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_timetable (
    match_id integer NOT NULL,
    match_no character varying(4),
    match_name character varying(120),
    league_name character varying(120),
    league_code character varying(30),
    event_type character varying(4),
    sports_type character varying(2),
    home_team character varying(255),
    away_team character varying(255),
    settled_flag character varying(1),
    last_updated_date timestamp without time zone,
    match_start_date_d date,
    match_start_date_t time without time zone,
    settled_date_d date,
    settled_date_t time without time zone,
    event_score_ht character varying(81),
    event_score_ft character varying(81),
    event_score_et_ht character varying(81),
    event_score_et_ft character varying(81),
    event_score_aet character varying(81)
);


ALTER TABLE public.ztob_timetable OWNER TO sp_postgres;

--
-- TOC entry 555 (class 1259 OID 25687)
-- Name: ztob_timetableselections; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_timetableselections (
    match_id integer NOT NULL,
    market_id integer NOT NULL,
    selection_id integer NOT NULL,
    market_no character varying(4),
    market_name character varying(100),
    selection_no character varying(4),
    selection_name character varying(120),
    selection_status character varying(1),
    selection_channels character varying(32),
    selection_creation_date_d date,
    selection_creation_date_t time without time zone,
    selection_creation_date_business_id integer,
    selection_settlement_date_d date,
    selection_settlement_date_t time without time zone,
    selection_settlement_date_business_id integer,
    last_updated_date timestamp without time zone,
    system character varying(30),
    selection_result character varying(2)
);


ALTER TABLE public.ztob_timetableselections OWNER TO sp_postgres;

--
-- TOC entry 556 (class 1259 OID 25690)
-- Name: ztob_transactioncodes; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztob_transactioncodes (
    trn_group character varying(16),
    trn_type character varying(128),
    trn_type_desc character varying(240),
    trn_subtype character varying(5),
    trn_subtype_desc character varying(50)
);


ALTER TABLE public.ztob_transactioncodes OWNER TO sp_postgres;

--
-- TOC entry 557 (class 1259 OID 25693)
-- Name: ztosd_eod_employee; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztosd_eod_employee (
    date date NOT NULL,
    branch integer NOT NULL,
    employee integer NOT NULL,
    employee_description character varying(60) NOT NULL,
    excess numeric(12,2),
    shortage numeric(12,2),
    rounding_difference numeric(12,2),
    currency character varying(5)
);


ALTER TABLE public.ztosd_eod_employee OWNER TO sp_postgres;

--
-- TOC entry 558 (class 1259 OID 25696)
-- Name: ztosd_eod_product; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztosd_eod_product (
    date date NOT NULL,
    branch integer NOT NULL,
    product integer NOT NULL,
    category character varying(1) NOT NULL,
    company_code character varying(4) NOT NULL,
    date_from date,
    date_to date,
    time_from time without time zone,
    time_to time without time zone,
    eod_amount numeric(12,2),
    opening_balance_sport_voucher numeric(12,2),
    sweep_amount numeric(12,2),
    currency character varying(5)
);


ALTER TABLE public.ztosd_eod_product OWNER TO sp_postgres;

--
-- TOC entry 559 (class 1259 OID 25699)
-- Name: ztosd_md_branch_insurance; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztosd_md_branch_insurance (
    branch integer NOT NULL,
    branch_name character varying(100),
    nets_id bigint,
    tote_id integer,
    svs_id integer,
    cash_card_id bigint,
    cluster character varying(5),
    obsolete character varying(1),
    insurance_limit numeric(22,2),
    open_balance_sport_voucher numeric(22,2),
    open_balance_sport_voucher_date date
);


ALTER TABLE public.ztosd_md_branch_insurance OWNER TO sp_postgres;

--
-- TOC entry 872 (class 1259 OID 1072968)
-- Name: ztosd_md_branch_insurance_bk20240314; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztosd_md_branch_insurance_bk20240314 (
    branch integer NOT NULL,
    branch_name character varying(100),
    nets_id bigint,
    tote_id integer,
    svs_id integer,
    cash_card_id bigint,
    cluster character varying(5),
    obsolete character varying(1),
    insurance_limit numeric(22,2),
    open_balance_sport_voucher numeric(22,2),
    open_balance_sport_voucher_date date
);


ALTER TABLE public.ztosd_md_branch_insurance_bk20240314 OWNER TO sp_postgres;

--
-- TOC entry 560 (class 1259 OID 25702)
-- Name: ztosd_md_product; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztosd_md_product (
    product integer NOT NULL,
    product_description character varying(100),
    category character varying(1),
    category_description character varying(50)
);


ALTER TABLE public.ztosd_md_product OWNER TO sp_postgres;

--
-- TOC entry 561 (class 1259 OID 25705)
-- Name: ztosd_nets; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztosd_nets (
    date date NOT NULL,
    branch integer NOT NULL,
    eftpos numeric(12,2) NOT NULL,
    cash_card numeric(12,2) NOT NULL,
    currency character varying(5)
);


ALTER TABLE public.ztosd_nets OWNER TO sp_postgres;

--
-- TOC entry 562 (class 1259 OID 25708)
-- Name: ztosd_svs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztosd_svs (
    date date NOT NULL,
    claim_id character varying(17) NOT NULL,
    draw_number character varying(6) NOT NULL,
    ticket_number character varying(7) NOT NULL,
    serial_number character varying(22) NOT NULL,
    prize_code character varying(2) NOT NULL,
    svs_id character varying(6) NOT NULL,
    terminal_number character varying(4) NOT NULL,
    sweep_amount_paid numeric(9,2),
    currency character varying(5)
);


ALTER TABLE public.ztosd_svs OWNER TO sp_postgres;

--
-- TOC entry 563 (class 1259 OID 25711)
-- Name: ztosd_tote; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztosd_tote (
    date date NOT NULL,
    branch integer NOT NULL,
    gross_tote_investments numeric(12,2),
    tote_cancels numeric(12,2),
    tote_payouts numeric(12,2),
    tote_refunds numeric(12,2),
    net_tote_investments numeric(12,2),
    net_rebate numeric(12,2),
    sbk_collections numeric(12,2),
    account_deposit numeric(12,2),
    account_withdrawal numeric(12,2),
    currency character varying(5),
    run_datetime timestamp without time zone
);


ALTER TABLE public.ztosd_tote OWNER TO sp_postgres;

--
-- TOC entry 564 (class 1259 OID 25714)
-- Name: ztrtms2_customer; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms2_customer (
    auditlogid bigint NOT NULL,
    devref character varying(255),
    mobnbr character varying(255),
    email character varying(255),
    isactive integer,
    monthlyexpenselimit double precision,
    deviceid character varying(100),
    action character varying(10),
    updatedat timestamp(0) without time zone,
    updatedby character varying(128),
    dateofbirth date,
    bankreferenceid character varying(50),
    mobnbr_decrypted character varying,
    email_decrypted character varying
);


ALTER TABLE public.ztrtms2_customer OWNER TO sp_postgres;

--
-- TOC entry 565 (class 1259 OID 25720)
-- Name: ztrtms2_inv_dev; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms2_inv_dev (
    salesdate date NOT NULL,
    terminal integer NOT NULL,
    product integer NOT NULL,
    salestype integer NOT NULL,
    retailer integer,
    transcount bigint,
    transamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms2_inv_dev OWNER TO sp_postgres;

--
-- TOC entry 566 (class 1259 OID 25723)
-- Name: ztrtms2_retailer_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms2_retailer_master (
    retailer bigint NOT NULL,
    retailername character varying(255),
    retailertypeid integer,
    retailertype character varying(255),
    businesscode integer,
    businesscodename character varying(255),
    bankaccountnumber bigint,
    bankroutingnumber integer,
    bankbranchcode integer,
    address character varying(255),
    postalcode character varying(6),
    createdby character varying(255),
    createddate date,
    activationdate date,
    deactivationdate date,
    status integer,
    sun_open time without time zone,
    sun_close time without time zone,
    mon_open time without time zone,
    mon_close time without time zone,
    tue_open time without time zone,
    tue_close time without time zone,
    wed_open time without time zone,
    wed_close time without time zone,
    thu_open time without time zone,
    thu_close time without time zone,
    fri_open time without time zone,
    fri_close time without time zone,
    sat_open time without time zone,
    sat_close time without time zone,
    last_updated_date date,
    gstflag integer,
    gstregnumber character varying(15),
    last_updated_time time without time zone,
    ibgflag integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms2_retailer_master OWNER TO sp_postgres;

--
-- TOC entry 567 (class 1259 OID 25729)
-- Name: ztrtms2_terminal_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms2_terminal_master (
    terminal bigint NOT NULL,
    retailer integer,
    chainid integer,
    superchainid integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms2_terminal_master OWNER TO sp_postgres;

--
-- TOC entry 568 (class 1259 OID 25732)
-- Name: ztrtms2_trans_horse; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms2_trans_horse (
    busdate date NOT NULL,
    transheaderid character varying(50) NOT NULL,
    transtype integer NOT NULL,
    uuid character varying(50) NOT NULL,
    productid integer NOT NULL,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone NOT NULL,
    terminalid bigint NOT NULL,
    userid character varying(50),
    retailerid bigint NOT NULL,
    devref character varying(255),
    claimsref character varying(255),
    mobnbr character varying(255),
    email character varying(255),
    wager double precision NOT NULL,
    sales double precision,
    salescomm double precision,
    gst double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255),
    transfee double precision,
    rebate double precision
);


ALTER TABLE public.ztrtms2_trans_horse OWNER TO sp_postgres;

--
-- TOC entry 569 (class 1259 OID 25738)
-- Name: ztrtms2_trans_lottery; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms2_trans_lottery (
    busdate date NOT NULL,
    transheaderid character varying(50) NOT NULL,
    boardid character varying(50) NOT NULL,
    drawid integer NOT NULL,
    transtype integer NOT NULL,
    uuid character varying(50) NOT NULL,
    productid integer NOT NULL,
    bettypeid character varying(3) NOT NULL,
    selection character varying(255) NOT NULL,
    transtimestamp timestamp without time zone NOT NULL,
    terminalid bigint NOT NULL,
    userid character varying(50),
    retailerid bigint NOT NULL,
    devref character varying(255),
    claimsref character varying(255),
    mobnbr character varying(255),
    email character varying(255),
    entrymethod integer,
    numboards integer,
    numdraws integer,
    numsimplebets integer,
    qpflag integer,
    nummarks integer,
    bulkid character varying(255),
    itotoparts integer,
    itotototalparts integer,
    grptotoparts integer,
    wager1 double precision NOT NULL,
    wager2 double precision NOT NULL,
    sales1 double precision,
    sales2 double precision,
    salescomm1 double precision,
    salescomm2 double precision,
    gst1 double precision,
    gst2 double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255),
    transfee double precision
);


ALTER TABLE public.ztrtms2_trans_lottery OWNER TO sp_postgres;

--
-- TOC entry 570 (class 1259 OID 25744)
-- Name: ztrtms2_trans_sports; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms2_trans_sports (
    busdate date NOT NULL,
    transheaderid character varying(50) NOT NULL,
    matchid bigint NOT NULL,
    transtype integer NOT NULL,
    uuid character varying(50) NOT NULL,
    productid integer NOT NULL,
    bettypeid character varying(3) NOT NULL,
    selection character varying(255) NOT NULL,
    transtimestamp timestamp without time zone NOT NULL,
    terminalid bigint NOT NULL,
    userid character varying(50),
    retailerid bigint NOT NULL,
    devref character varying(255),
    claimsref character varying(255),
    mobnbr character varying(255),
    email character varying(255),
    leaguecode character varying(4) NOT NULL,
    liveind character varying(1) NOT NULL,
    matchname character varying(255) NOT NULL,
    market character varying(255) NOT NULL,
    odds double precision NOT NULL,
    matchstarttimestamp timestamp without time zone NOT NULL,
    wager double precision NOT NULL,
    sales double precision,
    salescomm double precision,
    gst double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255),
    transfee double precision
);


ALTER TABLE public.ztrtms2_trans_sports OWNER TO sp_postgres;

--
-- TOC entry 571 (class 1259 OID 25750)
-- Name: ztrtms2_user_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms2_user_master (
    userseqid bigint NOT NULL,
    "User" character varying(10),
    retailer integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms2_user_master OWNER TO sp_postgres;

--
-- TOC entry 936 (class 1259 OID 1840213)
-- Name: ztrtms_inout_paymentdetail; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_inout_paymentdetail (
    inout_paymentdetailid bigint NOT NULL,
    out_payoutid character varying(38),
    in_paymentdetailid character varying(38),
    in_paymentid character varying(38),
    transactiontype character varying(38) NOT NULL,
    paidamount numeric(18,2),
    paymenttypeid character varying(5) NOT NULL,
    cartid character varying(38),
    terdisplayid character varying(50),
    userdisplayid character varying(50),
    sessionid character varying(38),
    createddate timestamp without time zone NOT NULL
);


ALTER TABLE public.ztrtms_inout_paymentdetail OWNER TO sp_postgres;

--
-- TOC entry 935 (class 1259 OID 1840211)
-- Name: ztrtms_inout_paymentdetail_inout_paymentdetailid_seq; Type: SEQUENCE; Schema: public; Owner: sp_postgres
--

CREATE SEQUENCE public.ztrtms_inout_paymentdetail_inout_paymentdetailid_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE public.ztrtms_inout_paymentdetail_inout_paymentdetailid_seq OWNER TO sp_postgres;

--
-- TOC entry 7959 (class 0 OID 0)
-- Dependencies: 935
-- Name: ztrtms_inout_paymentdetail_inout_paymentdetailid_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: sp_postgres
--

ALTER SEQUENCE public.ztrtms_inout_paymentdetail_inout_paymentdetailid_seq OWNED BY public.ztrtms_inout_paymentdetail.inout_paymentdetailid;


--
-- TOC entry 968 (class 1259 OID 1858022)
-- Name: ztrtms_inout_paymentdetail_temp; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_inout_paymentdetail_temp (
    out_payoutid character varying(38),
    in_paymentdetailid character varying(38),
    in_paymentid character varying(38),
    transactiontype character varying(38),
    paidamount numeric(18,2),
    paymenttypeid character varying(5),
    cartid character varying(38),
    terdisplayid character varying(50),
    userdisplayid character varying(50),
    sessionid character varying(38),
    createddate timestamp without time zone
);


ALTER TABLE public.ztrtms_inout_paymentdetail_temp OWNER TO sp_postgres;

--
-- TOC entry 572 (class 1259 OID 25753)
-- Name: ztrtms_inv_adj; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_inv_adj (
    adjdate date NOT NULL,
    adjserial integer NOT NULL,
    invoiceid integer,
    retailer integer,
    transtype integer,
    lineitemcode integer,
    updatetimestamp timestamp without time zone,
    agentstatus integer,
    adjtype character varying(5),
    adjamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_adj OWNER TO sp_postgres;

--
-- TOC entry 979 (class 1259 OID 1909174)
-- Name: ztrtms_inv_adj_bkup_240909; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztrtms_inv_adj_bkup_240909 (
    adjdate date,
    adjserial integer,
    invoiceid integer,
    retailer integer,
    transtype integer,
    lineitemcode integer,
    updatetimestamp timestamp without time zone,
    agentstatus integer,
    adjtype character varying(5),
    adjamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_adj_bkup_240909 OWNER TO postgres;

--
-- TOC entry 917 (class 1259 OID 1616726)
-- Name: ztrtms_inv_adj_uat_20240702; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_inv_adj_uat_20240702 (
    adjdate date,
    adjserial integer,
    invoiceid integer,
    retailer integer,
    transtype integer,
    lineitemcode integer,
    updatetimestamp timestamp without time zone,
    agentstatus integer,
    adjtype character varying(5),
    adjamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_adj_uat_20240702 OWNER TO sp_postgres;

--
-- TOC entry 573 (class 1259 OID 25756)
-- Name: ztrtms_inv_adj_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztrtms_inv_adj_uat_test (
    adjdate date,
    adjserial integer,
    invoiceid integer,
    retailer integer,
    transtype integer,
    lineitemcode integer,
    updatetimestamp timestamp without time zone,
    agentstatus integer,
    adjtype character varying(5),
    adjamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_adj_uat_test OWNER TO consultant01;

--
-- TOC entry 574 (class 1259 OID 25759)
-- Name: ztrtms_inv_agt; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_inv_agt (
    retailer integer NOT NULL,
    invoiceid integer NOT NULL,
    product integer NOT NULL,
    salestype integer NOT NULL,
    chainid integer,
    salescount bigint,
    salesamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_agt OWNER TO sp_postgres;

--
-- TOC entry 575 (class 1259 OID 25762)
-- Name: ztrtms_inv_agt_uat; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_inv_agt_uat (
    retailer integer,
    invoiceid integer,
    product integer,
    salestype integer,
    chainid integer,
    salescount bigint,
    salesamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_agt_uat OWNER TO sp_postgres;

--
-- TOC entry 576 (class 1259 OID 25765)
-- Name: ztrtms_inv_def; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_inv_def (
    invoiceid integer NOT NULL,
    startdate date,
    enddate date,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_def OWNER TO sp_postgres;

--
-- TOC entry 577 (class 1259 OID 25768)
-- Name: ztrtms_inv_def_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztrtms_inv_def_uat_test (
    invoiceid integer,
    startdate date,
    enddate date,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_def_uat_test OWNER TO consultant01;

--
-- TOC entry 578 (class 1259 OID 25771)
-- Name: ztrtms_inv_dev; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_inv_dev (
    salesdate date NOT NULL,
    terminal integer NOT NULL,
    product integer NOT NULL,
    salestype integer NOT NULL,
    retailer integer,
    transcount bigint,
    transamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_dev OWNER TO sp_postgres;

--
-- TOC entry 579 (class 1259 OID 25774)
-- Name: ztrtms_inv_dev_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztrtms_inv_dev_uat_test (
    salesdate date,
    terminal integer,
    product integer,
    salestype integer,
    retailer integer,
    transcount bigint,
    transamount bigint,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_inv_dev_uat_test OWNER TO consultant01;

--
-- TOC entry 580 (class 1259 OID 25777)
-- Name: ztrtms_location_oprhrs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_location_oprhrs (
    retailer bigint NOT NULL,
    terminal bigint NOT NULL,
    signondate date NOT NULL,
    signontime time without time zone NOT NULL,
    retailername character varying(255),
    opentime time without time zone,
    firstsaletime time without time zone,
    firsthourcount integer,
    closetime time without time zone,
    signoffdate date,
    signofftime time without time zone,
    lastsaletime time without time zone,
    lasthourcount integer,
    busdate date,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_location_oprhrs OWNER TO sp_postgres;

--
-- TOC entry 581 (class 1259 OID 25780)
-- Name: ztrtms_location_oprhrs_ubt_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_location_oprhrs_ubt_test (
    retailername text,
    retailer numeric,
    terminal numeric,
    opentime timestamp without time zone,
    signondate timestamp without time zone,
    signontime timestamp without time zone,
    firstsaletime timestamp without time zone,
    firsthourcount numeric,
    closetime timestamp without time zone,
    signoffdate timestamp without time zone,
    signofftime timestamp without time zone,
    lastsaletime timestamp without time zone,
    lasthourcount numeric,
    busdate timestamp without time zone,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_location_oprhrs_ubt_test OWNER TO sp_postgres;

--
-- TOC entry 582 (class 1259 OID 25786)
-- Name: ztrtms_retailer_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_retailer_master (
    retailer bigint NOT NULL,
    retailername character varying(255),
    retailertypeid integer,
    retailertype character varying(255),
    businesscode integer,
    businesscodename character varying(255),
    bankaccountnumber bigint,
    bankroutingnumber bigint,
    bankbranchcode bigint,
    address character varying(255),
    postalcode character varying(6),
    createdby character varying(255),
    createddate date,
    activationdate date,
    deactivationdate date,
    status integer,
    sun_open time without time zone,
    sun_close time without time zone,
    mon_open time without time zone,
    mon_close time without time zone,
    tue_open time without time zone,
    tue_close time without time zone,
    wed_open time without time zone,
    wed_close time without time zone,
    thu_open time without time zone,
    thu_close time without time zone,
    fri_open time without time zone,
    fri_close time without time zone,
    sat_open time without time zone,
    sat_close time without time zone,
    last_updated_date date,
    gstflag integer,
    gstregnumber character varying(15),
    last_updated_time time without time zone,
    ibgflag integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_retailer_master OWNER TO sp_postgres;

--
-- TOC entry 996 (class 1259 OID 2046959)
-- Name: ztrtms_retailer_master_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_retailer_master_bk_before_tfog (
    retailer bigint NOT NULL,
    retailername character varying(255),
    retailertypeid integer,
    retailertype character varying(255),
    businesscode integer,
    businesscodename character varying(255),
    bankaccountnumber bigint,
    bankroutingnumber bigint,
    bankbranchcode bigint,
    address character varying(255),
    postalcode character varying(6),
    createdby character varying(255),
    createddate date,
    activationdate date,
    deactivationdate date,
    status integer,
    sun_open time without time zone,
    sun_close time without time zone,
    mon_open time without time zone,
    mon_close time without time zone,
    tue_open time without time zone,
    tue_close time without time zone,
    wed_open time without time zone,
    wed_close time without time zone,
    thu_open time without time zone,
    thu_close time without time zone,
    fri_open time without time zone,
    fri_close time without time zone,
    sat_open time without time zone,
    sat_close time without time zone,
    last_updated_date date,
    gstflag integer,
    gstregnumber character varying(15),
    last_updated_time time without time zone,
    ibgflag integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_retailer_master_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 583 (class 1259 OID 25792)
-- Name: ztrtms_retailer_master_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztrtms_retailer_master_uat_test (
    retailer bigint,
    retailername character varying(255),
    retailertypeid integer,
    retailertype character varying(255),
    businesscode integer,
    businesscodename character varying(255),
    bankaccountnumber bigint,
    bankroutingnumber bigint,
    bankbranchcode bigint,
    address character varying(255),
    postalcode character varying(6),
    createdby character varying(255),
    createddate date,
    activationdate date,
    deactivationdate date,
    status integer,
    sun_open time without time zone,
    sun_close time without time zone,
    mon_open time without time zone,
    mon_close time without time zone,
    tue_open time without time zone,
    tue_close time without time zone,
    wed_open time without time zone,
    wed_close time without time zone,
    thu_open time without time zone,
    thu_close time without time zone,
    fri_open time without time zone,
    fri_close time without time zone,
    sat_open time without time zone,
    sat_close time without time zone,
    last_updated_date date,
    gstflag integer,
    gstregnumber character varying(15),
    last_updated_time time without time zone,
    ibgflag integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_retailer_master_uat_test OWNER TO consultant01;

--
-- TOC entry 584 (class 1259 OID 25798)
-- Name: ztrtms_terminal_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_terminal_master (
    terminal bigint NOT NULL,
    retailer integer,
    chainid integer,
    superchainid integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_terminal_master OWNER TO sp_postgres;

--
-- TOC entry 585 (class 1259 OID 25801)
-- Name: ztrtms_terminal_master_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztrtms_terminal_master_uat_test (
    terminal bigint,
    retailer integer,
    chainid integer,
    superchainid integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_terminal_master_uat_test OWNER TO consultant01;

--
-- TOC entry 586 (class 1259 OID 25804)
-- Name: ztrtms_trans_entry; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_entry (
    busdate date NOT NULL,
    transheaderid character varying(50) NOT NULL,
    transtype integer NOT NULL,
    entrymethod integer,
    retailerid bigint NOT NULL,
    productid integer NOT NULL
);


ALTER TABLE public.ztrtms_trans_entry OWNER TO sp_postgres;

--
-- TOC entry 827 (class 1259 OID 217481)
-- Name: ztrtms_trans_entry_uat_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_entry_uat_test (
    busdate date NOT NULL,
    transheaderid character varying(50) NOT NULL,
    transtype integer NOT NULL,
    entrymethod integer,
    retailerid bigint NOT NULL,
    productid integer NOT NULL
);


ALTER TABLE public.ztrtms_trans_entry_uat_test OWNER TO sp_postgres;

--
-- TOC entry 587 (class 1259 OID 25807)
-- Name: ztrtms_trans_horse; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_horse (
    busdate date NOT NULL,
    transheaderid character varying(50) NOT NULL,
    transtype integer NOT NULL,
    uuid character varying(50) NOT NULL,
    productid integer NOT NULL,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone NOT NULL,
    terminalid bigint NOT NULL,
    userid character varying(50),
    retailerid bigint NOT NULL,
    wager double precision NOT NULL,
    sales double precision,
    salescomm double precision,
    gst double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255),
    rebate double precision
);


ALTER TABLE public.ztrtms_trans_horse OWNER TO sp_postgres;

--
-- TOC entry 588 (class 1259 OID 25819)
-- Name: ztrtms_trans_horse_uat; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_horse_uat (
    busdate date,
    transheaderid character varying(50),
    transtype integer,
    uuid character varying(50),
    productid integer,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone,
    terminalid bigint,
    userid character varying(50),
    retailerid bigint,
    wager double precision,
    sales double precision,
    salescomm double precision,
    gst double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255),
    rebate double precision
);


ALTER TABLE public.ztrtms_trans_horse_uat OWNER TO sp_postgres;

--
-- TOC entry 589 (class 1259 OID 25825)
-- Name: ztrtms_trans_lottery; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_lottery (
    busdate date NOT NULL,
    transheaderid character varying(50) NOT NULL,
    boardid character varying(50) NOT NULL,
    drawid integer NOT NULL,
    transtype integer NOT NULL,
    uuid character varying(50) NOT NULL,
    productid integer NOT NULL,
    bettypeid character varying(3) NOT NULL,
    selection character varying(255) NOT NULL,
    transtimestamp timestamp without time zone NOT NULL,
    terminalid bigint NOT NULL,
    userid character varying(50),
    retailerid bigint NOT NULL,
    entrymethod integer,
    numboards integer,
    numdraws integer,
    ebetslipdeviceid character varying(255),
    numsimplebets integer,
    qpflag integer,
    nummarks integer,
    bulkid character varying(255),
    itotoparts integer,
    itotototalparts integer,
    grptotoparts integer,
    wager1 double precision NOT NULL,
    wager2 double precision NOT NULL,
    sales1 double precision,
    sales2 double precision,
    salescomm1 double precision,
    salescomm2 double precision,
    gst1 double precision,
    gst2 double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255)
);


ALTER TABLE public.ztrtms_trans_lottery OWNER TO sp_postgres;

--
-- TOC entry 1016 (class 1259 OID 2237316)
-- Name: ztrtms_trans_lottery_bk20241204; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_lottery_bk20241204 (
    busdate date,
    transheaderid character varying(50),
    boardid character varying(50),
    drawid integer,
    transtype integer,
    uuid character varying(50),
    productid integer,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone,
    terminalid bigint,
    userid character varying(50),
    retailerid bigint,
    entrymethod integer,
    numboards integer,
    numdraws integer,
    ebetslipdeviceid character varying(255),
    numsimplebets integer,
    qpflag integer,
    nummarks integer,
    bulkid character varying(255),
    itotoparts integer,
    itotototalparts integer,
    grptotoparts integer,
    wager1 double precision,
    wager2 double precision,
    sales1 double precision,
    sales2 double precision,
    salescomm1 double precision,
    salescomm2 double precision,
    gst1 double precision,
    gst2 double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255)
);


ALTER TABLE public.ztrtms_trans_lottery_bk20241204 OWNER TO sp_postgres;

--
-- TOC entry 896 (class 1259 OID 1482961)
-- Name: ztrtms_trans_lottery_bkdata_20240610; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_lottery_bkdata_20240610 (
    busdate date,
    transheaderid character varying(50),
    boardid character varying(50),
    drawid integer,
    transtype integer,
    uuid character varying(50),
    productid integer,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone,
    terminalid bigint,
    userid character varying(50),
    retailerid bigint,
    entrymethod integer,
    numboards integer,
    numdraws integer,
    ebetslipdeviceid character varying(255),
    numsimplebets integer,
    qpflag integer,
    nummarks integer,
    bulkid character varying(255),
    itotoparts integer,
    itotototalparts integer,
    grptotoparts integer,
    wager1 double precision,
    wager2 double precision,
    sales1 double precision,
    sales2 double precision,
    salescomm1 double precision,
    salescomm2 double precision,
    gst1 double precision,
    gst2 double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255)
);


ALTER TABLE public.ztrtms_trans_lottery_bkdata_20240610 OWNER TO sp_postgres;

--
-- TOC entry 1018 (class 1259 OID 2282805)
-- Name: ztrtms_trans_lottery_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_lottery_test (
    busdate date,
    transheaderid character varying(50),
    boardid character varying(50),
    drawid integer,
    transtype integer,
    uuid character varying(50),
    productid integer,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone,
    terminalid bigint,
    userid character varying(50),
    retailerid bigint,
    entrymethod integer,
    numboards integer,
    numdraws integer,
    ebetslipdeviceid character varying(255),
    numsimplebets integer,
    qpflag integer,
    nummarks integer,
    bulkid character varying(255),
    itotoparts integer,
    itotototalparts integer,
    grptotoparts integer,
    wager1 double precision,
    wager2 double precision,
    sales1 double precision,
    sales2 double precision,
    salescomm1 double precision,
    salescomm2 double precision,
    gst1 double precision,
    gst2 double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255)
);


ALTER TABLE public.ztrtms_trans_lottery_test OWNER TO sp_postgres;

--
-- TOC entry 590 (class 1259 OID 25837)
-- Name: ztrtms_trans_lottery_uat; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_lottery_uat (
    busdate date,
    transheaderid character varying(50),
    boardid character varying(50),
    drawid integer,
    transtype integer,
    uuid character varying(50),
    productid integer,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone,
    terminalid bigint,
    userid character varying(50),
    retailerid bigint,
    entrymethod integer,
    numboards integer,
    numdraws integer,
    ebetslipdeviceid character varying(255),
    numsimplebets integer,
    qpflag integer,
    nummarks integer,
    bulkid character varying(255),
    itotoparts integer,
    itotototalparts integer,
    grptotoparts integer,
    wager1 double precision,
    wager2 double precision,
    sales1 double precision,
    sales2 double precision,
    salescomm1 double precision,
    salescomm2 double precision,
    gst1 double precision,
    gst2 double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255)
);


ALTER TABLE public.ztrtms_trans_lottery_uat OWNER TO sp_postgres;

--
-- TOC entry 591 (class 1259 OID 25843)
-- Name: ztrtms_trans_sports; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_sports (
    busdate date NOT NULL,
    transheaderid character varying(50) NOT NULL,
    matchid bigint NOT NULL,
    transtype integer NOT NULL,
    uuid character varying(50) NOT NULL,
    productid integer NOT NULL,
    bettypeid character varying(3) NOT NULL,
    selection character varying(255) NOT NULL,
    transtimestamp timestamp without time zone NOT NULL,
    terminalid bigint NOT NULL,
    userid character varying(50),
    retailerid bigint NOT NULL,
    leaguecode character varying(4) NOT NULL,
    liveind character varying(1) NOT NULL,
    matchname character varying(255) NOT NULL,
    market character varying(255) NOT NULL,
    odds double precision NOT NULL,
    matchstarttimestamp timestamp without time zone NOT NULL,
    wager double precision NOT NULL,
    sales double precision,
    salescomm double precision,
    gst double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255),
    entrymethod integer,
    ebetslipdeviceid character varying(255)
);


ALTER TABLE public.ztrtms_trans_sports OWNER TO sp_postgres;

--
-- TOC entry 592 (class 1259 OID 25855)
-- Name: ztrtms_trans_sports_uat; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_trans_sports_uat (
    busdate date,
    transheaderid character varying(50),
    matchid bigint,
    transtype integer,
    uuid character varying(50),
    productid integer,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone,
    terminalid bigint,
    userid character varying(50),
    retailerid bigint,
    leaguecode character varying(4),
    liveind character varying(1),
    matchname character varying(255),
    market character varying(255),
    odds double precision,
    matchstarttimestamp timestamp without time zone,
    wager double precision,
    sales double precision,
    salescomm double precision,
    gst double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255),
    entrymethod integer,
    ebetslipdeviceid character varying(255)
)
WITH (autovacuum_enabled=off);


ALTER TABLE public.ztrtms_trans_sports_uat OWNER TO sp_postgres;

--
-- TOC entry 593 (class 1259 OID 25861)
-- Name: ztrtms_user_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztrtms_user_master (
    userseqid bigint NOT NULL,
    "User" character varying(10),
    retailer integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_user_master OWNER TO sp_postgres;

--
-- TOC entry 594 (class 1259 OID 25864)
-- Name: ztrtms_user_master_uat_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztrtms_user_master_uat_test (
    userseqid bigint,
    "User" character varying(10),
    retailer integer,
    change_log_date timestamp without time zone
);


ALTER TABLE public.ztrtms_user_master_uat_test OWNER TO consultant01;

--
-- TOC entry 595 (class 1259 OID 25867)
-- Name: ztsapfi_cca; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_cca (
    chart_of_accounts character varying(4) NOT NULL,
    controlling_area character varying(4) NOT NULL,
    company_code character varying(4) NOT NULL,
    cost_center character varying(10) NOT NULL,
    cost_element character varying(10) NOT NULL,
    currency_type character varying(2) NOT NULL,
    customer character varying(10) NOT NULL,
    fm_area character varying(4) NOT NULL,
    functional_area character varying(16) NOT NULL,
    fund character varying(20) NOT NULL,
    gl_account character varying(10) NOT NULL,
    "grant" character varying(20) NOT NULL,
    valuation_view smallint NOT NULL,
    version character varying(3) NOT NULL,
    value_type smallint NOT NULL,
    fiscal_year_period integer NOT NULL,
    currency character varying(5) NOT NULL,
    amount numeric(13,2),
    quantity numeric(13,3),
    unit character varying(3),
    fp_request_tsn character varying(23),
    fp_data_packet character varying(6),
    fp_entry_item integer NOT NULL,
    plan_category character varying(10) NOT NULL,
    ledger character varying(2) NOT NULL,
    profit_center character varying(10) NOT NULL,
    project_definition character varying(24) NOT NULL,
    project_name character varying(40),
    wbs_element character varying(24) NOT NULL,
    wbs_element_name character varying(40)
);


ALTER TABLE public.ztsapfi_cca OWNER TO sp_postgres;

--
-- TOC entry 596 (class 1259 OID 25873)
-- Name: ztsapfi_cca_new; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_cca_new (
    chart_of_accounts character varying(4) NOT NULL,
    controlling_area character varying(4) NOT NULL,
    company_code character varying(4) NOT NULL,
    cost_center character varying(10) NOT NULL,
    cost_element character varying(10) NOT NULL,
    currency_type character varying(2) NOT NULL,
    customer character varying(10) NOT NULL,
    fm_area character varying(4) NOT NULL,
    functional_area character varying(16) NOT NULL,
    fund character varying(20) NOT NULL,
    gl_account character varying(10) NOT NULL,
    "grant" character varying(20) NOT NULL,
    valuation_view smallint NOT NULL,
    version character varying(3) NOT NULL,
    value_type smallint NOT NULL,
    fiscal_year_period integer NOT NULL,
    currency character varying(5) NOT NULL,
    amount numeric(13,2),
    quantity numeric(13,3),
    unit character varying(3),
    fp_request_tsn character varying(23),
    fp_data_packet character varying(6),
    fp_entry_item integer NOT NULL,
    plan_category character varying(10) NOT NULL,
    profit_center character varying(10) NOT NULL,
    project_definition character varying(24) NOT NULL,
    project_name character varying(40),
    wbs_element character varying(24) NOT NULL,
    wbs_element_name character varying(40),
    ledger character varying(2) NOT NULL
);


ALTER TABLE public.ztsapfi_cca_new OWNER TO sp_postgres;

--
-- TOC entry 597 (class 1259 OID 25876)
-- Name: ztsapfi_cchierarchy; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_cchierarchy (
    controlling_area character varying(4) NOT NULL,
    cost_center_hierarchy character varying(42) NOT NULL,
    validity_end_date date,
    cc_level1 character varying(40),
    cc_level2 character varying(40),
    cc_level3 character varying(40),
    cc_level4 character varying(40),
    cc_level5 character varying(40),
    cc_level6 character varying(40),
    cc_level7 character varying(40),
    cost_center_range1 character varying(10) NOT NULL,
    cost_center_range2 character varying(10) NOT NULL,
    text character varying(40) NOT NULL,
    change_on date
);


ALTER TABLE public.ztsapfi_cchierarchy OWNER TO sp_postgres;

--
-- TOC entry 598 (class 1259 OID 25879)
-- Name: ztsapfi_ccmaster; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_ccmaster (
    cost_center character varying(10) NOT NULL,
    cost_center_text character varying(40),
    controlling_area character varying(4) NOT NULL,
    valid_from date,
    valid_to date NOT NULL,
    actual_primary_costs character varying(1),
    plan_primary_costs character varying(1),
    actl_sec_costs character varying(1),
    actual_revenues character varying(1),
    commitment_update character varying(1),
    lock_plan_sec_costs character varying(1),
    lock_planning_revn character varying(1),
    company_code character varying(4) NOT NULL,
    profit_center character varying(10),
    cost_center_category character varying(1),
    hierarchy_area character varying(12),
    department character varying(12),
    functional_area character varying(16),
    functional_area_description character varying(30),
    cchierarchy_cos_01 character varying(40),
    wagering_division_cos character varying(40),
    wagering_dept_cos character varying(40)
);


ALTER TABLE public.ztsapfi_ccmaster OWNER TO sp_postgres;

--
-- TOC entry 1025 (class 1259 OID 2431243)
-- Name: ztsapfi_ccmaster_backup; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_ccmaster_backup (
    cost_center character varying(10),
    cost_center_text character varying(40),
    controlling_area character varying(4),
    valid_from date,
    valid_to date,
    actual_primary_costs character varying(1),
    plan_primary_costs character varying(1),
    actl_sec_costs character varying(1),
    actual_revenues character varying(1),
    commitment_update character varying(1),
    lock_plan_sec_costs character varying(1),
    lock_planning_revn character varying(1),
    company_code character varying(4),
    profit_center character varying(10),
    cost_center_category character varying(1),
    hierarchy_area character varying(12),
    department character varying(12),
    functional_area character varying(16),
    functional_area_description character varying(30),
    cchierarchy_cos_01 character varying(40),
    wagering_division_cos character varying(40),
    wagering_dept_cos character varying(40)
);


ALTER TABLE public.ztsapfi_ccmaster_backup OWNER TO sp_postgres;

--
-- TOC entry 599 (class 1259 OID 25885)
-- Name: ztsapfi_ccmaster_org; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_ccmaster_org (
    cost_center character varying(10),
    cost_center_text character varying(40),
    controlling_area character varying(4),
    valid_from date,
    valid_to date,
    actual_primary_costs character varying(1),
    plan_primary_costs character varying(1),
    actl_sec_costs character varying(1),
    actual_revenues character varying(1),
    commitment_update character varying(1),
    lock_plan_sec_costs character varying(1),
    lock_planning_revn character varying(1),
    company_code character varying(4),
    profit_center character varying(10),
    cost_center_category character varying(1),
    hierarchy_area character varying(12),
    department character varying(12),
    functional_area character varying(16),
    functional_area_description character varying(30),
    cchierarchy_cos_01 character varying(40),
    wagering_division_cos character varying(40),
    wagering_dept_cos character varying(40)
);


ALTER TABLE public.ztsapfi_ccmaster_org OWNER TO sp_postgres;

--
-- TOC entry 600 (class 1259 OID 25888)
-- Name: ztsapfi_copa; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_copa (
    bet_mode character varying(18) NOT NULL,
    business_area character varying(4) NOT NULL,
    chart_of_accounts character varying(4) NOT NULL,
    company_code character varying(4) NOT NULL,
    controlling_area character varying(4) NOT NULL,
    cost_center character varying(10) NOT NULL,
    cost_element character varying(10) NOT NULL,
    country character varying(3) NOT NULL,
    customer character varying(10) NOT NULL,
    draw_number character varying(18) NOT NULL,
    league_code character varying(6) NOT NULL,
    material character varying(18) NOT NULL,
    product_id character varying(3) NOT NULL,
    product_hierarchy character varying(18) NOT NULL,
    profit_center character varying(10) NOT NULL,
    valuation_view smallint NOT NULL,
    value_type smallint NOT NULL,
    version character varying(3) NOT NULL,
    fiscal_year_period integer NOT NULL,
    controlling_currency character varying(5) NOT NULL,
    total_value_controlling numeric(13,2),
    object_currency character varying(5) NOT NULL,
    total_value_object numeric(13,2),
    transaction_currency character varying(5) NOT NULL,
    total_value_transaction numeric(13,2)
);


ALTER TABLE public.ztsapfi_copa OWNER TO sp_postgres;

--
-- TOC entry 601 (class 1259 OID 25894)
-- Name: ztsapfi_customer_master; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_customer_master (
    customer_no character varying(10) NOT NULL,
    country character varying(3),
    customer_name character varying(220),
    name_2 character varying(60),
    name_3 character varying(60),
    name_4 character varying(60),
    searchterm character varying(12),
    telephone_1 character varying(16),
    fax_number character varying(31),
    cust_group character varying(4),
    city character varying(35),
    postalcode character varying(10),
    region character varying(3),
    street character varying(35),
    street_2 character varying(35),
    street_3 character varying(35),
    street_4 character varying(35),
    street_5 character varying(35),
    building character varying(20),
    company_code character varying(4) NOT NULL,
    pay_t character varying(4),
    recon_acct character varying(10),
    hd_office character varying(10),
    change_on date,
    zone character varying(10),
    number_of_terminals character varying(10),
    square_feet_area character varying(10)
);


ALTER TABLE public.ztsapfi_customer_master OWNER TO sp_postgres;

--
-- TOC entry 602 (class 1259 OID 25906)
-- Name: ztsapfi_doc_header_text; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_doc_header_text (
    document_number character varying(10) NOT NULL,
    company_code character varying(4) NOT NULL,
    fiscal_year integer NOT NULL,
    document_header_text character varying(25)
);


ALTER TABLE public.ztsapfi_doc_header_text OWNER TO sp_postgres;

--
-- TOC entry 603 (class 1259 OID 25909)
-- Name: ztsapfi_enddate_filter; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_enddate_filter (
    interface_name character varying(20) NOT NULL,
    interface_type character varying(10) NOT NULL,
    enddate date
);


ALTER TABLE public.ztsapfi_enddate_filter OWNER TO sp_postgres;

--
-- TOC entry 604 (class 1259 OID 25912)
-- Name: ztsapfi_gamsd; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gamsd (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    gamecode integer NOT NULL,
    drawno integer NOT NULL,
    retailerid integer NOT NULL,
    sharetype integer,
    scoreid character varying(18),
    salesamt bigint,
    salescomm bigint,
    salestotal bigint,
    salescommtotal bigint,
    iscancelled character varying(1),
    transamt bigint
);


ALTER TABLE public.ztsapfi_gamsd OWNER TO sp_postgres;

--
-- TOC entry 892 (class 1259 OID 1442389)
-- Name: ztsapfi_gamsd_bk20240604; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gamsd_bk20240604 (
    companycode character varying(4),
    transdate date,
    gamecode integer,
    drawno integer,
    retailerid integer,
    sharetype integer,
    scoreid character varying(18),
    salesamt bigint,
    salescomm bigint,
    salestotal bigint,
    salescommtotal bigint
);


ALTER TABLE public.ztsapfi_gamsd_bk20240604 OWNER TO sp_postgres;

--
-- TOC entry 605 (class 1259 OID 25915)
-- Name: ztsapfi_gamsd_db; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gamsd_db (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    gamecode integer NOT NULL,
    drawno integer NOT NULL,
    retailerid integer NOT NULL,
    sharetype integer,
    scoreid character varying(18),
    salesamt bigint,
    salescomm bigint,
    salestotal bigint,
    salescommtotal bigint,
    iscancelled character varying(1),
    transamt bigint
);


ALTER TABLE public.ztsapfi_gamsd_db OWNER TO sp_postgres;

--
-- TOC entry 893 (class 1259 OID 1442392)
-- Name: ztsapfi_gamsd_db_bk20240604; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gamsd_db_bk20240604 (
    companycode character varying(4),
    transdate date,
    gamecode integer,
    drawno integer,
    retailerid integer,
    sharetype integer,
    scoreid character varying(18),
    salesamt bigint,
    salescomm bigint,
    salestotal bigint,
    salescommtotal bigint
);


ALTER TABLE public.ztsapfi_gamsd_db_bk20240604 OWNER TO sp_postgres;

--
-- TOC entry 885 (class 1259 OID 1337238)
-- Name: ztsapfi_gamsd_db_lsr_hds2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gamsd_db_lsr_hds2 (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    gamecode integer NOT NULL,
    drawno integer NOT NULL,
    retailerid integer NOT NULL,
    sharetype integer,
    scoreid character varying(18),
    salesamt bigint,
    transamt bigint,
    salescomm bigint,
    salestotal bigint,
    salescommtotal bigint,
    iscancelled character varying(1)
);


ALTER TABLE public.ztsapfi_gamsd_db_lsr_hds2 OWNER TO sp_postgres;

--
-- TOC entry 883 (class 1259 OID 1337158)
-- Name: ztsapfi_gamsd_lsr_hds2; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gamsd_lsr_hds2 (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    gamecode integer NOT NULL,
    drawno integer NOT NULL,
    retailerid integer NOT NULL,
    sharetype integer,
    scoreid character varying(18),
    salesamt bigint,
    transamt bigint,
    salescomm bigint,
    salestotal bigint,
    salescommtotal bigint,
    iscancelled character varying(1),
    channeltype integer,
    channelsubtype integer
);


ALTER TABLE public.ztsapfi_gamsd_lsr_hds2 OWNER TO sp_postgres;

--
-- TOC entry 606 (class 1259 OID 25918)
-- Name: ztsapfi_gdyup; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gdyup (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    retailerid integer NOT NULL,
    gamecode integer NOT NULL,
    transmode integer NOT NULL,
    transcode character varying(1) NOT NULL,
    scoreid character varying(18) NOT NULL,
    drawnum integer NOT NULL,
    retailtype integer,
    sign character varying(1),
    transamt bigint
);


ALTER TABLE public.ztsapfi_gdyup OWNER TO sp_postgres;

--
-- TOC entry 915 (class 1259 OID 1573542)
-- Name: ztsapfi_gdyup_bk20240628; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gdyup_bk20240628 (
    companycode character varying(4),
    transdate date,
    retailerid integer,
    gamecode integer,
    transmode integer,
    transcode character varying(1),
    scoreid character varying(18),
    drawnum integer,
    retailtype integer,
    sign character varying(1),
    transamt bigint
);


ALTER TABLE public.ztsapfi_gdyup_bk20240628 OWNER TO sp_postgres;

--
-- TOC entry 607 (class 1259 OID 25921)
-- Name: ztsapfi_gibgf; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gibgf (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    retailerid integer NOT NULL,
    drawnum integer NOT NULL,
    sign character varying(1) NOT NULL,
    retailtype integer,
    bankcode integer,
    valuedate date,
    periodstart date,
    periodend date,
    transamt bigint
);


ALTER TABLE public.ztsapfi_gibgf OWNER TO sp_postgres;

--
-- TOC entry 608 (class 1259 OID 25924)
-- Name: ztsapfi_gl; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gl (
    company_code character varying(4) NOT NULL,
    fiscal_year integer NOT NULL,
    document_number character varying(10) NOT NULL,
    item_number integer NOT NULL,
    assignment_number character varying(18),
    chart_of_accounts character varying(4),
    controlling_area character varying(4),
    cost_center character varying(10),
    cost_element character varying(10),
    document_header_text character varying(25),
    document_type character varying(2),
    gl_account character varying(10),
    posting_date date,
    posting_key character varying(2),
    product_id character varying(3),
    profit_center character varying(10),
    reference_key character varying(20),
    business_area character varying(4),
    functional_area character varying(16),
    fiscal_year_period integer,
    fiscal_year_variant character varying(2),
    local_currency character varying(5),
    debit_credit_amount numeric(13,2),
    item_text character varying(50),
    document_reference_id character varying(16),
    source_ledger character varying(2) NOT NULL,
    ledger character varying(2) NOT NULL,
    document_date date,
    debit_credit_code character varying(1),
    wbs_element character varying(24),
    sold_product character varying(40),
    sold_product_group character varying(9),
    customer_no character varying(10),
    draw_day character varying(10),
    draw_number character varying(10),
    bet_mode character varying(10),
    bet_type character varying(30),
    product_hierachy character varying(10),
    entered_on date,
    amount_in_company_code_curr numeric(13,2),
    company_code_curr character varying(5),
    manual_change_date date,
    amount_in_transaction_curr numeric(13,2),
    transaction_curr character varying(5)
);


ALTER TABLE public.ztsapfi_gl OWNER TO sp_postgres;

--
-- TOC entry 609 (class 1259 OID 25930)
-- Name: ztsapfi_gl_stg_prod; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gl_stg_prod (
    company_code character varying(4),
    fiscal_year integer,
    document_number character varying(10),
    item_number integer,
    assignment_number character varying(18),
    chart_of_accounts character varying(4),
    controlling_area character varying(4),
    cost_center character varying(10),
    cost_element character varying(10),
    document_header_text character varying(25),
    document_type character varying(2),
    gl_account character varying(10),
    posting_date character varying(20),
    posting_key character varying(2),
    product_id character varying(3),
    profit_center character varying(10),
    reference_key character varying(20),
    business_area character varying(4),
    functional_area character varying(16),
    fiscal_year_period integer,
    fiscal_year_variant character varying(2),
    local_currency character varying(5),
    debit_credit_amount numeric,
    item_text character varying(50),
    document_reference_id character varying(16),
    source_ledger character varying(2),
    ledger character varying(2),
    document_date character varying(20),
    debit_credit_code character varying(1),
    wbs_element character varying(24),
    sold_product character varying(40),
    sold_product_group character varying(9),
    customer_no character varying(10),
    draw_day character varying(10),
    draw_number character varying(10),
    bet_mode character varying(10),
    bet_type character varying(30),
    product_hierachy character varying(10),
    entered_on character varying(20),
    amount_in_company_code_curr numeric,
    company_code_curr character varying(5),
    manual_change_date character varying(20),
    amount_in_transaction_curr numeric,
    transaction_curr character varying(5)
);


ALTER TABLE public.ztsapfi_gl_stg_prod OWNER TO sp_postgres;

--
-- TOC entry 610 (class 1259 OID 25936)
-- Name: ztsapfi_glhierarchy; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_glhierarchy (
    gl_account_hierarchy character varying(42) NOT NULL,
    validity_end_date date,
    parentnode character varying(50),
    gl_level1 character varying(50),
    hierarchynode_level1 character varying(50),
    sequence_number_level1 character varying(50),
    gl_level2 character varying(50),
    hierarchynode_level2 character varying(50),
    sequence_number_level2 character varying(50),
    gl_level3 character varying(50),
    hierarchynode_level3 character varying(50),
    sequence_number_level3 character varying(50),
    gl_level4 character varying(50),
    hierarchynode_level4 character varying(50),
    sequence_number_level4 character varying(50),
    gl_level5 character varying(50),
    hierarchynode_level5 character varying(50),
    sequence_number_level5 character varying(50),
    gl_level6 character varying(50),
    hierarchynode_level6 character varying(50),
    sequence_number_level6 character varying(50),
    gl_range1 character varying(10) NOT NULL,
    gl_range2 character varying(10) NOT NULL,
    sequence_number_gl character varying(50),
    text character varying(40) NOT NULL
);


ALTER TABLE public.ztsapfi_glhierarchy OWNER TO sp_postgres;

--
-- TOC entry 611 (class 1259 OID 25942)
-- Name: ztsapfi_glhierarchy_20210715; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_glhierarchy_20210715 (
    gl_account_hierarchy character varying(42),
    validity_end_date date,
    parentnode character varying(50),
    gl_level1 character varying(50),
    hierarchynode_level1 character varying(50),
    sequence_number_level1 character varying(50),
    gl_level2 character varying(50),
    hierarchynode_level2 character varying(50),
    sequence_number_level2 character varying(50),
    gl_level3 character varying(50),
    hierarchynode_level3 character varying(50),
    sequence_number_level3 character varying(50),
    gl_level4 character varying(50),
    hierarchynode_level4 character varying(50),
    sequence_number_level4 character varying(50),
    gl_level5 character varying(50),
    hierarchynode_level5 character varying(50),
    sequence_number_level5 character varying(50),
    gl_level6 character varying(50),
    hierarchynode_level6 character varying(50),
    sequence_number_level6 character varying(50),
    gl_range1 character varying(10),
    gl_range2 character varying(10),
    sequence_number_gl character varying(50),
    text character varying(40)
);


ALTER TABLE public.ztsapfi_glhierarchy_20210715 OWNER TO sp_postgres;

--
-- TOC entry 612 (class 1259 OID 25948)
-- Name: ztsapfi_glhierarchy_staging; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_glhierarchy_staging (
    glaccounthierarchy character varying(50),
    hierarchynode character varying(50),
    validityenddate character varying(50),
    parentnode character varying(50),
    hierarchyversion character varying(50),
    validitystartdate character varying(50),
    chartofaccounts character varying(50),
    glaccount character varying(50),
    sequencenumber character varying(50),
    hierarchynodelevel character varying(50),
    nodetype character varying(50),
    semantictag character varying(50),
    sacaccounttype character varying(50),
    hierarchynodetext character varying(50)
);


ALTER TABLE public.ztsapfi_glhierarchy_staging OWNER TO sp_postgres;

--
-- TOC entry 613 (class 1259 OID 25954)
-- Name: ztsapfi_glmaster; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_glmaster (
    gl_account character varying(10) NOT NULL,
    gl_text character varying(50),
    company_code character varying(4) NOT NULL,
    last_update_date date,
    corporate_group_account character varying(10),
    gl_account_type character varying(1),
    gl_account_type_description character varying(1)
);


ALTER TABLE public.ztsapfi_glmaster OWNER TO sp_postgres;

--
-- TOC entry 614 (class 1259 OID 25957)
-- Name: ztsapfi_glmaster_20210715; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_glmaster_20210715 (
    gl_account character varying(10),
    gl_text character varying(50),
    company_code character varying(4),
    last_update_date date,
    corporate_group_account character varying(10),
    gl_account_type character varying(1),
    gl_account_type_description character varying(1)
);


ALTER TABLE public.ztsapfi_glmaster_20210715 OWNER TO sp_postgres;

--
-- TOC entry 615 (class 1259 OID 25963)
-- Name: ztsapfi_grfun; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_grfun (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    retailtype integer NOT NULL,
    bankcode integer NOT NULL,
    drawnum integer NOT NULL,
    sign character varying(1),
    transamt bigint
);


ALTER TABLE public.ztsapfi_grfun OWNER TO sp_postgres;

--
-- TOC entry 616 (class 1259 OID 25966)
-- Name: ztsapfi_gunwn; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gunwn (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    gamecode integer NOT NULL,
    sharetype integer,
    unclaimtype integer NOT NULL,
    drawnumber integer,
    scoreid character varying(18),
    expiredamt bigint,
    purgedate date
);


ALTER TABLE public.ztsapfi_gunwn OWNER TO sp_postgres;

--
-- TOC entry 617 (class 1259 OID 25969)
-- Name: ztsapfi_guswn; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_guswn (
    companycode character varying(4) NOT NULL,
    transdate date NOT NULL,
    gamecode integer NOT NULL,
    drawnum integer NOT NULL,
    retailerid integer NOT NULL,
    sign character varying(1),
    amount integer
);


ALTER TABLE public.ztsapfi_guswn OWNER TO sp_postgres;

--
-- TOC entry 618 (class 1259 OID 25972)
-- Name: ztsapfi_gwapp; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_gwapp (
    companycode character varying(4) NOT NULL,
    drawdate date NOT NULL,
    gamecode integer NOT NULL,
    sharetype integer,
    drawnumber integer,
    scoreid character varying(18),
    prizepool bigint,
    prizewin bigint,
    poolforward bigint,
    otherprizepool bigint
);


ALTER TABLE public.ztsapfi_gwapp OWNER TO sp_postgres;

--
-- TOC entry 619 (class 1259 OID 25975)
-- Name: ztsapfi_parameter; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_parameter (
    field_key character varying(50) NOT NULL,
    field_value character varying(200)
);


ALTER TABLE public.ztsapfi_parameter OWNER TO sp_postgres;

--
-- TOC entry 620 (class 1259 OID 25978)
-- Name: ztsapfi_pchierarchy; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_pchierarchy (
    controlling_area character varying(4) NOT NULL,
    profit_center_hierarchy character varying(42) NOT NULL,
    validity_end_date date,
    pc_level1 character varying(40),
    pc_level2 character varying(40),
    pc_level3 character varying(40),
    pc_level4 character varying(40),
    pc_level5 character varying(40),
    pc_level6 character varying(40),
    pc_level7 character varying(40),
    profit_center_range1 character varying(10) NOT NULL,
    profit_center_range2 character varying(10) NOT NULL,
    text character varying(40),
    change_on date
);


ALTER TABLE public.ztsapfi_pchierarchy OWNER TO sp_postgres;

--
-- TOC entry 621 (class 1259 OID 25981)
-- Name: ztsapfi_pcmaster; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_pcmaster (
    profit_center character varying(10) NOT NULL,
    profit_center_text character varying(40),
    profit_center_long_name character varying(50),
    lock_indicator character varying(1),
    hierarchy_area character varying(12),
    controlling_area character varying(4) NOT NULL,
    valid_from date,
    valid_to date NOT NULL,
    company_code character varying(4) NOT NULL,
    department character varying(12),
    segment character varying(10),
    segment_name character varying(50),
    search_term character varying(2),
    wagering_division1_prc character varying(40),
    wagering_dept1_prc character varying(40)
);


ALTER TABLE public.ztsapfi_pcmaster OWNER TO sp_postgres;

--
-- TOC entry 622 (class 1259 OID 25987)
-- Name: ztsapfi_pcmaster_org; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsapfi_pcmaster_org (
    profit_center character varying(10),
    profit_center_text character varying(40),
    profit_center_long_name character varying(50),
    lock_indicator character varying(1),
    hierarchy_area character varying(12),
    controlling_area character varying(4),
    valid_from date,
    valid_to date,
    company_code character varying(4),
    department character varying(12),
    segment character varying(10),
    segment_name character varying(50),
    search_term character varying(2),
    wagering_division1_prc character varying(40),
    wagering_dept1_prc character varying(40)
);


ALTER TABLE public.ztsapfi_pcmaster_org OWNER TO sp_postgres;

--
-- TOC entry 623 (class 1259 OID 25990)
-- Name: ztsf_empdata; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsf_empdata (
    employee_id character varying(8) NOT NULL,
    period date,
    employee_name character varying(80),
    employee_group character varying(1),
    employee_group_description character varying(40),
    cost_center_code character varying(10),
    cost_center_name character varying(40),
    number_of_working_hours double precision,
    joining_date date,
    last_day_of_service date,
    employment_status character varying(1),
    employment_status_description character varying(40),
    username character varying(40),
    payroll_area character varying(2)
);


ALTER TABLE public.ztsf_empdata OWNER TO sp_postgres;

--
-- TOC entry 624 (class 1259 OID 25993)
-- Name: ztsvcs_case; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsvcs_case (
    casenumber character varying(100) NOT NULL,
    casemodeofcontact character varying(20),
    caseowner character varying(200),
    casecategorylevel1 character varying(100),
    casecategorylevel2 character varying(100),
    casecategorylevel3 character varying(100),
    caseissueowner character varying(200),
    caseexgratiapayment character varying(1),
    caseexgratiapaymentamount numeric(15,2),
    casemanualadjustment character varying(1),
    casemanualadjustmentamount numeric(15,2),
    casebetcancellation character varying(1),
    casebetcancellationamount numeric(15,2),
    casevouchers character varying(1),
    casevouchersamount numeric(15,2),
    caseexceptionhandling character varying(1),
    casecreatedon timestamp without time zone,
    casefirsttimeresolvedin timestamp without time zone,
    statusreason character varying(1000),
    casemodifiedon timestamp without time zone,
    casesucceededon timestamp without time zone,
    resolvebykpistatus character varying(25),
    customerid character varying(100),
    customerstatus character varying(25),
    accountnumber character varying(100),
    accounttype character varying(20),
    accountstatus character varying(10),
    primarycaseofficer character varying(200),
    caseadhoccriteria character varying(100),
    casecreatedby character varying(200),
    customersupportcasechecker character varying(200),
    customersupportcasemaker character varying(200),
    customersupportcasecheckerprocessedon timestamp without time zone,
    customersupportcasemakerprocessedon timestamp without time zone,
    customersupportprocessingstatus character varying(25),
    casecallextensionid character varying(100),
    casefollowuprequired character varying(10),
    casesystemauthenticated character varying(10)
);


ALTER TABLE public.ztsvcs_case OWNER TO sp_postgres;

--
-- TOC entry 625 (class 1259 OID 25999)
-- Name: ztsvcs_edmsubscription; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsvcs_edmsubscription (
    subscriptionlistid character varying(36) NOT NULL,
    customerid character varying(100) NOT NULL,
    subscriptionname character varying(128),
    subscriptionsource character varying(128),
    spacustomer integer,
    accountnumber character varying(100)
);


ALTER TABLE public.ztsvcs_edmsubscription OWNER TO sp_postgres;

--
-- TOC entry 626 (class 1259 OID 26002)
-- Name: ztsvcs_review; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsvcs_review (
    casereviewactivityid character varying(36) NOT NULL,
    casenumber character varying(100),
    casereviewactivitystaff character varying(100),
    casereviewactivityoutcome character varying(4000),
    casereviewactivityactiontakentype character varying(4000),
    casereviewactivitycreatedon timestamp without time zone,
    casereviewactivitymodifiedon timestamp without time zone,
    casereviewactivitystatus character varying(4000),
    casereviewactivitytype character varying(4000),
    outletnumber character varying(20),
    outletname character varying(160),
    outlettype character varying(100),
    outletzone character varying(100),
    outletstatus character varying(4000),
    stafftype character varying(4000),
    staffoutlet character varying(160),
    staffstatus character varying(4000),
    caseissueowner character varying(100)
);


ALTER TABLE public.ztsvcs_review OWNER TO sp_postgres;

--
-- TOC entry 627 (class 1259 OID 26008)
-- Name: ztsvcs_rootcause; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsvcs_rootcause (
    caserootcauseid character varying(36) NOT NULL,
    casenumber character varying(100) NOT NULL,
    caserootcausetype character varying(4000),
    caserootcause character varying(100),
    casecreatedon timestamp without time zone,
    casemodifiedon timestamp without time zone
);


ALTER TABLE public.ztsvcs_rootcause OWNER TO sp_postgres;

--
-- TOC entry 628 (class 1259 OID 26014)
-- Name: ztsvcs_sms; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztsvcs_sms (
    smsid character varying(36) NOT NULL,
    smssubject character varying(200),
    smscreatedby character varying(200),
    smscreatedon timestamp without time zone,
    smscustomerid character varying(100),
    smsstatus character varying(4000),
    spacustomer integer,
    smsendedon timestamp without time zone,
    accountnumber character varying(100),
    smsmodifiedon timestamp without time zone
);


ALTER TABLE public.ztsvcs_sms OWNER TO sp_postgres;

--
-- TOC entry 629 (class 1259 OID 26020)
-- Name: ztubt_4d_placedbettransactionlineitem; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_4d_placedbettransactionlineitem (
    tranheaderid character varying(50) NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sourcesystemtransactionid character varying(50) NOT NULL,
    permutation integer,
    bettypeid character varying(10) NOT NULL,
    betlineannotation character varying(500),
    quickpickindicator boolean NOT NULL,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_4d_placedbettransactionlineitem OWNER TO consultant01;

--
-- TOC entry 922 (class 1259 OID 1789945)
-- Name: ztubt_4d_placedbettransactionlineitem_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_4d_placedbettransactionlineitem_bk_before_bmcs (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    permutation integer,
    bettypeid character varying(10),
    betlineannotation character varying(500),
    quickpickindicator boolean,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_4d_placedbettransactionlineitem_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 988 (class 1259 OID 2036677)
-- Name: ztubt_4d_placedbettransactionlineitem_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_4d_placedbettransactionlineitem_bk_before_tfog (
    tranheaderid character varying(50) NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sourcesystemtransactionid character varying(50) NOT NULL,
    permutation integer,
    bettypeid character varying(10) NOT NULL,
    betlineannotation character varying(500),
    quickpickindicator boolean NOT NULL,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_4d_placedbettransactionlineitem_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1000 (class 1259 OID 2132307)
-- Name: ztubt_4d_placedbettransactionlineitem_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_4d_placedbettransactionlineitem_bk_tfog_sit (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    permutation integer,
    bettypeid character varying(10),
    betlineannotation character varying(500),
    quickpickindicator boolean,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_4d_placedbettransactionlineitem_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 630 (class 1259 OID 26026)
-- Name: ztubt_4d_placedbettransactionlineitemnumber; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_4d_placedbettransactionlineitemnumber (
    lineitemnumberid bigint NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sequence integer NOT NULL,
    selectedbetnumber character varying(5) NOT NULL,
    bigbetinitialwager numeric(16,2) NOT NULL,
    smallbetinitialwager numeric(16,2) NOT NULL,
    bigbetacceptedwager numeric(16,2),
    smallbetacceptedwager numeric(16,2),
    salesfactorsmall numeric(16,9),
    salesfactoramountsmall numeric(16,9),
    salescommsmall numeric(16,9),
    salescommamountsmall numeric(16,9),
    salesfactorbig numeric(16,9),
    salesfactoramountbig numeric(16,9),
    salescommbig numeric(16,9),
    salescommamountbig numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    tranheaderid character varying(50),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_4d_placedbettransactionlineitemnumber OWNER TO sp_postgres;

--
-- TOC entry 1015 (class 1259 OID 2155629)
-- Name: ztubt_4d_placedbettransactionlineitemnumber_bk20241120; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_4d_placedbettransactionlineitemnumber_bk20241120 (
    lineitemnumberid bigint,
    tranlineitemid character varying(50),
    sequence integer,
    selectedbetnumber character varying(5),
    bigbetinitialwager numeric(16,2),
    smallbetinitialwager numeric(16,2),
    bigbetacceptedwager numeric(16,2),
    smallbetacceptedwager numeric(16,2),
    salesfactorsmall numeric(16,9),
    salesfactoramountsmall numeric(16,9),
    salescommsmall numeric(16,9),
    salescommamountsmall numeric(16,9),
    salesfactorbig numeric(16,9),
    salesfactoramountbig numeric(16,9),
    salescommbig numeric(16,9),
    salescommamountbig numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    tranheaderid character varying(50),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_4d_placedbettransactionlineitemnumber_bk20241120 OWNER TO sp_postgres;

--
-- TOC entry 631 (class 1259 OID 26032)
-- Name: ztubt_adhoctimeconfig; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_adhoctimeconfig (
    adhoctimeconfigid integer NOT NULL,
    host integer NOT NULL,
    defaulttime character varying(8) NOT NULL,
    adhoctime character varying(8),
    sentstatus character varying(1) NOT NULL,
    receivedstatus character varying(1) NOT NULL,
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_adhoctimeconfig OWNER TO consultant01;

--
-- TOC entry 828 (class 1259 OID 334371)
-- Name: ztubt_adhoctimeconfig_test; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_adhoctimeconfig_test (
    adhoctimeconfigid integer,
    host integer,
    defaulttime character varying(8),
    adhoctime character varying(8),
    sentstatus character varying(1),
    receivedstatus character varying(1),
    createdbyid integer,
    createddatetime timestamp without time zone,
    updatedbyid integer,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_adhoctimeconfig_test OWNER TO postgres;

--
-- TOC entry 632 (class 1259 OID 26035)
-- Name: ztubt_adhoctimehistory; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_adhoctimehistory (
    adhoctimehistoryid bigint NOT NULL,
    host integer NOT NULL,
    perioddatetime timestamp without time zone NOT NULL,
    actualdate date NOT NULL,
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_adhoctimehistory OWNER TO sp_postgres;

--
-- TOC entry 1009 (class 1259 OID 2132346)
-- Name: ztubt_adhoctimehistory_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_adhoctimehistory_bk_tfog_sit (
    adhoctimehistoryid bigint,
    host integer,
    perioddatetime timestamp without time zone,
    actualdate date,
    createdbyid integer,
    createddatetime timestamp without time zone,
    updatedbyid integer,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_adhoctimehistory_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 633 (class 1259 OID 26038)
-- Name: ztubt_adjustinvoice; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_adjustinvoice (
    adjustinvoiceid bigint NOT NULL,
    locid integer NOT NULL,
    adjustmentcode integer NOT NULL,
    adjustmenttype integer NOT NULL,
    adjustmentby integer NOT NULL,
    adjustmentamount numeric NOT NULL,
    approvalstatus integer,
    approvedby integer,
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_adjustinvoice OWNER TO consultant01;

--
-- TOC entry 634 (class 1259 OID 26044)
-- Name: ztubt_admissionvouchertransaction; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_admissionvouchertransaction (
    vouchertransactionid character varying(50) NOT NULL,
    headerid character varying(50) NOT NULL,
    serialnumber character varying(200) NOT NULL,
    amount numeric(16,9) NOT NULL,
    isactive boolean NOT NULL,
    transactiontype integer NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_admissionvouchertransaction OWNER TO consultant01;

--
-- TOC entry 635 (class 1259 OID 26050)
-- Name: ztubt_cancelledbetticket; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_cancelledbetticket (
    tranheaderid character varying(50) NOT NULL,
    requestid character varying(33) NOT NULL,
    ticketserialnumber character varying(200) NOT NULL,
    cancelleddate timestamp without time zone NOT NULL,
    cartid character varying(50) NOT NULL,
    cancelledamout numeric(16,2),
    isremote boolean,
    supervisorid character varying(50),
    isspecialcancelled boolean NOT NULL,
    createdcancellationdate timestamp without time zone,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    prodid integer,
    firstentrymethodid character varying(10),
    uniqueid character varying(234)
);


ALTER TABLE public.ztubt_cancelledbetticket OWNER TO consultant01;

--
-- TOC entry 636 (class 1259 OID 26056)
-- Name: ztubt_cancelledbetticketlifecyclestate; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_cancelledbetticketlifecyclestate (
    cancelledbetlifecycleid character varying(50) NOT NULL,
    tranheaderid character varying(50) NOT NULL,
    betstatetypeid character varying(5) NOT NULL,
    status character varying(50) NOT NULL,
    captureddate timestamp without time zone NOT NULL,
    uuid character varying(33),
    referenceuuid character varying(33),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_cancelledbetticketlifecyclestate OWNER TO consultant01;

--
-- TOC entry 637 (class 1259 OID 26059)
-- Name: ztubt_cart; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_cart (
    cartid character varying(50) NOT NULL,
    sessionid character varying(50) NOT NULL,
    userdisplayid character varying(50),
    terdisplayid character varying(50) NOT NULL,
    cartcreateddate timestamp without time zone NOT NULL,
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_cart OWNER TO consultant01;

--
-- TOC entry 933 (class 1259 OID 1839566)
-- Name: ztubt_cashbox; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_cashbox (
    cashboxtranid numeric(19,0) NOT NULL,
    sessionid character varying(38) NOT NULL,
    userdisplayid character varying(100) NOT NULL,
    terdisplayid character varying(100) NOT NULL,
    cashtransactiontypeid numeric(10,0) NOT NULL,
    tenderedamout numeric(16,2),
    returnedamount numeric(16,2),
    amount numeric(18,0) NOT NULL,
    comments character varying(1000),
    createddatetime timestamp without time zone NOT NULL,
    cartid character varying(38)
);


ALTER TABLE public.ztubt_cashbox OWNER TO sp_postgres;

--
-- TOC entry 638 (class 1259 OID 26062)
-- Name: ztubt_chain; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_chain (
    chid integer NOT NULL,
    chdisplayid character varying(100) NOT NULL,
    chname character varying(100) NOT NULL,
    scid integer NOT NULL,
    chbusinessregistrationno character varying(100),
    chmanagername character varying(100),
    chcontactno character varying(100),
    chemailaddress character varying(100),
    createdby character varying(100) NOT NULL,
    createddate timestamp without time zone NOT NULL,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean NOT NULL
);


ALTER TABLE public.ztubt_chain OWNER TO consultant01;

--
-- TOC entry 639 (class 1259 OID 26068)
-- Name: ztubt_charitytickettransaction; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_charitytickettransaction (
    charitytransactionid character varying NOT NULL,
    headerid character varying NOT NULL,
    totalamount numeric(16,9) NOT NULL,
    repeatedticket integer NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying,
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_charitytickettransaction OWNER TO consultant01;

--
-- TOC entry 640 (class 1259 OID 26074)
-- Name: ztubt_drawdates; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_drawdates (
    drawdatesid integer NOT NULL,
    tranheaderid character varying(50) NOT NULL,
    drawdate date NOT NULL,
    hostdrawdatesid bigint NOT NULL,
    viewcreateddate timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_drawdates OWNER TO consultant01;

--
-- TOC entry 930 (class 1259 OID 1806043)
-- Name: ztubt_drawdates_bb; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_bb (
    drawdatesid bigint NOT NULL,
    tranheaderid character varying(50),
    drawdate date,
    hostdrawdatesid bigint,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_bb OWNER TO sp_postgres;

--
-- TOC entry 874 (class 1259 OID 1229302)
-- Name: ztubt_drawdates_beforepatching; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_drawdates_beforepatching (
    drawdatesid integer,
    tranheaderid character varying(50),
    drawdate date,
    hostdrawdatesid bigint,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_beforepatching OWNER TO postgres;

--
-- TOC entry 853 (class 1259 OID 652531)
-- Name: ztubt_drawdates_beforepatching_230928; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_drawdates_beforepatching_230928 (
    drawdatesid integer,
    tranheaderid character varying(50),
    drawdate date,
    hostdrawdatesid bigint,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_beforepatching_230928 OWNER TO postgres;

--
-- TOC entry 855 (class 1259 OID 653749)
-- Name: ztubt_drawdates_beforepatching_230929; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_drawdates_beforepatching_230929 (
    drawdatesid integer,
    tranheaderid character varying(50),
    drawdate date,
    hostdrawdatesid bigint,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_beforepatching_230929 OWNER TO postgres;

--
-- TOC entry 876 (class 1259 OID 1236327)
-- Name: ztubt_drawdates_beforepatching_240401; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_beforepatching_240401 (
    drawdatesid integer,
    tranheaderid character varying(50),
    drawdate date,
    hostdrawdatesid bigint,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_beforepatching_240401 OWNER TO sp_postgres;

--
-- TOC entry 976 (class 1259 OID 1893923)
-- Name: ztubt_drawdates_beforepatching_240904; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_drawdates_beforepatching_240904 (
    drawdatesid integer,
    tranheaderid character varying(50),
    drawdate date,
    hostdrawdatesid bigint,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_beforepatching_240904 OWNER TO postgres;

--
-- TOC entry 928 (class 1259 OID 1789978)
-- Name: ztubt_drawdates_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_bk_before_bmcs (
    drawdatesid integer,
    tranheaderid character varying(50),
    drawdate date,
    hostdrawdatesid bigint,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 994 (class 1259 OID 2044902)
-- Name: ztubt_drawdates_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_bk_before_tfog (
    drawdatesid integer NOT NULL,
    tranheaderid character varying(50) NOT NULL,
    drawdate date NOT NULL,
    hostdrawdatesid bigint NOT NULL,
    viewcreateddate timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_drawdates_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1001 (class 1259 OID 2132313)
-- Name: ztubt_drawdates_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_bk_tfog_sit (
    drawdatesid integer,
    tranheaderid character varying(50),
    drawdate date,
    hostdrawdatesid bigint,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 641 (class 1259 OID 26077)
-- Name: ztubt_drawdates_master; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_drawdates_master (
    drawdatesmasterid integer NOT NULL,
    hostdrawdatesid integer NOT NULL,
    prodid integer NOT NULL,
    drawstartdate date NOT NULL,
    drawenddate date NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_drawdates_master OWNER TO consultant01;

--
-- TOC entry 873 (class 1259 OID 1229299)
-- Name: ztubt_drawdates_master_beforepatching; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_drawdates_master_beforepatching (
    drawdatesmasterid integer,
    hostdrawdatesid integer,
    prodid integer,
    drawstartdate date,
    drawenddate date,
    createddatetime timestamp without time zone,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_master_beforepatching OWNER TO postgres;

--
-- TOC entry 852 (class 1259 OID 652528)
-- Name: ztubt_drawdates_master_beforepatching_230928; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_drawdates_master_beforepatching_230928 (
    drawdatesmasterid integer,
    hostdrawdatesid integer,
    prodid integer,
    drawstartdate date,
    drawenddate date,
    createddatetime timestamp without time zone,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_master_beforepatching_230928 OWNER TO postgres;

--
-- TOC entry 854 (class 1259 OID 653746)
-- Name: ztubt_drawdates_master_beforepatching_230929; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_drawdates_master_beforepatching_230929 (
    drawdatesmasterid integer,
    hostdrawdatesid integer,
    prodid integer,
    drawstartdate date,
    drawenddate date,
    createddatetime timestamp without time zone,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_master_beforepatching_230929 OWNER TO postgres;

--
-- TOC entry 875 (class 1259 OID 1236324)
-- Name: ztubt_drawdates_master_beforepatching_240401; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_master_beforepatching_240401 (
    drawdatesmasterid integer,
    hostdrawdatesid integer,
    prodid integer,
    drawstartdate date,
    drawenddate date,
    createddatetime timestamp without time zone,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_master_beforepatching_240401 OWNER TO sp_postgres;

--
-- TOC entry 975 (class 1259 OID 1893920)
-- Name: ztubt_drawdates_master_beforepatching_240904; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_drawdates_master_beforepatching_240904 (
    drawdatesmasterid integer,
    hostdrawdatesid integer,
    prodid integer,
    drawstartdate date,
    drawenddate date,
    createddatetime timestamp without time zone,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_master_beforepatching_240904 OWNER TO postgres;

--
-- TOC entry 927 (class 1259 OID 1789975)
-- Name: ztubt_drawdates_master_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_master_bk_before_bmcs (
    drawdatesmasterid integer,
    hostdrawdatesid integer,
    prodid integer,
    drawstartdate date,
    drawenddate date,
    createddatetime timestamp without time zone,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_master_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 995 (class 1259 OID 2044909)
-- Name: ztubt_drawdates_master_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_master_bk_before_tfog (
    drawdatesmasterid integer NOT NULL,
    hostdrawdatesid integer NOT NULL,
    prodid integer NOT NULL,
    drawstartdate date NOT NULL,
    drawenddate date NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_drawdates_master_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1002 (class 1259 OID 2132316)
-- Name: ztubt_drawdates_master_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_master_bk_tfog_sit (
    drawdatesmasterid integer,
    hostdrawdatesid integer,
    prodid integer,
    drawstartdate date,
    drawenddate date,
    createddatetime timestamp without time zone,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_drawdates_master_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 929 (class 1259 OID 1806037)
-- Name: ztubt_drawdates_new; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_drawdates_new (
    drawdatesid bigint NOT NULL,
    tranheaderid character varying(50) NOT NULL,
    drawdate date NOT NULL,
    hostdrawdatesid bigint NOT NULL,
    viewcreateddate timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_drawdates_new OWNER TO sp_postgres;

--
-- TOC entry 642 (class 1259 OID 26080)
-- Name: ztubt_entrymethod; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_entrymethod (
    entrymethodid character varying(4) NOT NULL,
    entrymethodname character varying(25)
);


ALTER TABLE public.ztubt_entrymethod OWNER TO consultant01;

--
-- TOC entry 643 (class 1259 OID 26083)
-- Name: ztubt_etl_recon; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_etl_recon (
    recondate date,
    table_name character varying(100),
    source_table_name character varying(100),
    kpi_type character varying(50),
    from_datetime timestamp without time zone,
    to_datetime timestamp without time zone,
    dl_value numeric,
    ubt_value numeric,
    etl_type character varying(50)
);


ALTER TABLE public.ztubt_etl_recon OWNER TO consultant01;

--
-- TOC entry 644 (class 1259 OID 26089)
-- Name: ztubt_funding; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_funding (
    fundingid bigint NOT NULL,
    fundingconfigid bigint NOT NULL,
    locid integer NOT NULL,
    fundperiodstart date NOT NULL,
    fundperiodend date NOT NULL,
    fundingamount numeric,
    createdbyid character varying(255) NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid character varying(255) NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_funding OWNER TO consultant01;

--
-- TOC entry 645 (class 1259 OID 26095)
-- Name: ztubt_getbusinessdate_perhost; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_getbusinessdate_perhost (
    host integer NOT NULL,
    previousperioddatetime timestamp without time zone,
    perioddatetime timestamp without time zone,
    actualdate date NOT NULL,
    previousperioddatetimeutc timestamp without time zone,
    perioddatetimeutc timestamp without time zone
);


ALTER TABLE public.ztubt_getbusinessdate_perhost OWNER TO consultant01;

--
-- TOC entry 1013 (class 1259 OID 2153161)
-- Name: ztubt_getbusinessdate_perhost_test; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_getbusinessdate_perhost_test (
    host integer NOT NULL,
    previousperioddatetime timestamp without time zone,
    perioddatetime timestamp without time zone,
    actualdate date NOT NULL,
    previousperioddatetimeutc timestamp without time zone,
    perioddatetimeutc timestamp without time zone
);


ALTER TABLE public.ztubt_getbusinessdate_perhost_test OWNER TO sp_postgres;

--
-- TOC entry 646 (class 1259 OID 26098)
-- Name: ztubt_getcfsumreport; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_getcfsumreport (
    hostdrawdatesid bigint NOT NULL,
    actualdate date NOT NULL,
    wager numeric(22,2),
    secondwager numeric(22,2),
    salesfactoramount numeric(32,12),
    secondsalesfactoramount numeric(32,12),
    salescommamount numeric(32,12)
);


ALTER TABLE public.ztubt_getcfsumreport OWNER TO consultant01;

--
-- TOC entry 647 (class 1259 OID 26101)
-- Name: ztubt_getcfsumreport_summary; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_getcfsumreport_summary (
    hostdrawdatesid bigint,
    flag character varying(15),
    amount numeric(32,12)
);


ALTER TABLE public.ztubt_getcfsumreport_summary OWNER TO consultant01;

--
-- TOC entry 648 (class 1259 OID 26104)
-- Name: ztubt_gstconfig; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_gstconfig (
    gstconfigid bigint NOT NULL,
    gstrate numeric(16,2) NOT NULL,
    effectivefrom date NOT NULL,
    enddate date,
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_gstconfig OWNER TO consultant01;

--
-- TOC entry 649 (class 1259 OID 26107)
-- Name: ztubt_horse_placedbettransactionlineitem; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_horse_placedbettransactionlineitem (
    tranheaderid character varying(50) NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sourcesystemtransactionid character varying(50) NOT NULL,
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10) NOT NULL,
    fixturedate date NOT NULL,
    meeting character varying(50) NOT NULL,
    betlineannotation character varying(500) NOT NULL,
    units integer NOT NULL,
    betpriceamount numeric(32,16),
    boardrebateamount numeric(32,16),
    bmcshostticketid character varying(500),
    betcount integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(32,16),
    salescomm numeric(32,16),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_horse_placedbettransactionlineitem OWNER TO consultant01;

--
-- TOC entry 921 (class 1259 OID 1789939)
-- Name: ztubt_horse_placedbettransactionlineitem_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_horse_placedbettransactionlineitem_bk_before_bmcs (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10),
    fixturedate date,
    meeting character varying(50),
    betlineannotation character varying(500),
    units integer,
    betpriceamount numeric(32,16),
    boardrebateamount numeric(32,16),
    bmcshostticketid character varying(500),
    betcount integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(32,16),
    salescomm numeric(32,16),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_horse_placedbettransactionlineitem_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 989 (class 1259 OID 2036689)
-- Name: ztubt_horse_placedbettransactionlineitem_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_horse_placedbettransactionlineitem_bk_before_tfog (
    tranheaderid character varying(50) NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sourcesystemtransactionid character varying(50) NOT NULL,
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10) NOT NULL,
    fixturedate date NOT NULL,
    meeting character varying(50) NOT NULL,
    betlineannotation character varying(500) NOT NULL,
    units integer NOT NULL,
    betpriceamount numeric(32,16),
    boardrebateamount numeric(32,16),
    bmcshostticketid character varying(500),
    betcount integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(32,16),
    salescomm numeric(32,16),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_horse_placedbettransactionlineitem_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1003 (class 1259 OID 2132319)
-- Name: ztubt_horse_placedbettransactionlineitem_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_horse_placedbettransactionlineitem_bk_tfog_sit (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10),
    fixturedate date,
    meeting character varying(50),
    betlineannotation character varying(500),
    units integer,
    betpriceamount numeric(32,16),
    boardrebateamount numeric(32,16),
    bmcshostticketid character varying(500),
    betcount integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(32,16),
    salescomm numeric(32,16),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_horse_placedbettransactionlineitem_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 650 (class 1259 OID 26113)
-- Name: ztubt_invoiceperiod; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_invoiceperiod (
    invoiceperiodid integer NOT NULL,
    startdate date,
    enddate date
);


ALTER TABLE public.ztubt_invoiceperiod OWNER TO consultant01;

--
-- TOC entry 651 (class 1259 OID 26116)
-- Name: ztubt_load_config; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_load_config (
    table_name character varying(60),
    business_date date NOT NULL,
    from_date_time timestamp without time zone NOT NULL,
    to_date_time timestamp without time zone NOT NULL,
    raw_zone_status character varying(20),
    raw_file_name character varying(100) NOT NULL,
    etl_run_time timestamp without time zone,
    created_date timestamp without time zone,
    last_updated_date timestamp without time zone,
    remarks character varying
);


ALTER TABLE public.ztubt_load_config OWNER TO consultant01;

--
-- TOC entry 652 (class 1259 OID 26128)
-- Name: ztubt_location; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_location (
    locid integer NOT NULL,
    locdisplayid character varying(100) NOT NULL,
    loctypeid integer NOT NULL,
    chid integer,
    retid integer,
    locname character varying(100) NOT NULL,
    locdescription character varying(1000),
    locbusinessregistrationno character varying(100),
    locaddress character varying(1000),
    locpostalcode character varying(100),
    locsupervisorname character varying(100),
    loccontactno character varying(100),
    createdby character varying(100) NOT NULL,
    createddate timestamp without time zone NOT NULL,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean NOT NULL,
    isgst boolean,
    isibg boolean,
    bankid character varying(100),
    branchid character varying(100),
    accountnumber character varying(100),
    gstregnumber character varying(100),
    sweepindicator integer,
    ishq boolean
);


ALTER TABLE public.ztubt_location OWNER TO consultant01;

--
-- TOC entry 987 (class 1259 OID 2036371)
-- Name: ztubt_location_bk20241015; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_location_bk20241015 (
    locid integer NOT NULL,
    locdisplayid character varying(100) NOT NULL,
    loctypeid integer NOT NULL,
    chid integer,
    retid integer,
    locname character varying(100) NOT NULL,
    locdescription character varying(1000),
    locbusinessregistrationno character varying(100),
    locaddress character varying(1000),
    locpostalcode character varying(100),
    locsupervisorname character varying(100),
    loccontactno character varying(100),
    createdby character varying(100) NOT NULL,
    createddate timestamp without time zone NOT NULL,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean NOT NULL,
    isgst boolean,
    isibg boolean,
    bankid character varying(100),
    branchid character varying(100),
    accountnumber character varying(100),
    gstregnumber character varying(100),
    sweepindicator integer,
    ishq boolean
);


ALTER TABLE public.ztubt_location_bk20241015 OWNER TO sp_postgres;

--
-- TOC entry 1011 (class 1259 OID 2132355)
-- Name: ztubt_location_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_location_bk_tfog_sit (
    locid integer,
    locdisplayid character varying(100),
    loctypeid integer,
    chid integer,
    retid integer,
    locname character varying(100),
    locdescription character varying(1000),
    locbusinessregistrationno character varying(100),
    locaddress character varying(1000),
    locpostalcode character varying(100),
    locsupervisorname character varying(100),
    loccontactno character varying(100),
    createdby character varying(100),
    createddate timestamp without time zone,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean,
    isgst boolean,
    isibg boolean,
    bankid character varying(100),
    branchid character varying(100),
    accountnumber character varying(100),
    gstregnumber character varying(100),
    sweepindicator integer,
    ishq boolean
);


ALTER TABLE public.ztubt_location_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 986 (class 1259 OID 2032301)
-- Name: ztubt_location_testubt; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_location_testubt (
    locid integer,
    locdisplayid character varying(100),
    loctypeid integer,
    chid integer,
    retid integer,
    locname character varying(100),
    locdescription character varying(1000),
    locbusinessregistrationno character varying(100),
    locaddress character varying(1000),
    locpostalcode character varying(100),
    locsupervisorname character varying(100),
    loccontactno character varying(100),
    createdby character varying(100),
    createddate timestamp without time zone,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean,
    isgst boolean,
    isibg boolean,
    bankid character varying(100),
    branchid character varying(100),
    accountnumber character varying(100),
    gstregnumber character varying(100),
    sweepindicator integer,
    ishq boolean
);


ALTER TABLE public.ztubt_location_testubt OWNER TO sp_postgres;

--
-- TOC entry 653 (class 1259 OID 26140)
-- Name: ztubt_locationgsthistory; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_locationgsthistory (
    locationgsthistoryid bigint NOT NULL,
    locid integer NOT NULL,
    isgst boolean NOT NULL,
    startdate date NOT NULL,
    enddate date NOT NULL,
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL,
    isdeleted boolean NOT NULL
);


ALTER TABLE public.ztubt_locationgsthistory OWNER TO consultant01;

--
-- TOC entry 999 (class 1259 OID 2083221)
-- Name: ztubt_locationgsthistory_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_locationgsthistory_bk_before_tfog (
    locationgsthistoryid bigint,
    locid integer,
    isgst boolean,
    startdate date,
    enddate date,
    createdbyid integer,
    createddatetime timestamp without time zone,
    updatedbyid integer,
    updateddatetime timestamp without time zone,
    isdeleted boolean
);


ALTER TABLE public.ztubt_locationgsthistory_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1004 (class 1259 OID 2132325)
-- Name: ztubt_locationgsthistory_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_locationgsthistory_bk_tfog_sit (
    locationgsthistoryid bigint,
    locid integer,
    isgst boolean,
    startdate date,
    enddate date,
    createdbyid integer,
    createddatetime timestamp without time zone,
    updatedbyid integer,
    updateddatetime timestamp without time zone,
    isdeleted boolean
);


ALTER TABLE public.ztubt_locationgsthistory_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 654 (class 1259 OID 26143)
-- Name: ztubt_locationstatuschange; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_locationstatuschange (
    locstatusid integer NOT NULL,
    locid integer NOT NULL,
    status integer NOT NULL,
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_locationstatuschange OWNER TO consultant01;

--
-- TOC entry 655 (class 1259 OID 26146)
-- Name: ztubt_locbusinesscode; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_locbusinesscode (
    locbusinesscode integer,
    chdisplayid character varying(200)
);


ALTER TABLE public.ztubt_locbusinesscode OWNER TO consultant01;

--
-- TOC entry 656 (class 1259 OID 26149)
-- Name: ztubt_loctype; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_loctype (
    loctypeid integer,
    sweepindicator integer,
    saploctypeid integer,
    saploctype character varying(30)
);


ALTER TABLE public.ztubt_loctype OWNER TO consultant01;

--
-- TOC entry 657 (class 1259 OID 26152)
-- Name: ztubt_lookupvalueconfig; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_lookupvalueconfig (
    lookupvalueid integer NOT NULL,
    configname character varying(30) NOT NULL,
    fld1value character varying(50),
    fld2value character varying(50),
    fld3value character varying(50),
    fld4value character varying(50),
    fld5value character varying(50),
    startdate date,
    enddate date,
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_lookupvalueconfig OWNER TO consultant01;

--
-- TOC entry 658 (class 1259 OID 26155)
-- Name: ztubt_offlineproductheader; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_offlineproductheader (
    transactionheaderid character varying NOT NULL,
    cartid character varying NOT NULL,
    offlineproductid integer NOT NULL,
    transactiontime timestamp without time zone NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying
);


ALTER TABLE public.ztubt_offlineproductheader OWNER TO consultant01;

--
-- TOC entry 659 (class 1259 OID 26161)
-- Name: ztubt_operatinghours; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_operatinghours (
    operatinghoursid integer NOT NULL,
    dayno integer NOT NULL,
    locid integer NOT NULL,
    isclosed boolean NOT NULL,
    opentime time without time zone,
    closetime time without time zone,
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL,
    isdeleted boolean NOT NULL
);


ALTER TABLE public.ztubt_operatinghours OWNER TO consultant01;

--
-- TOC entry 660 (class 1259 OID 26164)
-- Name: ztubt_paymentdetail; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_paymentdetail (
    paymentid character varying(50) NOT NULL,
    paymentdetailid character varying(50) NOT NULL,
    paidamount numeric(16,2) NOT NULL,
    paymenttypeid character varying(5) NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_paymentdetail OWNER TO consultant01;

--
-- TOC entry 934 (class 1259 OID 1840189)
-- Name: ztubt_paymentheader; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_paymentheader (
    paymentid character varying(38) NOT NULL,
    cartid character varying(38) NOT NULL,
    totalamountpaid numeric(18,2),
    paymenttag character varying(100),
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_paymentheader OWNER TO sp_postgres;

--
-- TOC entry 870 (class 1259 OID 956792)
-- Name: ztubt_paynowtransaction; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_paynowtransaction (
    bankaccountno character varying(35),
    bankname character varying(10),
    bankreference character varying(60),
    cartid character varying(38) NOT NULL,
    createddate timestamp without time zone NOT NULL,
    creditdebit character varying(60) NOT NULL,
    documentno character varying(36),
    netamount numeric(21,2) NOT NULL,
    paymentdetailid character varying(38),
    paymentmode character varying(1),
    paymenttypeid character varying(60) NOT NULL,
    payoutid character varying(38),
    transactiondate timestamp without time zone,
    transactionfee numeric(9,2) NOT NULL,
    transactionreference character varying(16) NOT NULL,
    transactionstatus character varying(2) NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_paynowtransaction OWNER TO sp_postgres;

--
-- TOC entry 932 (class 1259 OID 1839536)
-- Name: ztubt_payoutdata; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_payoutdata (
    payoutid character varying(38) NOT NULL,
    cartid character varying(38) NOT NULL,
    totalamountpaid numeric(16,2),
    paymenttypeid character varying(5) NOT NULL,
    cartcreateddate timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_payoutdata OWNER TO sp_postgres;

--
-- TOC entry 661 (class 1259 OID 26167)
-- Name: ztubt_payoutsports; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_payoutsports (
    payoutsportid integer NOT NULL,
    businessdate timestamp without time zone,
    producttype character varying(10),
    prizeamount numeric(18,2),
    refundamount numeric(18,2),
    txndate timestamp without time zone
);


ALTER TABLE public.ztubt_payoutsports OWNER TO consultant01;

--
-- TOC entry 1021 (class 1259 OID 2308167)
-- Name: ztubt_pbth_partition_test; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_pbth_partition_test (
    tranheaderid character varying(50) NOT NULL,
    requestid character varying(33) NOT NULL,
    tickettransactionid character varying(200) NOT NULL,
    ticketserialnumber character varying(200) NOT NULL,
    hostticketid character varying(500),
    barcode character varying(200),
    trandate timestamp without time zone,
    prodid integer NOT NULL,
    cartid character varying(50) NOT NULL,
    createddate timestamp without time zone NOT NULL,
    entrymethodid character varying(10),
    qrformat1 character varying(1000),
    qrformat2 character varying(1000),
    deviceid character varying(100),
    isbetrejectedbytrader boolean,
    ispay boolean,
    uniqueid character varying(534),
    iscancelled boolean NOT NULL,
    isexchangeticket boolean NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50)
)
PARTITION BY RANGE (createddate);


ALTER TABLE public.ztubt_pbth_partition_test OWNER TO postgres;

--
-- TOC entry 1022 (class 1259 OID 2308180)
-- Name: ztubt_pbth_partition_test_2022; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_pbth_partition_test_2022 PARTITION OF public.ztubt_pbth_partition_test
FOR VALUES FROM ('2022-01-01 00:00:00') TO ('2023-01-01 00:00:00');


ALTER TABLE public.ztubt_pbth_partition_test_2022 OWNER TO postgres;

--
-- TOC entry 662 (class 1259 OID 26170)
-- Name: ztubt_placedbettransactionheader; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_placedbettransactionheader (
    tranheaderid character varying(50) NOT NULL,
    requestid character varying(33) NOT NULL,
    tickettransactionid character varying(200) NOT NULL,
    ticketserialnumber character varying(200) NOT NULL,
    hostticketid character varying(500),
    barcode character varying(200),
    trandate timestamp without time zone,
    prodid integer NOT NULL,
    cartid character varying(50) NOT NULL,
    createddate timestamp without time zone,
    entrymethodid character varying(10),
    qrformat1 character varying(1000),
    qrformat2 character varying(1000),
    deviceid character varying(100),
    isbetrejectedbytrader boolean,
    ispay boolean,
    uniqueid character varying(534),
    iscancelled boolean NOT NULL,
    isexchangeticket boolean NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50)
);


ALTER TABLE public.ztubt_placedbettransactionheader OWNER TO consultant01;

--
-- TOC entry 663 (class 1259 OID 26182)
-- Name: ztubt_placedbettransactionheaderlifecyclestate; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_placedbettransactionheaderlifecyclestate (
    placedbetlifecycleid character varying(50) NOT NULL,
    tranheaderid character varying(50) NOT NULL,
    betstatetypeid character varying(5) NOT NULL,
    status character varying(50) NOT NULL,
    captureddate timestamp without time zone NOT NULL,
    createddate timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_placedbettransactionheaderlifecyclestate OWNER TO consultant01;

--
-- TOC entry 664 (class 1259 OID 26188)
-- Name: ztubt_product; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_product (
    prodid integer NOT NULL,
    productdisplayid character varying(100) NOT NULL,
    prodname character varying(100) NOT NULL,
    proddesc character varying(1000),
    prodonlinetime time without time zone,
    prodofflinetime time without time zone,
    isdeleted boolean NOT NULL,
    host integer NOT NULL,
    isallowedebetslip boolean,
    isenabledebetslip boolean,
    createdbyid integer,
    createddatetime timestamp without time zone,
    updatedbyid integer,
    updateddatetime timestamp without time zone
);


ALTER TABLE public.ztubt_product OWNER TO consultant01;

--
-- TOC entry 871 (class 1259 OID 958408)
-- Name: ztubt_reconciliationresult; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_reconciliationresult (
    reconciliationresultid bigint NOT NULL,
    transactionreference character varying(16) NOT NULL,
    bankname character varying(10) NOT NULL,
    bankaccountno character varying(35) NOT NULL,
    paymenttypeid character varying(5) NOT NULL,
    bankreference character varying(60),
    bankamount numeric(21,2),
    netamount numeric(21,2),
    transactionfeedl numeric(9,2),
    documentnodl character varying(36),
    cartiddl character varying(38),
    creditdebit character varying(1) NOT NULL,
    transactiondate timestamp without time zone,
    bankstatusdl character varying(2),
    valuedate timestamp without time zone,
    createddate timestamp without time zone NOT NULL,
    updateddatetime timestamp without time zone NOT NULL,
    "RESULT" character varying(5) NOT NULL
);


ALTER TABLE public.ztubt_reconciliationresult OWNER TO sp_postgres;

--
-- TOC entry 665 (class 1259 OID 26194)
-- Name: ztubt_recovery; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_recovery (
    recoveryid integer NOT NULL,
    fundingid integer NOT NULL,
    recperiodstart date NOT NULL,
    recperiodend date NOT NULL,
    recoveryamount numeric,
    createdbyid character varying(255) NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid character varying(255) NOT NULL,
    updateddatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_recovery OWNER TO consultant01;

--
-- TOC entry 666 (class 1259 OID 26200)
-- Name: ztubt_retailer; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_retailer (
    retid integer NOT NULL,
    retname character varying(100) NOT NULL,
    retdesc character varying(1000),
    createdby character varying(100) NOT NULL,
    createddate timestamp without time zone NOT NULL,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean NOT NULL
);


ALTER TABLE public.ztubt_retailer OWNER TO consultant01;

--
-- TOC entry 667 (class 1259 OID 26206)
-- Name: ztubt_salescomconfig; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_salescomconfig (
    salescomconfigid integer NOT NULL,
    prodid integer NOT NULL,
    bettype integer,
    commissiontype integer NOT NULL,
    salesfactor numeric(16,9),
    salescommission numeric(16,9),
    fixedamount numeric(16,9),
    grouptiered integer,
    amountfrom numeric(16,9),
    amountto numeric(16,9),
    commissionrate numeric(16,9),
    createdbyid integer NOT NULL,
    createddatetime timestamp without time zone NOT NULL,
    updatedbyid integer NOT NULL,
    updateddatetime timestamp without time zone NOT NULL,
    isdeleted boolean NOT NULL
);


ALTER TABLE public.ztubt_salescomconfig OWNER TO consultant01;

--
-- TOC entry 668 (class 1259 OID 26209)
-- Name: ztubt_sap_product; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sap_product (
    prodid integer,
    sapprodid integer
);


ALTER TABLE public.ztubt_sap_product OWNER TO consultant01;

--
-- TOC entry 669 (class 1259 OID 26212)
-- Name: ztubt_session; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_session (
    sessionid character varying NOT NULL,
    userdisplayid character varying(50),
    terdisplayid character varying(100),
    sessionstartdatetime timestamp without time zone DEFAULT ('now'::text)::date NOT NULL,
    sessionenddatetime timestamp without time zone,
    status character varying(50),
    closedby character varying(100),
    comments character varying(1000)
);


ALTER TABLE public.ztubt_session OWNER TO consultant01;

--
-- TOC entry 670 (class 1259 OID 26219)
-- Name: ztubt_spatransaction; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_spatransaction (
    spatransactionid character varying NOT NULL,
    headerid character varying NOT NULL,
    totalamount numeric(18,2) NOT NULL,
    repeatedticket integer NOT NULL,
    transactiontype integer,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying,
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_spatransaction OWNER TO consultant01;

--
-- TOC entry 671 (class 1259 OID 26231)
-- Name: ztubt_sportcategory; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sportcategory (
    categoryid integer NOT NULL,
    name character varying(128) NOT NULL,
    displayname character varying(128),
    isdisplay boolean NOT NULL,
    statuscode character varying(10) NOT NULL,
    displayorder integer NOT NULL,
    createtime timestamp without time zone NOT NULL,
    updatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_sportcategory OWNER TO consultant01;

--
-- TOC entry 672 (class 1259 OID 26234)
-- Name: ztubt_sportclass; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sportclass (
    classid integer NOT NULL,
    categoryid integer NOT NULL,
    name character varying(256) NOT NULL,
    displayname character varying(256),
    isdisplay boolean NOT NULL,
    statuscode character varying(10) NOT NULL,
    displayorder integer NOT NULL,
    sitechannels character varying(50),
    classflagcodes character varying(20),
    classsortcode character varying(20),
    hasopenevent boolean,
    hasnext24hourevent boolean,
    haslivenowevent boolean,
    haslivenoweventorfutureevent boolean,
    drilldowntagnames character varying(50),
    createtime timestamp without time zone NOT NULL,
    updatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_sportclass OWNER TO consultant01;

--
-- TOC entry 673 (class 1259 OID 26240)
-- Name: ztubt_sportevent; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sportevent (
    eventid integer NOT NULL,
    typeid integer NOT NULL,
    retailercode character varying(10) NOT NULL,
    name character varying(255) NOT NULL,
    isdisplay boolean NOT NULL,
    statuscode character varying(10) NOT NULL,
    sitechannels character varying(50),
    starttime timestamp without time zone NOT NULL,
    suspendtime timestamp without time zone NOT NULL,
    isfinish boolean NOT NULL,
    isresulted boolean NOT NULL,
    ishotevent boolean NOT NULL,
    hasbetinrun boolean NOT NULL,
    isoff character varying(10) NOT NULL,
    activityfeedcreatetime timestamp without time zone NOT NULL,
    activityfeedupdatetime timestamp without time zone NOT NULL,
    createtime timestamp without time zone NOT NULL,
    updatetime timestamp without time zone NOT NULL,
    flags character varying(16)
);


ALTER TABLE public.ztubt_sportevent OWNER TO consultant01;

--
-- TOC entry 674 (class 1259 OID 26243)
-- Name: ztubt_sportleagueinfo; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sportleagueinfo (
    leagueinfoid integer NOT NULL,
    leaguecode character varying(32),
    name character varying(128),
    createtime timestamp without time zone NOT NULL,
    updatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_sportleagueinfo OWNER TO consultant01;

--
-- TOC entry 675 (class 1259 OID 26246)
-- Name: ztubt_sports_placedbettransactionlineitem; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sports_placedbettransactionlineitem (
    tranheaderid character varying(50) NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sourcesystemtransactionid character varying(50) NOT NULL,
    issinglebet boolean NOT NULL,
    accumulatorid character varying(4) NOT NULL,
    betamount numeric(16,9) NOT NULL,
    potentialreturns numeric(18,9) NOT NULL,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    originalbetamount numeric(16,9),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_sports_placedbettransactionlineitem OWNER TO consultant01;

--
-- TOC entry 923 (class 1259 OID 1789951)
-- Name: ztubt_sports_placedbettransactionlineitem_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_sports_placedbettransactionlineitem_bk_before_bmcs (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    issinglebet boolean,
    accumulatorid character varying(4),
    betamount numeric(16,9),
    potentialreturns numeric(18,9),
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    originalbetamount numeric(16,9),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_sports_placedbettransactionlineitem_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 676 (class 1259 OID 26249)
-- Name: ztubt_sports_placedbettransactionlineitemnumber; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sports_placedbettransactionlineitemnumber (
    sportslineitemid bigint NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    eventid integer NOT NULL,
    eventleaguename character varying(255) NOT NULL,
    eventname character varying(255) NOT NULL,
    eventstarttime timestamp without time zone NOT NULL,
    bettypeid integer NOT NULL,
    bettypename character varying(255) NOT NULL,
    selectionid integer NOT NULL,
    selectionname character varying(255) NOT NULL,
    selectionodds numeric(16,9) NOT NULL,
    sequence integer NOT NULL,
    scoringtype character varying(10),
    salescombettype character varying(255) NOT NULL,
    createddate timestamp without time zone,
    tranheaderid character varying(50),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_sports_placedbettransactionlineitemnumber OWNER TO consultant01;

--
-- TOC entry 924 (class 1259 OID 1789954)
-- Name: ztubt_sports_placedbettransactionlineitemnumber_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_sports_placedbettransactionlineitemnumber_bk_before_bmcs (
    sportslineitemid bigint,
    tranlineitemid character varying(50),
    eventid integer,
    eventleaguename character varying(255),
    eventname character varying(255),
    eventstarttime timestamp without time zone,
    bettypeid integer,
    bettypename character varying(255),
    selectionid integer,
    selectionname character varying(255),
    selectionodds numeric(16,9),
    sequence integer,
    scoringtype character varying(10),
    salescombettype character varying(255),
    createddate timestamp without time zone,
    tranheaderid character varying(50),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_sports_placedbettransactionlineitemnumber_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 990 (class 1259 OID 2036705)
-- Name: ztubt_sports_placedbettransactionlineitemnumber_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_sports_placedbettransactionlineitemnumber_bk_before_tfog (
    sportslineitemid bigint NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    eventid integer NOT NULL,
    eventleaguename character varying(255) NOT NULL,
    eventname character varying(255) NOT NULL,
    eventstarttime timestamp without time zone NOT NULL,
    bettypeid integer NOT NULL,
    bettypename character varying(255) NOT NULL,
    selectionid integer NOT NULL,
    selectionname character varying(255) NOT NULL,
    selectionodds numeric(16,9) NOT NULL,
    sequence integer NOT NULL,
    scoringtype character varying(10),
    salescombettype character varying(255) NOT NULL,
    createddate timestamp without time zone,
    tranheaderid character varying(50),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_sports_placedbettransactionlineitemnumber_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1005 (class 1259 OID 2132328)
-- Name: ztubt_sports_placedbettransactionlineitemnumber_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_sports_placedbettransactionlineitemnumber_bk_tfog_sit (
    sportslineitemid bigint,
    tranlineitemid character varying(50),
    eventid integer,
    eventleaguename character varying(255),
    eventname character varying(255),
    eventstarttime timestamp without time zone,
    bettypeid integer,
    bettypename character varying(255),
    selectionid integer,
    selectionname character varying(255),
    selectionodds numeric(16,9),
    sequence integer,
    scoringtype character varying(10),
    salescombettype character varying(255),
    createddate timestamp without time zone,
    tranheaderid character varying(50),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_sports_placedbettransactionlineitemnumber_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 677 (class 1259 OID 26255)
-- Name: ztubt_sporttype; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sporttype (
    typeid integer NOT NULL,
    classid integer NOT NULL,
    retailercode character varying(10),
    name character varying(255) NOT NULL,
    displayname character varying(128),
    isdisplay boolean NOT NULL,
    statuscode character varying(10) NOT NULL,
    displayorder integer NOT NULL,
    sitechannels character varying(50),
    typeflagcodes character varying(20),
    hasopenevent boolean,
    hasnext24hourevent boolean,
    haslivenowevent boolean,
    haslivenoweventorfutureevent boolean,
    drilldowntagnames character varying(50),
    cashoutavail character varying(10),
    createtime timestamp without time zone NOT NULL,
    updatetime timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_sporttype OWNER TO consultant01;

--
-- TOC entry 678 (class 1259 OID 26261)
-- Name: ztubt_superchain; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_superchain (
    scid integer NOT NULL,
    scdisplayid character varying(100) NOT NULL,
    scname character varying(100) NOT NULL,
    scbusinessregistrationno character varying(100),
    scheadquarteraddress character varying(1000),
    scpostalcode character varying(50),
    scmanagername character varying(100),
    sccontactno character varying(100),
    scemailaddress character varying(100),
    isretailer boolean NOT NULL,
    createdby character varying(100) NOT NULL,
    createddate timestamp without time zone NOT NULL,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean NOT NULL
);


ALTER TABLE public.ztubt_superchain OWNER TO consultant01;

--
-- TOC entry 679 (class 1259 OID 26267)
-- Name: ztubt_sweep_placedbettransactionlineitem; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sweep_placedbettransactionlineitem (
    tranlineitemid character varying(50) NOT NULL,
    tranheaderid character varying(50) NOT NULL,
    bulkid character varying(50),
    bulksequence integer,
    sourcesystemtransactionid character varying(50) NOT NULL,
    sequence integer NOT NULL,
    bettypeid character varying(10) NOT NULL,
    quickpickindicator boolean NOT NULL,
    isprinted boolean,
    printattemptcount integer,
    createddate timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_sweep_placedbettransactionlineitem OWNER TO consultant01;

--
-- TOC entry 920 (class 1259 OID 1789931)
-- Name: ztubt_sweep_placedbettransactionlineitem_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_sweep_placedbettransactionlineitem_bk_before_bmcs (
    tranlineitemid character varying(50),
    tranheaderid character varying(50),
    bulkid character varying(50),
    bulksequence integer,
    sourcesystemtransactionid character varying(50),
    sequence integer,
    bettypeid character varying(10),
    quickpickindicator boolean,
    isprinted boolean,
    printattemptcount integer,
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_sweep_placedbettransactionlineitem_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 991 (class 1259 OID 2036715)
-- Name: ztubt_sweep_placedbettransactionlineitem_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_sweep_placedbettransactionlineitem_bk_before_tfog (
    tranlineitemid character varying(50) NOT NULL,.ztubt_sweep_placedbettransactionlineitem
    tranheaderid character varying(50) NOT NULL,
    bulkid character varying(50),
    bulksequence integer,
    sourcesystemtransactionid character varying(50) NOT NULL,
    sequence integer NOT NULL,
    bettypeid character varying(10) NOT NULL,
    quickpickindicator boolean NOT NULL,
    isprinted boolean,
    printattemptcount integer,
    createddate timestamp without time zone NOT NULL
);


ALTER TABLE public.ztubt_sweep_placedbettransactionlineitem_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1006 (class 1259 OID 2132334)
-- Name: ztubt_sweep_placedbettransactionlineitem_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_sweep_placedbettransactionlineitem_bk_tfog_sit (
    tranlineitemid character varying(50),
    tranheaderid character varying(50),
    bulkid character varying(50),
    bulksequence integer,
    sourcesystemtransactionid character varying(50),
    sequence integer,
    bettypeid character varying(10),
    quickpickindicator boolean,
    isprinted boolean,
    printattemptcount integer,
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_sweep_placedbettransactionlineitem_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 680 (class 1259 OID 26270)
-- Name: ztubt_sweep_placedbettransactionlineitemnumber; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_sweep_placedbettransactionlineitemnumber (
    lineitemnumberid bigint NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    userselectednumber character varying(10),
    selectednumber character varying(10),
    issoldout boolean,
    betpriceamount numeric(16,9) NOT NULL,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    tranheaderid character varying(50),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_sweep_placedbettransactionlineitemnumber OWNER TO consultant01;

--
-- TOC entry 919 (class 1259 OID 1789920)
-- Name: ztubt_sweep_placedbettransactionlineitemnumber_bk_dat; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_sweep_placedbettransactionlineitemnumber_bk_dat (
    lineitemnumberid bigint,
    tranlineitemid character varying(50),
    userselectednumber character varying(10),
    selectednumber character varying(10),
    issoldout boolean,
    betpriceamount numeric(16,9),
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    tranheaderid character varying(50),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_sweep_placedbettransactionlineitemnumber_bk_dat OWNER TO sp_postgres;

--
-- TOC entry 681 (class 1259 OID 26273)
-- Name: ztubt_table_interval_load_config; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_table_interval_load_config (
    table_name character varying(60) NOT NULL,
    raw_run_no integer NOT NULL,
    from_time time without time zone NOT NULL,
    to_time time without time zone NOT NULL,
    curated_run_no integer NOT NULL,
    createdate timestamp without time zone NOT NULL,
    updateddate timestamp without time zone NOT NULL,
    from_day_no integer,
    to_day_no integer,
    etl_start_date date,
    etl_type character varying,
    ubtsourcetable character varying(100),
    ubtextractionfield character varying(100),
    ztubt_extract_field character varying(50)
);


ALTER TABLE public.ztubt_table_interval_load_config OWNER TO consultant01;

--
-- TOC entry 682 (class 1259 OID 26321)
-- Name: ztubt_table_interval_load_config_utc2; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_table_interval_load_config_utc2 (
    table_name character varying(60),
    raw_run_no integer,
    from_time time without time zone,
    to_time time without time zone,
    curated_run_no integer,
    createdate timestamp without time zone,
    updateddate timestamp without time zone,
    from_day_no integer,
    to_day_no integer,
    etl_start_date date,
    etl_type character varying
);


ALTER TABLE public.ztubt_table_interval_load_config_utc2 OWNER TO consultant01;

--
-- TOC entry 683 (class 1259 OID 26327)
-- Name: ztubt_temp_placedbettransactionheader; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_temp_placedbettransactionheader (
    tranheaderid character varying(50),
    requestid character varying(33),
    tickettransactionid character varying(200),
    ticketserialnumber character varying(200),
    hostticketid character varying(500),
    barcode character varying(200),
    trandate timestamp without time zone,
    prodid integer,
    cartid character varying(50),
    createddate timestamp without time zone,
    entrymethodid character varying(10),
    qrformat1 character varying(1000),
    qrformat2 character varying(1000),
    deviceid character varying(100),
    isbetrejectedbytrader boolean,
    ispay boolean,
    uniqueid character varying(534),
    iscancelled boolean,
    isexchangeticket boolean,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50)
);


ALTER TABLE public.ztubt_temp_placedbettransactionheader OWNER TO consultant01;

--
-- TOC entry 684 (class 1259 OID 26339)
-- Name: ztubt_terminal; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_terminal (
    terid integer NOT NULL,
    terdisplayid character varying(100) NOT NULL,
    locid integer NOT NULL,
    tername character varying(100),
    terhostname character varying(100),
    termacaddress character varying(20),
    createdby character varying(100) NOT NULL,
    createddate timestamp without time zone NOT NULL,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean NOT NULL,
    ischequepayout boolean
);


ALTER TABLE public.ztubt_terminal OWNER TO consultant01;

--
-- TOC entry 1010 (class 1259 OID 2132349)
-- Name: ztubt_terminal_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_terminal_bk_tfog_sit (
    terid integer,
    terdisplayid character varying(100),
    locid integer,
    tername character varying(100),
    terhostname character varying(100),
    termacaddress character varying(20),
    createdby character varying(100),
    createddate timestamp without time zone,
    updatedby character varying(100),
    updateddate timestamp without time zone,
    isdeleted boolean,
    ischequepayout boolean
);


ALTER TABLE public.ztubt_terminal_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 685 (class 1259 OID 26345)
-- Name: ztubt_test_dl_ubt_table_mapping; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_test_dl_ubt_table_mapping (
    dl_table character varying(100),
    etl_type character varying(20),
    extraction_field character varying(50),
    ubt_table character varying(100)
);


ALTER TABLE public.ztubt_test_dl_ubt_table_mapping OWNER TO consultant01;

--
-- TOC entry 686 (class 1259 OID 26348)
-- Name: ztubt_test_placedbettransactionheader_del; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_test_placedbettransactionheader_del (
    tranheaderid character varying(50),
    requestid character varying(33),
    tickettransactionid character varying(200),
    ticketserialnumber character varying(200),
    hostticketid character varying(500),
    barcode character varying(200),
    trandate timestamp without time zone,
    prodid integer,
    cartid character varying(50),
    createddate timestamp without time zone,
    entrymethodid character varying(10),
    qrformat1 character varying(1000),
    qrformat2 character varying(1000),
    deviceid character varying(100),
    isbetrejectedbytrader boolean,
    ispay boolean,
    uniqueid character varying(534),
    iscancelled boolean,
    isexchangeticket boolean,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50)
);


ALTER TABLE public.ztubt_test_placedbettransactionheader_del OWNER TO consultant01;

--
-- TOC entry 687 (class 1259 OID 26354)
-- Name: ztubt_topupcardtransaction; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_topupcardtransaction (
    topuptransactionid character varying NOT NULL,
    headerid character varying NOT NULL,
    cardnumber character varying(1),
    totalamount numeric(16,9) NOT NULL,
    transactiontype integer NOT NULL,
    repeatedticket integer NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying,
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_topupcardtransaction OWNER TO consultant01;

--
-- TOC entry 1024 (class 1259 OID 2376152)
-- Name: ztubt_topupcardtransaction_bk; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_topupcardtransaction_bk (
    topuptransactionid character varying,
    headerid character varying,
    cardnumber character varying(1),
    totalamount numeric(16,9),
    transactiontype integer,
    repeatedticket integer,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying,
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_topupcardtransaction_bk OWNER TO sp_postgres;

--
-- TOC entry 688 (class 1259 OID 26360)
-- Name: ztubt_toto_lineitem_prd; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_toto_lineitem_prd (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10),
    betlineannotation character varying(500),
    units integer,
    betpriceamount numeric(16,2),
    grouphostid character varying(50),
    groupunitsequence integer,
    quickpickindicator boolean,
    itotoindicator boolean,
    boardsequence integer,
    syndicatepartsallowed integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate information_schema.time_stamp
);


ALTER TABLE public.ztubt_toto_lineitem_prd OWNER TO consultant01;

--
-- TOC entry 689 (class 1259 OID 26366)
-- Name: ztubt_toto_lineitem_ubt; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_toto_lineitem_ubt (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10),
    betlineannotation character varying(500),
    units integer,
    betpriceamount numeric(16,2),
    grouphostid character varying(50),
    groupunitsequence integer,
    quickpickindicator boolean,
    itotoindicator boolean,
    boardsequence integer,
    syndicatepartsallowed integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate information_schema.time_stamp
);


ALTER TABLE public.ztubt_toto_lineitem_ubt OWNER TO consultant01;

--
-- TOC entry 690 (class 1259 OID 26372)
-- Name: ztubt_toto_placedbettransactionlineitem; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitem (
    tranheaderid character varying(50) NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sourcesystemtransactionid character varying(50) NOT NULL,
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10) NOT NULL,
    betlineannotation character varying(500) NOT NULL,
    units integer NOT NULL,
    betpriceamount numeric(16,2),
    grouphostid character varying(50),
    groupunitsequence integer,
    quickpickindicator boolean NOT NULL,
    itotoindicator boolean NOT NULL,
    boardsequence integer,
    syndicatepartsallowed integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
)
WITH (autovacuum_enabled='true');


ALTER TABLE public.ztubt_toto_placedbettransactionlineitem OWNER TO consultant01;

--
-- TOC entry 1014 (class 1259 OID 2155069)
-- Name: ztubt_toto_placedbettransactionlineitem_bk20241120; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitem_bk20241120 (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10),
    betlineannotation character varying(500),
    units integer,
    betpriceamount numeric(16,2),
    grouphostid character varying(50),
    groupunitsequence integer,
    quickpickindicator boolean,
    itotoindicator boolean,
    boardsequence integer,
    syndicatepartsallowed integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_toto_placedbettransactionlineitem_bk20241120 OWNER TO sp_postgres;

--
-- TOC entry 925 (class 1259 OID 1789960)
-- Name: ztubt_toto_placedbettransactionlineitem_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitem_bk_before_bmcs (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10),
    betlineannotation character varying(500),
    units integer,
    betpriceamount numeric(16,2),
    grouphostid character varying(50),
    groupunitsequence integer,
    quickpickindicator boolean,
    itotoindicator boolean,
    boardsequence integer,
    syndicatepartsallowed integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_toto_placedbettransactionlineitem_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 992 (class 1259 OID 2036724)
-- Name: ztubt_toto_placedbettransactionlineitem_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitem_bk_before_tfog (
    tranheaderid character varying(50) NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sourcesystemtransactionid character varying(50) NOT NULL,
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10) NOT NULL,
    betlineannotation character varying(500) NOT NULL,
    units integer NOT NULL,
    betpriceamount numeric(16,2),
    grouphostid character varying(50),
    groupunitsequence integer,
    quickpickindicator boolean NOT NULL,
    itotoindicator boolean NOT NULL,
    boardsequence integer,
    syndicatepartsallowed integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_toto_placedbettransactionlineitem_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1007 (class 1259 OID 2132337)
-- Name: ztubt_toto_placedbettransactionlineitem_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitem_bk_tfog_sit (
    tranheaderid character varying(50),
    tranlineitemid character varying(50),
    sourcesystemtransactionid character varying(50),
    betlinehosttransactionid character varying(50),
    bettypeid character varying(10),
    betlineannotation character varying(500),
    units integer,
    betpriceamount numeric(16,2),
    grouphostid character varying(50),
    groupunitsequence integer,
    quickpickindicator boolean,
    itotoindicator boolean,
    boardsequence integer,
    syndicatepartsallowed integer,
    salesfactor numeric(16,9),
    salesfactoramount numeric(16,9),
    salescomm numeric(16,9),
    salescommamount numeric(16,9),
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_toto_placedbettransactionlineitem_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 691 (class 1259 OID 26378)
-- Name: ztubt_toto_placedbettransactionlineitemnumber; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitemnumber (
    lineitemnumberid bigint NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sequence integer NOT NULL,
    singlebetnumber integer NOT NULL,
    viewcreateddate timestamp without time zone
)
WITH (autovacuum_vacuum_scale_factor='0.002', autovacuum_analyze_scale_factor='0.002', autovacuum_vacuum_cost_delay='2', autovacuum_vacuum_cost_limit='10000');


ALTER TABLE public.ztubt_toto_placedbettransactionlineitemnumber OWNER TO consultant01;

--
-- TOC entry 926 (class 1259 OID 1789966)
-- Name: ztubt_toto_placedbettransactionlineitemnumber_bk_before_bmcs; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitemnumber_bk_before_bmcs (
    lineitemnumberid bigint,
    tranlineitemid character varying(50),
    sequence integer,
    singlebetnumber integer,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_toto_placedbettransactionlineitemnumber_bk_before_bmcs OWNER TO sp_postgres;

--
-- TOC entry 993 (class 1259 OID 2036741)
-- Name: ztubt_toto_placedbettransactionlineitemnumber_bk_before_tfog; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitemnumber_bk_before_tfog (
    lineitemnumberid bigint NOT NULL,
    tranlineitemid character varying(50) NOT NULL,
    sequence integer NOT NULL,
    singlebetnumber integer NOT NULL,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_toto_placedbettransactionlineitemnumber_bk_before_tfog OWNER TO sp_postgres;

--
-- TOC entry 1008 (class 1259 OID 2132343)
-- Name: ztubt_toto_placedbettransactionlineitemnumber_bk_tfog_sit; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitemnumber_bk_tfog_sit (
    lineitemnumberid bigint,
    tranlineitemid character varying(50),
    sequence integer,
    singlebetnumber integer,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_toto_placedbettransactionlineitemnumber_bk_tfog_sit OWNER TO sp_postgres;

--
-- TOC entry 1023 (class 1259 OID 2314324)
-- Name: ztubt_toto_placedbettransactionlineitemnumber_new; Type: TABLE; Schema: public; Owner: postgres
--

CREATE TABLE public.ztubt_toto_placedbettransactionlineitemnumber_new (
    lineitemnumberid bigint NOT NULL,
    tranlineitemid character varying(50),
    sequence integer,
    singlebetnumber integer,
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_toto_placedbettransactionlineitemnumber_new OWNER TO postgres;

--
-- TOC entry 692 (class 1259 OID 26381)
-- Name: ztubt_totohongbaotransaction; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_totohongbaotransaction (
    totohongbaotransactionid character varying(50) NOT NULL,
    headerid character varying(50) NOT NULL,
    totalamount numeric(16,9) NOT NULL,
    repeatedticket integer NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    createddate timestamp without time zone
);


ALTER TABLE public.ztubt_totohongbaotransaction OWNER TO consultant01;

--
-- TOC entry 693 (class 1259 OID 26384)
-- Name: ztubt_user; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_user (
    userid integer NOT NULL,
    userdisplayid character varying(50) NOT NULL,
    usergrpid integer,
    locid integer,
    name character varying(500),
    sapid character varying(50),
    emailid character varying(100),
    phone character varying(50),
    gender character varying(10),
    profilepic bytea,
    ispwdlocked boolean NOT NULL,
    ispwdhardreset boolean,
    departmentid integer,
    application character varying(50) NOT NULL,
    startdate timestamp without time zone NOT NULL,
    enddate timestamp without time zone
);


ALTER TABLE public.ztubt_user OWNER TO consultant01;

--
-- TOC entry 694 (class 1259 OID 26390)
-- Name: ztubt_validatedbetticket; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_validatedbetticket (
    tranheaderid character varying(50) NOT NULL,
    requestid character varying(33) NOT NULL,
    ticketserialnumber character varying(200) NOT NULL,
    validationdate timestamp without time zone NOT NULL,
    cartid character varying(50) NOT NULL,
    validationtypeid character varying(4),
    amount numeric(16,2),
    tickettransactionid character varying(200),
    exchangetranheaderid character varying(50),
    winningamount numeric(16,2),
    rebateamount numeric(16,2),
    refundamount numeric(16,2),
    rebatereclaim numeric(16,2),
    uniqueid character varying(200),
    createdvalidationdate timestamp without time zone,
    prodid integer NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    firstentrymethodid character varying(10)
);


ALTER TABLE public.ztubt_validatedbetticket OWNER TO consultant01;

--
-- TOC entry 695 (class 1259 OID 26396)
-- Name: ztubt_validatedbetticket_del; Type: TABLE; Schema: public; Owner: sp_postgres
--

CREATE TABLE public.ztubt_validatedbetticket_del (
    tranheaderid character varying(50),
    requestid character varying(33),
    ticketserialnumber character varying(200),
    validationdate timestamp without time zone,
    cartid character varying(50),
    validationtypeid character varying(4),
    amount numeric(16,2),
    tickettransactionid character varying(200),
    exchangetranheaderid character varying(50),
    winningamount numeric(16,2),
    rebateamount numeric(16,2),
    refundamount numeric(16,2),
    rebatereclaim numeric(16,2),
    uniqueid character varying(200),
    createdvalidationdate timestamp without time zone,
    prodid integer,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    firstentrymethodid character varying(10)
);


ALTER TABLE public.ztubt_validatedbetticket_del OWNER TO sp_postgres;

--
-- TOC entry 696 (class 1259 OID 26402)
-- Name: ztubt_validatedbetticket_prd; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_validatedbetticket_prd (
    tranheaderid character varying(50),
    requestid character varying(33),
    ticketserialnumber character varying(200),
    validationdate timestamp without time zone NOT NULL,
    cartid character varying(50),
    validationtypeid character varying(4),
    amount numeric(16,2),
    tickettransactionid character varying(200),
    exchangetranheaderid character varying(50),
    winningamount numeric(16,2),
    rebateamount numeric(16,2),
    refundamount numeric(16,2),
    rebatereclaim numeric(16,2),
    uniqueid character varying(200),
    createdvalidationdate timestamp without time zone,
    prodid integer NOT NULL,
    terdisplayid character varying(100),
    userdisplayid character varying(50),
    sessionid character varying(50),
    firstentrymethodid character varying(10)
);


ALTER TABLE public.ztubt_validatedbetticket_prd OWNER TO consultant01;

--
-- TOC entry 697 (class 1259 OID 26408)
-- Name: ztubt_validatedbetticketlifecyclestate; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_validatedbetticketlifecyclestate (
    validatedbetlifecycleid character varying(50) NOT NULL,
    tranheaderid character varying(50) NOT NULL,
    betstatetypeid character varying(5) NOT NULL,
    status character varying(50) NOT NULL,
    captureddate timestamp without time zone NOT NULL,
    uuid character varying(33),
    referenceuuid character varying(33),
    viewcreateddate timestamp without time zone
);


ALTER TABLE public.ztubt_validatedbetticketlifecyclestate OWNER TO consultant01;

--
-- TOC entry 698 (class 1259 OID 26411)
-- Name: ztubt_validationtype; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.ztubt_validationtype (
    validationtypeid character varying(4) NOT NULL,
    validationname character varying(50) NOT NULL,
    validationdesc character varying(1000)
);


ALTER TABLE public.ztubt_validationtype OWNER TO consultant01;

--
-- TOC entry 944 (class 1259 OID 1855011)
-- Name: zvalation_postgres_log; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW public.zvalation_postgres_log AS
 SELECT a.session_id AS sessionid,
    a.user_name AS username,
    a.session_start_time AS sessionstarttime,
    a.session_start_time AS starttime,
    a.virtual_transaction_id AS transactionid,
    a.message AS querystring,
    'N'::text AS cancelled,
    a.database_name AS defaultdatabases
   FROM public.ztalation_postgres_log a;


ALTER TABLE public.zvalation_postgres_log OWNER TO postgres;

--
-- TOC entry 966 (class 1259 OID 1857228)
-- Name: zvalation_postgres_log_backup; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvalation_postgres_log_backup AS
 SELECT ztalation_postgres_log.session_id AS sessionid,
    ztalation_postgres_log.user_name AS username,
    ztalation_postgres_log.session_start_time AS sessionstarttime,
    ztalation_postgres_log.session_start_time AS starttime,
    ztalation_postgres_log.virtual_transaction_id AS transactionid,
    ztalation_postgres_log.message AS querystring,
    'N'::text AS cancelled,
    ztalation_postgres_log.database_name AS defaultdatabases
   FROM public.ztalation_postgres_log;


ALTER TABLE public.zvalation_postgres_log_backup OWNER TO sp_postgres;

--
-- TOC entry 967 (class 1259 OID 1857232)
-- Name: zvalation_postgres_log_test; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvalation_postgres_log_test AS
 SELECT ztalation_postgres_log_test.session_id AS sessionid,
    ztalation_postgres_log_test.user_name AS username,
    ztalation_postgres_log_test.session_start_time AS sessionstarttime,
    ztalation_postgres_log_test.session_start_time AS starttime,
    ztalation_postgres_log_test.virtual_transaction_id AS transactionid,
    ztalation_postgres_log_test.message AS querystring,
    'N'::text AS cancelled,
    ztalation_postgres_log_test.database_name AS defaultdatabases
   FROM public.ztalation_postgres_log_test;


ALTER TABLE public.zvalation_postgres_log_test OWNER TO sp_postgres;

--
-- TOC entry 699 (class 1259 OID 26417)
-- Name: zves_bigsmall_winpayables; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_bigsmall_winpayables AS
 SELECT a.productnum,
    a.drawdate,
    a.drawnumber,
    ((sum(
        CASE a.prizename
            WHEN 'SML'::text THEN (0)::bigint
            ELSE a.totalpayable
        END) / (100)::numeric))::numeric(11,2) AS bigpayable,
    ((sum(
        CASE a.prizename
            WHEN 'SML'::text THEN a.totalpayable
            ELSE (0)::bigint
        END) / (100)::numeric))::numeric(11,2) AS smallpayable
   FROM ( SELECT a_1.productnum,
            (a_1.drawcdc + '1986-05-11'::date) AS drawdate,
            a_1.winset_id,
            a_1.windiv_id,
            a_1.drawnumber,
            "left"(upper((b.przdiv_divname)::text), 3) AS prizename,
            a_1.totalamount AS totalpayable
           FROM (public.ztes_pdf_winshares a_1
             JOIN public.ztes_pdf_drawparam b ON (((a_1.productnum = b.productnum) AND (a_1.drawcdc = b.drawcdc) AND (a_1.winset_id = b.winset_id) AND (a_1.windiv_id = b.przdiv_id))))) a
  GROUP BY a.productnum, a.drawdate, a.drawnumber
  ORDER BY a.productnum, a.drawdate, a.drawnumber;


ALTER TABLE public.zves_bigsmall_winpayables OWNER TO sp_postgres;

--
-- TOC entry 998 (class 1259 OID 2075126)
-- Name: zves_findata_draw; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw AS
 SELECT b.cdc,
    b.prod,
        CASE
            WHEN ((b.prod = 23) AND ((b.totomatch_tfogflag = 0) OR (b.totomatch_tfogflag IS NULL))) THEN 't649'::text
            WHEN ((b.prod = 23) AND (b.totomatch_tfogflag = 1)) THEN 'totomatch'::text
            ELSE NULL::text
        END AS sub_prod,
    b.tratrmidn,
    b.traagt,
    b.tratyp,
    a.draws_draw,
    (b.channeltype)::text AS channeltype,
    (b.channelsubtype)::text AS channelsubtype,
    sum(((b.totamt * 5) / b.numdraws)) AS transamt,
    sum((b.saleamount0 + b.saleamount1)) AS saleamt,
    sum((b.commamount0 + b.commamount1)) AS commamt
   FROM public.ztes_mjf_draws a,
    public.ztes_mjf_journals b
  WHERE ((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (b.esaextchaninfo_terminalid IS NULL))
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draws_draw, b.channeltype, b.channelsubtype, b.totomatch_tfogflag
UNION ALL
 SELECT (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.productid AS prod,
        CASE
            WHEN ((ztrtms_trans_lottery.productid = 23) AND ((ztrtms_trans_lottery.bettypeid)::text = ANY (ARRAY['16'::text, '17'::text, '18'::text, '19'::text]))) THEN 'totomatch'::text
            WHEN ((ztrtms_trans_lottery.productid = 23) AND ((ztrtms_trans_lottery.bettypeid)::text <> ALL (ARRAY['16'::text, '17'::text, '18'::text, '19'::text]))) THEN 't649'::text
            ELSE NULL::text
        END AS sub_prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    ztrtms_trans_lottery.retailerid AS traagt,
    ztrtms_trans_lottery.transtype AS tratyp,
    ztrtms_trans_lottery.drawid AS draws_draw,
    '1'::text AS channeltype,
    '1'::text AS channelsubtype,
    sum((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2)) AS transamt,
    sum((ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2)) AS saleamt,
    sum((ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2)) AS commamt
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
  GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid,
        CASE
            WHEN ((ztrtms_trans_lottery.productid = 23) AND ((ztrtms_trans_lottery.bettypeid)::text = ANY (ARRAY['16'::text, '17'::text, '18'::text, '19'::text]))) THEN 'totomatch'::text
            WHEN ((ztrtms_trans_lottery.productid = 23) AND ((ztrtms_trans_lottery.bettypeid)::text <> ALL (ARRAY['16'::text, '17'::text, '18'::text, '19'::text]))) THEN 't649'::text
            ELSE NULL::text
        END;


ALTER TABLE public.zves_findata_draw OWNER TO sp_postgres;

--
-- TOC entry 700 (class 1259 OID 26427)
-- Name: zves_findata_draw_bak; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw_bak AS
 SELECT b.cdc,
    b.prod,
    b.tratrmidn,
    b.traagt,
    b.tratyp,
    a.draws_draw,
    sum(((b.totamt * 5) / b.numdraws)) AS transamt,
    sum((b.saleamount0 + b.saleamount1)) AS saleamt,
    sum((b.commamount0 + b.commamount1)) AS commamt
   FROM public.ztes_mjf_draws a,
    public.ztes_mjf_journals b
  WHERE ((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (b.esaextchaninfo_terminalid IS NULL))
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draws_draw
UNION ALL
 SELECT (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.productid AS prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    ztrtms_trans_lottery.retailerid AS traagt,
    ztrtms_trans_lottery.transtype AS tratyp,
    ztrtms_trans_lottery.drawid AS draws_draw,
    sum((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2)) AS transamt,
    sum((ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2)) AS saleamt,
    sum((ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2)) AS commamt
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
  GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid;


ALTER TABLE public.zves_findata_draw_bak OWNER TO sp_postgres;

--
-- TOC entry 895 (class 1259 OID 1442401)
-- Name: zves_findata_draw_bk20240604; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw_bk20240604 AS
 SELECT b.cdc,
    b.prod,
    b.tratrmidn,
    b.traagt,
    b.tratyp,
    a.draws_draw,
    sum(((b.totamt * 5) / b.numdraws)) AS transamt,
    sum((b.saleamount0 + b.saleamount1)) AS saleamt,
    sum((b.commamount0 + b.commamount1)) AS commamt
   FROM public.ztes_mjf_draws a,
    public.ztes_mjf_journals b
  WHERE ((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (b.esaextchaninfo_terminalid IS NULL))
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draws_draw
UNION ALL
 SELECT (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.productid AS prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    ztrtms_trans_lottery.retailerid AS traagt,
    ztrtms_trans_lottery.transtype AS tratyp,
    ztrtms_trans_lottery.drawid AS draws_draw,
    sum((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2)) AS transamt,
    sum((ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2)) AS saleamt,
    sum((ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2)) AS commamt
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
  GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid;


ALTER TABLE public.zves_findata_draw_bk20240604 OWNER TO sp_postgres;

--
-- TOC entry 997 (class 1259 OID 2075121)
-- Name: zves_findata_draw_bk20241010; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw_bk20241010 AS
 SELECT b.cdc,
    b.prod,
    b.tratrmidn,
    b.traagt,
    b.tratyp,
    a.draws_draw,
    (b.channeltype)::text AS channeltype,
    (b.channelsubtype)::text AS channelsubtype,
    sum(((b.totamt * 5) / b.numdraws)) AS transamt,
    sum((b.saleamount0 + b.saleamount1)) AS saleamt,
    sum((b.commamount0 + b.commamount1)) AS commamt
   FROM public.ztes_mjf_draws a,
    public.ztes_mjf_journals b
  WHERE ((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (b.esaextchaninfo_terminalid IS NULL))
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draws_draw, b.channeltype, b.channelsubtype
UNION ALL
 SELECT (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.productid AS prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    ztrtms_trans_lottery.retailerid AS traagt,
    ztrtms_trans_lottery.transtype AS tratyp,
    ztrtms_trans_lottery.drawid AS draws_draw,
    '1'::text AS channeltype,
    '1'::text AS channelsubtype,
    sum((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2)) AS transamt,
    sum((ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2)) AS saleamt,
    sum((ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2)) AS commamt
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
  GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid;


ALTER TABLE public.zves_findata_draw_bk20241010 OWNER TO sp_postgres;

--
-- TOC entry 830 (class 1259 OID 384135)
-- Name: zves_findata_draw_bkpob; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw_bkpob AS
 SELECT b.cdc,
    b.prod,
    b.tratrmidn,
    b.traagt,
    b.tratyp,
    a.draws_draw,
    sum(((b.totamt * 5) / b.numdraws)) AS transamt,
    sum((b.saleamount0 + b.saleamount1)) AS saleamt,
    sum((b.commamount0 + b.commamount1)) AS commamt
   FROM public.ztes_mjf_draws a,
    public.ztes_mjf_journals b
  WHERE ((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (b.esaextchaninfo_terminalid IS NULL) AND (((b.traagt)::character varying)::text !~~ '6688%'::text))
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draws_draw
UNION ALL
 SELECT (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.productid AS prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    ztrtms_trans_lottery.retailerid AS traagt,
    ztrtms_trans_lottery.transtype AS tratyp,
    ztrtms_trans_lottery.drawid AS draws_draw,
    sum((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2)) AS transamt,
    sum((ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2)) AS saleamt,
    sum((ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2)) AS commamt
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
  GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid
UNION ALL
 SELECT (b.business_date - '1986-05-11'::date) AS cdc,
    (a.product_id)::integer AS prod,
        CASE
            WHEN ((a.channel)::text = 'V'::text) THEN 66881101
            WHEN ((a.channel)::text = 'I'::text) THEN 66881201
            WHEN ((a.channel)::text = 'M'::text) THEN 66881301
            ELSE NULL::integer
        END AS tratrmidn,
        CASE
            WHEN ((a.channel)::text = 'V'::text) THEN 668811
            WHEN ((a.channel)::text = 'I'::text) THEN 668812
            WHEN ((a.channel)::text = 'M'::text) THEN 668813
            ELSE NULL::integer
        END AS traagt,
    1 AS tratyp,
    a.es_draw_no AS draws_draw,
    sum((a.total_stake * (100)::numeric)) AS transamt,
    sum((a.sales_amount * (100)::numeric)) AS saleamt,
    0 AS commamt
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday b ON ((((a.system)::text = (b.system)::text) AND (a.creation_date_business_id = b.business_id) AND ((b.system)::text = 'OB'::text))))
  WHERE ((a.ob_status)::text = 'A'::text)
  GROUP BY b.business_date, a.product_id, a.channel, a.es_draw_no;


ALTER TABLE public.zves_findata_draw_bkpob OWNER TO sp_postgres;

--
-- TOC entry 701 (class 1259 OID 26432)
-- Name: zves_findata_draw_digibc; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw_digibc AS
 SELECT (ztrtms2_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms2_trans_lottery.productid AS prod,
    ztrtms2_trans_lottery.terminalid AS tratrmidn,
    ztrtms2_trans_lottery.retailerid AS traagt,
    ztrtms2_trans_lottery.transtype AS tratyp,
    ztrtms2_trans_lottery.drawid AS draws_draw,
    sum((ztrtms2_trans_lottery.wager1 + ztrtms2_trans_lottery.wager2)) AS transamt,
    sum((ztrtms2_trans_lottery.sales1 + ztrtms2_trans_lottery.sales2)) AS saleamt,
    sum((ztrtms2_trans_lottery.salescomm1 + ztrtms2_trans_lottery.salescomm2)) AS commamt
   FROM public.ztrtms2_trans_lottery
  WHERE (ztrtms2_trans_lottery.transtype = ANY (ARRAY[1, 2]))
  GROUP BY ztrtms2_trans_lottery.busdate, ztrtms2_trans_lottery.productid, ztrtms2_trans_lottery.terminalid, ztrtms2_trans_lottery.retailerid, ztrtms2_trans_lottery.transtype, ztrtms2_trans_lottery.drawid;


ALTER TABLE public.zves_findata_draw_digibc OWNER TO sp_postgres;

--
-- TOC entry 884 (class 1259 OID 1337168)
-- Name: zves_findata_draw_lsr_hds_bk20240508; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw_lsr_hds_bk20240508 AS
 SELECT b.cdc,
    b.prod,
    b.tratrmidn,
    b.traagt,
    b.tratyp,
    a.draws_draw,
    b.channeltype,
    b.channelsubtype,
    sum((((b.totamt)::double precision * (5)::double precision) / (b.numdraws)::double precision)) AS transamt,
    sum((b.saleamount0 + b.saleamount1)) AS saleamt,
    sum((b.commamount0 + b.commamount1)) AS commamt
   FROM public.ztes_mjf_draws a,
    public.ztes_mjf_journals_lsr_hds2 b
  WHERE (((a.cdc)::double precision = (b.cdc)::double precision) AND ((a.journaladdress)::double precision = (b.journaladdress)::double precision) AND (b.esaextchaninfo_terminalid IS NULL) AND (b.tratyp <> ALL (ARRAY[3, 9])))
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draws_draw, b.channeltype, b.channelsubtype
UNION ALL
 SELECT (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.productid AS prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    ztrtms_trans_lottery.retailerid AS traagt,
    ztrtms_trans_lottery.transtype AS tratyp,
    ztrtms_trans_lottery.drawid AS draws_draw,
    1 AS channeltype,
    1 AS channelsubtype,
    sum((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2)) AS transamt,
    sum((ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2)) AS saleamt,
    sum((ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2)) AS commamt
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
  GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid, 1::integer
UNION ALL
 SELECT b.cdc,
    b.prod,
    (b.tratrmidn)::bigint AS tratrmidn,
    (b.traagt)::bigint AS traagt,
    b.tratyp,
    a.draw AS draws_draw,
    b.channeltype,
    b.channelsubtype,
    sum(a.amount) AS transamt,
    sum(a.amount) AS saleamt,
    0 AS commamt
   FROM (public.ztes_mjf_windtl_lsr_hds2 a
     JOIN public.ztes_mjf_journals_lsr_hds2 b ON (((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress))))
  WHERE ((a.refflg)::text = 'T'::text)
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draw, b.channeltype, b.channelsubtype
UNION ALL
 SELECT b.cdc,
    b.prod,
    (b.tratrmidn)::bigint AS tratrmidn,
    (b.traagt)::bigint AS traagt,
    b.tratyp,
    a.draw AS draws_draw,
    b.channeltype,
    b.channelsubtype,
    sum(a.amount) AS transamt,
    sum(a.amount) AS saleamt,
    0 AS commamt
   FROM (public.ztes_mjf_winnereftdetail_lsr_hds_bk a
     JOIN public.ztes_mjf_journals_lsr_hds2 b ON (((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress))))
  WHERE ((a.refflg)::text = 'T'::text)
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draw, b.channeltype, b.channelsubtype;


ALTER TABLE public.zves_findata_draw_lsr_hds_bk20240508 OWNER TO sp_postgres;

--
-- TOC entry 702 (class 1259 OID 26437)
-- Name: zves_findata_draw_recon; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw_recon AS
 SELECT b.cdc,
    b.prod,
    b.tratrmidn,
    b.traagt,
    b.tratyp,
    a.draws_draw,
    sum(((b.totamt * 5) / b.numdraws)) AS transamt,
    sum((b.saleamount0 + b.saleamount1)) AS saleamt,
    sum((b.commamount0 + b.commamount1)) AS commamt,
    'ES'::text AS channel
   FROM public.ztes_mjf_draws a,
    public.ztes_mjf_journals b
  WHERE ((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (b.esaextchaninfo_terminalid IS NULL))
  GROUP BY b.cdc, b.prod, b.tratrmidn, b.traagt, b.tratyp, a.draws_draw
UNION ALL
 SELECT (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.productid AS prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    ztrtms_trans_lottery.retailerid AS traagt,
    ztrtms_trans_lottery.transtype AS tratyp,
    ztrtms_trans_lottery.drawid AS draws_draw,
    sum((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2)) AS transamt,
    sum((ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2)) AS saleamt,
    sum((ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2)) AS commamt,
    'RTMS'::text AS channel
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
  GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid;


ALTER TABLE public.zves_findata_draw_recon OWNER TO sp_postgres;

--
-- TOC entry 703 (class 1259 OID 26442)
-- Name: zves_findata_draw_recon_host; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_findata_draw_recon_host AS
 SELECT b.cdc,
    b.prod,
    b.tratrmidn,
    b.traagt,
    b.tratyp,
    a.draws_draw,
    ((b.totamt * 5) / b.numdraws) AS transamt,
    (b.saleamount0 + b.saleamount1) AS saleamt,
    (b.commamount0 + b.commamount1) AS commamt,
    b.esaextchaninfo_foreignserial,
    b.esaextchaninfo_terminalid
   FROM public.ztes_mjf_draws a,
    public.ztes_mjf_journals b
  WHERE ((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress));


ALTER TABLE public.zves_findata_draw_recon_host OWNER TO sp_postgres;

--
-- TOC entry 829 (class 1259 OID 363172)
-- Name: zves_findata_draw_sweep; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW public.zves_findata_draw_sweep AS
 WITH collsweep AS (
         SELECT (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
            (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS wagcdc,
            ztrtms_trans_lottery.productid AS prod,
            ztrtms_trans_lottery.terminalid AS tratrmidn,
            ztrtms_trans_lottery.retailerid AS traagt,
            ztrtms_trans_lottery.transtype AS tratyp,
            ztrtms_trans_lottery.drawid AS draws_draw,
            sum((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2)) AS transamt,
            sum((ztrtms_trans_lottery.sales1 + ztrtms_trans_lottery.sales2)) AS saleamt,
            sum((ztrtms_trans_lottery.salescomm1 + ztrtms_trans_lottery.salescomm2)) AS commamt
           FROM public.ztrtms_trans_lottery
          WHERE ((ztrtms_trans_lottery.transtype = 1) AND (ztrtms_trans_lottery.productid = 11))
          GROUP BY ztrtms_trans_lottery.busdate, ztrtms_trans_lottery.productid, ztrtms_trans_lottery.terminalid, ztrtms_trans_lottery.retailerid, ztrtms_trans_lottery.transtype, ztrtms_trans_lottery.drawid
        ), cansweep_raw AS (
         SELECT can.busdate,
            wag.busdate AS wagbusdate,
            can.productid AS prod,
            can.terminalid AS tratrmidn,
            can.retailerid AS traagt,
            can.transtype AS tratyp,
            can.drawid AS draws_draw,
            (can.wager1 + can.wager2) AS transamt,
            (can.sales1 + can.sales2) AS saleamt,
            (can.salescomm1 + can.salescomm2) AS commamt
           FROM (public.ztrtms_trans_lottery can
             JOIN public.ztrtms_trans_lottery wag ON ((((wag.transheaderid)::text = (can.transheaderid)::text) AND ("right"((wag.boardid)::text, 2) = "right"((can.boardid)::text, 2)) AND (wag.drawid = can.drawid))))
          WHERE ((can.transtype = 2) AND (can.productid = 11) AND (wag.transtype = 1))
        ), cansweep AS (
         SELECT (cansweep_raw.busdate - '1986-05-11'::date) AS cdc,
            (cansweep_raw.wagbusdate - '1986-05-11'::date) AS wagcdc,
            cansweep_raw.prod,
            cansweep_raw.tratrmidn,
            cansweep_raw.traagt,
            cansweep_raw.tratyp,
            cansweep_raw.draws_draw,
            sum(cansweep_raw.transamt) AS transamt,
            sum(cansweep_raw.saleamt) AS saleamt,
            sum(cansweep_raw.commamt) AS commamt
           FROM cansweep_raw
          GROUP BY cansweep_raw.busdate, cansweep_raw.wagbusdate, cansweep_raw.prod, cansweep_raw.tratrmidn, cansweep_raw.traagt, cansweep_raw.tratyp, cansweep_raw.draws_draw
        )
 SELECT collsweep.cdc,
    collsweep.wagcdc,
    collsweep.prod,
    collsweep.tratrmidn,
    collsweep.traagt,
    collsweep.tratyp,
    collsweep.draws_draw,
    collsweep.transamt,
    collsweep.saleamt,
    collsweep.commamt,
        CASE
            WHEN (collsweep.wagcdc < 13323) THEN 0.07
            WHEN (collsweep.wagcdc >= 13323) THEN 0.08
            ELSE NULL::numeric
        END AS gst,
        CASE
            WHEN (collsweep.wagcdc < 13323) THEN ((0.07)::double precision * collsweep.commamt)
            WHEN (collsweep.wagcdc >= 13323) THEN ((0.08)::double precision * collsweep.commamt)
            ELSE NULL::double precision
        END AS gstcommamt
   FROM collsweep
UNION ALL
 SELECT cansweep.cdc,
    cansweep.wagcdc,
    cansweep.prod,
    cansweep.tratrmidn,
    cansweep.traagt,
    cansweep.tratyp,
    cansweep.draws_draw,
    cansweep.transamt,
    cansweep.saleamt,
    cansweep.commamt,
        CASE
            WHEN (cansweep.wagcdc < 13323) THEN 0.07
            WHEN (cansweep.wagcdc >= 13323) THEN 0.08
            ELSE NULL::numeric
        END AS gst,
        CASE
            WHEN (cansweep.wagcdc < 13323) THEN ((0.07)::double precision * cansweep.commamt)
            WHEN (cansweep.wagcdc >= 13323) THEN ((0.08)::double precision * cansweep.commamt)
            ELSE NULL::double precision
        END AS gstcommamt
   FROM cansweep;


ALTER TABLE public.zves_findata_draw_sweep OWNER TO postgres;

--
-- TOC entry 704 (class 1259 OID 26447)
-- Name: zves_mjf_valid; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_mjf_valid AS
 SELECT a.journaladdress,
    a.cdc,
    a.draw,
    a.id,
    b.serial,
    b.prod,
    b.tratrmidn,
    b.tratlr,
    b.traagt,
    b.tratim,
    b.tratyp,
    b.trasub,
    b.trares,
    b.validatinginfo_exchanged,
    b.validatinginfo_cashed,
    b.validatinginfo_refunded,
    b.validatinginfo_inquiry,
    b.validatinginfo_confirmed,
    b.validatinginfo_claimreq,
    b.validatinginfo_onbehalf,
    b.validatinginfo_type,
    b.validatinginfo_oldsys,
    b.validatinginfo_cdc,
    b.validatinginfo_sellter,
    b.validatinginfo_lstwincdc,
    b.validatinginfo_serial,
    b.validatinginfo_excser,
    b.validatinginfo_sellagt,
    b.validatinginfo_lastdraw,
    b.validatinginfo_forteller,
    b.validatinginfo_reqtrmidn,
    b.partialwininf_syndid,
    b.partialwininf_syndrecid,
    b.partialwininf_syndnumparts,
    b.partialwininf_syndtotparts,
    a.casflg,
    a.expflg,
    a.eftflg,
    a.winset,
    a.division,
    a.game,
    a.winloadcdc,
    a.expcdc,
    a.amount,
    a.bettyp,
    a.cashcdc,
    a.validationcomm
   FROM (public.ztes_mjf_windtl a
     LEFT JOIN public.ztes_mjf_journals b ON (((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress))));


ALTER TABLE public.zves_mjf_valid OWNER TO sp_postgres;

--
-- TOC entry 705 (class 1259 OID 26452)
-- Name: zves_mjf_wagcan; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_mjf_wagcan AS
 SELECT (a.journaladdress)::character varying AS journaladdress,
    a.cdc,
    c.draws_draw,
    (a.board_id)::character varying AS board_id,
    (d.serial)::character varying AS serial,
    d.prod,
    d.tratrmidn,
    (d.tratlr)::character varying AS tratlr,
    d.traagt,
    d.tratim,
    d.tratyp,
    d.trasub,
    d.trares,
    d.nbrbrds,
    d.totamt,
    d.tktchg,
    d.begdrw,
    d.enddrw,
    d.numdraws,
    d.fracwagerinfo_numfrac,
    d.fracwagerinfo_fracnum,
    d.partialwagerinfo_syndid,
    d.partialwagerinfo_syndrecid,
    d.partialwagerinfo_syndnumparts,
    d.partialwagerinfo_syndtotparts,
    a.transamt0,
    a.transamt1,
    a.salesamt0,
    a.salesamt1,
    a.commamt0,
    a.commamt1,
    a.nbrsmp,
    a.basamt0,
    a.basamt1,
    a.basamt2,
    a.actamt0,
    a.actamt1,
    a.actamt2,
    a.qpmrks,
    (a.bettyp)::character varying AS bettyp,
    a.betcls,
    a.nbrmrks,
    a.reduced0,
    a.reduced1,
    a.reduced2,
    b.board_desc,
    d.hdr_stats,
    (d.bulkprintval)::character varying AS bulkprintval,
    ''::text AS bulkprintinfo_type,
    ''::text AS bulkprintinfo_totalbulkprint,
    ''::text AS bulkprintinfo_header,
    ''::text AS bulkprintinfo_blocknum,
    ''::text AS bulkprintinfo_startbrdnum,
    ''::text AS bulkprintinfo_lastbrdnum,
    d.ebetslipinfo_mobnbr,
    d.ebetslipinfo_reservedata1,
    d.ebetslipinfo_reservedata2,
    d.ebetslipinfo_reservedata3,
    d.ebetslipinfo_reservedata4,
    (d.esaextchaninfo_foreignserial)::character varying AS esaextchaninfo_foreignserial
   FROM (((public.ztes_mjf_brdinf a
     JOIN public.ztes_mjf_brdnums b ON (((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (a.board_id = b.board_id))))
     LEFT JOIN public.ztes_mjf_draws c ON (((a.cdc = c.cdc) AND (a.journaladdress = c.journaladdress))))
     LEFT JOIN public.ztes_mjf_journals d ON (((a.cdc = d.cdc) AND (a.journaladdress = d.journaladdress))))
  WHERE (d.esaextchaninfo_foreignserial IS NULL)
UNION ALL
 SELECT ztrtms_trans_lottery.uuid AS journaladdress,
    (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.drawid AS draws_draw,
    ztrtms_trans_lottery.boardid AS board_id,
    ztrtms_trans_lottery.transheaderid AS serial,
    ztrtms_trans_lottery.productid AS prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    upper((ztrtms_trans_lottery.userid)::text) AS tratlr,
    ztrtms_trans_lottery.retailerid AS traagt,
    (date_part('epoch'::text, ztrtms_trans_lottery.transtimestamp))::integer AS tratim,
    ztrtms_trans_lottery.transtype AS tratyp,
    NULL::integer AS trasub,
    NULL::integer AS trares,
    ztrtms_trans_lottery.numboards AS nbrbrds,
        CASE
            WHEN (ztrtms_trans_lottery.grptotoparts IS NOT NULL) THEN ((((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2) * (ztrtms_trans_lottery.grptotoparts)::double precision) * (ztrtms_trans_lottery.numdraws)::double precision) * (ztrtms_trans_lottery.numboards)::double precision)
            ELSE (((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2) * (ztrtms_trans_lottery.numdraws)::double precision) * (ztrtms_trans_lottery.numboards)::double precision)
        END AS totamt,
    NULL::integer AS tktchg,
    NULL::integer AS begdrw,
    NULL::integer AS enddrw,
    ztrtms_trans_lottery.numdraws,
    ztrtms_trans_lottery.grptotoparts AS fracwagerinfo_numfrac,
    NULL::integer AS fracwagerinfo_fracnum,
    NULL::integer AS partialwagerinfo_syndid,
    NULL::integer AS partialwagerinfo_syndrecid,
    ztrtms_trans_lottery.itotoparts AS partialwagerinfo_syndnumparts,
    ztrtms_trans_lottery.itotototalparts AS partialwagerinfo_syndtotparts,
    ztrtms_trans_lottery.wager1 AS transamt0,
    ztrtms_trans_lottery.wager2 AS transamt1,
    ztrtms_trans_lottery.sales1 AS salesamt0,
    ztrtms_trans_lottery.sales2 AS salesamt1,
    ztrtms_trans_lottery.salescomm1 AS commamt0,
    ztrtms_trans_lottery.salescomm2 AS commamt1,
    ztrtms_trans_lottery.numsimplebets AS nbrsmp,
    NULL::integer AS basamt0,
    NULL::integer AS basamt1,
    NULL::integer AS basamt2,
    NULL::integer AS actamt0,
    NULL::integer AS actamt1,
    NULL::integer AS actamt2,
    ztrtms_trans_lottery.qpflag AS qpmrks,
    ztrtms_trans_lottery.bettypeid AS bettyp,
    NULL::integer AS betcls,
    ztrtms_trans_lottery.nummarks AS nbrmrks,
    NULL::integer AS reduced0,
    NULL::integer AS reduced1,
    NULL::integer AS reduced2,
    ztrtms_trans_lottery.selection AS board_desc,
        CASE
            WHEN (ztrtms_trans_lottery.ebetslipdeviceid IS NULL) THEN ztrtms_trans_lottery.entrymethod
            ELSE 16
        END AS hdr_stats,
    ztrtms_trans_lottery.bulkid AS bulkprintval,
    NULL::text AS bulkprintinfo_type,
    NULL::text AS bulkprintinfo_totalbulkprint,
    NULL::text AS bulkprintinfo_header,
    NULL::text AS bulkprintinfo_blocknum,
    NULL::text AS bulkprintinfo_startbrdnum,
    NULL::text AS bulkprintinfo_lastbrdnum,
    ztrtms_trans_lottery.ebetslipdeviceid AS ebetslipinfo_mobnbr,
    NULL::character varying AS ebetslipinfo_reservedata1,
    NULL::character varying AS ebetslipinfo_reservedata2,
    NULL::character varying AS ebetslipinfo_reservedata3,
    NULL::character varying AS ebetslipinfo_reservedata4,
    ztrtms_trans_lottery.uuid AS esaextchaninfo_foreignserial
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
UNION ALL
 SELECT ztrtms2_trans_lottery.uuid AS journaladdress,
    (ztrtms2_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms2_trans_lottery.drawid AS draws_draw,
    ztrtms2_trans_lottery.boardid AS board_id,
    ztrtms2_trans_lottery.transheaderid AS serial,
    ztrtms2_trans_lottery.productid AS prod,
    ztrtms2_trans_lottery.terminalid AS tratrmidn,
    upper((ztrtms2_trans_lottery.userid)::text) AS tratlr,
    ztrtms2_trans_lottery.retailerid AS traagt,
    (date_part('epoch'::text, ztrtms2_trans_lottery.transtimestamp))::integer AS tratim,
    ztrtms2_trans_lottery.transtype AS tratyp,
    NULL::integer AS trasub,
    NULL::integer AS trares,
    ztrtms2_trans_lottery.numboards AS nbrbrds,
        CASE
            WHEN (ztrtms2_trans_lottery.grptotoparts IS NOT NULL) THEN ((((ztrtms2_trans_lottery.wager1 + ztrtms2_trans_lottery.wager2) * (ztrtms2_trans_lottery.grptotoparts)::double precision) * (ztrtms2_trans_lottery.numdraws)::double precision) * (ztrtms2_trans_lottery.numboards)::double precision)
            ELSE (((ztrtms2_trans_lottery.wager1 + ztrtms2_trans_lottery.wager2) * (ztrtms2_trans_lottery.numdraws)::double precision) * (ztrtms2_trans_lottery.numboards)::double precision)
        END AS totamt,
    NULL::integer AS tktchg,
    NULL::integer AS begdrw,
    NULL::integer AS enddrw,
    ztrtms2_trans_lottery.numdraws,
    ztrtms2_trans_lottery.grptotoparts AS fracwagerinfo_numfrac,
    NULL::integer AS fracwagerinfo_fracnum,
    NULL::integer AS partialwagerinfo_syndid,
    NULL::integer AS partialwagerinfo_syndrecid,
    ztrtms2_trans_lottery.itotoparts AS partialwagerinfo_syndnumparts,
    ztrtms2_trans_lottery.itotototalparts AS partialwagerinfo_syndtotparts,
    ztrtms2_trans_lottery.wager1 AS transamt0,
    ztrtms2_trans_lottery.wager2 AS transamt1,
    ztrtms2_trans_lottery.sales1 AS salesamt0,
    ztrtms2_trans_lottery.sales2 AS salesamt1,
    ztrtms2_trans_lottery.salescomm1 AS commamt0,
    ztrtms2_trans_lottery.salescomm2 AS commamt1,
    ztrtms2_trans_lottery.numsimplebets AS nbrsmp,
    NULL::integer AS basamt0,
    NULL::integer AS basamt1,
    NULL::integer AS basamt2,
    NULL::integer AS actamt0,
    NULL::integer AS actamt1,
    NULL::integer AS actamt2,
    ztrtms2_trans_lottery.qpflag AS qpmrks,
    ztrtms2_trans_lottery.bettypeid AS bettyp,
    NULL::integer AS betcls,
    ztrtms2_trans_lottery.nummarks AS nbrmrks,
    NULL::integer AS reduced0,
    NULL::integer AS reduced1,
    NULL::integer AS reduced2,
    ztrtms2_trans_lottery.selection AS board_desc,
    ztrtms2_trans_lottery.entrymethod AS hdr_stats,
    ztrtms2_trans_lottery.bulkid AS bulkprintval,
    NULL::text AS bulkprintinfo_type,
    NULL::text AS bulkprintinfo_totalbulkprint,
    NULL::text AS bulkprintinfo_header,
    NULL::text AS bulkprintinfo_blocknum,
    NULL::text AS bulkprintinfo_startbrdnum,
    NULL::text AS bulkprintinfo_lastbrdnum,
    ztrtms2_trans_lottery.mobnbr AS ebetslipinfo_mobnbr,
    NULL::character varying AS ebetslipinfo_reservedata1,
    NULL::character varying AS ebetslipinfo_reservedata2,
    NULL::character varying AS ebetslipinfo_reservedata3,
    NULL::character varying AS ebetslipinfo_reservedata4,
    ztrtms2_trans_lottery.uuid AS esaextchaninfo_foreignserial
   FROM public.ztrtms2_trans_lottery
  WHERE (ztrtms2_trans_lottery.transtype = ANY (ARRAY[1, 2]));


ALTER TABLE public.zves_mjf_wagcan OWNER TO sp_postgres;

--
-- TOC entry 706 (class 1259 OID 26457)
-- Name: zves_mjf_wagcan_digibc; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_mjf_wagcan_digibc AS
 SELECT (a.journaladdress)::character varying AS journaladdress,
    a.cdc,
    c.draws_draw,
    (a.board_id)::character varying AS board_id,
    (d.serial)::character varying AS serial,
    d.prod,
    d.tratrmidn,
    (d.tratlr)::character varying AS tratlr,
    d.traagt,
    d.tratim,
    d.tratyp,
    d.trasub,
    d.trares,
    d.nbrbrds,
    d.totamt,
    d.tktchg,
    d.begdrw,
    d.enddrw,
    d.numdraws,
    d.fracwagerinfo_numfrac,
    d.fracwagerinfo_fracnum,
    d.partialwagerinfo_syndid,
    d.partialwagerinfo_syndrecid,
    d.partialwagerinfo_syndnumparts,
    d.partialwagerinfo_syndtotparts,
    a.transamt0,
    a.transamt1,
    a.salesamt0,
    a.salesamt1,
    a.commamt0,
    a.commamt1,
    a.nbrsmp,
    a.basamt0,
    a.basamt1,
    a.basamt2,
    a.actamt0,
    a.actamt1,
    a.actamt2,
    a.qpmrks,
    (a.bettyp)::character varying AS bettyp,
    a.betcls,
    a.nbrmrks,
    a.reduced0,
    a.reduced1,
    a.reduced2,
    b.board_desc,
    d.hdr_stats,
    (d.bulkprintval)::character varying AS bulkprintval,
    ''::text AS bulkprintinfo_type,
    ''::text AS bulkprintinfo_totalbulkprint,
    ''::text AS bulkprintinfo_header,
    ''::text AS bulkprintinfo_blocknum,
    ''::text AS bulkprintinfo_startbrdnum,
    ''::text AS bulkprintinfo_lastbrdnum,
    d.ebetslipinfo_mobnbr,
    d.ebetslipinfo_reservedata1,
    d.ebetslipinfo_reservedata2,
    d.ebetslipinfo_reservedata3,
    d.ebetslipinfo_reservedata4,
    (d.esaextchaninfo_foreignserial)::character varying AS esaextchaninfo_foreignserial
   FROM (((public.ztes_mjf_brdinf a
     JOIN public.ztes_mjf_brdnums b ON (((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (a.board_id = b.board_id))))
     LEFT JOIN public.ztes_mjf_draws c ON (((a.cdc = c.cdc) AND (a.journaladdress = c.journaladdress))))
     LEFT JOIN public.ztes_mjf_journals d ON (((a.cdc = d.cdc) AND (a.journaladdress = d.journaladdress))))
  WHERE (d.esaextchaninfo_foreignserial IS NULL)
UNION ALL
 SELECT ztrtms_trans_lottery.uuid AS journaladdress,
    (ztrtms_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms_trans_lottery.drawid AS draws_draw,
    ztrtms_trans_lottery.boardid AS board_id,
    ztrtms_trans_lottery.transheaderid AS serial,
    ztrtms_trans_lottery.productid AS prod,
    ztrtms_trans_lottery.terminalid AS tratrmidn,
    upper((ztrtms_trans_lottery.userid)::text) AS tratlr,
    ztrtms_trans_lottery.retailerid AS traagt,
    (date_part('epoch'::text, ztrtms_trans_lottery.transtimestamp))::integer AS tratim,
    ztrtms_trans_lottery.transtype AS tratyp,
    NULL::integer AS trasub,
    NULL::integer AS trares,
    ztrtms_trans_lottery.numboards AS nbrbrds,
        CASE
            WHEN (ztrtms_trans_lottery.grptotoparts IS NOT NULL) THEN ((((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2) * (ztrtms_trans_lottery.grptotoparts)::double precision) * (ztrtms_trans_lottery.numdraws)::double precision) * (ztrtms_trans_lottery.numboards)::double precision)
            ELSE (((ztrtms_trans_lottery.wager1 + ztrtms_trans_lottery.wager2) * (ztrtms_trans_lottery.numdraws)::double precision) * (ztrtms_trans_lottery.numboards)::double precision)
        END AS totamt,
    NULL::integer AS tktchg,
    NULL::integer AS begdrw,
    NULL::integer AS enddrw,
    ztrtms_trans_lottery.numdraws,
    ztrtms_trans_lottery.grptotoparts AS fracwagerinfo_numfrac,
    NULL::integer AS fracwagerinfo_fracnum,
    NULL::integer AS partialwagerinfo_syndid,
    NULL::integer AS partialwagerinfo_syndrecid,
    ztrtms_trans_lottery.itotoparts AS partialwagerinfo_syndnumparts,
    ztrtms_trans_lottery.itotototalparts AS partialwagerinfo_syndtotparts,
    ztrtms_trans_lottery.wager1 AS transamt0,
    ztrtms_trans_lottery.wager2 AS transamt1,
    ztrtms_trans_lottery.sales1 AS salesamt0,
    ztrtms_trans_lottery.sales2 AS salesamt1,
    ztrtms_trans_lottery.salescomm1 AS commamt0,
    ztrtms_trans_lottery.salescomm2 AS commamt1,
    ztrtms_trans_lottery.numsimplebets AS nbrsmp,
    NULL::integer AS basamt0,
    NULL::integer AS basamt1,
    NULL::integer AS basamt2,
    NULL::integer AS actamt0,
    NULL::integer AS actamt1,
    NULL::integer AS actamt2,
    ztrtms_trans_lottery.qpflag AS qpmrks,
    ztrtms_trans_lottery.bettypeid AS bettyp,
    NULL::integer AS betcls,
    ztrtms_trans_lottery.nummarks AS nbrmrks,
    NULL::integer AS reduced0,
    NULL::integer AS reduced1,
    NULL::integer AS reduced2,
    ztrtms_trans_lottery.selection AS board_desc,
        CASE
            WHEN (ztrtms_trans_lottery.ebetslipdeviceid IS NULL) THEN ztrtms_trans_lottery.entrymethod
            ELSE 16
        END AS hdr_stats,
    ztrtms_trans_lottery.bulkid AS bulkprintval,
    NULL::text AS bulkprintinfo_type,
    NULL::text AS bulkprintinfo_totalbulkprint,
    NULL::text AS bulkprintinfo_header,
    NULL::text AS bulkprintinfo_blocknum,
    NULL::text AS bulkprintinfo_startbrdnum,
    NULL::text AS bulkprintinfo_lastbrdnum,
    ztrtms_trans_lottery.ebetslipdeviceid AS ebetslipinfo_mobnbr,
    NULL::character varying AS ebetslipinfo_reservedata1,
    NULL::character varying AS ebetslipinfo_reservedata2,
    NULL::character varying AS ebetslipinfo_reservedata3,
    NULL::character varying AS ebetslipinfo_reservedata4,
    ztrtms_trans_lottery.uuid AS esaextchaninfo_foreignserial
   FROM public.ztrtms_trans_lottery
  WHERE (ztrtms_trans_lottery.transtype = ANY (ARRAY[1, 2]))
UNION ALL
 SELECT ztrtms2_trans_lottery.uuid AS journaladdress,
    (ztrtms2_trans_lottery.busdate - '1986-05-11'::date) AS cdc,
    ztrtms2_trans_lottery.drawid AS draws_draw,
    ztrtms2_trans_lottery.boardid AS board_id,
    ztrtms2_trans_lottery.transheaderid AS serial,
    ztrtms2_trans_lottery.productid AS prod,
    ztrtms2_trans_lottery.terminalid AS tratrmidn,
    upper((ztrtms2_trans_lottery.userid)::text) AS tratlr,
    ztrtms2_trans_lottery.retailerid AS traagt,
    (date_part('epoch'::text, ztrtms2_trans_lottery.transtimestamp))::integer AS tratim,
    ztrtms2_trans_lottery.transtype AS tratyp,
    NULL::integer AS trasub,
    NULL::integer AS trares,
    ztrtms2_trans_lottery.numboards AS nbrbrds,
        CASE
            WHEN (ztrtms2_trans_lottery.grptotoparts IS NOT NULL) THEN ((((ztrtms2_trans_lottery.wager1 + ztrtms2_trans_lottery.wager2) * (ztrtms2_trans_lottery.grptotoparts)::double precision) * (ztrtms2_trans_lottery.numdraws)::double precision) * (ztrtms2_trans_lottery.numboards)::double precision)
            ELSE (((ztrtms2_trans_lottery.wager1 + ztrtms2_trans_lottery.wager2) * (ztrtms2_trans_lottery.numdraws)::double precision) * (ztrtms2_trans_lottery.numboards)::double precision)
        END AS totamt,
    NULL::integer AS tktchg,
    NULL::integer AS begdrw,
    NULL::integer AS enddrw,
    ztrtms2_trans_lottery.numdraws,
    ztrtms2_trans_lottery.grptotoparts AS fracwagerinfo_numfrac,
    NULL::integer AS fracwagerinfo_fracnum,
    NULL::integer AS partialwagerinfo_syndid,
    NULL::integer AS partialwagerinfo_syndrecid,
    ztrtms2_trans_lottery.itotoparts AS partialwagerinfo_syndnumparts,
    ztrtms2_trans_lottery.itotototalparts AS partialwagerinfo_syndtotparts,
    ztrtms2_trans_lottery.wager1 AS transamt0,
    ztrtms2_trans_lottery.wager2 AS transamt1,
    ztrtms2_trans_lottery.sales1 AS salesamt0,
    ztrtms2_trans_lottery.sales2 AS salesamt1,
    ztrtms2_trans_lottery.salescomm1 AS commamt0,
    ztrtms2_trans_lottery.salescomm2 AS commamt1,
    ztrtms2_trans_lottery.numsimplebets AS nbrsmp,
    NULL::integer AS basamt0,
    NULL::integer AS basamt1,
    NULL::integer AS basamt2,
    NULL::integer AS actamt0,
    NULL::integer AS actamt1,
    NULL::integer AS actamt2,
    ztrtms2_trans_lottery.qpflag AS qpmrks,
    ztrtms2_trans_lottery.bettypeid AS bettyp,
    NULL::integer AS betcls,
    ztrtms2_trans_lottery.nummarks AS nbrmrks,
    NULL::integer AS reduced0,
    NULL::integer AS reduced1,
    NULL::integer AS reduced2,
    ztrtms2_trans_lottery.selection AS board_desc,
    ztrtms2_trans_lottery.entrymethod AS hdr_stats,
    ztrtms2_trans_lottery.bulkid AS bulkprintval,
    NULL::text AS bulkprintinfo_type,
    NULL::text AS bulkprintinfo_totalbulkprint,
    NULL::text AS bulkprintinfo_header,
    NULL::text AS bulkprintinfo_blocknum,
    NULL::text AS bulkprintinfo_startbrdnum,
    NULL::text AS bulkprintinfo_lastbrdnum,
    ztrtms2_trans_lottery.mobnbr AS ebetslipinfo_mobnbr,
    NULL::character varying AS ebetslipinfo_reservedata1,
    NULL::character varying AS ebetslipinfo_reservedata2,
    NULL::character varying AS ebetslipinfo_reservedata3,
    NULL::character varying AS ebetslipinfo_reservedata4,
    ztrtms2_trans_lottery.uuid AS esaextchaninfo_foreignserial
   FROM public.ztrtms2_trans_lottery
  WHERE (ztrtms2_trans_lottery.transtype = ANY (ARRAY[1, 2]));


ALTER TABLE public.zves_mjf_wagcan_digibc OWNER TO sp_postgres;

--
-- TOC entry 707 (class 1259 OID 26462)
-- Name: zves_mjf_wagcan_es; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_mjf_wagcan_es AS
 SELECT (a.journaladdress)::character varying AS journaladdress,
    a.cdc,
    c.draws_draw,
    (a.board_id)::character varying AS board_id,
    (d.serial)::character varying AS serial,
    d.prod,
    d.tratrmidn,
    (d.tratlr)::character varying AS tratlr,
    d.traagt,
    d.tratim,
    d.tratyp,
    d.trasub,
    d.trares,
    d.nbrbrds,
    d.totamt,
    d.tktchg,
    d.begdrw,
    d.enddrw,
    d.numdraws,
    d.fracwagerinfo_numfrac,
    d.fracwagerinfo_fracnum,
    d.partialwagerinfo_syndid,
    d.partialwagerinfo_syndrecid,
    d.partialwagerinfo_syndnumparts,
    d.partialwagerinfo_syndtotparts,
    a.transamt0,
    a.transamt1,
    a.salesamt0,
    a.salesamt1,
    a.commamt0,
    a.commamt1,
    a.nbrsmp,
    a.basamt0,
    a.basamt1,
    a.basamt2,
    a.actamt0,
    a.actamt1,
    a.actamt2,
    a.qpmrks,
    (a.bettyp)::character varying AS bettyp,
    a.betcls,
    a.nbrmrks,
    a.reduced0,
    a.reduced1,
    a.reduced2,
    b.board_desc,
    d.hdr_stats,
    (d.bulkprintval)::character varying AS bulkprintval,
    ''::text AS bulkprintinfo_type,
    ''::text AS bulkprintinfo_totalbulkprint,
    ''::text AS bulkprintinfo_header,
    ''::text AS bulkprintinfo_blocknum,
    ''::text AS bulkprintinfo_startbrdnum,
    ''::text AS bulkprintinfo_lastbrdnum,
    d.ebetslipinfo_mobnbr,
    d.ebetslipinfo_reservedata1,
    d.ebetslipinfo_reservedata2,
    d.ebetslipinfo_reservedata3,
    d.ebetslipinfo_reservedata4,
    (d.esaextchaninfo_foreignserial)::character varying AS esaextchaninfo_foreignserial
   FROM (((public.ztes_mjf_brdinf a
     JOIN public.ztes_mjf_brdnums b ON (((a.cdc = b.cdc) AND (a.journaladdress = b.journaladdress) AND (a.board_id = b.board_id))))
     LEFT JOIN public.ztes_mjf_draws c ON (((a.cdc = c.cdc) AND (a.journaladdress = c.journaladdress))))
     LEFT JOIN public.ztes_mjf_journals d ON (((a.cdc = d.cdc) AND (a.journaladdress = d.journaladdress))));


ALTER TABLE public.zves_mjf_wagcan_es OWNER TO sp_postgres;

--
-- TOC entry 708 (class 1259 OID 26467)
-- Name: zves_ret_signonoff; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zves_ret_signonoff AS
 SELECT to_char(('1986-05-11'::date + ('1 day'::interval * (a.cdc)::double precision)), 'yyyyMMdd'::text) AS business_date,
    a.cdc,
    a.tratrmidn AS terminal_id,
    a.traagt AS retailer_id,
    ('1970-01-01'::date + ('00:00:01'::interval * (sum(a.firsttrans))::double precision)) AS sign_on_timestamp,
    ('1970-01-01'::date + ('00:00:01'::interval * (sum(a.lasttrans))::double precision)) AS sign_off_timestamp,
    to_char(('1970-01-01'::date + ('00:00:01'::interval * (sum(a.firsttrans))::double precision)), 'yyyyMMdd'::text) AS sign_on_date,
    to_char(('1970-01-01'::date + ('00:00:01'::interval * (sum(a.lasttrans))::double precision)), 'yyyyMMdd'::text) AS sign_off_date,
    to_char(('1970-01-01'::date + ('00:00:01'::interval * (sum(a.firsttrans))::double precision)), 'HH24MISS'::text) AS sign_on_time,
    to_char(('1970-01-01'::date + ('00:00:01'::interval * (sum(a.lasttrans))::double precision)), 'HH24MISS'::text) AS sign_off_time,
    ('1970-01-01'::date + ('00:00:01'::interval * (sum(a.firstsale))::double precision)) AS first_sale_timestamp,
    ('1970-01-01'::date + ('00:00:01'::interval * (sum(a.lastsale))::double precision)) AS last_sale_timestamp,
    to_char(('1970-01-01'::date + ('00:00:01'::interval * (sum(a.firstsale))::double precision)), 'yyyyMMdd'::text) AS first_sale_date,
    to_char(('1970-01-01'::date + ('00:00:01'::interval * (sum(a.lastsale))::double precision)), 'yyyyMMdd'::text) AS last_sale_date,
    to_char(('1970-01-01'::date + ('00:00:01'::interval * (sum(a.firstsale))::double precision)), 'HH24MISS'::text) AS first_sale_time,
    to_char(('1970-01-01'::date + ('00:00:01'::interval * (sum(a.lastsale))::double precision)), 'HH24MISS'::text) AS last_sale_time
   FROM ( SELECT ztes_mjf_journals.cdc,
            ztes_mjf_journals.tratrmidn,
            ztes_mjf_journals.traagt,
            min(ztes_mjf_journals.tratim) AS firsttrans,
            max(ztes_mjf_journals.tratim) AS lasttrans,
            NULL::bigint AS firstsale,
            NULL::bigint AS lastsale
           FROM public.ztes_mjf_journals
          GROUP BY ztes_mjf_journals.cdc, ztes_mjf_journals.tratrmidn, ztes_mjf_journals.traagt
        UNION ALL
         SELECT ztes_mjf_journals.cdc,
            ztes_mjf_journals.tratrmidn,
            ztes_mjf_journals.traagt,
            NULL::bigint AS firsttrans,
            NULL::bigint AS lasttrans,
            min(ztes_mjf_journals.tratim) AS firstsale,
            max(ztes_mjf_journals.tratim) AS lastsale
           FROM public.ztes_mjf_journals
          WHERE (ztes_mjf_journals.tratyp = 1)
          GROUP BY ztes_mjf_journals.cdc, ztes_mjf_journals.tratrmidn, ztes_mjf_journals.traagt) a
  GROUP BY a.cdc, a.tratrmidn, a.traagt
  ORDER BY a.cdc, a.tratrmidn, a.traagt;


ALTER TABLE public.zves_ret_signonoff OWNER TO sp_postgres;

--
-- TOC entry 709 (class 1259 OID 26472)
-- Name: zvkyc_branch; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_branch AS
 SELECT a.id AS appid,
    a.customeraccountnum AS custaccno,
    h.createdtime AS branchdatetime,
    h.agentid AS branchid,
    h.action AS branchaction,
    h.actionremarks AS branchremarks
   FROM (public.ztkyc_applications a
     JOIN public.ztkyc_applicationstatushistory h ON (((a.id = h.applicationid) AND (h.roleid = 2))));


ALTER TABLE public.zvkyc_branch OWNER TO sp_postgres;

--
-- TOC entry 710 (class 1259 OID 26477)
-- Name: zvkyc_branch_masked; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_branch_masked AS
 SELECT a.id AS appid,
    a.customeraccountnum AS custaccno,
    h.createdtime AS branchdatetime,
    h.agentid AS branchid,
    h.action AS branchaction
   FROM (public.ztkyc_applications a
     JOIN public.ztkyc_applicationstatushistory h ON (((a.id = h.applicationid) AND (h.roleid = 2))));


ALTER TABLE public.zvkyc_branch_masked OWNER TO sp_postgres;

--
-- TOC entry 711 (class 1259 OID 26482)
-- Name: zvkyc_calldurationhistory; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_calldurationhistory AS
 SELECT h.applicationid,
    a.customeraccountnum AS custaccno,
    h.createdtime,
    h.lastupdatedbyid,
    h.customerwaitingduration,
    h.videocallduration,
    h.csohandlingduration,
    h.osinfo,
    h.browserinfo,
    h.action,
    h.actionremarks
   FROM (public.ztkyc_applicationdurationhistory h
     JOIN public.ztkyc_applications a ON ((a.id = h.applicationid)));


ALTER TABLE public.zvkyc_calldurationhistory OWNER TO sp_postgres;

--
-- TOC entry 712 (class 1259 OID 26487)
-- Name: zvkyc_calldurationhistory_masked; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_calldurationhistory_masked AS
 SELECT h.applicationid,
    a.customeraccountnum AS custaccno,
    h.createdtime,
    h.lastupdatedbyid,
    h.customerwaitingduration,
    h.videocallduration,
    h.csohandlingduration,
    h.osinfo,
    h.browserinfo,
    h.action
   FROM (public.ztkyc_applicationdurationhistory h
     JOIN public.ztkyc_applications a ON ((a.id = h.applicationid)));


ALTER TABLE public.zvkyc_calldurationhistory_masked OWNER TO sp_postgres;

--
-- TOC entry 713 (class 1259 OID 26492)
-- Name: zvkyc_checker; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_checker AS
 SELECT mh.id AS mhid,
    ch.id AS chid,
    a.id AS appid,
    a.customeraccountnum AS custaccno,
    mh.createdtime AS branchmakerdatetime,
    r2.role AS branchmakerrole,
    mh.action AS branchmakeraction,
    mh.actionremarks AS branchmakerremarks,
    ch.createdtime AS checkerdatetime,
    ch.agentid AS checkerid,
    ch.action AS checkeraction,
    ch.actionremarks AS checkerremarks,
    rank() OVER (PARTITION BY ch.id ORDER BY mh.id DESC) AS checker_rank
   FROM ((((public.ztkyc_applications a
     JOIN public.ztkyc_applicationstatushistory ch ON (((ch.applicationid = a.id) AND (ch.roleid = 4))))
     JOIN public.ztkyc_applicationstatushistory mh ON (((a.id = mh.applicationid) AND (mh.roleid = ANY (ARRAY[2, 3])))))
     JOIN public.ztkyc_role r ON ((ch.roleid = r.id)))
     JOIN public.ztkyc_role r2 ON (((mh.roleid = r2.id) AND (ch.id > mh.id))));


ALTER TABLE public.zvkyc_checker OWNER TO sp_postgres;

--
-- TOC entry 714 (class 1259 OID 26497)
-- Name: zvkyc_checker_masked; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_checker_masked AS
 SELECT mh.id AS mhid,
    ch.id AS chid,
    a.id AS appid,
    a.customeraccountnum AS custaccno,
    mh.createdtime AS branchmakerdatetime,
    r2.role AS branchmakerrole,
    mh.action AS branchmakeraction,
    mh.actionremarks AS branchmakerremarks,
    ch.createdtime AS checkerdatetime,
    ch.agentid AS checkerid,
    ch.action AS checkeraction,
    rank() OVER (PARTITION BY ch.id ORDER BY mh.id DESC) AS checker_rank
   FROM ((((public.ztkyc_applications a
     JOIN public.ztkyc_applicationstatushistory ch ON (((ch.applicationid = a.id) AND (ch.roleid = 4))))
     JOIN public.ztkyc_applicationstatushistory mh ON (((a.id = mh.applicationid) AND (mh.roleid = ANY (ARRAY[2, 3])))))
     JOIN public.ztkyc_role r ON ((ch.roleid = r.id)))
     JOIN public.ztkyc_role r2 ON (((mh.roleid = r2.id) AND (ch.id > mh.id))));


ALTER TABLE public.zvkyc_checker_masked OWNER TO sp_postgres;

--
-- TOC entry 715 (class 1259 OID 26502)
-- Name: zvkyc_kyclocation; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_kyclocation AS
 SELECT a.id AS appid,
    a.customeraccountnum,
    b.id AS l2_id,
    br.role AS l2_role,
    b.action AS l2_action,
    b.createdtime AS l2_createdtime,
    c.id AS l1_id,
    cr.role AS l1_role,
    c.action AS l1_action,
    c.createdtime AS l1_createdtime,
    rank() OVER (PARTITION BY b.id ORDER BY c.id DESC) AS l1_rank,
    b.lastupdatedtime
   FROM ((((public.ztkyc_applications a
     JOIN public.ztkyc_applicationstatushistory b ON (((a.id = b.applicationid) AND (b.roleid = 4) AND ((b.action)::text = 'Approved'::text))))
     JOIN public.ztkyc_applicationstatushistory c ON (((a.id = c.applicationid) AND (c.roleid = ANY (ARRAY[2, 3])) AND ((c.action)::text = ANY (ARRAY[('Passed'::character varying)::text, ('Failed'::character varying)::text])))))
     JOIN public.ztkyc_role br ON ((b.roleid = br.id)))
     JOIN public.ztkyc_role cr ON ((c.roleid = cr.id)));


ALTER TABLE public.zvkyc_kyclocation OWNER TO sp_postgres;

--
-- TOC entry 716 (class 1259 OID 26507)
-- Name: zvkyc_maker; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_maker AS
 SELECT a.id AS appid,
    a.customeraccountnum AS custaccno,
    h.createdtime AS makerdatetime,
    h.agentid AS makerid,
    h.action AS makeraction,
    h.actionremarks AS makerremarks
   FROM (public.ztkyc_applications a
     JOIN public.ztkyc_applicationstatushistory h ON (((a.id = h.applicationid) AND (h.roleid = 3))));


ALTER TABLE public.zvkyc_maker OWNER TO sp_postgres;

--
-- TOC entry 717 (class 1259 OID 26512)
-- Name: zvkyc_maker_masked; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvkyc_maker_masked AS
 SELECT a.id AS appid,
    a.customeraccountnum AS custaccno,
    h.createdtime AS makerdatetime,
    h.agentid AS makerid,
    h.action AS makeraction
   FROM (public.ztkyc_applications a
     JOIN public.ztkyc_applicationstatushistory h ON (((a.id = h.applicationid) AND (h.roleid = 3))));


ALTER TABLE public.zvkyc_maker_masked OWNER TO sp_postgres;

--
-- TOC entry 718 (class 1259 OID 26517)
-- Name: zvob_customer_activation_date; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_customer_activation_date AS
 SELECT c.account_no,
    cf.cleared_date
   FROM (public.ztob_customer c
     LEFT JOIN ( SELECT ztob_custstatusflag.account_no,
            max(ztob_custstatusflag.cleared_date) AS cleared_date
           FROM public.ztob_custstatusflag
          WHERE (((ztob_custstatusflag.status_flag_tag)::text = ANY (ARRAY[('KYCFAIL'::character varying)::text, ('KYCPEND'::character varying)::text, ('EXEXCHFAIL'::character varying)::text, ('EXEXCHPEND'::character varying)::text, ('BKGDCHFAIL'::character varying)::text, ('BKGDCHPEND'::character varying)::text, ('STOP'::character varying)::text, ('TNC'::character varying)::text, ('NOSPDLIMIT'::character varying)::text, ('NODEPLIMIT'::character varying)::text])) AND ((ztob_custstatusflag.status)::text = 'S'::text))
          GROUP BY ztob_custstatusflag.account_no) cf ON ((((c.account_no)::text = (cf.account_no)::text) AND ((c.account_no)::text ~~ '00%'::text))))
  WHERE (((c.account_no)::text ~~ '00%'::text) AND ((c.status)::text = 'A'::text) AND (c.activation_date IS NOT NULL) AND (NOT (EXISTS ( SELECT cf_1.account_no,
            cf_1.cust_flag_id,
            cf_1.status_flag_tag,
            cf_1.status,
            cf_1.reason,
            cf_1.username_set_flag,
            cf_1.username_cleared_flag,
            cf_1.created_date,
            cf_1.cleared_date,
            cf_1.last_updated_date,
            cf_1.created_date_business_id,
            cf_1.cleared_date_business_id,
            cf_1.system
           FROM public.ztob_custstatusflag cf_1
          WHERE (((c.account_no)::text = (cf_1.account_no)::text) AND ((cf_1.status_flag_tag)::text = ANY (ARRAY[('KYCFAIL'::character varying)::text, ('KYCPEND'::character varying)::text, ('EXEXCHFAIL'::character varying)::text, ('EXEXCHPEND'::character varying)::text, ('BKGDCHFAIL'::character varying)::text, ('BKGDCHPEND'::character varying)::text, ('STOP'::character varying)::text, ('TNC'::character varying)::text, ('NOSPDLIMIT'::character varying)::text, ('NODEPLIMIT'::character varying)::text])) AND ((cf_1.status)::text = 'A'::text))))))
UNION
 SELECT c.account_no,
    cf.cleared_date
   FROM (public.ztob_customer c
     LEFT JOIN ( SELECT ztob_custstatusflag.account_no,
            max(ztob_custstatusflag.cleared_date) AS cleared_date
           FROM public.ztob_custstatusflag
          WHERE (((ztob_custstatusflag.status_flag_tag)::text = ANY (ARRAY[('KYCFAIL'::character varying)::text, ('KYCPEND'::character varying)::text, ('EXEXCHFAIL'::character varying)::text, ('EXEXCHPEND'::character varying)::text, ('BKGDCHFAIL'::character varying)::text, ('BKGDCHPEND'::character varying)::text, ('STOP'::character varying)::text, ('PWORD'::character varying)::text, ('TNC'::character varying)::text, ('NOSPDLIMIT'::character varying)::text, ('NODEPLIMIT'::character varying)::text])) AND ((ztob_custstatusflag.status)::text = 'S'::text))
          GROUP BY ztob_custstatusflag.account_no) cf ON ((((c.account_no)::text = (cf.account_no)::text) AND (NOT ((c.account_no)::text ~~ '00%'::text)))))
  WHERE ((NOT ((c.account_no)::text ~~ '00%'::text)) AND ((c.status)::text = 'A'::text) AND (c.activation_date IS NOT NULL) AND (NOT (EXISTS ( SELECT cf_1.account_no,
            cf_1.cust_flag_id,
            cf_1.status_flag_tag,
            cf_1.status,
            cf_1.reason,
            cf_1.username_set_flag,
            cf_1.username_cleared_flag,
            cf_1.created_date,
            cf_1.cleared_date,
            cf_1.last_updated_date,
            cf_1.created_date_business_id,
            cf_1.cleared_date_business_id,
            cf_1.system
           FROM public.ztob_custstatusflag cf_1
          WHERE (((c.account_no)::text = (cf_1.account_no)::text) AND ((cf_1.status_flag_tag)::text = ANY (ARRAY[('KYCFAIL'::character varying)::text, ('KYCPEND'::character varying)::text, ('EXEXCHFAIL'::character varying)::text, ('EXEXCHPEND'::character varying)::text, ('BKGDCHFAIL'::character varying)::text, ('BKGDCHPEND'::character varying)::text, ('STOP'::character varying)::text, ('PWORD'::character varying)::text, ('TNC'::character varying)::text, ('NOSPDLIMIT'::character varying)::text, ('NODEPLIMIT'::character varying)::text])) AND ((cf_1.status)::text = 'A'::text))))));


ALTER TABLE public.zvob_customer_activation_date OWNER TO sp_postgres;

--
-- TOC entry 719 (class 1259 OID 26522)
-- Name: zvob_customerbackgroundinfo; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_customerbackgroundinfo AS
 SELECT ztob_customer.account_no,
        CASE
            WHEN ((ztob_customer.gender)::text = 'M'::text) THEN 'MALE'::text
            ELSE 'FEMALE'::text
        END AS gender,
    ztob_customer.dob AS date_of_birth,
    ztob_customer.nationality,
    ztob_customer.addr_postcode AS postal_code,
    ztob_customer.income_min,
    ztob_customer.income_max,
    ztob_customer.industry_name AS industry,
    ztob_customer.occupation_name AS occupation,
    ztob_customer.creation_date AS opening_date,
    ztob_customer.status AS current_status,
    ztob_customer.last_updated_date
   FROM public.ztob_customer;


ALTER TABLE public.zvob_customerbackgroundinfo OWNER TO sp_postgres;

--
-- TOC entry 720 (class 1259 OID 26527)
-- Name: zvob_lottery_active_bet; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_lottery_active_bet AS
 SELECT a.ccy_code,
    a.bet_id,
    b.business_date,
    a.creation_date_d,
    a.creation_date_t,
    a.account_no,
    a.ob_status,
    a.bet_type,
    a.betslip_id,
    a.bet_name,
    a.channel,
    a.es_draw_no,
    a.draw_date_d,
    a.draw_date_t,
        CASE
            WHEN ((a.auto_pick)::text = 'Y'::text) THEN 0
            ELSE 1
        END AS auto_pick,
    a.es_syndicate_id,
    a.es_syndicate_name,
    a.es_syndicate_parts,
    a.product_id,
    a.total_stake,
    a.bet_stake_1,
    a.bet_stake_2,
    a.sales_amount AS sales,
    a.gst_amount AS gst,
    a.returns,
    a.winnings,
    a.picks,
    a.type_stake_1,
    a.type_stake_2,
    a.unit_stake_1,
    a.unit_stake_2,
    a.syndicate_parts
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday b ON ((((a.system)::text = (b.system)::text) AND (a.creation_date_business_id = b.business_id))))
  WHERE (((a.ob_status)::text = 'A'::text) AND ((b.system)::text = 'OB'::text));


ALTER TABLE public.zvob_lottery_active_bet OWNER TO sp_postgres;

--
-- TOC entry 721 (class 1259 OID 26532)
-- Name: zvob_lottery_cancel_bet; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_lottery_cancel_bet AS
 SELECT a.ccy_code,
    a.bet_id,
    bd.business_date,
    a.settled_date_d,
    a.settled_date_t,
    a.creation_date_d,
    a.creation_date_t,
    a.account_no,
    a.ob_status,
    a.bet_type,
    a.betslip_id,
    a.bet_name,
    a.channel,
    a.es_draw_no,
    a.draw_date_d,
    a.draw_date_t,
        CASE
            WHEN ((a.auto_pick)::text = 'Y'::text) THEN 0
            ELSE 1
        END AS auto_pick,
    a.es_syndicate_id,
    a.es_syndicate_name,
    a.es_syndicate_parts,
    a.product_id,
    a.total_stake,
    a.bet_stake_1,
    a.bet_stake_2,
    a.sales_amount AS sales,
    a.gst_amount AS gst,
    a.returns,
    a.winnings,
    a.picks,
    a.type_stake_1,
    a.type_stake_2,
    a.unit_stake_1,
    a.unit_stake_2,
    a.syndicate_parts
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday bd ON (((a.settled_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
  WHERE (((bd.system)::text = 'OB'::text) AND ((a.ob_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text));


ALTER TABLE public.zvob_lottery_cancel_bet OWNER TO sp_postgres;

--
-- TOC entry 722 (class 1259 OID 26537)
-- Name: zvob_lottery_monthly_bettype_cancel; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_lottery_monthly_bettype_cancel AS
 SELECT a.settled_date_d,
    bd.business_date,
    a.account_no,
    a.channel,
    a.product_id,
    a.bet_type,
    a.bet_name,
    count(DISTINCT a.bet_id) AS betcount,
    sum(a.total_stake) AS stake,
    sum(a.sales_amount) AS sales,
    sum(a.gst_amount) AS gst
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday bd ON ((((a.system)::text = (bd.system)::text) AND (a.settled_date_business_id = bd.business_id))))
  WHERE (((a.ob_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.settled_date_d, bd.business_date, a.account_no, a.channel, a.product_id, a.bet_type, a.bet_name;


ALTER TABLE public.zvob_lottery_monthly_bettype_cancel OWNER TO sp_postgres;

--
-- TOC entry 723 (class 1259 OID 26542)
-- Name: zvob_lottery_monthly_bettype_wager; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_lottery_monthly_bettype_wager AS
 SELECT a.creation_date_d,
    bd.business_date,
    a.account_no,
    a.channel,
    a.product_id,
    a.bet_type,
    a.bet_name,
    count(DISTINCT a.bet_id) AS betcount,
    sum(a.total_stake) AS stake,
    sum(a.sales_amount) AS sales,
    sum(a.gst_amount) AS gst
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday bd ON (((a.creation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
  WHERE (((((a.ob_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.ob_status)::text = 'A'::text)) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.creation_date_d, bd.business_date, a.account_no, a.channel, a.product_id, a.bet_type, a.bet_name;


ALTER TABLE public.zvob_lottery_monthly_bettype_wager OWNER TO sp_postgres;

--
-- TOC entry 724 (class 1259 OID 26547)
-- Name: zvob_lottery_monthlyrpt_cancel; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_lottery_monthlyrpt_cancel AS
 SELECT a.settled_date_d,
    bd.business_date,
    a.account_no,
    a.channel,
    a.product_id,
    count(DISTINCT a.bet_id) AS betcount,
    sum(a.total_stake) AS stake,
    sum(a.sales_amount) AS sales,
    sum(a.gst_amount) AS gst
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday bd ON (((a.settled_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
  WHERE (((a.ob_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.settled_date_d, bd.business_date, a.account_no, a.channel, a.product_id;


ALTER TABLE public.zvob_lottery_monthlyrpt_cancel OWNER TO sp_postgres;

--
-- TOC entry 725 (class 1259 OID 26552)
-- Name: zvob_lottery_monthlyrpt_valid; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_lottery_monthlyrpt_valid AS
 SELECT a.valid_date_d,
    bd.business_date,
    a.account_no,
    a.channel,
    a.product_id,
    count(DISTINCT a.bet_id) AS betcount,
    sum(a.returns) AS returns,
    sum(a.winnings) AS winnings
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday bd ON (((a.valid_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
  WHERE (((a.ob_status)::text = 'A'::text) AND (a.valid_date_d IS NOT NULL) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.valid_date_d, bd.business_date, a.account_no, a.channel, a.product_id;


ALTER TABLE public.zvob_lottery_monthlyrpt_valid OWNER TO sp_postgres;

--
-- TOC entry 726 (class 1259 OID 26557)
-- Name: zvob_lottery_monthlyrpt_wager; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_lottery_monthlyrpt_wager AS
 SELECT a.creation_date_d,
    bd.business_date,
    a.account_no,
    a.channel,
    a.product_id,
    count(DISTINCT a.bet_id) AS betcount,
    sum(a.total_stake) AS stake,
    sum(a.sales_amount) AS sales,
    sum(a.gst_amount) AS gst
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday bd ON (((a.creation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
  WHERE (((((a.ob_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.ob_status)::text = 'A'::text)) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.creation_date_d, bd.business_date, a.account_no, a.channel, a.product_id;


ALTER TABLE public.zvob_lottery_monthlyrpt_wager OWNER TO sp_postgres;

--
-- TOC entry 727 (class 1259 OID 26562)
-- Name: zvob_lottery_valid_bet; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_lottery_valid_bet AS
 SELECT a.ccy_code,
    a.bet_id,
    bd.business_date,
    a.valid_date_d,
    a.valid_date_t,
    a.settled_date_d,
    a.settled_date_t,
    a.creation_date_d,
    a.creation_date_t,
    a.account_no,
    a.ob_status,
    a.bet_type,
    a.betslip_id,
    a.bet_name,
    a.channel,
    a.es_draw_no,
    a.draw_date_d,
    a.draw_date_t,
        CASE
            WHEN ((a.auto_pick)::text = 'Y'::text) THEN 0
            ELSE 1
        END AS auto_pick,
    a.es_syndicate_id,
    a.es_syndicate_name,
    a.es_syndicate_parts,
    a.product_id,
    a.total_stake,
    a.bet_stake_1,
    a.bet_stake_2,
    a.sales_amount AS sales,
    a.gst_amount AS gst,
    a.returns,
    a.winnings,
    a.picks,
    a.type_stake_1,
    a.type_stake_2,
    a.unit_stake_1,
    a.unit_stake_2,
    a.syndicate_parts
   FROM (public.ztob_lottery a
     JOIN public.ztall_businessday bd ON (((a.valid_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
  WHERE (((a.ob_status)::text = 'A'::text) AND (a.valid_date_d IS NOT NULL) AND ((bd.system)::text = 'OB'::text));


ALTER TABLE public.zvob_lottery_valid_bet OWNER TO sp_postgres;

--
-- TOC entry 728 (class 1259 OID 26567)
-- Name: zvob_sports_active_bet; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_active_bet AS
 SELECT a.ccy_code,
    a.bet_id,
    a.creation_date_d,
    bd.business_date,
    a.creation_date_t,
    a.match_id,
    ( SELECT tt.sports_type
           FROM public.ztob_timetable tt
          WHERE (a.match_id = tt.match_id)) AS product_id,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.place_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.place_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    a.leg_no,
    a.bet_type,
    a.bir,
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.stake
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.stake / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.stake / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.stake / (4)::numeric)
            ELSE a.stake
        END AS stake,
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.sales
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.sales / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.sales / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.sales / (4)::numeric)
            ELSE a.sales
        END AS sales,
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.gst
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.gst / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.gst / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.gst / (4)::numeric)
            ELSE a.gst
        END AS gst,
    a.place_terminal_code,
    a.opening_odds,
    a.closing_odds,
    a.selected_odds,
    a.market_no,
    a.market_name,
    a.selection_name,
    a.multiple_bet,
    a.selection_id,
    a.collect_terminal_code,
    a.ext_trans_id,
    a.market_id,
    a.place_teller_id,
    a.collect_teller_id
   FROM (public.ztob_sportbets a
     JOIN public.ztall_businessday bd ON ((((a.system)::text = (bd.system)::text) AND (a.creation_date_business_id = bd.business_id))))
  WHERE (((a.bet_status)::text = 'A'::text) AND ((bd.system)::text = 'OB'::text));


ALTER TABLE public.zvob_sports_active_bet OWNER TO sp_postgres;

--
-- TOC entry 729 (class 1259 OID 26572)
-- Name: zvob_sports_cancel; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_cancel AS
 SELECT (to_timestamp(((a.last_settled_date_d || ' '::text) || a.last_settled_date_t), 'yyyy-mm-dd hh24:mi:ss'::text))::timestamp without time zone AS settled_timestamp,
    a.last_settled_date_d AS business_day,
    a.match_id,
    a.account_no,
    a.channel,
    a.bet_type,
    a.bir,
    a.selected_odds,
    a.market_name,
    a.multiple_bet,
    sum(a.settled_stake) AS wager,
    sum(a.settled_sales) AS sales,
    sum(a.settled_gst) AS gst,
    count(DISTINCT a.bet_id) AS bet_count,
    2 AS transactiontype
   FROM public.ztob_sportbetssettled a
  WHERE (((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text))
  GROUP BY ((to_timestamp(((a.last_settled_date_d || ' '::text) || a.last_settled_date_t), 'yyyy-mm-dd hh24:mi:ss'::text))::timestamp without time zone), a.last_settled_date_d, a.match_id, a.account_no, a.channel, a.bet_type, a.bir, a.selected_odds, a.market_name, a.multiple_bet;


ALTER TABLE public.zvob_sports_cancel OWNER TO sp_postgres;

--
-- TOC entry 730 (class 1259 OID 26577)
-- Name: zvob_sports_cancel_bet; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_cancel_bet AS
 SELECT a.ccy_code,
    a.bet_id,
    a.last_settled_date_d,
    bd.business_date,
    a.last_settled_date_t,
    a.match_id,
    tt.sports_type AS product_id,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.place_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.place_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    a.leg_no,
    a.bet_type,
    a.bir,
    a.settled_stake,
    a.settled_sales,
    a.settled_gst,
    a.opening_odds,
    a.closing_odds,
    a.selected_odds,
    a.market_no,
    a.market_name,
    a.selection_name,
    a.multiple_bet,
    a.selection_id,
    a.place_terminal_code,
    a.collect_terminal_code,
    a.ext_trans_id,
    a.market_id,
    a.place_teller_id,
    a.collect_teller_id
   FROM ((public.ztob_sportbetssettled a
     JOIN public.ztall_businessday bd ON (((a.last_settled_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text) AND ((bd.system)::text = 'OB'::text));


ALTER TABLE public.zvob_sports_cancel_bet OWNER TO sp_postgres;

--
-- TOC entry 731 (class 1259 OID 26582)
-- Name: zvob_sports_liab; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_liab AS
 SELECT a.bet_id,
    a.creation_date_d,
    ( SELECT bd.business_date
           FROM public.ztall_businessday bd
          WHERE ((a.creation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))) AS bet_business_day,
    a.last_settled_date_d,
    ( SELECT bd.business_date
           FROM public.ztall_businessday bd
          WHERE ((a.last_settled_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))) AS business_day,
    a.validation_date_d,
    ( SELECT bd.business_date
           FROM public.ztall_businessday bd
          WHERE ((a.validation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))) AS valid_business_day,
    a.match_id,
    ( SELECT tt.sports_type
           FROM public.ztob_timetable tt
          WHERE (a.match_id = tt.match_id)) AS product_id,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN substr(btrim((a.account_no)::text), 5, 6)
            ELSE NULL::text
        END AS retailer_id,
    a.channel,
    a.leg_no,
    a.bet_type,
    a.leg_status,
    a.bir,
    a.settled_stake,
    a.settled_sales,
    a.settled_gst,
    a.settled_returns,
    a.opening_odds,
    a.closing_odds,
    a.selected_odds,
    a.market_name,
    a.selection_name,
    a.multiple_bet,
    a.settled_flag,
    a.last_settled_info
   FROM public.ztob_sportbetssettled a
  WHERE (((a.bet_status)::text = 'A'::text) AND ((a.leg_status)::text = ANY (ARRAY[('W'::character varying)::text, ('L'::character varying)::text])));


ALTER TABLE public.zvob_sports_liab OWNER TO sp_postgres;

--
-- TOC entry 732 (class 1259 OID 26587)
-- Name: zvob_sports_monthly_bettype_cancel; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_monthly_bettype_cancel AS
 SELECT a.last_settled_date_d,
    bd.business_date,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.place_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.place_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    tt.sports_type,
    a.market_name,
    count(DISTINCT a.bet_id) AS betcount,
    sum(a.settled_stake) AS stake,
    sum(a.settled_sales) AS sales,
    sum(a.settled_gst) AS gst
   FROM ((public.ztob_sportbetssettled a
     JOIN public.ztall_businessday bd ON (((a.last_settled_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.last_settled_date_d, bd.business_date, a.account_no, a.channel, tt.sports_type, a.market_name, a.place_terminal_code;


ALTER TABLE public.zvob_sports_monthly_bettype_cancel OWNER TO sp_postgres;

--
-- TOC entry 733 (class 1259 OID 26592)
-- Name: zvob_sports_monthly_bettype_wager; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_monthly_bettype_wager AS
 SELECT a.creation_date_d,
    bd.business_date,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.place_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.place_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    tt.sports_type,
    a.market_name,
    count(DISTINCT a.bet_id) AS betcount,
    sum(
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.stake
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.stake / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.stake / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.stake / (4)::numeric)
            ELSE NULL::numeric
        END) AS stake,
    sum(
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.sales
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.sales / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.sales / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.sales / (4)::numeric)
            ELSE NULL::numeric
        END) AS sales,
    sum(
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.gst
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.gst / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.gst / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.gst / (4)::numeric)
            ELSE NULL::numeric
        END) AS gst
   FROM ((public.ztob_sportbets a
     JOIN public.ztall_businessday bd ON (((a.creation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text)) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.creation_date_d, bd.business_date, a.account_no, a.channel, tt.sports_type, a.market_name, a.place_terminal_code;


ALTER TABLE public.zvob_sports_monthly_bettype_wager OWNER TO sp_postgres;

--
-- TOC entry 734 (class 1259 OID 26597)
-- Name: zvob_sports_monthlyrpt_cancel; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_monthlyrpt_cancel AS
 SELECT a.last_settled_date_d,
    bd.business_date,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.place_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.place_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    tt.sports_type,
    count(DISTINCT a.bet_id) AS betcount,
    sum(a.settled_stake) AS stake,
    sum(a.settled_sales) AS sales,
    sum(a.settled_gst) AS gst
   FROM ((public.ztob_sportbetssettled a
     JOIN public.ztall_businessday bd ON (((a.last_settled_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text))
  GROUP BY a.last_settled_date_d, bd.business_date, a.account_no, a.channel, tt.sports_type, a.place_terminal_code;


ALTER TABLE public.zvob_sports_monthlyrpt_cancel OWNER TO sp_postgres;

--
-- TOC entry 735 (class 1259 OID 26602)
-- Name: zvob_sports_monthlyrpt_valid; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_monthlyrpt_valid AS
 SELECT a.validation_date_d,
    bd.business_date,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.collect_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.collect_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    tt.sports_type,
    count(DISTINCT a.bet_id) AS betcount,
    sum(a.settled_returns) AS settled_returns
   FROM ((public.ztob_sportbetssettled a
     JOIN public.ztall_businessday bd ON (((a.validation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((a.bet_status)::text = 'A'::text) AND ((a.leg_status)::text = 'W'::text) AND (a.validation_date_d IS NOT NULL) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.validation_date_d, bd.business_date, a.account_no, a.channel, tt.sports_type, a.collect_terminal_code;


ALTER TABLE public.zvob_sports_monthlyrpt_valid OWNER TO sp_postgres;

--
-- TOC entry 736 (class 1259 OID 26607)
-- Name: zvob_sports_monthlyrpt_wager; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_monthlyrpt_wager AS
 SELECT a.creation_date_d,
    bd.business_date,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.place_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.place_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    tt.sports_type,
    count(DISTINCT a.bet_id) AS betcount,
    sum(
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.stake
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.stake / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.stake / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.stake / (4)::numeric)
            ELSE NULL::numeric
        END) AS stake,
    sum(
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.sales
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.sales / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.sales / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.sales / (4)::numeric)
            ELSE NULL::numeric
        END) AS sales,
    sum(
        CASE
            WHEN ((a.bet_type)::text = 'SGL'::text) THEN a.gst
            WHEN ((a.bet_type)::text = 'DBL'::text) THEN (a.gst / (2)::numeric)
            WHEN ((a.bet_type)::text = 'TBL'::text) THEN (a.gst / (3)::numeric)
            WHEN ((a.bet_type)::text = 'ACC4'::text) THEN (a.gst / (4)::numeric)
            ELSE NULL::numeric
        END) AS gst
   FROM ((public.ztob_sportbets a
     JOIN public.ztall_businessday bd ON (((a.creation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text)) AND ((bd.system)::text = 'OB'::text))
  GROUP BY a.creation_date_d, bd.business_date, a.account_no, a.channel, tt.sports_type, a.place_terminal_code;


ALTER TABLE public.zvob_sports_monthlyrpt_wager OWNER TO sp_postgres;

--
-- TOC entry 737 (class 1259 OID 26612)
-- Name: zvob_sports_r40; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_r40 AS
 SELECT tbet.account_no,
    tbet.match_id,
    tbet.market_id,
    tbet.last_settled_date_business_id,
    count(DISTINCT tbet.selection_id) AS betsel,
    ( SELECT count(*) AS count
           FROM public.ztob_timetableselections ts
          WHERE ((ts.match_id = tbet.match_id) AND (ts.market_id = tbet.market_id))) AS tsel,
    count(DISTINCT tbet.bet_id) AS count,
    sum(tbet.settled_stake) AS stake,
    sum(tbet.settled_sales) AS sales,
    sum(tbet.settled_returns) AS return
   FROM public.ztob_sportbetssettled tbet
  WHERE (((tbet.bet_status)::text = 'A'::text) AND ((tbet.bet_type)::text = 'SGL'::text) AND (NOT ((tbet.leg_status)::text = 'V'::text)) AND (tbet.market_id IS NOT NULL) AND (tbet.selection_id IS NOT NULL) AND ((tbet.channel)::text IN ( SELECT ztob_channels.channel
           FROM public.ztob_channels
          WHERE ((ztob_channels.channeltype)::text = 'Online'::text))))
  GROUP BY tbet.account_no, tbet.match_id, tbet.market_id, tbet.last_settled_date_business_id
 HAVING (count(DISTINCT tbet.selection_id) = ( SELECT count(*) AS count
           FROM public.ztob_timetableselections ts
          WHERE ((ts.match_id = tbet.match_id) AND (ts.market_id = tbet.market_id))));


ALTER TABLE public.zvob_sports_r40 OWNER TO sp_postgres;

--
-- TOC entry 738 (class 1259 OID 26617)
-- Name: zvob_sports_r40_retail; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_r40_retail AS
 SELECT tbet.account_no,
    tbet.match_id,
    tbet.market_id,
    tbet.last_settled_date_business_id,
    count(DISTINCT tbet.selection_id) AS betsel,
    ( SELECT count(*) AS count
           FROM public.ztob_timetableselections ts
          WHERE ((ts.match_id = tbet.match_id) AND (ts.market_id = tbet.market_id))) AS tsel,
    count(DISTINCT tbet.bet_id) AS count,
    sum(tbet.settled_stake) AS stake,
    sum(tbet.settled_sales) AS sales,
    sum(tbet.settled_returns) AS return
   FROM public.ztob_sportbetssettled tbet
  WHERE (((tbet.bet_status)::text = 'A'::text) AND ((tbet.bet_type)::text = 'SGL'::text) AND (NOT ((tbet.leg_status)::text = 'V'::text)) AND (tbet.market_id IS NOT NULL) AND (tbet.selection_id IS NOT NULL) AND ((tbet.channel)::text IN ( SELECT ztob_channels.channel
           FROM public.ztob_channels
          WHERE ((ztob_channels.channeltype)::text = 'Retail'::text))))
  GROUP BY tbet.account_no, tbet.match_id, tbet.market_id, tbet.last_settled_date_business_id
 HAVING (count(DISTINCT tbet.selection_id) = ( SELECT count(*) AS count
           FROM public.ztob_timetableselections ts
          WHERE ((ts.match_id = tbet.match_id) AND (ts.market_id = tbet.market_id))));


ALTER TABLE public.zvob_sports_r40_retail OWNER TO sp_postgres;

--
-- TOC entry 739 (class 1259 OID 26622)
-- Name: zvob_sports_settled; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_settled AS
 SELECT (to_timestamp(((a.last_settled_date_d || ' '::text) || a.last_settled_date_t), 'yyyy-mm-dd hh24:mi:ss'::text))::timestamp without time zone AS settled_timestamp,
    a.last_settled_date_d AS business_day,
    a.match_id,
    a.account_no,
    a.channel,
    a.bet_type,
    a.bir,
    a.selected_odds,
    a.market_name,
    a.multiple_bet,
    a.leg_status,
    sum(a.settled_stake) AS wager,
    sum(a.settled_sales) AS sales,
    sum(a.settled_gst) AS gst,
    sum(a.settled_returns) AS winnings,
    count(DISTINCT a.bet_id) AS bet_count
   FROM public.ztob_sportbetssettled a
  WHERE (((a.bet_status)::text = 'A'::text) AND ((a.leg_status)::text = ANY (ARRAY[('L'::character varying)::text, ('W'::character varying)::text])))
  GROUP BY ((to_timestamp(((a.last_settled_date_d || ' '::text) || a.last_settled_date_t), 'yyyy-mm-dd hh24:mi:ss'::text))::timestamp without time zone), a.last_settled_date_d, a.match_id, a.account_no, a.channel, a.bet_type, a.bir, a.selected_odds, a.market_name, a.multiple_bet, a.leg_status;


ALTER TABLE public.zvob_sports_settled OWNER TO sp_postgres;

--
-- TOC entry 740 (class 1259 OID 26627)
-- Name: zvob_sports_valid; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_valid AS
 SELECT (to_timestamp(((a.validation_date_d || ' '::text) || a.validation_date_t), 'yyyy-mm-dd hh24:mi:ss'::text))::timestamp without time zone AS valid_timestamp,
    a.validation_date_d AS business_day,
    a.match_id,
    a.account_no,
    a.channel,
    a.bet_type,
    a.bir,
    a.selected_odds,
    a.market_name,
    a.multiple_bet,
    sum(a.settled_stake) AS wager,
    sum(a.settled_sales) AS sales,
    sum(a.settled_gst) AS gst,
    sum(a.settled_returns) AS winnings,
    count(DISTINCT a.bet_id) AS bet_count
   FROM public.ztob_sportbetssettled a
  WHERE (((a.bet_status)::text = 'A'::text) AND ((a.leg_status)::text = 'W'::text))
  GROUP BY ((to_timestamp(((a.validation_date_d || ' '::text) || a.validation_date_t), 'yyyy-mm-dd hh24:mi:ss'::text))::timestamp without time zone), a.validation_date_d, a.match_id, a.account_no, a.channel, a.bet_type, a.bir, a.selected_odds, a.market_name, a.multiple_bet;


ALTER TABLE public.zvob_sports_valid OWNER TO sp_postgres;

--
-- TOC entry 741 (class 1259 OID 26632)
-- Name: zvob_sports_valid_bet; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_valid_bet AS
 SELECT a.ccy_code,
    a.bet_id,
    bd.business_date,
    a.creation_date_d,
    a.creation_date_t,
    a.validation_date_d,
    a.validation_date_t,
    a.last_settled_date_d,
    a.last_settled_date_t,
    a.match_id,
    tt.sports_type AS product_id,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.collect_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.collect_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    a.leg_no,
    a.bet_type,
    a.bir,
    a.leg_status,
    a.settled_stake,
    a.settled_sales,
    a.settled_gst,
    a.settled_returns,
    a.opening_odds,
    a.closing_odds,
    a.selected_odds,
    a.market_no,
    a.market_name,
    a.selection_name,
    a.multiple_bet,
    a.last_settled_info,
    a.selection_id,
    a.place_terminal_code,
    a.collect_terminal_code,
    a.ext_trans_id,
    a.market_id,
    a.place_teller_id,
    a.collect_teller_id
   FROM ((public.ztob_sportbetssettled a
     JOIN public.ztall_businessday bd ON (((a.validation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((a.bet_status)::text <> 'X'::text) AND ((a.leg_status)::text = 'W'::text) AND (a.validation_date_d IS NOT NULL) AND ((bd.system)::text = 'OB'::text));


ALTER TABLE public.zvob_sports_valid_bet OWNER TO sp_postgres;

--
-- TOC entry 856 (class 1259 OID 662081)
-- Name: zvob_sports_valid_bet_test; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW public.zvob_sports_valid_bet_test AS
 SELECT a.ccy_code,
    a.bet_id,
    bd.business_date,
    a.creation_date_d,
    a.creation_date_t,
    a.validation_date_d,
    a.validation_date_t,
    a.last_settled_date_d,
    a.last_settled_date_t,
    a.match_id,
    tt.sports_type AS product_id,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.collect_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.collect_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    a.leg_no,
    a.bet_type,
    a.bir,
    a.leg_status,
    a.settled_stake,
    a.settled_sales,
    a.settled_gst,
    a.settled_returns,
    a.opening_odds,
    a.closing_odds,
    a.selected_odds,
    a.market_no,
    a.market_name,
    a.selection_name,
    a.multiple_bet,
    a.last_settled_info,
    a.selection_id,
    a.place_terminal_code,
    a.collect_terminal_code,
    a.ext_trans_id,
    a.market_id,
    a.place_teller_id,
    a.collect_teller_id
   FROM ((public.ztob_sportbetssettled a
     JOIN public.ztall_businessday bd ON (((a.validation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((a.bet_status)::text <> 'X'::text) AND ((a.leg_status)::text = 'W'::text) AND (a.validation_date_d IS NOT NULL) AND ((bd.system)::text = 'OB'::text));


ALTER TABLE public.zvob_sports_valid_bet_test OWNER TO postgres;

--
-- TOC entry 742 (class 1259 OID 26637)
-- Name: zvob_sports_voidpaid_bet; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_voidpaid_bet AS
 SELECT a.ccy_code,
    a.bet_id,
    bd.business_date,
    a.creation_date_d,
    a.creation_date_t,
    a.validation_date_d,
    a.validation_date_t,
    a.last_settled_date_d,
    a.last_settled_date_t,
    a.match_id,
    tt.sports_type AS product_id,
    a.account_no,
        CASE
            WHEN ((a.channel)::text = 'R'::text) THEN "left"(lpad((a.collect_terminal_code)::text, 8, '0'::text), 6)
            ELSE "left"((a.collect_terminal_code)::text, 6)
        END AS retailer_id,
    a.channel,
    a.leg_no,
    a.bet_type,
    a.bir,
    a.leg_status,
    a.settled_stake,
    a.settled_sales,
    a.settled_gst,
    a.settled_returns,
    a.opening_odds,
    a.closing_odds,
    a.selected_odds,
    a.market_no,
    a.market_name,
    a.selection_name,
    a.multiple_bet,
    a.last_settled_info,
    a.selection_id,
    a.place_terminal_code,
    a.collect_terminal_code,
    a.ext_trans_id,
    a.market_id,
    a.place_teller_id,
    a.collect_teller_id
   FROM ((public.ztob_sportbetssettled a
     JOIN public.ztall_businessday bd ON (((a.validation_date_business_id = bd.business_id) AND ((a.system)::text = (bd.system)::text))))
     JOIN public.ztob_timetable tt ON ((a.match_id = tt.match_id)))
  WHERE (((a.bet_status)::text <> 'X'::text) AND ((a.leg_status)::text = 'V'::text) AND (a.validation_date_d IS NOT NULL) AND ((bd.system)::text = 'OB'::text) AND ((a.channel)::text IN ( SELECT ztob_channels.channel
           FROM public.ztob_channels
          WHERE ((ztob_channels.channeltype)::text = 'Retail'::text))));


ALTER TABLE public.zvob_sports_voidpaid_bet OWNER TO sp_postgres;

--
-- TOC entry 743 (class 1259 OID 26642)
-- Name: zvob_sports_wager; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvob_sports_wager AS
 SELECT a.business_day,
    a.match_id,
    a.account_no,
    a.channel,
    a.bet_type,
    a.bir,
    a.selected_odds,
    a.market_name,
    a.multiple_bet,
    sum(a.stake) AS wager,
    sum(a.sales) AS sales,
    sum(a.gst) AS gst,
    count(DISTINCT a.bet_id) AS bet_count,
    1 AS transactiontype
   FROM public.ztob_sportbets a
  WHERE ((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text))
  GROUP BY a.business_day, a.match_id, a.account_no, a.channel, a.bet_type, a.bir, a.selected_odds, a.market_name, a.multiple_bet;


ALTER TABLE public.zvob_sports_wager OWNER TO sp_postgres;

--
-- TOC entry 744 (class 1259 OID 26647)
-- Name: zvrtms_trans_sports_entry; Type: VIEW; Schema: public; Owner: sp_postgres
--

CREATE VIEW public.zvrtms_trans_sports_entry AS
 SELECT a.busdate,
    a.transheaderid,
    a.matchid,
    a.transtype,
    a.uuid,
    a.productid,
    a.bettypeid,
    a.selection,
    a.transtimestamp,
    a.terminalid,
    a.userid,
    a.retailerid,
    a.leaguecode,
    a.liveind,
    a.matchname,
    a.market,
    a.odds,
    a.matchstarttimestamp,
    a.wager,
    a.sales,
    a.salescomm,
    a.gst,
    a.returnamt,
    a.winning,
    a.paymentmode,
    a.cartid,
    b.entrymethod,
    a.ebetslipdeviceid
   FROM (public.ztrtms_trans_sports a
     LEFT JOIN public.ztrtms_trans_entry b ON (((a.busdate = b.busdate) AND ((a.transheaderid)::text = (b.transheaderid)::text) AND (a.transtype = b.transtype) AND (a.retailerid = b.retailerid) AND (a.productid = b.productid))));


ALTER TABLE public.zvrtms_trans_sports_entry OWNER TO sp_postgres;

--
-- TOC entry 745 (class 1259 OID 26652)
-- Name: zz_test; Type: TABLE; Schema: public; Owner: consultant01
--

CREATE TABLE public.zz_test (
    tranheaderid character varying(50),
    ct bigint
);


ALTER TABLE public.zz_test OWNER TO consultant01;

--
-- TOC entry 984 (class 1259 OID 1989577)
-- Name: chart_config_testdat; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.chart_config_testdat (
    chart_id integer NOT NULL,
    chart_name character varying(100) NOT NULL,
    sql_query text NOT NULL,
    fields text NOT NULL,
    created_date date DEFAULT CURRENT_DATE,
    updated_datetime timestamp without time zone DEFAULT CURRENT_TIMESTAMP
);


ALTER TABLE qlik.chart_config_testdat OWNER TO sp_postgres;

--
-- TOC entry 983 (class 1259 OID 1989575)
-- Name: chart_config_testdat_chart_id_seq; Type: SEQUENCE; Schema: qlik; Owner: sp_postgres
--

CREATE SEQUENCE qlik.chart_config_testdat_chart_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE qlik.chart_config_testdat_chart_id_seq OWNER TO sp_postgres;

--
-- TOC entry 8124 (class 0 OID 0)
-- Dependencies: 983
-- Name: chart_config_testdat_chart_id_seq; Type: SEQUENCE OWNED BY; Schema: qlik; Owner: sp_postgres
--

ALTER SEQUENCE qlik.chart_config_testdat_chart_id_seq OWNED BY qlik.chart_config_testdat.chart_id;


--
-- TOC entry 746 (class 1259 OID 26655)
-- Name: dim_account; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_account (
    acct_id integer NOT NULL,
    acct_fr character varying(20),
    acct_to character varying(20),
    acct_type character varying(1),
    acct_lvl1 character varying(50),
    acct_lvl2 character varying(100),
    acct_lvl3 character varying(50),
    acct_lvl4 character varying(50),
    acct_lvl5 character varying(50),
    acct_lvl6 character varying(50),
    acct_desc character varying(100),
    attribute1 character varying(200),
    attribute2 character varying(200)
);


ALTER TABLE qlik.dim_account OWNER TO sp_postgres;

--
-- TOC entry 8125 (class 0 OID 0)
-- Dependencies: 746
-- Name: COLUMN dim_account.acct_id; Type: COMMENT; Schema: qlik; Owner: sp_postgres
--

COMMENT ON COLUMN qlik.dim_account.acct_id IS 'Dim Account Primary Key to Fact_GL_Balance.Acct_Id';


--
-- TOC entry 747 (class 1259 OID 26661)
-- Name: dim_account_2021_may_27; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_account_2021_may_27 (
    acct_id integer,
    acct_fr character varying(20),
    acct_to character varying(20),
    acct_type character varying(1),
    acct_lvl1 character varying(50),
    acct_lvl2 character varying(50),
    acct_lvl3 character varying(50),
    acct_lvl4 character varying(50),
    acct_lvl5 character varying(50),
    acct_lvl6 character varying(50),
    acct_desc character varying(100),
    attribute1 character varying(200),
    attribute2 character varying(200)
);


ALTER TABLE qlik.dim_account_2021_may_27 OWNER TO sp_postgres;

--
-- TOC entry 748 (class 1259 OID 26667)
-- Name: dim_account_bckup; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_account_bckup (
    acct_id integer,
    acct_fr character varying(20),
    acct_to character varying(20),
    acct_type character varying(1),
    acct_lvl1 character varying(50),
    acct_lvl2 character varying(50),
    acct_lvl3 character varying(50),
    acct_lvl4 character varying(50),
    acct_lvl5 character varying(50),
    acct_lvl6 character varying(50),
    acct_desc character varying(100),
    attribute1 character varying(200),
    attribute2 character varying(200)
);


ALTER TABLE qlik.dim_account_bckup OWNER TO sp_postgres;

--
-- TOC entry 749 (class 1259 OID 26691)
-- Name: dim_account_prd_20210715; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_account_prd_20210715 (
    acct_id integer,
    acct_fr character varying(20),
    acct_to character varying(20),
    acct_type character varying(1),
    acct_lvl1 character varying(50),
    acct_lvl2 character varying(100),
    acct_lvl3 character varying(50),
    acct_lvl4 character varying(50),
    acct_lvl5 character varying(50),
    acct_lvl6 character varying(50),
    acct_desc character varying(100),
    attribute1 character varying(200),
    attribute2 character varying(200)
);


ALTER TABLE qlik.dim_account_prd_20210715 OWNER TO sp_postgres;

--
-- TOC entry 750 (class 1259 OID 26697)
-- Name: dim_account_tmp; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_account_tmp (
    acct_id integer NOT NULL,
    acct_fr character varying(20),
    acct_to character varying(20),
    acct_type character varying(1),
    acct_lvl1 character varying(50),
    acct_lvl2 character varying(50),
    acct_lvl3 character varying(50),
    acct_lvl4 character varying(50),
    acct_lvl5 character varying(50),
    acct_lvl6 character varying(50),
    acct_desc character varying(100),
    attribute1 character varying(200),
    attribute2 character varying(200)
);


ALTER TABLE qlik.dim_account_tmp OWNER TO sp_postgres;

--
-- TOC entry 751 (class 1259 OID 26703)
-- Name: dim_attribute; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_attribute (
    attrib_id integer,
    attrib_cd character varying(50),
    attrib_nm character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200),
    attribute3 character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200)
);


ALTER TABLE qlik.dim_attribute OWNER TO sp_postgres;

--
-- TOC entry 752 (class 1259 OID 26709)
-- Name: dim_attribute_bckup; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_attribute_bckup (
    attrib_id integer,
    attrib_cd character varying(50),
    attrib_nm character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200),
    attribute3 character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200)
);


ALTER TABLE qlik.dim_attribute_bckup OWNER TO sp_postgres;

--
-- TOC entry 753 (class 1259 OID 26721)
-- Name: dim_customer; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_customer (
    cust_id integer NOT NULL,
    cust_cd character varying(20),
    cust_nm character varying(100),
    attribute1 character varying(200),
    attribute2 character varying(200),
    attribute3 character varying(200)
);


ALTER TABLE qlik.dim_customer OWNER TO sp_postgres;

--
-- TOC entry 754 (class 1259 OID 26727)
-- Name: dim_employee; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_employee (
    period_id integer NOT NULL,
    entity_id integer NOT NULL,
    employeeid character varying(20),
    employeename character varying(100),
    employeegroup character varying(50),
    costcentercode character varying(20),
    costcentername character varying(50),
    noofworkinghours numeric(13,2),
    joiningdate date,
    lastdayofservice date,
    employmentstatus character varying(20),
    username character varying(40),
    repmonthyear character varying(20),
    payroll_area character varying(2)
);


ALTER TABLE qlik.dim_employee OWNER TO sp_postgres;

--
-- TOC entry 755 (class 1259 OID 26730)
-- Name: dim_entity; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_entity (
    entity_id integer NOT NULL,
    entity_cd character varying(20),
    entity_nm character varying(100),
    dept_cd character varying(20),
    dept_nm character varying(100),
    div_cd character varying(20),
    div_nm character varying(50),
    company character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200),
    attribute3 character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200),
    attribute6 character varying(200),
    attribute7 character varying(200)
);


ALTER TABLE qlik.dim_entity OWNER TO sp_postgres;

--
-- TOC entry 756 (class 1259 OID 26736)
-- Name: dim_entity_2021_may_27; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_entity_2021_may_27 (
    entity_id integer,
    entity_cd character varying(20),
    entity_nm character varying(100),
    dept_cd character varying(20),
    dept_nm character varying(100),
    div_cd character varying(20),
    div_nm character varying(50),
    company character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200),
    attribute3 character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200),
    attribute6 character varying(200),
    attribute7 character varying(200)
);


ALTER TABLE qlik.dim_entity_2021_may_27 OWNER TO sp_postgres;

--
-- TOC entry 757 (class 1259 OID 26742)
-- Name: dim_entity_bckup; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_entity_bckup (
    entity_id integer,
    entity_cd character varying(20),
    entity_nm character varying(100),
    dept_cd character varying(20),
    dept_nm character varying(100),
    div_cd character varying(20),
    div_nm character varying(50),
    company character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200),
    attribute3 character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200),
    attribute6 character varying(200),
    attribute7 character varying(200)
);


ALTER TABLE qlik.dim_entity_bckup OWNER TO sp_postgres;

--
-- TOC entry 851 (class 1259 OID 640201)
-- Name: dim_entity_test; Type: TABLE; Schema: qlik; Owner: postgres
--

CREATE TABLE qlik.dim_entity_test (
    entity_id integer,
    entity_cd character varying(20),
    entity_nm character varying(100),
    dept_cd character varying(20),
    dept_nm character varying(100),
    div_cd character varying(20),
    div_nm character varying(50),
    company character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200),
    attribute3 character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200),
    attribute6 character varying(200),
    attribute7 character varying(200)
);


ALTER TABLE qlik.dim_entity_test OWNER TO postgres;

--
-- TOC entry 758 (class 1259 OID 26754)
-- Name: dim_period; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_period (
    period_id integer NOT NULL,
    mth_short_nm character varying(20),
    mth_nm character varying(20),
    year integer,
    period_short_nm character varying(20),
    period_nm character varying(20),
    qtr_nm character varying(20),
    mth_no integer,
    fiscal_period_no integer,
    fiscal_year_period integer,
    fiscal_year character varying(10),
    attribute1 character varying(200),
    attribute2 character varying(200)
);


ALTER TABLE qlik.dim_period OWNER TO sp_postgres;

--
-- TOC entry 759 (class 1259 OID 26760)
-- Name: dim_product; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_product (
    product_id integer NOT NULL,
    product_cd character varying(20),
    product_nm character varying(200),
    product_lvl1 character varying(50),
    product_lvl2 character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200)
);


ALTER TABLE qlik.dim_product OWNER TO sp_postgres;

--
-- TOC entry 760 (class 1259 OID 26766)
-- Name: dim_product_bckup; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_product_bckup (
    product_id integer,
    product_cd character varying(20),
    product_nm character varying(200),
    product_lvl1 character varying(50),
    product_lvl2 character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200)
);


ALTER TABLE qlik.dim_product_bckup OWNER TO sp_postgres;

--
-- TOC entry 761 (class 1259 OID 26784)
-- Name: dim_toto_draw_type; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.dim_toto_draw_type (
    draw_no character varying(10),
    draw_type character varying(10)
);


ALTER TABLE qlik.dim_toto_draw_type OWNER TO sp_postgres;

--
-- TOC entry 762 (class 1259 OID 26787)
-- Name: fact_bt; Type: TABLE; Schema: qlik; Owner: postgres
--

CREATE TABLE qlik.fact_bt (
    period_id integer NOT NULL,
    entity_id integer NOT NULL,
    acct_id integer NOT NULL,
    attrib1_id integer NOT NULL,
    attrib1_nm character varying(50),
    value numeric(13,2),
    remarks character varying(500),
    detail_msg character varying(500),
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    div_cd character varying(50),
    div_nm character varying(50)
);


ALTER TABLE qlik.fact_bt OWNER TO postgres;

--
-- TOC entry 763 (class 1259 OID 26793)
-- Name: fact_customer; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_customer (
    period_id integer NOT NULL,
    acct_id integer NOT NULL,
    attrib1_id integer NOT NULL,
    attrib2_id integer NOT NULL,
    opening_amt numeric(13,4),
    activity_amt numeric(13,4),
    closing_amt numeric(13,4),
    value numeric(13,4),
    remarks character varying(500),
    attribute1 bpchar
);


ALTER TABLE qlik.fact_customer OWNER TO sp_postgres;

--
-- TOC entry 764 (class 1259 OID 26802)
-- Name: fact_daily_collection; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_daily_collection (
    period_id integer,
    business_date date,
    product_cd character varying(100),
    measure_nm character varying(50),
    attribute1 character varying(120),
    attribute2 character varying(120),
    attribute3 character varying(120),
    value numeric(13,2)
);


ALTER TABLE qlik.fact_daily_collection OWNER TO sp_postgres;

--
-- TOC entry 765 (class 1259 OID 26808)
-- Name: fact_daily_collection_20210624; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_daily_collection_20210624 (
    period_id integer,
    business_date date,
    product_cd character varying(100),
    measure_nm character varying(50),
    attribute1 character varying(50),
    attribute2 character varying(50),
    attribute3 character varying(50),
    value numeric(13,2)
);


ALTER TABLE qlik.fact_daily_collection_20210624 OWNER TO sp_postgres;

--
-- TOC entry 766 (class 1259 OID 26817)
-- Name: fact_daily_collection_tmp; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_daily_collection_tmp (
    meetingdate date,
    raceid integer,
    clubmeeting character varying(3),
    meetingid integer,
    actualmeeting character varying(60)
);


ALTER TABLE qlik.fact_daily_collection_tmp OWNER TO sp_postgres;

--
-- TOC entry 767 (class 1259 OID 26820)
-- Name: fact_gl_balance; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_gl_balance (
    period_id integer NOT NULL,
    entity_id integer NOT NULL,
    product_id integer NOT NULL,
    cust_id integer NOT NULL,
    acct_id integer NOT NULL,
    value_type integer NOT NULL,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer NOT NULL
);


ALTER TABLE qlik.fact_gl_balance OWNER TO sp_postgres;

--
-- TOC entry 768 (class 1259 OID 26823)
-- Name: fact_gl_balance_090421; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_gl_balance_090421 (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    value_type integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer
);


ALTER TABLE qlik.fact_gl_balance_090421 OWNER TO sp_postgres;

--
-- TOC entry 769 (class 1259 OID 26826)
-- Name: fact_gl_balance_150221; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_gl_balance_150221 (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    value_type integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer
);


ALTER TABLE qlik.fact_gl_balance_150221 OWNER TO sp_postgres;

--
-- TOC entry 770 (class 1259 OID 26832)
-- Name: fact_gl_balance_temp; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_gl_balance_temp (
    period_id integer NOT NULL,
    entity_id integer NOT NULL,
    product_id integer NOT NULL,
    cust_id integer NOT NULL,
    acct_id integer NOT NULL,
    value_type integer NOT NULL,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer NOT NULL
);


ALTER TABLE qlik.fact_gl_balance_temp OWNER TO sp_postgres;

--
-- TOC entry 771 (class 1259 OID 26835)
-- Name: fact_pnc; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_pnc (
    period_id integer NOT NULL,
    entity_id integer NOT NULL,
    acct_id integer NOT NULL,
    attrib1_id integer,
    attrib2_id integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    value numeric(13,3),
    remarks character varying(500),
    attribute1 character(125),
    attribute2 character(125),
    dept_cd character varying(50),
    div_cd character varying(50),
    dept_nm character varying(100),
    div_nm character varying(100)
);


ALTER TABLE qlik.fact_pnc OWNER TO sp_postgres;

--
-- TOC entry 772 (class 1259 OID 26841)
-- Name: fact_product; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_product (
    period_id integer,
    entity_id integer,
    product_id integer,
    acct_id integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer,
    attrib2_id integer,
    attrib3_id integer,
    notes character varying(200),
    business_date date,
    x_attribute1_type character varying(100),
    x_attribute1_value character varying(100)
);


ALTER TABLE qlik.fact_product OWNER TO sp_postgres;

--
-- TOC entry 773 (class 1259 OID 26844)
-- Name: fact_product_2021_may_27; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_product_2021_may_27 (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer,
    attrib2_id integer,
    attrib3_id integer
);


ALTER TABLE qlik.fact_product_2021_may_27 OWNER TO sp_postgres;

--
-- TOC entry 774 (class 1259 OID 26850)
-- Name: fact_rnc; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.fact_rnc (
    period_id integer NOT NULL,
    entity_id integer NOT NULL,
    acct_id integer NOT NULL,
    attrib1_id integer NOT NULL,
    attrib1_nm character varying(50),
    value numeric(13,2),
    remarks character varying(500),
    detail_msg character varying(500),
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    div_cd character varying(20),
    div_nm character varying(50)
);


ALTER TABLE qlik.fact_rnc OWNER TO sp_postgres;

--
-- TOC entry 775 (class 1259 OID 26856)
-- Name: fact_royalty_historical_data; Type: TABLE; Schema: qlik; Owner: postgres
--

CREATE TABLE qlik.fact_royalty_historical_data (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    value_type integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer,
    country character varying
);


ALTER TABLE qlik.fact_royalty_historical_data OWNER TO postgres;

--
-- TOC entry 776 (class 1259 OID 26862)
-- Name: hist_fact_gl_balance; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.hist_fact_gl_balance (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    value_type integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer
);


ALTER TABLE qlik.hist_fact_gl_balance OWNER TO sp_postgres;

--
-- TOC entry 777 (class 1259 OID 26865)
-- Name: hr_betting_account_info; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.hr_betting_account_info (
    period_id integer,
    actualmeeting character varying(50),
    bettingaccountnumber character varying(50)
);


ALTER TABLE qlik.hr_betting_account_info OWNER TO sp_postgres;

--
-- TOC entry 778 (class 1259 OID 26868)
-- Name: lkp_clubmeeting; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.lkp_clubmeeting (
    clubsequence integer,
    clubid character varying(50),
    clubname character varying(100),
    racedesc character varying(100),
    clubmeeting character varying(50)
);


ALTER TABLE qlik.lkp_clubmeeting OWNER TO sp_postgres;

--
-- TOC entry 779 (class 1259 OID 26871)
-- Name: lkp_dept_div_mapping; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.lkp_dept_div_mapping (
    dept_cd character varying(20),
    dept_nm character varying(100),
    div_cd character varying(20),
    div_nm character varying(50),
    attribute1 character varying(200),
    attribute3 character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200),
    attribute6 character varying(200),
    attribute7 character varying(200)
);


ALTER TABLE qlik.lkp_dept_div_mapping OWNER TO sp_postgres;

--
-- TOC entry 780 (class 1259 OID 26877)
-- Name: lkp_locationgrouping; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.lkp_locationgrouping (
    lg_lev1 text,
    lg_lev2 text,
    lg_grp_id text,
    lg_grp text,
    lg_type_id text,
    lg_type text,
    lg_id text,
    lg_name text,
    lg_position_id text
);


ALTER TABLE qlik.lkp_locationgrouping OWNER TO sp_postgres;

--
-- TOC entry 1019 (class 1259 OID 2289880)
-- Name: lkp_locationgrouping_bkup_241224; Type: TABLE; Schema: qlik; Owner: postgres
--

CREATE TABLE qlik.lkp_locationgrouping_bkup_241224 (
    lg_lev1 text,
    lg_lev2 text,
    lg_grp_id text,
    lg_grp text,
    lg_type_id text,
    lg_type text,
    lg_id text,
    lg_name text,
    lg_position_id text
);


ALTER TABLE qlik.lkp_locationgrouping_bkup_241224 OWNER TO postgres;

--
-- TOC entry 1020 (class 1259 OID 2308151)
-- Name: lkp_locationgrouping_bkup_250102; Type: TABLE; Schema: qlik; Owner: postgres
--

CREATE TABLE qlik.lkp_locationgrouping_bkup_250102 (
    lg_lev1 text,
    lg_lev2 text,
    lg_grp_id text,
    lg_grp text,
    lg_type_id text,
    lg_type text,
    lg_id text,
    lg_name text,
    lg_position_id text
);


ALTER TABLE qlik.lkp_locationgrouping_bkup_250102 OWNER TO postgres;

--
-- TOC entry 781 (class 1259 OID 26883)
-- Name: lkp_pc_atttribute; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.lkp_pc_atttribute (
    attribute_cd character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200),
    attribute6 character varying(200),
    attribute7 character varying(200)
);


ALTER TABLE qlik.lkp_pc_atttribute OWNER TO sp_postgres;

--
-- TOC entry 782 (class 1259 OID 26889)
-- Name: lkp_pc_atttribute1; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.lkp_pc_atttribute1 (
    attribute_cd character varying(200),
    attribute4 character varying(200),
    attribute5 character varying(200),
    attribute6 character varying(200),
    attribute7 character varying(200)
);


ALTER TABLE qlik.lkp_pc_atttribute1 OWNER TO sp_postgres;

--
-- TOC entry 783 (class 1259 OID 26895)
-- Name: lkp_retail_branch_zonegrouping; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.lkp_retail_branch_zonegrouping (
    id character varying(10),
    name character varying(100),
    zone character varying(100),
    category1 character varying(100),
    category2 character varying(100)
);


ALTER TABLE qlik.lkp_retail_branch_zonegrouping OWNER TO sp_postgres;

--
-- TOC entry 784 (class 1259 OID 26898)
-- Name: lkp_subsume; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.lkp_subsume (
    recno double precision,
    meetingdate date,
    clubmeeting text,
    clubname text,
    racenumber double precision,
    actualmeeting text
);


ALTER TABLE qlik.lkp_subsume OWNER TO sp_postgres;

--
-- TOC entry 785 (class 1259 OID 26904)
-- Name: ref_dim_entity; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.ref_dim_entity (
    ref_entity_cd character varying(20),
    ref_entity_nm character varying(100)
);


ALTER TABLE qlik.ref_dim_entity OWNER TO sp_postgres;

--
-- TOC entry 786 (class 1259 OID 26907)
-- Name: stg_active_spa; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_active_spa (
    processing_date date NOT NULL,
    customers_activated integer
);


ALTER TABLE qlik.stg_active_spa OWNER TO sp_postgres;

--
-- TOC entry 787 (class 1259 OID 26910)
-- Name: stg_active_spa_customer; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_active_spa_customer (
    date date NOT NULL,
    "Customers Activated" integer
);


ALTER TABLE qlik.stg_active_spa_customer OWNER TO sp_postgres;

--
-- TOC entry 788 (class 1259 OID 26913)
-- Name: stg_channel; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_channel (
    period_id integer,
    entityname character varying(200),
    measure character varying(200),
    mtd_target numeric(13,4),
    mtd_actual numeric(13,4),
    ytd_target numeric(13,4),
    ytd_actual numeric(13,4)
);


ALTER TABLE qlik.stg_channel OWNER TO sp_postgres;

--
-- TOC entry 789 (class 1259 OID 26919)
-- Name: stg_customer_kpi; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_customer_kpi (
    period integer,
    measure character varying(100),
    kpinm character varying(200),
    value numeric(13,4),
    attribute1 character varying(200),
    attribute2 character varying(200),
    remarks character varying(500),
    proc_date_at timestamp with time zone DEFAULT now()
);


ALTER TABLE qlik.stg_customer_kpi OWNER TO sp_postgres;

--
-- TOC entry 790 (class 1259 OID 26926)
-- Name: stg_employee; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_employee (
    period_id integer,
    employeeid character varying(20),
    employeename character varying(100),
    employeegroup character varying(50),
    costcentercode character varying(20),
    costcentername character varying(50),
    noofworkinghours numeric(13,2),
    joiningdate date,
    lastdayofservice date,
    employmentstatus character varying(20),
    repmonthyear character varying(20),
    payroll_area character varying(2),
    username character varying(40)
);


ALTER TABLE qlik.stg_employee OWNER TO sp_postgres;

--
-- TOC entry 791 (class 1259 OID 26929)
-- Name: stg_employee_fte; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_employee_fte (
    period_id integer,
    employeeid character varying(20),
    employeename character varying(100),
    employeegroup character varying(50),
    costcentercode character varying(20),
    costcentername character varying(50),
    noofworkinghours numeric(13,2),
    joiningdate character varying(20),
    lastdayofservice character varying(20),
    employmentstatus character varying(20),
    repmonthyear character varying(20)
);


ALTER TABLE qlik.stg_employee_fte OWNER TO sp_postgres;

--
-- TOC entry 792 (class 1259 OID 26932)
-- Name: stg_entity_attribute_mapping; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_entity_attribute_mapping (
    entity_cd text,
    attribute4 text,
    attribute6 text,
    div_nm text,
    dept_nm text,
    entity_nm text
);


ALTER TABLE qlik.stg_entity_attribute_mapping OWNER TO sp_postgres;

--
-- TOC entry 858 (class 1259 OID 743505)
-- Name: stg_fact_customer; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_fact_customer (
    period_id integer NOT NULL,
    acct_id integer NOT NULL,
    attrib1_id integer NOT NULL,
    attrib2_id integer NOT NULL,
    opening_amt numeric(13,4),
    activity_amt numeric(13,4),
    closing_amt numeric(13,4)
);


ALTER TABLE qlik.stg_fact_customer OWNER TO sp_postgres;

--
-- TOC entry 820 (class 1259 OID 154507)
-- Name: stg_fact_gl_balance; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_fact_gl_balance (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    value_type integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer
);


ALTER TABLE qlik.stg_fact_gl_balance OWNER TO sp_postgres;

--
-- TOC entry 793 (class 1259 OID 26941)
-- Name: stg_fact_product; Type: TABLE; Schema: qlik; Owner: postgres
--

CREATE TABLE qlik.stg_fact_product (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer,
    attrib2_id integer,
    attrib3_id integer
);


ALTER TABLE qlik.stg_fact_product OWNER TO postgres;

--
-- TOC entry 794 (class 1259 OID 26944)
-- Name: stg_fte; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_fte (
    period_id integer,
    employeeid character varying(20),
    employeename character varying(100),
    employeegroup character varying(50),
    costcentercode character varying(20),
    costcentername character varying(50),
    noofworkinghours numeric(13,2),
    joiningdate character varying(20),
    lastdayofservice character varying(20),
    employmentstatus character varying(20),
    repmonthyear character varying(20)
);


ALTER TABLE qlik.stg_fte OWNER TO sp_postgres;

--
-- TOC entry 795 (class 1259 OID 26947)
-- Name: stg_pnc; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_pnc (
    period integer,
    measure character varying(100),
    departmentcd character varying(20),
    departmentnm character varying(100),
    divisioncd character varying(20),
    divisionnm character varying(50),
    attribute1 character varying(200),
    attribute2 character varying(200),
    value numeric(13,3),
    remarks character varying(500),
    proc_date_at timestamp with time zone DEFAULT now()
);


ALTER TABLE qlik.stg_pnc OWNER TO sp_postgres;

--
-- TOC entry 796 (class 1259 OID 26954)
-- Name: stg_project_expense; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_project_expense (
    period_id integer,
    project_nm character varying(100),
    cf_amt numeric(13,2),
    new_amt numeric(13,2),
    residual_amt numeric(13,2),
    total_budget numeric(13,2),
    pr_amt numeric(13,2),
    po_amt numeric(13,2),
    invoice_amt numeric(13,2),
    total_consumed numeric(13,2),
    total_available numeric(13,2),
    transformation character varying(1),
    commence character varying(1),
    commitment_item character varying(100)
);


ALTER TABLE qlik.stg_project_expense OWNER TO sp_postgres;

--
-- TOC entry 797 (class 1259 OID 26957)
-- Name: stg_rnc; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_rnc (
    period integer,
    measure character varying(50),
    costcentercd character varying(100),
    costcenternm character varying(100),
    attribute1 character varying(200),
    attribute2 character varying(200),
    value numeric(13,2),
    remarks character varying(500),
    proc_date_at timestamp with time zone DEFAULT now()
);


ALTER TABLE qlik.stg_rnc OWNER TO sp_postgres;

--
-- TOC entry 798 (class 1259 OID 26964)
-- Name: stg_toto_draw_file; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.stg_toto_draw_file (
    draw_no character varying(10),
    draw_type character varying(10)
);


ALTER TABLE qlik.stg_toto_draw_file OWNER TO sp_postgres;

--
-- TOC entry 799 (class 1259 OID 26967)
-- Name: test_variable; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.test_variable (
    test1 integer
);


ALTER TABLE qlik.test_variable OWNER TO sp_postgres;

--
-- TOC entry 800 (class 1259 OID 26970)
-- Name: tmp_active_spa; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.tmp_active_spa (
    period_id integer,
    acct_id integer,
    attrib1_id integer,
    attrib2_id integer,
    opening_amt integer,
    activity_amt bigint,
    closing_amt bigint
);


ALTER TABLE qlik.tmp_active_spa OWNER TO sp_postgres;

--
-- TOC entry 801 (class 1259 OID 26973)
-- Name: tmp_active_spa_otl; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.tmp_active_spa_otl (
    period_id integer,
    acct_id integer,
    attrib1_id integer,
    attrib2_id integer,
    opening_amt integer,
    activity_amt bigint,
    closing_amt bigint
);


ALTER TABLE qlik.tmp_active_spa_otl OWNER TO sp_postgres;

--
-- TOC entry 802 (class 1259 OID 26976)
-- Name: tmp_fact_balance; Type: TABLE; Schema: qlik; Owner: postgres
--

CREATE TABLE qlik.tmp_fact_balance (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    value_type integer,
    opening_amt integer,
    activity_amt numeric,
    closing_amt integer,
    attrib1_id integer
);


ALTER TABLE qlik.tmp_fact_balance OWNER TO postgres;

--
-- TOC entry 857 (class 1259 OID 743502)
-- Name: tmp_fact_customer; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.tmp_fact_customer (
    period_id integer NOT NULL,
    acct_id integer NOT NULL,
    attrib1_id integer NOT NULL,
    attrib2_id integer NOT NULL,
    opening_amt numeric(13,4),
    activity_amt numeric(13,4),
    closing_amt numeric(13,4)
);


ALTER TABLE qlik.tmp_fact_customer OWNER TO sp_postgres;

--
-- TOC entry 819 (class 1259 OID 154504)
-- Name: tmp_fact_gl_balance; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.tmp_fact_gl_balance (
    period_id integer,
    entity_id integer,
    product_id integer,
    cust_id integer,
    acct_id integer,
    value_type integer,
    opening_amt numeric(13,2),
    activity_amt numeric(13,2),
    closing_amt numeric(13,2),
    attrib1_id integer
);


ALTER TABLE qlik.tmp_fact_gl_balance OWNER TO sp_postgres;

--
-- TOC entry 803 (class 1259 OID 26985)
-- Name: tmp_fact_product_closing; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.tmp_fact_product_closing (
    period_id integer,
    entity_id integer,
    product_id integer,
    acct_id integer,
    opening_amt numeric,
    activity_amt numeric(13,2),
    closing_amt numeric,
    attrib1_id integer,
    attrib2_id integer,
    attrib3_id integer,
    notes character varying(200),
    business_date date,
    x_attribute1_type character varying(100),
    x_attribute1_value character varying(100)
);


ALTER TABLE qlik.tmp_fact_product_closing OWNER TO sp_postgres;

--
-- TOC entry 804 (class 1259 OID 26991)
-- Name: tmp_fact_product_dc; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.tmp_fact_product_dc (
    period_id integer,
    entity_id integer,
    product_id integer,
    acct_id integer,
    opening_amt integer,
    activity_amt numeric,
    closing_amt integer,
    attrib1_id integer,
    attrib2_id integer,
    attrib3_id integer,
    notes character varying,
    business_date date,
    x_attribute1_type character varying,
    x_attribute1_value character varying
);


ALTER TABLE qlik.tmp_fact_product_dc OWNER TO sp_postgres;

--
-- TOC entry 805 (class 1259 OID 26997)
-- Name: tmp_load_zero_closing; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.tmp_load_zero_closing (
    period_id integer,
    entity_id integer,
    product_id integer,
    acct_id integer,
    attrib1_id integer,
    attrib2_id integer,
    attrib3_id integer,
    notes character varying,
    business_date date,
    x_attribute1_type character varying,
    x_attribute1_value character varying
);


ALTER TABLE qlik.tmp_load_zero_closing OWNER TO sp_postgres;

--
-- TOC entry 806 (class 1259 OID 27003)
-- Name: ztall_weight_margin; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.ztall_weight_margin (
    marketgroup character varying(200),
    markets character varying(200),
    yieldmargin character varying(200),
    effective_date date
);


ALTER TABLE qlik.ztall_weight_margin OWNER TO sp_postgres;

--
-- TOC entry 807 (class 1259 OID 27009)
-- Name: ztbmcs_betinfobycashacctview_tmp; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.ztbmcs_betinfobycashacctview_tmp (
    locationid integer,
    positionid integer,
    meetingid integer,
    clubmeeting character varying(3),
    meetingdate timestamp without time zone,
    financialyear character varying(7),
    meetingname character varying(60),
    meetingnumber integer,
    raceid integer,
    racenumber integer,
    tracktype character varying(30),
    raceclass character varying(6),
    course character varying(3),
    distance integer,
    racename character varying(60),
    stakes numeric(12,2),
    trackcondition character varying(30),
    advertisedstarttime timestamp without time zone,
    jumptime timestamp without time zone,
    releasetime timestamp without time zone,
    meetingmix character varying(20),
    actualmeeting character varying(60),
    numberofstarters integer,
    poolid integer,
    bettype character varying(2),
    terminaltypeid character varying(1),
    turnover numeric(12,2),
    betlinerebate numeric(12,2),
    refund numeric(12,2),
    noofbetlines integer,
    noofunits numeric(28,8),
    totalcancelamount numeric(12,2),
    totalpayable numeric(12,2),
    rollbetleg integer,
    betsource character varying(30)
);


ALTER TABLE qlik.ztbmcs_betinfobycashacctview_tmp OWNER TO sp_postgres;

--
-- TOC entry 808 (class 1259 OID 27012)
-- Name: ztrtms_trans_lottery; Type: TABLE; Schema: qlik; Owner: postgres
--

CREATE TABLE qlik.ztrtms_trans_lottery (
    busdate date NOT NULL,
    transheaderid character varying(50),
    boardid character varying(50),
    drawid integer NOT NULL,
    transtype integer NOT NULL,
    uuid character varying(50),
    productid integer NOT NULL,
    bettypeid character varying(3),
    selection character varying(255),
    transtimestamp timestamp without time zone NOT NULL,
    terminalid bigint NOT NULL,
    userid character varying(50),
    retailerid bigint NOT NULL,
    entrymethod integer,
    numboards integer,
    numdraws integer,
    ebetslipdeviceid character varying(255),
    numsimplebets integer,
    qpflag integer,
    nummarks integer,
    bulkid character varying(255),
    itotoparts integer,
    itotototalparts integer,
    grptotoparts integer,
    wager1 double precision NOT NULL,
    wager2 double precision NOT NULL,
    sales1 double precision,
    sales2 double precision,
    salescomm1 double precision,
    salescomm2 double precision,
    gst1 double precision,
    gst2 double precision,
    returnamt double precision,
    winning double precision,
    paymentmode character varying(2),
    cartid character varying(255)
);


ALTER TABLE qlik.ztrtms_trans_lottery OWNER TO postgres;

--
-- TOC entry 809 (class 1259 OID 27018)
-- Name: ztsapfi_cca; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.ztsapfi_cca (
    chart_of_accounts character varying(4),
    controlling_area character varying(4),
    company_code character varying(4),
    cost_center character varying(10),
    cost_element character varying(10),
    currency_type character varying(2),
    customer character varying(10),
    fm_area character varying(4),
    functional_area character varying(16),
    fund character varying(20),
    gl_account character varying(10),
    "grant" character varying(20),
    valuation_view smallint,
    version character varying(3),
    value_type smallint,
    fiscal_year_period integer,
    currency character varying(5),
    amount numeric(13,2),
    quantity numeric(13,3),
    unit character varying(3)
);


ALTER TABLE qlik.ztsapfi_cca OWNER TO sp_postgres;

--
-- TOC entry 810 (class 1259 OID 27021)
-- Name: ztsapfi_copa; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.ztsapfi_copa (
    bet_mode character varying(18),
    business_area character varying(4),
    chart_of_accounts character varying(4),
    company_code character varying(4),
    controlling_area character varying(4),
    cost_center character varying(10),
    cost_element character varying(10),
    country character varying(3),
    customer character varying(10),
    draw_number character varying(18),
    league_code character varying(6),
    material character varying(18),
    product_id character varying(3),
    product_hierarchy character varying(18),
    profit_center character varying(10),
    valuation_view smallint,
    value_type smallint,
    version character varying(3),
    fiscal_year_period integer,
    controlling_currency character varying(5),
    total_value_controlling numeric(13,2),
    object_currency character varying(5),
    total_value_object numeric(13,2),
    transaction_currency character varying(5),
    total_value_transaction numeric(13,2)
);


ALTER TABLE qlik.ztsapfi_copa OWNER TO sp_postgres;

--
-- TOC entry 811 (class 1259 OID 27024)
-- Name: ztsapfi_gl; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.ztsapfi_gl (
    company_code character varying(4),
    fiscal_year integer,
    document_number character varying(10),
    item_number integer,
    assignment_number character varying(18),
    chart_of_accounts character varying(4),
    controlling_area character varying(4),
    cost_center character varying(10),
    cost_element character varying(10),
    document_header_text character varying(25),
    document_type character varying(2),
    gl_account character varying(10),
    posting_date date,
    posting_key character varying(2),
    product_id character varying(3),
    profit_center character varying(10),
    reference_key character varying(20),
    business_area character varying(4),
    functional_area character varying(16),
    fiscal_year_period integer,
    fiscal_year_variant character varying(2),
    local_currency character varying(5),
    debit_credit_amount numeric(13,2),
    item_text character varying(50)
);


ALTER TABLE qlik.ztsapfi_gl OWNER TO sp_postgres;

--
-- TOC entry 859 (class 1259 OID 745893)
-- Name: zv_adhoc_cashout_130822; Type: VIEW; Schema: qlik; Owner: postgres
--

CREATE VIEW qlik.zv_adhoc_cashout_130822 AS
 WITH entity_list AS (
         SELECT "right"((dim_entity.entity_cd)::text, 6) AS entity_src,
            dim_entity.entity_cd,
            dim_entity.entity_nm,
            dim_entity.attribute4,
            dim_entity.attribute6
           FROM qlik.dim_entity
          WHERE ((NOT (dim_entity.entity_id IN ( SELECT dim_entity_1.entity_id
                   FROM qlik.dim_entity dim_entity_1
                  WHERE (("right"((dim_entity_1.entity_cd)::text, 6) IN ( SELECT DISTINCT "right"((dim_entity_2.entity_cd)::text, 6) AS "right"
                           FROM qlik.dim_entity dim_entity_2
                          WHERE (((dim_entity_2.entity_nm)::text ~~ '%Br-OCB%'::text) OR ((dim_entity_2.entity_nm)::text ~~ 'STC RACECOURSE%'::text)))) AND ((dim_entity_1.dept_nm)::text = 'Retailer'::text))))) AND ((dim_entity.entity_nm)::text !~~ 'BETTING CONTROL%'::text) AND ((dim_entity.entity_nm)::text !~~ 'BUSINESS DEVELOPMENT%'::text))
        ), sports_daily_collection_src AS (
         SELECT btrim(replace(replace((a.place_terminal_code)::text, 'PRV_'::text, ''::text), '_SGD'::text, ''::text)) AS entity_cd,
            c.channel,
            d.league_name,
            c.description,
            d.league_code,
            sum(
                CASE a.bet_type
                    WHEN 'DBL'::text THEN (a.stake / (2)::numeric)
                    WHEN 'TBL'::text THEN (a.stake / (3)::numeric)
                    WHEN 'ACC4'::text THEN (a.stake / (4)::numeric)
                    ELSE a.stake
                END) AS collection_amt
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((a.bet_status)::text = 'A'::text) AND (b.business_date = to_date('20230822'::text, 'YYYYMMDD'::text)))
          GROUP BY a.place_terminal_code, c.channel, d.league_name, c.description, d.league_code
        ), sports_daily_collection AS (
         SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
            a.league_name AS product_cd,
            COALESCE(b.attribute4, a.description) AS attribute1,
            btrim(to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'day'::text)) AS attribute2,
                CASE
                    WHEN ("right"((a.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END AS attribute3,
            a.collection_amt AS value
           FROM (sports_daily_collection_src a
             LEFT JOIN entity_list b ON (
                CASE
                    WHEN ((a.channel)::text = ANY (ARRAY[('U'::character varying)::text, ('L'::character varying)::text])) THEN ("left"(a.entity_cd, 6) = b.entity_src)
                    WHEN ((a.channel)::text = 'R'::text) THEN (lpad(substr(a.entity_cd, 1, (length(a.entity_cd) - 2)), 6, '0'::text) = "right"(b.entity_src, 6))
                    ELSE NULL::boolean
                END))
        ), sports_daily_sales_src AS (
         SELECT btrim(replace(replace((a.account_no)::text, 'PRV_'::text, ''::text), '_SGD'::text, ''::text)) AS entity_cd,
            c.channel,
            d.league_name,
            c.description,
            a.market_name,
                CASE
                    WHEN ("right"((d.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END AS attribute3,
            a.bet_type,
            a.bet_status,
            count(DISTINCT a.bet_id) AS bet_count,
            sum(a.settled_sales) AS sales_amt,
            sum(a.settled_returns) AS payout_amt
           FROM ((public.ztob_sportbetssettled a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN ( SELECT DISTINCT b.business_date,
                    d_1.match_id,
                    d_1.league_name,
                    d_1.league_code
                   FROM (public.ztob_timetable d_1
                     JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND ((d_1.settled_date_d + d_1.settled_date_t) >= b.start_timestamp) AND ((d_1.settled_date_d + d_1.settled_date_t) <= b.end_timestamp))))
                  WHERE ((b.business_date = to_date('20230822'::text, 'YYYYMMDD'::text)) AND ((d_1.settled_flag)::text = 'Y'::text))) d ON ((d.match_id = a.match_id)))
          WHERE (((a.leg_status)::text = ANY (ARRAY[('L'::character varying)::text, ('W'::character varying)::text])) AND (d.business_date = to_date('20230822'::text, 'YYYYMMDD'::text)))
          GROUP BY a.account_no, c.channel, d.league_name, c.description, a.market_name,
                CASE
                    WHEN ("right"((d.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END, a.bet_type, a.bet_status
        ), sports_daily_account AS (
         SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
            count(DISTINCT a.account_no) AS value
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text)) AND (b.business_date = to_date('20230822'::text, 'YYYYMMDD'::text)) AND (((a.channel)::text = 'I'::text) OR ((a.channel)::text = 'M'::text) OR ((a.channel)::text = 'P'::text)))
        ), sports_daily_account_mtd AS (
         SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
            count(DISTINCT a.account_no) AS value
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text)) AND (b.business_date >= to_date(("left"('20230822'::text, 6) || '01'::text), 'YYYYMMDD'::text)) AND (b.business_date <= to_date('20230822'::text, 'YYYYMMDD'::text)) AND (((a.channel)::text = 'I'::text) OR ((a.channel)::text = 'M'::text) OR ((a.channel)::text = 'P'::text)))
        ), sport_no_of_event AS (
         SELECT DISTINCT d.league_name,
            d.match_id
           FROM (public.ztob_timetable d
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND ((d.settled_date_d + d.settled_date_t) >= b.start_timestamp) AND ((d.settled_date_d + d.settled_date_t) <= b.end_timestamp))))
          WHERE ((b.business_date = to_date('20230822'::text, 'YYYYMMDD'::text)) AND ((d.settled_flag)::text = 'Y'::text))
        ), sports_daily_sales AS (
         SELECT a.league_name,
            COALESCE(b.attribute4, a.description) AS chanel_category,
            a.market_name,
            a.sales_amt,
            a.payout_amt,
            a.attribute3,
            a.bet_type,
            a.bet_status,
            a.bet_count
           FROM (sports_daily_sales_src a
             LEFT JOIN entity_list b ON (
                CASE
                    WHEN ((a.channel)::text = ANY (ARRAY[('U'::character varying)::text, ('L'::character varying)::text])) THEN ("left"(a.entity_cd, 6) = b.entity_src)
                    WHEN ((a.channel)::text = 'R'::text) THEN (lpad(substr(a.entity_cd, 1, (length(a.entity_cd) - 2)), 6, '0'::text) = "right"(b.entity_src, 6))
                    ELSE NULL::boolean
                END))
        )
 SELECT sports_daily_collection.period_id,
    sports_daily_collection.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'collection'::character varying(100) AS measure_nm,
    (sports_daily_collection.attribute1)::character varying(100) AS attribute1,
    (sports_daily_collection.attribute2)::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_collection.value) AS value
   FROM sports_daily_collection
  GROUP BY sports_daily_collection.period_id, sports_daily_collection.business_date, ((sports_daily_collection.attribute1)::character varying(100)), ((sports_daily_collection.attribute2)::character varying(100))
UNION ALL
 SELECT sports_daily_collection.period_id,
    sports_daily_collection.business_date,
    (sports_daily_collection.product_cd)::character varying(100) AS product_cd,
    'collection by match type'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    (sports_daily_collection.attribute2)::character varying(100) AS attribute2,
    (sports_daily_collection.attribute3)::character varying(100) AS attribute3,
    sum(sports_daily_collection.value) AS value
   FROM sports_daily_collection
  GROUP BY sports_daily_collection.period_id, sports_daily_collection.business_date, ((sports_daily_collection.product_cd)::character varying(100)), ((sports_daily_collection.attribute3)::character varying(100)), ((sports_daily_collection.attribute2)::character varying(100))
UNION ALL
 SELECT sports_daily_account.period_id,
    sports_daily_account.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'no of account daily'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    NULL::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_account.value) AS value
   FROM sports_daily_account
  GROUP BY sports_daily_account.period_id, sports_daily_account.business_date
UNION ALL
 SELECT sports_daily_account_mtd.period_id,
    sports_daily_account_mtd.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'no of account daily mtd'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    NULL::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_account_mtd.value) AS value
   FROM sports_daily_account_mtd
  GROUP BY sports_daily_account_mtd.period_id, sports_daily_account_mtd.business_date
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'sales'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'sales by channel'::character varying AS measure_nm,
    sports_daily_sales.chanel_category AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'sales by bet type'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.market_name
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'payout by bet type'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.market_name
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'payout'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sport_no_of_event.league_name AS product_cd,
    'no of event'::character varying AS measure_nm,
    NULL::character varying AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    count(*) AS value
   FROM sport_no_of_event
  GROUP BY sport_no_of_event.league_name
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'sales by multiple bet'::character varying AS measure_nm,
    sports_daily_sales.bet_type AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.bet_type, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'payout by multiple bet'::character varying AS measure_nm,
    sports_daily_sales.bet_type AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.bet_type
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'cashout sales'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text = 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'noncashout sales'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text <> 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'cashout payout'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text = 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'noncashout payout'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text <> 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'cashout betcount'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.bet_count) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text = 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230822'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230822'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'noncashout betcount'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.bet_count) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text <> 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category;


ALTER TABLE qlik.zv_adhoc_cashout_130822 OWNER TO postgres;

--
-- TOC entry 849 (class 1259 OID 622397)
-- Name: zv_dcr_sports_20230725; Type: VIEW; Schema: qlik; Owner: postgres
--

CREATE VIEW qlik.zv_dcr_sports_20230725 AS
 WITH entity_list AS (
         SELECT "right"((dim_entity.entity_cd)::text, 6) AS entity_src,
            dim_entity.entity_cd,
            dim_entity.entity_nm,
            dim_entity.attribute4,
            dim_entity.attribute6
           FROM qlik.dim_entity
          WHERE ((NOT (dim_entity.entity_id IN ( SELECT dim_entity_1.entity_id
                   FROM qlik.dim_entity dim_entity_1
                  WHERE (("right"((dim_entity_1.entity_cd)::text, 6) IN ( SELECT DISTINCT "right"((dim_entity_2.entity_cd)::text, 6) AS "right"
                           FROM qlik.dim_entity dim_entity_2
                          WHERE (((dim_entity_2.entity_nm)::text ~~ '%Br-OCB%'::text) OR ((dim_entity_2.entity_nm)::text ~~ 'STC RACECOURSE%'::text)))) AND ((dim_entity_1.dept_nm)::text = 'Retailer'::text))))) AND ((dim_entity.entity_nm)::text !~~ 'BETTING CONTROL%'::text) AND ((dim_entity.entity_nm)::text !~~ 'BUSINESS DEVELOPMENT%'::text))
        ), sports_daily_collection_src AS (
         SELECT btrim(replace(replace((a.place_terminal_code)::text, 'PRV_'::text, ''::text), '_SGD'::text, ''::text)) AS entity_cd,
            c.channel,
            d.league_name,
            c.description,
            d.league_code,
            sum(
                CASE a.bet_type
                    WHEN 'DBL'::text THEN (a.stake / (2)::numeric)
                    WHEN 'TBL'::text THEN (a.stake / (3)::numeric)
                    WHEN 'ACC4'::text THEN (a.stake / (4)::numeric)
                    ELSE a.stake
                END) AS collection_amt
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((a.bet_status)::text = 'A'::text) AND (b.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)))
          GROUP BY a.place_terminal_code, c.channel, d.league_name, c.description, d.league_code
        ), sports_daily_collection AS (
         SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
            a.league_name AS product_cd,
            COALESCE(b.attribute4, a.description) AS attribute1,
            btrim(to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'day'::text)) AS attribute2,
                CASE
                    WHEN ("right"((a.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END AS attribute3,
            a.collection_amt AS value
           FROM (sports_daily_collection_src a
             LEFT JOIN entity_list b ON (
                CASE
                    WHEN ((a.channel)::text = ANY ((ARRAY['U'::character varying, 'L'::character varying])::text[])) THEN ("left"(a.entity_cd, 6) = b.entity_src)
                    WHEN ((a.channel)::text = 'R'::text) THEN (lpad(substr(a.entity_cd, 1, (length(a.entity_cd) - 2)), 6, '0'::text) = "right"(b.entity_src, 6))
                    ELSE NULL::boolean
                END))
        ), sports_daily_sales_src AS (
         SELECT btrim(replace(replace((a.account_no)::text, 'PRV_'::text, ''::text), '_SGD'::text, ''::text)) AS entity_cd,
            c.channel,
            d.league_name,
            c.description,
            a.market_name,
                CASE
                    WHEN ("right"((d.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END AS attribute3,
            a.bet_type,
            sum(a.settled_sales) AS sales_amt,
            sum(a.settled_returns) AS payout_amt
           FROM ((public.ztob_sportbetssettled a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN ( SELECT DISTINCT b.business_date,
                    d_1.match_id,
                    d_1.league_name,
                    d_1.league_code
                   FROM (public.ztob_timetable d_1
                     JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (((d_1.settled_date_d + d_1.settled_date_t) >= b.start_timestamp) AND ((d_1.settled_date_d + d_1.settled_date_t) <= b.end_timestamp)))))
                  WHERE ((b.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)) AND ((d_1.settled_flag)::text = 'Y'::text))) d ON ((d.match_id = a.match_id)))
          WHERE (((a.leg_status)::text = ANY ((ARRAY['L'::character varying, 'W'::character varying])::text[])) AND (d.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)))
          GROUP BY a.account_no, c.channel, d.league_name, c.description, a.market_name,
                CASE
                    WHEN ("right"((d.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END, a.bet_type
        ), sports_daily_account AS (
         SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
            count(DISTINCT a.account_no) AS value
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text)) AND (b.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)) AND (((a.channel)::text = 'I'::text) OR ((a.channel)::text = 'M'::text) OR ((a.channel)::text = 'P'::text)))
        ), sports_daily_account_mtd AS (
         SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
            count(DISTINCT a.account_no) AS value
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text)) AND ((b.business_date >= to_date(("left"('20230725'::text, 6) || '01'::text), 'YYYYMMDD'::text)) AND (b.business_date <= to_date('20230725'::text, 'YYYYMMDD'::text))) AND (((a.channel)::text = 'I'::text) OR ((a.channel)::text = 'M'::text) OR ((a.channel)::text = 'P'::text)))
        ), sport_no_of_event AS (
         SELECT DISTINCT d.league_name,
            d.match_id
           FROM (public.ztob_timetable d
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (((d.settled_date_d + d.settled_date_t) >= b.start_timestamp) AND ((d.settled_date_d + d.settled_date_t) <= b.end_timestamp)))))
          WHERE ((b.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)) AND ((d.settled_flag)::text = 'Y'::text))
        ), sports_daily_sales AS (
         SELECT a.league_name,
            COALESCE(b.attribute4, a.description) AS chanel_category,
            a.market_name,
            a.sales_amt,
            a.payout_amt,
            a.attribute3,
            a.bet_type
           FROM (sports_daily_sales_src a
             LEFT JOIN entity_list b ON (
                CASE
                    WHEN ((a.channel)::text = ANY ((ARRAY['U'::character varying, 'L'::character varying])::text[])) THEN ("left"(a.entity_cd, 6) = b.entity_src)
                    WHEN ((a.channel)::text = 'R'::text) THEN (lpad(substr(a.entity_cd, 1, (length(a.entity_cd) - 2)), 6, '0'::text) = "right"(b.entity_src, 6))
                    ELSE NULL::boolean
                END))
        )
 SELECT sports_daily_collection.period_id,
    sports_daily_collection.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'collection'::character varying(100) AS measure_nm,
    (sports_daily_collection.attribute1)::character varying(100) AS attribute1,
    (sports_daily_collection.attribute2)::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_collection.value) AS value
   FROM sports_daily_collection
  GROUP BY sports_daily_collection.period_id, sports_daily_collection.business_date, ((sports_daily_collection.attribute1)::character varying(100)), ((sports_daily_collection.attribute2)::character varying(100))
UNION ALL
 SELECT sports_daily_collection.period_id,
    sports_daily_collection.business_date,
    (sports_daily_collection.product_cd)::character varying(100) AS product_cd,
    'collection by match type'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    (sports_daily_collection.attribute2)::character varying(100) AS attribute2,
    (sports_daily_collection.attribute3)::character varying(100) AS attribute3,
    sum(sports_daily_collection.value) AS value
   FROM sports_daily_collection
  GROUP BY sports_daily_collection.period_id, sports_daily_collection.business_date, ((sports_daily_collection.product_cd)::character varying(100)), ((sports_daily_collection.attribute3)::character varying(100)), ((sports_daily_collection.attribute2)::character varying(100))
UNION ALL
 SELECT sports_daily_account.period_id,
    sports_daily_account.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'no of account daily'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    NULL::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_account.value) AS value
   FROM sports_daily_account
  GROUP BY sports_daily_account.period_id, sports_daily_account.business_date
UNION ALL
 SELECT sports_daily_account_mtd.period_id,
    sports_daily_account_mtd.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'no of account daily mtd'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    NULL::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_account_mtd.value) AS value
   FROM sports_daily_account_mtd
  GROUP BY sports_daily_account_mtd.period_id, sports_daily_account_mtd.business_date
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'sales'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'sales by channel'::character varying AS measure_nm,
    sports_daily_sales.chanel_category AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'sales by bet type'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.market_name
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'payout by bet type'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.market_name
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'payout'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sport_no_of_event.league_name AS product_cd,
    'no of event'::character varying AS measure_nm,
    NULL::character varying AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    count(*) AS value
   FROM sport_no_of_event
  GROUP BY sport_no_of_event.league_name
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'sales by multiple bet'::character varying AS measure_nm,
    sports_daily_sales.bet_type AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.bet_type, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'payout by multiple bet'::character varying AS measure_nm,
    sports_daily_sales.bet_type AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.bet_type
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric);


ALTER TABLE qlik.zv_dcr_sports_20230725 OWNER TO postgres;

--
-- TOC entry 850 (class 1259 OID 622402)
-- Name: zv_dcr_sports_cashout_20230725; Type: VIEW; Schema: qlik; Owner: postgres
--

CREATE VIEW qlik.zv_dcr_sports_cashout_20230725 AS
 WITH entity_list AS (
         SELECT "right"((dim_entity.entity_cd)::text, 6) AS entity_src,
            dim_entity.entity_cd,
            dim_entity.entity_nm,
            dim_entity.attribute4,
            dim_entity.attribute6
           FROM qlik.dim_entity
          WHERE ((NOT (dim_entity.entity_id IN ( SELECT dim_entity_1.entity_id
                   FROM qlik.dim_entity dim_entity_1
                  WHERE (("right"((dim_entity_1.entity_cd)::text, 6) IN ( SELECT DISTINCT "right"((dim_entity_2.entity_cd)::text, 6) AS "right"
                           FROM qlik.dim_entity dim_entity_2
                          WHERE (((dim_entity_2.entity_nm)::text ~~ '%Br-OCB%'::text) OR ((dim_entity_2.entity_nm)::text ~~ 'STC RACECOURSE%'::text)))) AND ((dim_entity_1.dept_nm)::text = 'Retailer'::text))))) AND ((dim_entity.entity_nm)::text !~~ 'BETTING CONTROL%'::text) AND ((dim_entity.entity_nm)::text !~~ 'BUSINESS DEVELOPMENT%'::text))
        ), sports_daily_collection_src AS (
         SELECT btrim(replace(replace((a.place_terminal_code)::text, 'PRV_'::text, ''::text), '_SGD'::text, ''::text)) AS entity_cd,
            c.channel,
            d.league_name,
            c.description,
            d.league_code,
            sum(
                CASE a.bet_type
                    WHEN 'DBL'::text THEN (a.stake / (2)::numeric)
                    WHEN 'TBL'::text THEN (a.stake / (3)::numeric)
                    WHEN 'ACC4'::text THEN (a.stake / (4)::numeric)
                    ELSE a.stake
                END) AS collection_amt
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((a.bet_status)::text = 'A'::text) AND (b.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)))
          GROUP BY a.place_terminal_code, c.channel, d.league_name, c.description, d.league_code
        ), sports_daily_collection AS (
         SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
            a.league_name AS product_cd,
            COALESCE(b.attribute4, a.description) AS attribute1,
            btrim(to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'day'::text)) AS attribute2,
                CASE
                    WHEN ("right"((a.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END AS attribute3,
            a.collection_amt AS value
           FROM (sports_daily_collection_src a
             LEFT JOIN entity_list b ON (
                CASE
                    WHEN ((a.channel)::text = ANY ((ARRAY['U'::character varying, 'L'::character varying])::text[])) THEN ("left"(a.entity_cd, 6) = b.entity_src)
                    WHEN ((a.channel)::text = 'R'::text) THEN (lpad(substr(a.entity_cd, 1, (length(a.entity_cd) - 2)), 6, '0'::text) = "right"(b.entity_src, 6))
                    ELSE NULL::boolean
                END))
        ), sports_daily_sales_src AS (
         SELECT btrim(replace(replace((a.account_no)::text, 'PRV_'::text, ''::text), '_SGD'::text, ''::text)) AS entity_cd,
            c.channel,
            d.league_name,
            c.description,
            a.market_name,
                CASE
                    WHEN ("right"((d.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END AS attribute3,
            a.bet_type,
            a.bet_status,
            count(DISTINCT a.bet_id) AS bet_count,
            sum(a.settled_sales) AS sales_amt,
            sum(a.settled_returns) AS payout_amt
           FROM ((public.ztob_sportbetssettled a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN ( SELECT DISTINCT b.business_date,
                    d_1.match_id,
                    d_1.league_name,
                    d_1.league_code
                   FROM (public.ztob_timetable d_1
                     JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (((d_1.settled_date_d + d_1.settled_date_t) >= b.start_timestamp) AND ((d_1.settled_date_d + d_1.settled_date_t) <= b.end_timestamp)))))
                  WHERE ((b.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)) AND ((d_1.settled_flag)::text = 'Y'::text))) d ON ((d.match_id = a.match_id)))
          WHERE (((a.leg_status)::text = ANY ((ARRAY['L'::character varying, 'W'::character varying])::text[])) AND (d.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)))
          GROUP BY a.account_no, c.channel, d.league_name, c.description, a.market_name,
                CASE
                    WHEN ("right"((d.league_code)::text, 1) = 'L'::text) THEN 'Live'::text
                    ELSE 'Prematch'::text
                END, a.bet_type, a.bet_status
        ), sports_daily_account AS (
         SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
            count(DISTINCT a.account_no) AS value
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text)) AND (b.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)) AND (((a.channel)::text = 'I'::text) OR ((a.channel)::text = 'M'::text) OR ((a.channel)::text = 'P'::text)))
        ), sports_daily_account_mtd AS (
         SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
            to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
            count(DISTINCT a.account_no) AS value
           FROM (((public.ztob_sportbets a
             JOIN public.ztob_channels c ON (((a.channel)::text = (c.channel)::text)))
             JOIN public.ztob_timetable d ON ((d.match_id = a.match_id)))
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (b.business_id = a.creation_date_business_id))))
          WHERE (((((a.bet_status)::text = 'X'::text) AND ((a.settled_how)::text = 'M'::text)) OR ((a.bet_status)::text = 'A'::text)) AND ((b.business_date >= to_date(("left"('20230725'::text, 6) || '01'::text), 'YYYYMMDD'::text)) AND (b.business_date <= to_date('20230725'::text, 'YYYYMMDD'::text))) AND (((a.channel)::text = 'I'::text) OR ((a.channel)::text = 'M'::text) OR ((a.channel)::text = 'P'::text)))
        ), sport_no_of_event AS (
         SELECT DISTINCT d.league_name,
            d.match_id
           FROM (public.ztob_timetable d
             JOIN public.ztall_businessday b ON ((((b.system)::text = 'OB'::text) AND (((d.settled_date_d + d.settled_date_t) >= b.start_timestamp) AND ((d.settled_date_d + d.settled_date_t) <= b.end_timestamp)))))
          WHERE ((b.business_date = to_date('20230725'::text, 'YYYYMMDD'::text)) AND ((d.settled_flag)::text = 'Y'::text))
        ), sports_daily_sales AS (
         SELECT a.league_name,
            COALESCE(b.attribute4, a.description) AS chanel_category,
            a.market_name,
            a.sales_amt,
            a.payout_amt,
            a.attribute3,
            a.bet_type,
            a.bet_status,
            a.bet_count
           FROM (sports_daily_sales_src a
             LEFT JOIN entity_list b ON (
                CASE
                    WHEN ((a.channel)::text = ANY ((ARRAY['U'::character varying, 'L'::character varying])::text[])) THEN ("left"(a.entity_cd, 6) = b.entity_src)
                    WHEN ((a.channel)::text = 'R'::text) THEN (lpad(substr(a.entity_cd, 1, (length(a.entity_cd) - 2)), 6, '0'::text) = "right"(b.entity_src, 6))
                    ELSE NULL::boolean
                END))
        )
 SELECT sports_daily_collection.period_id,
    sports_daily_collection.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'collection'::character varying(100) AS measure_nm,
    (sports_daily_collection.attribute1)::character varying(100) AS attribute1,
    (sports_daily_collection.attribute2)::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_collection.value) AS value
   FROM sports_daily_collection
  GROUP BY sports_daily_collection.period_id, sports_daily_collection.business_date, ((sports_daily_collection.attribute1)::character varying(100)), ((sports_daily_collection.attribute2)::character varying(100))
UNION ALL
 SELECT sports_daily_collection.period_id,
    sports_daily_collection.business_date,
    (sports_daily_collection.product_cd)::character varying(100) AS product_cd,
    'collection by match type'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    (sports_daily_collection.attribute2)::character varying(100) AS attribute2,
    (sports_daily_collection.attribute3)::character varying(100) AS attribute3,
    sum(sports_daily_collection.value) AS value
   FROM sports_daily_collection
  GROUP BY sports_daily_collection.period_id, sports_daily_collection.business_date, ((sports_daily_collection.product_cd)::character varying(100)), ((sports_daily_collection.attribute3)::character varying(100)), ((sports_daily_collection.attribute2)::character varying(100))
UNION ALL
 SELECT sports_daily_account.period_id,
    sports_daily_account.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'no of account daily'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    NULL::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_account.value) AS value
   FROM sports_daily_account
  GROUP BY sports_daily_account.period_id, sports_daily_account.business_date
UNION ALL
 SELECT sports_daily_account_mtd.period_id,
    sports_daily_account_mtd.business_date,
    'SPORTS'::character varying(100) AS product_cd,
    'no of account daily mtd'::character varying(100) AS measure_nm,
    NULL::character varying(100) AS attribute1,
    NULL::character varying(100) AS attribute2,
    NULL::character varying(100) AS attribute3,
    sum(sports_daily_account_mtd.value) AS value
   FROM sports_daily_account_mtd
  GROUP BY sports_daily_account_mtd.period_id, sports_daily_account_mtd.business_date
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'sales'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'sales by channel'::character varying AS measure_nm,
    sports_daily_sales.chanel_category AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'sales by bet type'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.market_name
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    'SPORTS'::character varying AS product_cd,
    'payout by bet type'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.market_name
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'payout'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sport_no_of_event.league_name AS product_cd,
    'no of event'::character varying AS measure_nm,
    NULL::character varying AS attribute1,
    NULL::character varying AS attribute2,
    NULL::character varying AS attribute3,
    count(*) AS value
   FROM sport_no_of_event
  GROUP BY sport_no_of_event.league_name
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'sales by multiple bet'::character varying AS measure_nm,
    sports_daily_sales.bet_type AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.bet_type, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'payout by multiple bet'::character varying AS measure_nm,
    sports_daily_sales.bet_type AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE (COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric)
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.bet_type
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'cashout sales'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text = 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'noncashout sales'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.sales_amt) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text <> 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'cashout payout'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text = 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'noncashout payout'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    NULL::character varying AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.payout_amt) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.payout_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text <> 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name
 HAVING (sum(sports_daily_sales.payout_amt) <> (0)::numeric)
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'cashout betcount'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.bet_count) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text = 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category
UNION ALL
 SELECT (to_char((to_date('20230725'::text, 'YYYYMMDD'::text))::timestamp with time zone, 'YYYYMM'::text))::integer AS period_id,
    to_date('20230725'::text, 'YYYYMMDD'::text) AS business_date,
    sports_daily_sales.league_name AS product_cd,
    'noncashout betcount'::character varying AS measure_nm,
    sports_daily_sales.market_name AS attribute1,
    sports_daily_sales.chanel_category AS attribute2,
    sports_daily_sales.attribute3,
    sum(sports_daily_sales.bet_count) AS value
   FROM sports_daily_sales
  WHERE ((COALESCE(sports_daily_sales.sales_amt, (0)::numeric) <> (0)::numeric) AND ((sports_daily_sales.bet_status)::text <> 'C'::text))
  GROUP BY sports_daily_sales.league_name, sports_daily_sales.attribute3, sports_daily_sales.market_name, sports_daily_sales.chanel_category;


ALTER TABLE qlik.zv_dcr_sports_cashout_20230725 OWNER TO postgres;

--
-- TOC entry 812 (class 1259 OID 27027)
-- Name: zvkyc_branch_bkp_20210610; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.zvkyc_branch_bkp_20210610 (
    appid integer,
    custaccno character varying(32),
    branchdatetime timestamp without time zone,
    branchid character varying(256),
    branchaction character varying(50),
    branchremarks text
);


ALTER TABLE qlik.zvkyc_branch_bkp_20210610 OWNER TO sp_postgres;

--
-- TOC entry 813 (class 1259 OID 27033)
-- Name: zvkyc_calldurationhistory_bkp_20210610; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.zvkyc_calldurationhistory_bkp_20210610 (
    applicationid integer,
    custaccno character varying(32),
    createdtime timestamp without time zone,
    lastupdatedbyid character varying(256),
    customerwaitingduration character varying(20),
    videocallduration character varying(20),
    csohandlingduration character varying(20),
    osinfo character varying(256),
    browserinfo character varying(256),
    action character varying(50),
    actionremarks text
);


ALTER TABLE qlik.zvkyc_calldurationhistory_bkp_20210610 OWNER TO sp_postgres;

--
-- TOC entry 814 (class 1259 OID 27039)
-- Name: zvkyc_checker_bkp_20210610; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.zvkyc_checker_bkp_20210610 (
    mhid integer,
    chid integer,
    appid integer,
    custaccno character varying(32),
    branchmakerdatetime timestamp without time zone,
    branchmakerrole character varying(250),
    branchmakeraction character varying(50),
    branchmakerremarks text,
    checkerdatetime timestamp without time zone,
    checkerid character varying(256),
    checkeraction character varying(50),
    checkerremarks text,
    checker_rank bigint
);


ALTER TABLE qlik.zvkyc_checker_bkp_20210610 OWNER TO sp_postgres;

--
-- TOC entry 815 (class 1259 OID 27045)
-- Name: zvkyc_checker_masked_bkp_20210615; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.zvkyc_checker_masked_bkp_20210615 (
    mhid integer,
    chid integer,
    appid integer,
    custaccno character varying(32),
    branchmakerdatetime timestamp without time zone,
    branchmakerrole character varying(250),
    branchmakeraction character varying(50),
    branchmakerremarks text,
    checkerdatetime timestamp without time zone,
    checkerid character varying(256),
    checkeraction character varying(50),
    checker_rank bigint
);


ALTER TABLE qlik.zvkyc_checker_masked_bkp_20210615 OWNER TO sp_postgres;

--
-- TOC entry 816 (class 1259 OID 27051)
-- Name: zvkyc_checker_test; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.zvkyc_checker_test (
    mhid integer,
    chid integer,
    appid integer,
    custaccno character varying(32),
    branchmakerdatetime timestamp without time zone,
    branchmakerrole character varying(250),
    branchmakeraction character varying(50),
    branchmakerremarks text,
    checkerdatetime timestamp without time zone,
    checkerid character varying(256),
    checkeraction character varying(50),
    checker_rank bigint
);


ALTER TABLE qlik.zvkyc_checker_test OWNER TO sp_postgres;

--
-- TOC entry 817 (class 1259 OID 27057)
-- Name: zvkyc_maker_masked_bkp_20210615; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.zvkyc_maker_masked_bkp_20210615 (
    appid integer,
    custaccno character varying(32),
    makerdatetime timestamp without time zone,
    makerid character varying(256),
    makeraction character varying(50)
);


ALTER TABLE qlik.zvkyc_maker_masked_bkp_20210615 OWNER TO sp_postgres;

--
-- TOC entry 818 (class 1259 OID 27060)
-- Name: zvkyc_maker_test; Type: TABLE; Schema: qlik; Owner: sp_postgres
--

CREATE TABLE qlik.zvkyc_maker_test (
    appid integer,
    custaccno character varying(32),
    makerdatetime timestamp without time zone,
    makerid character varying(256),
    makeraction character varying(50)
);


ALTER TABLE qlik.zvkyc_maker_test OWNER TO sp_postgres;

--
-- TOC entry 6861 (class 2604 OID 1569954)
-- Name: audit audit_id; Type: DEFAULT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.audit ALTER COLUMN audit_id SET DEFAULT nextval('public.audit_audit_id_seq'::regclass);


--
-- TOC entry 6859 (class 2604 OID 1569916)
-- Name: category category_id; Type: DEFAULT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.category ALTER COLUMN category_id SET DEFAULT nextval('public.category_category_id_seq'::regclass);


--
-- TOC entry 6858 (class 2604 OID 1567564)
-- Name: city city_id; Type: DEFAULT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.city ALTER COLUMN city_id SET DEFAULT nextval('public.city_city_id_seq'::regclass);


--
-- TOC entry 6852 (class 2604 OID 27063)
-- Name: daily_etl_job_status id; Type: DEFAULT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.daily_etl_job_status ALTER COLUMN id SET DEFAULT nextval('public.daily_etl_job_status_id_seq'::regclass);


--
-- TOC entry 6860 (class 2604 OID 1569931)
-- Name: district district_number; Type: DEFAULT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.district ALTER COLUMN district_number SET DEFAULT nextval('public.district_district_number_seq'::regclass);


--
-- TOC entry 6857 (class 2604 OID 214428)
-- Name: mt940_file_status status_id; Type: DEFAULT; Schema: public; Owner: sp_sapfin
--

ALTER TABLE ONLY public.mt940_file_status ALTER COLUMN status_id SET DEFAULT nextval('public.mt940_file_status_status_id_seq'::regclass);


--
-- TOC entry 6862 (class 2604 OID 1569962)
-- Name: report report_id; Type: DEFAULT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.report ALTER COLUMN report_id SET DEFAULT nextval('public.report_report_id_seq'::regclass);


--
-- TOC entry 6863 (class 2604 OID 1840216)
-- Name: ztrtms_inout_paymentdetail inout_paymentdetailid; Type: DEFAULT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_inout_paymentdetail ALTER COLUMN inout_paymentdetailid SET DEFAULT nextval('public.ztrtms_inout_paymentdetail_inout_paymentdetailid_seq'::regclass);


--
-- TOC entry 6864 (class 2604 OID 1989580)
-- Name: chart_config_testdat chart_id; Type: DEFAULT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.chart_config_testdat ALTER COLUMN chart_id SET DEFAULT nextval('qlik.chart_config_testdat_chart_id_seq'::regclass);


--
-- TOC entry 7517 (class 2606 OID 1569956)
-- Name: audit audit_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.audit
    ADD CONSTRAINT audit_pkey PRIMARY KEY (audit_id);


--
-- TOC entry 7503 (class 2606 OID 1569920)
-- Name: category category_category_name_key; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.category
    ADD CONSTRAINT category_category_name_key UNIQUE (category_name);


--
-- TOC entry 7505 (class 2606 OID 1569918)
-- Name: category category_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.category
    ADD CONSTRAINT category_pkey PRIMARY KEY (category_id);


--
-- TOC entry 7493 (class 2606 OID 1567566)
-- Name: city city_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.city
    ADD CONSTRAINT city_pkey PRIMARY KEY (city_id);


--
-- TOC entry 7509 (class 2606 OID 1569933)
-- Name: district district_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.district
    ADD CONSTRAINT district_pkey PRIMARY KEY (district_number);


--
-- TOC entry 7511 (class 2606 OID 1569941)
-- Name: emp_user emp_user_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.emp_user
    ADD CONSTRAINT emp_user_pkey PRIMARY KEY (user_id);


--
-- TOC entry 7513 (class 2606 OID 1569943)
-- Name: emp_user emp_user_ssn_key; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.emp_user
    ADD CONSTRAINT emp_user_ssn_key UNIQUE (ssn);


--
-- TOC entry 7499 (class 2606 OID 1569905)
-- Name: holiday holiday_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.holiday
    ADD CONSTRAINT holiday_pkey PRIMARY KEY (holiday_date);


--
-- TOC entry 7454 (class 2606 OID 214430)
-- Name: mt940_file_status mt940_file_status_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_sapfin
--

ALTER TABLE ONLY public.mt940_file_status
    ADD CONSTRAINT mt940_file_status_pkey PRIMARY KEY (status_id);


--
-- TOC entry 7322 (class 2606 OID 27224)
-- Name: ztubt_entrymethod pk_entrymethod; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_entrymethod
    ADD CONSTRAINT pk_entrymethod PRIMARY KEY (entrymethodid);


--
-- TOC entry 7380 (class 2606 OID 27226)
-- Name: ztubt_session pk_session; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_session
    ADD CONSTRAINT pk_session PRIMARY KEY (sessionid);


--
-- TOC entry 7295 (class 2606 OID 27228)
-- Name: ztubt_adhoctimeconfig pk_ubt_adhoctimeconfig; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_adhoctimeconfig
    ADD CONSTRAINT pk_ubt_adhoctimeconfig PRIMARY KEY (adhoctimeconfigid);


--
-- TOC entry 7297 (class 2606 OID 27230)
-- Name: ztubt_adhoctimehistory pk_ubt_adhoctimehistory; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_adhoctimehistory
    ADD CONSTRAINT pk_ubt_adhoctimehistory PRIMARY KEY (adhoctimehistoryid);


--
-- TOC entry 7356 (class 2606 OID 27232)
-- Name: ztubt_payoutsports pk_ztubt_payoutsports; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_payoutsports
    ADD CONSTRAINT pk_ztubt_payoutsports PRIMARY KEY (payoutsportid);


--
-- TOC entry 7497 (class 2606 OID 1569900)
-- Name: product_category_mapping product_category_mapping_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.product_category_mapping
    ADD CONSTRAINT product_category_mapping_pkey PRIMARY KEY (product_id, category_id);


--
-- TOC entry 7501 (class 2606 OID 1569910)
-- Name: product_discount_mapping product_discount_mapping_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.product_discount_mapping
    ADD CONSTRAINT product_discount_mapping_pkey PRIMARY KEY (product_id, discount_date);


--
-- TOC entry 7495 (class 2606 OID 1569895)
-- Name: product product_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.product
    ADD CONSTRAINT product_pkey PRIMARY KEY (product_id);


--
-- TOC entry 7519 (class 2606 OID 1569964)
-- Name: report report_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.report
    ADD CONSTRAINT report_pkey PRIMARY KEY (report_id);


--
-- TOC entry 7521 (class 2606 OID 1569966)
-- Name: report report_report_name_key; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.report
    ADD CONSTRAINT report_report_name_key UNIQUE (report_name);


--
-- TOC entry 7507 (class 2606 OID 1569925)
-- Name: sale sale_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.sale
    ADD CONSTRAINT sale_pkey PRIMARY KEY (product_id, sale_date, store_number);


--
-- TOC entry 7491 (class 2606 OID 1567549)
-- Name: store store_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.store
    ADD CONSTRAINT store_pkey PRIMARY KEY (store_number);


--
-- TOC entry 7515 (class 2606 OID 1569948)
-- Name: user_district_mapping user_district_mapping_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.user_district_mapping
    ADD CONSTRAINT user_district_mapping_pkey PRIMARY KEY (user_id, district_number);


--
-- TOC entry 6870 (class 2606 OID 27234)
-- Name: ztall_businessday ztall_businessday_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztall_businessday
    ADD CONSTRAINT ztall_businessday_pk PRIMARY KEY (system, business_date);


--
-- TOC entry 6872 (class 2606 OID 27236)
-- Name: ztall_product ztall_product_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztall_product
    ADD CONSTRAINT ztall_product_pk PRIMARY KEY (product);


--
-- TOC entry 6874 (class 2606 OID 27238)
-- Name: ztbg_daily_bk20240314 ztbg_daily_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztbg_daily_bk20240314
    ADD CONSTRAINT ztbg_daily_pk PRIMARY KEY (dataorigin, calday, retailer_id);


--
-- TOC entry 7489 (class 2606 OID 1439049)
-- Name: ztbg_daily ztbg_daily_pk2; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztbg_daily
    ADD CONSTRAINT ztbg_daily_pk2 PRIMARY KEY (dataorigin, calday, retailer_id);


--
-- TOC entry 6877 (class 2606 OID 27240)
-- Name: ztes_esrm_device ztes_esrm_device_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_esrm_device
    ADD CONSTRAINT ztes_esrm_device_pk PRIMARY KEY (device_id);


--
-- TOC entry 6880 (class 2606 OID 27242)
-- Name: ztes_esrm_outlet ztes_esrm_outlet_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_esrm_outlet
    ADD CONSTRAINT ztes_esrm_outlet_pk PRIMARY KEY (outlet_id);


--
-- TOC entry 6883 (class 2606 OID 27244)
-- Name: ztes_esrm_teller ztes_esrm_teller_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_esrm_teller
    ADD CONSTRAINT ztes_esrm_teller_pk PRIMARY KEY (teller_id);


--
-- TOC entry 6887 (class 2606 OID 27246)
-- Name: ztes_este_bigwinner ztes_este_bigwinner_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_este_bigwinner
    ADD CONSTRAINT ztes_este_bigwinner_pkey PRIMARY KEY (cdc, tralnkmjf, tixnum);


--
-- TOC entry 6891 (class 2606 OID 27248)
-- Name: ztes_este_cashpurge ztes_este_cashpurge_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_este_cashpurge
    ADD CONSTRAINT ztes_este_cashpurge_pkey PRIMARY KEY (cdc, tralnkmjf, tixnum);


--
-- TOC entry 6895 (class 2606 OID 27250)
-- Name: ztes_este_uncashexpire ztes_este_uncashexpire_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_este_uncashexpire
    ADD CONSTRAINT ztes_este_uncashexpire_pkey PRIMARY KEY (cdc, tralnkmjf, tixnum);


--
-- TOC entry 6899 (class 2606 OID 27252)
-- Name: ztes_este_uncashpurge ztes_este_uncashpurge_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_este_uncashpurge
    ADD CONSTRAINT ztes_este_uncashpurge_pkey PRIMARY KEY (cdc, tralnkmjf, tixnum);


--
-- TOC entry 6902 (class 2606 OID 27254)
-- Name: ztes_inv_adj ztes_inv_adj_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_inv_adj
    ADD CONSTRAINT ztes_inv_adj_pk PRIMARY KEY (adjrec_updatecdc, adjrec_updateserial);


--
-- TOC entry 6906 (class 2606 OID 27256)
-- Name: ztes_inv_agt ztes_inv_agt_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_inv_agt
    ADD CONSTRAINT ztes_inv_agt_pk PRIMARY KEY (agentinvoice_invid, agentinvoice_agtidn, agentinvoice_finidn, agentinvoice_productid, sales_type);


--
-- TOC entry 6910 (class 2606 OID 27258)
-- Name: ztes_inv_dev ztes_inv_dev_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_inv_dev
    ADD CONSTRAINT ztes_inv_dev_pk PRIMARY KEY (deviceinvoice_salescdc, deviceinvoice_trmidn, deviceinvoice_productid, sales_type);


--
-- TOC entry 7545 (class 2606 OID 1846392)
-- Name: ztes_inv_dev_tfog2024 ztes_inv_dev_pk_1; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_inv_dev_tfog2024
    ADD CONSTRAINT ztes_inv_dev_pk_1 PRIMARY KEY (deviceinvoice_salescdc, deviceinvoice_trmidn, deviceinvoice_productid, sales_type);


--
-- TOC entry 6918 (class 2606 OID 27260)
-- Name: ztes_inv_invdef2 ztes_inv_invdef2_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_inv_invdef2
    ADD CONSTRAINT ztes_inv_invdef2_pk PRIMARY KEY (retailtype, startdate);


--
-- TOC entry 6914 (class 2606 OID 27262)
-- Name: ztes_inv_invdef ztes_inv_invdef_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_inv_invdef
    ADD CONSTRAINT ztes_inv_invdef_pk PRIMARY KEY (invoiceperiod);


--
-- TOC entry 6921 (class 2606 OID 27264)
-- Name: ztes_mjf_brdinf ztes_mjf_brdinf_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_brdinf
    ADD CONSTRAINT ztes_mjf_brdinf_pk PRIMARY KEY (cdc, journaladdress, board_id);


--
-- TOC entry 6923 (class 2606 OID 27266)
-- Name: ztes_mjf_brdnums ztes_mjf_brdnums_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_brdnums
    ADD CONSTRAINT ztes_mjf_brdnums_pk PRIMARY KEY (cdc, journaladdress, board_id);


--
-- TOC entry 6926 (class 2606 OID 27268)
-- Name: ztes_mjf_draws ztes_mjf_draws_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_draws
    ADD CONSTRAINT ztes_mjf_draws_pk PRIMARY KEY (cdc, journaladdress, draws_draw);


--
-- TOC entry 7524 (class 2606 OID 1666985)
-- Name: ztes_mjf_draws_dat184 ztes_mjf_draws_pk_1; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_draws_dat184
    ADD CONSTRAINT ztes_mjf_draws_pk_1 PRIMARY KEY (cdc, journaladdress, draws_draw);


--
-- TOC entry 7480 (class 2606 OID 1320743)
-- Name: ztes_mjf_journals_lsr_hds2 ztes_mjf_journals__lsr_hds_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_journals_lsr_hds2
    ADD CONSTRAINT ztes_mjf_journals__lsr_hds_pk PRIMARY KEY (cdc, journaladdress);


--
-- TOC entry 6929 (class 2606 OID 27270)
-- Name: ztes_mjf_journals ztes_mjf_journals_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_journals
    ADD CONSTRAINT ztes_mjf_journals_pk PRIMARY KEY (cdc, journaladdress);


--
-- TOC entry 7547 (class 2606 OID 1846402)
-- Name: ztes_mjf_journals_tfog2024 ztes_mjf_journals_pk_tfog2024; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_journals_tfog2024
    ADD CONSTRAINT ztes_mjf_journals_pk_tfog2024 PRIMARY KEY (cdc, journaladdress);


--
-- TOC entry 7485 (class 2606 OID 1320775)
-- Name: ztes_mjf_windtl_lsr_hds2 ztes_mjf_windtl_lsr_hds_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_windtl_lsr_hds2
    ADD CONSTRAINT ztes_mjf_windtl_lsr_hds_pk PRIMARY KEY (cdc, journaladdress, id);


--
-- TOC entry 6933 (class 2606 OID 27272)
-- Name: ztes_mjf_windtl ztes_mjf_windtl_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_mjf_windtl
    ADD CONSTRAINT ztes_mjf_windtl_pk PRIMARY KEY (cdc, journaladdress, id);


--
-- TOC entry 6935 (class 2606 OID 27274)
-- Name: ztes_orphans ztes_orphan_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_orphans
    ADD CONSTRAINT ztes_orphan_pkey PRIMARY KEY (cdc, requestid);


--
-- TOC entry 6937 (class 2606 OID 27276)
-- Name: ztes_orphans_requestid ztes_orphan_requestid_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_orphans_requestid
    ADD CONSTRAINT ztes_orphan_requestid_pkey PRIMARY KEY (date, requestid);


--
-- TOC entry 7476 (class 2606 OID 1438030)
-- Name: ztes_pdf_drawparam_lsr_hds2 ztes_pdf_drawparam_lsr_hds_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_drawparam_lsr_hds2
    ADD CONSTRAINT ztes_pdf_drawparam_lsr_hds_pk PRIMARY KEY (productnum, drawnumber, winset_id, przdiv_id);


--
-- TOC entry 6941 (class 2606 OID 27278)
-- Name: ztes_pdf_drawparam ztes_pdf_drawparam_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_drawparam
    ADD CONSTRAINT ztes_pdf_drawparam_pk PRIMARY KEY (productnum, drawnumber, winset_id, przdiv_id);


--
-- TOC entry 6954 (class 2606 OID 27280)
-- Name: ztes_pdf_synddrwdtl ztes_pdf_drwdtl_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_synddrwdtl
    ADD CONSTRAINT ztes_pdf_drwdtl_pkey PRIMARY KEY (hdr_recid, hdr_syndid, draw_id);


--
-- TOC entry 7478 (class 2606 OID 1312857)
-- Name: ztes_pdf_liabcon_lsr_hds2 ztes_pdf_liabcon_lsr_hds_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_liabcon_lsr_hds2
    ADD CONSTRAINT ztes_pdf_liabcon_lsr_hds_pkey PRIMARY KEY (productnum, drawnumber, bettyp_id);


--
-- TOC entry 6945 (class 2606 OID 27282)
-- Name: ztes_pdf_liabcon ztes_pdf_liabcon_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_liabcon
    ADD CONSTRAINT ztes_pdf_liabcon_pkey PRIMARY KEY (productnum, drawnumber, bettyp_id);


--
-- TOC entry 6948 (class 2606 OID 27284)
-- Name: ztes_pdf_syndbrddtl ztes_pdf_syndbrddtl_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_syndbrddtl
    ADD CONSTRAINT ztes_pdf_syndbrddtl_pk PRIMARY KEY (hdr_recid, hdr_syndid, board_id);


--
-- TOC entry 6951 (class 2606 OID 27286)
-- Name: ztes_pdf_synddef ztes_pdf_synddef_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_synddef
    ADD CONSTRAINT ztes_pdf_synddef_pkey PRIMARY KEY (currentcdc, currentdraw, item_id);


--
-- TOC entry 6957 (class 2606 OID 27288)
-- Name: ztes_pdf_syndrecs ztes_pdf_syndrecs_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_syndrecs
    ADD CONSTRAINT ztes_pdf_syndrecs_pkey PRIMARY KEY (hdr_recid, hdr_syndid);


--
-- TOC entry 6961 (class 2606 OID 27290)
-- Name: ztes_pdf_winnbr ztes_pdf_winnbr_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_winnbr
    ADD CONSTRAINT ztes_pdf_winnbr_pkey PRIMARY KEY (productnum, drawcdc, winset_id, windiv_id);


--
-- TOC entry 6965 (class 2606 OID 27292)
-- Name: ztes_pdf_winshares ztes_pdf_winshares_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_pdf_winshares
    ADD CONSTRAINT ztes_pdf_winshares_pkey PRIMARY KEY (productnum, drawcdc, winset_id, windiv_id);


--
-- TOC entry 6969 (class 2606 OID 27294)
-- Name: ztes_totallog ztes_totallog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztes_totallog
    ADD CONSTRAINT ztes_totallog_pkey PRIMARY KEY (busdate, log_id);


--
-- TOC entry 6972 (class 2606 OID 27296)
-- Name: ztetl_log ztetl_log_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztetl_log
    ADD CONSTRAINT ztetl_log_pk PRIMARY KEY (system, log_timestamp, etl_name);


--
-- TOC entry 6974 (class 2606 OID 27298)
-- Name: ztfr_txn ztfr_txn_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztfr_txn
    ADD CONSTRAINT ztfr_txn_pk PRIMARY KEY (frtxnid);


--
-- TOC entry 6976 (class 2606 OID 27300)
-- Name: ztkyc_agents ztkyc_agents_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztkyc_agents
    ADD CONSTRAINT ztkyc_agents_pkey PRIMARY KEY (id);


--
-- TOC entry 6978 (class 2606 OID 27302)
-- Name: ztkyc_applicationdurationhistory ztkyc_applicationdurationhistory_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztkyc_applicationdurationhistory
    ADD CONSTRAINT ztkyc_applicationdurationhistory_pkey PRIMARY KEY (id);


--
-- TOC entry 6980 (class 2606 OID 27304)
-- Name: ztkyc_applications ztkyc_applications_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztkyc_applications
    ADD CONSTRAINT ztkyc_applications_pkey PRIMARY KEY (id);


--
-- TOC entry 6982 (class 2606 OID 27306)
-- Name: ztkyc_applicationstatushistory ztkyc_applicationstatushistory_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztkyc_applicationstatushistory
    ADD CONSTRAINT ztkyc_applicationstatushistory_pkey PRIMARY KEY (id);


--
-- TOC entry 6984 (class 2606 OID 27308)
-- Name: ztkyc_dashboard ztkyc_dashboard_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztkyc_dashboard
    ADD CONSTRAINT ztkyc_dashboard_pkey PRIMARY KEY (id);


--
-- TOC entry 6986 (class 2606 OID 27310)
-- Name: ztkyc_kycstatus ztkyc_kycstatus_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztkyc_kycstatus
    ADD CONSTRAINT ztkyc_kycstatus_pkey PRIMARY KEY (id);


--
-- TOC entry 6988 (class 2606 OID 27312)
-- Name: ztkyc_role ztkyc_role_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztkyc_role
    ADD CONSTRAINT ztkyc_role_pkey PRIMARY KEY (id);


--
-- TOC entry 6990 (class 2606 OID 27314)
-- Name: ztmf_surveyresult ztmf_surveyresult_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmf_surveyresult
    ADD CONSTRAINT ztmf_surveyresult_pkey PRIMARY KEY (username, version, survey_start);


--
-- TOC entry 6994 (class 2606 OID 27316)
-- Name: ztmm2_cancel ztmm2_cancel_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_cancel
    ADD CONSTRAINT ztmm2_cancel_pk PRIMARY KEY (canceldate, canceltime, betid, matchcode);


--
-- TOC entry 6996 (class 2606 OID 27318)
-- Name: ztmm2_invoiceperterminal ztmm2_invoiceperterminal_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_invoiceperterminal
    ADD CONSTRAINT ztmm2_invoiceperterminal_pkey PRIMARY KEY (invoicedate, partnercode, salespointnumber, terminalcode);


--
-- TOC entry 7001 (class 2606 OID 27320)
-- Name: ztmm2_liability ztmm2_liability_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_liability
    ADD CONSTRAINT ztmm2_liability_pk PRIMARY KEY (betdate, bettime, betid, matchcode, invoiceitemno);


--
-- TOC entry 7005 (class 2606 OID 27322)
-- Name: ztmm2_purge ztmm2_purge_old_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_purge
    ADD CONSTRAINT ztmm2_purge_old_pk PRIMARY KEY (purgedate, purgetime, betid, matchcode);


--
-- TOC entry 7009 (class 2606 OID 27324)
-- Name: ztmm2_purge_dev ztmm2_purge_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_purge_dev
    ADD CONSTRAINT ztmm2_purge_pk PRIMARY KEY (purgedate, purgetime, matchcode, productclass);


--
-- TOC entry 7011 (class 2606 OID 27326)
-- Name: ztmm2_retailsummary ztmm2_retailsummary_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_retailsummary
    ADD CONSTRAINT ztmm2_retailsummary_pkey PRIMARY KEY (transactiondate, partnercode, salespointnumber, terminalcode);


--
-- TOC entry 7013 (class 2606 OID 27328)
-- Name: ztmm2_ros ztmm2_ros_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_ros
    ADD CONSTRAINT ztmm2_ros_pkey PRIMARY KEY (refundmonth, "transactionID", "betID");


--
-- TOC entry 7015 (class 2606 OID 27330)
-- Name: ztmm2_sprtliabtrans_v ztmm2_sprtliabtrans_v_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_sprtliabtrans_v
    ADD CONSTRAINT ztmm2_sprtliabtrans_v_pkey PRIMARY KEY (betid, matchcode, invoiceitemsnapshot, matchsettledate);


--
-- TOC entry 7018 (class 2606 OID 27332)
-- Name: ztmm2_timetable ztmm2_timetable_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_timetable
    ADD CONSTRAINT ztmm2_timetable_pk PRIMARY KEY (matchcode);


--
-- TOC entry 7022 (class 2606 OID 27334)
-- Name: ztmm2_valid ztmm2_valid_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_valid
    ADD CONSTRAINT ztmm2_valid_pk PRIMARY KEY (validdate, validtime, betid, matchcode);


--
-- TOC entry 7026 (class 2606 OID 27336)
-- Name: ztmm2_wager ztmm2_wager_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2_wager
    ADD CONSTRAINT ztmm2_wager_pk PRIMARY KEY (betdate, bettime, betid, matchcode);


--
-- TOC entry 7028 (class 2606 OID 27338)
-- Name: ztmm2file_liability ztmm2file_liability_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2file_liability
    ADD CONSTRAINT ztmm2file_liability_pkey PRIMARY KEY (recordtype, wagerdate, termindalid, tellerid, bookidentifier, selection, betamount, legstatus, winningamount, betslipid, betid, freebetindicator, matchdate, matchsettledate, matchcode, matchname, bettype, sales, invoiceitemsnapshot, odds, idmmaccount, marketname, is4inrunning);


--
-- TOC entry 7030 (class 2606 OID 27340)
-- Name: ztmm2file_valid ztmm2file_valid_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2file_valid
    ADD CONSTRAINT ztmm2file_valid_pkey PRIMARY KEY (recordtype, validationdate, wagerdate, validationterminalid, tellerid, wagertermindalid, bookidentifier, validationamt, betslipid, betid, freebetindicator, legstatus, matchdate, matchsettledate, matchcode, matchname, bettype, idmmaccount, marketname, is4inrunning, winningfactor);


--
-- TOC entry 7032 (class 2606 OID 27342)
-- Name: ztmm2file_wager ztmm2file_wager_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztmm2file_wager
    ADD CONSTRAINT ztmm2file_wager_pkey PRIMARY KEY (recordtype, wagerdate, termindalid, operid, bookidentifier, selection, betamount, odds, "POSITION", betslipid, betid, freebetindicator, sale, outputgst, matchdate, matchsettledate, matchcode, matchname, bettype, idmmaccount, marketname, is4inrunning);


--
-- TOC entry 7034 (class 2606 OID 27344)
-- Name: ztob_businessday ztob_businessday_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_businessday
    ADD CONSTRAINT ztob_businessday_pkey PRIMARY KEY (start_time_d);


--
-- TOC entry 7036 (class 2606 OID 27346)
-- Name: ztob_channels ztob_channels_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_channels
    ADD CONSTRAINT ztob_channels_pkey PRIMARY KEY (channel);


--
-- TOC entry 7038 (class 2606 OID 27348)
-- Name: ztob_custcalls ztob_custcalls_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custcalls
    ADD CONSTRAINT ztob_custcalls_pkey PRIMARY KEY (ob_call_id, start_date_d, start_date_t);


--
-- TOC entry 7040 (class 2606 OID 27350)
-- Name: ztob_custfastapplications ztob_custfastapplications_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custfastapplications
    ADD CONSTRAINT ztob_custfastapplications_pk PRIMARY KEY (account_no, cpm_id, status);


--
-- TOC entry 7042 (class 2606 OID 27352)
-- Name: ztob_custflagstaff ztob_custflagstaff_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custflagstaff
    ADD CONSTRAINT ztob_custflagstaff_pkey PRIMARY KEY (account_no);


--
-- TOC entry 7044 (class 2606 OID 27354)
-- Name: ztob_custlimits ztob_custlimits_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custlimits
    ADD CONSTRAINT ztob_custlimits_pkey PRIMARY KEY (limit_id);


--
-- TOC entry 7046 (class 2606 OID 27356)
-- Name: ztob_custlogin ztob_custlogin_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custlogin
    ADD CONSTRAINT ztob_custlogin_pk PRIMARY KEY (account_no, login_datetime);


--
-- TOC entry 7050 (class 2606 OID 27358)
-- Name: ztob_customer_act_date ztob_customer_act_date_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_customer_act_date
    ADD CONSTRAINT ztob_customer_act_date_pkey PRIMARY KEY (account_no);


--
-- TOC entry 7466 (class 2606 OID 490464)
-- Name: ztob_customer_anonymised ztob_customer_anonymised_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_customer_anonymised
    ADD CONSTRAINT ztob_customer_anonymised_pk PRIMARY KEY (account_no);


--
-- TOC entry 7052 (class 2606 OID 27360)
-- Name: ztob_customer_backup ztob_customer_backup_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_customer_backup
    ADD CONSTRAINT ztob_customer_backup_pkey PRIMARY KEY (business_day, account_no);


--
-- TOC entry 7054 (class 2606 OID 27362)
-- Name: ztob_customer_master ztob_customer_master_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_customer_master
    ADD CONSTRAINT ztob_customer_master_pkey PRIMARY KEY (account_no);


--
-- TOC entry 7048 (class 2606 OID 27364)
-- Name: ztob_customer ztob_customer_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_customer
    ADD CONSTRAINT ztob_customer_pkey PRIMARY KEY (account_no);


--
-- TOC entry 7056 (class 2606 OID 27366)
-- Name: ztob_customer_temp ztob_customer_temp_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_customer_temp
    ADD CONSTRAINT ztob_customer_temp_pkey PRIMARY KEY (business_day, account_no);


--
-- TOC entry 7058 (class 2606 OID 27368)
-- Name: ztob_customer_test ztob_customer_test_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_customer_test
    ADD CONSTRAINT ztob_customer_test_pkey PRIMARY KEY (business_day, account_no);


--
-- TOC entry 7461 (class 2606 OID 485918)
-- Name: ztob_customer_update_trail ztob_customer_update_trail_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_customer_update_trail
    ADD CONSTRAINT ztob_customer_update_trail_pk PRIMARY KEY (account_no, last_updated_date);


--
-- TOC entry 7060 (class 2606 OID 27370)
-- Name: ztob_custstatusflag ztob_custstatusflag_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custstatusflag
    ADD CONSTRAINT ztob_custstatusflag_pkey PRIMARY KEY (cust_flag_id);


--
-- TOC entry 7062 (class 2606 OID 27372)
-- Name: ztob_custstatuslog ztob_custstatuslog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custstatuslog
    ADD CONSTRAINT ztob_custstatuslog_pkey PRIMARY KEY (account_no, last_updated_date);


--
-- TOC entry 7064 (class 2606 OID 27374)
-- Name: ztob_custsweepback ztob_custsweepback_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custsweepback
    ADD CONSTRAINT ztob_custsweepback_pk PRIMARY KEY (account_no, payment_method, last_updated_date);


--
-- TOC entry 7066 (class 2606 OID 27376)
-- Name: ztob_custtnc ztob_custtnc_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_custtnc
    ADD CONSTRAINT ztob_custtnc_pkey PRIMARY KEY (cust_tnc_id);


--
-- TOC entry 7068 (class 2606 OID 27378)
-- Name: ztob_exclusionhistory ztob_exclusionhistory_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_exclusionhistory
    ADD CONSTRAINT ztob_exclusionhistory_pkey PRIMARY KEY (exclude_record_id, last_updated_date);


--
-- TOC entry 7072 (class 2606 OID 27380)
-- Name: ztob_journal ztob_journal_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_journal
    ADD CONSTRAINT ztob_journal_pk PRIMARY KEY (journal_no, transaction_no, creation_date_d, creation_date_t);


--
-- TOC entry 7074 (class 2606 OID 27382)
-- Name: ztob_journal_temp ztob_journal_temp_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_journal_temp
    ADD CONSTRAINT ztob_journal_temp_pkey PRIMARY KEY (journal_no, transaction_no, creation_date_d, creation_date_t);


--
-- TOC entry 7084 (class 2606 OID 27384)
-- Name: ztob_lottery_patch ztob_lottery_patch_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_lottery_patch
    ADD CONSTRAINT ztob_lottery_patch_pk PRIMARY KEY (bet_id, creation_date_d, creation_date_t);


--
-- TOC entry 7082 (class 2606 OID 27386)
-- Name: ztob_lottery ztob_lottery_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_lottery
    ADD CONSTRAINT ztob_lottery_pk PRIMARY KEY (bet_id, creation_date_d, creation_date_t);


--
-- TOC entry 7087 (class 2606 OID 27388)
-- Name: ztob_lotterycustdailystats ztob_lotterycustdailystats_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_lotterycustdailystats
    ADD CONSTRAINT ztob_lotterycustdailystats_pk PRIMARY KEY (account_no, channel, last_updated_date);


--
-- TOC entry 7090 (class 2606 OID 27390)
-- Name: ztob_lotterycuststats ztob_lotterycuststats_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_lotterycuststats
    ADD CONSTRAINT ztob_lotterycuststats_pk PRIMARY KEY (account_no, channel);


--
-- TOC entry 7093 (class 2606 OID 27392)
-- Name: ztob_lotterysubscriptions ztob_lotterysubscriptions_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_lotterysubscriptions
    ADD CONSTRAINT ztob_lotterysubscriptions_pk PRIMARY KEY (account_no, slip_id, sub_id, attempt_draw_id);


--
-- TOC entry 7463 (class 2606 OID 489741)
-- Name: ztob_namematch ztob_namematch_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_namematch
    ADD CONSTRAINT ztob_namematch_pk PRIMARY KEY (cr_date, pmt_or_refund_id);


--
-- TOC entry 7592 (class 2606 OID 2463137)
-- Name: ztob_pmttransaction_phu ztob_pmttransaction_phu_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_pmttransaction_phu
    ADD CONSTRAINT ztob_pmttransaction_phu_pk PRIMARY KEY (ref_id, creation_date_d, creation_date_t);


--
-- TOC entry 7095 (class 2606 OID 27394)
-- Name: ztob_reactivate ztob_reactivate_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_reactivate
    ADD CONSTRAINT ztob_reactivate_pkey PRIMARY KEY (business_day, account_no);


--
-- TOC entry 7099 (class 2606 OID 27396)
-- Name: ztob_sportbets ztob_sportbets_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportbets
    ADD CONSTRAINT ztob_sportbets_pk PRIMARY KEY (bet_id, match_id, creation_date_d, creation_date_t);


--
-- TOC entry 7101 (class 2606 OID 27398)
-- Name: ztob_sportbets_temp ztob_sportbets_temp_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportbets_temp
    ADD CONSTRAINT ztob_sportbets_temp_pkey PRIMARY KEY (bet_id, match_id, creation_date_d, creation_date_t);


--
-- TOC entry 7103 (class 2606 OID 27400)
-- Name: ztob_sportbets_wager ztob_sportbets_wager_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportbets_wager
    ADD CONSTRAINT ztob_sportbets_wager_pkey PRIMARY KEY (business_day, account_no, bet_type, channel, multiple_bet, bir, market_no, match_id, sports_type);


--
-- TOC entry 7111 (class 2606 OID 27402)
-- Name: ztob_sportbetssettled_cancel ztob_sportbetssettled_cancel_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportbetssettled_cancel
    ADD CONSTRAINT ztob_sportbetssettled_cancel_pkey PRIMARY KEY (business_day, account_no, bet_type, leg_status, channel, multiple_bet, bir, market_no, match_id, sports_type);


--
-- TOC entry 7113 (class 2606 OID 27404)
-- Name: ztob_sportbetssettled_liability ztob_sportbetssettled_liability_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportbetssettled_liability
    ADD CONSTRAINT ztob_sportbetssettled_liability_pkey PRIMARY KEY (business_day, account_no, bet_type, leg_status, channel, multiple_bet, bir, market_no, match_id, sports_type);


--
-- TOC entry 7109 (class 2606 OID 27406)
-- Name: ztob_sportbetssettled ztob_sportbetssettled_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportbetssettled
    ADD CONSTRAINT ztob_sportbetssettled_pk PRIMARY KEY (bet_id, match_id, creation_date_d, creation_date_t);


--
-- TOC entry 7115 (class 2606 OID 27408)
-- Name: ztob_sportbetssettled_valid ztob_sportbetssettled_valid_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportbetssettled_valid
    ADD CONSTRAINT ztob_sportbetssettled_valid_pkey PRIMARY KEY (business_day, account_no, bet_type, leg_status, channel, multiple_bet, bir, market_no, match_id, sports_type);


--
-- TOC entry 7117 (class 2606 OID 27410)
-- Name: ztob_sportreport40 ztob_sportreport40_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportreport40
    ADD CONSTRAINT ztob_sportreport40_pkey PRIMARY KEY (bet_id, match_id, market_id, selection_id);


--
-- TOC entry 7119 (class 2606 OID 27412)
-- Name: ztob_sportscustdailystats ztob_sportscustdailystats_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportscustdailystats
    ADD CONSTRAINT ztob_sportscustdailystats_pkey PRIMARY KEY (account_no, channel, last_updated_date);


--
-- TOC entry 7121 (class 2606 OID 27414)
-- Name: ztob_sportscuststats ztob_sportscuststats_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_sportscuststats
    ADD CONSTRAINT ztob_sportscuststats_pkey PRIMARY KEY (account_no, channel);


--
-- TOC entry 7123 (class 2606 OID 27416)
-- Name: ztob_timetable ztob_timetable_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_timetable
    ADD CONSTRAINT ztob_timetable_pkey PRIMARY KEY (match_id);


--
-- TOC entry 7125 (class 2606 OID 27418)
-- Name: ztob_timetableselections ztob_timetableselections_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztob_timetableselections
    ADD CONSTRAINT ztob_timetableselections_pkey PRIMARY KEY (match_id, market_id, selection_id);


--
-- TOC entry 7127 (class 2606 OID 27420)
-- Name: ztosd_eod_employee ztosd_eod_employee_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztosd_eod_employee
    ADD CONSTRAINT ztosd_eod_employee_pkey PRIMARY KEY (date, branch, employee, employee_description);


--
-- TOC entry 7129 (class 2606 OID 27422)
-- Name: ztosd_eod_product ztosd_eod_product_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztosd_eod_product
    ADD CONSTRAINT ztosd_eod_product_pkey PRIMARY KEY (date, branch, product, category, company_code);


--
-- TOC entry 7131 (class 2606 OID 27424)
-- Name: ztosd_md_branch_insurance ztosd_md_branch_insurance_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztosd_md_branch_insurance
    ADD CONSTRAINT ztosd_md_branch_insurance_pkey PRIMARY KEY (branch);


--
-- TOC entry 7474 (class 2606 OID 1072972)
-- Name: ztosd_md_branch_insurance_bk20240314 ztosd_md_branch_insurance_pkey2; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztosd_md_branch_insurance_bk20240314
    ADD CONSTRAINT ztosd_md_branch_insurance_pkey2 PRIMARY KEY (branch);


--
-- TOC entry 7133 (class 2606 OID 27426)
-- Name: ztosd_md_product ztosd_md_product_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztosd_md_product
    ADD CONSTRAINT ztosd_md_product_pkey PRIMARY KEY (product);


--
-- TOC entry 7135 (class 2606 OID 27428)
-- Name: ztosd_nets ztosd_nets_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztosd_nets
    ADD CONSTRAINT ztosd_nets_pkey PRIMARY KEY (date, branch, eftpos, cash_card);


--
-- TOC entry 7137 (class 2606 OID 27430)
-- Name: ztosd_svs ztosd_svs_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztosd_svs
    ADD CONSTRAINT ztosd_svs_pkey PRIMARY KEY (date, claim_id, draw_number, ticket_number, serial_number, prize_code, svs_id, terminal_number);


--
-- TOC entry 7139 (class 2606 OID 27432)
-- Name: ztosd_tote ztosd_tote_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztosd_tote
    ADD CONSTRAINT ztosd_tote_pkey PRIMARY KEY (date, branch);


--
-- TOC entry 7142 (class 2606 OID 27434)
-- Name: ztrtms2_customer ztrtms2_customer_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms2_customer
    ADD CONSTRAINT ztrtms2_customer_pkey PRIMARY KEY (auditlogid);


--
-- TOC entry 7146 (class 2606 OID 27436)
-- Name: ztrtms2_inv_dev ztrtms2_inv_dev_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms2_inv_dev
    ADD CONSTRAINT ztrtms2_inv_dev_pkey PRIMARY KEY (salesdate, terminal, product, salestype);


--
-- TOC entry 7149 (class 2606 OID 27438)
-- Name: ztrtms2_retailer_master ztrtms2_retailer_master_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms2_retailer_master
    ADD CONSTRAINT ztrtms2_retailer_master_pkey PRIMARY KEY (retailer);


--
-- TOC entry 7153 (class 2606 OID 27440)
-- Name: ztrtms2_terminal_master ztrtms2_terminal_master_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms2_terminal_master
    ADD CONSTRAINT ztrtms2_terminal_master_pkey PRIMARY KEY (terminal);


--
-- TOC entry 7157 (class 2606 OID 27442)
-- Name: ztrtms2_trans_horse ztrtms2_trans_horse_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms2_trans_horse
    ADD CONSTRAINT ztrtms2_trans_horse_pkey PRIMARY KEY (busdate, transheaderid, transtype);


--
-- TOC entry 7162 (class 2606 OID 27444)
-- Name: ztrtms2_trans_lottery ztrtms2_trans_lottery_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms2_trans_lottery
    ADD CONSTRAINT ztrtms2_trans_lottery_pkey PRIMARY KEY (busdate, transheaderid, boardid, drawid, transtype);


--
-- TOC entry 7167 (class 2606 OID 27446)
-- Name: ztrtms2_trans_sports ztrtms2_trans_sports_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms2_trans_sports
    ADD CONSTRAINT ztrtms2_trans_sports_pkey PRIMARY KEY (busdate, transheaderid, matchid, transtype);


--
-- TOC entry 7171 (class 2606 OID 27448)
-- Name: ztrtms2_user_master ztrtms2_user_master_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms2_user_master
    ADD CONSTRAINT ztrtms2_user_master_pkey PRIMARY KEY (userseqid);


--
-- TOC entry 7541 (class 2606 OID 1840218)
-- Name: ztrtms_inout_paymentdetail ztrtms_inout_paymentdetail_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_inout_paymentdetail
    ADD CONSTRAINT ztrtms_inout_paymentdetail_pkey PRIMARY KEY (inout_paymentdetailid);


--
-- TOC entry 7178 (class 2606 OID 27450)
-- Name: ztrtms_inv_agt ztrtms_inv_agt_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_inv_agt
    ADD CONSTRAINT ztrtms_inv_agt_pkey PRIMARY KEY (retailer, invoiceid, product, salestype);


--
-- TOC entry 7182 (class 2606 OID 27452)
-- Name: ztrtms_inv_def ztrtms_inv_def_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_inv_def
    ADD CONSTRAINT ztrtms_inv_def_pkey PRIMARY KEY (invoiceid);


--
-- TOC entry 7186 (class 2606 OID 27454)
-- Name: ztrtms_inv_dev ztrtms_inv_dev_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_inv_dev
    ADD CONSTRAINT ztrtms_inv_dev_pkey PRIMARY KEY (salesdate, terminal, product, salestype);


--
-- TOC entry 7174 (class 2606 OID 27456)
-- Name: ztrtms_inv_adj ztrtms_location_adj_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_inv_adj
    ADD CONSTRAINT ztrtms_location_adj_pkey PRIMARY KEY (adjdate, adjserial);


--
-- TOC entry 7188 (class 2606 OID 27458)
-- Name: ztrtms_location_oprhrs ztrtms_location_oprhrs_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_location_oprhrs
    ADD CONSTRAINT ztrtms_location_oprhrs_pkey PRIMARY KEY (retailer, terminal, signondate, signontime);


--
-- TOC entry 7581 (class 2606 OID 2046966)
-- Name: ztrtms_retailer_master_bk_before_tfog ztrtms_retailer_master_bk_before_tfog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_retailer_master_bk_before_tfog
    ADD CONSTRAINT ztrtms_retailer_master_bk_before_tfog_pkey PRIMARY KEY (retailer);


--
-- TOC entry 7191 (class 2606 OID 27460)
-- Name: ztrtms_retailer_master ztrtms_retailer_master_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_retailer_master
    ADD CONSTRAINT ztrtms_retailer_master_pkey PRIMARY KEY (retailer);


--
-- TOC entry 7195 (class 2606 OID 27462)
-- Name: ztrtms_terminal_master ztrtms_terminal_master_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_terminal_master
    ADD CONSTRAINT ztrtms_terminal_master_pkey PRIMARY KEY (terminal);


--
-- TOC entry 7199 (class 2606 OID 27464)
-- Name: ztrtms_trans_entry ztrtms_trans_entry_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_trans_entry
    ADD CONSTRAINT ztrtms_trans_entry_pkey PRIMARY KEY (busdate, transheaderid, transtype);


--
-- TOC entry 7203 (class 2606 OID 27466)
-- Name: ztrtms_trans_horse ztrtms_trans_horse_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_trans_horse
    ADD CONSTRAINT ztrtms_trans_horse_pkey PRIMARY KEY (busdate, transheaderid, transtype);


--
-- TOC entry 7208 (class 2606 OID 27468)
-- Name: ztrtms_trans_lottery ztrtms_trans_lottery_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_trans_lottery
    ADD CONSTRAINT ztrtms_trans_lottery_pkey PRIMARY KEY (busdate, transheaderid, boardid, drawid, transtype);


--
-- TOC entry 7213 (class 2606 OID 27470)
-- Name: ztrtms_trans_sports ztrtms_trans_sports_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_trans_sports
    ADD CONSTRAINT ztrtms_trans_sports_pkey PRIMARY KEY (busdate, transheaderid, matchid, transtype);


--
-- TOC entry 7217 (class 2606 OID 27472)
-- Name: ztrtms_user_master ztrtms_user_master_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztrtms_user_master
    ADD CONSTRAINT ztrtms_user_master_pkey PRIMARY KEY (userseqid);


--
-- TOC entry 7220 (class 2606 OID 27474)
-- Name: ztsapfi_cca ztsapfi_cca_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_cca
    ADD CONSTRAINT ztsapfi_cca_pkey PRIMARY KEY (chart_of_accounts, controlling_area, company_code, cost_center, cost_element, currency_type, customer, fm_area, functional_area, fund, gl_account, "grant", valuation_view, version, value_type, fiscal_year_period, currency, plan_category, ledger, profit_center, project_definition, wbs_element);


--
-- TOC entry 7223 (class 2606 OID 27476)
-- Name: ztsapfi_cca_new ztsapfi_cca_pkey_new; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_cca_new
    ADD CONSTRAINT ztsapfi_cca_pkey_new PRIMARY KEY (chart_of_accounts, controlling_area, company_code, cost_center, cost_element, currency_type, customer, fm_area, functional_area, fund, gl_account, "grant", valuation_view, version, value_type, fiscal_year_period, currency, plan_category, ledger, profit_center, project_definition, wbs_element);


--
-- TOC entry 7225 (class 2606 OID 27478)
-- Name: ztsapfi_cchierarchy ztsapfi_cchierarchy_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_cchierarchy
    ADD CONSTRAINT ztsapfi_cchierarchy_pkey PRIMARY KEY (controlling_area, cost_center_hierarchy, cost_center_range1);


--
-- TOC entry 7227 (class 2606 OID 2431248)
-- Name: ztsapfi_ccmaster ztsapfi_ccmaster_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_ccmaster
    ADD CONSTRAINT ztsapfi_ccmaster_pkey PRIMARY KEY (cost_center, company_code, controlling_area, valid_to);


--
-- TOC entry 7230 (class 2606 OID 27482)
-- Name: ztsapfi_copa ztsapfi_copa_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_copa
    ADD CONSTRAINT ztsapfi_copa_pkey PRIMARY KEY (bet_mode, business_area, chart_of_accounts, company_code, controlling_area, cost_center, cost_element, country, customer, draw_number, league_code, material, product_id, product_hierarchy, profit_center, valuation_view, value_type, version, fiscal_year_period, controlling_currency, object_currency, transaction_currency);


--
-- TOC entry 7232 (class 2606 OID 27499)
-- Name: ztsapfi_customer_master ztsapfi_customer_master_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_customer_master
    ADD CONSTRAINT ztsapfi_customer_master_pkey PRIMARY KEY (customer_no, company_code);


--
-- TOC entry 7234 (class 2606 OID 27501)
-- Name: ztsapfi_doc_header_text ztsapfi_doc_header_text_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_doc_header_text
    ADD CONSTRAINT ztsapfi_doc_header_text_pkey PRIMARY KEY (document_number, company_code, fiscal_year);


--
-- TOC entry 7236 (class 2606 OID 27503)
-- Name: ztsapfi_enddate_filter ztsapfi_enddate_filter_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_enddate_filter
    ADD CONSTRAINT ztsapfi_enddate_filter_pkey PRIMARY KEY (interface_name, interface_type);


--
-- TOC entry 7242 (class 2606 OID 27505)
-- Name: ztsapfi_gamsd_db ztsapfi_gamsd_db_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_gamsd_db
    ADD CONSTRAINT ztsapfi_gamsd_db_pkey PRIMARY KEY (companycode, transdate, gamecode, drawno, retailerid);


--
-- TOC entry 7239 (class 2606 OID 27507)
-- Name: ztsapfi_gamsd ztsapfi_gamsd_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_gamsd
    ADD CONSTRAINT ztsapfi_gamsd_pkey PRIMARY KEY (companycode, transdate, gamecode, drawno, retailerid);


--
-- TOC entry 7246 (class 2606 OID 27509)
-- Name: ztsapfi_gdyup ztsapfi_gdyup_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_gdyup
    ADD CONSTRAINT ztsapfi_gdyup_pkey PRIMARY KEY (companycode, transdate, retailerid, gamecode, transmode, transcode, scoreid, drawnum);


--
-- TOC entry 7249 (class 2606 OID 27511)
-- Name: ztsapfi_gibgf ztsapfi_gibgf_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_gibgf
    ADD CONSTRAINT ztsapfi_gibgf_pkey PRIMARY KEY (companycode, transdate, retailerid, drawnum, sign);


--
-- TOC entry 7252 (class 2606 OID 27513)
-- Name: ztsapfi_gl ztsapfi_gl_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_gl
    ADD CONSTRAINT ztsapfi_gl_pkey PRIMARY KEY (company_code, fiscal_year, document_number, item_number, source_ledger, ledger);


--
-- TOC entry 7254 (class 2606 OID 27515)
-- Name: ztsapfi_glhierarchy ztsapfi_glhierarchy_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_glhierarchy
    ADD CONSTRAINT ztsapfi_glhierarchy_pkey PRIMARY KEY (gl_account_hierarchy, gl_range1);


--
-- TOC entry 7256 (class 2606 OID 27517)
-- Name: ztsapfi_glmaster ztsapfi_glmaster_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_glmaster
    ADD CONSTRAINT ztsapfi_glmaster_pkey PRIMARY KEY (gl_account, company_code);


--
-- TOC entry 7258 (class 2606 OID 27519)
-- Name: ztsapfi_grfun ztsapfi_grfun_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_grfun
    ADD CONSTRAINT ztsapfi_grfun_pkey PRIMARY KEY (companycode, transdate, retailtype, bankcode, drawnum);


--
-- TOC entry 7261 (class 2606 OID 2333385)
-- Name: ztsapfi_gunwn ztsapfi_gunwn_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_gunwn
    ADD CONSTRAINT ztsapfi_gunwn_pkey PRIMARY KEY (transdate, companycode, gamecode, unclaimtype);


--
-- TOC entry 7263 (class 2606 OID 27523)
-- Name: ztsapfi_guswn ztsapfi_guswn_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_guswn
    ADD CONSTRAINT ztsapfi_guswn_pkey PRIMARY KEY (companycode, transdate, gamecode, drawnum, retailerid);


--
-- TOC entry 7266 (class 2606 OID 27525)
-- Name: ztsapfi_gwapp ztsapfi_gwapp_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_gwapp
    ADD CONSTRAINT ztsapfi_gwapp_pkey PRIMARY KEY (companycode, drawdate, gamecode);


--
-- TOC entry 7268 (class 2606 OID 27527)
-- Name: ztsapfi_parameter ztsapfi_parameter_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_parameter
    ADD CONSTRAINT ztsapfi_parameter_pkey PRIMARY KEY (field_key);


--
-- TOC entry 7270 (class 2606 OID 27529)
-- Name: ztsapfi_pchierarchy ztsapfi_pchierarchy_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_pchierarchy
    ADD CONSTRAINT ztsapfi_pchierarchy_pkey PRIMARY KEY (controlling_area, profit_center_hierarchy, profit_center_range1);


--
-- TOC entry 7272 (class 2606 OID 27531)
-- Name: ztsapfi_pcmaster ztsapfi_pcmaster_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsapfi_pcmaster
    ADD CONSTRAINT ztsapfi_pcmaster_pkey PRIMARY KEY (profit_center, company_code, controlling_area, valid_to);


--
-- TOC entry 7274 (class 2606 OID 27533)
-- Name: ztsf_empdata ztsf_empdata_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsf_empdata
    ADD CONSTRAINT ztsf_empdata_pk PRIMARY KEY (employee_id);


--
-- TOC entry 7276 (class 2606 OID 27535)
-- Name: ztsvcs_case ztsvcs_case_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsvcs_case
    ADD CONSTRAINT ztsvcs_case_pk PRIMARY KEY (casenumber);


--
-- TOC entry 7278 (class 2606 OID 27537)
-- Name: ztsvcs_edmsubscription ztsvcs_edmsubscription_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsvcs_edmsubscription
    ADD CONSTRAINT ztsvcs_edmsubscription_pk PRIMARY KEY (subscriptionlistid, customerid);


--
-- TOC entry 7280 (class 2606 OID 27539)
-- Name: ztsvcs_review ztsvcs_review_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsvcs_review
    ADD CONSTRAINT ztsvcs_review_pk PRIMARY KEY (casereviewactivityid);


--
-- TOC entry 7282 (class 2606 OID 27541)
-- Name: ztsvcs_rootcause ztsvcs_rootcause_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsvcs_rootcause
    ADD CONSTRAINT ztsvcs_rootcause_pk PRIMARY KEY (caserootcauseid, casenumber);


--
-- TOC entry 7284 (class 2606 OID 27543)
-- Name: ztsvcs_sms ztsvcs_sms_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztsvcs_sms
    ADD CONSTRAINT ztsvcs_sms_pk PRIMARY KEY (smsid);


--
-- TOC entry 7555 (class 2606 OID 2036684)
-- Name: ztubt_4d_placedbettransactionlineitem_bk_before_tfog ztubt_4d_placedbettransactionlineitem_bk_before_tfog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_4d_placedbettransactionlineitem_bk_before_tfog
    ADD CONSTRAINT ztubt_4d_placedbettransactionlineitem_bk_before_tfog_pkey PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7286 (class 2606 OID 27545)
-- Name: ztubt_4d_placedbettransactionlineitem ztubt_4d_placedbettransactionlineitem_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_4d_placedbettransactionlineitem
    ADD CONSTRAINT ztubt_4d_placedbettransactionlineitem_pk PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7292 (class 2606 OID 467372)
-- Name: ztubt_4d_placedbettransactionlineitemnumber ztubt_4d_placedbettransactionlineitemnumber_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_4d_placedbettransactionlineitemnumber
    ADD CONSTRAINT ztubt_4d_placedbettransactionlineitemnumber_pk PRIMARY KEY (lineitemnumberid);


--
-- TOC entry 7300 (class 2606 OID 27550)
-- Name: ztubt_adjustinvoice ztubt_adjustinvoice_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_adjustinvoice
    ADD CONSTRAINT ztubt_adjustinvoice_pk PRIMARY KEY (adjustinvoiceid);


--
-- TOC entry 7302 (class 2606 OID 27552)
-- Name: ztubt_admissionvouchertransaction ztubt_admissionvouchertransaction_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_admissionvouchertransaction
    ADD CONSTRAINT ztubt_admissionvouchertransaction_pk PRIMARY KEY (vouchertransactionid);


--
-- TOC entry 7304 (class 2606 OID 27554)
-- Name: ztubt_cancelledbetticket ztubt_cancelledbetticket_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_cancelledbetticket
    ADD CONSTRAINT ztubt_cancelledbetticket_pk PRIMARY KEY (tranheaderid);


--
-- TOC entry 7306 (class 2606 OID 27556)
-- Name: ztubt_cancelledbetticketlifecyclestate ztubt_cancelledbetticketlifecyclestate_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_cancelledbetticketlifecyclestate
    ADD CONSTRAINT ztubt_cancelledbetticketlifecyclestate_pk PRIMARY KEY (cancelledbetlifecycleid);


--
-- TOC entry 7308 (class 2606 OID 27558)
-- Name: ztubt_cart ztubt_cart_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_cart
    ADD CONSTRAINT ztubt_cart_pk PRIMARY KEY (cartid);


--
-- TOC entry 7534 (class 2606 OID 1839570)
-- Name: ztubt_cashbox ztubt_cashbox_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_cashbox
    ADD CONSTRAINT ztubt_cashbox_pkey PRIMARY KEY (cashboxtranid);


--
-- TOC entry 7312 (class 2606 OID 27560)
-- Name: ztubt_chain ztubt_chain_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_chain
    ADD CONSTRAINT ztubt_chain_pk PRIMARY KEY (chid);


--
-- TOC entry 7314 (class 2606 OID 27562)
-- Name: ztubt_charitytickettransaction ztubt_charitytickettransaction_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_charitytickettransaction
    ADD CONSTRAINT ztubt_charitytickettransaction_pk PRIMARY KEY (charitytransactionid);


--
-- TOC entry 7528 (class 2606 OID 1806051)
-- Name: ztubt_drawdates_bb ztubt_drawdates_aa_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_drawdates_bb
    ADD CONSTRAINT ztubt_drawdates_aa_pk PRIMARY KEY (drawdatesid);


--
-- TOC entry 7575 (class 2606 OID 2044906)
-- Name: ztubt_drawdates_bk_before_tfog ztubt_drawdates_bk_before_tfog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_drawdates_bk_before_tfog
    ADD CONSTRAINT ztubt_drawdates_bk_before_tfog_pkey PRIMARY KEY (drawdatesid);


--
-- TOC entry 7578 (class 2606 OID 2044913)
-- Name: ztubt_drawdates_master_bk_before_tfog ztubt_drawdates_master_bk_before_tfog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_drawdates_master_bk_before_tfog
    ADD CONSTRAINT ztubt_drawdates_master_bk_before_tfog_pkey PRIMARY KEY (drawdatesmasterid);


--
-- TOC entry 7320 (class 2606 OID 27564)
-- Name: ztubt_drawdates_master ztubt_drawdates_master_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_drawdates_master
    ADD CONSTRAINT ztubt_drawdates_master_pk PRIMARY KEY (drawdatesmasterid);


--
-- TOC entry 7526 (class 2606 OID 1806041)
-- Name: ztubt_drawdates_new ztubt_drawdates_new_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_drawdates_new
    ADD CONSTRAINT ztubt_drawdates_new_pk PRIMARY KEY (drawdatesid);


--
-- TOC entry 7317 (class 2606 OID 27566)
-- Name: ztubt_drawdates ztubt_drawdates_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_drawdates
    ADD CONSTRAINT ztubt_drawdates_pk PRIMARY KEY (drawdatesid);


--
-- TOC entry 7324 (class 2606 OID 27570)
-- Name: ztubt_funding ztubt_funding_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_funding
    ADD CONSTRAINT ztubt_funding_pk PRIMARY KEY (fundingid);


--
-- TOC entry 7326 (class 2606 OID 27572)
-- Name: ztubt_gstconfig ztubt_gstconfig_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_gstconfig
    ADD CONSTRAINT ztubt_gstconfig_pk PRIMARY KEY (gstconfigid);


--
-- TOC entry 7559 (class 2606 OID 2036696)
-- Name: ztubt_horse_placedbettransactionlineitem_bk_before_tfog ztubt_horse_placedbettransactionlineitem_bk_before_tfog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_horse_placedbettransactionlineitem_bk_before_tfog
    ADD CONSTRAINT ztubt_horse_placedbettransactionlineitem_bk_before_tfog_pkey PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7330 (class 2606 OID 27574)
-- Name: ztubt_horse_placedbettransactionlineitem ztubt_horse_placedbettransactionlineitem_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_horse_placedbettransactionlineitem
    ADD CONSTRAINT ztubt_horse_placedbettransactionlineitem_pk PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7553 (class 2606 OID 2036378)
-- Name: ztubt_location_bk20241015 ztubt_location_bk20241015_test_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_location_bk20241015
    ADD CONSTRAINT ztubt_location_bk20241015_test_pkey PRIMARY KEY (locid);


--
-- TOC entry 7337 (class 2606 OID 27576)
-- Name: ztubt_location ztubt_location_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_location
    ADD CONSTRAINT ztubt_location_pk PRIMARY KEY (locid);


--
-- TOC entry 7339 (class 2606 OID 27578)
-- Name: ztubt_locationgsthistory ztubt_locationgsthistory_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_locationgsthistory
    ADD CONSTRAINT ztubt_locationgsthistory_pk PRIMARY KEY (locationgsthistoryid);


--
-- TOC entry 7341 (class 2606 OID 27580)
-- Name: ztubt_locationstatuschange ztubt_locationstatuschange_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_locationstatuschange
    ADD CONSTRAINT ztubt_locationstatuschange_pk PRIMARY KEY (locstatusid);


--
-- TOC entry 7346 (class 2606 OID 27582)
-- Name: ztubt_lookupvalueconfig ztubt_lookupvalueconfig_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_lookupvalueconfig
    ADD CONSTRAINT ztubt_lookupvalueconfig_pk PRIMARY KEY (lookupvalueid);


--
-- TOC entry 7348 (class 2606 OID 27584)
-- Name: ztubt_offlineproductheader ztubt_offlineproductheader_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_offlineproductheader
    ADD CONSTRAINT ztubt_offlineproductheader_pk PRIMARY KEY (transactionheaderid);


--
-- TOC entry 7350 (class 2606 OID 27586)
-- Name: ztubt_operatinghours ztubt_operatinghours_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_operatinghours
    ADD CONSTRAINT ztubt_operatinghours_pk PRIMARY KEY (operatinghoursid);


--
-- TOC entry 7354 (class 2606 OID 27588)
-- Name: ztubt_paymentdetail ztubt_paymentdetail_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_paymentdetail
    ADD CONSTRAINT ztubt_paymentdetail_pk PRIMARY KEY (paymentdetailid);


--
-- TOC entry 7538 (class 2606 OID 1840193)
-- Name: ztubt_paymentheader ztubt_paymentheader_pk; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_paymentheader
    ADD CONSTRAINT ztubt_paymentheader_pk PRIMARY KEY (paymentid);


--
-- TOC entry 7469 (class 2606 OID 2003972)
-- Name: ztubt_paynowtransaction ztubt_paynowtransaction_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_paynowtransaction
    ADD CONSTRAINT ztubt_paynowtransaction_pkey PRIMARY KEY (transactionreference);


--
-- TOC entry 7367 (class 2606 OID 27590)
-- Name: ztubt_placedbettransactionheaderlifecyclestate ztubt_pbth_lifecyclestate_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_placedbettransactionheaderlifecyclestate
    ADD CONSTRAINT ztubt_pbth_lifecyclestate_pk PRIMARY KEY (placedbetlifecycleid);


--
-- TOC entry 7583 (class 2606 OID 2308171)
-- Name: ztubt_pbth_partition_test ztubt_pbth_partition_test_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.ztubt_pbth_partition_test
    ADD CONSTRAINT ztubt_pbth_partition_test_pkey PRIMARY KEY (tranheaderid, createddate);


--
-- TOC entry 7585 (class 2606 OID 2308184)
-- Name: ztubt_pbth_partition_test_2022 ztubt_pbth_partition_test_2022_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.ztubt_pbth_partition_test_2022
    ADD CONSTRAINT ztubt_pbth_partition_test_2022_pkey PRIMARY KEY (tranheaderid, createddate);


--
-- TOC entry 7362 (class 2606 OID 27604)
-- Name: ztubt_placedbettransactionheader ztubt_placedbettransactionheader_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_placedbettransactionheader
    ADD CONSTRAINT ztubt_placedbettransactionheader_pk PRIMARY KEY (tranheaderid);


--
-- TOC entry 7371 (class 2606 OID 27610)
-- Name: ztubt_product ztubt_product_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_product
    ADD CONSTRAINT ztubt_product_pk PRIMARY KEY (prodid);


--
-- TOC entry 7472 (class 2606 OID 958412)
-- Name: ztubt_reconciliationresult ztubt_reconciliationresult_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_reconciliationresult
    ADD CONSTRAINT ztubt_reconciliationresult_pkey PRIMARY KEY (reconciliationresultid);


--
-- TOC entry 7374 (class 2606 OID 27612)
-- Name: ztubt_recovery ztubt_recovery_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_recovery
    ADD CONSTRAINT ztubt_recovery_pk PRIMARY KEY (recoveryid);


--
-- TOC entry 7376 (class 2606 OID 27614)
-- Name: ztubt_retailer ztubt_retailer_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_retailer
    ADD CONSTRAINT ztubt_retailer_pk PRIMARY KEY (retid);


--
-- TOC entry 7332 (class 2606 OID 27616)
-- Name: ztubt_invoiceperiod ztubt_rtms_invoiceperiod_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_invoiceperiod
    ADD CONSTRAINT ztubt_rtms_invoiceperiod_pk PRIMARY KEY (invoiceperiodid);


--
-- TOC entry 7378 (class 2606 OID 27618)
-- Name: ztubt_salescomconfig ztubt_salescomconfig_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_salescomconfig
    ADD CONSTRAINT ztubt_salescomconfig_pk PRIMARY KEY (salescomconfigid);


--
-- TOC entry 7383 (class 2606 OID 27620)
-- Name: ztubt_spatransaction ztubt_spatransaction_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_spatransaction
    ADD CONSTRAINT ztubt_spatransaction_pk PRIMARY KEY (spatransactionid);


--
-- TOC entry 7385 (class 2606 OID 27622)
-- Name: ztubt_sportcategory ztubt_sportcategory_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sportcategory
    ADD CONSTRAINT ztubt_sportcategory_pk PRIMARY KEY (categoryid);


--
-- TOC entry 7387 (class 2606 OID 27624)
-- Name: ztubt_sportclass ztubt_sportclass_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sportclass
    ADD CONSTRAINT ztubt_sportclass_pk PRIMARY KEY (classid);


--
-- TOC entry 7389 (class 2606 OID 27626)
-- Name: ztubt_sportevent ztubt_sportevent_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sportevent
    ADD CONSTRAINT ztubt_sportevent_pk PRIMARY KEY (eventid);


--
-- TOC entry 7391 (class 2606 OID 27628)
-- Name: ztubt_sportleagueinfo ztubt_sportleagueinfo_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sportleagueinfo
    ADD CONSTRAINT ztubt_sportleagueinfo_pk PRIMARY KEY (leagueinfoid);


--
-- TOC entry 7393 (class 2606 OID 27630)
-- Name: ztubt_sports_placedbettransactionlineitem ztubt_sports_placedbettransactionlineitem_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sports_placedbettransactionlineitem
    ADD CONSTRAINT ztubt_sports_placedbettransactionlineitem_pk PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7561 (class 2606 OID 2036712)
-- Name: ztubt_sports_placedbettransactionlineitemnumber_bk_before_tfog ztubt_sports_placedbettransactionlineitemnumber_bk_before__pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_sports_placedbettransactionlineitemnumber_bk_before_tfog
    ADD CONSTRAINT ztubt_sports_placedbettransactionlineitemnumber_bk_before__pkey PRIMARY KEY (sportslineitemid);


--
-- TOC entry 7395 (class 2606 OID 27632)
-- Name: ztubt_sports_placedbettransactionlineitemnumber ztubt_sports_placedbettransactionlineitemnumber_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sports_placedbettransactionlineitemnumber
    ADD CONSTRAINT ztubt_sports_placedbettransactionlineitemnumber_pk PRIMARY KEY (sportslineitemid);


--
-- TOC entry 7397 (class 2606 OID 27634)
-- Name: ztubt_sporttype ztubt_sporttype_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sporttype
    ADD CONSTRAINT ztubt_sporttype_pk PRIMARY KEY (typeid);


--
-- TOC entry 7399 (class 2606 OID 27636)
-- Name: ztubt_superchain ztubt_superchain_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_superchain
    ADD CONSTRAINT ztubt_superchain_pk PRIMARY KEY (scid);


--
-- TOC entry 7564 (class 2606 OID 2036719)
-- Name: ztubt_sweep_placedbettransactionlineitem_bk_before_tfog ztubt_sweep_placedbettransactionlineitem_bk_before_tfog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_sweep_placedbettransactionlineitem_bk_before_tfog
    ADD CONSTRAINT ztubt_sweep_placedbettransactionlineitem_bk_before_tfog_pkey PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7403 (class 2606 OID 27638)
-- Name: ztubt_sweep_placedbettransactionlineitem ztubt_sweep_placedbettransactionlineitem_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sweep_placedbettransactionlineitem
    ADD CONSTRAINT ztubt_sweep_placedbettransactionlineitem_pk PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7406 (class 2606 OID 27640)
-- Name: ztubt_sweep_placedbettransactionlineitemnumber ztubt_sweep_placedbettransactionlineitemnumber_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_sweep_placedbettransactionlineitemnumber
    ADD CONSTRAINT ztubt_sweep_placedbettransactionlineitemnumber_pk PRIMARY KEY (lineitemnumberid);


--
-- TOC entry 7408 (class 2606 OID 27642)
-- Name: ztubt_table_interval_load_config ztubt_table_interval_load_config_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_table_interval_load_config
    ADD CONSTRAINT ztubt_table_interval_load_config_pk PRIMARY KEY (table_name, raw_run_no);


--
-- TOC entry 7531 (class 2606 OID 1843295)
-- Name: ztubt_payoutdata ztubt_tb_ubt_payoutdata_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_payoutdata
    ADD CONSTRAINT ztubt_tb_ubt_payoutdata_pkey PRIMARY KEY (payoutid);


--
-- TOC entry 7411 (class 2606 OID 27644)
-- Name: ztubt_terminal ztubt_terminal_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_terminal
    ADD CONSTRAINT ztubt_terminal_pk PRIMARY KEY (terid);


--
-- TOC entry 7413 (class 2606 OID 27646)
-- Name: ztubt_topupcardtransaction ztubt_topupcardtransaction_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_topupcardtransaction
    ADD CONSTRAINT ztubt_topupcardtransaction_pk PRIMARY KEY (topuptransactionid);


--
-- TOC entry 7569 (class 2606 OID 2036731)
-- Name: ztubt_toto_placedbettransactionlineitem_bk_before_tfog ztubt_toto_placedbettransactionlineitem_bk_before_tfog_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_toto_placedbettransactionlineitem_bk_before_tfog
    ADD CONSTRAINT ztubt_toto_placedbettransactionlineitem_bk_before_tfog_pkey PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7419 (class 2606 OID 27648)
-- Name: ztubt_toto_placedbettransactionlineitem ztubt_toto_placedbettransactionlineitem_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_toto_placedbettransactionlineitem
    ADD CONSTRAINT ztubt_toto_placedbettransactionlineitem_pk PRIMARY KEY (tranlineitemid);


--
-- TOC entry 7572 (class 2606 OID 2036745)
-- Name: ztubt_toto_placedbettransactionlineitemnumber_bk_before_tfog ztubt_toto_placedbettransactionlineitemnumber_bk_before_tf_pkey; Type: CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.ztubt_toto_placedbettransactionlineitemnumber_bk_before_tfog
    ADD CONSTRAINT ztubt_toto_placedbettransactionlineitemnumber_bk_before_tf_pkey PRIMARY KEY (lineitemnumberid);


--
-- TOC entry 7588 (class 2606 OID 2314328)
-- Name: ztubt_toto_placedbettransactionlineitemnumber_new ztubt_toto_placedbettransactionlineitemnumber_new_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY public.ztubt_toto_placedbettransactionlineitemnumber_new
    ADD CONSTRAINT ztubt_toto_placedbettransactionlineitemnumber_new_pkey PRIMARY KEY (lineitemnumberid);


--
-- TOC entry 7422 (class 2606 OID 27650)
-- Name: ztubt_toto_placedbettransactionlineitemnumber ztubt_toto_placedbettransactionlineitemnumber_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_toto_placedbettransactionlineitemnumber
    ADD CONSTRAINT ztubt_toto_placedbettransactionlineitemnumber_pk PRIMARY KEY (lineitemnumberid);


--
-- TOC entry 7424 (class 2606 OID 27656)
-- Name: ztubt_totohongbaotransaction ztubt_totohongbaotransaction_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_totohongbaotransaction
    ADD CONSTRAINT ztubt_totohongbaotransaction_pk PRIMARY KEY (totohongbaotransactionid);


--
-- TOC entry 7426 (class 2606 OID 27658)
-- Name: ztubt_user ztubt_user_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_user
    ADD CONSTRAINT ztubt_user_pk PRIMARY KEY (userid);


--
-- TOC entry 7430 (class 2606 OID 27660)
-- Name: ztubt_validatedbetticket ztubt_validatedbetticket_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_validatedbetticket
    ADD CONSTRAINT ztubt_validatedbetticket_pk PRIMARY KEY (tranheaderid);


--
-- TOC entry 7434 (class 2606 OID 27662)
-- Name: ztubt_validatedbetticketlifecyclestate ztubt_validatedbetticketlifecyclestate_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_validatedbetticketlifecyclestate
    ADD CONSTRAINT ztubt_validatedbetticketlifecyclestate_pk PRIMARY KEY (validatedbetlifecycleid);


--
-- TOC entry 7436 (class 2606 OID 27666)
-- Name: ztubt_validationtype ztubt_validationtype_pk; Type: CONSTRAINT; Schema: public; Owner: consultant01
--

ALTER TABLE ONLY public.ztubt_validationtype
    ADD CONSTRAINT ztubt_validationtype_pk PRIMARY KEY (validationtypeid);


--
-- TOC entry 7438 (class 2606 OID 27668)
-- Name: dim_account PK_ACCOUNT_ID_1; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.dim_account
    ADD CONSTRAINT "PK_ACCOUNT_ID_1" PRIMARY KEY (acct_id);


--
-- TOC entry 7440 (class 2606 OID 27670)
-- Name: dim_account_tmp PK_ACCOUNT_ID_tmp; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.dim_account_tmp
    ADD CONSTRAINT "PK_ACCOUNT_ID_tmp" PRIMARY KEY (acct_id);


--
-- TOC entry 7549 (class 2606 OID 1989587)
-- Name: chart_config_testdat chart_config_testdat_pkey; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.chart_config_testdat
    ADD CONSTRAINT chart_config_testdat_pkey PRIMARY KEY (chart_id);


--
-- TOC entry 7450 (class 2606 OID 27672)
-- Name: fact_customer fact_customer_pkey; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.fact_customer
    ADD CONSTRAINT fact_customer_pkey PRIMARY KEY (period_id, acct_id, attrib1_id, attrib2_id);


--
-- TOC entry 7442 (class 2606 OID 27674)
-- Name: dim_customer pk_cust_id; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.dim_customer
    ADD CONSTRAINT pk_cust_id PRIMARY KEY (cust_id);


--
-- TOC entry 7444 (class 2606 OID 27676)
-- Name: dim_entity pk_entity_id; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.dim_entity
    ADD CONSTRAINT pk_entity_id PRIMARY KEY (entity_id);


--
-- TOC entry 7452 (class 2606 OID 27678)
-- Name: fact_gl_balance pk_fact_gl_balance; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.fact_gl_balance
    ADD CONSTRAINT pk_fact_gl_balance PRIMARY KEY (period_id, entity_id, product_id, cust_id, acct_id, value_type, attrib1_id);


--
-- TOC entry 7446 (class 2606 OID 27692)
-- Name: dim_period pk_period_id; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.dim_period
    ADD CONSTRAINT pk_period_id PRIMARY KEY (period_id);


--
-- TOC entry 7448 (class 2606 OID 27694)
-- Name: dim_product pk_product_id; Type: CONSTRAINT; Schema: qlik; Owner: sp_postgres
--

ALTER TABLE ONLY qlik.dim_product
    ADD CONSTRAINT pk_product_id PRIMARY KEY (product_id);


--
-- TOC entry 7287 (class 1259 OID 27695)
-- Name: idx_4dlineitemnumber_createddt; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_4dlineitemnumber_createddt ON public.ztubt_4d_placedbettransactionlineitemnumber USING btree (createddate);


--
-- TOC entry 7532 (class 1259 OID 1839571)
-- Name: idx_created_createddate; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_created_createddate ON public.ztubt_cashbox USING btree (createddatetime);


--
-- TOC entry 7529 (class 1259 OID 1839541)
-- Name: idx_created_createddate_payout; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_created_createddate_payout ON public.ztubt_payoutdata USING btree (cartcreateddate);


--
-- TOC entry 7467 (class 1259 OID 956800)
-- Name: idx_created_transaction_date; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_created_transaction_date ON public.ztubt_paynowtransaction USING btree (updateddatetime, transactiondate, transactionstatus);


--
-- TOC entry 7457 (class 1259 OID 405169)
-- Name: idx_nyx_auto_job_entry_log_1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_nyx_auto_job_entry_log_1 ON public.nyx_auto_job_entry_log USING btree (id_batch);


--
-- TOC entry 7458 (class 1259 OID 405176)
-- Name: idx_nyx_auto_job_log_1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_nyx_auto_job_log_1 ON public.nyx_auto_job_log USING btree (id_job);


--
-- TOC entry 7459 (class 1259 OID 405177)
-- Name: idx_nyx_auto_job_log_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_nyx_auto_job_log_2 ON public.nyx_auto_job_log USING btree (errors, status, jobname);


--
-- TOC entry 7455 (class 1259 OID 404142)
-- Name: idx_nyx_auto_trans_log_1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_nyx_auto_trans_log_1 ON public.nyx_auto_trans_log USING btree (id_batch);


--
-- TOC entry 7456 (class 1259 OID 404143)
-- Name: idx_nyx_auto_trans_log_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_nyx_auto_trans_log_2 ON public.nyx_auto_trans_log USING btree (errors, status, transname);


--
-- TOC entry 7351 (class 1259 OID 1840148)
-- Name: idx_paymentheader_createddate; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_paymentheader_createddate ON public.ztubt_paymentdetail USING btree (createddate);


--
-- TOC entry 7288 (class 1259 OID 27696)
-- Name: idx_pbthlcs_tranheaderid; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_pbthlcs_tranheaderid ON public.ztubt_4d_placedbettransactionlineitemnumber USING btree (tranheaderid);


--
-- TOC entry 7470 (class 1259 OID 991739)
-- Name: idx_recon_created_transaction_date; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_recon_created_transaction_date ON public.ztubt_reconciliationresult USING btree (updateddatetime, transactiondate);


--
-- TOC entry 7400 (class 1259 OID 27697)
-- Name: idx_sweepli_tliid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_sweepli_tliid ON public.ztubt_sweep_placedbettransactionlineitem USING btree (tranlineitemid);


--
-- TOC entry 7401 (class 1259 OID 27698)
-- Name: idx_sweepli_tranid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_sweepli_tranid ON public.ztubt_sweep_placedbettransactionlineitem USING btree (tranheaderid);


--
-- TOC entry 7404 (class 1259 OID 27699)
-- Name: idx_sweeplin_tliid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_sweeplin_tliid ON public.ztubt_sweep_placedbettransactionlineitemnumber USING btree (tranlineitemid);


--
-- TOC entry 7414 (class 1259 OID 27700)
-- Name: idx_toto_pbli_grpseq; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_toto_pbli_grpseq ON public.ztubt_toto_placedbettransactionlineitem USING btree (groupunitsequence);


--
-- TOC entry 7289 (class 1259 OID 27701)
-- Name: idx_ubt_4dpbtlin_transheaderid; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ubt_4dpbtlin_transheaderid ON public.ztubt_4d_placedbettransactionlineitemnumber USING btree (tranheaderid);


--
-- TOC entry 7315 (class 1259 OID 27709)
-- Name: idx_ubt_dd_transheaderid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_dd_transheaderid ON public.ztubt_drawdates USING btree (tranheaderid);


--
-- TOC entry 7327 (class 1259 OID 27710)
-- Name: idx_ubt_hrpbtli_transheaderid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_hrpbtli_transheaderid ON public.ztubt_horse_placedbettransactionlineitem USING btree (tranheaderid);


--
-- TOC entry 7357 (class 1259 OID 27713)
-- Name: idx_ubt_pbth_cdt; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_pbth_cdt ON public.ztubt_placedbettransactionheader USING btree (createddate DESC NULLS LAST);


--
-- TOC entry 7358 (class 1259 OID 27715)
-- Name: idx_ubt_pbth_prodid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_pbth_prodid ON public.ztubt_placedbettransactionheader USING btree (prodid);


--
-- TOC entry 7359 (class 1259 OID 27728)
-- Name: idx_ubt_pbth_tid_pid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_pbth_tid_pid ON public.ztubt_placedbettransactionheader USING btree (tranheaderid, prodid);


--
-- TOC entry 7360 (class 1259 OID 27729)
-- Name: idx_ubt_pbth_tranheaderid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_pbth_tranheaderid ON public.ztubt_placedbettransactionheader USING btree (tranheaderid);


--
-- TOC entry 7427 (class 1259 OID 27742)
-- Name: idx_ubt_pbth_valdate; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_pbth_valdate ON public.ztubt_validatedbetticket USING btree (createdvalidationdate);


--
-- TOC entry 7364 (class 1259 OID 27743)
-- Name: idx_ubt_pbthlcs_thid_bsid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_pbthlcs_thid_bsid ON public.ztubt_placedbettransactionheaderlifecyclestate USING btree (tranheaderid, betstatetypeid);


--
-- TOC entry 7365 (class 1259 OID 27750)
-- Name: idx_ubt_pbthlcs_tranid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_pbthlcs_tranid ON public.ztubt_placedbettransactionheaderlifecyclestate USING btree (tranheaderid);


--
-- TOC entry 7415 (class 1259 OID 27763)
-- Name: idx_ubt_totli_ghid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_totli_ghid ON public.ztubt_toto_placedbettransactionlineitem USING btree (grouphostid);


--
-- TOC entry 7416 (class 1259 OID 27764)
-- Name: idx_ubt_totli_tlid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_totli_tlid ON public.ztubt_toto_placedbettransactionlineitem USING btree (tranlineitemid);


--
-- TOC entry 7420 (class 1259 OID 27772)
-- Name: idx_ubt_totlin_tlid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_totlin_tlid ON public.ztubt_toto_placedbettransactionlineitemnumber USING btree (tranlineitemid);


--
-- TOC entry 7586 (class 1259 OID 2314329)
-- Name: idx_ubt_totlin_tlid_new; Type: INDEX; Schema: public; Owner: postgres
--

CREATE INDEX idx_ubt_totlin_tlid_new ON public.ztubt_toto_placedbettransactionlineitemnumber_new USING btree (tranlineitemid);


--
-- TOC entry 7417 (class 1259 OID 27782)
-- Name: idx_ubt_totopbtln_headerid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_totopbtln_headerid ON public.ztubt_toto_placedbettransactionlineitem USING btree (tranheaderid);


--
-- TOC entry 7432 (class 1259 OID 27793)
-- Name: idx_ubt_vblc_headerid_betstate; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_vblc_headerid_betstate ON public.ztubt_validatedbetticketlifecyclestate USING btree (tranheaderid, betstatetypeid);


--
-- TOC entry 7428 (class 1259 OID 27794)
-- Name: idx_ubt_vbt_tranheaderid; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX idx_ubt_vbt_tranheaderid ON public.ztubt_validatedbetticket USING btree (tranheaderid);


--
-- TOC entry 6884 (class 1259 OID 27795)
-- Name: idx_ztes_este_bigwinner_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_este_bigwinner_2 ON public.ztes_este_bigwinner USING btree (change_log_date);


--
-- TOC entry 6885 (class 1259 OID 27796)
-- Name: idx_ztes_este_bigwinner_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_este_bigwinner_3 ON public.ztes_este_bigwinner USING btree (traprod, windtl_drawcdc);


--
-- TOC entry 6888 (class 1259 OID 27797)
-- Name: idx_ztes_este_cashpurge_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_este_cashpurge_2 ON public.ztes_este_cashpurge USING btree (change_log_date);


--
-- TOC entry 6889 (class 1259 OID 27798)
-- Name: idx_ztes_este_cashpurge_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_este_cashpurge_3 ON public.ztes_este_cashpurge USING btree (traprod, windtl_drawcdc);


--
-- TOC entry 6892 (class 1259 OID 27799)
-- Name: idx_ztes_este_uncashexpire_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_este_uncashexpire_2 ON public.ztes_este_uncashexpire USING btree (change_log_date);


--
-- TOC entry 6893 (class 1259 OID 27800)
-- Name: idx_ztes_este_uncashexpire_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_este_uncashexpire_3 ON public.ztes_este_uncashexpire USING btree (traprod, windtl_drawcdc);


--
-- TOC entry 6896 (class 1259 OID 27801)
-- Name: idx_ztes_este_uncashpurge_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_este_uncashpurge_2 ON public.ztes_este_uncashpurge USING btree (change_log_date);


--
-- TOC entry 6897 (class 1259 OID 27802)
-- Name: idx_ztes_este_uncashpurge_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_este_uncashpurge_3 ON public.ztes_este_uncashpurge USING btree (traprod, windtl_drawcdc);


--
-- TOC entry 6942 (class 1259 OID 27803)
-- Name: idx_ztes_pdf_liabcon_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_liabcon_2 ON public.ztes_pdf_liabcon USING btree (productnum, drawcdc);


--
-- TOC entry 6943 (class 1259 OID 27804)
-- Name: idx_ztes_pdf_liabcon_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_liabcon_3 ON public.ztes_pdf_liabcon USING btree (change_log_date);


--
-- TOC entry 6949 (class 1259 OID 27805)
-- Name: idx_ztes_pdf_synddef_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_synddef_2 ON public.ztes_pdf_synddef USING btree (change_log_date);


--
-- TOC entry 6952 (class 1259 OID 27806)
-- Name: idx_ztes_pdf_synddrwdtl_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_synddrwdtl_2 ON public.ztes_pdf_synddrwdtl USING btree (change_log_date);


--
-- TOC entry 6955 (class 1259 OID 27807)
-- Name: idx_ztes_pdf_syndrecs_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_syndrecs_2 ON public.ztes_pdf_syndrecs USING btree (change_log_date);


--
-- TOC entry 6958 (class 1259 OID 27808)
-- Name: idx_ztes_pdf_winnbr_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_winnbr_2 ON public.ztes_pdf_winnbr USING btree (productnum, drawnumber);


--
-- TOC entry 6959 (class 1259 OID 27809)
-- Name: idx_ztes_pdf_winnbr_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_winnbr_3 ON public.ztes_pdf_winnbr USING btree (change_log_date);


--
-- TOC entry 6962 (class 1259 OID 27810)
-- Name: idx_ztes_pdf_winshares_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_winshares_2 ON public.ztes_pdf_winshares USING btree (productnum, drawnumber);


--
-- TOC entry 6963 (class 1259 OID 27811)
-- Name: idx_ztes_pdf_winshares_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_pdf_winshares_3 ON public.ztes_pdf_winshares USING btree (change_log_date);


--
-- TOC entry 6966 (class 1259 OID 27812)
-- Name: idx_ztes_totallog_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_totallog_2 ON public.ztes_totallog USING btree (busdate, agent);


--
-- TOC entry 6967 (class 1259 OID 27813)
-- Name: idx_ztes_totallog_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztes_totallog_3 ON public.ztes_totallog USING btree (change_log_date);


--
-- TOC entry 7539 (class 1259 OID 1840219)
-- Name: idx_ztrtms_inout_paymentdetail; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztrtms_inout_paymentdetail ON public.ztrtms_inout_paymentdetail USING btree (out_payoutid, in_paymentdetailid, in_paymentid);


--
-- TOC entry 7218 (class 1259 OID 27819)
-- Name: idx_ztsapfi_cca_lookup; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_cca_lookup ON public.ztsapfi_cca USING btree (company_code, fiscal_year_period);


--
-- TOC entry 7221 (class 1259 OID 27820)
-- Name: idx_ztsapfi_cca_lookup_new; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_cca_lookup_new ON public.ztsapfi_cca_new USING btree (company_code, fiscal_year_period);


--
-- TOC entry 7228 (class 1259 OID 27821)
-- Name: idx_ztsapfi_copa_lookup; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_copa_lookup ON public.ztsapfi_copa USING btree (company_code, fiscal_year_period);


--
-- TOC entry 7237 (class 1259 OID 27822)
-- Name: idx_ztsapfi_gamsd_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_gamsd_2 ON public.ztsapfi_gamsd USING btree (gamecode, drawno);


--
-- TOC entry 7486 (class 1259 OID 1337161)
-- Name: idx_ztsapfi_gamsd_lsr_hds_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_gamsd_lsr_hds_2 ON public.ztsapfi_gamsd_lsr_hds2 USING btree (gamecode, drawno);


--
-- TOC entry 7243 (class 1259 OID 27823)
-- Name: idx_ztsapfi_gdyup_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_gdyup_2 ON public.ztsapfi_gdyup USING btree (transdate, retailtype, drawnum);


--
-- TOC entry 7244 (class 1259 OID 27824)
-- Name: idx_ztsapfi_gdyup_3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_gdyup_3 ON public.ztsapfi_gdyup USING btree (drawnum, transdate);


--
-- TOC entry 7247 (class 1259 OID 27825)
-- Name: idx_ztsapfi_gibgf_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_gibgf_2 ON public.ztsapfi_gibgf USING btree (drawnum);


--
-- TOC entry 7250 (class 1259 OID 27826)
-- Name: idx_ztsapfi_gl_lookup; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_gl_lookup ON public.ztsapfi_gl USING btree (company_code, fiscal_year_period);


--
-- TOC entry 7259 (class 1259 OID 27827)
-- Name: idx_ztsapfi_gunwn_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_gunwn_2 ON public.ztsapfi_gunwn USING btree (gamecode, drawnumber);


--
-- TOC entry 7264 (class 1259 OID 27828)
-- Name: idx_ztsapfi_gwapp_2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztsapfi_gwapp_2 ON public.ztsapfi_gwapp USING btree (gamecode, drawnumber);


--
-- TOC entry 7535 (class 1259 OID 1840194)
-- Name: idx_ztubt_paymentheader; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztubt_paymentheader ON public.ztubt_paymentheader USING btree (createddate);


--
-- TOC entry 7536 (class 1259 OID 1857997)
-- Name: idx_ztubt_paymentheader_paymentid; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX idx_ztubt_paymentheader_paymentid ON public.ztubt_paymentheader USING btree (paymentid);


--
-- TOC entry 7431 (class 1259 OID 27870)
-- Name: x_test_val_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX x_test_val_idx ON public.ztubt_validatedbetticket_prd USING btree (createdvalidationdate);


--
-- TOC entry 6867 (class 1259 OID 27871)
-- Name: ztall_businessday_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztall_businessday_idx1 ON public.ztall_businessday USING btree (system, business_id);


--
-- TOC entry 6868 (class 1259 OID 27872)
-- Name: ztall_businessday_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztall_businessday_idx2 ON public.ztall_businessday USING btree (system, start_timestamp);


--
-- TOC entry 6875 (class 1259 OID 27873)
-- Name: ztes_esrm_device_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_esrm_device_idx1 ON public.ztes_esrm_device USING btree (change_log_date);


--
-- TOC entry 6878 (class 1259 OID 27874)
-- Name: ztes_esrm_outlet_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_esrm_outlet_idx1 ON public.ztes_esrm_outlet USING btree (change_log_date);


--
-- TOC entry 6881 (class 1259 OID 27875)
-- Name: ztes_esrm_teller_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_esrm_teller_idx1 ON public.ztes_esrm_teller USING btree (change_log_date);


--
-- TOC entry 6900 (class 1259 OID 27876)
-- Name: ztes_inv_adj_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_adj_idx1 ON public.ztes_inv_adj USING btree (change_log_date);


--
-- TOC entry 6903 (class 1259 OID 27877)
-- Name: ztes_inv_agt_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_agt_idx1 ON public.ztes_inv_agt USING btree (agentinvoice_invid, agentinvoice_productid, sales_type, agentinvoice_agtidn);


--
-- TOC entry 6904 (class 1259 OID 27878)
-- Name: ztes_inv_agt_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_agt_idx2 ON public.ztes_inv_agt USING btree (change_log_date);


--
-- TOC entry 6907 (class 1259 OID 27879)
-- Name: ztes_inv_dev_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_dev_idx1 ON public.ztes_inv_dev USING btree (deviceinvoice_salescdc, deviceinvoice_productid, sales_type, deviceinvoice_agtidn);


--
-- TOC entry 7542 (class 1259 OID 1846393)
-- Name: ztes_inv_dev_idx1_1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_dev_idx1_1 ON public.ztes_inv_dev_tfog2024 USING btree (deviceinvoice_salescdc, deviceinvoice_productid, sales_type, deviceinvoice_agtidn);


--
-- TOC entry 6908 (class 1259 OID 27880)
-- Name: ztes_inv_dev_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_dev_idx2 ON public.ztes_inv_dev USING btree (change_log_date);


--
-- TOC entry 7543 (class 1259 OID 1846394)
-- Name: ztes_inv_dev_idx2_1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_dev_idx2_1 ON public.ztes_inv_dev_tfog2024 USING btree (change_log_date);


--
-- TOC entry 6915 (class 1259 OID 27881)
-- Name: ztes_inv_invdef2_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_invdef2_idx1 ON public.ztes_inv_invdef2 USING btree (change_log_date);


--
-- TOC entry 6916 (class 1259 OID 27882)
-- Name: ztes_inv_invdef2_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_invdef2_idx2 ON public.ztes_inv_invdef2 USING btree (enddate);


--
-- TOC entry 6911 (class 1259 OID 27883)
-- Name: ztes_inv_invdef_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_invdef_idx1 ON public.ztes_inv_invdef USING btree (change_log_date);


--
-- TOC entry 6912 (class 1259 OID 27884)
-- Name: ztes_inv_invdef_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_inv_invdef_idx2 ON public.ztes_inv_invdef USING btree (enddate);


--
-- TOC entry 6919 (class 1259 OID 27885)
-- Name: ztes_mjf_brdinf_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_brdinf_idx1 ON public.ztes_mjf_brdinf USING btree (cdc, bettyp, betcls);


--
-- TOC entry 6924 (class 1259 OID 27886)
-- Name: ztes_mjf_draws_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_draws_idx1 ON public.ztes_mjf_draws USING btree (draws_draw);


--
-- TOC entry 7522 (class 1259 OID 1666986)
-- Name: ztes_mjf_draws_idx1_1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_draws_idx1_1 ON public.ztes_mjf_draws_dat184 USING btree (draws_draw);


--
-- TOC entry 6927 (class 1259 OID 27887)
-- Name: ztes_mjf_journals_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_journals_idx1 ON public.ztes_mjf_journals USING btree (cdc, prod, tratyp);


--
-- TOC entry 7481 (class 1259 OID 1320744)
-- Name: ztes_mjf_journals_lsr_hds_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_journals_lsr_hds_idx1 ON public.ztes_mjf_journals_lsr_hds2 USING btree (cdc, prod, tratyp);


--
-- TOC entry 6930 (class 1259 OID 27888)
-- Name: ztes_mjf_windtl_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_windtl_idx1 ON public.ztes_mjf_windtl USING btree (draw);


--
-- TOC entry 6931 (class 1259 OID 27889)
-- Name: ztes_mjf_windtl_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_windtl_idx2 ON public.ztes_mjf_windtl USING btree (expcdc);


--
-- TOC entry 7482 (class 1259 OID 1320776)
-- Name: ztes_mjf_windtl_lsr_hds_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_windtl_lsr_hds_idx1 ON public.ztes_mjf_windtl_lsr_hds2 USING btree (draw);


--
-- TOC entry 7483 (class 1259 OID 1320777)
-- Name: ztes_mjf_windtl_lsr_hds_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_mjf_windtl_lsr_hds_idx2 ON public.ztes_mjf_windtl_lsr_hds2 USING btree (expcdc);


--
-- TOC entry 6938 (class 1259 OID 27890)
-- Name: ztes_pdf_drawparam_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_pdf_drawparam_idx1 ON public.ztes_pdf_drawparam USING btree (productnum, drawcdc);


--
-- TOC entry 6939 (class 1259 OID 27891)
-- Name: ztes_pdf_drawparam_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_pdf_drawparam_idx2 ON public.ztes_pdf_drawparam USING btree (change_log_date);


--
-- TOC entry 6946 (class 1259 OID 27892)
-- Name: ztes_pdf_syndbrddtl_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztes_pdf_syndbrddtl_idx1 ON public.ztes_pdf_syndbrddtl USING btree (change_log_date);


--
-- TOC entry 6970 (class 1259 OID 27893)
-- Name: ztetl_log_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztetl_log_idx1 ON public.ztetl_log USING btree (log_date);


--
-- TOC entry 6991 (class 1259 OID 27894)
-- Name: ztmm2_cancel_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_cancel_idx1 ON public.ztmm2_cancel USING btree (canceltimestamp);


--
-- TOC entry 6992 (class 1259 OID 27895)
-- Name: ztmm2_cancel_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_cancel_idx2 ON public.ztmm2_cancel USING btree (busdate);


--
-- TOC entry 6997 (class 1259 OID 27896)
-- Name: ztmm2_liability_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_liability_idx1 ON public.ztmm2_liability USING btree (invoiceitemno);


--
-- TOC entry 6998 (class 1259 OID 27897)
-- Name: ztmm2_liability_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_liability_idx2 ON public.ztmm2_liability USING btree (busdate);


--
-- TOC entry 6999 (class 1259 OID 27898)
-- Name: ztmm2_liability_idx3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_liability_idx3 ON public.ztmm2_liability USING btree (matchdate);


--
-- TOC entry 7006 (class 1259 OID 27899)
-- Name: ztmm2_purge_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_purge_idx1 ON public.ztmm2_purge_dev USING btree (purgetimestamp);


--
-- TOC entry 7007 (class 1259 OID 27900)
-- Name: ztmm2_purge_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_purge_idx2 ON public.ztmm2_purge_dev USING btree (busdate);


--
-- TOC entry 7002 (class 1259 OID 27901)
-- Name: ztmm2_purge_old_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_purge_old_idx1 ON public.ztmm2_purge USING btree (purgetimestamp);


--
-- TOC entry 7003 (class 1259 OID 27902)
-- Name: ztmm2_purge_old_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_purge_old_idx2 ON public.ztmm2_purge USING btree (busdate);


--
-- TOC entry 7016 (class 1259 OID 27903)
-- Name: ztmm2_timetable_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_timetable_idx1 ON public.ztmm2_timetable USING btree (matchdate, matchtime);


--
-- TOC entry 7019 (class 1259 OID 27904)
-- Name: ztmm2_valid_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_valid_idx1 ON public.ztmm2_valid USING btree (validtimestamp);


--
-- TOC entry 7020 (class 1259 OID 27905)
-- Name: ztmm2_valid_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_valid_idx2 ON public.ztmm2_valid USING btree (busdate);


--
-- TOC entry 7023 (class 1259 OID 27906)
-- Name: ztmm2_wager_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_wager_idx1 ON public.ztmm2_wager USING btree (bettimestamp);


--
-- TOC entry 7024 (class 1259 OID 27907)
-- Name: ztmm2_wager_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztmm2_wager_idx2 ON public.ztmm2_wager USING btree (busdate);


--
-- TOC entry 7464 (class 1259 OID 490465)
-- Name: ztob_customer_anonymised_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_customer_anonymised_idx1 ON public.ztob_customer_anonymised USING btree (business_date);


--
-- TOC entry 7069 (class 1259 OID 27908)
-- Name: ztob_journal_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_journal_idx1 ON public.ztob_journal USING btree (last_updated_date);


--
-- TOC entry 7070 (class 1259 OID 27909)
-- Name: ztob_journal_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_journal_idx2 ON public.ztob_journal USING btree (authorisation_date_business_id);


--
-- TOC entry 7075 (class 1259 OID 27910)
-- Name: ztob_lottery_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lottery_idx1 ON public.ztob_lottery USING btree (last_updated_date);


--
-- TOC entry 7076 (class 1259 OID 27911)
-- Name: ztob_lottery_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lottery_idx2 ON public.ztob_lottery USING btree (creation_date_business_id);


--
-- TOC entry 7077 (class 1259 OID 27912)
-- Name: ztob_lottery_idx3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lottery_idx3 ON public.ztob_lottery USING btree (draw_date_business_id);


--
-- TOC entry 7078 (class 1259 OID 27913)
-- Name: ztob_lottery_idx4; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lottery_idx4 ON public.ztob_lottery USING btree (valid_date_business_id);


--
-- TOC entry 7079 (class 1259 OID 27914)
-- Name: ztob_lottery_idx5; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lottery_idx5 ON public.ztob_lottery USING btree (settled_date_business_id);


--
-- TOC entry 7080 (class 1259 OID 27915)
-- Name: ztob_lottery_idx6; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lottery_idx6 ON public.ztob_lottery USING btree (last_updated_date_business_id);


--
-- TOC entry 7085 (class 1259 OID 27916)
-- Name: ztob_lotterycustdailystats_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lotterycustdailystats_idx1 ON public.ztob_lotterycustdailystats USING btree (last_updated_date);


--
-- TOC entry 7088 (class 1259 OID 27917)
-- Name: ztob_lotterycuststats_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lotterycuststats_idx1 ON public.ztob_lotterycuststats USING btree (last_updated_date);


--
-- TOC entry 7091 (class 1259 OID 27918)
-- Name: ztob_lotterysubscriptions_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_lotterysubscriptions_idx1 ON public.ztob_lotterysubscriptions USING btree (last_updated_date);


--
-- TOC entry 7589 (class 1259 OID 2463138)
-- Name: ztob_pmttransaction_phu_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_pmttransaction_phu_idx1 ON public.ztob_pmttransaction_phu USING btree (last_updated_date);


--
-- TOC entry 7590 (class 1259 OID 2463139)
-- Name: ztob_pmttransaction_phu_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_pmttransaction_phu_idx2 ON public.ztob_pmttransaction_phu USING btree (creation_date_business_id);


--
-- TOC entry 7096 (class 1259 OID 27919)
-- Name: ztob_sportbets_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_sportbets_idx1 ON public.ztob_sportbets USING btree (last_updated_date);


--
-- TOC entry 7097 (class 1259 OID 27920)
-- Name: ztob_sportbets_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_sportbets_idx2 ON public.ztob_sportbets USING btree (creation_date_business_id);


--
-- TOC entry 7104 (class 1259 OID 27921)
-- Name: ztob_sportbetssettled_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_sportbetssettled_idx1 ON public.ztob_sportbetssettled USING btree (last_updated_date);


--
-- TOC entry 7105 (class 1259 OID 27922)
-- Name: ztob_sportbetssettled_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_sportbetssettled_idx2 ON public.ztob_sportbetssettled USING btree (creation_date_business_id);


--
-- TOC entry 7106 (class 1259 OID 27923)
-- Name: ztob_sportbetssettled_idx3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_sportbetssettled_idx3 ON public.ztob_sportbetssettled USING btree (last_settled_date_business_id);


--
-- TOC entry 7107 (class 1259 OID 27924)
-- Name: ztob_sportbetssettled_idx4; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztob_sportbetssettled_idx4 ON public.ztob_sportbetssettled USING btree (validation_date_business_id);


--
-- TOC entry 7140 (class 1259 OID 27925)
-- Name: ztrtms2_customer_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_customer_idx1 ON public.ztrtms2_customer USING btree (updatedat);


--
-- TOC entry 7143 (class 1259 OID 27926)
-- Name: ztrtms2_inv_dev_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_inv_dev_idx1 ON public.ztrtms2_inv_dev USING btree (salesdate, product, salestype, retailer);


--
-- TOC entry 7144 (class 1259 OID 27927)
-- Name: ztrtms2_inv_dev_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_inv_dev_idx2 ON public.ztrtms2_inv_dev USING btree (change_log_date);


--
-- TOC entry 7147 (class 1259 OID 27928)
-- Name: ztrtms2_retailer_master_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_retailer_master_idx1 ON public.ztrtms2_retailer_master USING btree (change_log_date);


--
-- TOC entry 7150 (class 1259 OID 27929)
-- Name: ztrtms2_terminal_master_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_terminal_master_idx1 ON public.ztrtms2_terminal_master USING btree (retailer);


--
-- TOC entry 7151 (class 1259 OID 27930)
-- Name: ztrtms2_terminal_master_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_terminal_master_idx2 ON public.ztrtms2_terminal_master USING btree (change_log_date);


--
-- TOC entry 7154 (class 1259 OID 27931)
-- Name: ztrtms2_trans_horse_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_trans_horse_idx1 ON public.ztrtms2_trans_horse USING btree (transheaderid);


--
-- TOC entry 7155 (class 1259 OID 27932)
-- Name: ztrtms2_trans_horse_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_trans_horse_idx2 ON public.ztrtms2_trans_horse USING btree (retailerid, busdate);


--
-- TOC entry 7158 (class 1259 OID 27933)
-- Name: ztrtms2_trans_lottery_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_trans_lottery_idx1 ON public.ztrtms2_trans_lottery USING btree (retailerid, busdate);


--
-- TOC entry 7159 (class 1259 OID 27934)
-- Name: ztrtms2_trans_lottery_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_trans_lottery_idx2 ON public.ztrtms2_trans_lottery USING btree (transheaderid);


--
-- TOC entry 7160 (class 1259 OID 27935)
-- Name: ztrtms2_trans_lottery_idx3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_trans_lottery_idx3 ON public.ztrtms2_trans_lottery USING btree (drawid, busdate);


--
-- TOC entry 7163 (class 1259 OID 27936)
-- Name: ztrtms2_trans_sports_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_trans_sports_idx1 ON public.ztrtms2_trans_sports USING btree (matchstarttimestamp);


--
-- TOC entry 7164 (class 1259 OID 27937)
-- Name: ztrtms2_trans_sports_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_trans_sports_idx2 ON public.ztrtms2_trans_sports USING btree (retailerid, busdate);


--
-- TOC entry 7165 (class 1259 OID 27938)
-- Name: ztrtms2_trans_sports_idx3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_trans_sports_idx3 ON public.ztrtms2_trans_sports USING btree (transheaderid);


--
-- TOC entry 7168 (class 1259 OID 27939)
-- Name: ztrtms2_user_master_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_user_master_idx1 ON public.ztrtms2_user_master USING btree (retailer);


--
-- TOC entry 7169 (class 1259 OID 27940)
-- Name: ztrtms2_user_master_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms2_user_master_idx2 ON public.ztrtms2_user_master USING btree (change_log_date);


--
-- TOC entry 7172 (class 1259 OID 27941)
-- Name: ztrtms_inv_adj_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_inv_adj_idx1 ON public.ztrtms_inv_adj USING btree (change_log_date);


--
-- TOC entry 7175 (class 1259 OID 27942)
-- Name: ztrtms_inv_agt_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_inv_agt_idx1 ON public.ztrtms_inv_agt USING btree (invoiceid, product, salestype, retailer);


--
-- TOC entry 7176 (class 1259 OID 27943)
-- Name: ztrtms_inv_agt_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_inv_agt_idx2 ON public.ztrtms_inv_agt USING btree (change_log_date);


--
-- TOC entry 7179 (class 1259 OID 27944)
-- Name: ztrtms_inv_def_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_inv_def_idx1 ON public.ztrtms_inv_def USING btree (enddate);


--
-- TOC entry 7180 (class 1259 OID 27945)
-- Name: ztrtms_inv_def_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_inv_def_idx2 ON public.ztrtms_inv_def USING btree (change_log_date);


--
-- TOC entry 7183 (class 1259 OID 27946)
-- Name: ztrtms_inv_dev_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_inv_dev_idx1 ON public.ztrtms_inv_dev USING btree (salesdate, product, salestype, retailer);


--
-- TOC entry 7184 (class 1259 OID 27947)
-- Name: ztrtms_inv_dev_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_inv_dev_idx2 ON public.ztrtms_inv_dev USING btree (change_log_date);


--
-- TOC entry 7579 (class 1259 OID 2046967)
-- Name: ztrtms_retailer_master_bk_before_tfog_change_log_date_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_retailer_master_bk_before_tfog_change_log_date_idx ON public.ztrtms_retailer_master_bk_before_tfog USING btree (change_log_date);


--
-- TOC entry 7189 (class 1259 OID 27948)
-- Name: ztrtms_retailer_master_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_retailer_master_idx1 ON public.ztrtms_retailer_master USING btree (change_log_date);


--
-- TOC entry 7192 (class 1259 OID 27949)
-- Name: ztrtms_terminal_master_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_terminal_master_idx1 ON public.ztrtms_terminal_master USING btree (retailer);


--
-- TOC entry 7193 (class 1259 OID 27950)
-- Name: ztrtms_terminal_master_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_terminal_master_idx2 ON public.ztrtms_terminal_master USING btree (change_log_date);


--
-- TOC entry 7196 (class 1259 OID 27951)
-- Name: ztrtms_trans_entry_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_entry_idx1 ON public.ztrtms_trans_entry USING btree (retailerid, busdate);


--
-- TOC entry 7197 (class 1259 OID 27952)
-- Name: ztrtms_trans_entry_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_entry_idx2 ON public.ztrtms_trans_entry USING btree (transheaderid);


--
-- TOC entry 7200 (class 1259 OID 27953)
-- Name: ztrtms_trans_horse_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_horse_idx1 ON public.ztrtms_trans_horse USING btree (transheaderid);


--
-- TOC entry 7201 (class 1259 OID 27954)
-- Name: ztrtms_trans_horse_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_horse_idx2 ON public.ztrtms_trans_horse USING btree (retailerid, busdate);


--
-- TOC entry 7204 (class 1259 OID 27955)
-- Name: ztrtms_trans_lottery_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_lottery_idx1 ON public.ztrtms_trans_lottery USING btree (retailerid, busdate);


--
-- TOC entry 7205 (class 1259 OID 27956)
-- Name: ztrtms_trans_lottery_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_lottery_idx2 ON public.ztrtms_trans_lottery USING btree (transheaderid);


--
-- TOC entry 7206 (class 1259 OID 27968)
-- Name: ztrtms_trans_lottery_idx3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_lottery_idx3 ON public.ztrtms_trans_lottery USING btree (drawid, busdate);


--
-- TOC entry 7209 (class 1259 OID 27969)
-- Name: ztrtms_trans_sports_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_sports_idx1 ON public.ztrtms_trans_sports USING btree (matchstarttimestamp);


--
-- TOC entry 7210 (class 1259 OID 27970)
-- Name: ztrtms_trans_sports_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_sports_idx2 ON public.ztrtms_trans_sports USING btree (retailerid, busdate);


--
-- TOC entry 7211 (class 1259 OID 27971)
-- Name: ztrtms_trans_sports_idx3; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_trans_sports_idx3 ON public.ztrtms_trans_sports USING btree (transheaderid);


--
-- TOC entry 7214 (class 1259 OID 27972)
-- Name: ztrtms_user_master_idx1; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_user_master_idx1 ON public.ztrtms_user_master USING btree (retailer);


--
-- TOC entry 7215 (class 1259 OID 27973)
-- Name: ztrtms_user_master_idx2; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztrtms_user_master_idx2 ON public.ztrtms_user_master USING btree (change_log_date);


--
-- TOC entry 7240 (class 1259 OID 27974)
-- Name: ztsapfi_gamsd_db_gamecode_drawno_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztsapfi_gamsd_db_gamecode_drawno_idx ON public.ztsapfi_gamsd_db USING btree (gamecode, drawno);


--
-- TOC entry 7487 (class 1259 OID 1337242)
-- Name: ztsapfi_gamsd_db_lsr_hds_gamecode_drawno_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztsapfi_gamsd_db_lsr_hds_gamecode_drawno_idx ON public.ztsapfi_gamsd_db_lsr_hds2 USING btree (gamecode, drawno);


--
-- TOC entry 7290 (class 1259 OID 800968)
-- Name: ztubt_4d_placedbettransactionlineitemnumber_createddate_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_4d_placedbettransactionlineitemnumber_createddate_idx ON public.ztubt_4d_placedbettransactionlineitemnumber USING btree (createddate);


--
-- TOC entry 7293 (class 1259 OID 800969)
-- Name: ztubt_4d_placedbettransactionlineitemnumber_tranheaderid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_4d_placedbettransactionlineitemnumber_tranheaderid_idx ON public.ztubt_4d_placedbettransactionlineitemnumber USING btree (tranheaderid);


--
-- TOC entry 7298 (class 1259 OID 27975)
-- Name: ztubt_adjustinvoice_i2; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_adjustinvoice_i2 ON public.ztubt_adjustinvoice USING btree (updateddatetime DESC NULLS LAST);


--
-- TOC entry 7309 (class 1259 OID 796694)
-- Name: ztubt_chain_chid_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_chain_chid_idx ON public.ztubt_chain USING btree (chid);


--
-- TOC entry 7310 (class 1259 OID 27976)
-- Name: ztubt_chain_i2; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_chain_i2 ON public.ztubt_chain USING btree (chdisplayid);


--
-- TOC entry 7573 (class 1259 OID 2044908)
-- Name: ztubt_drawdates_bk_before_tfog_drawdate_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_drawdates_bk_before_tfog_drawdate_idx ON public.ztubt_drawdates_bk_before_tfog USING btree (drawdate DESC NULLS LAST);


--
-- TOC entry 7576 (class 1259 OID 2044907)
-- Name: ztubt_drawdates_bk_before_tfog_tranheaderid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_drawdates_bk_before_tfog_tranheaderid_idx ON public.ztubt_drawdates_bk_before_tfog USING btree (tranheaderid);


--
-- TOC entry 7556 (class 1259 OID 2036697)
-- Name: ztubt_horse_placedbettransactionlineitem_bk_be_tranheaderid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_horse_placedbettransactionlineitem_bk_be_tranheaderid_idx ON public.ztubt_horse_placedbettransactionlineitem_bk_before_tfog USING btree (tranheaderid);


--
-- TOC entry 7557 (class 1259 OID 2036698)
-- Name: ztubt_horse_placedbettransactionlineitem_bk_bef_createddate_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_horse_placedbettransactionlineitem_bk_bef_createddate_idx ON public.ztubt_horse_placedbettransactionlineitem_bk_before_tfog USING btree (createddate);


--
-- TOC entry 7328 (class 1259 OID 800967)
-- Name: ztubt_horse_placedbettransactionlineitem_createddate_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_horse_placedbettransactionlineitem_createddate_idx ON public.ztubt_horse_placedbettransactionlineitem USING btree (createddate);


--
-- TOC entry 7318 (class 1259 OID 27977)
-- Name: ztubt_idx_ddate; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_idx_ddate ON public.ztubt_drawdates USING btree (drawdate DESC NULLS LAST);


--
-- TOC entry 7550 (class 1259 OID 2036379)
-- Name: ztubt_location_bk20241015_test_chid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_location_bk20241015_test_chid_idx ON public.ztubt_location_bk20241015 USING btree (chid);


--
-- TOC entry 7551 (class 1259 OID 2036380)
-- Name: ztubt_location_bk20241015_test_loctypeid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_location_bk20241015_test_loctypeid_idx ON public.ztubt_location_bk20241015 USING brin (loctypeid);


--
-- TOC entry 7333 (class 1259 OID 27978)
-- Name: ztubt_location_i3; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_location_i3 ON public.ztubt_location USING btree (chid);


--
-- TOC entry 7334 (class 1259 OID 796692)
-- Name: ztubt_location_locid_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_location_locid_idx ON public.ztubt_location USING btree (locid);


--
-- TOC entry 7335 (class 1259 OID 796693)
-- Name: ztubt_location_loctypeid_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_location_loctypeid_idx ON public.ztubt_location USING brin (loctypeid);


--
-- TOC entry 7342 (class 1259 OID 796696)
-- Name: ztubt_lookupvalueconfig_configname_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_lookupvalueconfig_configname_idx ON public.ztubt_lookupvalueconfig USING btree (configname);


--
-- TOC entry 7343 (class 1259 OID 796698)
-- Name: ztubt_lookupvalueconfig_fld1value_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_lookupvalueconfig_fld1value_idx ON public.ztubt_lookupvalueconfig USING btree (fld1value);


--
-- TOC entry 7344 (class 1259 OID 796697)
-- Name: ztubt_lookupvalueconfig_fld2value_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_lookupvalueconfig_fld2value_idx ON public.ztubt_lookupvalueconfig USING btree (fld2value);


--
-- TOC entry 7352 (class 1259 OID 27979)
-- Name: ztubt_paymentdetail_i2; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_paymentdetail_i2 ON public.ztubt_paymentdetail USING btree (createddate);


--
-- TOC entry 7363 (class 1259 OID 800615)
-- Name: ztubt_placedbettransactionheader_prodid_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_placedbettransactionheader_prodid_idx ON public.ztubt_placedbettransactionheader USING btree (prodid);


--
-- TOC entry 7368 (class 1259 OID 800616)
-- Name: ztubt_placedbettransactionheaderlifecyclestate_betstatetypeid_i; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_placedbettransactionheaderlifecyclestate_betstatetypeid_i ON public.ztubt_placedbettransactionheaderlifecyclestate USING btree (betstatetypeid);


--
-- TOC entry 7369 (class 1259 OID 800966)
-- Name: ztubt_placedbettransactionheaderlifecyclestate_tranheaderid_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_placedbettransactionheaderlifecyclestate_tranheaderid_idx ON public.ztubt_placedbettransactionheaderlifecyclestate USING btree (tranheaderid);


--
-- TOC entry 7372 (class 1259 OID 800614)
-- Name: ztubt_product_prodid_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_product_prodid_idx ON public.ztubt_product USING btree (prodid);


--
-- TOC entry 7381 (class 1259 OID 27980)
-- Name: ztubt_session_i2; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_session_i2 ON public.ztubt_session USING btree (sessionstartdatetime);


--
-- TOC entry 7562 (class 1259 OID 2036720)
-- Name: ztubt_sweep_placedbettransactionlineitem_bk_be_tranheaderid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_sweep_placedbettransactionlineitem_bk_be_tranheaderid_idx ON public.ztubt_sweep_placedbettransactionlineitem_bk_before_tfog USING btree (tranheaderid);


--
-- TOC entry 7409 (class 1259 OID 796695)
-- Name: ztubt_terminal_locid_idx; Type: INDEX; Schema: public; Owner: consultant01
--

CREATE INDEX ztubt_terminal_locid_idx ON public.ztubt_terminal USING btree (locid);


--
-- TOC entry 7565 (class 1259 OID 2036732)
-- Name: ztubt_toto_placedbettransactionlineitem_b_groupunitsequence_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_toto_placedbettransactionlineitem_b_groupunitsequence_idx ON public.ztubt_toto_placedbettransactionlineitem_bk_before_tfog USING btree (groupunitsequence);


--
-- TOC entry 7566 (class 1259 OID 2036734)
-- Name: ztubt_toto_placedbettransactionlineitem_bk_bef_tranheaderid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_toto_placedbettransactionlineitem_bk_bef_tranheaderid_idx ON public.ztubt_toto_placedbettransactionlineitem_bk_before_tfog USING btree (tranheaderid);


--
-- TOC entry 7567 (class 1259 OID 2036733)
-- Name: ztubt_toto_placedbettransactionlineitem_bk_befo_grouphostid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_toto_placedbettransactionlineitem_bk_befo_grouphostid_idx ON public.ztubt_toto_placedbettransactionlineitem_bk_before_tfog USING btree (grouphostid);


--
-- TOC entry 7570 (class 1259 OID 2036746)
-- Name: ztubt_toto_placedbettransactionlineitemnumbe_tranlineitemid_idx; Type: INDEX; Schema: public; Owner: sp_postgres
--

CREATE INDEX ztubt_toto_placedbettransactionlineitemnumbe_tranlineitemid_idx ON public.ztubt_toto_placedbettransactionlineitemnumber_bk_before_tfog USING btree (tranlineitemid);


--
-- TOC entry 7593 (class 0 OID 0)
-- Name: ztubt_pbth_partition_test_2022_pkey; Type: INDEX ATTACH; Schema: public; Owner: 
--

ALTER INDEX public.ztubt_pbth_partition_test_pkey ATTACH PARTITION public.ztubt_pbth_partition_test_2022_pkey;


--
-- TOC entry 7605 (class 2606 OID 1570022)
-- Name: audit fk_audit_accessed_report_id_report_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.audit
    ADD CONSTRAINT fk_audit_accessed_report_id_report_id FOREIGN KEY (accessed_report_id) REFERENCES public.report(report_id);


--
-- TOC entry 7604 (class 2606 OID 1570017)
-- Name: audit fk_audit_user_id_user_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.audit
    ADD CONSTRAINT fk_audit_user_id_user_id FOREIGN KEY (user_id) REFERENCES public.emp_user(user_id);


--
-- TOC entry 7598 (class 2606 OID 1569987)
-- Name: holiday fk_holiday_creator_user_id_emp_user_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.holiday
    ADD CONSTRAINT fk_holiday_creator_user_id_emp_user_id FOREIGN KEY (creator_user_id) REFERENCES public.emp_user(user_id);


--
-- TOC entry 7597 (class 2606 OID 1569982)
-- Name: product_category_mapping fk_product_category_mapping_category_id_category_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.product_category_mapping
    ADD CONSTRAINT fk_product_category_mapping_category_id_category_id FOREIGN KEY (category_id) REFERENCES public.category(category_id);


--
-- TOC entry 7596 (class 2606 OID 1569977)
-- Name: product_category_mapping fk_product_category_mapping_product_id_product_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.product_category_mapping
    ADD CONSTRAINT fk_product_category_mapping_product_id_product_id FOREIGN KEY (product_id) REFERENCES public.product(product_id);


--
-- TOC entry 7599 (class 2606 OID 1569992)
-- Name: product_discount_mapping fk_product_discount_mapping_product_id_product_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.product_discount_mapping
    ADD CONSTRAINT fk_product_discount_mapping_product_id_product_id FOREIGN KEY (product_id) REFERENCES public.product(product_id);


--
-- TOC entry 7600 (class 2606 OID 1569997)
-- Name: sale fk_sale_product_id_product_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.sale
    ADD CONSTRAINT fk_sale_product_id_product_id FOREIGN KEY (product_id) REFERENCES public.product(product_id);


--
-- TOC entry 7601 (class 2606 OID 1570002)
-- Name: sale fk_sale_store_number_store_number; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.sale
    ADD CONSTRAINT fk_sale_store_number_store_number FOREIGN KEY (store_number) REFERENCES public.store(store_number);


--
-- TOC entry 7595 (class 2606 OID 1569972)
-- Name: store fk_store_city_id_city_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.store
    ADD CONSTRAINT fk_store_city_id_city_id FOREIGN KEY (city_id) REFERENCES public.city(city_id);


--
-- TOC entry 7594 (class 2606 OID 1569967)
-- Name: store fk_store_distict_number_district_number; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.store
    ADD CONSTRAINT fk_store_distict_number_district_number FOREIGN KEY (district_number) REFERENCES public.district(district_number);


--
-- TOC entry 7603 (class 2606 OID 1570012)
-- Name: user_district_mapping fk_user_disctrict_mapping_district_number_district_number; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.user_district_mapping
    ADD CONSTRAINT fk_user_disctrict_mapping_district_number_district_number FOREIGN KEY (district_number) REFERENCES public.district(district_number);


--
-- TOC entry 7602 (class 2606 OID 1570007)
-- Name: user_district_mapping fk_user_disctrict_mapping_user_id_emp_user_id; Type: FK CONSTRAINT; Schema: public; Owner: sp_postgres
--

ALTER TABLE ONLY public.user_district_mapping
    ADD CONSTRAINT fk_user_disctrict_mapping_user_id_emp_user_id FOREIGN KEY (user_id) REFERENCES public.emp_user(user_id);


--
-- TOC entry 7791 (class 0 OID 0)
-- Dependencies: 191
-- Name: SCHEMA qlik; Type: ACL; Schema: -; Owner: sp_postgres
--

GRANT USAGE ON SCHEMA qlik TO PUBLIC;
GRANT ALL ON SCHEMA qlik TO qlikuser WITH GRANT OPTION;


--
-- TOC entry 7797 (class 0 OID 0)
-- Dependencies: 1143
-- Name: FUNCTION sp_ubt_getoperatinghours(transactiondate date); Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON FUNCTION public.sp_ubt_getoperatinghours(transactiondate date) TO qlikuser;
GRANT ALL ON FUNCTION public.sp_ubt_getoperatinghours(transactiondate date) TO consultant01;


--
-- TOC entry 7798 (class 0 OID 0)
-- Dependencies: 1120
-- Name: FUNCTION sp_ubt_getrtshopcloud_bkup_gst_change(inbusinessdate date); Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON FUNCTION public.sp_ubt_getrtshopcloud_bkup_gst_change(inbusinessdate date) TO qlikuser;
GRANT ALL ON FUNCTION public.sp_ubt_getrtshopcloud_bkup_gst_change(inbusinessdate date) TO consultant01;


--
-- TOC entry 7799 (class 0 OID 0)
-- Dependencies: 1179
-- Name: FUNCTION sp_ubt_gettransactiondataforinterval(startdatetime timestamp without time zone, enddatetime timestamp without time zone); Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON FUNCTION public.sp_ubt_gettransactiondataforinterval(startdatetime timestamp without time zone, enddatetime timestamp without time zone) TO consultant01;


--
-- TOC entry 7800 (class 0 OID 0)
-- Dependencies: 1125
-- Name: FUNCTION sp_ubt_gettransamountdetails_bk20240314(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone); Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON FUNCTION public.sp_ubt_gettransamountdetails_bk20240314(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) TO qlikuser;
GRANT ALL ON FUNCTION public.sp_ubt_gettransamountdetails_bk20240314(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) TO consultant01;


--
-- TOC entry 7801 (class 0 OID 0)
-- Dependencies: 1116
-- Name: FUNCTION sp_ubt_gtad_dr_summarybychain(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone); Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON FUNCTION public.sp_ubt_gtad_dr_summarybychain(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) TO qlikuser;
GRANT ALL ON FUNCTION public.sp_ubt_gtad_dr_summarybychain(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) TO consultant01;


--
-- TOC entry 7802 (class 0 OID 0)
-- Dependencies: 1121
-- Name: FUNCTION sp_ubt_gtad_salescomm(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone); Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON FUNCTION public.sp_ubt_gtad_salescomm(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) TO qlikuser;
GRANT ALL ON FUNCTION public.sp_ubt_gtad_salescomm(in_fromdatetime timestamp without time zone, in_todatetime timestamp without time zone) TO consultant01;


--
-- TOC entry 7803 (class 0 OID 0)
-- Dependencies: 1195
-- Name: FUNCTION sp_ubt_insertsalescommreport(in_generateddate date); Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON FUNCTION public.sp_ubt_insertsalescommreport(in_generateddate date) TO qlikuser;


--
-- TOC entry 7804 (class 0 OID 0)
-- Dependencies: 1203
-- Name: FUNCTION sp_dim_employee(vparperiod character); Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON FUNCTION qlik.sp_dim_employee(vparperiod character) TO postgres;


--
-- TOC entry 7805 (class 0 OID 0)
-- Dependencies: 1215
-- Name: FUNCTION sp_fact_pnc_employee(vparperiod character); Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON FUNCTION qlik.sp_fact_pnc_employee(vparperiod character) TO postgres;


--
-- TOC entry 7806 (class 0 OID 0)
-- Dependencies: 1216
-- Name: FUNCTION sp_fact_pnc_training(vparperiod character); Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON FUNCTION qlik.sp_fact_pnc_training(vparperiod character) TO postgres;


--
-- TOC entry 7807 (class 0 OID 0)
-- Dependencies: 1220
-- Name: FUNCTION sp_stg_employee(vparperiod character); Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON FUNCTION qlik.sp_stg_employee(vparperiod character) TO postgres;


--
-- TOC entry 7811 (class 0 OID 0)
-- Dependencies: 382
-- Name: TABLE daily_etl_job_status; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.daily_etl_job_status TO sp_suhas;


--
-- TOC entry 7815 (class 0 OID 0)
-- Dependencies: 388
-- Name: TABLE pg_prd_test_gtamt_detail_20220122; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.pg_prd_test_gtamt_detail_20220122 TO consultant01;


--
-- TOC entry 7816 (class 0 OID 0)
-- Dependencies: 389
-- Name: TABLE pg_prd_test_gtamt_detail_20220126; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.pg_prd_test_gtamt_detail_20220126 TO consultant01;


--
-- TOC entry 7817 (class 0 OID 0)
-- Dependencies: 390
-- Name: TABLE pg_prd_test_gtamtr_20220122; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.pg_prd_test_gtamtr_20220122 TO consultant01;


--
-- TOC entry 7819 (class 0 OID 0)
-- Dependencies: 393
-- Name: TABLE rtpos_ubt_test; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.rtpos_ubt_test TO consultant01;


--
-- TOC entry 7820 (class 0 OID 0)
-- Dependencies: 394
-- Name: TABLE rtshop_ubt_test; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.rtshop_ubt_test TO consultant01;


--
-- TOC entry 7821 (class 0 OID 0)
-- Dependencies: 400
-- Name: TABLE temp_place_bet_transaction; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.temp_place_bet_transaction TO sp_postgres;
GRANT SELECT ON TABLE public.temp_place_bet_transaction TO qlikuser;


--
-- TOC entry 7822 (class 0 OID 0)
-- Dependencies: 401
-- Name: TABLE temp_table_trf; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.temp_table_trf TO qlikuser;
GRANT ALL ON TABLE public.temp_table_trf TO sp_postgres;


--
-- TOC entry 7823 (class 0 OID 0)
-- Dependencies: 1027
-- Name: TABLE test; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.test TO sp_suhas;


--
-- TOC entry 7824 (class 0 OID 0)
-- Dependencies: 407
-- Name: TABLE "test_salescommrpt_ubt04FEB"; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public."test_salescommrpt_ubt04FEB" TO consultant01;


--
-- TOC entry 7825 (class 0 OID 0)
-- Dependencies: 408
-- Name: TABLE test_salescommrpt_ubt04oct; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.test_salescommrpt_ubt04oct TO consultant01;


--
-- TOC entry 7826 (class 0 OID 0)
-- Dependencies: 412
-- Name: TABLE test_ubt_dailysummarychain_03nov; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.test_ubt_dailysummarychain_03nov TO consultant01;


--
-- TOC entry 7827 (class 0 OID 0)
-- Dependencies: 413
-- Name: TABLE test_ubt_get_amt_trx_03nov; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.test_ubt_get_amt_trx_03nov TO consultant01;


--
-- TOC entry 7828 (class 0 OID 0)
-- Dependencies: 414
-- Name: TABLE test_ubt_interfacedata; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.test_ubt_interfacedata TO consultant01;


--
-- TOC entry 7829 (class 0 OID 0)
-- Dependencies: 415
-- Name: TABLE test_ubt_interfacedata_21nov; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.test_ubt_interfacedata_21nov TO sp_postgres;


--
-- TOC entry 7830 (class 0 OID 0)
-- Dependencies: 417
-- Name: TABLE test_ubt_invoicerpt_03nov; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.test_ubt_invoicerpt_03nov TO consultant01;


--
-- TOC entry 7831 (class 0 OID 0)
-- Dependencies: 419
-- Name: TABLE test_ubt_salescomm_14nov; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.test_ubt_salescomm_14nov TO consultant01;


--
-- TOC entry 7832 (class 0 OID 0)
-- Dependencies: 422
-- Name: TABLE test_ubt_toto_uuid; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.test_ubt_toto_uuid TO sp_postgres;


--
-- TOC entry 7833 (class 0 OID 0)
-- Dependencies: 868
-- Name: TABLE ubt_salescomm_report_data; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT,INSERT ON TABLE public.ubt_salescomm_report_data TO qlikuser;
GRANT SELECT ON TABLE public.ubt_salescomm_report_data TO consultant01;


--
-- TOC entry 7834 (class 0 OID 0)
-- Dependencies: 425
-- Name: TABLE ubt_temp_locinv_02nov; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ubt_temp_locinv_02nov TO consultant01;


--
-- TOC entry 7835 (class 0 OID 0)
-- Dependencies: 430
-- Name: TABLE ubt_test_gta_tra_csv_prd; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ubt_test_gta_tra_csv_prd TO consultant01;


--
-- TOC entry 7836 (class 0 OID 0)
-- Dependencies: 431
-- Name: TABLE ubt_test_gtad_csv_prd; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ubt_test_gtad_csv_prd TO sp_postgres;


--
-- TOC entry 7837 (class 0 OID 0)
-- Dependencies: 965
-- Name: TABLE ztalation_postgres_log_test; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztalation_postgres_log_test TO svcalation;


--
-- TOC entry 7838 (class 0 OID 0)
-- Dependencies: 445
-- Name: TABLE ztall_businessday; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztall_businessday TO qlikuser;
GRANT SELECT ON TABLE public.ztall_businessday TO consultant01;
GRANT SELECT ON TABLE public.ztall_businessday TO sp_suhas;


--
-- TOC entry 7839 (class 0 OID 0)
-- Dependencies: 446
-- Name: TABLE ztall_product; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztall_product TO qlikuser;
GRANT SELECT ON TABLE public.ztall_product TO consultant01;
GRANT SELECT ON TABLE public.ztall_product TO sp_suhas;


--
-- TOC entry 7840 (class 0 OID 0)
-- Dependencies: 447
-- Name: TABLE ztall_weight_margin; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztall_weight_margin TO qlikuser;


--
-- TOC entry 7841 (class 0 OID 0)
-- Dependencies: 448
-- Name: TABLE ztbg_daily_bk20240314; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ztbg_daily_bk20240314 TO qlikuser;


--
-- TOC entry 7842 (class 0 OID 0)
-- Dependencies: 457
-- Name: TABLE ztes_esrm_device; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_esrm_device TO qlikuser;
GRANT SELECT ON TABLE public.ztes_esrm_device TO consultant01;
GRANT SELECT ON TABLE public.ztes_esrm_device TO sp_suhas;


--
-- TOC entry 7843 (class 0 OID 0)
-- Dependencies: 458
-- Name: TABLE ztes_esrm_device_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztes_esrm_device_uat_test TO sp_postgres;


--
-- TOC entry 7844 (class 0 OID 0)
-- Dependencies: 459
-- Name: TABLE ztes_esrm_outlet; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_esrm_outlet TO qlikuser;
GRANT SELECT ON TABLE public.ztes_esrm_outlet TO consultant01;
GRANT SELECT ON TABLE public.ztes_esrm_outlet TO sp_suhas;


--
-- TOC entry 7845 (class 0 OID 0)
-- Dependencies: 460
-- Name: TABLE ztes_esrm_outlet_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztes_esrm_outlet_uat_test TO sp_postgres;


--
-- TOC entry 7846 (class 0 OID 0)
-- Dependencies: 461
-- Name: TABLE ztes_esrm_teller; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_esrm_teller TO qlikuser;
GRANT SELECT ON TABLE public.ztes_esrm_teller TO consultant01;
GRANT SELECT ON TABLE public.ztes_esrm_teller TO sp_suhas;


--
-- TOC entry 7847 (class 0 OID 0)
-- Dependencies: 462
-- Name: TABLE ztes_este_bigwinner; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_este_bigwinner TO qlikuser;
GRANT SELECT ON TABLE public.ztes_este_bigwinner TO consultant01;
GRANT SELECT ON TABLE public.ztes_este_bigwinner TO sp_suhas;


--
-- TOC entry 7848 (class 0 OID 0)
-- Dependencies: 463
-- Name: TABLE ztes_este_cashpurge; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_este_cashpurge TO qlikuser;
GRANT SELECT ON TABLE public.ztes_este_cashpurge TO consultant01;
GRANT SELECT ON TABLE public.ztes_este_cashpurge TO sp_suhas;


--
-- TOC entry 7849 (class 0 OID 0)
-- Dependencies: 464
-- Name: TABLE ztes_este_uncashexpire; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_este_uncashexpire TO qlikuser;
GRANT SELECT ON TABLE public.ztes_este_uncashexpire TO consultant01;
GRANT SELECT ON TABLE public.ztes_este_uncashexpire TO sp_suhas;


--
-- TOC entry 7850 (class 0 OID 0)
-- Dependencies: 465
-- Name: TABLE ztes_este_uncashpurge; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_este_uncashpurge TO qlikuser;
GRANT SELECT ON TABLE public.ztes_este_uncashpurge TO consultant01;
GRANT SELECT ON TABLE public.ztes_este_uncashpurge TO sp_suhas;


--
-- TOC entry 7851 (class 0 OID 0)
-- Dependencies: 466
-- Name: TABLE ztes_inv_adj; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_inv_adj TO qlikuser;
GRANT ALL ON TABLE public.ztes_inv_adj TO consultant01;
GRANT SELECT ON TABLE public.ztes_inv_adj TO sp_suhas;


--
-- TOC entry 7852 (class 0 OID 0)
-- Dependencies: 467
-- Name: TABLE ztes_inv_adj_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztes_inv_adj_uat_test TO sp_postgres;


--
-- TOC entry 7853 (class 0 OID 0)
-- Dependencies: 468
-- Name: TABLE ztes_inv_agt; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_inv_agt TO qlikuser;
GRANT SELECT ON TABLE public.ztes_inv_agt TO consultant01;
GRANT SELECT ON TABLE public.ztes_inv_agt TO sp_suhas;


--
-- TOC entry 7854 (class 0 OID 0)
-- Dependencies: 470
-- Name: TABLE ztes_inv_dev; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_inv_dev TO qlikuser;
GRANT SELECT ON TABLE public.ztes_inv_dev TO consultant01;
GRANT SELECT ON TABLE public.ztes_inv_dev TO sp_suhas;


--
-- TOC entry 7855 (class 0 OID 0)
-- Dependencies: 471
-- Name: TABLE ztes_inv_dev_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztes_inv_dev_uat_test TO sp_postgres;


--
-- TOC entry 7856 (class 0 OID 0)
-- Dependencies: 472
-- Name: TABLE ztes_inv_invdef; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_inv_invdef TO qlikuser;
GRANT SELECT ON TABLE public.ztes_inv_invdef TO consultant01;
GRANT SELECT ON TABLE public.ztes_inv_invdef TO sp_suhas;


--
-- TOC entry 7857 (class 0 OID 0)
-- Dependencies: 473
-- Name: TABLE ztes_inv_invdef2; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_inv_invdef2 TO qlikuser;
GRANT SELECT ON TABLE public.ztes_inv_invdef2 TO consultant01;
GRANT SELECT ON TABLE public.ztes_inv_invdef2 TO sp_suhas;


--
-- TOC entry 7858 (class 0 OID 0)
-- Dependencies: 474
-- Name: TABLE ztes_mjf_brdinf; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_mjf_brdinf TO qlikuser;
GRANT SELECT ON TABLE public.ztes_mjf_brdinf TO consultant01;
GRANT SELECT ON TABLE public.ztes_mjf_brdinf TO sp_suhas;


--
-- TOC entry 7859 (class 0 OID 0)
-- Dependencies: 475
-- Name: TABLE ztes_mjf_brdnums; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_mjf_brdnums TO qlikuser;
GRANT SELECT ON TABLE public.ztes_mjf_brdnums TO consultant01;
GRANT SELECT ON TABLE public.ztes_mjf_brdnums TO sp_suhas;


--
-- TOC entry 7860 (class 0 OID 0)
-- Dependencies: 476
-- Name: TABLE ztes_mjf_draws; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_mjf_draws TO qlikuser;
GRANT SELECT ON TABLE public.ztes_mjf_draws TO consultant01;
GRANT SELECT ON TABLE public.ztes_mjf_draws TO sp_suhas;


--
-- TOC entry 7861 (class 0 OID 0)
-- Dependencies: 477
-- Name: TABLE ztes_mjf_journals; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_mjf_journals TO qlikuser;
GRANT SELECT ON TABLE public.ztes_mjf_journals TO consultant01;
GRANT SELECT ON TABLE public.ztes_mjf_journals TO sp_suhas;


--
-- TOC entry 7862 (class 0 OID 0)
-- Dependencies: 478
-- Name: TABLE ztes_mjf_windtl; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_mjf_windtl TO qlikuser;
GRANT SELECT ON TABLE public.ztes_mjf_windtl TO consultant01;
GRANT SELECT ON TABLE public.ztes_mjf_windtl TO sp_suhas;


--
-- TOC entry 7863 (class 0 OID 0)
-- Dependencies: 479
-- Name: TABLE ztes_orphans; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_orphans TO qlikuser;


--
-- TOC entry 7864 (class 0 OID 0)
-- Dependencies: 480
-- Name: TABLE ztes_orphans_output; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ztes_orphans_output TO qlikuser;


--
-- TOC entry 7865 (class 0 OID 0)
-- Dependencies: 481
-- Name: TABLE ztes_orphans_output_board; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ztes_orphans_output_board TO qlikuser;


--
-- TOC entry 7866 (class 0 OID 0)
-- Dependencies: 482
-- Name: TABLE ztes_orphans_requestid; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_orphans_requestid TO qlikuser;


--
-- TOC entry 7867 (class 0 OID 0)
-- Dependencies: 483
-- Name: TABLE ztes_pdf_drawparam; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_pdf_drawparam TO qlikuser;
GRANT SELECT ON TABLE public.ztes_pdf_drawparam TO sp_suhas;
GRANT ALL ON TABLE public.ztes_pdf_drawparam TO consultant01;


--
-- TOC entry 7868 (class 0 OID 0)
-- Dependencies: 877
-- Name: TABLE ztes_pdf_drawparam_lsr_hds2; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ztes_pdf_drawparam_lsr_hds2 TO consultant01;


--
-- TOC entry 7869 (class 0 OID 0)
-- Dependencies: 484
-- Name: TABLE ztes_pdf_liabcon; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_pdf_liabcon TO qlikuser;
GRANT SELECT ON TABLE public.ztes_pdf_liabcon TO consultant01;
GRANT SELECT ON TABLE public.ztes_pdf_liabcon TO sp_suhas;


--
-- TOC entry 7870 (class 0 OID 0)
-- Dependencies: 485
-- Name: TABLE ztes_pdf_syndbrddtl; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_pdf_syndbrddtl TO qlikuser;
GRANT SELECT ON TABLE public.ztes_pdf_syndbrddtl TO consultant01;
GRANT SELECT ON TABLE public.ztes_pdf_syndbrddtl TO sp_suhas;


--
-- TOC entry 7871 (class 0 OID 0)
-- Dependencies: 486
-- Name: TABLE ztes_pdf_synddef; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_pdf_synddef TO qlikuser;
GRANT SELECT ON TABLE public.ztes_pdf_synddef TO consultant01;
GRANT SELECT ON TABLE public.ztes_pdf_synddef TO sp_suhas;


--
-- TOC entry 7872 (class 0 OID 0)
-- Dependencies: 487
-- Name: TABLE ztes_pdf_synddrwdtl; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_pdf_synddrwdtl TO qlikuser;
GRANT SELECT ON TABLE public.ztes_pdf_synddrwdtl TO consultant01;
GRANT SELECT ON TABLE public.ztes_pdf_synddrwdtl TO sp_suhas;


--
-- TOC entry 7873 (class 0 OID 0)
-- Dependencies: 488
-- Name: TABLE ztes_pdf_syndrecs; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_pdf_syndrecs TO qlikuser;
GRANT SELECT ON TABLE public.ztes_pdf_syndrecs TO consultant01;
GRANT SELECT ON TABLE public.ztes_pdf_syndrecs TO sp_suhas;


--
-- TOC entry 7874 (class 0 OID 0)
-- Dependencies: 489
-- Name: TABLE ztes_pdf_winnbr; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_pdf_winnbr TO qlikuser;
GRANT SELECT ON TABLE public.ztes_pdf_winnbr TO consultant01;
GRANT SELECT ON TABLE public.ztes_pdf_winnbr TO sp_suhas;


--
-- TOC entry 7875 (class 0 OID 0)
-- Dependencies: 490
-- Name: TABLE ztes_pdf_winshares; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_pdf_winshares TO qlikuser;
GRANT SELECT ON TABLE public.ztes_pdf_winshares TO consultant01;
GRANT SELECT ON TABLE public.ztes_pdf_winshares TO sp_suhas;


--
-- TOC entry 7876 (class 0 OID 0)
-- Dependencies: 491
-- Name: TABLE ztes_totallog; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztes_totallog TO qlikuser;
GRANT SELECT ON TABLE public.ztes_totallog TO consultant01;
GRANT SELECT ON TABLE public.ztes_totallog TO sp_suhas;


--
-- TOC entry 7877 (class 0 OID 0)
-- Dependencies: 492
-- Name: TABLE ztetl_log; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztetl_log TO qlikuser;
GRANT SELECT ON TABLE public.ztetl_log TO consultant01;


--
-- TOC entry 7878 (class 0 OID 0)
-- Dependencies: 493
-- Name: TABLE ztfr_txn; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztfr_txn TO qlikuser;


--
-- TOC entry 7879 (class 0 OID 0)
-- Dependencies: 494
-- Name: TABLE ztkyc_agents; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztkyc_agents TO consultant01;
GRANT SELECT ON TABLE public.ztkyc_agents TO qlikuser;
GRANT SELECT ON TABLE public.ztkyc_agents TO sp_suhas;


--
-- TOC entry 7880 (class 0 OID 0)
-- Dependencies: 495
-- Name: TABLE ztkyc_applicationdurationhistory; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztkyc_applicationdurationhistory TO consultant01;
GRANT SELECT ON TABLE public.ztkyc_applicationdurationhistory TO qlikuser;
GRANT SELECT ON TABLE public.ztkyc_applicationdurationhistory TO sp_suhas;


--
-- TOC entry 7881 (class 0 OID 0)
-- Dependencies: 496
-- Name: TABLE ztkyc_applications; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztkyc_applications TO consultant01;
GRANT SELECT ON TABLE public.ztkyc_applications TO qlikuser;
GRANT SELECT ON TABLE public.ztkyc_applications TO sp_suhas;


--
-- TOC entry 7882 (class 0 OID 0)
-- Dependencies: 497
-- Name: TABLE ztkyc_applicationstatushistory; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztkyc_applicationstatushistory TO consultant01;
GRANT SELECT ON TABLE public.ztkyc_applicationstatushistory TO qlikuser;
GRANT SELECT ON TABLE public.ztkyc_applicationstatushistory TO sp_suhas;


--
-- TOC entry 7883 (class 0 OID 0)
-- Dependencies: 498
-- Name: TABLE ztkyc_dashboard; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztkyc_dashboard TO consultant01;
GRANT SELECT ON TABLE public.ztkyc_dashboard TO qlikuser;
GRANT SELECT ON TABLE public.ztkyc_dashboard TO sp_suhas;


--
-- TOC entry 7884 (class 0 OID 0)
-- Dependencies: 499
-- Name: TABLE ztkyc_kycstatus; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztkyc_kycstatus TO consultant01;
GRANT SELECT ON TABLE public.ztkyc_kycstatus TO qlikuser;
GRANT SELECT ON TABLE public.ztkyc_kycstatus TO sp_suhas;


--
-- TOC entry 7885 (class 0 OID 0)
-- Dependencies: 500
-- Name: TABLE ztkyc_role; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztkyc_role TO consultant01;
GRANT SELECT ON TABLE public.ztkyc_role TO qlikuser;
GRANT SELECT ON TABLE public.ztkyc_role TO sp_suhas;


--
-- TOC entry 7886 (class 0 OID 0)
-- Dependencies: 501
-- Name: TABLE ztmf_surveyresult; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmf_surveyresult TO qlikuser;
GRANT SELECT ON TABLE public.ztmf_surveyresult TO consultant01;


--
-- TOC entry 7887 (class 0 OID 0)
-- Dependencies: 502
-- Name: TABLE ztmm2_cancel; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_cancel TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_cancel TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_cancel TO sp_suhas;


--
-- TOC entry 7888 (class 0 OID 0)
-- Dependencies: 503
-- Name: TABLE ztmm2_invoiceperterminal; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_invoiceperterminal TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_invoiceperterminal TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_invoiceperterminal TO sp_suhas;


--
-- TOC entry 7889 (class 0 OID 0)
-- Dependencies: 504
-- Name: TABLE ztmm2_liability; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_liability TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_liability TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_liability TO sp_suhas;


--
-- TOC entry 7890 (class 0 OID 0)
-- Dependencies: 505
-- Name: TABLE ztmm2_purge; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_purge TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_purge TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_purge TO sp_suhas;


--
-- TOC entry 7891 (class 0 OID 0)
-- Dependencies: 506
-- Name: TABLE ztmm2_purge_dev; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_purge_dev TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_purge_dev TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_purge_dev TO sp_suhas;


--
-- TOC entry 7892 (class 0 OID 0)
-- Dependencies: 507
-- Name: TABLE ztmm2_retailsummary; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_retailsummary TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_retailsummary TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_retailsummary TO sp_suhas;


--
-- TOC entry 7893 (class 0 OID 0)
-- Dependencies: 508
-- Name: TABLE ztmm2_ros; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_ros TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_ros TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_ros TO sp_suhas;


--
-- TOC entry 7894 (class 0 OID 0)
-- Dependencies: 509
-- Name: TABLE ztmm2_sprtliabtrans_v; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_sprtliabtrans_v TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_sprtliabtrans_v TO sp_suhas;


--
-- TOC entry 7895 (class 0 OID 0)
-- Dependencies: 510
-- Name: TABLE ztmm2_timetable; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_timetable TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_timetable TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_timetable TO sp_suhas;


--
-- TOC entry 7896 (class 0 OID 0)
-- Dependencies: 511
-- Name: TABLE ztmm2_valid; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_valid TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_valid TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_valid TO sp_suhas;


--
-- TOC entry 7897 (class 0 OID 0)
-- Dependencies: 512
-- Name: TABLE ztmm2_wager; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2_wager TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2_wager TO consultant01;
GRANT SELECT ON TABLE public.ztmm2_wager TO sp_suhas;


--
-- TOC entry 7898 (class 0 OID 0)
-- Dependencies: 513
-- Name: TABLE ztmm2file_liability; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2file_liability TO consultant01;
GRANT SELECT ON TABLE public.ztmm2file_liability TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2file_liability TO sp_suhas;


--
-- TOC entry 7899 (class 0 OID 0)
-- Dependencies: 514
-- Name: TABLE ztmm2file_valid; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2file_valid TO consultant01;
GRANT SELECT ON TABLE public.ztmm2file_valid TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2file_valid TO sp_suhas;


--
-- TOC entry 7900 (class 0 OID 0)
-- Dependencies: 515
-- Name: TABLE ztmm2file_wager; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztmm2file_wager TO consultant01;
GRANT SELECT ON TABLE public.ztmm2file_wager TO qlikuser;
GRANT SELECT ON TABLE public.ztmm2file_wager TO sp_suhas;


--
-- TOC entry 7901 (class 0 OID 0)
-- Dependencies: 516
-- Name: TABLE ztob_businessday; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_businessday TO qlikuser;
GRANT SELECT ON TABLE public.ztob_businessday TO consultant01;
GRANT SELECT ON TABLE public.ztob_businessday TO sp_suhas;


--
-- TOC entry 7902 (class 0 OID 0)
-- Dependencies: 517
-- Name: TABLE ztob_channels; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_channels TO qlikuser;
GRANT SELECT ON TABLE public.ztob_channels TO consultant01;
GRANT SELECT ON TABLE public.ztob_channels TO sp_suhas;


--
-- TOC entry 7903 (class 0 OID 0)
-- Dependencies: 518
-- Name: TABLE ztob_custcalls; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custcalls TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custcalls TO consultant01;
GRANT SELECT ON TABLE public.ztob_custcalls TO sp_suhas;


--
-- TOC entry 7904 (class 0 OID 0)
-- Dependencies: 519
-- Name: TABLE ztob_custfastapplications; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custfastapplications TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custfastapplications TO consultant01;


--
-- TOC entry 7905 (class 0 OID 0)
-- Dependencies: 520
-- Name: TABLE ztob_custflagstaff; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custflagstaff TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custflagstaff TO sp_suhas;


--
-- TOC entry 7906 (class 0 OID 0)
-- Dependencies: 521
-- Name: TABLE ztob_custlimits; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custlimits TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custlimits TO consultant01;
GRANT SELECT ON TABLE public.ztob_custlimits TO sp_suhas;


--
-- TOC entry 7907 (class 0 OID 0)
-- Dependencies: 522
-- Name: TABLE ztob_custlogin; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custlogin TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custlogin TO consultant01;


--
-- TOC entry 7908 (class 0 OID 0)
-- Dependencies: 523
-- Name: TABLE ztob_customer; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_customer TO qlikuser;
GRANT SELECT ON TABLE public.ztob_customer TO sp_suhas;


--
-- TOC entry 7909 (class 0 OID 0)
-- Dependencies: 524
-- Name: TABLE ztob_customer_act_date; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_customer_act_date TO consultant01;
GRANT SELECT ON TABLE public.ztob_customer_act_date TO qlikuser;
GRANT SELECT ON TABLE public.ztob_customer_act_date TO sp_suhas;


--
-- TOC entry 7910 (class 0 OID 0)
-- Dependencies: 846
-- Name: TABLE ztob_customer_anonymised; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_customer_anonymised TO qlikuser;


--
-- TOC entry 7911 (class 0 OID 0)
-- Dependencies: 525
-- Name: TABLE ztob_customer_backup; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_customer_backup TO qlikuser;
GRANT SELECT ON TABLE public.ztob_customer_backup TO consultant01;
GRANT SELECT ON TABLE public.ztob_customer_backup TO sp_suhas;


--
-- TOC entry 7912 (class 0 OID 0)
-- Dependencies: 526
-- Name: TABLE ztob_customer_master; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_customer_master TO qlikuser;
GRANT SELECT ON TABLE public.ztob_customer_master TO sp_suhas;


--
-- TOC entry 7913 (class 0 OID 0)
-- Dependencies: 527
-- Name: TABLE ztob_customer_temp; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_customer_temp TO consultant01;
GRANT SELECT ON TABLE public.ztob_customer_temp TO qlikuser;
GRANT SELECT ON TABLE public.ztob_customer_temp TO sp_suhas;


--
-- TOC entry 7914 (class 0 OID 0)
-- Dependencies: 528
-- Name: TABLE ztob_customer_test; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_customer_test TO consultant01;
GRANT SELECT ON TABLE public.ztob_customer_test TO qlikuser;
GRANT SELECT ON TABLE public.ztob_customer_test TO sp_suhas;


--
-- TOC entry 7915 (class 0 OID 0)
-- Dependencies: 843
-- Name: TABLE ztob_customer_update_trail; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_customer_update_trail TO qlikuser;


--
-- TOC entry 7916 (class 0 OID 0)
-- Dependencies: 529
-- Name: TABLE ztob_custstatusflag; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custstatusflag TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custstatusflag TO sp_suhas;


--
-- TOC entry 7917 (class 0 OID 0)
-- Dependencies: 530
-- Name: TABLE ztob_custstatuslog; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custstatuslog TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custstatuslog TO sp_suhas;


--
-- TOC entry 7918 (class 0 OID 0)
-- Dependencies: 531
-- Name: TABLE ztob_custsweepback; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custsweepback TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custsweepback TO consultant01;


--
-- TOC entry 7919 (class 0 OID 0)
-- Dependencies: 532
-- Name: TABLE ztob_custtnc; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_custtnc TO qlikuser;
GRANT SELECT ON TABLE public.ztob_custtnc TO sp_suhas;


--
-- TOC entry 7920 (class 0 OID 0)
-- Dependencies: 533
-- Name: TABLE ztob_exclusionhistory; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_exclusionhistory TO qlikuser;
GRANT SELECT ON TABLE public.ztob_exclusionhistory TO consultant01;
GRANT SELECT ON TABLE public.ztob_exclusionhistory TO sp_suhas;


--
-- TOC entry 7921 (class 0 OID 0)
-- Dependencies: 534
-- Name: TABLE ztob_journal; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_journal TO qlikuser;
GRANT SELECT ON TABLE public.ztob_journal TO consultant01;
GRANT SELECT ON TABLE public.ztob_journal TO sp_suhas;


--
-- TOC entry 7922 (class 0 OID 0)
-- Dependencies: 535
-- Name: TABLE ztob_journal_temp; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_journal_temp TO consultant01;
GRANT SELECT ON TABLE public.ztob_journal_temp TO qlikuser;
GRANT SELECT ON TABLE public.ztob_journal_temp TO sp_suhas;


--
-- TOC entry 7923 (class 0 OID 0)
-- Dependencies: 536
-- Name: TABLE ztob_lottery; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_lottery TO qlikuser;
GRANT SELECT ON TABLE public.ztob_lottery TO consultant01;
GRANT SELECT ON TABLE public.ztob_lottery TO sp_suhas;


--
-- TOC entry 7924 (class 0 OID 0)
-- Dependencies: 537
-- Name: TABLE ztob_lottery_patch; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_lottery_patch TO qlikuser;
GRANT SELECT ON TABLE public.ztob_lottery_patch TO consultant01;
GRANT SELECT ON TABLE public.ztob_lottery_patch TO sp_suhas;


--
-- TOC entry 7925 (class 0 OID 0)
-- Dependencies: 538
-- Name: TABLE ztob_lottery_temp; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_lottery_temp TO sp_suhas;


--
-- TOC entry 7926 (class 0 OID 0)
-- Dependencies: 539
-- Name: TABLE ztob_lotterycustdailystats; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_lotterycustdailystats TO qlikuser;
GRANT SELECT ON TABLE public.ztob_lotterycustdailystats TO consultant01;
GRANT SELECT ON TABLE public.ztob_lotterycustdailystats TO sp_suhas;


--
-- TOC entry 7927 (class 0 OID 0)
-- Dependencies: 540
-- Name: TABLE ztob_lotterycuststats; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_lotterycuststats TO qlikuser;
GRANT SELECT ON TABLE public.ztob_lotterycuststats TO consultant01;
GRANT SELECT ON TABLE public.ztob_lotterycuststats TO sp_suhas;


--
-- TOC entry 7928 (class 0 OID 0)
-- Dependencies: 541
-- Name: TABLE ztob_lotterysubscriptions; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_lotterysubscriptions TO qlikuser;
GRANT SELECT ON TABLE public.ztob_lotterysubscriptions TO consultant01;


--
-- TOC entry 7929 (class 0 OID 0)
-- Dependencies: 542
-- Name: TABLE ztob_reactivate; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_reactivate TO consultant01;
GRANT SELECT ON TABLE public.ztob_reactivate TO qlikuser;
GRANT SELECT ON TABLE public.ztob_reactivate TO sp_suhas;


--
-- TOC entry 7930 (class 0 OID 0)
-- Dependencies: 543
-- Name: TABLE ztob_sportbets; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportbets TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportbets TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportbets TO sp_suhas;


--
-- TOC entry 7931 (class 0 OID 0)
-- Dependencies: 544
-- Name: TABLE ztob_sportbets_temp; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportbets_temp TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportbets_temp TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportbets_temp TO sp_suhas;


--
-- TOC entry 7932 (class 0 OID 0)
-- Dependencies: 545
-- Name: TABLE ztob_sportbets_wager; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportbets_wager TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportbets_wager TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportbets_wager TO sp_suhas;


--
-- TOC entry 7933 (class 0 OID 0)
-- Dependencies: 546
-- Name: TABLE ztob_sportbetssettled; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportbetssettled TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportbetssettled TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportbetssettled TO sp_suhas;


--
-- TOC entry 7934 (class 0 OID 0)
-- Dependencies: 547
-- Name: TABLE ztob_sportbetssettled_cancel; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportbetssettled_cancel TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportbetssettled_cancel TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportbetssettled_cancel TO sp_suhas;


--
-- TOC entry 7935 (class 0 OID 0)
-- Dependencies: 548
-- Name: TABLE ztob_sportbetssettled_liability; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportbetssettled_liability TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportbetssettled_liability TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportbetssettled_liability TO sp_suhas;


--
-- TOC entry 7936 (class 0 OID 0)
-- Dependencies: 549
-- Name: TABLE ztob_sportbetssettled_valid; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportbetssettled_valid TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportbetssettled_valid TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportbetssettled_valid TO sp_suhas;


--
-- TOC entry 7937 (class 0 OID 0)
-- Dependencies: 550
-- Name: TABLE ztob_sportreport40; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportreport40 TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportreport40 TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportreport40 TO sp_suhas;


--
-- TOC entry 7938 (class 0 OID 0)
-- Dependencies: 551
-- Name: TABLE ztob_sportscustdailystats; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportscustdailystats TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportscustdailystats TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportscustdailystats TO sp_suhas;


--
-- TOC entry 7939 (class 0 OID 0)
-- Dependencies: 552
-- Name: TABLE ztob_sportscuststats; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_sportscuststats TO qlikuser;
GRANT SELECT ON TABLE public.ztob_sportscuststats TO consultant01;
GRANT SELECT ON TABLE public.ztob_sportscuststats TO sp_suhas;


--
-- TOC entry 7940 (class 0 OID 0)
-- Dependencies: 553
-- Name: TABLE ztob_table_test; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_table_test TO sp_suhas;


--
-- TOC entry 7941 (class 0 OID 0)
-- Dependencies: 554
-- Name: TABLE ztob_timetable; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_timetable TO qlikuser;
GRANT SELECT ON TABLE public.ztob_timetable TO consultant01;
GRANT SELECT ON TABLE public.ztob_timetable TO sp_suhas;


--
-- TOC entry 7942 (class 0 OID 0)
-- Dependencies: 555
-- Name: TABLE ztob_timetableselections; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_timetableselections TO qlikuser;
GRANT SELECT ON TABLE public.ztob_timetableselections TO consultant01;
GRANT SELECT ON TABLE public.ztob_timetableselections TO sp_suhas;


--
-- TOC entry 7943 (class 0 OID 0)
-- Dependencies: 556
-- Name: TABLE ztob_transactioncodes; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztob_transactioncodes TO qlikuser;
GRANT SELECT ON TABLE public.ztob_transactioncodes TO sp_suhas;


--
-- TOC entry 7944 (class 0 OID 0)
-- Dependencies: 557
-- Name: TABLE ztosd_eod_employee; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztosd_eod_employee TO qlikuser;
GRANT SELECT ON TABLE public.ztosd_eod_employee TO consultant01;
GRANT SELECT ON TABLE public.ztosd_eod_employee TO sp_suhas;


--
-- TOC entry 7945 (class 0 OID 0)
-- Dependencies: 558
-- Name: TABLE ztosd_eod_product; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztosd_eod_product TO qlikuser;
GRANT SELECT ON TABLE public.ztosd_eod_product TO consultant01;
GRANT SELECT ON TABLE public.ztosd_eod_product TO sp_suhas;


--
-- TOC entry 7946 (class 0 OID 0)
-- Dependencies: 559
-- Name: TABLE ztosd_md_branch_insurance; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztosd_md_branch_insurance TO qlikuser;
GRANT SELECT ON TABLE public.ztosd_md_branch_insurance TO consultant01;
GRANT SELECT ON TABLE public.ztosd_md_branch_insurance TO sp_suhas;


--
-- TOC entry 7947 (class 0 OID 0)
-- Dependencies: 560
-- Name: TABLE ztosd_md_product; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztosd_md_product TO qlikuser;
GRANT SELECT ON TABLE public.ztosd_md_product TO consultant01;
GRANT SELECT ON TABLE public.ztosd_md_product TO sp_suhas;


--
-- TOC entry 7948 (class 0 OID 0)
-- Dependencies: 561
-- Name: TABLE ztosd_nets; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztosd_nets TO qlikuser;
GRANT SELECT ON TABLE public.ztosd_nets TO consultant01;
GRANT SELECT ON TABLE public.ztosd_nets TO sp_suhas;


--
-- TOC entry 7949 (class 0 OID 0)
-- Dependencies: 562
-- Name: TABLE ztosd_svs; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztosd_svs TO qlikuser;
GRANT SELECT ON TABLE public.ztosd_svs TO consultant01;
GRANT SELECT ON TABLE public.ztosd_svs TO sp_suhas;


--
-- TOC entry 7950 (class 0 OID 0)
-- Dependencies: 563
-- Name: TABLE ztosd_tote; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztosd_tote TO qlikuser;
GRANT SELECT ON TABLE public.ztosd_tote TO consultant01;
GRANT SELECT ON TABLE public.ztosd_tote TO sp_suhas;


--
-- TOC entry 7951 (class 0 OID 0)
-- Dependencies: 564
-- Name: TABLE ztrtms2_customer; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms2_customer TO qlikuser;
GRANT SELECT ON TABLE public.ztrtms2_customer TO consultant01;
GRANT SELECT ON TABLE public.ztrtms2_customer TO sp_suhas;


--
-- TOC entry 7952 (class 0 OID 0)
-- Dependencies: 565
-- Name: TABLE ztrtms2_inv_dev; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms2_inv_dev TO qlikuser;
GRANT SELECT ON TABLE public.ztrtms2_inv_dev TO consultant01;
GRANT SELECT ON TABLE public.ztrtms2_inv_dev TO sp_suhas;


--
-- TOC entry 7953 (class 0 OID 0)
-- Dependencies: 566
-- Name: TABLE ztrtms2_retailer_master; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms2_retailer_master TO sp_suhas;


--
-- TOC entry 7954 (class 0 OID 0)
-- Dependencies: 567
-- Name: TABLE ztrtms2_terminal_master; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms2_terminal_master TO sp_suhas;


--
-- TOC entry 7955 (class 0 OID 0)
-- Dependencies: 568
-- Name: TABLE ztrtms2_trans_horse; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms2_trans_horse TO sp_suhas;
GRANT SELECT ON TABLE public.ztrtms2_trans_horse TO qlikuser;


--
-- TOC entry 7956 (class 0 OID 0)
-- Dependencies: 569
-- Name: TABLE ztrtms2_trans_lottery; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms2_trans_lottery TO qlikuser;
GRANT SELECT ON TABLE public.ztrtms2_trans_lottery TO consultant01;
GRANT SELECT ON TABLE public.ztrtms2_trans_lottery TO sp_suhas;


--
-- TOC entry 7957 (class 0 OID 0)
-- Dependencies: 570
-- Name: TABLE ztrtms2_trans_sports; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms2_trans_sports TO qlikuser;
GRANT SELECT ON TABLE public.ztrtms2_trans_sports TO consultant01;
GRANT SELECT ON TABLE public.ztrtms2_trans_sports TO sp_suhas;


--
-- TOC entry 7958 (class 0 OID 0)
-- Dependencies: 571
-- Name: TABLE ztrtms2_user_master; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms2_user_master TO sp_suhas;
GRANT SELECT ON TABLE public.ztrtms2_user_master TO qlikuser;


--
-- TOC entry 7960 (class 0 OID 0)
-- Dependencies: 572
-- Name: TABLE ztrtms_inv_adj; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_inv_adj TO sp_suhas;
GRANT SELECT ON TABLE public.ztrtms_inv_adj TO qlikuser;
GRANT ALL ON TABLE public.ztrtms_inv_adj TO consultant01;


--
-- TOC entry 7961 (class 0 OID 0)
-- Dependencies: 573
-- Name: TABLE ztrtms_inv_adj_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztrtms_inv_adj_uat_test TO sp_postgres;


--
-- TOC entry 7962 (class 0 OID 0)
-- Dependencies: 574
-- Name: TABLE ztrtms_inv_agt; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_inv_agt TO sp_suhas;
GRANT SELECT ON TABLE public.ztrtms_inv_agt TO qlikuser;
GRANT ALL ON TABLE public.ztrtms_inv_agt TO consultant01;


--
-- TOC entry 7963 (class 0 OID 0)
-- Dependencies: 576
-- Name: TABLE ztrtms_inv_def; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_inv_def TO sp_suhas;
GRANT ALL ON TABLE public.ztrtms_inv_def TO consultant01;


--
-- TOC entry 7964 (class 0 OID 0)
-- Dependencies: 577
-- Name: TABLE ztrtms_inv_def_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztrtms_inv_def_uat_test TO sp_postgres;


--
-- TOC entry 7965 (class 0 OID 0)
-- Dependencies: 578
-- Name: TABLE ztrtms_inv_dev; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_inv_dev TO qlikuser;
GRANT SELECT ON TABLE public.ztrtms_inv_dev TO consultant01;
GRANT SELECT ON TABLE public.ztrtms_inv_dev TO sp_suhas;


--
-- TOC entry 7966 (class 0 OID 0)
-- Dependencies: 579
-- Name: TABLE ztrtms_inv_dev_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztrtms_inv_dev_uat_test TO sp_postgres;


--
-- TOC entry 7967 (class 0 OID 0)
-- Dependencies: 580
-- Name: TABLE ztrtms_location_oprhrs; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_location_oprhrs TO qlikuser;
GRANT SELECT ON TABLE public.ztrtms_location_oprhrs TO consultant01;


--
-- TOC entry 7968 (class 0 OID 0)
-- Dependencies: 582
-- Name: TABLE ztrtms_retailer_master; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_retailer_master TO sp_suhas;
GRANT ALL ON TABLE public.ztrtms_retailer_master TO consultant01;


--
-- TOC entry 7969 (class 0 OID 0)
-- Dependencies: 583
-- Name: TABLE ztrtms_retailer_master_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztrtms_retailer_master_uat_test TO sp_postgres;


--
-- TOC entry 7970 (class 0 OID 0)
-- Dependencies: 584
-- Name: TABLE ztrtms_terminal_master; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_terminal_master TO sp_suhas;
GRANT ALL ON TABLE public.ztrtms_terminal_master TO consultant01;


--
-- TOC entry 7971 (class 0 OID 0)
-- Dependencies: 585
-- Name: TABLE ztrtms_terminal_master_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztrtms_terminal_master_uat_test TO sp_postgres;


--
-- TOC entry 7972 (class 0 OID 0)
-- Dependencies: 586
-- Name: TABLE ztrtms_trans_entry; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_trans_entry TO qlikuser;


--
-- TOC entry 7973 (class 0 OID 0)
-- Dependencies: 587
-- Name: TABLE ztrtms_trans_horse; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_trans_horse TO sp_suhas;
GRANT SELECT ON TABLE public.ztrtms_trans_horse TO qlikuser;
GRANT ALL ON TABLE public.ztrtms_trans_horse TO consultant01;


--
-- TOC entry 7974 (class 0 OID 0)
-- Dependencies: 588
-- Name: TABLE ztrtms_trans_horse_uat; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ztrtms_trans_horse_uat TO consultant01;


--
-- TOC entry 7975 (class 0 OID 0)
-- Dependencies: 589
-- Name: TABLE ztrtms_trans_lottery; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_trans_lottery TO qlikuser;
GRANT SELECT ON TABLE public.ztrtms_trans_lottery TO consultant01;
GRANT SELECT ON TABLE public.ztrtms_trans_lottery TO sp_suhas;


--
-- TOC entry 7976 (class 0 OID 0)
-- Dependencies: 590
-- Name: TABLE ztrtms_trans_lottery_uat; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ztrtms_trans_lottery_uat TO consultant01;


--
-- TOC entry 7977 (class 0 OID 0)
-- Dependencies: 591
-- Name: TABLE ztrtms_trans_sports; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_trans_sports TO qlikuser;
GRANT SELECT ON TABLE public.ztrtms_trans_sports TO consultant01;
GRANT SELECT ON TABLE public.ztrtms_trans_sports TO sp_suhas;


--
-- TOC entry 7978 (class 0 OID 0)
-- Dependencies: 593
-- Name: TABLE ztrtms_user_master; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztrtms_user_master TO sp_suhas;
GRANT SELECT ON TABLE public.ztrtms_user_master TO qlikuser;
GRANT ALL ON TABLE public.ztrtms_user_master TO consultant01;


--
-- TOC entry 7979 (class 0 OID 0)
-- Dependencies: 594
-- Name: TABLE ztrtms_user_master_uat_test; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztrtms_user_master_uat_test TO sp_postgres;


--
-- TOC entry 7980 (class 0 OID 0)
-- Dependencies: 595
-- Name: TABLE ztsapfi_cca; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_cca TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_cca TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_cca TO sp_suhas;


--
-- TOC entry 7981 (class 0 OID 0)
-- Dependencies: 596
-- Name: TABLE ztsapfi_cca_new; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_cca_new TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_cca_new TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_cca_new TO sp_suhas;


--
-- TOC entry 7982 (class 0 OID 0)
-- Dependencies: 597
-- Name: TABLE ztsapfi_cchierarchy; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_cchierarchy TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_cchierarchy TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_cchierarchy TO sp_suhas;


--
-- TOC entry 7983 (class 0 OID 0)
-- Dependencies: 598
-- Name: TABLE ztsapfi_ccmaster; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_ccmaster TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_ccmaster TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_ccmaster TO sp_suhas;


--
-- TOC entry 7984 (class 0 OID 0)
-- Dependencies: 600
-- Name: TABLE ztsapfi_copa; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_copa TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_copa TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_copa TO sp_suhas;


--
-- TOC entry 7985 (class 0 OID 0)
-- Dependencies: 601
-- Name: TABLE ztsapfi_customer_master; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_customer_master TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_customer_master TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_customer_master TO sp_suhas;


--
-- TOC entry 7986 (class 0 OID 0)
-- Dependencies: 602
-- Name: TABLE ztsapfi_doc_header_text; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_doc_header_text TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_doc_header_text TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_doc_header_text TO sp_suhas;


--
-- TOC entry 7987 (class 0 OID 0)
-- Dependencies: 603
-- Name: TABLE ztsapfi_enddate_filter; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_enddate_filter TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_enddate_filter TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_enddate_filter TO sp_suhas;


--
-- TOC entry 7988 (class 0 OID 0)
-- Dependencies: 604
-- Name: TABLE ztsapfi_gamsd; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_gamsd TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_gamsd TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_gamsd TO sp_suhas;


--
-- TOC entry 7989 (class 0 OID 0)
-- Dependencies: 605
-- Name: TABLE ztsapfi_gamsd_db; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_gamsd_db TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_gamsd_db TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_gamsd_db TO sp_suhas;


--
-- TOC entry 7990 (class 0 OID 0)
-- Dependencies: 606
-- Name: TABLE ztsapfi_gdyup; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_gdyup TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_gdyup TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_gdyup TO sp_suhas;


--
-- TOC entry 7991 (class 0 OID 0)
-- Dependencies: 607
-- Name: TABLE ztsapfi_gibgf; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_gibgf TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_gibgf TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_gibgf TO sp_suhas;


--
-- TOC entry 7992 (class 0 OID 0)
-- Dependencies: 608
-- Name: TABLE ztsapfi_gl; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_gl TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_gl TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_gl TO sp_suhas;


--
-- TOC entry 7993 (class 0 OID 0)
-- Dependencies: 609
-- Name: TABLE ztsapfi_gl_stg_prod; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_gl_stg_prod TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_gl_stg_prod TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_gl_stg_prod TO sp_suhas;


--
-- TOC entry 7994 (class 0 OID 0)
-- Dependencies: 610
-- Name: TABLE ztsapfi_glhierarchy; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_glhierarchy TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_glhierarchy TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_glhierarchy TO sp_suhas;


--
-- TOC entry 7995 (class 0 OID 0)
-- Dependencies: 612
-- Name: TABLE ztsapfi_glhierarchy_staging; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_glhierarchy_staging TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_glhierarchy_staging TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_glhierarchy_staging TO sp_suhas;


--
-- TOC entry 7996 (class 0 OID 0)
-- Dependencies: 613
-- Name: TABLE ztsapfi_glmaster; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_glmaster TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_glmaster TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_glmaster TO sp_suhas;


--
-- TOC entry 7997 (class 0 OID 0)
-- Dependencies: 615
-- Name: TABLE ztsapfi_grfun; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_grfun TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_grfun TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_grfun TO sp_suhas;


--
-- TOC entry 7998 (class 0 OID 0)
-- Dependencies: 616
-- Name: TABLE ztsapfi_gunwn; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_gunwn TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_gunwn TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_gunwn TO sp_suhas;


--
-- TOC entry 7999 (class 0 OID 0)
-- Dependencies: 617
-- Name: TABLE ztsapfi_guswn; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_guswn TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_guswn TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_guswn TO sp_suhas;


--
-- TOC entry 8000 (class 0 OID 0)
-- Dependencies: 618
-- Name: TABLE ztsapfi_gwapp; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_gwapp TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_gwapp TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_gwapp TO sp_suhas;


--
-- TOC entry 8001 (class 0 OID 0)
-- Dependencies: 619
-- Name: TABLE ztsapfi_parameter; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_parameter TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_parameter TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_parameter TO sp_suhas;


--
-- TOC entry 8002 (class 0 OID 0)
-- Dependencies: 620
-- Name: TABLE ztsapfi_pchierarchy; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_pchierarchy TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_pchierarchy TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_pchierarchy TO sp_suhas;


--
-- TOC entry 8003 (class 0 OID 0)
-- Dependencies: 621
-- Name: TABLE ztsapfi_pcmaster; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsapfi_pcmaster TO qlikuser;
GRANT SELECT ON TABLE public.ztsapfi_pcmaster TO consultant01;
GRANT SELECT ON TABLE public.ztsapfi_pcmaster TO sp_suhas;


--
-- TOC entry 8004 (class 0 OID 0)
-- Dependencies: 623
-- Name: TABLE ztsf_empdata; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsf_empdata TO qlikuser;


--
-- TOC entry 8005 (class 0 OID 0)
-- Dependencies: 624
-- Name: TABLE ztsvcs_case; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsvcs_case TO qlikuser;
GRANT SELECT ON TABLE public.ztsvcs_case TO consultant01;


--
-- TOC entry 8006 (class 0 OID 0)
-- Dependencies: 625
-- Name: TABLE ztsvcs_edmsubscription; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsvcs_edmsubscription TO qlikuser;
GRANT SELECT ON TABLE public.ztsvcs_edmsubscription TO consultant01;


--
-- TOC entry 8007 (class 0 OID 0)
-- Dependencies: 626
-- Name: TABLE ztsvcs_review; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsvcs_review TO qlikuser;
GRANT SELECT ON TABLE public.ztsvcs_review TO consultant01;


--
-- TOC entry 8008 (class 0 OID 0)
-- Dependencies: 627
-- Name: TABLE ztsvcs_rootcause; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsvcs_rootcause TO qlikuser;
GRANT SELECT ON TABLE public.ztsvcs_rootcause TO consultant01;


--
-- TOC entry 8009 (class 0 OID 0)
-- Dependencies: 628
-- Name: TABLE ztsvcs_sms; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztsvcs_sms TO qlikuser;
GRANT SELECT ON TABLE public.ztsvcs_sms TO consultant01;


--
-- TOC entry 8010 (class 0 OID 0)
-- Dependencies: 629
-- Name: TABLE ztubt_4d_placedbettransactionlineitem; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_4d_placedbettransactionlineitem TO qlikuser;
GRANT ALL ON TABLE public.ztubt_4d_placedbettransactionlineitem TO sp_postgres;


--
-- TOC entry 8011 (class 0 OID 0)
-- Dependencies: 630
-- Name: TABLE ztubt_4d_placedbettransactionlineitemnumber; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ztubt_4d_placedbettransactionlineitemnumber TO qlikuser;
GRANT ALL ON TABLE public.ztubt_4d_placedbettransactionlineitemnumber TO postgres;
GRANT SELECT ON TABLE public.ztubt_4d_placedbettransactionlineitemnumber TO consultant01;


--
-- TOC entry 8012 (class 0 OID 0)
-- Dependencies: 631
-- Name: TABLE ztubt_adhoctimeconfig; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_adhoctimeconfig TO qlikuser;
GRANT ALL ON TABLE public.ztubt_adhoctimeconfig TO sp_postgres;


--
-- TOC entry 8013 (class 0 OID 0)
-- Dependencies: 632
-- Name: TABLE ztubt_adhoctimehistory; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT ALL ON TABLE public.ztubt_adhoctimehistory TO consultant01;


--
-- TOC entry 8014 (class 0 OID 0)
-- Dependencies: 633
-- Name: TABLE ztubt_adjustinvoice; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_adjustinvoice TO qlikuser;
GRANT ALL ON TABLE public.ztubt_adjustinvoice TO sp_postgres;


--
-- TOC entry 8015 (class 0 OID 0)
-- Dependencies: 634
-- Name: TABLE ztubt_admissionvouchertransaction; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_admissionvouchertransaction TO qlikuser;
GRANT ALL ON TABLE public.ztubt_admissionvouchertransaction TO sp_postgres;


--
-- TOC entry 8016 (class 0 OID 0)
-- Dependencies: 635
-- Name: TABLE ztubt_cancelledbetticket; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_cancelledbetticket TO qlikuser;
GRANT ALL ON TABLE public.ztubt_cancelledbetticket TO sp_postgres;


--
-- TOC entry 8017 (class 0 OID 0)
-- Dependencies: 636
-- Name: TABLE ztubt_cancelledbetticketlifecyclestate; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_cancelledbetticketlifecyclestate TO sp_postgres;
GRANT SELECT ON TABLE public.ztubt_cancelledbetticketlifecyclestate TO qlikuser;


--
-- TOC entry 8018 (class 0 OID 0)
-- Dependencies: 637
-- Name: TABLE ztubt_cart; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_cart TO qlikuser;
GRANT ALL ON TABLE public.ztubt_cart TO sp_postgres;


--
-- TOC entry 8019 (class 0 OID 0)
-- Dependencies: 638
-- Name: TABLE ztubt_chain; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_chain TO qlikuser;
GRANT ALL ON TABLE public.ztubt_chain TO sp_postgres;


--
-- TOC entry 8020 (class 0 OID 0)
-- Dependencies: 639
-- Name: TABLE ztubt_charitytickettransaction; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_charitytickettransaction TO qlikuser;
GRANT ALL ON TABLE public.ztubt_charitytickettransaction TO sp_postgres;


--
-- TOC entry 8021 (class 0 OID 0)
-- Dependencies: 640
-- Name: TABLE ztubt_drawdates; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_drawdates TO qlikuser;
GRANT ALL ON TABLE public.ztubt_drawdates TO sp_postgres;


--
-- TOC entry 8022 (class 0 OID 0)
-- Dependencies: 641
-- Name: TABLE ztubt_drawdates_master; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_drawdates_master TO qlikuser;
GRANT ALL ON TABLE public.ztubt_drawdates_master TO sp_postgres;


--
-- TOC entry 8023 (class 0 OID 0)
-- Dependencies: 929
-- Name: TABLE ztubt_drawdates_new; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztubt_drawdates_new TO consultant01;
GRANT SELECT ON TABLE public.ztubt_drawdates_new TO qlikuser;
GRANT SELECT ON TABLE public.ztubt_drawdates_new TO svcalation;


--
-- TOC entry 8024 (class 0 OID 0)
-- Dependencies: 642
-- Name: TABLE ztubt_entrymethod; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_entrymethod TO sp_postgres;
GRANT SELECT ON TABLE public.ztubt_entrymethod TO qlikuser;


--
-- TOC entry 8025 (class 0 OID 0)
-- Dependencies: 643
-- Name: TABLE ztubt_etl_recon; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_etl_recon TO sp_postgres;


--
-- TOC entry 8026 (class 0 OID 0)
-- Dependencies: 644
-- Name: TABLE ztubt_funding; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_funding TO qlikuser;
GRANT ALL ON TABLE public.ztubt_funding TO sp_postgres;


--
-- TOC entry 8027 (class 0 OID 0)
-- Dependencies: 645
-- Name: TABLE ztubt_getbusinessdate_perhost; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_getbusinessdate_perhost TO qlikuser;
GRANT ALL ON TABLE public.ztubt_getbusinessdate_perhost TO sp_postgres;


--
-- TOC entry 8028 (class 0 OID 0)
-- Dependencies: 1013
-- Name: TABLE ztubt_getbusinessdate_perhost_test; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztubt_getbusinessdate_perhost_test TO qlikuser;


--
-- TOC entry 8029 (class 0 OID 0)
-- Dependencies: 646
-- Name: TABLE ztubt_getcfsumreport; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_getcfsumreport TO qlikuser;
GRANT ALL ON TABLE public.ztubt_getcfsumreport TO sp_postgres;


--
-- TOC entry 8030 (class 0 OID 0)
-- Dependencies: 648
-- Name: TABLE ztubt_gstconfig; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_gstconfig TO sp_postgres;
GRANT SELECT ON TABLE public.ztubt_gstconfig TO qlikuser;


--
-- TOC entry 8031 (class 0 OID 0)
-- Dependencies: 649
-- Name: TABLE ztubt_horse_placedbettransactionlineitem; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_horse_placedbettransactionlineitem TO qlikuser;
GRANT ALL ON TABLE public.ztubt_horse_placedbettransactionlineitem TO sp_postgres;


--
-- TOC entry 8032 (class 0 OID 0)
-- Dependencies: 650
-- Name: TABLE ztubt_invoiceperiod; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_invoiceperiod TO qlikuser;
GRANT ALL ON TABLE public.ztubt_invoiceperiod TO sp_postgres;


--
-- TOC entry 8033 (class 0 OID 0)
-- Dependencies: 651
-- Name: TABLE ztubt_load_config; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_load_config TO qlikuser;
GRANT ALL ON TABLE public.ztubt_load_config TO sp_postgres;


--
-- TOC entry 8034 (class 0 OID 0)
-- Dependencies: 652
-- Name: TABLE ztubt_location; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_location TO qlikuser;
GRANT ALL ON TABLE public.ztubt_location TO sp_postgres;


--
-- TOC entry 8035 (class 0 OID 0)
-- Dependencies: 653
-- Name: TABLE ztubt_locationgsthistory; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_locationgsthistory TO qlikuser;
GRANT ALL ON TABLE public.ztubt_locationgsthistory TO sp_postgres;


--
-- TOC entry 8036 (class 0 OID 0)
-- Dependencies: 654
-- Name: TABLE ztubt_locationstatuschange; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_locationstatuschange TO qlikuser;
GRANT ALL ON TABLE public.ztubt_locationstatuschange TO sp_postgres;


--
-- TOC entry 8037 (class 0 OID 0)
-- Dependencies: 655
-- Name: TABLE ztubt_locbusinesscode; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_locbusinesscode TO sp_postgres;
GRANT SELECT ON TABLE public.ztubt_locbusinesscode TO qlikuser;


--
-- TOC entry 8038 (class 0 OID 0)
-- Dependencies: 656
-- Name: TABLE ztubt_loctype; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_loctype TO sp_postgres;


--
-- TOC entry 8039 (class 0 OID 0)
-- Dependencies: 657
-- Name: TABLE ztubt_lookupvalueconfig; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_lookupvalueconfig TO qlikuser;
GRANT ALL ON TABLE public.ztubt_lookupvalueconfig TO sp_postgres;


--
-- TOC entry 8040 (class 0 OID 0)
-- Dependencies: 658
-- Name: TABLE ztubt_offlineproductheader; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_offlineproductheader TO qlikuser;
GRANT ALL ON TABLE public.ztubt_offlineproductheader TO sp_postgres;


--
-- TOC entry 8041 (class 0 OID 0)
-- Dependencies: 659
-- Name: TABLE ztubt_operatinghours; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_operatinghours TO qlikuser;
GRANT ALL ON TABLE public.ztubt_operatinghours TO sp_postgres;


--
-- TOC entry 8042 (class 0 OID 0)
-- Dependencies: 660
-- Name: TABLE ztubt_paymentdetail; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_paymentdetail TO qlikuser;
GRANT ALL ON TABLE public.ztubt_paymentdetail TO sp_postgres;


--
-- TOC entry 8043 (class 0 OID 0)
-- Dependencies: 870
-- Name: TABLE ztubt_paynowtransaction; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.ztubt_paynowtransaction TO consultant01;


--
-- TOC entry 8044 (class 0 OID 0)
-- Dependencies: 662
-- Name: TABLE ztubt_placedbettransactionheader; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_placedbettransactionheader TO qlikuser;
GRANT ALL ON TABLE public.ztubt_placedbettransactionheader TO sp_postgres;


--
-- TOC entry 8045 (class 0 OID 0)
-- Dependencies: 663
-- Name: TABLE ztubt_placedbettransactionheaderlifecyclestate; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_placedbettransactionheaderlifecyclestate TO sp_postgres;


--
-- TOC entry 8046 (class 0 OID 0)
-- Dependencies: 664
-- Name: TABLE ztubt_product; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_product TO qlikuser;
GRANT ALL ON TABLE public.ztubt_product TO sp_postgres;


--
-- TOC entry 8047 (class 0 OID 0)
-- Dependencies: 665
-- Name: TABLE ztubt_recovery; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_recovery TO qlikuser;
GRANT ALL ON TABLE public.ztubt_recovery TO sp_postgres;


--
-- TOC entry 8048 (class 0 OID 0)
-- Dependencies: 666
-- Name: TABLE ztubt_retailer; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_retailer TO qlikuser;
GRANT ALL ON TABLE public.ztubt_retailer TO sp_postgres;


--
-- TOC entry 8049 (class 0 OID 0)
-- Dependencies: 667
-- Name: TABLE ztubt_salescomconfig; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_salescomconfig TO qlikuser;
GRANT ALL ON TABLE public.ztubt_salescomconfig TO sp_postgres;


--
-- TOC entry 8050 (class 0 OID 0)
-- Dependencies: 668
-- Name: TABLE ztubt_sap_product; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_sap_product TO sp_postgres;


--
-- TOC entry 8051 (class 0 OID 0)
-- Dependencies: 669
-- Name: TABLE ztubt_session; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_session TO qlikuser;
GRANT ALL ON TABLE public.ztubt_session TO sp_postgres;


--
-- TOC entry 8052 (class 0 OID 0)
-- Dependencies: 670
-- Name: TABLE ztubt_spatransaction; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_spatransaction TO qlikuser;
GRANT ALL ON TABLE public.ztubt_spatransaction TO sp_postgres;


--
-- TOC entry 8053 (class 0 OID 0)
-- Dependencies: 671
-- Name: TABLE ztubt_sportcategory; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_sportcategory TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sportcategory TO sp_postgres;


--
-- TOC entry 8054 (class 0 OID 0)
-- Dependencies: 672
-- Name: TABLE ztubt_sportclass; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_sportclass TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sportclass TO sp_postgres;


--
-- TOC entry 8055 (class 0 OID 0)
-- Dependencies: 673
-- Name: TABLE ztubt_sportevent; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_sportevent TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sportevent TO sp_postgres;


--
-- TOC entry 8056 (class 0 OID 0)
-- Dependencies: 674
-- Name: TABLE ztubt_sportleagueinfo; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_sportleagueinfo TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sportleagueinfo TO sp_postgres;


--
-- TOC entry 8057 (class 0 OID 0)
-- Dependencies: 675
-- Name: TABLE ztubt_sports_placedbettransactionlineitem; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_sports_placedbettransactionlineitem TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sports_placedbettransactionlineitem TO sp_postgres;


--
-- TOC entry 8058 (class 0 OID 0)
-- Dependencies: 676
-- Name: TABLE ztubt_sports_placedbettransactionlineitemnumber; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_sports_placedbettransactionlineitemnumber TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sports_placedbettransactionlineitemnumber TO sp_postgres;


--
-- TOC entry 8059 (class 0 OID 0)
-- Dependencies: 677
-- Name: TABLE ztubt_sporttype; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_sporttype TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sporttype TO sp_postgres;


--
-- TOC entry 8060 (class 0 OID 0)
-- Dependencies: 678
-- Name: TABLE ztubt_superchain; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_superchain TO qlikuser;
GRANT ALL ON TABLE public.ztubt_superchain TO sp_postgres;


--
-- TOC entry 8061 (class 0 OID 0)
-- Dependencies: 679
-- Name: TABLE ztubt_sweep_placedbettransactionlineitem; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_sweep_placedbettransactionlineitem TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sweep_placedbettransactionlineitem TO sp_postgres;


--
-- TOC entry 8062 (class 0 OID 0)
-- Dependencies: 680
-- Name: TABLE ztubt_sweep_placedbettransactionlineitemnumber; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_sweep_placedbettransactionlineitemnumber TO qlikuser;
GRANT ALL ON TABLE public.ztubt_sweep_placedbettransactionlineitemnumber TO sp_postgres;


--
-- TOC entry 8063 (class 0 OID 0)
-- Dependencies: 681
-- Name: TABLE ztubt_table_interval_load_config; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_table_interval_load_config TO qlikuser;
GRANT ALL ON TABLE public.ztubt_table_interval_load_config TO sp_postgres;


--
-- TOC entry 8064 (class 0 OID 0)
-- Dependencies: 683
-- Name: TABLE ztubt_temp_placedbettransactionheader; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_temp_placedbettransactionheader TO sp_postgres;


--
-- TOC entry 8065 (class 0 OID 0)
-- Dependencies: 684
-- Name: TABLE ztubt_terminal; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_terminal TO sp_postgres;
GRANT SELECT ON TABLE public.ztubt_terminal TO qlikuser;


--
-- TOC entry 8066 (class 0 OID 0)
-- Dependencies: 686
-- Name: TABLE ztubt_test_placedbettransactionheader_del; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_test_placedbettransactionheader_del TO sp_postgres;


--
-- TOC entry 8067 (class 0 OID 0)
-- Dependencies: 687
-- Name: TABLE ztubt_topupcardtransaction; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_topupcardtransaction TO qlikuser;
GRANT ALL ON TABLE public.ztubt_topupcardtransaction TO sp_postgres;


--
-- TOC entry 8068 (class 0 OID 0)
-- Dependencies: 690
-- Name: TABLE ztubt_toto_placedbettransactionlineitem; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_toto_placedbettransactionlineitem TO qlikuser;
GRANT ALL ON TABLE public.ztubt_toto_placedbettransactionlineitem TO sp_postgres;


--
-- TOC entry 8069 (class 0 OID 0)
-- Dependencies: 691
-- Name: TABLE ztubt_toto_placedbettransactionlineitemnumber; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_toto_placedbettransactionlineitemnumber TO qlikuser;
GRANT ALL ON TABLE public.ztubt_toto_placedbettransactionlineitemnumber TO sp_postgres;


--
-- TOC entry 8070 (class 0 OID 0)
-- Dependencies: 692
-- Name: TABLE ztubt_totohongbaotransaction; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_totohongbaotransaction TO qlikuser;
GRANT ALL ON TABLE public.ztubt_totohongbaotransaction TO sp_postgres;


--
-- TOC entry 8071 (class 0 OID 0)
-- Dependencies: 693
-- Name: TABLE ztubt_user; Type: ACL; Schema: public; Owner: consultant01
--

GRANT SELECT ON TABLE public.ztubt_user TO qlikuser;
GRANT ALL ON TABLE public.ztubt_user TO sp_postgres;


--
-- TOC entry 8072 (class 0 OID 0)
-- Dependencies: 694
-- Name: TABLE ztubt_validatedbetticket; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_validatedbetticket TO qlikuser;
GRANT ALL ON TABLE public.ztubt_validatedbetticket TO sp_postgres;


--
-- TOC entry 8073 (class 0 OID 0)
-- Dependencies: 697
-- Name: TABLE ztubt_validatedbetticketlifecyclestate; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_validatedbetticketlifecyclestate TO qlikuser;
GRANT ALL ON TABLE public.ztubt_validatedbetticketlifecyclestate TO sp_postgres;


--
-- TOC entry 8074 (class 0 OID 0)
-- Dependencies: 698
-- Name: TABLE ztubt_validationtype; Type: ACL; Schema: public; Owner: consultant01
--

GRANT ALL ON TABLE public.ztubt_validationtype TO qlikuser;
GRANT ALL ON TABLE public.ztubt_validationtype TO sp_postgres;


--
-- TOC entry 8075 (class 0 OID 0)
-- Dependencies: 944
-- Name: TABLE zvalation_postgres_log; Type: ACL; Schema: public; Owner: postgres
--

GRANT SELECT ON TABLE public.zvalation_postgres_log TO svcalation;


--
-- TOC entry 8076 (class 0 OID 0)
-- Dependencies: 967
-- Name: TABLE zvalation_postgres_log_test; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvalation_postgres_log_test TO svcalation;


--
-- TOC entry 8077 (class 0 OID 0)
-- Dependencies: 699
-- Name: TABLE zves_bigsmall_winpayables; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_bigsmall_winpayables TO qlikuser;
GRANT SELECT ON TABLE public.zves_bigsmall_winpayables TO sp_suhas;


--
-- TOC entry 8078 (class 0 OID 0)
-- Dependencies: 700
-- Name: TABLE zves_findata_draw_bak; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_findata_draw_bak TO qlikuser;
GRANT SELECT ON TABLE public.zves_findata_draw_bak TO consultant01;
GRANT SELECT ON TABLE public.zves_findata_draw_bak TO sp_suhas;


--
-- TOC entry 8079 (class 0 OID 0)
-- Dependencies: 830
-- Name: TABLE zves_findata_draw_bkpob; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_findata_draw_bkpob TO sp_suhas;
GRANT SELECT ON TABLE public.zves_findata_draw_bkpob TO qlikuser;
GRANT SELECT ON TABLE public.zves_findata_draw_bkpob TO consultant01;


--
-- TOC entry 8080 (class 0 OID 0)
-- Dependencies: 701
-- Name: TABLE zves_findata_draw_digibc; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_findata_draw_digibc TO qlikuser;
GRANT SELECT ON TABLE public.zves_findata_draw_digibc TO consultant01;
GRANT SELECT ON TABLE public.zves_findata_draw_digibc TO sp_suhas;


--
-- TOC entry 8081 (class 0 OID 0)
-- Dependencies: 702
-- Name: TABLE zves_findata_draw_recon; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_findata_draw_recon TO qlikuser;
GRANT SELECT ON TABLE public.zves_findata_draw_recon TO consultant01;


--
-- TOC entry 8082 (class 0 OID 0)
-- Dependencies: 703
-- Name: TABLE zves_findata_draw_recon_host; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_findata_draw_recon_host TO qlikuser;
GRANT SELECT ON TABLE public.zves_findata_draw_recon_host TO consultant01;


--
-- TOC entry 8083 (class 0 OID 0)
-- Dependencies: 704
-- Name: TABLE zves_mjf_valid; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_mjf_valid TO qlikuser;
GRANT SELECT ON TABLE public.zves_mjf_valid TO consultant01;
GRANT SELECT ON TABLE public.zves_mjf_valid TO sp_suhas;


--
-- TOC entry 8084 (class 0 OID 0)
-- Dependencies: 705
-- Name: TABLE zves_mjf_wagcan; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_mjf_wagcan TO qlikuser;
GRANT SELECT ON TABLE public.zves_mjf_wagcan TO consultant01;
GRANT SELECT ON TABLE public.zves_mjf_wagcan TO sp_suhas;


--
-- TOC entry 8085 (class 0 OID 0)
-- Dependencies: 706
-- Name: TABLE zves_mjf_wagcan_digibc; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_mjf_wagcan_digibc TO qlikuser;
GRANT SELECT ON TABLE public.zves_mjf_wagcan_digibc TO consultant01;
GRANT SELECT ON TABLE public.zves_mjf_wagcan_digibc TO sp_suhas;


--
-- TOC entry 8086 (class 0 OID 0)
-- Dependencies: 707
-- Name: TABLE zves_mjf_wagcan_es; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_mjf_wagcan_es TO qlikuser;


--
-- TOC entry 8087 (class 0 OID 0)
-- Dependencies: 708
-- Name: TABLE zves_ret_signonoff; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zves_ret_signonoff TO qlikuser;
GRANT SELECT ON TABLE public.zves_ret_signonoff TO consultant01;
GRANT SELECT ON TABLE public.zves_ret_signonoff TO sp_suhas;


--
-- TOC entry 8088 (class 0 OID 0)
-- Dependencies: 709
-- Name: TABLE zvkyc_branch; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_branch TO qlikuser;


--
-- TOC entry 8089 (class 0 OID 0)
-- Dependencies: 710
-- Name: TABLE zvkyc_branch_masked; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_branch_masked TO qlikuser;


--
-- TOC entry 8090 (class 0 OID 0)
-- Dependencies: 711
-- Name: TABLE zvkyc_calldurationhistory; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_calldurationhistory TO qlikuser;


--
-- TOC entry 8091 (class 0 OID 0)
-- Dependencies: 712
-- Name: TABLE zvkyc_calldurationhistory_masked; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_calldurationhistory_masked TO qlikuser;


--
-- TOC entry 8092 (class 0 OID 0)
-- Dependencies: 713
-- Name: TABLE zvkyc_checker; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_checker TO qlikuser;


--
-- TOC entry 8093 (class 0 OID 0)
-- Dependencies: 714
-- Name: TABLE zvkyc_checker_masked; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_checker_masked TO qlikuser;


--
-- TOC entry 8094 (class 0 OID 0)
-- Dependencies: 715
-- Name: TABLE zvkyc_kyclocation; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_kyclocation TO qlikuser;


--
-- TOC entry 8095 (class 0 OID 0)
-- Dependencies: 716
-- Name: TABLE zvkyc_maker; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_maker TO qlikuser;


--
-- TOC entry 8096 (class 0 OID 0)
-- Dependencies: 717
-- Name: TABLE zvkyc_maker_masked; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvkyc_maker_masked TO qlikuser;


--
-- TOC entry 8097 (class 0 OID 0)
-- Dependencies: 718
-- Name: TABLE zvob_customer_activation_date; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_customer_activation_date TO qlikuser;
GRANT SELECT ON TABLE public.zvob_customer_activation_date TO sp_suhas;


--
-- TOC entry 8098 (class 0 OID 0)
-- Dependencies: 719
-- Name: TABLE zvob_customerbackgroundinfo; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_customerbackgroundinfo TO qlikuser;
GRANT SELECT ON TABLE public.zvob_customerbackgroundinfo TO kpmgconsultant01;


--
-- TOC entry 8099 (class 0 OID 0)
-- Dependencies: 720
-- Name: TABLE zvob_lottery_active_bet; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_lottery_active_bet TO qlikuser;
GRANT SELECT ON TABLE public.zvob_lottery_active_bet TO sp_suhas;


--
-- TOC entry 8100 (class 0 OID 0)
-- Dependencies: 721
-- Name: TABLE zvob_lottery_cancel_bet; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_lottery_cancel_bet TO qlikuser;
GRANT SELECT ON TABLE public.zvob_lottery_cancel_bet TO sp_suhas;


--
-- TOC entry 8101 (class 0 OID 0)
-- Dependencies: 722
-- Name: TABLE zvob_lottery_monthly_bettype_cancel; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_lottery_monthly_bettype_cancel TO qlikuser;
GRANT SELECT ON TABLE public.zvob_lottery_monthly_bettype_cancel TO sp_suhas;


--
-- TOC entry 8102 (class 0 OID 0)
-- Dependencies: 723
-- Name: TABLE zvob_lottery_monthly_bettype_wager; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_lottery_monthly_bettype_wager TO qlikuser;
GRANT SELECT ON TABLE public.zvob_lottery_monthly_bettype_wager TO sp_suhas;


--
-- TOC entry 8103 (class 0 OID 0)
-- Dependencies: 724
-- Name: TABLE zvob_lottery_monthlyrpt_cancel; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_lottery_monthlyrpt_cancel TO qlikuser;
GRANT SELECT ON TABLE public.zvob_lottery_monthlyrpt_cancel TO sp_suhas;


--
-- TOC entry 8104 (class 0 OID 0)
-- Dependencies: 725
-- Name: TABLE zvob_lottery_monthlyrpt_valid; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_lottery_monthlyrpt_valid TO qlikuser;
GRANT SELECT ON TABLE public.zvob_lottery_monthlyrpt_valid TO sp_suhas;


--
-- TOC entry 8105 (class 0 OID 0)
-- Dependencies: 726
-- Name: TABLE zvob_lottery_monthlyrpt_wager; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_lottery_monthlyrpt_wager TO qlikuser;
GRANT SELECT ON TABLE public.zvob_lottery_monthlyrpt_wager TO sp_suhas;


--
-- TOC entry 8106 (class 0 OID 0)
-- Dependencies: 727
-- Name: TABLE zvob_lottery_valid_bet; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_lottery_valid_bet TO qlikuser;
GRANT SELECT ON TABLE public.zvob_lottery_valid_bet TO sp_suhas;


--
-- TOC entry 8107 (class 0 OID 0)
-- Dependencies: 728
-- Name: TABLE zvob_sports_active_bet; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_active_bet TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_active_bet TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_active_bet TO sp_suhas;


--
-- TOC entry 8108 (class 0 OID 0)
-- Dependencies: 729
-- Name: TABLE zvob_sports_cancel; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_cancel TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_cancel TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_cancel TO sp_suhas;


--
-- TOC entry 8109 (class 0 OID 0)
-- Dependencies: 730
-- Name: TABLE zvob_sports_cancel_bet; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_cancel_bet TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_cancel_bet TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_cancel_bet TO sp_suhas;


--
-- TOC entry 8110 (class 0 OID 0)
-- Dependencies: 731
-- Name: TABLE zvob_sports_liab; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_liab TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_liab TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_liab TO sp_suhas;


--
-- TOC entry 8111 (class 0 OID 0)
-- Dependencies: 732
-- Name: TABLE zvob_sports_monthly_bettype_cancel; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_monthly_bettype_cancel TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_monthly_bettype_cancel TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_monthly_bettype_cancel TO sp_suhas;


--
-- TOC entry 8112 (class 0 OID 0)
-- Dependencies: 733
-- Name: TABLE zvob_sports_monthly_bettype_wager; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_monthly_bettype_wager TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_monthly_bettype_wager TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_monthly_bettype_wager TO sp_suhas;


--
-- TOC entry 8113 (class 0 OID 0)
-- Dependencies: 734
-- Name: TABLE zvob_sports_monthlyrpt_cancel; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_cancel TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_cancel TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_cancel TO sp_suhas;


--
-- TOC entry 8114 (class 0 OID 0)
-- Dependencies: 735
-- Name: TABLE zvob_sports_monthlyrpt_valid; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_valid TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_valid TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_valid TO sp_suhas;


--
-- TOC entry 8115 (class 0 OID 0)
-- Dependencies: 736
-- Name: TABLE zvob_sports_monthlyrpt_wager; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_wager TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_wager TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_monthlyrpt_wager TO sp_suhas;


--
-- TOC entry 8116 (class 0 OID 0)
-- Dependencies: 737
-- Name: TABLE zvob_sports_r40; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_r40 TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_r40 TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_r40 TO sp_suhas;


--
-- TOC entry 8117 (class 0 OID 0)
-- Dependencies: 738
-- Name: TABLE zvob_sports_r40_retail; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_r40_retail TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_r40_retail TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_r40_retail TO sp_suhas;


--
-- TOC entry 8118 (class 0 OID 0)
-- Dependencies: 739
-- Name: TABLE zvob_sports_settled; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_settled TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_settled TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_settled TO sp_suhas;


--
-- TOC entry 8119 (class 0 OID 0)
-- Dependencies: 740
-- Name: TABLE zvob_sports_valid; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_valid TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_valid TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_valid TO sp_suhas;


--
-- TOC entry 8120 (class 0 OID 0)
-- Dependencies: 741
-- Name: TABLE zvob_sports_valid_bet; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_valid_bet TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_valid_bet TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_valid_bet TO sp_suhas;


--
-- TOC entry 8121 (class 0 OID 0)
-- Dependencies: 742
-- Name: TABLE zvob_sports_voidpaid_bet; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_voidpaid_bet TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_voidpaid_bet TO sp_suhas;


--
-- TOC entry 8122 (class 0 OID 0)
-- Dependencies: 743
-- Name: TABLE zvob_sports_wager; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvob_sports_wager TO qlikuser;
GRANT SELECT ON TABLE public.zvob_sports_wager TO consultant01;
GRANT SELECT ON TABLE public.zvob_sports_wager TO sp_suhas;


--
-- TOC entry 8123 (class 0 OID 0)
-- Dependencies: 744
-- Name: TABLE zvrtms_trans_sports_entry; Type: ACL; Schema: public; Owner: sp_postgres
--

GRANT SELECT ON TABLE public.zvrtms_trans_sports_entry TO qlikuser;


--
-- TOC entry 8126 (class 0 OID 0)
-- Dependencies: 746
-- Name: TABLE dim_account; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_account TO qlikuser;
GRANT SELECT ON TABLE qlik.dim_account TO sp_suhas;


--
-- TOC entry 8127 (class 0 OID 0)
-- Dependencies: 747
-- Name: TABLE dim_account_2021_may_27; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_account_2021_may_27 TO qlikuser;


--
-- TOC entry 8128 (class 0 OID 0)
-- Dependencies: 748
-- Name: TABLE dim_account_bckup; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_account_bckup TO qlikuser;


--
-- TOC entry 8129 (class 0 OID 0)
-- Dependencies: 750
-- Name: TABLE dim_account_tmp; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_account_tmp TO qlikuser;
GRANT SELECT ON TABLE qlik.dim_account_tmp TO sp_suhas;


--
-- TOC entry 8130 (class 0 OID 0)
-- Dependencies: 751
-- Name: TABLE dim_attribute; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_attribute TO qlikuser;
GRANT SELECT ON TABLE qlik.dim_attribute TO sp_suhas;


--
-- TOC entry 8131 (class 0 OID 0)
-- Dependencies: 752
-- Name: TABLE dim_attribute_bckup; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_attribute_bckup TO qlikuser;


--
-- TOC entry 8132 (class 0 OID 0)
-- Dependencies: 753
-- Name: TABLE dim_customer; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_customer TO qlikuser;
GRANT SELECT ON TABLE qlik.dim_customer TO sp_suhas;


--
-- TOC entry 8133 (class 0 OID 0)
-- Dependencies: 754
-- Name: TABLE dim_employee; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.dim_employee TO qlikuser;


--
-- TOC entry 8134 (class 0 OID 0)
-- Dependencies: 755
-- Name: TABLE dim_entity; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_entity TO qlikuser;
GRANT SELECT ON TABLE qlik.dim_entity TO sp_suhas;


--
-- TOC entry 8135 (class 0 OID 0)
-- Dependencies: 756
-- Name: TABLE dim_entity_2021_may_27; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_entity_2021_may_27 TO qlikuser;


--
-- TOC entry 8136 (class 0 OID 0)
-- Dependencies: 757
-- Name: TABLE dim_entity_bckup; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_entity_bckup TO qlikuser;


--
-- TOC entry 8137 (class 0 OID 0)
-- Dependencies: 758
-- Name: TABLE dim_period; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_period TO qlikuser;
GRANT SELECT ON TABLE qlik.dim_period TO sp_suhas;


--
-- TOC entry 8138 (class 0 OID 0)
-- Dependencies: 759
-- Name: TABLE dim_product; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_product TO qlikuser;
GRANT SELECT ON TABLE qlik.dim_product TO sp_suhas;


--
-- TOC entry 8139 (class 0 OID 0)
-- Dependencies: 760
-- Name: TABLE dim_product_bckup; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.dim_product_bckup TO qlikuser;


--
-- TOC entry 8140 (class 0 OID 0)
-- Dependencies: 761
-- Name: TABLE dim_toto_draw_type; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.dim_toto_draw_type TO qlikuser;


--
-- TOC entry 8141 (class 0 OID 0)
-- Dependencies: 762
-- Name: TABLE fact_bt; Type: ACL; Schema: qlik; Owner: postgres
--

GRANT SELECT ON TABLE qlik.fact_bt TO qlikuser;


--
-- TOC entry 8142 (class 0 OID 0)
-- Dependencies: 763
-- Name: TABLE fact_customer; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_customer TO qlikuser;


--
-- TOC entry 8143 (class 0 OID 0)
-- Dependencies: 764
-- Name: TABLE fact_daily_collection; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_daily_collection TO qlikuser;


--
-- TOC entry 8144 (class 0 OID 0)
-- Dependencies: 766
-- Name: TABLE fact_daily_collection_tmp; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_daily_collection_tmp TO qlikuser;


--
-- TOC entry 8145 (class 0 OID 0)
-- Dependencies: 767
-- Name: TABLE fact_gl_balance; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_gl_balance TO qlikuser;
GRANT SELECT ON TABLE qlik.fact_gl_balance TO sp_suhas;


--
-- TOC entry 8146 (class 0 OID 0)
-- Dependencies: 768
-- Name: TABLE fact_gl_balance_090421; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_gl_balance_090421 TO qlikuser;


--
-- TOC entry 8147 (class 0 OID 0)
-- Dependencies: 769
-- Name: TABLE fact_gl_balance_150221; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_gl_balance_150221 TO qlikuser;


--
-- TOC entry 8148 (class 0 OID 0)
-- Dependencies: 770
-- Name: TABLE fact_gl_balance_temp; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_gl_balance_temp TO qlikuser;


--
-- TOC entry 8149 (class 0 OID 0)
-- Dependencies: 771
-- Name: TABLE fact_pnc; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.fact_pnc TO qlikuser;


--
-- TOC entry 8150 (class 0 OID 0)
-- Dependencies: 772
-- Name: TABLE fact_product; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.fact_product TO qlikuser;


--
-- TOC entry 8151 (class 0 OID 0)
-- Dependencies: 773
-- Name: TABLE fact_product_2021_may_27; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_product_2021_may_27 TO qlikuser;


--
-- TOC entry 8152 (class 0 OID 0)
-- Dependencies: 774
-- Name: TABLE fact_rnc; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.fact_rnc TO qlikuser;


--
-- TOC entry 8153 (class 0 OID 0)
-- Dependencies: 775
-- Name: TABLE fact_royalty_historical_data; Type: ACL; Schema: qlik; Owner: postgres
--

GRANT SELECT ON TABLE qlik.fact_royalty_historical_data TO qlikuser;


--
-- TOC entry 8154 (class 0 OID 0)
-- Dependencies: 776
-- Name: TABLE hist_fact_gl_balance; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.hist_fact_gl_balance TO sp_suhas;
GRANT ALL ON TABLE qlik.hist_fact_gl_balance TO qlikuser;


--
-- TOC entry 8155 (class 0 OID 0)
-- Dependencies: 777
-- Name: TABLE hr_betting_account_info; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.hr_betting_account_info TO qlikuser;
GRANT SELECT ON TABLE qlik.hr_betting_account_info TO consultant01;


--
-- TOC entry 8156 (class 0 OID 0)
-- Dependencies: 778
-- Name: TABLE lkp_clubmeeting; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.lkp_clubmeeting TO qlikuser;
GRANT SELECT ON TABLE qlik.lkp_clubmeeting TO sp_suhas;


--
-- TOC entry 8157 (class 0 OID 0)
-- Dependencies: 779
-- Name: TABLE lkp_dept_div_mapping; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.lkp_dept_div_mapping TO sp_suhas;
GRANT ALL ON TABLE qlik.lkp_dept_div_mapping TO qlikuser;


--
-- TOC entry 8158 (class 0 OID 0)
-- Dependencies: 780
-- Name: TABLE lkp_locationgrouping; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.lkp_locationgrouping TO qlikuser;


--
-- TOC entry 8159 (class 0 OID 0)
-- Dependencies: 781
-- Name: TABLE lkp_pc_atttribute; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.lkp_pc_atttribute TO qlikuser;
GRANT SELECT ON TABLE qlik.lkp_pc_atttribute TO sp_suhas;


--
-- TOC entry 8160 (class 0 OID 0)
-- Dependencies: 782
-- Name: TABLE lkp_pc_atttribute1; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.lkp_pc_atttribute1 TO qlikuser;
GRANT SELECT ON TABLE qlik.lkp_pc_atttribute1 TO sp_suhas;


--
-- TOC entry 8161 (class 0 OID 0)
-- Dependencies: 783
-- Name: TABLE lkp_retail_branch_zonegrouping; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.lkp_retail_branch_zonegrouping TO sp_suhas;
GRANT ALL ON TABLE qlik.lkp_retail_branch_zonegrouping TO qlikuser;


--
-- TOC entry 8162 (class 0 OID 0)
-- Dependencies: 784
-- Name: TABLE lkp_subsume; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.lkp_subsume TO qlikuser;


--
-- TOC entry 8163 (class 0 OID 0)
-- Dependencies: 785
-- Name: TABLE ref_dim_entity; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.ref_dim_entity TO qlikuser;


--
-- TOC entry 8164 (class 0 OID 0)
-- Dependencies: 787
-- Name: TABLE stg_active_spa_customer; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.stg_active_spa_customer TO qlikuser;


--
-- TOC entry 8165 (class 0 OID 0)
-- Dependencies: 788
-- Name: TABLE stg_channel; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.stg_channel TO qlikuser;


--
-- TOC entry 8166 (class 0 OID 0)
-- Dependencies: 789
-- Name: TABLE stg_customer_kpi; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.stg_customer_kpi TO qlikuser;


--
-- TOC entry 8167 (class 0 OID 0)
-- Dependencies: 790
-- Name: TABLE stg_employee; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.stg_employee TO qlikuser;


--
-- TOC entry 8168 (class 0 OID 0)
-- Dependencies: 791
-- Name: TABLE stg_employee_fte; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.stg_employee_fte TO sp_suhas;
GRANT ALL ON TABLE qlik.stg_employee_fte TO qlikuser;


--
-- TOC entry 8169 (class 0 OID 0)
-- Dependencies: 792
-- Name: TABLE stg_entity_attribute_mapping; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.stg_entity_attribute_mapping TO qlikuser;
GRANT SELECT ON TABLE qlik.stg_entity_attribute_mapping TO consultant01;


--
-- TOC entry 8170 (class 0 OID 0)
-- Dependencies: 793
-- Name: TABLE stg_fact_product; Type: ACL; Schema: qlik; Owner: postgres
--

GRANT ALL ON TABLE qlik.stg_fact_product TO qlikuser;


--
-- TOC entry 8171 (class 0 OID 0)
-- Dependencies: 794
-- Name: TABLE stg_fte; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.stg_fte TO sp_suhas;
GRANT ALL ON TABLE qlik.stg_fte TO qlikuser;


--
-- TOC entry 8172 (class 0 OID 0)
-- Dependencies: 795
-- Name: TABLE stg_pnc; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.stg_pnc TO qlikuser;


--
-- TOC entry 8173 (class 0 OID 0)
-- Dependencies: 796
-- Name: TABLE stg_project_expense; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.stg_project_expense TO sp_suhas;
GRANT ALL ON TABLE qlik.stg_project_expense TO qlikuser;


--
-- TOC entry 8174 (class 0 OID 0)
-- Dependencies: 797
-- Name: TABLE stg_rnc; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.stg_rnc TO qlikuser;


--
-- TOC entry 8175 (class 0 OID 0)
-- Dependencies: 798
-- Name: TABLE stg_toto_draw_file; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT SELECT ON TABLE qlik.stg_toto_draw_file TO qlikuser;


--
-- TOC entry 8176 (class 0 OID 0)
-- Dependencies: 802
-- Name: TABLE tmp_fact_balance; Type: ACL; Schema: qlik; Owner: postgres
--

GRANT ALL ON TABLE qlik.tmp_fact_balance TO qlikuser;


--
-- TOC entry 8177 (class 0 OID 0)
-- Dependencies: 806
-- Name: TABLE ztall_weight_margin; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.ztall_weight_margin TO qlikuser;


--
-- TOC entry 8178 (class 0 OID 0)
-- Dependencies: 807
-- Name: TABLE ztbmcs_betinfobycashacctview_tmp; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.ztbmcs_betinfobycashacctview_tmp TO qlikuser;


--
-- TOC entry 8179 (class 0 OID 0)
-- Dependencies: 809
-- Name: TABLE ztsapfi_cca; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.ztsapfi_cca TO qlikuser;
GRANT SELECT ON TABLE qlik.ztsapfi_cca TO sp_suhas;


--
-- TOC entry 8180 (class 0 OID 0)
-- Dependencies: 810
-- Name: TABLE ztsapfi_copa; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.ztsapfi_copa TO qlikuser;
GRANT SELECT ON TABLE qlik.ztsapfi_copa TO sp_suhas;


--
-- TOC entry 8181 (class 0 OID 0)
-- Dependencies: 811
-- Name: TABLE ztsapfi_gl; Type: ACL; Schema: qlik; Owner: sp_postgres
--

GRANT ALL ON TABLE qlik.ztsapfi_gl TO qlikuser;
GRANT SELECT ON TABLE qlik.ztsapfi_gl TO sp_suhas;


--
-- TOC entry 4966 (class 826 OID 625321)
-- Name: DEFAULT PRIVILEGES FOR TABLES; Type: DEFAULT ACL; Schema: pg_catalog; Owner: postgres
--

ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA pg_catalog REVOKE ALL ON TABLES  FROM postgres;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA pg_catalog GRANT SELECT ON TABLES  TO svcalation;


-- Completed on 2025-05-13 15:31:17

--
-- PostgreSQL database dump complete
--

